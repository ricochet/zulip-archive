<html>
<head><meta charset="utf-8"><title>wasmtime / PR #8383 Avoid copying the frame for tail call... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html">wasmtime / PR #8383 Avoid copying the frame for tail call...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="433572865"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433572865" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433572865">(Apr 16 2024 at 17:25)</a>:</h4>
<p>elliottt opened <a href="https://github.com/bytecodealliance/wasmtime/pull/8383">PR #8383</a> from <code>elliottt:trevor/tail-calls-riscv64</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>To mirror the implementation in the x64 backend, switch to eagerly reserving enough space in the incoming argument area for any tail call present in the function being compiled.</p>
<p>NOTE: this doesn't make the change to enable callee-save registers with the tail calling convention on aarch64, but that will be a relatively small change following this PR.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="433575754"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433575754" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433575754">(Apr 16 2024 at 17:44)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/8383#issuecomment-2059631768">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8383">PR #8383</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @cfallin, @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "isle"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>cfallin: isle</li>
<li>fitzgen: isle</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="433601954"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433601954" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433601954">(Apr 16 2024 at 20:43)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8383">PR #8383</a>.</p>



<a name="433606916"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433606916" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433606916">(Apr 16 2024 at 21:04)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8383">PR #8383</a>.</p>



<a name="433607491"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433607491" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433607491">(Apr 16 2024 at 21:08)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/8383">PR #8383</a>:</p>
<blockquote>
<p>To mirror the implementation in the x64 backend, switch to eagerly reserving enough space in the incoming argument area for any tail call present in the function being compiled.</p>
<p>The diff here is large due to the change of representation for incoming arguments in the riscv64 specific <code>AMode</code> type. Now that we reference incoming arguments with a negative offset from the beginning of the incoming argument area, all references to incoming arguments changed in the riscv64 filetests.</p>
<p>NOTE: this doesn't make the change to enable callee-save registers with the tail calling convention on aarch64, but that will be a relatively small change following this PR.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="433607595"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433607595" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433607595">(Apr 16 2024 at 21:09)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/8383">PR #8383</a>:</p>
<blockquote>
<p>To mirror the implementation in the x64 backend, switch to eagerly reserving enough space in the incoming argument area for any tail call present in the function being compiled.</p>
<p>The diff here is large due to the change of representation for incoming arguments in the riscv64 specific <code>AMode</code> type. Now that we reference incoming arguments with a negative offset from the beginning of the incoming argument area, all references to incoming arguments changed in the riscv64 filetests. These would have ended up being no-op changes in the disassembly, though I took this opportunity to make them SP relative now, to move closer to frame pointers not being strictly required for tail calls.</p>
<p>NOTE: this doesn't make the change to enable callee-save registers with the tail calling convention on aarch64, but that will be a relatively small change following this PR.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="433607614"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433607614" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433607614">(Apr 16 2024 at 21:09)</a>:</h4>
<p><strong>elliottt</strong> has marked <a href="https://github.com/bytecodealliance/wasmtime/pull/8383">PR #8383</a> as ready for review.</p>



<a name="433607616"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433607616" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433607616">(Apr 16 2024 at 21:09)</a>:</h4>
<p><strong>elliottt</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8383">PR #8383</a>.</p>



<a name="433607617"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433607617" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433607617">(Apr 16 2024 at 21:09)</a>:</h4>
<p><strong>elliottt</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8383">PR #8383</a>.</p>



<a name="433607630"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433607630" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433607630">(Apr 16 2024 at 21:09)</a>:</h4>
<p><strong>elliottt</strong> requested <a href="https://github.com/jameysharp">jameysharp</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8383">PR #8383</a>.</p>



<a name="433607647"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433607647" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433607647">(Apr 16 2024 at 21:09)</a>:</h4>
<p><strong>elliottt</strong> requested <a href="https://github.com/afonso360">afonso360</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8383">PR #8383</a>.</p>



<a name="433607771"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433607771" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433607771">(Apr 16 2024 at 21:10)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/8383">PR #8383</a>:</p>
<blockquote>
<p>To mirror the implementation in the x64 backend, switch to eagerly reserving enough space in the incoming argument area for any tail call present in the function being compiled.</p>
<p>The diff here is large due to the change of representation for incoming arguments in the riscv64 specific <code>AMode</code> type. Now that we reference incoming arguments with a negative offset from the beginning of the incoming argument area, all references to incoming arguments changed in the riscv64 filetests. These would have ended up being no-op changes in the disassembly, though I took this opportunity to make them SP relative now, to move closer to frame pointers not being strictly required for tail calls.</p>
<p>As this is the last backend that was waiting to be migrated to the approach of resizing the incoming argument area in the function prologue, I've also deleted the shared code in <code>machinst/abi.rs</code> that's no longer needed.</p>
<p>NOTE: this doesn't make the change to enable callee-save registers with the tail calling convention on aarch64, but that will be a relatively small change following this PR.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="433608444"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433608444" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433608444">(Apr 16 2024 at 21:15)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8383#pullrequestreview-2004611797">PR review</a>.</p>



<a name="433608445"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433608445" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433608445">(Apr 16 2024 at 21:15)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/8383#discussion_r1567949611">PR review comment</a>:</p>
<blockquote>
<p>Maybe this would be better written as <code>fp(incoming_arg_area - {offset})</code>?</p>
</blockquote>



<a name="433608496"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433608496" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433608496">(Apr 16 2024 at 21:15)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/8383#discussion_r1567949611">PR review comment</a>.</p>



<a name="433616598"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433616598" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433616598">(Apr 16 2024 at 22:21)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8383#pullrequestreview-2004684378">PR review</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>I don't think I can do a very good review here, I don't remember a lot about how our frames are set up and haven't been following the rest of the tail calls work very closely. So I'd prefer if someone else could review this.</p>
</blockquote>



<a name="433616600"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433616600" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433616600">(Apr 16 2024 at 22:21)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8383#pullrequestreview-2004684378">PR review</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>I don't think I can do a very good review here, I don't remember a lot about how our frames are set up and haven't been following the rest of the tail calls work very closely. So I'd prefer if someone else could review this.</p>
</blockquote>



<a name="433616601"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433616601" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433616601">(Apr 16 2024 at 22:21)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/8383#discussion_r1567996902">PR review comment</a>:</p>
<blockquote>
<p>Is this island check now done in some common code, or do we no longer need it? I remember having some issues with missing islands when we enabled compressed jumps since with the compressed extensions we have a very short jump range.</p>
</blockquote>



<a name="433622686"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433622686" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433622686">(Apr 16 2024 at 23:20)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8383#pullrequestreview-2004737402">PR review</a>.</p>



<a name="433622689"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433622689" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433622689">(Apr 16 2024 at 23:20)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/8383#discussion_r1568032452">PR review comment</a>:</p>
<blockquote>
<p>Thanks for catching this, that check isn't being done in any generic code. I'll add this back in!</p>
</blockquote>



<a name="433622821"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433622821" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433622821">(Apr 16 2024 at 23:21)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8383#pullrequestreview-2004735502">PR review</a>.</p>



<a name="433622823"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433622823" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433622823">(Apr 16 2024 at 23:21)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8383#pullrequestreview-2004735502">PR review</a>.</p>



<a name="433622824"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433622824" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433622824">(Apr 16 2024 at 23:21)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/8383#discussion_r1568030881">PR review comment</a>:</p>
<blockquote>
<p>I'd also take <code>"-{}(incoming_arg)"</code> to signal that the offset is subtracted from the base. I don't think it's worth bikeshedding this very much but I think clarifying that it's a subtraction would help with readability.</p>
</blockquote>



<a name="433626279"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433626279" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433626279">(Apr 17 2024 at 00:03)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8383#pullrequestreview-2004768908">PR review</a>.</p>



<a name="433626281"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433626281" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433626281">(Apr 17 2024 at 00:03)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/8383#discussion_r1568054475">PR review comment</a>:</p>
<blockquote>
<p>On further inspection, there is generic code in <code>VCode::emit</code> that emits islands based on the backend's <code>Inst::worst_case_size()</code> estimate. Both <code>gen_epilogue</code> and these <code>ReturnCall</code>/<code>ReturnCallInd</code> pseudo-instructions need to fit within that worst-case size. These pseudo-instructions might be slightly longer than <code>gen_epilogue</code> right now but they're almost the same, so I think they don't need an explicit island check.</p>
</blockquote>



<a name="433627491"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433627491" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433627491">(Apr 17 2024 at 00:18)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/8383#discussion_r1568061763">PR review comment</a>:</p>
<blockquote>
<p>I did some more refactoring, and the resulting code generated for a <code>return_call</code> or <code>return_call_indirect</code> should now be pretty close to the same size as <code>gen_epilogue</code>. Lots of chatting with @jameysharp has me convinced that we shouldn't need to check for island emission at this point anymore, and I've removed the manual resets at the call-sites for <code>emit_return_call_common_sequence</code> to ensure that we trigger an assert if this isn't true.</p>
</blockquote>



<a name="433627492"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433627492" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433627492">(Apr 17 2024 at 00:18)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8383#pullrequestreview-2004779301">PR review</a>.</p>



<a name="433627519"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433627519" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433627519">(Apr 17 2024 at 00:19)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8383">PR #8383</a>.</p>



<a name="433628089"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433628089" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433628089">(Apr 17 2024 at 00:27)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8383">PR #8383</a>.</p>



<a name="433628184"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/433628184" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#433628184">(Apr 17 2024 at 00:29)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8383">PR #8383</a>.</p>



<a name="434200236"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/434200236" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#434200236">(Apr 18 2024 at 16:40)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8383">PR #8383</a>.</p>



<a name="434240456"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/434240456" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#434240456">(Apr 18 2024 at 21:20)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8383">PR #8383</a>.</p>



<a name="434241497"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/434241497" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#434241497">(Apr 18 2024 at 21:28)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8383#pullrequestreview-2009936020">PR review</a>:</p>
<blockquote>
<p>I'm convinced this is all correct. Ship it!</p>
</blockquote>



<a name="434247223"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238383%20Avoid%20copying%20the%20frame%20for%20tail%20call.../near/434247223" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238383.20Avoid.20copying.20the.20frame.20for.20tail.20call.2E.2E.2E.html#434247223">(Apr 18 2024 at 22:18)</a>:</h4>
<p>elliottt merged <a href="https://github.com/bytecodealliance/wasmtime/pull/8383">PR #8383</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>