<html>
<head><meta charset="utf-8"><title>wasmtime / issue #9194 wasmtime serve seems to ignore --d... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239194.20wasmtime.20serve.20seems.20to.20ignore.20--d.2E.2E.2E.html">wasmtime / issue #9194 wasmtime serve seems to ignore --d...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="467179254"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239194%20wasmtime%20serve%20seems%20to%20ignore%20--d.../near/467179254" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239194.20wasmtime.20serve.20seems.20to.20ignore.20--d.2E.2E.2E.html#467179254">(Sep 03 2024 at 09:01)</a>:</h4>
<p><a href="https://github.com/javorszky">javorszky</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/9194">Issue #9194</a>.</p>



<a name="467179263"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239194%20wasmtime%20serve%20seems%20to%20ignore%20--d.../near/467179263" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239194.20wasmtime.20serve.20seems.20to.20ignore.20--d.2E.2E.2E.html#467179263">(Sep 03 2024 at 09:01)</a>:</h4>
<p>javorszky opened <a href="https://github.com/bytecodealliance/wasmtime/issues/9194">issue #9194</a>:</p>
<blockquote>
<p>We've been trying to create a wasi:http world file to have access to the filesystem. We couldn't get it working.</p>
<h3>Test Case</h3>
<p>I've put up a repository here: <a href="https://github.com/javorszky/wasmtime-fscheck-serve">https://github.com/javorszky/wasmtime-fscheck-serve</a> which has the source code, a dockerfile, a makefile to make sure everything is consistent across different machines and host triplets.</p>
<h3>Steps to Reproduce</h3>
<ul>
<li>clone the repository</li>
<li>build the docker container with <code>make bd</code></li>
<li>run the docker container with <code>make dr</code></li>
<li>send an empty get request to localhost:8080</li>
</ul>
<h3>Expected Results</h3>
<p>I expect the wasm component to respond with a 200 OK with the body being the list of files and directories in the opened directory.</p>
<h3>Actual Results</h3>
<p>Response is a panicked crash with the following error log in docker:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">stderr</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">thread</span><span class="w"> </span><span class="o">'&lt;</span><span class="n">unnamed</span><span class="o">&gt;'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span>
<span class="nc">stderr</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Result</span><span class="p">::</span><span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="nb">Err</span><span class="err">`</span><span class="w"> </span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="nc">Custom</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">kind</span><span class="p">:</span><span class="w"> </span><span class="nc">Uncategorized</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="s">"failed to find a pre-opened file descriptor through which </span><span class="se">\"</span><span class="s">/shenanigans</span><span class="se">\"</span><span class="s"> could be opened"</span><span class="w"> </span><span class="p">}</span>
<span class="n">stderr</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">note</span><span class="p">:</span><span class="w"> </span><span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span>
<span class="mi">2024</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">03</span><span class="n">T08</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mf">29.977839</span><span class="n">Z</span><span class="w"> </span><span class="n">ERROR</span><span class="w"> </span><span class="n">wasmtime_cli</span><span class="p">::</span><span class="n">commands</span><span class="p">::</span><span class="n">serve</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">Error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">context</span><span class="p">:</span><span class="w"> </span><span class="s">"error while executing at wasm backtrace:</span><span class="se">\n</span><span class="s">    0: 0x258f2 - wasmtime_filesystem_debug.wasm!__rust_start_panic</span><span class="se">\n</span><span class="s">    1: 0x2546e - wasmtime_filesystem_debug.wasm!rust_panic</span><span class="se">\n</span><span class="s">    2: 0x25224 - wasmtime_filesystem_debug.wasm!std::panicking::rust_panic_with_hook::h8bb4f94cf9e68e20</span><span class="se">\n</span><span class="s">    3: 0x24646 - wasmtime_filesystem_debug.wasm!std::panicking::begin_panic_handler::{{closure}}::h2c354a3372fcca00</span><span class="se">\n</span><span class="s">    4: 0x245ad - wasmtime_filesystem_debug.wasm!std::sys_common::backtrace::__rust_end_short_backtrace::hf791a0fba63af5e9</span><span class="se">\n</span><span class="s">    5: 0x24dbc - wasmtime_filesystem_debug.wasm!rust_begin_unwind</span><span class="se">\n</span><span class="s">    6: 0x2a66b - wasmtime_filesystem_debug.wasm!core::panicking::panic_fmt::haadcabb094f4c85b</span><span class="se">\n</span><span class="s">    7: 0x2c2de - wasmtime_filesystem_debug.wasm!core::result::unwrap_failed::hd09ff05c9c2fb25f</span><span class="se">\n</span><span class="s">    8: 0x6a1d - wasmtime_filesystem_debug.wasm!&lt;wasmtime_filesystem_debug::Component as wasi::proxy::exports::wasi::http::incoming_handler::Guest&gt;::handle::hd44cd139d21c109c</span><span class="se">\n</span><span class="s">    9: 0x7853 - wasmtime_filesystem_debug.wasm!wasi::proxy::exports::wasi::http::incoming_handler::_export_handle_cabi::he753d69b8503d63c</span><span class="se">\n</span><span class="s">   10: 0x7798 - wasmtime_filesystem_debug.wasm!wasi:http/incoming-handler@0.2.1#handle</span><span class="se">\n</span><span class="s">note: using the `WASMTIME_BACKTRACE_DETAILS=1` environment variable may show more debugging information"</span><span class="p">,</span>
<span class="w">    </span><span class="n">source</span><span class="p">:</span><span class="w"> </span><span class="nc">UnreachableCodeReached</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nc">hyper</span><span class="p">::</span><span class="n">Error</span><span class="p">(</span><span class="n">User</span><span class="p">(</span><span class="n">Service</span><span class="p">),</span><span class="w"> </span><span class="n">guest</span><span class="w"> </span><span class="n">never</span><span class="w"> </span><span class="n">invoked</span><span class="w"> </span><span class="err">`</span><span class="n">response</span><span class="o">-</span><span class="n">outparam</span><span class="p">::</span><span class="n">set</span><span class="err">`</span><span class="w"> </span><span class="n">method</span><span class="p">:</span><span class="w"> </span><span class="nc">error</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">executing</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span><span class="p">:</span>
<span class="w">    </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="mh">0x258f2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">__rust_start_panic</span>
<span class="w">    </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="mh">0x2546e</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">rust_panic</span>
<span class="w">    </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="mh">0x25224</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">std</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">rust_panic_with_hook</span><span class="p">::</span><span class="n">h8bb4f94cf9e68e20</span>
<span class="w">    </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="mh">0x24646</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">std</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">begin_panic_handler</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}::</span><span class="n">h2c354a3372fcca00</span>
<span class="w">    </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="mh">0x245ad</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">std</span><span class="p">::</span><span class="n">sys_common</span><span class="p">::</span><span class="n">backtrace</span><span class="p">::</span><span class="n">__rust_end_short_backtrace</span><span class="p">::</span><span class="n">hf791a0fba63af5e9</span>
<span class="w">    </span><span class="mi">5</span><span class="p">:</span><span class="w"> </span><span class="mh">0x24dbc</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">rust_begin_unwind</span>
<span class="w">    </span><span class="mi">6</span><span class="p">:</span><span class="w"> </span><span class="mh">0x2a66b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">panic_fmt</span><span class="p">::</span><span class="n">haadcabb094f4c85b</span>
<span class="w">    </span><span class="mi">7</span><span class="p">:</span><span class="w"> </span><span class="mh">0x2c2de</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">core</span><span class="p">::</span><span class="n">result</span><span class="p">::</span><span class="n">unwrap_failed</span><span class="p">::</span><span class="n">hd09ff05c9c2fb25f</span>
<span class="w">    </span><span class="mi">8</span><span class="p">:</span><span class="w"> </span><span class="mh">0x6a1d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!&lt;</span><span class="n">wasmtime_filesystem_debug</span><span class="p">::</span><span class="n">Component</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">wasi</span><span class="p">::</span><span class="n">proxy</span><span class="p">::</span><span class="n">exports</span><span class="p">::</span><span class="n">wasi</span><span class="p">::</span><span class="n">http</span><span class="p">::</span><span class="n">incoming_handler</span><span class="p">::</span><span class="n">Guest</span><span class="o">&gt;</span><span class="p">::</span><span class="n">handle</span><span class="p">::</span><span class="n">hd44cd139d21c109c</span>
<span class="w">    </span><span class="mi">9</span><span class="p">:</span><span class="w"> </span><span class="mh">0x7853</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">wasi</span><span class="p">::</span><span class="n">proxy</span><span class="p">::</span><span class="n">exports</span><span class="p">::</span><span class="n">wasi</span><span class="p">::</span><span class="n">http</span><span class="p">::</span><span class="n">incoming_handler</span><span class="p">::</span><span class="n">_export_handle_cabi</span><span class="p">::</span><span class="n">he753d69b8503d63c</span>
<span class="w">   </span><span class="mi">10</span><span class="p">:</span><span class="w"> </span><span class="mh">0x7798</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">wasi</span><span class="p">:</span><span class="nc">http</span><span class="o">/</span><span class="n">incoming</span><span class="o">-</span><span class="n">handler</span><span class="o">@</span><span class="mf">0.2.1</span><span class="p">#</span><span class="n">handle</span>
<span class="n">note</span><span class="p">:</span><span class="w"> </span><span class="nc">using</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">`</span><span class="n">WASMTIME_BACKTRACE_DETAILS</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">debugging</span><span class="w"> </span><span class="n">information</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span><span class="p">:</span>
<span class="w">    </span><span class="nc">wasm</span><span class="w"> </span><span class="n">trap</span><span class="p">:</span><span class="w"> </span><span class="nc">wasm</span><span class="w"> </span><span class="err">`</span><span class="n">unreachable</span><span class="err">`</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="n">executed</span><span class="p">)</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: wasmtime-cli 24.0.0</p>
<p>Operating system: linux bullseye (docker base image is <code>rust:bullseye</code>)</p>
<p>Architecture: aarch64-unknown-linux-gnu</p>
<h3>Extra Info</h3>
<p>It looks like preopen doesn't happen with wasmtime serve, as there's no <code>openat</code> syscall to the directory we're trying to preopen. For comparison I also have a <a href="https://github.com/javorszky/wasmtime-fscheck-cli">cli version of the wasm with a preopened directory</a> where I can see an <code>openat</code> call to the directory I specified in <code>strace</code>, and the component prints out the contents of the directory as expected.</p>
<p>I also tried many variations of passing <code>-Scli=y -Spreview2=y</code> with no fix to directory access.</p>
<p>Adding <code>-Dlogging=y</code> does not yield anything useful.</p>
<p>My assumption that <code>wasmtime serve</code> should honour the <code>--dir</code> flag is based on the following:</p>
<ul>
<li>PR 8279: <a href="https://github.com/bytecodealliance/wasmtime/pull/8279">https://github.com/bytecodealliance/wasmtime/pull/8279</a></li>
<li>conversation in issue 8086: <a href="https://github.com/bytecodealliance/wasmtime/issues/8086">https://github.com/bytecodealliance/wasmtime/issues/8086</a></li>
<li>
<p>this source code dive:</p>
<ol>
<li>serve command's <a href="https://github.com/bytecodealliance/wasmtime/blob/main/src/commands/serve.rs#L484">handle_request calls new_store</a></li>
<li>serve command's <a href="https://github.com/bytecodealliance/wasmtime/blob/main/src/commands/serve.rs#L137">new_store calls configure_wasip2</a></li>
<li><a href="https://github.com/bytecodealliance/wasmtime/blob/v24.0.0/src/common.rs#L293">common's configure_wasip2 iterates over the directories to open</a></li>
</ol>
</li>
</ul>
<p>It looks like common's <code>self.dirs</code> is not getting populated from the command line argument.<br>
</p>
</blockquote>



<a name="467199513"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239194%20wasmtime%20serve%20seems%20to%20ignore%20--d.../near/467199513" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239194.20wasmtime.20serve.20seems.20to.20ignore.20--d.2E.2E.2E.html#467199513">(Sep 03 2024 at 10:09)</a>:</h4>
<p>javorszky edited <a href="https://github.com/bytecodealliance/wasmtime/issues/9194">issue #9194</a>:</p>
<blockquote>
<p>We've been trying to create a wasi:http world file to have access to the filesystem. We couldn't get it working.</p>
<h3>Test Case</h3>
<p>I've put up a repository here: <a href="https://github.com/javorszky/wasmtime-fscheck-serve">https://github.com/javorszky/wasmtime-fscheck-serve</a> which has the source code, a dockerfile, a makefile to make sure everything is consistent across different machines and host triplets.</p>
<h3>Steps to Reproduce</h3>
<ul>
<li>clone the repository</li>
<li>build the docker container with <code>make bd</code></li>
<li>run the docker container with <code>make dr</code></li>
<li>send an empty get request to localhost:8080</li>
</ul>
<h3>Expected Results</h3>
<p>I expect the wasm component to respond with a 200 OK with the body being the list of files and directories in the opened directory.</p>
<h3>Actual Results</h3>
<p>Response is a panicked crash with the following error log in docker:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">stderr</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">thread</span><span class="w"> </span><span class="o">'&lt;</span><span class="n">unnamed</span><span class="o">&gt;'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span>
<span class="nc">stderr</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Result</span><span class="p">::</span><span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="nb">Err</span><span class="err">`</span><span class="w"> </span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="nc">Custom</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">kind</span><span class="p">:</span><span class="w"> </span><span class="nc">Uncategorized</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="s">"failed to find a pre-opened file descriptor through which </span><span class="se">\"</span><span class="s">/shenanigans</span><span class="se">\"</span><span class="s"> could be opened"</span><span class="w"> </span><span class="p">}</span>
<span class="n">stderr</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">note</span><span class="p">:</span><span class="w"> </span><span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span>
<span class="mi">2024</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">03</span><span class="n">T08</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mf">29.977839</span><span class="n">Z</span><span class="w"> </span><span class="n">ERROR</span><span class="w"> </span><span class="n">wasmtime_cli</span><span class="p">::</span><span class="n">commands</span><span class="p">::</span><span class="n">serve</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">Error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">context</span><span class="p">:</span><span class="w"> </span><span class="s">"error while executing at wasm backtrace:</span><span class="se">\n</span><span class="s">    0: 0x258f2 - wasmtime_filesystem_debug.wasm!__rust_start_panic</span><span class="se">\n</span><span class="s">    1: 0x2546e - wasmtime_filesystem_debug.wasm!rust_panic</span><span class="se">\n</span><span class="s">    2: 0x25224 - wasmtime_filesystem_debug.wasm!std::panicking::rust_panic_with_hook::h8bb4f94cf9e68e20</span><span class="se">\n</span><span class="s">    3: 0x24646 - wasmtime_filesystem_debug.wasm!std::panicking::begin_panic_handler::{{closure}}::h2c354a3372fcca00</span><span class="se">\n</span><span class="s">    4: 0x245ad - wasmtime_filesystem_debug.wasm!std::sys_common::backtrace::__rust_end_short_backtrace::hf791a0fba63af5e9</span><span class="se">\n</span><span class="s">    5: 0x24dbc - wasmtime_filesystem_debug.wasm!rust_begin_unwind</span><span class="se">\n</span><span class="s">    6: 0x2a66b - wasmtime_filesystem_debug.wasm!core::panicking::panic_fmt::haadcabb094f4c85b</span><span class="se">\n</span><span class="s">    7: 0x2c2de - wasmtime_filesystem_debug.wasm!core::result::unwrap_failed::hd09ff05c9c2fb25f</span><span class="se">\n</span><span class="s">    8: 0x6a1d - wasmtime_filesystem_debug.wasm!&lt;wasmtime_filesystem_debug::Component as wasi::proxy::exports::wasi::http::incoming_handler::Guest&gt;::handle::hd44cd139d21c109c</span><span class="se">\n</span><span class="s">    9: 0x7853 - wasmtime_filesystem_debug.wasm!wasi::proxy::exports::wasi::http::incoming_handler::_export_handle_cabi::he753d69b8503d63c</span><span class="se">\n</span><span class="s">   10: 0x7798 - wasmtime_filesystem_debug.wasm!wasi:http/incoming-handler@0.2.1#handle</span><span class="se">\n</span><span class="s">note: using the `WASMTIME_BACKTRACE_DETAILS=1` environment variable may show more debugging information"</span><span class="p">,</span>
<span class="w">    </span><span class="n">source</span><span class="p">:</span><span class="w"> </span><span class="nc">UnreachableCodeReached</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nc">hyper</span><span class="p">::</span><span class="n">Error</span><span class="p">(</span><span class="n">User</span><span class="p">(</span><span class="n">Service</span><span class="p">),</span><span class="w"> </span><span class="n">guest</span><span class="w"> </span><span class="n">never</span><span class="w"> </span><span class="n">invoked</span><span class="w"> </span><span class="err">`</span><span class="n">response</span><span class="o">-</span><span class="n">outparam</span><span class="p">::</span><span class="n">set</span><span class="err">`</span><span class="w"> </span><span class="n">method</span><span class="p">:</span><span class="w"> </span><span class="nc">error</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">executing</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span><span class="p">:</span>
<span class="w">    </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="mh">0x258f2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">__rust_start_panic</span>
<span class="w">    </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="mh">0x2546e</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">rust_panic</span>
<span class="w">    </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="mh">0x25224</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">std</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">rust_panic_with_hook</span><span class="p">::</span><span class="n">h8bb4f94cf9e68e20</span>
<span class="w">    </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="mh">0x24646</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">std</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">begin_panic_handler</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}::</span><span class="n">h2c354a3372fcca00</span>
<span class="w">    </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="mh">0x245ad</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">std</span><span class="p">::</span><span class="n">sys_common</span><span class="p">::</span><span class="n">backtrace</span><span class="p">::</span><span class="n">__rust_end_short_backtrace</span><span class="p">::</span><span class="n">hf791a0fba63af5e9</span>
<span class="w">    </span><span class="mi">5</span><span class="p">:</span><span class="w"> </span><span class="mh">0x24dbc</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">rust_begin_unwind</span>
<span class="w">    </span><span class="mi">6</span><span class="p">:</span><span class="w"> </span><span class="mh">0x2a66b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">panic_fmt</span><span class="p">::</span><span class="n">haadcabb094f4c85b</span>
<span class="w">    </span><span class="mi">7</span><span class="p">:</span><span class="w"> </span><span class="mh">0x2c2de</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">core</span><span class="p">::</span><span class="n">result</span><span class="p">::</span><span class="n">unwrap_failed</span><span class="p">::</span><span class="n">hd09ff05c9c2fb25f</span>
<span class="w">    </span><span class="mi">8</span><span class="p">:</span><span class="w"> </span><span class="mh">0x6a1d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!&lt;</span><span class="n">wasmtime_filesystem_debug</span><span class="p">::</span><span class="n">Component</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">wasi</span><span class="p">::</span><span class="n">proxy</span><span class="p">::</span><span class="n">exports</span><span class="p">::</span><span class="n">wasi</span><span class="p">::</span><span class="n">http</span><span class="p">::</span><span class="n">incoming_handler</span><span class="p">::</span><span class="n">Guest</span><span class="o">&gt;</span><span class="p">::</span><span class="n">handle</span><span class="p">::</span><span class="n">hd44cd139d21c109c</span>
<span class="w">    </span><span class="mi">9</span><span class="p">:</span><span class="w"> </span><span class="mh">0x7853</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">wasi</span><span class="p">::</span><span class="n">proxy</span><span class="p">::</span><span class="n">exports</span><span class="p">::</span><span class="n">wasi</span><span class="p">::</span><span class="n">http</span><span class="p">::</span><span class="n">incoming_handler</span><span class="p">::</span><span class="n">_export_handle_cabi</span><span class="p">::</span><span class="n">he753d69b8503d63c</span>
<span class="w">   </span><span class="mi">10</span><span class="p">:</span><span class="w"> </span><span class="mh">0x7798</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">wasi</span><span class="p">:</span><span class="nc">http</span><span class="o">/</span><span class="n">incoming</span><span class="o">-</span><span class="n">handler</span><span class="o">@</span><span class="mf">0.2.1</span><span class="p">#</span><span class="n">handle</span>
<span class="n">note</span><span class="p">:</span><span class="w"> </span><span class="nc">using</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">`</span><span class="n">WASMTIME_BACKTRACE_DETAILS</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">debugging</span><span class="w"> </span><span class="n">information</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span><span class="p">:</span>
<span class="w">    </span><span class="nc">wasm</span><span class="w"> </span><span class="n">trap</span><span class="p">:</span><span class="w"> </span><span class="nc">wasm</span><span class="w"> </span><span class="err">`</span><span class="n">unreachable</span><span class="err">`</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="n">executed</span><span class="p">)</span>
</code></pre></div>
<p>The important error is this one:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">find</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">pre</span><span class="o">-</span><span class="n">opened</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">descriptor</span><span class="w"> </span><span class="n">through</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="err">\</span><span class="s">"/shenanigans</span><span class="se">\"</span><span class="s"> could be opened</span>
</code></pre></div>
<p>coming from this source code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">fs</span><span class="p">::</span><span class="n">read_dir</span><span class="p">(</span><span class="s">"/shenanigans"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span>
</code></pre></div>
<p>where the command to start it was</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="p">.</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="n">serve</span><span class="w"> </span><span class="o">--</span><span class="n">dir</span><span class="o">=/</span><span class="n">shenanigans</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasip1</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: wasmtime-cli 24.0.0</p>
<p>Operating system: linux bullseye (docker base image is <code>rust:bullseye</code>)</p>
<p>Architecture: aarch64-unknown-linux-gnu</p>
<h3>Extra Info</h3>
<p>It looks like preopen doesn't happen with wasmtime serve, as there's no <code>openat</code> syscall to the directory we're trying to preopen. For comparison I also have a <a href="https://github.com/javorszky/wasmtime-fscheck-cli">cli version of the wasm with a preopened directory</a> where I can see an <code>openat</code> call to the directory I specified in <code>strace</code>, and the component prints out the contents of the directory as expected.</p>
<p>I also tried many variations of passing <code>-Scli=y -Spreview2=y</code> with no fix to directory access.</p>
<p>Adding <code>-Dlogging=y</code> does not yield anything useful.</p>
<p>My assumption that <code>wasmtime serve</code> should honour the <code>--dir</code> flag is based on the following:<br>
* PR 8279: <a href="https://github.com/bytecodealliance/wasmtime/pull/8279">https://github.com/bytecodealliance/wasmtime/pull/8279</a><br>
* conversation in issue 8086: <a href="https://github.com/bytecodealliance/wasmtime/issues/8086">https://github.com/bytecodealliance/wasmtime/issues/8086</a><br>
* this source code dive:<br>
  1. serve command's <a href="https://github.com/bytecodealliance/wasmtime/blob/main/src/commands/serve.rs#L484">handle_request calls new_store</a><br>
  2. serve command's <a href="https://github.com/bytecodealliance/wasmtime/blob/main/src/commands/serve.rs#L137">new_store calls configure_wasip2</a><br>
  3. <a href="https://github.com/bytecodealliance/wasmtime/blob/v24.0.0/src/common.rs#L293">common's configure_wasip2 iterates over the directories to open</a></p>
<p>It looks like common's <code>self.dirs</code> is not getting populated from the command line argument.<br>
</p>
</blockquote>



<a name="467323793"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239194%20wasmtime%20serve%20seems%20to%20ignore%20--d.../near/467323793" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239194.20wasmtime.20serve.20seems.20to.20ignore.20--d.2E.2E.2E.html#467323793">(Sep 03 2024 at 17:44)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/9194#issuecomment-2327091170">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9194">issue #9194</a>:</p>
<blockquote>
<p>Thanks for the detailed report! I think the main issue is with <a href="https://github.com/javorszky/wasmtime-fscheck-serve/blob/236845becebd8e3dcc9fe23421ca8105d38692be/Cargo.toml#L15">this line</a> where that causes <code>cargo component</code> to use the "proxy adapter" when converting WASIp1 calls to WASIp2. The proxy version hardcodes that the filesystem is inaccessible and will always return an empty filesystem. If you want access to the filesystem I think you probably want to just remove that line. That should cause the "reactor adapter" to be used instead which forwards WASIp1 calls to WASIp2.</p>
<p>After doing that you'll want to pass <code>-Scli</code> to <code>wasmtime serve</code>, and it should work this time. It didn't work before because the proxy adapter meant that WASIp2 functions weren't ever called.</p>
<p>Does that help clarify what's happening?</p>
</blockquote>



<a name="467326057"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239194%20wasmtime%20serve%20seems%20to%20ignore%20--d.../near/467326057" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239194.20wasmtime.20serve.20seems.20to.20ignore.20--d.2E.2E.2E.html#467326057">(Sep 03 2024 at 17:53)</a>:</h4>
<p>javorszky <a href="https://github.com/bytecodealliance/wasmtime/issues/9194#issuecomment-2327106410">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9194">issue #9194</a>:</p>
<blockquote>
<p>@alexcrichton yes, that makes sense. I removed that line and now the component works as expected, thank you so much!</p>
<p>I went through the documentation for wasmtime, and couldn't find any mention of what proxy:true does. I'll keep digging, but is there info about this already published I'm not finding?</p>
<p>Again, much appreciated!</p>
</blockquote>



<a name="467326286"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239194%20wasmtime%20serve%20seems%20to%20ignore%20--d.../near/467326286" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239194.20wasmtime.20serve.20seems.20to.20ignore.20--d.2E.2E.2E.html#467326286">(Sep 03 2024 at 17:54)</a>:</h4>
<p>javorszky <a href="https://github.com/bytecodealliance/wasmtime/issues/9194#issuecomment-2327107695">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9194">issue #9194</a>:</p>
<blockquote>
<p>Solved by removing the <code>proxy = true</code> line from the Cargo.toml under the <code>[package.metadata.component]</code> section</p>
</blockquote>



<a name="467326804"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239194%20wasmtime%20serve%20seems%20to%20ignore%20--d.../near/467326804" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239194.20wasmtime.20serve.20seems.20to.20ignore.20--d.2E.2E.2E.html#467326804">(Sep 03 2024 at 17:56)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/9194#issuecomment-2327110924">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9194">issue #9194</a>:</p>
<blockquote>
<p>Ah the reason you didn't find that in the wasmtime docs is that it's a feature of <code>cargo component</code>, not Wasmtime. Wasmtime doesn't currently house docs for each guest language that could compile to wasm, although <a href="https://component-model.bytecodealliance.org/">https://component-model.bytecodealliance.org/</a> is a location where such docs could work. Alas though I don't believe the <code>proxy = true</code> part is documented all that well in either place right now either, but it'd be good to contribute!</p>
</blockquote>



<a name="467326810"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239194%20wasmtime%20serve%20seems%20to%20ignore%20--d.../near/467326810" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239194.20wasmtime.20serve.20seems.20to.20ignore.20--d.2E.2E.2E.html#467326810">(Sep 03 2024 at 17:56)</a>:</h4>
<p>javorszky closed <a href="https://github.com/bytecodealliance/wasmtime/issues/9194">issue #9194</a>:</p>
<blockquote>
<p>We've been trying to create a wasi:http world file to have access to the filesystem. We couldn't get it working.</p>
<h3>Test Case</h3>
<p>I've put up a repository here: <a href="https://github.com/javorszky/wasmtime-fscheck-serve">https://github.com/javorszky/wasmtime-fscheck-serve</a> which has the source code, a dockerfile, a makefile to make sure everything is consistent across different machines and host triplets.</p>
<h3>Steps to Reproduce</h3>
<ul>
<li>clone the repository</li>
<li>build the docker container with <code>make bd</code></li>
<li>run the docker container with <code>make dr</code></li>
<li>send an empty get request to localhost:8080</li>
</ul>
<h3>Expected Results</h3>
<p>I expect the wasm component to respond with a 200 OK with the body being the list of files and directories in the opened directory.</p>
<h3>Actual Results</h3>
<p>Response is a panicked crash with the following error log in docker:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">stderr</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">thread</span><span class="w"> </span><span class="o">'&lt;</span><span class="n">unnamed</span><span class="o">&gt;'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span>
<span class="nc">stderr</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Result</span><span class="p">::</span><span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="nb">Err</span><span class="err">`</span><span class="w"> </span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="nc">Custom</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">kind</span><span class="p">:</span><span class="w"> </span><span class="nc">Uncategorized</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="s">"failed to find a pre-opened file descriptor through which </span><span class="se">\"</span><span class="s">/shenanigans</span><span class="se">\"</span><span class="s"> could be opened"</span><span class="w"> </span><span class="p">}</span>
<span class="n">stderr</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">note</span><span class="p">:</span><span class="w"> </span><span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span>
<span class="mi">2024</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">03</span><span class="n">T08</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mf">29.977839</span><span class="n">Z</span><span class="w"> </span><span class="n">ERROR</span><span class="w"> </span><span class="n">wasmtime_cli</span><span class="p">::</span><span class="n">commands</span><span class="p">::</span><span class="n">serve</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">Error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">context</span><span class="p">:</span><span class="w"> </span><span class="s">"error while executing at wasm backtrace:</span><span class="se">\n</span><span class="s">    0: 0x258f2 - wasmtime_filesystem_debug.wasm!__rust_start_panic</span><span class="se">\n</span><span class="s">    1: 0x2546e - wasmtime_filesystem_debug.wasm!rust_panic</span><span class="se">\n</span><span class="s">    2: 0x25224 - wasmtime_filesystem_debug.wasm!std::panicking::rust_panic_with_hook::h8bb4f94cf9e68e20</span><span class="se">\n</span><span class="s">    3: 0x24646 - wasmtime_filesystem_debug.wasm!std::panicking::begin_panic_handler::{{closure}}::h2c354a3372fcca00</span><span class="se">\n</span><span class="s">    4: 0x245ad - wasmtime_filesystem_debug.wasm!std::sys_common::backtrace::__rust_end_short_backtrace::hf791a0fba63af5e9</span><span class="se">\n</span><span class="s">    5: 0x24dbc - wasmtime_filesystem_debug.wasm!rust_begin_unwind</span><span class="se">\n</span><span class="s">    6: 0x2a66b - wasmtime_filesystem_debug.wasm!core::panicking::panic_fmt::haadcabb094f4c85b</span><span class="se">\n</span><span class="s">    7: 0x2c2de - wasmtime_filesystem_debug.wasm!core::result::unwrap_failed::hd09ff05c9c2fb25f</span><span class="se">\n</span><span class="s">    8: 0x6a1d - wasmtime_filesystem_debug.wasm!&lt;wasmtime_filesystem_debug::Component as wasi::proxy::exports::wasi::http::incoming_handler::Guest&gt;::handle::hd44cd139d21c109c</span><span class="se">\n</span><span class="s">    9: 0x7853 - wasmtime_filesystem_debug.wasm!wasi::proxy::exports::wasi::http::incoming_handler::_export_handle_cabi::he753d69b8503d63c</span><span class="se">\n</span><span class="s">   10: 0x7798 - wasmtime_filesystem_debug.wasm!wasi:http/incoming-handler@0.2.1#handle</span><span class="se">\n</span><span class="s">note: using the `WASMTIME_BACKTRACE_DETAILS=1` environment variable may show more debugging information"</span><span class="p">,</span>
<span class="w">    </span><span class="n">source</span><span class="p">:</span><span class="w"> </span><span class="nc">UnreachableCodeReached</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nc">hyper</span><span class="p">::</span><span class="n">Error</span><span class="p">(</span><span class="n">User</span><span class="p">(</span><span class="n">Service</span><span class="p">),</span><span class="w"> </span><span class="n">guest</span><span class="w"> </span><span class="n">never</span><span class="w"> </span><span class="n">invoked</span><span class="w"> </span><span class="err">`</span><span class="n">response</span><span class="o">-</span><span class="n">outparam</span><span class="p">::</span><span class="n">set</span><span class="err">`</span><span class="w"> </span><span class="n">method</span><span class="p">:</span><span class="w"> </span><span class="nc">error</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">executing</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span><span class="p">:</span>
<span class="w">    </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="mh">0x258f2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">__rust_start_panic</span>
<span class="w">    </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="mh">0x2546e</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">rust_panic</span>
<span class="w">    </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="mh">0x25224</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">std</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">rust_panic_with_hook</span><span class="p">::</span><span class="n">h8bb4f94cf9e68e20</span>
<span class="w">    </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="mh">0x24646</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">std</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">begin_panic_handler</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}::</span><span class="n">h2c354a3372fcca00</span>
<span class="w">    </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="mh">0x245ad</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">std</span><span class="p">::</span><span class="n">sys_common</span><span class="p">::</span><span class="n">backtrace</span><span class="p">::</span><span class="n">__rust_end_short_backtrace</span><span class="p">::</span><span class="n">hf791a0fba63af5e9</span>
<span class="w">    </span><span class="mi">5</span><span class="p">:</span><span class="w"> </span><span class="mh">0x24dbc</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">rust_begin_unwind</span>
<span class="w">    </span><span class="mi">6</span><span class="p">:</span><span class="w"> </span><span class="mh">0x2a66b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">panic_fmt</span><span class="p">::</span><span class="n">haadcabb094f4c85b</span>
<span class="w">    </span><span class="mi">7</span><span class="p">:</span><span class="w"> </span><span class="mh">0x2c2de</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">core</span><span class="p">::</span><span class="n">result</span><span class="p">::</span><span class="n">unwrap_failed</span><span class="p">::</span><span class="n">hd09ff05c9c2fb25f</span>
<span class="w">    </span><span class="mi">8</span><span class="p">:</span><span class="w"> </span><span class="mh">0x6a1d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!&lt;</span><span class="n">wasmtime_filesystem_debug</span><span class="p">::</span><span class="n">Component</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">wasi</span><span class="p">::</span><span class="n">proxy</span><span class="p">::</span><span class="n">exports</span><span class="p">::</span><span class="n">wasi</span><span class="p">::</span><span class="n">http</span><span class="p">::</span><span class="n">incoming_handler</span><span class="p">::</span><span class="n">Guest</span><span class="o">&gt;</span><span class="p">::</span><span class="n">handle</span><span class="p">::</span><span class="n">hd44cd139d21c109c</span>
<span class="w">    </span><span class="mi">9</span><span class="p">:</span><span class="w"> </span><span class="mh">0x7853</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">wasi</span><span class="p">::</span><span class="n">proxy</span><span class="p">::</span><span class="n">exports</span><span class="p">::</span><span class="n">wasi</span><span class="p">::</span><span class="n">http</span><span class="p">::</span><span class="n">incoming_handler</span><span class="p">::</span><span class="n">_export_handle_cabi</span><span class="p">::</span><span class="n">he753d69b8503d63c</span>
<span class="w">   </span><span class="mi">10</span><span class="p">:</span><span class="w"> </span><span class="mh">0x7798</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">wasi</span><span class="p">:</span><span class="nc">http</span><span class="o">/</span><span class="n">incoming</span><span class="o">-</span><span class="n">handler</span><span class="o">@</span><span class="mf">0.2.1</span><span class="p">#</span><span class="n">handle</span>
<span class="n">note</span><span class="p">:</span><span class="w"> </span><span class="nc">using</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">`</span><span class="n">WASMTIME_BACKTRACE_DETAILS</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">debugging</span><span class="w"> </span><span class="n">information</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span><span class="p">:</span>
<span class="w">    </span><span class="nc">wasm</span><span class="w"> </span><span class="n">trap</span><span class="p">:</span><span class="w"> </span><span class="nc">wasm</span><span class="w"> </span><span class="err">`</span><span class="n">unreachable</span><span class="err">`</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="n">executed</span><span class="p">)</span>
</code></pre></div>
<p>The important error is this one:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">find</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">pre</span><span class="o">-</span><span class="n">opened</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">descriptor</span><span class="w"> </span><span class="n">through</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="err">\</span><span class="s">"/shenanigans</span><span class="se">\"</span><span class="s"> could be opened</span>
</code></pre></div>
<p>coming from this source code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">fs</span><span class="p">::</span><span class="n">read_dir</span><span class="p">(</span><span class="s">"/shenanigans"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span>
</code></pre></div>
<p>where the command to start it was</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="p">.</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="n">serve</span><span class="w"> </span><span class="o">--</span><span class="n">dir</span><span class="o">=/</span><span class="n">shenanigans</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasip1</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">wasmtime_filesystem_debug</span><span class="p">.</span><span class="n">wasm</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: wasmtime-cli 24.0.0</p>
<p>Operating system: linux bullseye (docker base image is <code>rust:bullseye</code>)</p>
<p>Architecture: aarch64-unknown-linux-gnu</p>
<h3>Extra Info</h3>
<p>It looks like preopen doesn't happen with wasmtime serve, as there's no <code>openat</code> syscall to the directory we're trying to preopen. For comparison I also have a <a href="https://github.com/javorszky/wasmtime-fscheck-cli">cli version of the wasm with a preopened directory</a> where I can see an <code>openat</code> call to the directory I specified in <code>strace</code>, and the component prints out the contents of the directory as expected.</p>
<p>I also tried many variations of passing <code>-Scli=y -Spreview2=y</code> with no fix to directory access.</p>
<p>Adding <code>-Dlogging=y</code> does not yield anything useful.</p>
<p>My assumption that <code>wasmtime serve</code> should honour the <code>--dir</code> flag is based on the following:<br>
* PR 8279: <a href="https://github.com/bytecodealliance/wasmtime/pull/8279">https://github.com/bytecodealliance/wasmtime/pull/8279</a><br>
* conversation in issue 8086: <a href="https://github.com/bytecodealliance/wasmtime/issues/8086">https://github.com/bytecodealliance/wasmtime/issues/8086</a><br>
* this source code dive:<br>
  1. serve command's <a href="https://github.com/bytecodealliance/wasmtime/blob/main/src/commands/serve.rs#L484">handle_request calls new_store</a><br>
  2. serve command's <a href="https://github.com/bytecodealliance/wasmtime/blob/main/src/commands/serve.rs#L137">new_store calls configure_wasip2</a><br>
  3. <a href="https://github.com/bytecodealliance/wasmtime/blob/v24.0.0/src/common.rs#L293">common's configure_wasip2 iterates over the directories to open</a></p>
<p>It looks like common's <code>self.dirs</code> is not getting populated from the command line argument.<br>
</p>
</blockquote>



<a name="467327005"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239194%20wasmtime%20serve%20seems%20to%20ignore%20--d.../near/467327005" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239194.20wasmtime.20serve.20seems.20to.20ignore.20--d.2E.2E.2E.html#467327005">(Sep 03 2024 at 17:57)</a>:</h4>
<p>javorszky <a href="https://github.com/bytecodealliance/wasmtime/issues/9194#issuecomment-2327112200">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9194">issue #9194</a>:</p>
<blockquote>
<p>Excellent, thank you! I'll put together some documentation once I figure out what it does in detail <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span> </p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>