<html>
<head><meta charset="utf-8"><title>wasmtime / issue #7001 new: declare type wasi_ctx in c-api · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237001.20new.3A.20declare.20type.20wasi_ctx.20in.20c-api.html">wasmtime / issue #7001 new: declare type wasi_ctx in c-api</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="390398997"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237001%20new%3A%20declare%20type%20wasi_ctx%20in%20c-api/near/390398997" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237001.20new.3A.20declare.20type.20wasi_ctx.20in.20c-api.html#390398997">(Sep 11 2023 at 22:31)</a>:</h4>
<p>gaukas <a href="https://github.com/bytecodealliance/wasmtime/pull/7001#issuecomment-1714672189">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7001">issue #7001</a>:</p>
<blockquote>
<p>fixing Rustfmt... </p>
</blockquote>



<a name="390400597"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237001%20new%3A%20declare%20type%20wasi_ctx%20in%20c-api/near/390400597" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237001.20new.3A.20declare.20type.20wasi_ctx.20in.20c-api.html#390400597">(Sep 11 2023 at 22:43)</a>:</h4>
<p>gaukas edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/7001#issuecomment-1714672189">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7001">issue #7001</a>:</p>
<blockquote>
<p>fixing Rustfmt... Done. </p>
</blockquote>



<a name="390400642"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237001%20new%3A%20declare%20type%20wasi_ctx%20in%20c-api/near/390400642" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237001.20new.3A.20declare.20type.20wasi_ctx.20in.20c-api.html#390400642">(Sep 11 2023 at 22:43)</a>:</h4>
<p>gaukas edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/7001#issuecomment-1714672189">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7001">issue #7001</a>:</p>
<blockquote>
<p>Fixing Rustfmt... [DONE]</p>
</blockquote>



<a name="390412835"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237001%20new%3A%20declare%20type%20wasi_ctx%20in%20c-api/near/390412835" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237001.20new.3A.20declare.20type.20wasi_ctx.20in.20c-api.html#390412835">(Sep 12 2023 at 00:16)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/pull/7001#issuecomment-1714782138">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7001">issue #7001</a>:</p>
<blockquote>
<p>I missed the discussion in <a href="https://github.com/bytecodealliance/wasmtime-go/issues/187">https://github.com/bytecodealliance/wasmtime-go/issues/187</a> and I am a little nervous about these changes - they can be supported today, but will have to change substantially in the future.</p>
<p>In our preview 2 implementation, we have eliminated all of the user-facing methods on WasiCtx. This is required due to new invariants that we need to maintain for preview 2 resources. You can still insert directories into a WasiCtx while in the builder. We also eliminated the WasiFile/WasiDir traits as a mechanism for extending the Wasi implementation. We do have extension traits for implementing streams (which maybe will be what you need, to expose pipes?) and a totally new interface and implementation for sockets. The story for how to expose these new interfaces to guests is itself a bit involved as well - we have adapters to transition modules consuming just Wasi preview 1, but it sounds like you are using preview 1 plus some other imports as well.</p>
<p>We expect the preview 2 builder/context (defined in <code>wasmtime-wasi::preview2</code>) will supplant the preview 1 implementation (defined in <code>wasi-common</code>) pretty soon, and preview 1 will be supported through the p2-&gt;p1 host compatibility layer (<code>wasmtime-wasi::preview2::preview1</code>). We will be supporting both the new and old Wasi implementations a little while for users to transition, but that is much easier to manage in Rust than in the C API. The existing C APIs which end up connecting to wasi-common are pretty easy to transition over wasmtime-wasi::preview2, but these methods will not be possible to transition.</p>
<p>One way we can bypass the many wrinkles in this story is if we can switch you over to using Wasi Preview 2 and the Component Model. That still has open questions about how to use the C FFI, but those are questions that it will benefit a lot of users to solve, whereas if we expose these methods for just you to use today, we'll also have to solve other problems for just you in a few months when it is time to transition to preview 2.</p>
</blockquote>



<a name="390412909"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237001%20new%3A%20declare%20type%20wasi_ctx%20in%20c-api/near/390412909" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237001.20new.3A.20declare.20type.20wasi_ctx.20in.20c-api.html#390412909">(Sep 12 2023 at 00:17)</a>:</h4>
<p>pchickey edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/7001#issuecomment-1714782138">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7001">issue #7001</a>:</p>
<blockquote>
<p>I missed the discussion in <a href="https://github.com/bytecodealliance/wasmtime-go/issues/187">https://github.com/bytecodealliance/wasmtime-go/issues/187</a> and I am a little nervous about these changes - they can be supported today, but will have to change substantially in the future.</p>
<p>In our preview 2 implementation, we have eliminated all of the user-facing methods on WasiCtx. This is required due to new invariants that we need to maintain for preview 2 resources. You can still insert (host filesystem) directories into a WasiCtx while in the builder. We also eliminated the WasiFile/WasiDir traits as a mechanism for extending the Wasi implementation. We do have extension traits for implementing streams (which maybe will be what you need, to expose pipes?) and a totally new interface and implementation for sockets. The story for how to expose these new interfaces to guests is itself a bit involved as well - we have adapters to transition modules consuming just Wasi preview 1, but it sounds like you are using preview 1 plus some other imports as well.</p>
<p>We expect the preview 2 builder/context (defined in <code>wasmtime-wasi::preview2</code>) will supplant the preview 1 implementation (defined in <code>wasi-common</code>) pretty soon, and preview 1 will be supported through the p2-&gt;p1 host compatibility layer (<code>wasmtime-wasi::preview2::preview1</code>). We will be supporting both the new and old Wasi implementations a little while for users to transition, but that is much easier to manage in Rust than in the C API. The existing C APIs which end up connecting to wasi-common are pretty easy to transition over wasmtime-wasi::preview2, but these methods will not be possible to transition.</p>
<p>One way we can bypass the many wrinkles in this story is if we can switch you over to using Wasi Preview 2 and the Component Model. That still has open questions about how to use the C FFI, but those are questions that it will benefit a lot of users to solve, whereas if we expose these methods for just you to use today, we'll also have to solve other problems for just you in a few months when it is time to transition to preview 2.</p>
</blockquote>



<a name="390413531"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237001%20new%3A%20declare%20type%20wasi_ctx%20in%20c-api/near/390413531" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237001.20new.3A.20declare.20type.20wasi_ctx.20in.20c-api.html#390413531">(Sep 12 2023 at 00:21)</a>:</h4>
<p>pchickey edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/7001#issuecomment-1714782138">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7001">issue #7001</a>:</p>
<blockquote>
<p>I missed the discussion in <a href="https://github.com/bytecodealliance/wasmtime-go/issues/187">https://github.com/bytecodealliance/wasmtime-go/issues/187</a> and I am a little nervous about these changes - they can be supported today, but will have to change substantially in the future.</p>
<p>In our preview 2 implementation, we have eliminated all of the user-facing methods on WasiCtx. This is required due to new invariants that we need to maintain for preview 2 resources. You can still insert (host filesystem) directories into a WasiCtx while in the builder. We also eliminated the WasiFile/WasiDir traits as a mechanism for extending the Wasi implementation. We do have extension traits for implementing streams (which maybe will be what you need, to expose pipes?) and a totally new interface and implementation for sockets. The story for how to expose these new interfaces to guests is itself a bit involved as well - we have adapters to transition modules consuming just Wasi preview 1, but it sounds like you are using preview 1 plus some other imports as well.</p>
<p>We expect the preview 2 builder/context (defined in <code>wasmtime-wasi::preview2</code>) will supplant the preview 1 implementation (defined in <code>wasi-common</code>) pretty soon, and preview 1 will be supported through the p2-&gt;p1 host compatibility layer (<code>wasmtime-wasi::preview2::preview1</code>). We will be supporting both the new and old Wasi implementations a little while for users to transition, but that is much easier to manage in Rust than in the C API. The existing C APIs which end up connecting to wasi-common are pretty easy to transition over wasmtime-wasi::preview2, but these methods will not be possible to transition.</p>
<p>One way we can bypass the many wrinkles in this story is if we can switch you over to using Wasi Preview 2 and the Component Model. That still has open questions about how to use the C FFI, but those are questions that it will benefit a lot of users to solve, whereas if we expose these methods for just you to use today, we'll also have to solve other problems for just you in a few months when it is time to transition to preview 2.</p>
<p>This is a pretty complex design space which doesn't have much by the way of docs, so if I can help you understand this problem better by discussing it, we can talk on the bytecode alliance zulip or setup a call sometime.</p>
</blockquote>



<a name="390416614"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237001%20new%3A%20declare%20type%20wasi_ctx%20in%20c-api/near/390416614" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237001.20new.3A.20declare.20type.20wasi_ctx.20in.20c-api.html#390416614">(Sep 12 2023 at 00:42)</a>:</h4>
<p>gaukas <a href="https://github.com/bytecodealliance/wasmtime/pull/7001#issuecomment-1714800093">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7001">issue #7001</a>:</p>
<blockquote>
<p>I understand your concern. The reason for this PR to exist is simply that the Go's implementation of wasmtime (as <a href="https://github.com/bytecodealliance/wasmtime-go">wasmtime-go</a>) has been missing way too many features from its Rust counterpart, and we really need BOTH to work on the same page. There's a set of projects we are working on right now and part of its job can ONLY be done in Go. However the gap between two implementation due to the absence of relevant C-API is irritating, and it feels like it is never a part of plan to allow the users with Go to do as much as Rust users can. If so, it is pretty sad, as I believe Go has its significance as much as Rust do. </p>
<p>It is not a bad idea to switch over to wasi preview2, but I am concerned about the amount of work needed to fill the gap in wasmtime-go, given it looks like not as popular and already fell short on features in preview 1. In the long run I believe it is definitely worth considering, though, if it implements a much more consistent feature set in across all ports. Specifically, the ability to inject sockets AFTER instance has been created/running.</p>
<p>A discussion will be nice to have, we can start by setting up a covert communication channel. Please feel free to shoot me an email if you wish.  </p>
</blockquote>



<a name="390427885"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237001%20new%3A%20declare%20type%20wasi_ctx%20in%20c-api/near/390427885" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237001.20new.3A.20declare.20type.20wasi_ctx.20in.20c-api.html#390427885">(Sep 12 2023 at 01:56)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/7001#issuecomment-1714849559">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7001">issue #7001</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @peterhuene</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "wasmtime:c-api"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>peterhuene: wasmtime:c-api</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="390569441"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237001%20new%3A%20declare%20type%20wasi_ctx%20in%20c-api/near/390569441" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237001.20new.3A.20declare.20type.20wasi_ctx.20in.20c-api.html#390569441">(Sep 12 2023 at 17:55)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/pull/7001#issuecomment-1716180012">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7001">issue #7001</a>:</p>
<blockquote>
<p>Wasmtime's C FFI isn't fully fleshed out, not because we don't want it to be, but because we have had other priorities. We are happy to help contributors add C FFI support for the parts of wasmtime where it is missing right now.</p>
</blockquote>



<a name="390599700"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237001%20new%3A%20declare%20type%20wasi_ctx%20in%20c-api/near/390599700" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237001.20new.3A.20declare.20type.20wasi_ctx.20in.20c-api.html#390599700">(Sep 12 2023 at 21:28)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/pull/7001#issuecomment-1716475849">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7001">issue #7001</a>:</p>
<blockquote>
<p>I looked at this again and talked to @alexcrichton about how we can move this over to preview 2 and I'm comfortable with it once he signs it off.</p>
</blockquote>



<a name="390965908"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237001%20new%3A%20declare%20type%20wasi_ctx%20in%20c-api/near/390965908" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237001.20new.3A.20declare.20type.20wasi_ctx.20in.20c-api.html#390965908">(Sep 14 2023 at 15:26)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/7001#issuecomment-1719673629">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7001">issue #7001</a>:</p>
<blockquote>
<p>Personally I don't think that <code>void*</code> should be used here as a placeholder for <code>HANDLE</code>-or-<code>int</code>. I realize this is what Go seems to do with <code>uintptr</code> as the return value from the <code>Fd()</code> method, but that's not how I'd personally do it. That being said I also don't have a lot of prior experience to draw from. Everything in Rust is "just use <code>File</code>" which isn't an option in C and otherwise I'm not aware of any C libraries that handle the Windows/Unix distinction as they generally take an fd and then don't work on Windows. To me though casting <code>int</code> in C to <code>void*</code> just to pass it to this function feels a bit too weird.</p>
<p>Otherwise though another comment I would have is that <code>#[cfg]</code> can be applied on a much more granular level than the entire function, so I'd recommend avoiding duplication of the entire function bodies in Rust with something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[cfg(unix)]</span>
<span class="kd">let</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span>::<span class="n">from_raw_fd</span><span class="p">(</span><span class="n">the_argument</span><span class="p">);</span>
<span class="cp">#[cfg(windows)]</span>
<span class="kd">let</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span>::<span class="n">from_raw_handle</span><span class="p">(</span><span class="n">the_argumet</span><span class="p">);</span>
</code></pre></div>
<p>(or something like that)</p>
</blockquote>



<a name="390975098"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237001%20new%3A%20declare%20type%20wasi_ctx%20in%20c-api/near/390975098" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237001.20new.3A.20declare.20type.20wasi_ctx.20in.20c-api.html#390975098">(Sep 14 2023 at 16:08)</a>:</h4>
<p>gaukas <a href="https://github.com/bytecodealliance/wasmtime/pull/7001#issuecomment-1719744327">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7001">issue #7001</a>:</p>
<blockquote>
<p>So do we have a conclusion here, shall we include multiple functions for Unix and Windows to have explicit types (<code>int32</code>/<code>i32</code> and <code>void*</code>/<code>HANDLE</code>), or do you think it is okay to save them for later and keep it as you described </p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[cfg(unix)]</span>
<span class="kd">let</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span>::<span class="n">from_raw_fd</span><span class="p">(</span><span class="n">the_argument</span><span class="p">);</span>
<span class="cp">#[cfg(windows)]</span>
<span class="kd">let</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span>::<span class="n">from_raw_handle</span><span class="p">(</span><span class="n">the_argumet</span><span class="p">);</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="391006070"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237001%20new%3A%20declare%20type%20wasi_ctx%20in%20c-api/near/391006070" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237001.20new.3A.20declare.20type.20wasi_ctx.20in.20c-api.html#391006070">(Sep 14 2023 at 19:34)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/7001#issuecomment-1720030487">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7001">issue #7001</a>:</p>
<blockquote>
<p>All I can really offer here is my own personal opinion and preference. My preference is that the types of the argument reflect what the system uses, which in C is <code>int</code> on Unix (not <code>int32_t</code>) and <code>HANDLE</code> on Windows. The Rust version of those is <code>Raw*</code> in the standard library. I don't have a strong preference on whether there's two different names for the function, but I think it's reasonable to have the same symbol with a platform-specific signature, meaning just one function with different types depending on the platform.</p>
</blockquote>



<a name="391090394"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237001%20new%3A%20declare%20type%20wasi_ctx%20in%20c-api/near/391090394" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237001.20new.3A.20declare.20type.20wasi_ctx.20in.20c-api.html#391090394">(Sep 15 2023 at 06:28)</a>:</h4>
<p>gaukas <a href="https://github.com/bytecodealliance/wasmtime/pull/7001#issuecomment-1720745544">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7001">issue #7001</a>:</p>
<blockquote>
<p>Now using <code>RawFd</code> and <code>RawHandle</code>.</p>
<p>On C's side: </p>
<p>Unix: </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">WASM_API_EXTERN</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="n">wasmtime_context_insert_file</span><span class="p">(</span><span class="n">wasmtime_context_t</span><span class="w"> </span><span class="o">*</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">uint32_t</span><span class="w"> </span><span class="n">guest_fd</span><span class="p">,</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="n">host_fd</span><span class="p">,</span><span class="w"> </span><span class="n">uint32_t</span><span class="w"> </span><span class="n">access_mode</span><span class="p">);</span>
<span class="n">WASM_API_EXTERN</span><span class="w"> </span><span class="n">wasmtime_error_t</span><span class="w"> </span><span class="o">*</span><span class="n">wasmtime_context_push_file</span><span class="p">(</span><span class="n">wasmtime_context_t</span><span class="w"> </span><span class="o">*</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="n">host_fd</span><span class="p">,</span><span class="w"> </span><span class="n">uint32_t</span><span class="w"> </span><span class="n">access_mode</span><span class="p">,</span><span class="w"> </span><span class="n">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">guest_fd</span><span class="p">);</span>
</code></pre></div>
<p>Windows: </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">WASM_API_EXTERN</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="n">wasmtime_context_insert_file</span><span class="p">(</span><span class="n">wasmtime_context_t</span><span class="w"> </span><span class="o">*</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">uint32_t</span><span class="w"> </span><span class="n">guest_fd</span><span class="p">,</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="o">*</span><span class="n">host_handle</span><span class="p">,</span><span class="w"> </span><span class="n">uint32_t</span><span class="w"> </span><span class="n">access_mode</span><span class="p">);</span>
<span class="n">WASM_API_EXTERN</span><span class="w"> </span><span class="n">wasmtime_error_t</span><span class="w"> </span><span class="o">*</span><span class="n">wasmtime_context_push_file</span><span class="p">(</span><span class="n">wasmtime_context_t</span><span class="w"> </span><span class="o">*</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="o">*</span><span class="n">host_handle</span><span class="p">,</span><span class="w"> </span><span class="n">uint32_t</span><span class="w"> </span><span class="n">access_mode</span><span class="p">,</span><span class="w"> </span><span class="n">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">guest_fd</span><span class="p">);</span>
</code></pre></div>
<p>Tried to use <code>HANDLE</code> from <code>&lt;winnt.h&gt;</code> but it turns out CGO won't even work, throws a bunch of errors such as </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span>: <span class="nc">unknown</span><span class="w"> </span><span class="k">type</span> <span class="nc">name</span><span class="w"> </span><span class="o">'</span><span class="na">DWORD</span><span class="o">'</span>
<span class="n">error</span>: <span class="nc">unknown</span><span class="w"> </span><span class="k">type</span> <span class="nc">name</span><span class="w"> </span><span class="o">'</span><span class="na">WORD</span><span class="o">'</span>
</code></pre></div>
<p>Defining <code>typedef void *HANDLE</code> in <code>store.h</code> didn't work out for me either, I failed to figure out a way to convert the <code>uintptr</code> into the self-defined <code>C.HANDLE</code> type. Casting into <code>C.HANDLE()</code> simply does not work. Therefore, here I choose to stick with <code>void*</code> in C-API, since it is just its true identity. Please feel free to push any further changes, but I guess that will be all I have for this. </p>
</blockquote>



<a name="391305838"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237001%20new%3A%20declare%20type%20wasi_ctx%20in%20c-api/near/391305838" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237001.20new.3A.20declare.20type.20wasi_ctx.20in.20c-api.html#391305838">(Sep 16 2023 at 01:56)</a>:</h4>
<p>gaukas <a href="https://github.com/bytecodealliance/wasmtime/pull/7001#issuecomment-1722102493">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7001">issue #7001</a>:</p>
<blockquote>
<p>I guess it is time for someone from <code>bytecodealliance</code> to deal with the PR, if you want to make a change, do it. I allowed changes by maintainers. </p>
<p><strong>I already got bored of this low communication efficiency and have much more prioritized work to do.</strong> And all I wanted could already be achieved with my fork, and for code style issue, please, no one can reach the agreement with others so push changes rather than suggesting one. I'm pissed and I hope I made that obvious.  </p>
</blockquote>



<a name="391306592"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237001%20new%3A%20declare%20type%20wasi_ctx%20in%20c-api/near/391306592" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237001.20new.3A.20declare.20type.20wasi_ctx.20in.20c-api.html#391306592">(Sep 16 2023 at 02:01)</a>:</h4>
<p>gaukas <a href="https://github.com/bytecodealliance/wasmtime/pull/7001#issuecomment-1722103977">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7001">issue #7001</a>:</p>
<blockquote>
<p>![image](<a href="https://github.com/bytecodealliance/wasmtime/assets/9084527/bfad862e-3209-4cae-931f-92128357dcc0">https://github.com/bytecodealliance/wasmtime/assets/9084527/bfad862e-3209-4cae-931f-92128357dcc0</a>)</p>
</blockquote>



<a name="391707723"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237001%20new%3A%20declare%20type%20wasi_ctx%20in%20c-api/near/391707723" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237001.20new.3A.20declare.20type.20wasi_ctx.20in.20c-api.html#391707723">(Sep 18 2023 at 14:05)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/7001#issuecomment-1723497025">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7001">issue #7001</a>:</p>
<blockquote>
<p>Ok thanks for the initial effort here. I'm going to close this and others can pick this up if they're interseted. If you feel inspired in the future feel free to reopen and/or resubmit as well.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>