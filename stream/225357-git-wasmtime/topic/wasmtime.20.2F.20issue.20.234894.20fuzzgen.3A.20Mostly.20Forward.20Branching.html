<html>
<head><meta charset="utf-8"><title>wasmtime / issue #4894 fuzzgen: Mostly Forward Branching · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html">wasmtime / issue #4894 fuzzgen: Mostly Forward Branching</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="298836400"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298836400" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298836400">(Sep 14 2022 at 19:24)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#issuecomment-1247205882">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4894">issue #4894</a>:</p>
<blockquote>
<p>Hey, I think I addressed most of the feedback above (Thanks for the great review!).</p>
<p>I've also done some additional changes:</p>
<ul>
<li>Added the <code>backwards_block_ratio</code> to the config</li>
<li>Moved all of the block generation code to inside <code>generate_blocks</code></li>
</ul>
</blockquote>



<a name="298836584"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298836584" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298836584">(Sep 14 2022 at 19:25)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#issuecomment-1247205882">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4894">issue #4894</a>:</p>
<blockquote>
<p>Hey, I think I addressed most of the feedback above (Thanks for the great review!). I've added this to the last two commits so that its easier to review.</p>
<p>I've also done some additional changes:</p>
<ul>
<li>Added the <code>backwards_block_ratio</code> to the config</li>
<li>Moved all of the block generation code to inside <code>generate_blocks</code></li>
</ul>
<p>Edit: Oops, it now has conflicts, I'll rebase.</p>
</blockquote>



<a name="298836607"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298836607" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298836607">(Sep 14 2022 at 19:25)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#issuecomment-1247205882">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4894">issue #4894</a>:</p>
<blockquote>
<p>Hey, I think I addressed most of the feedback above (Thanks for the great review!). I've added this to the last two commits so that its easier to review.</p>
<p>I've also done some additional changes:</p>
<ul>
<li>Added the <code>backwards_block_ratio</code> to the config</li>
<li>Moved all of the block generation code inside <code>generate_blocks</code></li>
</ul>
<p>Edit: Oops, it now has conflicts, I'll rebase.</p>
</blockquote>



<a name="298838537"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298838537" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298838537">(Sep 14 2022 at 19:37)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#issuecomment-1247205882">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4894">issue #4894</a>:</p>
<blockquote>
<p>Hey, I think I addressed most of the feedback above (Thanks for the great review!). I've added this to the last two commits so that its easier to review.</p>
<p>I've also done some additional changes:</p>
<ul>
<li>Added the <code>backwards_block_ratio</code> to the config</li>
<li>Moved all of the block generation code inside <code>generate_blocks</code></li>
</ul>
<p>Edit: Oops, it now has conflicts, I'll rebase.<br>
Edit2: Rebased, But I'm going to fuzz this for a bit</p>
</blockquote>



<a name="298842468"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298842468" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298842468">(Sep 14 2022 at 20:02)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#issuecomment-1247243538">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4894">issue #4894</a>:</p>
<blockquote>
<p>Something went wrong in the rebase and its now crashing, I'm going to take a look at this again tomorrow.</p>
</blockquote>



<a name="298981415"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298981415" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298981415">(Sep 15 2022 at 14:25)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#issuecomment-1248179094">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4894">issue #4894</a>:</p>
<blockquote>
<p>So, it turns out nothing went wrong in the rebase and it was a preexisting issue with this PR. We were sometimes selecting <code>block0</code> as a target for branching, which makes the verifier very unhappy. I didn't notice this because these inputs were silently being rejected and #4896 finally exposed this.</p>
<p>I think this may explain the difference between the results in this PR and the original stats in <a href="https://github.com/bytecodealliance/wasmtime/issues/3050#issuecomment-1243037213">https://github.com/bytecodealliance/wasmtime/issues/3050#issuecomment-1243037213</a>. Although here we have 10k stacks where we don't know what happened and that seems quite a bit.</p>
<p>I'm re running the benchmarks to see if this discrepancy has gone away.</p>
</blockquote>



<a name="299025247"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/299025247" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#299025247">(Sep 15 2022 at 18:12)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#issuecomment-1248438739">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4894">issue #4894</a>:</p>
<blockquote>
<p>So, here are the results.</p>
<p>This is using a custom patch on top of the arbitrary crate to report failures. See <a href="https://github.com/bytecodealliance/wasmtime/issues/3050#issuecomment-1244761070">https://github.com/bytecodealliance/wasmtime/issues/3050#issuecomment-1244761070</a> for more details.</p>
<p>&lt;details&gt;<br>
&lt;summary&gt;&lt;h3&gt;Baseline&lt;/h3&gt;&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="mi">99826</span><span class="w">  </span><span class="n">NEW</span><span class="w">    </span><span class="n">cov</span>: <span class="mi">32083</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">189603</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">5384</span><span class="o">/</span><span class="mi">10156</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">1048576</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">10</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">1030</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">2586</span><span class="o">/</span><span class="mi">1048576</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">4</span><span class="w"> </span><span class="n">EraseBytes</span><span class="o">-</span><span class="n">ChangeASCIIInt</span><span class="o">-</span><span class="n">ShuffleBytes</span><span class="o">-</span><span class="n">PersAutoDict</span><span class="o">-</span><span class="w"> </span><span class="n">DE</span>: <span class="s">"Q</span><span class="se">\x03\x00\x00\x00\x00\x00</span><span class="s">\x0</span>
<span class="s">0"</span><span class="o">-</span><span class="w"></span>
<span class="o">==</span><span class="w"> </span><span class="n">FuzzGen</span><span class="w"> </span><span class="n">Statistics</span><span class="w">  </span><span class="o">====================</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">100000</span><span class="w"></span>
<span class="n">Valid</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">61534</span><span class="w"> </span><span class="p">(</span><span class="mf">61.5</span><span class="o">%</span><span class="p">)</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">426680</span><span class="w"></span>
<span class="n">Successful</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">211464</span><span class="w"> </span><span class="p">(</span><span class="mf">49.6</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Timed</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">34331</span><span class="w"> </span><span class="p">(</span><span class="mf">8.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Traps</span>:
        <span class="nc">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">int_divz</span>: <span class="mi">180882</span><span class="w"> </span><span class="p">(</span><span class="mf">42.4</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">heap_misaligned</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">icall_null</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">bad_toint</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">resumable</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">int_ovf</span>: <span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">interrupt</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">debug</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">stk_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">bad_sig</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">unreachable</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">heap_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">table_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">[</span><span class="n">BUILD</span><span class="p">]</span><span class="w"> </span><span class="n">stack</span><span class="p">.</span><span class="n">rs</span><span class="w"></span>
<span class="n">Loaded</span><span class="w"> </span><span class="mi">10000</span><span class="w"></span>
<span class="n">Loaded</span><span class="w"> </span><span class="mi">20000</span><span class="w"></span>
<span class="n">Loaded</span><span class="w"> </span><span class="mi">30000</span><span class="w"></span>
<span class="n">Loaded</span><span class="w"> </span><span class="mi">38472</span><span class="w"> </span><span class="n">stacks</span><span class="w"></span>

<span class="n">First</span><span class="w"> </span><span class="n">Line</span><span class="w"> </span><span class="n">duplicates</span><span class="w"></span>
<span class="mf">100.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">38472</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>: <span class="nc">EmptyChoose</span><span class="w"></span>

<span class="n">Two</span><span class="w"> </span><span class="n">Line</span><span class="w"> </span><span class="n">duplicates</span><span class="w"></span>
<span class="mf">6.3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">2415</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>: <span class="nc">EmptyChoose</span><span class="w"></span>
<span class="w">   </span><span class="mi">0</span>: <span class="nc">arbitrary</span>::<span class="n">trace_error</span><span class="w"></span>
<span class="w">   </span><span class="mi">1</span>: <span class="nc">arbitrary</span>::<span class="n">unstructured</span>::<span class="n">Unstructured</span>::<span class="n">choose_index</span><span class="w"></span>
<span class="w">   </span><span class="mi">2</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_br_table</span><span class="w"></span>
<span class="mf">8.3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">3199</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>: <span class="nc">EmptyChoose</span><span class="w"></span>
<span class="w">   </span><span class="mi">0</span>: <span class="nc">arbitrary</span>::<span class="n">trace_error</span><span class="w"></span>
<span class="w">   </span><span class="mi">1</span>: <span class="nc">arbitrary</span>::<span class="n">unstructured</span>::<span class="n">Unstructured</span>::<span class="n">choose_index</span><span class="w"></span>
<span class="w">   </span><span class="mi">2</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_jumptables</span><span class="w"></span>
<span class="mf">1.4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">534</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>: <span class="nc">EmptyChoose</span><span class="w"></span>
<span class="w">   </span><span class="mi">0</span>: <span class="nc">arbitrary</span>::<span class="n">trace_error</span><span class="w"></span>
<span class="w">   </span><span class="mi">1</span>: <span class="nc">arbitrary</span>::<span class="n">unstructured</span>::<span class="n">Unstructured</span>::<span class="n">choose_index</span><span class="w"></span>
<span class="w">   </span><span class="mi">2</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_switch</span><span class="w"></span>
<span class="mf">20.2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">7779</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>: <span class="nc">EmptyChoose</span><span class="w"></span>
<span class="w">   </span><span class="mi">0</span>: <span class="nc">arbitrary</span>::<span class="n">trace_error</span><span class="w"></span>
<span class="w">   </span><span class="mi">1</span>: <span class="nc">arbitrary</span>::<span class="n">unstructured</span>::<span class="n">Unstructured</span>::<span class="n">choose_index</span><span class="w"></span>
<span class="w">   </span><span class="mi">2</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_target_block</span><span class="w"></span>
<span class="mf">35.2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">13526</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>: <span class="nc">EmptyChoose</span><span class="w"></span>
<span class="w">   </span><span class="mi">0</span>: <span class="nc">arbitrary</span>::<span class="n">trace_error</span><span class="w"></span>
<span class="w">   </span><span class="mi">1</span>: <span class="nc">arbitrary</span>::<span class="n">unstructured</span>::<span class="n">Unstructured</span>::<span class="n">choose_index</span><span class="w"></span>
<span class="w">   </span><span class="mi">2</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="mf">21.9</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">8413</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>: <span class="nc">EmptyChoose</span><span class="w"></span>
<span class="w">   </span><span class="mi">0</span>: <span class="nc">arbitrary</span>::<span class="n">trace_error</span><span class="w"></span>
<span class="w">   </span><span class="mi">1</span>: <span class="nc">arbitrary</span>::<span class="n">unstructured</span>::<span class="n">Unstructured</span>::<span class="n">choose_index</span><span class="w"></span>
<span class="w">   </span><span class="mi">2</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">stack_slot_with_size</span><span class="w"></span>
<span class="mf">6.8</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">2606</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>: <span class="nc">EmptyChoose</span><span class="w"></span>
<span class="w">   </span><span class="mi">0</span>: <span class="nc">arbitrary</span>::<span class="n">trace_error</span><span class="w"></span>
<span class="w">   </span><span class="mi">1</span>: <span class="nc">arbitrary</span>::<span class="n">unstructured</span>::<span class="n">Unstructured</span>::<span class="n">choose_index</span><span class="w"></span>
<span class="w">   </span><span class="mi">2</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">insert_call</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>&lt;details&gt;<br>
&lt;summary&gt;&lt;h3&gt;This PR&lt;/h3&gt;&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="mi">99990</span><span class="w">  </span><span class="n">REDUCE</span><span class="w"> </span><span class="n">cov</span>: <span class="mi">31890</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">186525</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">4925</span><span class="o">/</span><span class="mi">10508</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">393599</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">19</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">1034</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">144</span><span class="o">/</span><span class="mi">316625</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">1</span><span class="w"> </span><span class="n">EraseBytes</span><span class="o">-</span><span class="w"></span>
<span class="o">==</span><span class="w"> </span><span class="n">FuzzGen</span><span class="w"> </span><span class="n">Statistics</span><span class="w">  </span><span class="o">====================</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">100000</span><span class="w"></span>
<span class="n">Valid</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">74409</span><span class="w"> </span><span class="p">(</span><span class="mf">74.4</span><span class="o">%</span><span class="p">)</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">1540097</span><span class="w"></span>
<span class="n">Successful</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">1240133</span><span class="w"> </span><span class="p">(</span><span class="mf">80.5</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Timed</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">356</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Traps</span>:
        <span class="nc">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">unreachable</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">stk_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">int_divz</span>: <span class="mi">299534</span><span class="w"> </span><span class="p">(</span><span class="mf">19.4</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">heap_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">bad_toint</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">int_ovf</span>: <span class="mi">74</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">table_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">resumable</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">debug</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">heap_misaligned</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">icall_null</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">bad_sig</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">interrupt</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">[</span><span class="n">BUILD</span><span class="p">]</span><span class="w"> </span><span class="n">stack</span><span class="p">.</span><span class="n">rs</span><span class="w"></span>
<span class="n">Loaded</span><span class="w"> </span><span class="mi">10000</span><span class="w"></span>
<span class="n">Loaded</span><span class="w"> </span><span class="mi">20000</span><span class="w"></span>
<span class="n">Loaded</span><span class="w"> </span><span class="mi">25591</span><span class="w"> </span><span class="n">stacks</span><span class="w"></span>

<span class="n">First</span><span class="w"> </span><span class="n">Line</span><span class="w"> </span><span class="n">duplicates</span><span class="w"></span>
<span class="mf">100.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">25591</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>: <span class="nc">EmptyChoose</span><span class="w"></span>

<span class="n">Two</span><span class="w"> </span><span class="n">Line</span><span class="w"> </span><span class="n">duplicates</span><span class="w"></span>
<span class="mf">59.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">15098</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>: <span class="nc">EmptyChoose</span><span class="w"></span>
<span class="w">   </span><span class="mi">0</span>: <span class="nc">arbitrary</span>::<span class="n">trace_error</span><span class="w"></span>
<span class="w">   </span><span class="mi">1</span>: <span class="nc">arbitrary</span>::<span class="n">unstructured</span>::<span class="n">Unstructured</span>::<span class="n">choose_index</span><span class="w"></span>
<span class="w">   </span><span class="mi">2</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="mf">29.9</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">7645</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>: <span class="nc">EmptyChoose</span><span class="w"></span>
<span class="w">   </span><span class="mi">0</span>: <span class="nc">arbitrary</span>::<span class="n">trace_error</span><span class="w"></span>
<span class="w">   </span><span class="mi">1</span>: <span class="nc">arbitrary</span>::<span class="n">unstructured</span>::<span class="n">Unstructured</span>::<span class="n">choose_index</span><span class="w"></span>
<span class="w">   </span><span class="mi">2</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">stack_slot_with_size</span><span class="w"></span>
<span class="mf">11.1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">2848</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>: <span class="nc">EmptyChoose</span><span class="w"></span>
<span class="w">   </span><span class="mi">0</span>: <span class="nc">arbitrary</span>::<span class="n">trace_error</span><span class="w"></span>
<span class="w">   </span><span class="mi">1</span>: <span class="nc">arbitrary</span>::<span class="n">unstructured</span>::<span class="n">Unstructured</span>::<span class="n">choose_index</span><span class="w"></span>
<span class="w">   </span><span class="mi">2</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">insert_call</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<ol>
<li>
<p>Wow! #4895 makes a big difference in <code>int_divz</code> traps!</p>
</li>
<li>
<p>For baseline we have <code>38472</code> stacks and <code>(100000-61534)=38466</code> invalid inputs. That is close enough that I'm going to call it valid. I suspect the 6 extra stacks come from the fact that I run this with <code>-runs=100010</code> and 6 out of those 10 extra executions failed.</p>
</li>
</ol>
<p>I think this should be good for merging now. We no longer see the discrepancy in stacks.</p>
</blockquote>



<a name="299029674"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/299029674" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#299029674">(Sep 15 2022 at 18:39)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#issuecomment-1248465867">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4894">issue #4894</a>:</p>
<blockquote>
<p>This is fantastic. To summarize your statistics:</p>
<ul>
<li>21% increase in valid inputs</li>
<li>more than 3x as many total runs while doubling executions per second</li>
<li>almost 6x as many successful runs</li>
<li>eliminated almost 99% of timeouts</li>
</ul>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>