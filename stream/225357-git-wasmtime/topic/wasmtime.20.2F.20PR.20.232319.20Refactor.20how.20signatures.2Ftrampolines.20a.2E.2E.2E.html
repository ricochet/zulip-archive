<html>
<head><meta charset="utf-8"><title>wasmtime / PR #2319 Refactor how signatures/trampolines a... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232319.20Refactor.20how.20signatures.2Ftrampolines.20a.2E.2E.2E.html">wasmtime / PR #2319 Refactor how signatures/trampolines a...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="214517525"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232319%20Refactor%20how%20signatures/trampolines%20a.../near/214517525" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232319.20Refactor.20how.20signatures.2Ftrampolines.20a.2E.2E.2E.html#214517525">(Oct 25 2020 at 22:56)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/2319">PR #2319</a> from <code>remove-trampolines-from-instance</code> to <code>main</code>:</p>
<blockquote>
<p>This commit refactors where trampolines and signature information is<br>
stored within a <code>Store</code>, namely moving them from<br>
<code>wasmtime_runtime::Instance</code> instead to <code>Store</code> itself. The goal here is<br>
to remove an allocation inside of an <code>Instance</code> and make them a bit<br>
cheaper to create. Additionally this should open up future possibilities<br>
like not creating duplicate trampolines for signatures already in the<br>
<code>Store</code> when using <code>Func::new</code>.</p>
</blockquote>



<a name="214517632"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232319%20Refactor%20how%20signatures/trampolines%20a.../near/214517632" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232319.20Refactor.20how.20signatures.2Ftrampolines.20a.2E.2E.2E.html#214517632">(Oct 25 2020 at 22:59)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2319">PR #2319</a> from <code>remove-trampolines-from-instance</code> to <code>main</code>:</p>
<blockquote>
<p>This commit refactors where trampolines and signature information is<br>
stored within a <code>Store</code>, namely moving them from<br>
<code>wasmtime_runtime::Instance</code> instead to <code>Store</code> itself. The goal here is<br>
to remove an allocation inside of an <code>Instance</code> and make them a bit<br>
cheaper to create. Additionally this should open up future possibilities<br>
like not creating duplicate trampolines for signatures already in the<br>
<code>Store</code> when using <code>Func::new</code>.</p>
</blockquote>



<a name="215160898"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232319%20Refactor%20how%20signatures/trampolines%20a.../near/215160898" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232319.20Refactor.20how.20signatures.2Ftrampolines.20a.2E.2E.2E.html#215160898">(Oct 30 2020 at 23:09)</a>:</h4>
<p>pepyakin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2319#pullrequestreview-521080046">PR Review</a>.</p>



<a name="215160899"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232319%20Refactor%20how%20signatures/trampolines%20a.../near/215160899" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232319.20Refactor.20how.20signatures.2Ftrampolines.20a.2E.2E.2E.html#215160899">(Oct 30 2020 at 23:09)</a>:</h4>
<p>pepyakin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2319#discussion_r515418704">PR Review Comment</a>:</p>
<blockquote>
<p>Since this now stores trampolines, it would be great to update the comment.</p>
</blockquote>



<a name="215337202"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232319%20Refactor%20how%20signatures/trampolines%20a.../near/215337202" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232319.20Refactor.20how.20signatures.2Ftrampolines.20a.2E.2E.2E.html#215337202">(Nov 02 2020 at 15:54)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2319">PR #2319</a> from <code>remove-trampolines-from-instance</code> to <code>main</code>:</p>
<blockquote>
<p>This commit refactors where trampolines and signature information is<br>
stored within a <code>Store</code>, namely moving them from<br>
<code>wasmtime_runtime::Instance</code> instead to <code>Store</code> itself. The goal here is<br>
to remove an allocation inside of an <code>Instance</code> and make them a bit<br>
cheaper to create. Additionally this should open up future possibilities<br>
like not creating duplicate trampolines for signatures already in the<br>
<code>Store</code> when using <code>Func::new</code>.</p>
</blockquote>



<a name="215337235"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232319%20Refactor%20how%20signatures/trampolines%20a.../near/215337235" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232319.20Refactor.20how.20signatures.2Ftrampolines.20a.2E.2E.2E.html#215337235">(Nov 02 2020 at 15:54)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2319#pullrequestreview-521758745">PR Review</a>.</p>



<a name="215337236"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232319%20Refactor%20how%20signatures/trampolines%20a.../near/215337236" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232319.20Refactor.20how.20signatures.2Ftrampolines.20a.2E.2E.2E.html#215337236">(Nov 02 2020 at 15:54)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2319#discussion_r516070244">PR Review Comment</a>:</p>
<blockquote>
<p>Indeed!</p>
</blockquote>



<a name="215398039"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232319%20Refactor%20how%20signatures/trampolines%20a.../near/215398039" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232319.20Refactor.20how.20signatures.2Ftrampolines.20a.2E.2E.2E.html#215398039">(Nov 03 2020 at 00:33)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2319#pullrequestreview-522126027">PR Review</a>.</p>



<a name="215398040"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232319%20Refactor%20how%20signatures/trampolines%20a.../near/215398040" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232319.20Refactor.20how.20signatures.2Ftrampolines.20a.2E.2E.2E.html#215398040">(Nov 03 2020 at 00:34)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2319#pullrequestreview-522126027">PR Review</a>.</p>



<a name="215398041"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232319%20Refactor%20how%20signatures/trampolines%20a.../near/215398041" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232319.20Refactor.20how.20signatures.2Ftrampolines.20a.2E.2E.2E.html#215398041">(Nov 03 2020 at 00:34)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/2319#discussion_r516361153">PR Review Comment</a>:</p>
<blockquote>
<p>Since this function has to take ownership, we might as well make the caller do the clone (if necessary) so that we can avoid clones when they aren't needed. That is, revert the change from taking <code>&amp;WasmFuncType</code> and <code>&amp;ir::Signature</code> back to taking <code>WasmFuncType</code> and <code>ir::Signature</code>.</p>
</blockquote>



<a name="215405562"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232319%20Refactor%20how%20signatures/trampolines%20a.../near/215405562" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232319.20Refactor.20how.20signatures.2Ftrampolines.20a.2E.2E.2E.html#215405562">(Nov 03 2020 at 02:08)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2319#pullrequestreview-522151807">PR Review</a>.</p>



<a name="215405563"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232319%20Refactor%20how%20signatures/trampolines%20a.../near/215405563" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232319.20Refactor.20how.20signatures.2Ftrampolines.20a.2E.2E.2E.html#215405563">(Nov 03 2020 at 02:08)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2319#discussion_r516392676">PR Review Comment</a>:</p>
<blockquote>
<p>This is sort of the <code>Entry</code> problem where it's problematic that getting an <code>entry</code> requires <code>wasm.clone()</code> (should probably just so a <code>get</code> followed by an <code>insert</code>, but also that the <code>native</code> isn't always inserted here (although it sometimes is)</p>
<p>If we think this is an issue I could change the arguments to <code>impl Into&lt;Cow&lt;'_, ...&gt;&gt;</code>, but I was hoping to optimize more for the cache hit use case here rather than the "need to insert case". Do you think I should try to go the <code>Cow</code> route though?</p>
</blockquote>



<a name="215490776"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232319%20Refactor%20how%20signatures/trampolines%20a.../near/215490776" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232319.20Refactor.20how.20signatures.2Ftrampolines.20a.2E.2E.2E.html#215490776">(Nov 03 2020 at 18:09)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2319#pullrequestreview-522756805">PR Review</a>.</p>



<a name="215490778"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232319%20Refactor%20how%20signatures/trampolines%20a.../near/215490778" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232319.20Refactor.20how.20signatures.2Ftrampolines.20a.2E.2E.2E.html#215490778">(Nov 03 2020 at 18:09)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/2319#discussion_r516862352">PR Review Comment</a>:</p>
<blockquote>
<p>If it doesn't require bending over backwards too much, it would be nice.</p>
</blockquote>



<a name="215504551"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232319%20Refactor%20how%20signatures/trampolines%20a.../near/215504551" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232319.20Refactor.20how.20signatures.2Ftrampolines.20a.2E.2E.2E.html#215504551">(Nov 03 2020 at 20:13)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2319#pullrequestreview-522841371">PR Review</a>.</p>



<a name="215504552"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232319%20Refactor%20how%20signatures/trampolines%20a.../near/215504552" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232319.20Refactor.20how.20signatures.2Ftrampolines.20a.2E.2E.2E.html#215504552">(Nov 03 2020 at 20:13)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2319#discussion_r516929486">PR Review Comment</a>:</p>
<blockquote>
<p>Hm it turns out that <code>Into&lt;Cow&gt;</code> doesn't have as many implementations as I thought it did so I don't think this will work easily. Digging in more though I'm realizing that we're doing a number of unnecessary allocations in a number of places. In general a <code>Module</code> has no need to store the native signature types (it only needs the wasm signatures).</p>
<p>Would you be ok landing this as-is and I can have a follow-up which I think makes all the callers only have <code>&amp;WasmFuncType</code> anyway so there's no gain to be had by passing in an owned value?</p>
</blockquote>



<a name="215624839"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232319%20Refactor%20how%20signatures/trampolines%20a.../near/215624839" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232319.20Refactor.20how.20signatures.2Ftrampolines.20a.2E.2E.2E.html#215624839">(Nov 04 2020 at 18:49)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2319#pullrequestreview-523643571">PR Review</a>.</p>



<a name="215624840"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232319%20Refactor%20how%20signatures/trampolines%20a.../near/215624840" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232319.20Refactor.20how.20signatures.2Ftrampolines.20a.2E.2E.2E.html#215624840">(Nov 04 2020 at 18:49)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/2319#discussion_r517559280">PR Review Comment</a>:</p>
<blockquote>
<p>Yeah, for sure</p>
</blockquote>



<a name="215624854"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232319%20Refactor%20how%20signatures/trampolines%20a.../near/215624854" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232319.20Refactor.20how.20signatures.2Ftrampolines.20a.2E.2E.2E.html#215624854">(Nov 04 2020 at 18:49)</a>:</h4>
<p>fitzgen merged <a href="https://github.com/bytecodealliance/wasmtime/pull/2319">PR #2319</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>