<html>
<head><meta charset="utf-8"><title>wasmtime / PR #8802 wasmtime: Take guest-profiler samples... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238802.20wasmtime.3A.20Take.20guest-profiler.20samples.2E.2E.2E.html">wasmtime / PR #8802 wasmtime: Take guest-profiler samples...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="444577020"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238802%20wasmtime%3A%20Take%20guest-profiler%20samples.../near/444577020" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238802.20wasmtime.3A.20Take.20guest-profiler.20samples.2E.2E.2E.html#444577020">(Jun 13 2024 at 22:49)</a>:</h4>
<p>jameysharp opened <a href="https://github.com/bytecodealliance/wasmtime/pull/8802">PR #8802</a> from <code>jameysharp:profile-hostcalls</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Otherwise it's difficult to interpret the profiles because whatever happened to be the last sample before the hostcall appears to be taking the entire time of the hostcall.</p>
<p>Ideally we'd do more to highlight which hostcall is running or use markers to delimit the boundaries of each hostcall, but this should be a good starting point.</p>
<p>I haven't tested this at all yet, just wanted to share it as something to point to for folks who are pushing the current limits of the guest profiler.</p>
</blockquote>



<a name="445249809"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238802%20wasmtime%3A%20Take%20guest-profiler%20samples.../near/445249809" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238802.20wasmtime.3A.20Take.20guest-profiler.20samples.2E.2E.2E.html#445249809">(Jun 18 2024 at 00:40)</a>:</h4>
<p>jameysharp updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8802">PR #8802</a>.</p>



<a name="445250229"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238802%20wasmtime%3A%20Take%20guest-profiler%20samples.../near/445250229" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238802.20wasmtime.3A.20Take.20guest-profiler.20samples.2E.2E.2E.html#445250229">(Jun 18 2024 at 00:45)</a>:</h4>
<p>jameysharp updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8802">PR #8802</a>.</p>



<a name="445250325"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238802%20wasmtime%3A%20Take%20guest-profiler%20samples.../near/445250325" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238802.20wasmtime.3A.20Take.20guest-profiler.20samples.2E.2E.2E.html#445250325">(Jun 18 2024 at 00:47)</a>:</h4>
<p>jameysharp edited <a href="https://github.com/bytecodealliance/wasmtime/pull/8802">PR #8802</a>:</p>
<blockquote>
<p>The output of the guest profiler can be misleading around hostcalls. Whatever happened to be the last sample before the hostcall appears to run for the entire time of the hostcall. This change ensures that we can see the actual call stack at the time of the hostcall, and get a visual indication of which periods are not spent executing guest code.<br>
</p>
</blockquote>



<a name="445250890"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238802%20wasmtime%3A%20Take%20guest-profiler%20samples.../near/445250890" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238802.20wasmtime.3A.20Take.20guest-profiler.20samples.2E.2E.2E.html#445250890">(Jun 18 2024 at 00:54)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/8802#issuecomment-2174703853">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8802">PR #8802</a>:</p>
<blockquote>
<p>@alexcrichton, this PR means that the guest profiler will require the new <code>call-hook</code> feature. How do you think we should set the defaults for these features?</p>
<p>I could imagine for example that <code>profiling</code> and <code>call-hook</code> would both be off-by-default in the <code>wasmtime</code> crate so that embedders don't take the performance hit unless they ask for it, but enabled by default in <code>wasmtime-cli</code> so that CLI users have the full profiler available.</p>
<p>Alternatively, the profiler's use of call-hooks could be made conditional on whether <code>call-hook</code> is enabled, but 1) I think that's going to be a bit ugly and 2) the new functionality makes the profiles quite a bit easier to interpret correctly so I kind of want it always available.</p>
</blockquote>



<a name="445250892"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238802%20wasmtime%3A%20Take%20guest-profiler%20samples.../near/445250892" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238802.20wasmtime.3A.20Take.20guest-profiler.20samples.2E.2E.2E.html#445250892">(Jun 18 2024 at 00:54)</a>:</h4>
<p><strong>jameysharp</strong> has marked <a href="https://github.com/bytecodealliance/wasmtime/pull/8802">PR #8802</a> as ready for review.</p>



<a name="445250893"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238802%20wasmtime%3A%20Take%20guest-profiler%20samples.../near/445250893" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238802.20wasmtime.3A.20Take.20guest-profiler.20samples.2E.2E.2E.html#445250893">(Jun 18 2024 at 00:54)</a>:</h4>
<p><strong>jameysharp</strong> requested <a href="https://github.com/pchickey">pchickey</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8802">PR #8802</a>.</p>



<a name="445250894"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238802%20wasmtime%3A%20Take%20guest-profiler%20samples.../near/445250894" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238802.20wasmtime.3A.20Take.20guest-profiler.20samples.2E.2E.2E.html#445250894">(Jun 18 2024 at 00:54)</a>:</h4>
<p><strong>jameysharp</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8802">PR #8802</a>.</p>



<a name="445255516"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238802%20wasmtime%3A%20Take%20guest-profiler%20samples.../near/445255516" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238802.20wasmtime.3A.20Take.20guest-profiler.20samples.2E.2E.2E.html#445255516">(Jun 18 2024 at 01:51)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/8802#issuecomment-2174760515">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8802">PR #8802</a>:</p>
<blockquote>
<p>Is the use case you're primarily interested in the CLI itself? If so could we thread that needle by making the hooks conditional but unconditionally enabling them in the CLI?</p>
</blockquote>



<a name="445402922"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238802%20wasmtime%3A%20Take%20guest-profiler%20samples.../near/445402922" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238802.20wasmtime.3A.20Take.20guest-profiler.20samples.2E.2E.2E.html#445402922">(Jun 18 2024 at 16:14)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/8802#issuecomment-2176487957">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8802">PR #8802</a>:</p>
<blockquote>
<p>I do want this available in the CLI but I also want it in Fastly's CLI embedding of Wasmtime (Viceroy). So as long as all embedders have the option to turn this on then I'm happy.</p>
<p>I'll push a commit for that in a bit.</p>
</blockquote>



<a name="445406911"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238802%20wasmtime%3A%20Take%20guest-profiler%20samples.../near/445406911" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238802.20wasmtime.3A.20Take.20guest-profiler.20samples.2E.2E.2E.html#445406911">(Jun 18 2024 at 16:32)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/8802#issuecomment-2176520640">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8802">PR #8802</a>:</p>
<blockquote>
<p>Can we make it so that the sample-at-hostcall functionality only happens when the call hook feature is enabled and then embeddings can enable or disable the feature to get more functionality (at the cost of some host-wasm call overhead) as they choose?</p>
</blockquote>



<a name="445419250"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238802%20wasmtime%3A%20Take%20guest-profiler%20samples.../near/445419250" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238802.20wasmtime.3A.20Take.20guest-profiler.20samples.2E.2E.2E.html#445419250">(Jun 18 2024 at 17:29)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/8802#issuecomment-2176620090">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8802">PR #8802</a>:</p>
<blockquote>
<p>I just realized that the <code>CallHook</code> type (the enum indicating which kind of transition happened) is not guarded by the <code>call-hook</code> feature, which makes this simpler than I expected. That means the part of the guest profiler that's in the wasmtime crate does not actually require the <code>call-hook</code> feature; it can unconditionally provide a <code>call_hook</code> method for an embedder to use if they want to.</p>
<p>The embedder is responsible for arranging for that function to be called from an actual call-hook, and so it's their responsibility to enable the <code>call-hook</code> feature if they want to use that part of the guest profiler. In principle I think an embedder could also use other means to pass the same information to the profiler if they wanted to.</p>
<p>Hopefully that makes everyone happy?</p>
</blockquote>



<a name="445420270"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238802%20wasmtime%3A%20Take%20guest-profiler%20samples.../near/445420270" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238802.20wasmtime.3A.20Take.20guest-profiler.20samples.2E.2E.2E.html#445420270">(Jun 18 2024 at 17:34)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/8802#issuecomment-2176628916">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8802">PR #8802</a>:</p>
<blockquote>
<p>Oh nice! That sounds good to me <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
</blockquote>



<a name="445420775"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238802%20wasmtime%3A%20Take%20guest-profiler%20samples.../near/445420775" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238802.20wasmtime.3A.20Take.20guest-profiler.20samples.2E.2E.2E.html#445420775">(Jun 18 2024 at 17:37)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8802#pullrequestreview-2126126372">PR review</a>.</p>



<a name="445420776"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238802%20wasmtime%3A%20Take%20guest-profiler%20samples.../near/445420776" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238802.20wasmtime.3A.20Take.20guest-profiler.20samples.2E.2E.2E.html#445420776">(Jun 18 2024 at 17:37)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8802#pullrequestreview-2126126372">PR review</a>.</p>



<a name="445420777"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238802%20wasmtime%3A%20Take%20guest-profiler%20samples.../near/445420777" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238802.20wasmtime.3A.20Take.20guest-profiler.20samples.2E.2E.2E.html#445420777">(Jun 18 2024 at 17:37)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/8802#discussion_r1644832912">PR review comment</a>:</p>
<blockquote>
<p>Stray submodule change?</p>
</blockquote>



<a name="445421305"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238802%20wasmtime%3A%20Take%20guest-profiler%20samples.../near/445421305" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238802.20wasmtime.3A.20Take.20guest-profiler.20samples.2E.2E.2E.html#445421305">(Jun 18 2024 at 17:40)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8802#pullrequestreview-2126131761">PR review</a>.</p>



<a name="445421306"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238802%20wasmtime%3A%20Take%20guest-profiler%20samples.../near/445421306" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238802.20wasmtime.3A.20Take.20guest-profiler.20samples.2E.2E.2E.html#445421306">(Jun 18 2024 at 17:40)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/8802#discussion_r1644836291">PR review comment</a>:</p>
<blockquote>
<p>Ah dang, thanks for catching that!</p>
</blockquote>



<a name="445426888"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238802%20wasmtime%3A%20Take%20guest-profiler%20samples.../near/445426888" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238802.20wasmtime.3A.20Take.20guest-profiler.20samples.2E.2E.2E.html#445426888">(Jun 18 2024 at 18:04)</a>:</h4>
<p><strong>jameysharp</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers">wasmtime-default-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8802">PR #8802</a>.</p>



<a name="445426890"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238802%20wasmtime%3A%20Take%20guest-profiler%20samples.../near/445426890" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238802.20wasmtime.3A.20Take.20guest-profiler.20samples.2E.2E.2E.html#445426890">(Jun 18 2024 at 18:04)</a>:</h4>
<p>jameysharp updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8802">PR #8802</a>.</p>



<a name="445439426"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238802%20wasmtime%3A%20Take%20guest-profiler%20samples.../near/445439426" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238802.20wasmtime.3A.20Take.20guest-profiler.20samples.2E.2E.2E.html#445439426">(Jun 18 2024 at 19:08)</a>:</h4>
<p>jameysharp merged <a href="https://github.com/bytecodealliance/wasmtime/pull/8802">PR #8802</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>