<html>
<head><meta charset="utf-8"><title>wasmtime / issue #9732 winch(x64): Tail call · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239732.20winch.28x64.29.3A.20Tail.20call.html">wasmtime / issue #9732 winch(x64): Tail call</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="492124453"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239732%20winch%28x64%29%3A%20Tail%20call/near/492124453" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239732.20winch.28x64.29.3A.20Tail.20call.html#492124453">(Jan 06 2025 at 15:18)</a>:</h4>
<p>saulecabrera edited <a href="https://github.com/bytecodealliance/wasmtime/issues/9732">issue #9732</a>:</p>
<blockquote>
<p>The Wasm Tail Call proposal is considered Tier 1 according to <a href="https://docs.wasmtime.dev/stability-tiers.html#tier-1">Wasmtime's Tiers of support</a>. </p>
<p>Winch currently doesn't support this proposal.</p>
<ul>
<li>[ ] <code>return_call</code></li>
<li>[ ] <code>return_call_indirect</code></li>
</ul>
</blockquote>



<a name="494257698"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239732%20winch%28x64%29%3A%20Tail%20call/near/494257698" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239732.20winch.28x64.29.3A.20Tail.20call.html#494257698">(Jan 17 2025 at 00:24)</a>:</h4>
<p>saulecabrera assigned saulecabrera to <a href="https://github.com/bytecodealliance/wasmtime/issues/9732">issue #9732</a>.</p>



<a name="494376783"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239732%20winch%28x64%29%3A%20Tail%20call/near/494376783" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239732.20winch.28x64.29.3A.20Tail.20call.html#494376783">(Jan 17 2025 at 14:49)</a>:</h4>
<p>MarinPostma <a href="https://github.com/bytecodealliance/wasmtime/issues/9732#issuecomment-2598531711">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9732">issue #9732</a>:</p>
<blockquote>
<p>@saulecabrera you can assign me to that <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
</blockquote>



<a name="494377032"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239732%20winch%28x64%29%3A%20Tail%20call/near/494377032" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239732.20winch.28x64.29.3A.20Tail.20call.html#494377032">(Jan 17 2025 at 14:50)</a>:</h4>
<p>saulecabrera edited <a href="https://github.com/bytecodealliance/wasmtime/issues/9732">issue #9732</a>:</p>
<blockquote>
<p>The Wasm Tail Call proposal is considered Tier 1 according to <a href="https://docs.wasmtime.dev/stability-tiers.html#tier-1">Wasmtime's Tiers of support</a>. </p>
<p>Winch currently doesn't support this proposal.</p>
<ul>
<li>[ ] <code>return_call</code> @MarinPostma</li>
<li>[ ] <code>return_call_indirect</code> @MarinPostma </li>
</ul>
</blockquote>



<a name="494659761"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239732%20winch%28x64%29%3A%20Tail%20call/near/494659761" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239732.20winch.28x64.29.3A.20Tail.20call.html#494659761">(Jan 19 2025 at 17:19)</a>:</h4>
<p>MarinPostma <a href="https://github.com/bytecodealliance/wasmtime/issues/9732#issuecomment-2600949527">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9732">issue #9732</a>:</p>
<blockquote>
<p>@saulecabrera </p>
<p>Did you have a sketch of a plan on how to implement that already?</p>
<p>I did some homework this weekend, trying to find a path toward tail calls. I think we could do something like described in this post about <a href="https://v8.dev/blog/wasm-tail-call">v8 baseline compiler</a>, or as initially implemented <a href="https://github.com/bytecodealliance/wasmtime/pull/6635">in cranelift</a>, basically:</p>
<ul>
<li>set up the frame as if we were about to perform a normal call</li>
<li><code>memcpy</code> the frame down to override the caller frame</li>
<li>jump to the callee entry-point</li>
</ul>
<p>However this is over simplistic. There are many things getting in our way. Here's my understanding of the situation, thus far:</p>
<p>1) The callee and the caller may not require the same amount of stack space for their arguments. In the Winch calling convention, it is the caller that <a href="https://github.com/bytecodealliance/wasmtime/blob/main/winch/codegen/src/codegen/call.rs#L103-L112">cleans up the stack space for the arguments</a>. This is an issue for tail calls, because the caller doesn't know ahead of time how much stack space will need to be cleaned up when the callee returns. cranelift <code>TailCall</code> convention solves that by requiring that the callee <a href="https://github.com/bytecodealliance/rfcs/blob/main/accepted/tail-calls.md#new-wasm-calling-conventions-in-cranelift">cleans-up it's stack space</a>. I suppose there are alternatives to let the caller know dynamically the amount of stack space to pop on cleanup, but in any case, it seems to me that we need a calling convention that supports that.<br>
2) The <code>ret_area</code> is inherited from the caller, rather and allocated in the caller stack. This is easy to do: we can get it from the caller's initial control frame. (see <a href="https://github.com/bytecodealliance/wasmtime/blob/main/winch/codegen/src/visitor.rs#L1899">there</a>). This works, because the callee must have the same return as the caller.<br>
3) We need to emit a jump to the callee, rather than a call, because we must not push a return address, since the state is already set up during the return_call preparation. Winch relies of cranelift to emit relocs for the callee address. The story around converting a function ref to a <code>MachLabel</code> that can be used for a jump is not entirely clear to me yet. Alternatively, we could pop the FP back into it's register and let <code>call</code> push it back (this is what v8 baseline does).<br>
4) Cranelift has <a href="https://github.com/bytecodealliance/wasmtime/blob/2eb65138e9e0f331776d7d3747a47117f706d406/cranelift/codegen/src/isa/x64/inst/emit.rs?plain=1#L1670"><code>Inst::CallReturn*</code></a> macro-instruction, but it's not clear to me if we can use it, since it emits code specific to cranelift <code>Tail</code> calling convention.</p>
<p>I am glancing over a lot of things here, obviously. My principal concern is with <code>1)</code> right now; I don't see a way forward without addressing it.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>