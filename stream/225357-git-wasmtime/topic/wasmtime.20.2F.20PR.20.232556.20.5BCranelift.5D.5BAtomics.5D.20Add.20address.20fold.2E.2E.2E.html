<html>
<head><meta charset="utf-8"><title>wasmtime / PR #2556 [Cranelift][Atomics] Add address fold... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html">wasmtime / PR #2556 [Cranelift][Atomics] Add address fold...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="222000979"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222000979" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222000979">(Jan 07 2021 at 21:07)</a>:</h4>
<p>yurydelendik opened <a href="https://github.com/bytecodealliance/wasmtime/pull/2556">PR #2556</a> from <code>bug1684861</code> to <code>main</code>:</p>
<blockquote>
<p>Related isseue <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1684861">https://bugzilla.mozilla.org/show_bug.cgi?id=1684861</a></p>
<p>There are two parts:</p>
<ul>
<li>cranelift/wasm/src/code_translator.rs the logic required for SM to work properly</li>
<li>rest of it is testing of the broken logic</li>
</ul>
<p>I don't think it is necessary to check alignment in the <code>fold_atomic_mem_addr</code> though it is the only way at this moment to verify/test fix in the wasmtime.</p>
<p>Does makes sense for <code>wasmtime_memory_atomic_</code> to operate with 64-bit address instead of 32-bit one? But that's different question we have to address.</p>
<p>TODO:</p>
<ul>
<li>[ ] check for i32 adderss overflow?</li>
</ul>
</blockquote>



<a name="222001053"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222001053" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222001053">(Jan 07 2021 at 21:08)</a>:</h4>
<p><strong>yurydelendik</strong> requested <a href="https://github.com/julian-seward1">julian-seward1</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/2556">PR #2556</a>.</p>



<a name="222001192"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222001192" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222001192">(Jan 07 2021 at 21:09)</a>:</h4>
<p>yurydelendik edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2556">PR #2556</a> from <code>bug1684861</code> to <code>main</code>:</p>
<blockquote>
<p>Related isseue <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1684861">https://bugzilla.mozilla.org/show_bug.cgi?id=1684861</a></p>
<p>There are two parts:</p>
<ul>
<li>cranelift/wasm/src/code_translator.rs the logic required for SM to work properly</li>
<li>rest of it is testing of the broken logic</li>
</ul>
<p>I don't think it is necessary to check alignment in the <code>fold_atomic_mem_addr</code> though it is the only way at this moment to verify/test fix in the wasmtime.</p>
<p>Does it make sense for <code>wasmtime_memory_atomic_</code> to operate with 64-bit address instead of 32-bit one? But that's different question we have to address.</p>
<p>TODO:</p>
<ul>
<li>[ ] check for i32 address overflow?</li>
</ul>
</blockquote>



<a name="222009233"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222009233" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222009233">(Jan 07 2021 at 22:13)</a>:</h4>
<p>yurydelendik edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2556">PR #2556</a> from <code>bug1684861</code> to <code>main</code>:</p>
<blockquote>
<p>Related isseue <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1684861">https://bugzilla.mozilla.org/show_bug.cgi?id=1684861</a></p>
<p>There are two parts:</p>
<ul>
<li>cranelift/wasm/src/code_translator.rs the logic required for SM to work properly</li>
<li>rest of it is testing of the broken logic</li>
</ul>
<p>I don't think it is necessary to check alignment in the <code>fold_atomic_mem_addr</code> though it is the only way at this moment to verify/test fix in the wasmtime.</p>
<p>Does it make sense for <code>wasmtime_memory_atomic_</code> to operate with 64-bit address instead of 32-bit one? But that's different question we have to address.</p>
<p>TODO:</p>
<ul>
<li>[x] check for i32 address overflow?</li>
</ul>
</blockquote>



<a name="222009416"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222009416" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222009416">(Jan 07 2021 at 22:15)</a>:</h4>
<p>yurydelendik updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2556">PR #2556</a> from <code>bug1684861</code> to <code>main</code>:</p>
<blockquote>
<p>Related isseue <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1684861">https://bugzilla.mozilla.org/show_bug.cgi?id=1684861</a></p>
<p>There are two parts:</p>
<ul>
<li>cranelift/wasm/src/code_translator.rs the logic required for SM to work properly</li>
<li>rest of it is testing of the broken logic</li>
</ul>
<p>I don't think it is necessary to check alignment in the <code>fold_atomic_mem_addr</code> though it is the only way at this moment to verify/test fix in the wasmtime.</p>
<p>Does it make sense for <code>wasmtime_memory_atomic_</code> to operate with 64-bit address instead of 32-bit one? But that's different question we have to address.</p>
<p>TODO:</p>
<ul>
<li>[x] check for i32 address overflow?</li>
</ul>
</blockquote>



<a name="222010256"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222010256" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222010256">(Jan 07 2021 at 22:22)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#pullrequestreview-563868947">PR Review</a>.</p>



<a name="222010257"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222010257" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222010257">(Jan 07 2021 at 22:22)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#pullrequestreview-563868947">PR Review</a>.</p>



<a name="222010258"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222010258" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222010258">(Jan 07 2021 at 22:22)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#discussion_r553624583">PR Review Comment</a>:</p>
<blockquote>
<p>I figured that we already had a function somewhere in this file to calculate an address, could that perhaps be used instead of duplicating the logic here? That handles things with the guard page and whatnot too to deduplicate checks.</p>
</blockquote>



<a name="222010259"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222010259" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222010259">(Jan 07 2021 at 22:22)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#discussion_r553623614">PR Review Comment</a>:</p>
<blockquote>
<p>Due to the relative cost of these functions, could the distinction between local/imported memories be removed to halve the number of intrinsics added?</p>
</blockquote>



<a name="222010260"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222010260" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222010260">(Jan 07 2021 at 22:22)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#discussion_r553624848">PR Review Comment</a>:</p>
<blockquote>
<p>Similar to above I figured we'd already have alignment checks somewhere else for other atomic ops</p>
</blockquote>



<a name="222013373"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222013373" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222013373">(Jan 07 2021 at 22:52)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#pullrequestreview-563887545">PR Review</a>.</p>



<a name="222013375"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222013375" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222013375">(Jan 07 2021 at 22:52)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#discussion_r553639881">PR Review Comment</a>:</p>
<blockquote>
<p>In Cranelift memory instructions directlt get an offset as argument, so there is probably no need for such a function.</p>
</blockquote>



<a name="222013555"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222013555" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222013555">(Jan 07 2021 at 22:54)</a>:</h4>
<p>yurydelendik submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#pullrequestreview-563888392">PR Review</a>.</p>



<a name="222013556"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222013556" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222013556">(Jan 07 2021 at 22:54)</a>:</h4>
<p>yurydelendik created <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#discussion_r553640601">PR Review Comment</a>:</p>
<blockquote>
<p>I could not find specifically one that combines offsets, I saw only those that calculate a pointer based on memory base.</p>
</blockquote>



<a name="222013690"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222013690" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222013690">(Jan 07 2021 at 22:56)</a>:</h4>
<p>yurydelendik submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#pullrequestreview-563888995">PR Review</a>.</p>



<a name="222013691"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222013691" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222013691">(Jan 07 2021 at 22:56)</a>:</h4>
<p>yurydelendik created <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#discussion_r553641105">PR Review Comment</a>:</p>
<blockquote>
<p>yep, I copied a part of the logic from <code>finalise_atomic_mem_addr</code> though it calculates a host memory pointer.</p>
</blockquote>



<a name="222014182"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222014182" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222014182">(Jan 07 2021 at 23:00)</a>:</h4>
<p>yurydelendik submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#pullrequestreview-563891119">PR Review</a>.</p>



<a name="222014183"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222014183" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222014183">(Jan 07 2021 at 23:00)</a>:</h4>
<p>yurydelendik created <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#discussion_r553642866">PR Review Comment</a>:</p>
<blockquote>
<p>I agree, though I adapted a pattern used by <code>imported_memory_fill</code>/ <code>imemory_fill</code> or <code>imported_memory32_grow</code>/<code>memory32_grow</code>. Are there plans to do the same with above?</p>
</blockquote>



<a name="222062379"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222062379" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222062379">(Jan 08 2021 at 11:36)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#pullrequestreview-564195322">PR Review</a>.</p>



<a name="222062380"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222062380" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222062380">(Jan 08 2021 at 11:36)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#discussion_r553894521">PR Review Comment</a>:</p>
<blockquote>
<p>@bjorn3 But for atomic wait/notify, the actual handling code is generated by calling <code>environ.translate_atomic_wait</code> etc.  And that takes only the final linear memory offset as an argument.  There's no way to pass it an additional constant offset as a second arg.  Hence we have no option here but to "manually" fold in <code>memarg.offset</code> (and adding a second bounds check, sigh.)</p>
</blockquote>



<a name="222062648"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222062648" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222062648">(Jan 08 2021 at 11:40)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#pullrequestreview-564197388">PR Review</a>.</p>



<a name="222062649"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222062649" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222062649">(Jan 08 2021 at 11:40)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#discussion_r553896149">PR Review Comment</a>:</p>
<blockquote>
<p>@yurydelendik Do any of these tests test the case where the test created in <code>fold_atomic_mem_addr</code> fails?  I mean, where the check <code>linear_mem_addr + memarg.offset &gt;= 0x_1_0000_0000u64</code> ?  If not, can you add one?  If yes, can you add a one-liner comment above each test, to say what case it tests?</p>
</blockquote>



<a name="222062724"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222062724" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222062724">(Jan 08 2021 at 11:40)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#pullrequestreview-564197698">PR Review</a>.</p>



<a name="222062725"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222062725" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222062725">(Jan 08 2021 at 11:40)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#discussion_r553896372">PR Review Comment</a>:</p>
<blockquote>
<p>Indeed. I was reacting to</p>
<blockquote>
<p>I figured that we already had a function somewhere in this file to calculate an address</p>
</blockquote>
</blockquote>



<a name="222070288"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222070288" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222070288">(Jan 08 2021 at 13:13)</a>:</h4>
<p>yurydelendik submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#pullrequestreview-564248365">PR Review</a>.</p>



<a name="222070289"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222070289" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222070289">(Jan 08 2021 at 13:13)</a>:</h4>
<p>yurydelendik created <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#discussion_r553935715">PR Review Comment</a>:</p>
<blockquote>
<p>yes, <a href="https://github.com/bytecodealliance/wasmtime/pull/2556/commits/d76cba6e0b875c5514b51c46c2fae5e2520ec871#diff-3d0a7bf818a02b8a4a928c29ad09cb70ac01dd516b1670d2520289ff061a3e14R18-R29">line of 18</a> of the wast tests that</p>
</blockquote>



<a name="222086156"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222086156" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222086156">(Jan 08 2021 at 15:36)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#pullrequestreview-564354544">PR Review</a>.</p>



<a name="222086157"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222086157" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222086157">(Jan 08 2021 at 15:36)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#discussion_r554016039">PR Review Comment</a>:</p>
<blockquote>
<p>Eventually I'd like to get to those and do the same yeah, we did it awhile ago for a few reference types intrinsics but haven't gotten around to fixing things generally.</p>
</blockquote>



<a name="222086326"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222086326" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222086326">(Jan 08 2021 at 15:38)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#pullrequestreview-564355528">PR Review</a>.</p>



<a name="222086327"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222086327" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222086327">(Jan 08 2021 at 15:38)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#discussion_r554016797">PR Review Comment</a>:</p>
<blockquote>
<p>Could raw pointers get passed to the native functions which handle the implementation? The bounds-checking code is so tricky it seems like it'd be best to avoid duplicating it if we can.</p>
</blockquote>



<a name="222096966"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222096966" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222096966">(Jan 08 2021 at 17:01)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#pullrequestreview-564428397">PR Review</a>.</p>



<a name="222103204"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222103204" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222103204">(Jan 08 2021 at 17:48)</a>:</h4>
<p>yurydelendik submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#pullrequestreview-564460551">PR Review</a>.</p>



<a name="222103205"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222103205" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222103205">(Jan 08 2021 at 17:48)</a>:</h4>
<p>yurydelendik created <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#discussion_r554097748">PR Review Comment</a>:</p>
<blockquote>
<p>Yep, raised the related question at <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1684861#c7">https://bugzilla.mozilla.org/show_bug.cgi?id=1684861#c7</a> (consumer side)</p>
</blockquote>



<a name="222104064"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222104064" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222104064">(Jan 08 2021 at 17:54)</a>:</h4>
<p>yurydelendik submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#pullrequestreview-564464924">PR Review</a>.</p>



<a name="222104066"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222104066" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222104066">(Jan 08 2021 at 17:54)</a>:</h4>
<p>yurydelendik created <a href="https://github.com/bytecodealliance/wasmtime/pull/2556#discussion_r554101122">PR Review Comment</a>:</p>
<blockquote>
<p>Opened <a href="https://github.com/bytecodealliance/wasmtime/issues/2561">https://github.com/bytecodealliance/wasmtime/issues/2561</a> to address it in the future.</p>
</blockquote>



<a name="222104113"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232556%20%5BCranelift%5D%5BAtomics%5D%20Add%20address%20fold.../near/222104113" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232556.20.5BCranelift.5D.5BAtomics.5D.20Add.20address.20fold.2E.2E.2E.html#222104113">(Jan 08 2021 at 17:55)</a>:</h4>
<p>yurydelendik merged <a href="https://github.com/bytecodealliance/wasmtime/pull/2556">PR #2556</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>