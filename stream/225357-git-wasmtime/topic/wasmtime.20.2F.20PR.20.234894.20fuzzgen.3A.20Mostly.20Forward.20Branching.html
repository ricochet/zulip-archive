<html>
<head><meta charset="utf-8"><title>wasmtime / PR #4894 fuzzgen: Mostly Forward Branching · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html">wasmtime / PR #4894 fuzzgen: Mostly Forward Branching</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="298277201"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298277201" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298277201">(Sep 11 2022 at 18:11)</a>:</h4>
<p>afonso360 opened <a href="https://github.com/bytecodealliance/wasmtime/pull/4894">PR #4894</a> from <code>forward-branching</code> to <code>main</code>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>This PR addresses some of the issues found in #3050 regarding the performance of fuzzgen. We found that we had an outsized number of timeouts during execution of the fuzzer. This is mostly due to generating a bunch of infinite loops.</p>
<p>This changes our branching strategy. Instead of choosing blocks at random, we always choose a block ahead of the current block. This makes it so that we always make forward progress and don't time out very often. I still think backwards branches are important to generate, so we make those a configurable option (0.1% of branches).</p>
<p>Additionally it looks like not having valid target branches was also an issue. 27.3% of our invalid <code>Arbitrary::choice</code> failures were due to us trying to select a block that we didn't have. Such as for example trying to select a block that does not have params when all of them do.<br>
We are now smarter about which terminators we allow to be inserted avoiding these issues.</p>
<p>cc: @jameysharp </p>
<h2>Benchmarks</h2>
<p>&lt;details&gt;<br>
&lt;summary&gt;&lt;h3&gt;Baseline&lt;/h3&gt;&lt;/summary&gt;</p>
<p>Statistics:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="mi">49967</span><span class="w">  </span><span class="n">NEW</span><span class="w">    </span><span class="n">cov</span>: <span class="mi">31776</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">183224</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">4225</span><span class="o">/</span><span class="mi">5444</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">394895</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">23</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">966</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">2106</span><span class="o">/</span><span class="mi">373965</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">2</span><span class="w"> </span><span class="n">ShuffleBytes</span><span class="o">-</span><span class="n">CopyPart</span><span class="o">-</span><span class="w"></span>
<span class="o">==</span><span class="w"> </span><span class="n">FuzzGen</span><span class="w"> </span><span class="n">Statistics</span><span class="w">  </span><span class="o">====================</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">50000</span><span class="w"></span>
<span class="n">Valid</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">18378</span><span class="w"> </span><span class="p">(</span><span class="mf">36.8</span><span class="o">%</span><span class="p">)</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">62769</span><span class="w"></span>
<span class="n">Successful</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">48229</span><span class="w"> </span><span class="p">(</span><span class="mf">76.8</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Timed</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">10440</span><span class="w"> </span><span class="p">(</span><span class="mf">16.6</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Traps</span>:
        <span class="nc">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">int_divz</span>: <span class="mi">4100</span><span class="w"> </span><span class="p">(</span><span class="mf">6.5</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">bad_sig</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">debug</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">icall_null</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">heap_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">int_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">bad_toint</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">interrupt</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">stk_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">table_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">heap_misaligned</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">unreachable</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">resumable</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p><code>Arbitrary::choice</code> failures:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Loaded</span><span class="w"> </span><span class="mi">20139</span><span class="w"> </span><span class="n">stacks</span><span class="w"></span>

<span class="n">First</span><span class="w"> </span><span class="n">Line</span><span class="w"> </span><span class="n">duplicates</span><span class="w"></span>
<span class="mf">5.9</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">1181</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_br_table</span><span class="w"></span>
<span class="mf">8.3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">1679</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_jumptables</span><span class="w"></span>
<span class="mf">1.4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">282</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_switch</span><span class="w"></span>
<span class="mf">11.7</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">2355</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_target_block</span><span class="w"></span>
<span class="mf">29.9</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">6014</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="mf">29.7</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">5991</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">stack_slot_with_size</span><span class="w"></span>
<span class="mf">13.1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">2637</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">insert_call</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>&lt;details&gt;<br>
&lt;summary&gt;&lt;h3&gt;This PR&lt;/h3&gt;&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="mi">49979</span><span class="w">  </span><span class="n">NEW</span><span class="w">    </span><span class="n">cov</span>: <span class="mi">31503</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">178604</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">3520</span><span class="o">/</span><span class="mi">7374</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">1048576</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">48</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">1054</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">2702</span><span class="o">/</span><span class="mi">1048576</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">1</span><span class="w"> </span><span class="n">CMP</span><span class="o">-</span><span class="w"> </span><span class="n">DE</span>: <span class="s">"</span><span class="se">\x01\x00\x00\x00\x00\x00\x00\x05</span><span class="s">"</span><span class="o">-</span><span class="w"></span>
<span class="o">==</span><span class="w"> </span><span class="n">FuzzGen</span><span class="w"> </span><span class="n">Statistics</span><span class="w">  </span><span class="o">====================</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">50000</span><span class="w"></span>
<span class="n">Valid</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">21036</span><span class="w"> </span><span class="p">(</span><span class="mf">42.1</span><span class="o">%</span><span class="p">)</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">724599</span><span class="w"></span>
<span class="n">Successful</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">719276</span><span class="w"> </span><span class="p">(</span><span class="mf">99.3</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Timed</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">32</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Traps</span>:
        <span class="nc">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">stk_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">heap_misaligned</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">bad_sig</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">table_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">bad_toint</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">heap_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">debug</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">resumable</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">icall_null</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">int_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">int_divz</span>: <span class="mi">5291</span><span class="w"> </span><span class="p">(</span><span class="mf">0.7</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">unreachable</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">interrupt</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Loaded</span><span class="w"> </span><span class="mi">14367</span><span class="w"> </span><span class="n">stacks</span><span class="w"></span>

<span class="n">First</span><span class="w"> </span><span class="n">Line</span><span class="w"> </span><span class="n">duplicates</span><span class="w"></span>
<span class="mf">41.3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">5936</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="mf">37.6</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">5395</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">stack_slot_with_size</span><span class="w"></span>
<span class="mf">21.1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">3036</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">insert_call</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>This improves execs/s by 108% (23 -&gt; 48) which is nice. It also eliminates all invalid choices regarding block terminators. </p>
</blockquote>



<a name="298280433"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298280433" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298280433">(Sep 11 2022 at 18:51)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/4894">PR #4894</a> from <code>forward-branching</code> to <code>main</code>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>This PR addresses some of the issues found in #3050 regarding the performance of fuzzgen. We found that we had an outsized number of timeouts during execution of the fuzzer. This is mostly due to generating a bunch of infinite loops.</p>
<p>This changes our branching strategy. Instead of choosing blocks at random, we always choose a block ahead of the current block. This makes it so that we always make forward progress and don't time out very often. I still think backwards branches are important to generate, so we make those a configurable option (0.1% of branches).</p>
<p>Additionally it looks like not having valid target branches was also an issue. 27.3% of our invalid <code>Arbitrary::choice</code> failures were due to us trying to select a block that we didn't have. Such as for example trying to select a block that does not have params when all of them do.<br>
We are now smarter about which terminators we allow to be inserted avoiding these issues.</p>
<p>cc: @jameysharp </p>
<h2>Benchmarks</h2>
<p>&lt;details&gt;<br>
&lt;summary&gt;&lt;h3&gt;Baseline&lt;/h3&gt;&lt;/summary&gt;</p>
<p>Statistics:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="mi">49967</span><span class="w">  </span><span class="n">NEW</span><span class="w">    </span><span class="n">cov</span>: <span class="mi">31776</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">183224</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">4225</span><span class="o">/</span><span class="mi">5444</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">394895</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">23</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">966</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">2106</span><span class="o">/</span><span class="mi">373965</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">2</span><span class="w"> </span><span class="n">ShuffleBytes</span><span class="o">-</span><span class="n">CopyPart</span><span class="o">-</span><span class="w"></span>
<span class="o">==</span><span class="w"> </span><span class="n">FuzzGen</span><span class="w"> </span><span class="n">Statistics</span><span class="w">  </span><span class="o">====================</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">50000</span><span class="w"></span>
<span class="n">Valid</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">18378</span><span class="w"> </span><span class="p">(</span><span class="mf">36.8</span><span class="o">%</span><span class="p">)</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">62769</span><span class="w"></span>
<span class="n">Successful</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">48229</span><span class="w"> </span><span class="p">(</span><span class="mf">76.8</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Timed</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">10440</span><span class="w"> </span><span class="p">(</span><span class="mf">16.6</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Traps</span>:
        <span class="nc">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">int_divz</span>: <span class="mi">4100</span><span class="w"> </span><span class="p">(</span><span class="mf">6.5</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">bad_sig</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">debug</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">icall_null</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">heap_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">int_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">bad_toint</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">interrupt</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">stk_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">table_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">heap_misaligned</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">unreachable</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">resumable</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p><code>Arbitrary::choice</code> failures:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Loaded</span><span class="w"> </span><span class="mi">20139</span><span class="w"> </span><span class="n">stacks</span><span class="w"></span>

<span class="n">First</span><span class="w"> </span><span class="n">Line</span><span class="w"> </span><span class="n">duplicates</span><span class="w"></span>
<span class="mf">5.9</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">1181</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_br_table</span><span class="w"></span>
<span class="mf">8.3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">1679</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_jumptables</span><span class="w"></span>
<span class="mf">1.4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">282</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_switch</span><span class="w"></span>
<span class="mf">11.7</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">2355</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_target_block</span><span class="w"></span>
<span class="mf">29.9</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">6014</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="mf">29.7</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">5991</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">stack_slot_with_size</span><span class="w"></span>
<span class="mf">13.1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">2637</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">insert_call</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>&lt;details&gt;<br>
&lt;summary&gt;&lt;h3&gt;This PR&lt;/h3&gt;&lt;/summary&gt;</p>
<p>Statistics:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="mi">49979</span><span class="w">  </span><span class="n">NEW</span><span class="w">    </span><span class="n">cov</span>: <span class="mi">31503</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">178604</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">3520</span><span class="o">/</span><span class="mi">7374</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">1048576</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">48</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">1054</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">2702</span><span class="o">/</span><span class="mi">1048576</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">1</span><span class="w"> </span><span class="n">CMP</span><span class="o">-</span><span class="w"> </span><span class="n">DE</span>: <span class="s">"</span><span class="se">\x01\x00\x00\x00\x00\x00\x00\x05</span><span class="s">"</span><span class="o">-</span><span class="w"></span>
<span class="o">==</span><span class="w"> </span><span class="n">FuzzGen</span><span class="w"> </span><span class="n">Statistics</span><span class="w">  </span><span class="o">====================</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">50000</span><span class="w"></span>
<span class="n">Valid</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">21036</span><span class="w"> </span><span class="p">(</span><span class="mf">42.1</span><span class="o">%</span><span class="p">)</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">724599</span><span class="w"></span>
<span class="n">Successful</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">719276</span><span class="w"> </span><span class="p">(</span><span class="mf">99.3</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Timed</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">32</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Traps</span>:
        <span class="nc">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">stk_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">heap_misaligned</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">bad_sig</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">table_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">bad_toint</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">heap_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">debug</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">resumable</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">icall_null</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">int_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">int_divz</span>: <span class="mi">5291</span><span class="w"> </span><span class="p">(</span><span class="mf">0.7</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">unreachable</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">interrupt</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p><code>Arbitrary::choice</code> failures:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Loaded</span><span class="w"> </span><span class="mi">14367</span><span class="w"> </span><span class="n">stacks</span><span class="w"></span>

<span class="n">First</span><span class="w"> </span><span class="n">Line</span><span class="w"> </span><span class="n">duplicates</span><span class="w"></span>
<span class="mf">41.3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">5936</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="mf">37.6</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">5395</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">stack_slot_with_size</span><span class="w"></span>
<span class="mf">21.1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">3036</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">insert_call</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>This improves execs/s by 108% (23 -&gt; 48) which is nice. It also eliminates all invalid choices regarding block terminators. </p>
</blockquote>



<a name="298281056"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298281056" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298281056">(Sep 11 2022 at 18:59)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/4894">PR #4894</a> from <code>forward-branching</code> to <code>main</code>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>This PR addresses some of the issues found in #3050 regarding the performance of fuzzgen. We found that we had an outsized number of timeouts during execution of the fuzzer. This is mostly due to generating a bunch of infinite loops.</p>
<p>This changes our branching strategy. Instead of choosing blocks at random, we always choose a block ahead of the current block. This makes it so that we always make forward progress and don't time out very often. I still think backwards branches are important to generate, so we make those a configurable option (0.1% of branches).</p>
<p>Additionally it looks like not having valid target branches was also an issue. 27.3% of our invalid <code>Arbitrary::choice</code> failures were due to us trying to select a block that we didn't have. Such as for example trying to select a block that does not have params when all of them do.<br>
We are now smarter about which terminators we allow to be inserted avoiding these issues.</p>
<p>cc: @jameysharp </p>
<h2>Benchmarks</h2>
<p>&lt;details&gt;<br>
&lt;summary&gt;&lt;h3&gt;Baseline&lt;/h3&gt;&lt;/summary&gt;</p>
<p>Statistics:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="mi">49967</span><span class="w">  </span><span class="n">NEW</span><span class="w">    </span><span class="n">cov</span>: <span class="mi">31776</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">183224</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">4225</span><span class="o">/</span><span class="mi">5444</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">394895</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">23</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">966</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">2106</span><span class="o">/</span><span class="mi">373965</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">2</span><span class="w"> </span><span class="n">ShuffleBytes</span><span class="o">-</span><span class="n">CopyPart</span><span class="o">-</span><span class="w"></span>
<span class="o">==</span><span class="w"> </span><span class="n">FuzzGen</span><span class="w"> </span><span class="n">Statistics</span><span class="w">  </span><span class="o">====================</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">50000</span><span class="w"></span>
<span class="n">Valid</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">18378</span><span class="w"> </span><span class="p">(</span><span class="mf">36.8</span><span class="o">%</span><span class="p">)</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">62769</span><span class="w"></span>
<span class="n">Successful</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">48229</span><span class="w"> </span><span class="p">(</span><span class="mf">76.8</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Timed</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">10440</span><span class="w"> </span><span class="p">(</span><span class="mf">16.6</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Traps</span>:
        <span class="nc">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">int_divz</span>: <span class="mi">4100</span><span class="w"> </span><span class="p">(</span><span class="mf">6.5</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">bad_sig</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">debug</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">icall_null</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">heap_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">int_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">bad_toint</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">interrupt</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">stk_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">table_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">heap_misaligned</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">unreachable</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">resumable</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p><code>Arbitrary::choice</code> failures:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Loaded</span><span class="w"> </span><span class="mi">20139</span><span class="w"> </span><span class="n">stacks</span><span class="w"></span>

<span class="n">First</span><span class="w"> </span><span class="n">Line</span><span class="w"> </span><span class="n">duplicates</span><span class="w"></span>
<span class="mf">5.9</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">1181</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_br_table</span><span class="w"></span>
<span class="mf">8.3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">1679</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_jumptables</span><span class="w"></span>
<span class="mf">1.4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">282</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_switch</span><span class="w"></span>
<span class="mf">11.7</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">2355</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_target_block</span><span class="w"></span>
<span class="mf">29.9</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">6014</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="mf">29.7</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">5991</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">stack_slot_with_size</span><span class="w"></span>
<span class="mf">13.1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">2637</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">insert_call</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>&lt;details&gt;<br>
&lt;summary&gt;&lt;h3&gt;This PR&lt;/h3&gt;&lt;/summary&gt;</p>
<p>Statistics:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="mi">49979</span><span class="w">  </span><span class="n">NEW</span><span class="w">    </span><span class="n">cov</span>: <span class="mi">31503</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">178604</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">3520</span><span class="o">/</span><span class="mi">7374</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">1048576</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">48</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">1054</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">2702</span><span class="o">/</span><span class="mi">1048576</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">1</span><span class="w"> </span><span class="n">CMP</span><span class="o">-</span><span class="w"> </span><span class="n">DE</span>: <span class="s">"</span><span class="se">\x01\x00\x00\x00\x00\x00\x00\x05</span><span class="s">"</span><span class="o">-</span><span class="w"></span>
<span class="o">==</span><span class="w"> </span><span class="n">FuzzGen</span><span class="w"> </span><span class="n">Statistics</span><span class="w">  </span><span class="o">====================</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">50000</span><span class="w"></span>
<span class="n">Valid</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">21036</span><span class="w"> </span><span class="p">(</span><span class="mf">42.1</span><span class="o">%</span><span class="p">)</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">724599</span><span class="w"></span>
<span class="n">Successful</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">719276</span><span class="w"> </span><span class="p">(</span><span class="mf">99.3</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Timed</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">32</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Traps</span>:
        <span class="nc">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">stk_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">heap_misaligned</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">bad_sig</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">table_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">bad_toint</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">heap_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">debug</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">resumable</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">icall_null</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">int_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">int_divz</span>: <span class="mi">5291</span><span class="w"> </span><span class="p">(</span><span class="mf">0.7</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">unreachable</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="n">code</span>: <span class="nc">interrupt</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p><code>Arbitrary::choice</code> failures:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Loaded</span><span class="w"> </span><span class="mi">14367</span><span class="w"> </span><span class="n">stacks</span><span class="w"></span>

<span class="n">First</span><span class="w"> </span><span class="n">Line</span><span class="w"> </span><span class="n">duplicates</span><span class="w"></span>
<span class="mf">41.3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">5936</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="mf">37.6</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">5395</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">stack_slot_with_size</span><span class="w"></span>
<span class="mf">21.1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">3036</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">insert_call</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>This improves execs/s by 108% (23 -&gt; 48) which is nice. It also eliminates all invalid choices regarding block terminators so we reject fewer inputs as well. </p>
</blockquote>



<a name="298485234"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298485234" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298485234">(Sep 12 2022 at 21:56)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#discussion_r968958328">PR review comment</a>:</p>
<blockquote>
<p>It's a minor thing, but I'd prefer to not consume any fuzz input if there aren't any backwards blocks to jump to:</p>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>        let (backwards_blocks, forward_blocks) = self.resources.partition_blocks(source_block);
        let block_targets = if !backwards_blocks.is_empty() &amp;&amp; self.u.ratio(1, 1000)? {
</code></pre></div><br>
</p>
</blockquote>



<a name="298485236"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298485236" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298485236">(Sep 12 2022 at 21:56)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#discussion_r968835166">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>        // so generate a return. We could technically give it a chance to generate a backwards
</code></pre></div><br>
</p>
</blockquote>



<a name="298485237"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298485237" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298485237">(Sep 12 2022 at 21:56)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#discussion_r968836245">PR review comment</a>:</p>
<blockquote>
<p>I think <code>forward_blocks</code> should always be non-empty here because you return early if <code>is_last_block</code>. So you could either treat the <code>has_forward_blocks</code> checks below as always-true, or you could remove the early return in the <code>is_last_block</code> case above. I'd be inclined to remove the <code>is_last_block</code> check, because that check represents a second place where you have to reason about which terminators are legal. I think this function would continue to work correctly without that check.</p>
<p>Note that <code>Unstructured::choose</code> doesn't consume any of the fuzz input if there's only one choice, so we don't lose anything important by just calling it every time.</p>
</blockquote>



<a name="298485238"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298485238" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298485238">(Sep 12 2022 at 21:56)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#discussion_r968807916">PR review comment</a>:</p>
<blockquote>
<p>Unlike <code>partition_blocks</code>, you'd definitely have to search to find the right slice, but I think this can still be simplified:</p>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>        let partition_point = self.blocks_without_params.partition_point(|b| *b &lt;= block);
        &amp;self.blocks_without_params[partition_point..]
</code></pre></div><br>
</p>
</blockquote>



<a name="298485239"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298485239" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298485239">(Sep 12 2022 at 21:56)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#discussion_r968962870">PR review comment</a>:</p>
<blockquote>
<p>Seems unfortunate that <code>insert_switch</code> can't generate backward branches, but I guess that's fine.</p>
</blockquote>



<a name="298485240"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298485240" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298485240">(Sep 12 2022 at 21:56)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#discussion_r968855835">PR review comment</a>:</p>
<blockquote>
<p>What do you think of something along these lines?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">terminators</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">BlockTerminator</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">insert_return</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">insert_switch</span><span class="p">,</span><span class="w"> </span><span class="n">has_forward_blocks_without_params</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="p">].</span><span class="n">into_iter</span><span class="p">().</span><span class="n">filter</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">valid</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="o">*</span><span class="n">valid</span><span class="p">).</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="n">term</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="n">term</span><span class="p">).</span><span class="n">collect</span><span class="p">();</span><span class="w"></span>
</code></pre></div>
<p>We could go further and compute, for each kind of terminator, the first block index where that kind is not valid any more. (Something not valid anywhere in this function would be invalid at block 0, and something that's valid everywhere would become invalid sometime after the last block in the function.) Then we could reuse that list for every block instead of computing it fresh every time. If we have it sorted by block index, then we can choose from a suffix of the array, and never have to copy it.</p>
<p>But that's probably more work than it's worth. I like that the way you've written it means you can check whether a terminator is valid for a block by just getting the same list of targets that the <code>insert_*</code> functions would get.</p>
</blockquote>



<a name="298485241"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298485241" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298485241">(Sep 12 2022 at 21:56)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#discussion_r968793329">PR review comment</a>:</p>
<blockquote>
<p>I haven't checked carefully but I think this should be equivalent. All blocks less than or equal to <code>block</code> are in <code>&amp;blocks[..partition_point]</code> and all greater than <code>block</code> are in <code>&amp;blocks[partition_point..]</code>, and that's true even if either of those slices is empty.</p>
<div class="codehilite" data-code-language="suggestion"><pre><span></span><code>        let partition_point = self.blocks.partition_point(|(b, _)| *b &lt;= block);
</code></pre></div>
<p>That said... Aren't the blocks added in-order and without gaps? Like, is <code>self.blocks[i].0</code> always equal to <code>Block::new(i)</code>? Again, I haven't checked that, but if so we shouldn't need to store the block number and we should be able to find the right block just by indexing into the array.</p>
</blockquote>



<a name="298485243"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298485243" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298485243">(Sep 12 2022 at 21:56)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#discussion_r968851467">PR review comment</a>:</p>
<blockquote>
<p>Not important, but you can remove a layer of indirection by calling <code>copied()</code> sooner. Also I think if you shorten it this way <code>rustfmt</code> should still be happy.</p>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>        let jump_tables = &amp;builder.func.jump_tables;
        self.jump_tables
            .iter()
            .copied()
            .filter(|jt| jump_tables[*jt].iter().all(|target| *target &gt; block))
</code></pre></div><br>
</p>
</blockquote>



<a name="298485246"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298485246" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298485246">(Sep 12 2022 at 21:56)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#pullrequestreview-1104664173">PR review</a>.</p>



<a name="298485247"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298485247" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298485247">(Sep 12 2022 at 21:56)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#pullrequestreview-1104664173">PR review</a>.</p>



<a name="298747823"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298747823" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298747823">(Sep 14 2022 at 11:06)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#pullrequestreview-1107269872">PR review</a>.</p>



<a name="298747827"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298747827" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298747827">(Sep 14 2022 at 11:07)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#discussion_r970663128">PR review comment</a>:</p>
<blockquote>
<p>That is much neater, thanks! I wasn't aware of <code>partition_point()</code></p>
</blockquote>



<a name="298752963"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298752963" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298752963">(Sep 14 2022 at 11:40)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#discussion_r970692920">PR review comment</a>:</p>
<blockquote>
<p>Yeah, we should probably include that</p>
</blockquote>



<a name="298752970"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298752970" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298752970">(Sep 14 2022 at 11:40)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#pullrequestreview-1107315693">PR review</a>.</p>



<a name="298791071"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298791071" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298791071">(Sep 14 2022 at 15:17)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#pullrequestreview-1107724032">PR review</a>.</p>



<a name="298791072"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298791072" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298791072">(Sep 14 2022 at 15:17)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#discussion_r970960399">PR review comment</a>:</p>
<blockquote>
<p>I don't mind leaving this as something to come back to later though. If you want to just add a TODO comment to <code>insert_switch</code> that it would be nice to also check backward branches, that's plenty.</p>
</blockquote>



<a name="298835938"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298835938" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298835938">(Sep 14 2022 at 19:21)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#discussion_r971209400">PR review comment</a>:</p>
<blockquote>
<p>Yeah, that's a great suggestion! I was able to get this to the point where we directly index into the blocks vector using the block number. </p>
<p>We don't necessarily need to store the block alongside the Signature, however removing it makes it so that we can't return a slice here, and the caller of this is quite messy without it and without allocating anything.</p>
</blockquote>



<a name="298835939"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298835939" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298835939">(Sep 14 2022 at 19:21)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#pullrequestreview-1108081686">PR review</a>.</p>



<a name="298835987"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298835987" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298835987">(Sep 14 2022 at 19:22)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4894">PR #4894</a> from <code>forward-branching</code> to <code>main</code>.</p>



<a name="298837018"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298837018" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298837018">(Sep 14 2022 at 19:28)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#discussion_r971215429">PR review comment</a>:</p>
<blockquote>
<p>I like the list thingy. Precomputing the terminator block validity is nice but I also think is a bit of work <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> </p>
</blockquote>



<a name="298837020"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298837020" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298837020">(Sep 14 2022 at 19:28)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#pullrequestreview-1108089790">PR review</a>.</p>



<a name="298837213"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298837213" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298837213">(Sep 14 2022 at 19:29)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#pullrequestreview-1108091375">PR review</a>.</p>



<a name="298837214"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298837214" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298837214">(Sep 14 2022 at 19:29)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#discussion_r971216601">PR review comment</a>:</p>
<blockquote>
<p>Oh, good point! Storing the block number does make things easier in the caller.</p>
</blockquote>



<a name="298838470"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298838470" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298838470">(Sep 14 2022 at 19:36)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4894">PR #4894</a> from <code>forward-branching</code> to <code>main</code>.</p>



<a name="298841908"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298841908" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298841908">(Sep 14 2022 at 19:59)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#pullrequestreview-1108127991">PR review</a>.</p>



<a name="298841909"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298841909" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298841909">(Sep 14 2022 at 19:59)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#discussion_r971241430">PR review comment</a>:</p>
<blockquote>
<p>On further thought, we could avoid allocating here by sorting <code>self.jump_tables</code> in <code>generate_jumptables</code>. I'm happy to merge without it but I'm going to write down the idea in case you decide you want to do it.</p>
<p>The sort key is <code>|jt| builder.func.jump_tables[*jt].iter().min()</code>. In <code>generate_jumptables</code> you could use that as the argument to <code>self.resources.jump_tables.sort_by_cached_key(...)</code>. Then here you could use it in <code>self.jump_tables.partition_point(... &lt;= block)</code>.</p>
<p>To keep the sort key computation in only one place, you could have <code>generate_jumptables</code> save a pair of <code>(min_block, table_id)</code> in <code>self.resources.jump_tables</code>. Then the sort is just <code>self.resources.jump_tables.sort_unstable_by_key(|(min_block, _)| *min_block)</code> and this function just needs <code>self.jump_tables.partition_point(|(min_block, _)| *min_block &lt;= block)</code>.</p>
</blockquote>



<a name="298841910"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298841910" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298841910">(Sep 14 2022 at 19:59)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#pullrequestreview-1108127991">PR review</a>.</p>



<a name="298960171"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298960171" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298960171">(Sep 15 2022 at 12:41)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4894">PR #4894</a> from <code>forward-branching</code> to <code>main</code>.</p>



<a name="298968367"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298968367" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298968367">(Sep 15 2022 at 13:29)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#discussion_r971989459">PR review comment</a>:</p>
<blockquote>
<p>That sounds quite doable! I'm going to add a TODO comment to revisit later, I'd prefer to tackle the other fuzzgen issues for now.</p>
</blockquote>



<a name="298968368"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298968368" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298968368">(Sep 15 2022 at 13:29)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#pullrequestreview-1109198390">PR review</a>.</p>



<a name="298968466"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/298968466" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#298968466">(Sep 15 2022 at 13:30)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4894">PR #4894</a> from <code>forward-branching</code> to <code>main</code>.</p>



<a name="299025267"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/299025267" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#299025267">(Sep 15 2022 at 18:12)</a>:</h4>
<p><strong>afonso360</strong> has marked <a href="https://github.com/bytecodealliance/wasmtime/pull/4894">PR #4894</a> as ready for review.</p>



<a name="299027948"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234894%20fuzzgen%3A%20Mostly%20Forward%20Branching/near/299027948" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234894.20fuzzgen.3A.20Mostly.20Forward.20Branching.html#299027948">(Sep 15 2022 at 18:29)</a>:</h4>
<p>jameysharp merged <a href="https://github.com/bytecodealliance/wasmtime/pull/4894">PR #4894</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>