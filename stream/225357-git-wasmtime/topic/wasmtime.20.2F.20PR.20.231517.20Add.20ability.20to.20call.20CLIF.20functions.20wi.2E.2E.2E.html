<html>
<head><meta charset="utf-8"><title>wasmtime / PR #1517 Add ability to call CLIF functions wi... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html">wasmtime / PR #1517 Add ability to call CLIF functions wi...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="194227576"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/194227576" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#194227576">(Apr 15 2020 at 21:06)</a>:</h4>
<p>abrown opened <a href="https://github.com/bytecodealliance/wasmtime/pull/1517" title="https://github.com/bytecodealliance/wasmtime/pull/1517">PR #1517</a> from <code>run-clif</code> to <code>master</code>:</p>
<blockquote>
<p>This resolves the work started in <a href="https://github.com/bytecodealliance/cranelift/pull/1231" title="https://github.com/bytecodealliance/cranelift/pull/1231">https://github.com/bytecodealliance/cranelift/pull/1231</a> and <a href="https://github.com/bytecodealliance/wasmtime/pull/1436" title="https://github.com/bytecodealliance/wasmtime/pull/1436">https://github.com/bytecodealliance/wasmtime/pull/1436</a>. Cranelift filetests currently have the ability to run CLIF functions with a signature like <code>() -&gt; b*</code> and check that the result is true under the <code>test run</code> directive. This PR adds the ability to call functions with arbitrary arguments and non-boolean returns and either print the result or check against a list of expected results:</p>
<ul>
<li><code>run</code> commands look like <code>; run: %add(2, 2) == 4</code> or <code>; run: %add(2, 2) != 5</code> and verify that the executed CLIF function returns the expected value</li>
<li><code>print</code> commands look like <code>; print: %add(2, 2)</code> and print the result of the function to stdout</li>
</ul>
<p>To make this work, this PR compiles a single Cranelift <code>Function</code> into a <code>CompiledFunction</code> using a <code>SingleFunctionCompiler</code>. Because we will not know the signature of the function until runtime, we use a <code>Trampoline</code> to place the values in the appropriate location for the calling convention; this should look a lot like what @alexcrichton is doing with <code>VMTrampoline</code> in wasmtime (see <a href="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526" title="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526">https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526</a>, <a href="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260" title="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260">https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260</a>). To avoid re-compiling <code>Trampoline</code>s for the same function signatures, <code>Trampoline</code>s are cached in the <code>SingleFunctionCompiler</code>.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md" title="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="194229811"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/194229811" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#194229811">(Apr 15 2020 at 21:26)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1517" title="https://github.com/bytecodealliance/wasmtime/pull/1517">PR #1517</a> from <code>run-clif</code> to <code>master</code>:</p>
<blockquote>
<p>This resolves the work started in <a href="https://github.com/bytecodealliance/cranelift/pull/1231" title="https://github.com/bytecodealliance/cranelift/pull/1231">https://github.com/bytecodealliance/cranelift/pull/1231</a> and <a href="https://github.com/bytecodealliance/wasmtime/pull/1436" title="https://github.com/bytecodealliance/wasmtime/pull/1436">https://github.com/bytecodealliance/wasmtime/pull/1436</a>. Cranelift filetests currently have the ability to run CLIF functions with a signature like <code>() -&gt; b*</code> and check that the result is true under the <code>test run</code> directive. This PR adds the ability to call functions with arbitrary arguments and non-boolean returns and either print the result or check against a list of expected results:</p>
<ul>
<li><code>run</code> commands look like <code>; run: %add(2, 2) == 4</code> or <code>; run: %add(2, 2) != 5</code> and verify that the executed CLIF function returns the expected value</li>
<li><code>print</code> commands look like <code>; print: %add(2, 2)</code> and print the result of the function to stdout</li>
</ul>
<p>To make this work, this PR compiles a single Cranelift <code>Function</code> into a <code>CompiledFunction</code> using a <code>SingleFunctionCompiler</code>. Because we will not know the signature of the function until runtime, we use a <code>Trampoline</code> to place the values in the appropriate location for the calling convention; this should look a lot like what @alexcrichton is doing with <code>VMTrampoline</code> in wasmtime (see <a href="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526" title="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526">https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526</a>, <a href="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260" title="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260">https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260</a>). To avoid re-compiling <code>Trampoline</code>s for the same function signatures, <code>Trampoline</code>s are cached in the <code>SingleFunctionCompiler</code>.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md" title="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="194230768"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/194230768" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#194230768">(Apr 15 2020 at 21:34)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1517" title="https://github.com/bytecodealliance/wasmtime/pull/1517">PR #1517</a> from <code>run-clif</code> to <code>master</code>:</p>
<blockquote>
<p>This resolves the work started in <a href="https://github.com/bytecodealliance/cranelift/pull/1231" title="https://github.com/bytecodealliance/cranelift/pull/1231">https://github.com/bytecodealliance/cranelift/pull/1231</a> and <a href="https://github.com/bytecodealliance/wasmtime/pull/1436" title="https://github.com/bytecodealliance/wasmtime/pull/1436">https://github.com/bytecodealliance/wasmtime/pull/1436</a>. Cranelift filetests currently have the ability to run CLIF functions with a signature like <code>() -&gt; b*</code> and check that the result is true under the <code>test run</code> directive. This PR adds the ability to call functions with arbitrary arguments and non-boolean returns and either print the result or check against a list of expected results:</p>
<ul>
<li><code>run</code> commands look like <code>; run: %add(2, 2) == 4</code> or <code>; run: %add(2, 2) != 5</code> and verify that the executed CLIF function returns the expected value</li>
<li><code>print</code> commands look like <code>; print: %add(2, 2)</code> and print the result of the function to stdout</li>
</ul>
<p>To make this work, this PR compiles a single Cranelift <code>Function</code> into a <code>CompiledFunction</code> using a <code>SingleFunctionCompiler</code>. Because we will not know the signature of the function until runtime, we use a <code>Trampoline</code> to place the values in the appropriate location for the calling convention; this should look a lot like what @alexcrichton is doing with <code>VMTrampoline</code> in wasmtime (see <a href="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526" title="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526">https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526</a>, <a href="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260" title="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260">https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260</a>). To avoid re-compiling <code>Trampoline</code>s for the same function signatures, <code>Trampoline</code>s are cached in the <code>SingleFunctionCompiler</code>.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md" title="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="194556496"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/194556496" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#194556496">(Apr 18 2020 at 17:59)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1517" title="https://github.com/bytecodealliance/wasmtime/pull/1517">PR #1517</a> from <code>run-clif</code> to <code>master</code>:</p>
<blockquote>
<p>This resolves the work started in <a href="https://github.com/bytecodealliance/cranelift/pull/1231" title="https://github.com/bytecodealliance/cranelift/pull/1231">https://github.com/bytecodealliance/cranelift/pull/1231</a> and <a href="https://github.com/bytecodealliance/wasmtime/pull/1436" title="https://github.com/bytecodealliance/wasmtime/pull/1436">https://github.com/bytecodealliance/wasmtime/pull/1436</a>. Cranelift filetests currently have the ability to run CLIF functions with a signature like <code>() -&gt; b*</code> and check that the result is true under the <code>test run</code> directive. This PR adds the ability to call functions with arbitrary arguments and non-boolean returns and either print the result or check against a list of expected results:</p>
<ul>
<li><code>run</code> commands look like <code>; run: %add(2, 2) == 4</code> or <code>; run: %add(2, 2) != 5</code> and verify that the executed CLIF function returns the expected value</li>
<li><code>print</code> commands look like <code>; print: %add(2, 2)</code> and print the result of the function to stdout</li>
</ul>
<p>To make this work, this PR compiles a single Cranelift <code>Function</code> into a <code>CompiledFunction</code> using a <code>SingleFunctionCompiler</code>. Because we will not know the signature of the function until runtime, we use a <code>Trampoline</code> to place the values in the appropriate location for the calling convention; this should look a lot like what @alexcrichton is doing with <code>VMTrampoline</code> in wasmtime (see <a href="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526" title="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526">https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526</a>, <a href="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260" title="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260">https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260</a>). To avoid re-compiling <code>Trampoline</code>s for the same function signatures, <code>Trampoline</code>s are cached in the <code>SingleFunctionCompiler</code>.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md" title="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="194566319"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/194566319" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#194566319">(Apr 18 2020 at 22:15)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1517" title="https://github.com/bytecodealliance/wasmtime/pull/1517">PR #1517</a> from <code>run-clif</code> to <code>master</code>:</p>
<blockquote>
<p>This resolves the work started in <a href="https://github.com/bytecodealliance/cranelift/pull/1231" title="https://github.com/bytecodealliance/cranelift/pull/1231">https://github.com/bytecodealliance/cranelift/pull/1231</a> and <a href="https://github.com/bytecodealliance/wasmtime/pull/1436" title="https://github.com/bytecodealliance/wasmtime/pull/1436">https://github.com/bytecodealliance/wasmtime/pull/1436</a>. Cranelift filetests currently have the ability to run CLIF functions with a signature like <code>() -&gt; b*</code> and check that the result is true under the <code>test run</code> directive. This PR adds the ability to call functions with arbitrary arguments and non-boolean returns and either print the result or check against a list of expected results:</p>
<ul>
<li><code>run</code> commands look like <code>; run: %add(2, 2) == 4</code> or <code>; run: %add(2, 2) != 5</code> and verify that the executed CLIF function returns the expected value</li>
<li><code>print</code> commands look like <code>; print: %add(2, 2)</code> and print the result of the function to stdout</li>
</ul>
<p>To make this work, this PR compiles a single Cranelift <code>Function</code> into a <code>CompiledFunction</code> using a <code>SingleFunctionCompiler</code>. Because we will not know the signature of the function until runtime, we use a <code>Trampoline</code> to place the values in the appropriate location for the calling convention; this should look a lot like what @alexcrichton is doing with <code>VMTrampoline</code> in wasmtime (see <a href="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526" title="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526">https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526</a>, <a href="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260" title="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260">https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260</a>). To avoid re-compiling <code>Trampoline</code>s for the same function signatures, <code>Trampoline</code>s are cached in the <code>SingleFunctionCompiler</code>.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md" title="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="194566387"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/194566387" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#194566387">(Apr 18 2020 at 22:16)</a>:</h4>
<p><strong>abrown</strong> requested <a href="https://github.com/bnjbvr" title="https://github.com/bnjbvr">bnjbvr</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1517" title="https://github.com/bytecodealliance/wasmtime/pull/1517">PR #1517</a>.</p>



<a name="194567043"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/194567043" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#194567043">(Apr 18 2020 at 22:33)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1517" title="https://github.com/bytecodealliance/wasmtime/pull/1517">PR #1517</a> from <code>run-clif</code> to <code>master</code>:</p>
<blockquote>
<p>This resolves the work started in <a href="https://github.com/bytecodealliance/cranelift/pull/1231" title="https://github.com/bytecodealliance/cranelift/pull/1231">https://github.com/bytecodealliance/cranelift/pull/1231</a> and <a href="https://github.com/bytecodealliance/wasmtime/pull/1436" title="https://github.com/bytecodealliance/wasmtime/pull/1436">https://github.com/bytecodealliance/wasmtime/pull/1436</a>. Cranelift filetests currently have the ability to run CLIF functions with a signature like <code>() -&gt; b*</code> and check that the result is true under the <code>test run</code> directive. This PR adds the ability to call functions with arbitrary arguments and non-boolean returns and either print the result or check against a list of expected results:</p>
<ul>
<li><code>run</code> commands look like <code>; run: %add(2, 2) == 4</code> or <code>; run: %add(2, 2) != 5</code> and verify that the executed CLIF function returns the expected value</li>
<li><code>print</code> commands look like <code>; print: %add(2, 2)</code> and print the result of the function to stdout</li>
</ul>
<p>To make this work, this PR compiles a single Cranelift <code>Function</code> into a <code>CompiledFunction</code> using a <code>SingleFunctionCompiler</code>. Because we will not know the signature of the function until runtime, we use a <code>Trampoline</code> to place the values in the appropriate location for the calling convention; this should look a lot like what @alexcrichton is doing with <code>VMTrampoline</code> in wasmtime (see <a href="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526" title="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526">https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526</a>, <a href="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260" title="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260">https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260</a>). To avoid re-compiling <code>Trampoline</code>s for the same function signatures, <code>Trampoline</code>s are cached in the <code>SingleFunctionCompiler</code>.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md" title="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="194567097"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/194567097" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#194567097">(Apr 18 2020 at 22:35)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1517" title="https://github.com/bytecodealliance/wasmtime/pull/1517">PR #1517</a> from <code>run-clif</code> to <code>master</code>:</p>
<blockquote>
<p>This resolves the work started in <a href="https://github.com/bytecodealliance/cranelift/pull/1231" title="https://github.com/bytecodealliance/cranelift/pull/1231">https://github.com/bytecodealliance/cranelift/pull/1231</a> and <a href="https://github.com/bytecodealliance/wasmtime/pull/1436" title="https://github.com/bytecodealliance/wasmtime/pull/1436">https://github.com/bytecodealliance/wasmtime/pull/1436</a>. Cranelift filetests currently have the ability to run CLIF functions with a signature like <code>() -&gt; b*</code> and check that the result is true under the <code>test run</code> directive. This PR adds the ability to call functions with arbitrary arguments and non-boolean returns and either print the result or check against a list of expected results:</p>
<ul>
<li><code>run</code> commands look like <code>; run: %add(2, 2) == 4</code> or <code>; run: %add(2, 2) != 5</code> and verify that the executed CLIF function returns the expected value</li>
<li><code>print</code> commands look like <code>; print: %add(2, 2)</code> and print the result of the function to stdout</li>
</ul>
<p>To make this work, this PR compiles a single Cranelift <code>Function</code> into a <code>CompiledFunction</code> using a <code>SingleFunctionCompiler</code>. Because we will not know the signature of the function until runtime, we use a <code>Trampoline</code> to place the values in the appropriate location for the calling convention; this should look a lot like what @alexcrichton is doing with <code>VMTrampoline</code> in wasmtime (see <a href="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526" title="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526">https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526</a>, <a href="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260" title="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260">https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260</a>). To avoid re-compiling <code>Trampoline</code>s for the same function signatures, <code>Trampoline</code>s are cached in the <code>SingleFunctionCompiler</code>.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md" title="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="194963755"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/194963755" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#194963755">(Apr 22 2020 at 17:20)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1517" title="https://github.com/bytecodealliance/wasmtime/pull/1517">PR #1517</a> from <code>run-clif</code> to <code>master</code>:</p>
<blockquote>
<p>This resolves the work started in <a href="https://github.com/bytecodealliance/cranelift/pull/1231" title="https://github.com/bytecodealliance/cranelift/pull/1231">https://github.com/bytecodealliance/cranelift/pull/1231</a> and <a href="https://github.com/bytecodealliance/wasmtime/pull/1436" title="https://github.com/bytecodealliance/wasmtime/pull/1436">https://github.com/bytecodealliance/wasmtime/pull/1436</a>. Cranelift filetests currently have the ability to run CLIF functions with a signature like <code>() -&gt; b*</code> and check that the result is true under the <code>test run</code> directive. This PR adds the ability to call functions with arbitrary arguments and non-boolean returns and either print the result or check against a list of expected results:</p>
<ul>
<li><code>run</code> commands look like <code>; run: %add(2, 2) == 4</code> or <code>; run: %add(2, 2) != 5</code> and verify that the executed CLIF function returns the expected value</li>
<li><code>print</code> commands look like <code>; print: %add(2, 2)</code> and print the result of the function to stdout</li>
</ul>
<p>To make this work, this PR compiles a single Cranelift <code>Function</code> into a <code>CompiledFunction</code> using a <code>SingleFunctionCompiler</code>. Because we will not know the signature of the function until runtime, we use a <code>Trampoline</code> to place the values in the appropriate location for the calling convention; this should look a lot like what @alexcrichton is doing with <code>VMTrampoline</code> in wasmtime (see <a href="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526" title="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526">https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526</a>, <a href="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260" title="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260">https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260</a>). To avoid re-compiling <code>Trampoline</code>s for the same function signatures, <code>Trampoline</code>s are cached in the <code>SingleFunctionCompiler</code>.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md" title="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="194969504"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/194969504" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#194969504">(Apr 22 2020 at 18:04)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1517" title="https://github.com/bytecodealliance/wasmtime/pull/1517">PR #1517</a> from <code>run-clif</code> to <code>master</code>:</p>
<blockquote>
<p>This resolves the work started in <a href="https://github.com/bytecodealliance/cranelift/pull/1231" title="https://github.com/bytecodealliance/cranelift/pull/1231">https://github.com/bytecodealliance/cranelift/pull/1231</a> and <a href="https://github.com/bytecodealliance/wasmtime/pull/1436" title="https://github.com/bytecodealliance/wasmtime/pull/1436">https://github.com/bytecodealliance/wasmtime/pull/1436</a>. Cranelift filetests currently have the ability to run CLIF functions with a signature like <code>() -&gt; b*</code> and check that the result is true under the <code>test run</code> directive. This PR adds the ability to call functions with arbitrary arguments and non-boolean returns and either print the result or check against a list of expected results:</p>
<ul>
<li><code>run</code> commands look like <code>; run: %add(2, 2) == 4</code> or <code>; run: %add(2, 2) != 5</code> and verify that the executed CLIF function returns the expected value</li>
<li><code>print</code> commands look like <code>; print: %add(2, 2)</code> and print the result of the function to stdout</li>
</ul>
<p>To make this work, this PR compiles a single Cranelift <code>Function</code> into a <code>CompiledFunction</code> using a <code>SingleFunctionCompiler</code>. Because we will not know the signature of the function until runtime, we use a <code>Trampoline</code> to place the values in the appropriate location for the calling convention; this should look a lot like what @alexcrichton is doing with <code>VMTrampoline</code> in wasmtime (see <a href="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526" title="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526">https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526</a>, <a href="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260" title="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260">https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260</a>). To avoid re-compiling <code>Trampoline</code>s for the same function signatures, <code>Trampoline</code>s are cached in the <code>SingleFunctionCompiler</code>.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md" title="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="195219645"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195219645" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195219645">(Apr 24 2020 at 17:23)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1517#pullrequestreview-400072537" title="https://github.com/bytecodealliance/wasmtime/pull/1517#pullrequestreview-400072537">PR Review</a>.</p>



<a name="195219646"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195219646" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195219646">(Apr 24 2020 at 17:23)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1517#pullrequestreview-400072537" title="https://github.com/bytecodealliance/wasmtime/pull/1517#pullrequestreview-400072537">PR Review</a>.</p>



<a name="195219649"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195219649" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195219649">(Apr 24 2020 at 17:23)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r414684940" title="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r414684940">PR Review Comment</a>:</p>
<blockquote>
<p>I think we don't need to worry about the clone, this is an error path, so not perf sensitive. Could it be <code>e.to_string()</code> to avoid the macro use?</p>
</blockquote>



<a name="195219650"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195219650" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195219650">(Apr 24 2020 at 17:23)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r414686603" title="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r414686603">PR Review Comment</a>:</p>
<blockquote>
<p>Instead, could this look if trimmed is exactly run or print? I don't see the value in the ambiguity. If you agree with this, then we could rename this function <code>is_run_or_print_command</code> (since otherwise, there's a "run_command" called "run" and another called "print", which is a bit confusing).</p>
<p>In addition to this, could this return the command it found (so an <code>Option</code>, with <code>None</code> equivalent to current's false), instead of letting the caller clean up comments again and analyze the value?</p>
</blockquote>



<a name="195219652"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195219652" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195219652">(Apr 24 2020 at 17:23)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r414721804" title="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r414721804">PR Review Comment</a>:</p>
<blockquote>
<p>Do we need to trim comments again here? There can't be a comment within a comment, so this would only removed spaces at the start of <code>comment.text</code>, right? If so, and if we want this, could we do it explicitly with <code>trim_start_matches(" ")</code> instead?</p>
</blockquote>



<a name="195219654"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195219654" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195219654">(Apr 24 2020 at 17:23)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r414724315" title="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r414724315">PR Review Comment</a>:</p>
<blockquote>
<p>No need to worry about cloning here, it's not a perf-sensitive path. Can you use <code>e.to_string()</code> though?</p>
</blockquote>



<a name="195219655"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195219655" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195219655">(Apr 24 2020 at 17:23)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r414735576" title="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r414735576">PR Review Comment</a>:</p>
<blockquote>
<p>Could we just do a write here, using a transmute? It avoids the indirection through <code>Trampoline::write_value_to</code>, which is a bit unsettling.</p>
<p>If we did the same for reads, then the need for the <code>Trampoline</code> data structure is much lower, and could probably be avoided. Or we could hide the writing and reading into a different new <code>UnboxedValues</code> struct type (that'd be a vec&lt;u128&gt;); then the <code>slot_size</code> could be an attribute of this struct, a const func returning the size of the values it's storing (and then we can remove a bunch of comments, and have more confidence in the size being sync'd with the storage type). What do you think?</p>
</blockquote>



<a name="195219656"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195219656" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195219656">(Apr 24 2020 at 17:23)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r414726262" title="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r414726262">PR Review Comment</a>:</p>
<blockquote>
<p>Could it also check that the host architecture is equal to the requested ISA's architecture?</p>
</blockquote>



<a name="195219657"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195219657" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195219657">(Apr 24 2020 at 17:23)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r414726985" title="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r414726985">PR Review Comment</a>:</p>
<blockquote>
<p>Could we clone the function's signature before, since it's the only field that's used after (and it's cheap), and then pass the ownership to <code>compile</code>?</p>
</blockquote>



<a name="195459306"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195459306" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195459306">(Apr 27 2020 at 18:46)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1517#pullrequestreview-401230239" title="https://github.com/bytecodealliance/wasmtime/pull/1517#pullrequestreview-401230239">PR Review</a>.</p>



<a name="195459307"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195459307" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195459307">(Apr 27 2020 at 18:46)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r416062084" title="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r416062084">PR Review Comment</a>:</p>
<blockquote>
<p>Those checks should already exist at a higher level, e.g. <code>test_run.rs</code>, and I didn't want to limit this code too much because there are cases (x86 32-bit vs 64-bit) where multiple Cranelift ISAs could run on the same machine.</p>
</blockquote>



<a name="195459371"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195459371" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195459371">(Apr 27 2020 at 18:47)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1517#pullrequestreview-401230639" title="https://github.com/bytecodealliance/wasmtime/pull/1517#pullrequestreview-401230639">PR Review</a>.</p>



<a name="195459372"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195459372" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195459372">(Apr 27 2020 at 18:47)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r416062433" title="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r416062433">PR Review Comment</a>:</p>
<blockquote>
<p>Good idea... done.</p>
</blockquote>



<a name="195459875"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195459875" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195459875">(Apr 27 2020 at 18:51)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1517" title="https://github.com/bytecodealliance/wasmtime/pull/1517">PR #1517</a> from <code>run-clif</code> to <code>master</code>:</p>
<blockquote>
<p>This resolves the work started in <a href="https://github.com/bytecodealliance/cranelift/pull/1231" title="https://github.com/bytecodealliance/cranelift/pull/1231">https://github.com/bytecodealliance/cranelift/pull/1231</a> and <a href="https://github.com/bytecodealliance/wasmtime/pull/1436" title="https://github.com/bytecodealliance/wasmtime/pull/1436">https://github.com/bytecodealliance/wasmtime/pull/1436</a>. Cranelift filetests currently have the ability to run CLIF functions with a signature like <code>() -&gt; b*</code> and check that the result is true under the <code>test run</code> directive. This PR adds the ability to call functions with arbitrary arguments and non-boolean returns and either print the result or check against a list of expected results:</p>
<ul>
<li><code>run</code> commands look like <code>; run: %add(2, 2) == 4</code> or <code>; run: %add(2, 2) != 5</code> and verify that the executed CLIF function returns the expected value</li>
<li><code>print</code> commands look like <code>; print: %add(2, 2)</code> and print the result of the function to stdout</li>
</ul>
<p>To make this work, this PR compiles a single Cranelift <code>Function</code> into a <code>CompiledFunction</code> using a <code>SingleFunctionCompiler</code>. Because we will not know the signature of the function until runtime, we use a <code>Trampoline</code> to place the values in the appropriate location for the calling convention; this should look a lot like what @alexcrichton is doing with <code>VMTrampoline</code> in wasmtime (see <a href="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526" title="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526">https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526</a>, <a href="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260" title="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260">https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260</a>). To avoid re-compiling <code>Trampoline</code>s for the same function signatures, <code>Trampoline</code>s are cached in the <code>SingleFunctionCompiler</code>.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md" title="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="195460354"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195460354" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195460354">(Apr 27 2020 at 18:55)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1517#pullrequestreview-401236768" title="https://github.com/bytecodealliance/wasmtime/pull/1517#pullrequestreview-401236768">PR Review</a>.</p>



<a name="195460356"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195460356" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195460356">(Apr 27 2020 at 18:55)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r416068146" title="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r416068146">PR Review Comment</a>:</p>
<blockquote>
<p>Yeah, this is a good direction. These weird <code>trimmed_comment_chars</code> and <code>is_potential_run_command</code> functions were trying to do some lookahead to see if we actually needed to really parse the comment. I moved that logic into <code>parse_run_command</code> (which is in the parser module, where this functionality should be) and made it return <code>ParseResult&lt;Option&lt;RunCommand&gt;&gt;</code> instead of <code>ParseResult&lt;RunCommand&gt;</code>. The signature is a bit more complex but I think it is headed more in the direction you are suggesting.</p>
</blockquote>



<a name="195461734"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195461734" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195461734">(Apr 27 2020 at 19:07)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1517#pullrequestreview-401245125" title="https://github.com/bytecodealliance/wasmtime/pull/1517#pullrequestreview-401245125">PR Review</a>.</p>



<a name="195461735"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195461735" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195461735">(Apr 27 2020 at 19:07)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r416075808" title="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r416075808">PR Review Comment</a>:</p>
<blockquote>
<p>32bit x86 doesn't work in 64bit processes.</p>
</blockquote>



<a name="195463407"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195463407" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195463407">(Apr 27 2020 at 19:22)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1517#pullrequestreview-401255316" title="https://github.com/bytecodealliance/wasmtime/pull/1517#pullrequestreview-401255316">PR Review</a>.</p>



<a name="195463408"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195463408" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195463408">(Apr 27 2020 at 19:22)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r416085002" title="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r416085002">PR Review Comment</a>:</p>
<blockquote>
<p>I like having the <code>Trampoline</code> structure around to know what we are talking about; otherwise we have an <code>Mmap</code> floating around that is implicitly a trampoline. But that could be a type alias, I guess. I think your <code>UnboxedValues</code> makes sense and I started down this road but I'm not too confident about the transmute stuff--I will ping you on Zulip to see what you think.</p>
</blockquote>



<a name="195646120"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195646120" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195646120">(Apr 29 2020 at 00:29)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1517" title="https://github.com/bytecodealliance/wasmtime/pull/1517">PR #1517</a> from <code>run-clif</code> to <code>master</code>:</p>
<blockquote>
<p>This resolves the work started in <a href="https://github.com/bytecodealliance/cranelift/pull/1231" title="https://github.com/bytecodealliance/cranelift/pull/1231">https://github.com/bytecodealliance/cranelift/pull/1231</a> and <a href="https://github.com/bytecodealliance/wasmtime/pull/1436" title="https://github.com/bytecodealliance/wasmtime/pull/1436">https://github.com/bytecodealliance/wasmtime/pull/1436</a>. Cranelift filetests currently have the ability to run CLIF functions with a signature like <code>() -&gt; b*</code> and check that the result is true under the <code>test run</code> directive. This PR adds the ability to call functions with arbitrary arguments and non-boolean returns and either print the result or check against a list of expected results:</p>
<ul>
<li><code>run</code> commands look like <code>; run: %add(2, 2) == 4</code> or <code>; run: %add(2, 2) != 5</code> and verify that the executed CLIF function returns the expected value</li>
<li><code>print</code> commands look like <code>; print: %add(2, 2)</code> and print the result of the function to stdout</li>
</ul>
<p>To make this work, this PR compiles a single Cranelift <code>Function</code> into a <code>CompiledFunction</code> using a <code>SingleFunctionCompiler</code>. Because we will not know the signature of the function until runtime, we use a <code>Trampoline</code> to place the values in the appropriate location for the calling convention; this should look a lot like what @alexcrichton is doing with <code>VMTrampoline</code> in wasmtime (see <a href="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526" title="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526">https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526</a>, <a href="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260" title="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260">https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260</a>). To avoid re-compiling <code>Trampoline</code>s for the same function signatures, <code>Trampoline</code>s are cached in the <code>SingleFunctionCompiler</code>.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md" title="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="195721311"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195721311" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195721311">(Apr 29 2020 at 14:52)</a>:</h4>
<p><strong>bnjbvr</strong> requested <a href="https://github.com/bnjbvr" title="https://github.com/bnjbvr">bnjbvr</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1517" title="https://github.com/bytecodealliance/wasmtime/pull/1517">PR #1517</a>.</p>



<a name="195851188"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195851188" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195851188">(Apr 30 2020 at 14:58)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1517#pullrequestreview-403601590" title="https://github.com/bytecodealliance/wasmtime/pull/1517#pullrequestreview-403601590">PR Review</a>.</p>



<a name="195851190"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195851190" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195851190">(Apr 30 2020 at 14:58)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1517#pullrequestreview-403601590" title="https://github.com/bytecodealliance/wasmtime/pull/1517#pullrequestreview-403601590">PR Review</a>.</p>



<a name="195851191"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195851191" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195851191">(Apr 30 2020 at 14:58)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r418073403" title="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r418073403">PR Review Comment</a>:</p>
<blockquote>
<p>nit: can we put the <code>unsafe</code> within the <code>push</code>, to make it clear that the push itself isn't an issue?</p>
</blockquote>



<a name="195851192"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195851192" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195851192">(Apr 30 2020 at 14:58)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r418072865" title="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r418072865">PR Review Comment</a>:</p>
<blockquote>
<p>This will manifest as a panic when running a test, right? Is there a way to propagate this as an error to the test runner, with the right file location, instead?</p>
</blockquote>



<a name="195876168"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195876168" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195876168">(Apr 30 2020 at 17:48)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r418184148" title="https://github.com/bytecodealliance/wasmtime/pull/1517#discussion_r418184148">PR Review Comment</a>:</p>
<blockquote>
<p><code>Parser::parse_data_value</code> actually does that type checking before we ever get here; I'm going to change this to an <code>assert!</code> since that more clearly indicates the intent of this check.</p>
</blockquote>



<a name="195876169"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195876169" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195876169">(Apr 30 2020 at 17:48)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1517#pullrequestreview-403744867" title="https://github.com/bytecodealliance/wasmtime/pull/1517#pullrequestreview-403744867">PR Review</a>.</p>



<a name="195876535"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195876535" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195876535">(Apr 30 2020 at 17:51)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1517" title="https://github.com/bytecodealliance/wasmtime/pull/1517">PR #1517</a> from <code>run-clif</code> to <code>master</code>:</p>
<blockquote>
<p>This resolves the work started in <a href="https://github.com/bytecodealliance/cranelift/pull/1231" title="https://github.com/bytecodealliance/cranelift/pull/1231">https://github.com/bytecodealliance/cranelift/pull/1231</a> and <a href="https://github.com/bytecodealliance/wasmtime/pull/1436" title="https://github.com/bytecodealliance/wasmtime/pull/1436">https://github.com/bytecodealliance/wasmtime/pull/1436</a>. Cranelift filetests currently have the ability to run CLIF functions with a signature like <code>() -&gt; b*</code> and check that the result is true under the <code>test run</code> directive. This PR adds the ability to call functions with arbitrary arguments and non-boolean returns and either print the result or check against a list of expected results:</p>
<ul>
<li><code>run</code> commands look like <code>; run: %add(2, 2) == 4</code> or <code>; run: %add(2, 2) != 5</code> and verify that the executed CLIF function returns the expected value</li>
<li><code>print</code> commands look like <code>; print: %add(2, 2)</code> and print the result of the function to stdout</li>
</ul>
<p>To make this work, this PR compiles a single Cranelift <code>Function</code> into a <code>CompiledFunction</code> using a <code>SingleFunctionCompiler</code>. Because we will not know the signature of the function until runtime, we use a <code>Trampoline</code> to place the values in the appropriate location for the calling convention; this should look a lot like what @alexcrichton is doing with <code>VMTrampoline</code> in wasmtime (see <a href="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526" title="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526">https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/api/src/func.rs#L510-L526</a>, <a href="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260" title="https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260">https://github.com/bytecodealliance/wasmtime/blob/3b7cb6ee64469470fcdd68e185abca8eb2a1b20a/crates/jit/src/compiler.rs#L260</a>). To avoid re-compiling <code>Trampoline</code>s for the same function signatures, <code>Trampoline</code>s are cached in the <code>SingleFunctionCompiler</code>.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md" title="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="195880562"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231517%20Add%20ability%20to%20call%20CLIF%20functions%20wi.../near/195880562" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231517.20Add.20ability.20to.20call.20CLIF.20functions.20wi.2E.2E.2E.html#195880562">(Apr 30 2020 at 18:21)</a>:</h4>
<p>abrown merged <a href="https://github.com/bytecodealliance/wasmtime/pull/1517" title="https://github.com/bytecodealliance/wasmtime/pull/1517">PR #1517</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>