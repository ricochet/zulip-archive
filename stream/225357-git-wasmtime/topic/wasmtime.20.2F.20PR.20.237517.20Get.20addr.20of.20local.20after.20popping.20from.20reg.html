<html>
<head><meta charset="utf-8"><title>wasmtime / PR #7517 Get addr of local after popping from reg · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237517.20Get.20addr.20of.20local.20after.20popping.20from.20reg.html">wasmtime / PR #7517 Get addr of local after popping from reg</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="401228515"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237517%20Get%20addr%20of%20local%20after%20popping%20from%20reg/near/401228515" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237517.20Get.20addr.20of.20local.20after.20popping.20from.20reg.html#401228515">(Nov 09 2023 at 20:09)</a>:</h4>
<p>jeffcharles opened <a href="https://github.com/bytecodealliance/wasmtime/pull/7517">PR #7517</a> from <code>jeffcharles:winch-get-addr-after-popping-to-reg</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;<br>
I observed in Winch that the offset from the stack pointer for locals written to with <code>local.set</code> and <code>local.tee</code> are slightly wrong when they are writing to a local that had been spilled by a prior operation. The cause appears to be that we get the address of the local (that is, the offset from the stack pointer) before invoking <code>self.context.pop_to_reg</code> and then use that address to perform the store operation. <code>self.context.pop_to_reg</code> may change the value of the stack pointer if the value on top of the stack is in memory. So the previously calculated stack pointer offset of the local may not be correct when storing a value into that address. This change has us calculate the address of the local (that is, the offset from the stack pointer) after invoking <code>self.context.pop_to_reg</code> to avoid that problem.</p>
</blockquote>



<a name="401228517"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237517%20Get%20addr%20of%20local%20after%20popping%20from%20reg/near/401228517" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237517.20Get.20addr.20of.20local.20after.20popping.20from.20reg.html#401228517">(Nov 09 2023 at 20:09)</a>:</h4>
<p><strong>jeffcharles</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7517">PR #7517</a>.</p>



<a name="401228518"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237517%20Get%20addr%20of%20local%20after%20popping%20from%20reg/near/401228518" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237517.20Get.20addr.20of.20local.20after.20popping.20from.20reg.html#401228518">(Nov 09 2023 at 20:09)</a>:</h4>
<p><strong>jeffcharles</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7517">PR #7517</a>.</p>



<a name="401229638"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237517%20Get%20addr%20of%20local%20after%20popping%20from%20reg/near/401229638" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237517.20Get.20addr.20of.20local.20after.20popping.20from.20reg.html#401229638">(Nov 09 2023 at 20:16)</a>:</h4>
<p>saulecabrera submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7517#pullrequestreview-1723423503">PR review</a>:</p>
<blockquote>
<p>Thanks for finding this, I left one minor nit on wording, but else this looks good to me. </p>
</blockquote>



<a name="401229639"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237517%20Get%20addr%20of%20local%20after%20popping%20from%20reg/near/401229639" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237517.20Get.20addr.20of.20local.20after.20popping.20from.20reg.html#401229639">(Nov 09 2023 at 20:16)</a>:</h4>
<p>saulecabrera submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7517#pullrequestreview-1723423503">PR review</a>:</p>
<blockquote>
<p>Thanks for finding this, I left one minor nit on wording, but else this looks good to me. </p>
</blockquote>



<a name="401229640"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237517%20Get%20addr%20of%20local%20after%20popping%20from%20reg/near/401229640" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237517.20Get.20addr.20of.20local.20after.20popping.20from.20reg.html#401229640">(Nov 09 2023 at 20:16)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/7517#discussion_r1388537999">PR review comment</a>:</p>
<blockquote>
<p>One minor nit on this comment: it won't change the local's offset, it will change the calculation of that offset from the current position of the stack pointer. I'd suggest rewording this a bit to something like: _Need to get the local address before popping the value given that <code>pop_to_reg</code> will pop the machine stack, causing a wrong address to be calculated_</p>
</blockquote>



<a name="401230657"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237517%20Get%20addr%20of%20local%20after%20popping%20from%20reg/near/401230657" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237517.20Get.20addr.20of.20local.20after.20popping.20from.20reg.html#401230657">(Nov 09 2023 at 20:24)</a>:</h4>
<p>jeffcharles updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7517">PR #7517</a>.</p>



<a name="401231257"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237517%20Get%20addr%20of%20local%20after%20popping%20from%20reg/near/401231257" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237517.20Get.20addr.20of.20local.20after.20popping.20from.20reg.html#401231257">(Nov 09 2023 at 20:28)</a>:</h4>
<p>saulecabrera has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/7517">PR #7517</a>.</p>



<a name="401240523"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237517%20Get%20addr%20of%20local%20after%20popping%20from%20reg/near/401240523" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237517.20Get.20addr.20of.20local.20after.20popping.20from.20reg.html#401240523">(Nov 09 2023 at 21:34)</a>:</h4>
<p>saulecabrera merged <a href="https://github.com/bytecodealliance/wasmtime/pull/7517">PR #7517</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>