<html>
<head><meta charset="utf-8"><title>wasmtime / issue #3859 Unwind info for Windows may not be... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233859.20Unwind.20info.20for.20Windows.20may.20not.20be.2E.2E.2E.html">wasmtime / issue #3859 Unwind info for Windows may not be...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="273503158"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233859%20Unwind%20info%20for%20Windows%20may%20not%20be.../near/273503158" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233859.20Unwind.20info.20for.20Windows.20may.20not.20be.2E.2E.2E.html#273503158">(Feb 28 2022 at 15:11)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/issues/3859">issue #3859</a>:</p>
<blockquote>
<p>With a debugging session last Friday about Windows-specific CI failures we ended up concluding that CI failures were tied to Github Actions' recent upgrade of the <code>windows-latest</code> image from <code>windows-2019</code> to <code>windows-2022</code>. The PR to <a href="https://github.com/bytecodealliance/wasmtime/pull/3854">temporarily pin to <code>windows-2019</code></a> has landed and CI is fixed for now but we also did some further investigation to figure out what about <code>windows-2022</code> was causing breakage.</p>
<p>With the investigation on <a href="https://github.com/bytecodealliance/wasmtime/pull/3853">https://github.com/bytecodealliance/wasmtime/pull/3853</a> the conclusion was that one of the failing tests was <code>wast::Cranelift::misc::stack_overflow</code>. Some further investigation showed that all stack overflow tests were failing. Digging further into this our first conclusion was <a href="https://github.com/bytecodealliance/wasmtime/issues/3857">https://github.com/bytecodealliance/wasmtime/issues/3857</a> which is separate from this issue, but we realized that reproducing this issue required running tests on separate threads, at least with <code>--test-threads 2</code>. </p>
<p>The previous CI failures we were seeing were out-of-memory errors on the tune of 5GiB allocations. It turns out that <code>Backtrace::new_unresolved</code> was the culprit as the stack trace was hitting an "infinite loop" where the stack wasn't actually infinite but the stack unwinder was infinitely looping over frames. We attempted to collect (<a href="https://github.com/bytecodealliance/wasmtime/issues/3858">https://github.com/bytecodealliance/wasmtime/issues/3858</a>) all these frames which resulted in OOM.</p>
<p>That's all basically a long-winded way of saying that the system-generated stack trace on <code>windows-2019</code> was correct while the stack trace on <code>windows-2022</code> was an "infinite" stack trace (despite it not actually being infinite). For a simple WebAssembly module:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">module</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>the cranelift machine IR emitted for this is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">VCode_ShowWithRRU</span><span class="w"> </span><span class="p">{{</span><span class="w"></span>
<span class="w">  </span><span class="n">Entry</span><span class="w"> </span><span class="n">block</span>: <span class="mi">0</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="mi">0</span>:
  <span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="n">IR</span><span class="w"> </span><span class="n">block</span>: <span class="nc">block0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">successor</span>: <span class="nc">Block</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="n">range</span>: <span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">13</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">0</span>:   <span class="nc">pushq</span><span class="w">   </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">1</span>:   <span class="nc">unwind</span><span class="w"> </span><span class="n">PushFrameRegs</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">offset_upward_to_caller_sp</span>: <span class="mi">16</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">2</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">3</span>:   <span class="nc">movq</span><span class="w">    </span><span class="mi">0</span><span class="p">(</span><span class="o">%</span><span class="n">rdi</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">r10</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">4</span>:   <span class="nc">movq</span><span class="w">    </span><span class="mi">0</span><span class="p">(</span><span class="o">%</span><span class="n">r10</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">r10</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">5</span>:   <span class="nc">cmpq</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r10</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">6</span>:   <span class="nc">jbe</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">ud2</span><span class="w"> </span><span class="n">stk_ovf</span><span class="w"> </span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">7</span>:   <span class="nc">unwind</span><span class="w"> </span><span class="n">DefineNewFrame</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">offset_upward_to_caller_sp</span>: <span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="n">offset_downward_to_clobbers</span>: <span class="mi">0</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">8</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rax</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">9</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rdi</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">10</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsi</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">11</span>:   <span class="nc">call</span><span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">namespace</span>: <span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">index</span>: <span class="mi">0</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">12</span>:   <span class="nc">jmp</span><span class="w">     </span><span class="n">label1</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="mi">1</span>:
  <span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="n">IR</span><span class="w"> </span><span class="n">block</span>: <span class="nc">block1</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="n">range</span>: <span class="mi">13</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">13</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">14</span>:   <span class="nc">popq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">15</span>:   <span class="nc">ret</span><span class="w"></span>
<span class="p">}}</span><span class="w"></span>
</code></pre></div>
<p>When wasm hits the fault at <code>"Inst 6" above due to stack overflow this is before the </code>DefineNewFrame<code> unwind pseudo-instruction, but that instruction should probably be just after "Inst 2" instead of at the end of the prologue that checks the out-of-stack condition. The current suspicion is that this probably-incorrect location of </code>DefineNewFrame<code> is why the </code>windows-2022` stack unwinding hits an infinite loop.</p>
<p>It's worth noting that one of the debugging runs on <a href="https://github.com/bytecodealliance/wasmtime/pull/3853">https://github.com/bytecodealliance/wasmtime/pull/3853</a> printed out the ip/sp of each frame on the stack and it looked like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">0</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7ff62df77637</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55af8d20</span><span class="w"></span>
<span class="mi">1</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7ff62df77637</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55af8d20</span><span class="w"></span>
<span class="mi">2</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7ff62df77527</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afabd0</span><span class="w"></span>
<span class="mi">3</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7ff62df54c33</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afac40</span><span class="w"></span>
<span class="mi">4</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7ff62df55303</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afae30</span><span class="w"></span>
<span class="mi">5</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7ff62df635a7</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afaea0</span><span class="w"></span>
<span class="mi">6</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7ff62df55238</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afaf10</span><span class="w"></span>
<span class="mi">7</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7fff1896b592</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afaf60</span><span class="w"></span>
<span class="mi">8</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7fff18922022</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afb000</span><span class="w"></span>
<span class="mi">9</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7fff18992e1e</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afb240</span><span class="w"></span>
<span class="mi">10</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1013</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afc010</span><span class="w"></span>
<span class="mi">11</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55afc020</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afc018</span><span class="w"></span>
<span class="mi">12</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afc020</span><span class="w"></span>
<span class="mi">13</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55afc030</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afc028</span><span class="w"></span>
<span class="mi">14</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afc030</span><span class="w"></span>
<span class="mi">15</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55afc040</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afc038</span><span class="w"></span>
<span class="mi">16</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afc040</span><span class="w"></span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="mi">22446</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d30</span><span class="w"></span>
<span class="mi">22447</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55b27d40</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d38</span><span class="w"></span>
<span class="mi">22448</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d40</span><span class="w"></span>
<span class="mi">22449</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55b27d50</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d48</span><span class="w"></span>
<span class="mi">22450</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d50</span><span class="w"></span>
<span class="mi">22451</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55b27d60</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d58</span><span class="w"></span>
<span class="mi">22452</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d60</span><span class="w"></span>
<span class="mi">22453</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55b27d70</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d68</span><span class="w"></span>
<span class="mi">22454</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d70</span><span class="w"></span>
<span class="mi">22455</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55b27d80</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d78</span><span class="w"></span>
<span class="mi">22456</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d80</span><span class="w"></span>
<span class="mi">22457</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55b27d90</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d88</span><span class="w"></span>
<span class="mi">22458</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d90</span><span class="w"></span>
<span class="mi">22459</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55b27da0</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d98</span><span class="w"></span>
</code></pre></div>
<p>where the <code>ip</code> is seemingly correct in that this was a mutally recursive set of functions as part of the test case and the <code>sp</code> is indeed increasing, but there seems to be no limit to <code>sp</code> increasing and apparently no reads/writes of memory are being done because presumably it would have otherwise segfaulted at this point!</p>
<p>In any case it appears that bad unwinding information is to blame here on Windows, so this issue is intended to track fixing that, and a fix for this issue should likely be accompanied with a revert of <a href="https://github.com/bytecodealliance/wasmtime/pull/3854">https://github.com/bytecodealliance/wasmtime/pull/3854</a> as well.</p>
</blockquote>



<a name="273513320"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233859%20Unwind%20info%20for%20Windows%20may%20not%20be.../near/273513320" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233859.20Unwind.20info.20for.20Windows.20may.20not.20be.2E.2E.2E.html#273513320">(Feb 28 2022 at 16:12)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/3859#issuecomment-1054417172">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3859">issue #3859</a>:</p>
<blockquote>
<p>cc @cfallin, @peterhuene </p>
</blockquote>



<a name="273536311"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233859%20Unwind%20info%20for%20Windows%20may%20not%20be.../near/273536311" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233859.20Unwind.20info.20for.20Windows.20may.20not.20be.2E.2E.2E.html#273536311">(Feb 28 2022 at 18:54)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/3859#issuecomment-1054562730">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3859">issue #3859</a>:</p>
<blockquote>
<p>Some notes here: I've been paging in details on the unwind generation and ABI code and this will require a bit of surgery to fix I think. In particular:</p>
<ul>
<li>The <code>DefineNewFrame</code> unwind pseudo-inst (<a href="https://github.com/bytecodealliance/wasmtime/blob/aeaca2062fd0b997483597280bfdb5dff8cb545d/cranelift/codegen/src/isa/unwind.rs#L149-L156">defined here</a>) has info about clobber-frame size.</li>
<li>This means that the generation of this pseudo-inst <a href="https://github.com/bytecodealliance/wasmtime/blob/aeaca2062fd0b997483597280bfdb5dff8cb545d/cranelift/codegen/src/isa/x64/abi.rs#L509-L520">here</a> (for x64, but similarly for others) needs to occur in the clobber-saving trait method, which is invoked after the initial prologue (push rbp / mov rbp, rsp).</li>
<li>The info about clobbers is currently needed because in the translation <a href="https://github.com/bytecodealliance/wasmtime/blob/aeaca2062fd0b997483597280bfdb5dff8cb545d/cranelift/codegen/src/isa/unwind/winx64.rs#L280-L292">both to winx64 unwind</a> and <a href="https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/codegen/src/isa/unwind/systemv.rs#L205-L223">systemv unwind</a> we save info to be able to generate the correct offsets with subsequent clobber saves.</li>
</ul>
<p>I think the simplest approach is probably to split the function of <code>DefineNewFrame</code> into two parts: the actual setting of the FP register, and the metadata used to generate FP- or SP-relative offsets for clobber saves. I'll see what I can do about that.</p>
</blockquote>



<a name="273538577"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233859%20Unwind%20info%20for%20Windows%20may%20not%20be.../near/273538577" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233859.20Unwind.20info.20for.20Windows.20may.20not.20be.2E.2E.2E.html#273538577">(Feb 28 2022 at 19:09)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/3859#issuecomment-1054574524">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3859">issue #3859</a>:</p>
<blockquote>
<p>Hmm, and as an added twist, when <a href="https://github.com/bytecodealliance/wasmtime/blob/dd9c86a58c509c2408d6baa5d89734ceb9de3947/cranelift/codegen/src/isa/unwind/winx64.rs#L280-L286">generating the SetFPReg Windows unwind record</a> we need to know the size of the clobbers, so we actually can't do the split I suggested above; we need to process clobbers (at least know their size) before we generate the unwind info for setting the FP, which itself happens before the stack check (and must be so, as Windows requires a fairly rigid prologue sequence). So the way in which we handle stack check generation has to change overall. Will consider more!</p>
</blockquote>



<a name="276393138"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233859%20Unwind%20info%20for%20Windows%20may%20not%20be.../near/276393138" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233859.20Unwind.20info.20for.20Windows.20may.20not.20be.2E.2E.2E.html#276393138">(Mar 23 2022 at 20:12)</a>:</h4>
<p>alexcrichton labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/3859">issue #3859</a>:</p>
<blockquote>
<p>With a debugging session last Friday about Windows-specific CI failures we ended up concluding that CI failures were tied to Github Actions' recent upgrade of the <code>windows-latest</code> image from <code>windows-2019</code> to <code>windows-2022</code>. The PR to <a href="https://github.com/bytecodealliance/wasmtime/pull/3854">temporarily pin to <code>windows-2019</code></a> has landed and CI is fixed for now but we also did some further investigation to figure out what about <code>windows-2022</code> was causing breakage.</p>
<p>With the investigation on <a href="https://github.com/bytecodealliance/wasmtime/pull/3853">https://github.com/bytecodealliance/wasmtime/pull/3853</a> the conclusion was that one of the failing tests was <code>wast::Cranelift::misc::stack_overflow</code>. Some further investigation showed that all stack overflow tests were failing. Digging further into this our first conclusion was <a href="https://github.com/bytecodealliance/wasmtime/issues/3857">https://github.com/bytecodealliance/wasmtime/issues/3857</a> which is separate from this issue, but we realized that reproducing this issue required running tests on separate threads, at least with <code>--test-threads 2</code>. </p>
<p>The previous CI failures we were seeing were out-of-memory errors on the tune of 5GiB allocations. It turns out that <code>Backtrace::new_unresolved</code> was the culprit as the stack trace was hitting an "infinite loop" where the stack wasn't actually infinite but the stack unwinder was infinitely looping over frames. We attempted to collect (<a href="https://github.com/bytecodealliance/wasmtime/issues/3858">https://github.com/bytecodealliance/wasmtime/issues/3858</a>) all these frames which resulted in OOM.</p>
<p>That's all basically a long-winded way of saying that the system-generated stack trace on <code>windows-2019</code> was correct while the stack trace on <code>windows-2022</code> was an "infinite" stack trace (despite it not actually being infinite). For a simple WebAssembly module:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">module</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>the cranelift machine IR emitted for this is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">VCode_ShowWithRRU</span><span class="w"> </span><span class="p">{{</span><span class="w"></span>
<span class="w">  </span><span class="n">Entry</span><span class="w"> </span><span class="n">block</span>: <span class="mi">0</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="mi">0</span>:
  <span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="n">IR</span><span class="w"> </span><span class="n">block</span>: <span class="nc">block0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">successor</span>: <span class="nc">Block</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="n">range</span>: <span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">13</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">0</span>:   <span class="nc">pushq</span><span class="w">   </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">1</span>:   <span class="nc">unwind</span><span class="w"> </span><span class="n">PushFrameRegs</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">offset_upward_to_caller_sp</span>: <span class="mi">16</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">2</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">3</span>:   <span class="nc">movq</span><span class="w">    </span><span class="mi">0</span><span class="p">(</span><span class="o">%</span><span class="n">rdi</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">r10</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">4</span>:   <span class="nc">movq</span><span class="w">    </span><span class="mi">0</span><span class="p">(</span><span class="o">%</span><span class="n">r10</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">r10</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">5</span>:   <span class="nc">cmpq</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r10</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">6</span>:   <span class="nc">jbe</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">ud2</span><span class="w"> </span><span class="n">stk_ovf</span><span class="w"> </span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">7</span>:   <span class="nc">unwind</span><span class="w"> </span><span class="n">DefineNewFrame</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">offset_upward_to_caller_sp</span>: <span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="n">offset_downward_to_clobbers</span>: <span class="mi">0</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">8</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rax</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">9</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rdi</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">10</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsi</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">11</span>:   <span class="nc">call</span><span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">namespace</span>: <span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">index</span>: <span class="mi">0</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">12</span>:   <span class="nc">jmp</span><span class="w">     </span><span class="n">label1</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="mi">1</span>:
  <span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="n">IR</span><span class="w"> </span><span class="n">block</span>: <span class="nc">block1</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="n">range</span>: <span class="mi">13</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">13</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">14</span>:   <span class="nc">popq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">15</span>:   <span class="nc">ret</span><span class="w"></span>
<span class="p">}}</span><span class="w"></span>
</code></pre></div>
<p>When wasm hits the fault at <code>"Inst 6" above due to stack overflow this is before the </code>DefineNewFrame<code> unwind pseudo-instruction, but that instruction should probably be just after "Inst 2" instead of at the end of the prologue that checks the out-of-stack condition. The current suspicion is that this probably-incorrect location of </code>DefineNewFrame<code> is why the </code>windows-2022` stack unwinding hits an infinite loop.</p>
<p>It's worth noting that one of the debugging runs on <a href="https://github.com/bytecodealliance/wasmtime/pull/3853">https://github.com/bytecodealliance/wasmtime/pull/3853</a> printed out the ip/sp of each frame on the stack and it looked like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">0</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7ff62df77637</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55af8d20</span><span class="w"></span>
<span class="mi">1</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7ff62df77637</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55af8d20</span><span class="w"></span>
<span class="mi">2</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7ff62df77527</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afabd0</span><span class="w"></span>
<span class="mi">3</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7ff62df54c33</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afac40</span><span class="w"></span>
<span class="mi">4</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7ff62df55303</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afae30</span><span class="w"></span>
<span class="mi">5</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7ff62df635a7</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afaea0</span><span class="w"></span>
<span class="mi">6</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7ff62df55238</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afaf10</span><span class="w"></span>
<span class="mi">7</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7fff1896b592</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afaf60</span><span class="w"></span>
<span class="mi">8</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7fff18922022</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afb000</span><span class="w"></span>
<span class="mi">9</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7fff18992e1e</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afb240</span><span class="w"></span>
<span class="mi">10</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1013</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afc010</span><span class="w"></span>
<span class="mi">11</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55afc020</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afc018</span><span class="w"></span>
<span class="mi">12</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afc020</span><span class="w"></span>
<span class="mi">13</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55afc030</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afc028</span><span class="w"></span>
<span class="mi">14</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afc030</span><span class="w"></span>
<span class="mi">15</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55afc040</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afc038</span><span class="w"></span>
<span class="mi">16</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afc040</span><span class="w"></span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="mi">22446</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d30</span><span class="w"></span>
<span class="mi">22447</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55b27d40</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d38</span><span class="w"></span>
<span class="mi">22448</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d40</span><span class="w"></span>
<span class="mi">22449</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55b27d50</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d48</span><span class="w"></span>
<span class="mi">22450</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d50</span><span class="w"></span>
<span class="mi">22451</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55b27d60</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d58</span><span class="w"></span>
<span class="mi">22452</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d60</span><span class="w"></span>
<span class="mi">22453</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55b27d70</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d68</span><span class="w"></span>
<span class="mi">22454</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d70</span><span class="w"></span>
<span class="mi">22455</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55b27d80</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d78</span><span class="w"></span>
<span class="mi">22456</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d80</span><span class="w"></span>
<span class="mi">22457</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55b27d90</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d88</span><span class="w"></span>
<span class="mi">22458</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d90</span><span class="w"></span>
<span class="mi">22459</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55b27da0</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d98</span><span class="w"></span>
</code></pre></div>
<p>where the <code>ip</code> is seemingly correct in that this was a mutally recursive set of functions as part of the test case and the <code>sp</code> is indeed increasing, but there seems to be no limit to <code>sp</code> increasing and apparently no reads/writes of memory are being done because presumably it would have otherwise segfaulted at this point!</p>
<p>In any case it appears that bad unwinding information is to blame here on Windows, so this issue is intended to track fixing that, and a fix for this issue should likely be accompanied with a revert of <a href="https://github.com/bytecodealliance/wasmtime/pull/3854">https://github.com/bytecodealliance/wasmtime/pull/3854</a> as well.</p>
</blockquote>



<a name="276393139"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233859%20Unwind%20info%20for%20Windows%20may%20not%20be.../near/276393139" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233859.20Unwind.20info.20for.20Windows.20may.20not.20be.2E.2E.2E.html#276393139">(Mar 23 2022 at 20:12)</a>:</h4>
<p>alexcrichton labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/3859">issue #3859</a>:</p>
<blockquote>
<p>With a debugging session last Friday about Windows-specific CI failures we ended up concluding that CI failures were tied to Github Actions' recent upgrade of the <code>windows-latest</code> image from <code>windows-2019</code> to <code>windows-2022</code>. The PR to <a href="https://github.com/bytecodealliance/wasmtime/pull/3854">temporarily pin to <code>windows-2019</code></a> has landed and CI is fixed for now but we also did some further investigation to figure out what about <code>windows-2022</code> was causing breakage.</p>
<p>With the investigation on <a href="https://github.com/bytecodealliance/wasmtime/pull/3853">https://github.com/bytecodealliance/wasmtime/pull/3853</a> the conclusion was that one of the failing tests was <code>wast::Cranelift::misc::stack_overflow</code>. Some further investigation showed that all stack overflow tests were failing. Digging further into this our first conclusion was <a href="https://github.com/bytecodealliance/wasmtime/issues/3857">https://github.com/bytecodealliance/wasmtime/issues/3857</a> which is separate from this issue, but we realized that reproducing this issue required running tests on separate threads, at least with <code>--test-threads 2</code>. </p>
<p>The previous CI failures we were seeing were out-of-memory errors on the tune of 5GiB allocations. It turns out that <code>Backtrace::new_unresolved</code> was the culprit as the stack trace was hitting an "infinite loop" where the stack wasn't actually infinite but the stack unwinder was infinitely looping over frames. We attempted to collect (<a href="https://github.com/bytecodealliance/wasmtime/issues/3858">https://github.com/bytecodealliance/wasmtime/issues/3858</a>) all these frames which resulted in OOM.</p>
<p>That's all basically a long-winded way of saying that the system-generated stack trace on <code>windows-2019</code> was correct while the stack trace on <code>windows-2022</code> was an "infinite" stack trace (despite it not actually being infinite). For a simple WebAssembly module:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">module</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>the cranelift machine IR emitted for this is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">VCode_ShowWithRRU</span><span class="w"> </span><span class="p">{{</span><span class="w"></span>
<span class="w">  </span><span class="n">Entry</span><span class="w"> </span><span class="n">block</span>: <span class="mi">0</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="mi">0</span>:
  <span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="n">IR</span><span class="w"> </span><span class="n">block</span>: <span class="nc">block0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">successor</span>: <span class="nc">Block</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="n">range</span>: <span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">13</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">0</span>:   <span class="nc">pushq</span><span class="w">   </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">1</span>:   <span class="nc">unwind</span><span class="w"> </span><span class="n">PushFrameRegs</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">offset_upward_to_caller_sp</span>: <span class="mi">16</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">2</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">3</span>:   <span class="nc">movq</span><span class="w">    </span><span class="mi">0</span><span class="p">(</span><span class="o">%</span><span class="n">rdi</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">r10</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">4</span>:   <span class="nc">movq</span><span class="w">    </span><span class="mi">0</span><span class="p">(</span><span class="o">%</span><span class="n">r10</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">r10</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">5</span>:   <span class="nc">cmpq</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r10</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">6</span>:   <span class="nc">jbe</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">ud2</span><span class="w"> </span><span class="n">stk_ovf</span><span class="w"> </span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">7</span>:   <span class="nc">unwind</span><span class="w"> </span><span class="n">DefineNewFrame</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">offset_upward_to_caller_sp</span>: <span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="n">offset_downward_to_clobbers</span>: <span class="mi">0</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">8</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rax</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">9</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rdi</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">10</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsi</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">11</span>:   <span class="nc">call</span><span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">namespace</span>: <span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">index</span>: <span class="mi">0</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">12</span>:   <span class="nc">jmp</span><span class="w">     </span><span class="n">label1</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="mi">1</span>:
  <span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="n">IR</span><span class="w"> </span><span class="n">block</span>: <span class="nc">block1</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="n">range</span>: <span class="mi">13</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">13</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">14</span>:   <span class="nc">popq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">15</span>:   <span class="nc">ret</span><span class="w"></span>
<span class="p">}}</span><span class="w"></span>
</code></pre></div>
<p>When wasm hits the fault at <code>"Inst 6" above due to stack overflow this is before the </code>DefineNewFrame<code> unwind pseudo-instruction, but that instruction should probably be just after "Inst 2" instead of at the end of the prologue that checks the out-of-stack condition. The current suspicion is that this probably-incorrect location of </code>DefineNewFrame<code> is why the </code>windows-2022` stack unwinding hits an infinite loop.</p>
<p>It's worth noting that one of the debugging runs on <a href="https://github.com/bytecodealliance/wasmtime/pull/3853">https://github.com/bytecodealliance/wasmtime/pull/3853</a> printed out the ip/sp of each frame on the stack and it looked like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">0</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7ff62df77637</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55af8d20</span><span class="w"></span>
<span class="mi">1</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7ff62df77637</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55af8d20</span><span class="w"></span>
<span class="mi">2</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7ff62df77527</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afabd0</span><span class="w"></span>
<span class="mi">3</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7ff62df54c33</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afac40</span><span class="w"></span>
<span class="mi">4</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7ff62df55303</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afae30</span><span class="w"></span>
<span class="mi">5</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7ff62df635a7</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afaea0</span><span class="w"></span>
<span class="mi">6</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7ff62df55238</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afaf10</span><span class="w"></span>
<span class="mi">7</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7fff1896b592</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afaf60</span><span class="w"></span>
<span class="mi">8</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7fff18922022</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afb000</span><span class="w"></span>
<span class="mi">9</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7fff18992e1e</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afb240</span><span class="w"></span>
<span class="mi">10</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1013</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afc010</span><span class="w"></span>
<span class="mi">11</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55afc020</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afc018</span><span class="w"></span>
<span class="mi">12</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afc020</span><span class="w"></span>
<span class="mi">13</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55afc030</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afc028</span><span class="w"></span>
<span class="mi">14</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afc030</span><span class="w"></span>
<span class="mi">15</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55afc040</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afc038</span><span class="w"></span>
<span class="mi">16</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afc040</span><span class="w"></span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="mi">22446</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d30</span><span class="w"></span>
<span class="mi">22447</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55b27d40</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d38</span><span class="w"></span>
<span class="mi">22448</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d40</span><span class="w"></span>
<span class="mi">22449</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55b27d50</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d48</span><span class="w"></span>
<span class="mi">22450</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d50</span><span class="w"></span>
<span class="mi">22451</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55b27d60</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d58</span><span class="w"></span>
<span class="mi">22452</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d60</span><span class="w"></span>
<span class="mi">22453</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55b27d70</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d68</span><span class="w"></span>
<span class="mi">22454</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d70</span><span class="w"></span>
<span class="mi">22455</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55b27d80</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d78</span><span class="w"></span>
<span class="mi">22456</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d80</span><span class="w"></span>
<span class="mi">22457</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55b27d90</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d88</span><span class="w"></span>
<span class="mi">22458</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d90</span><span class="w"></span>
<span class="mi">22459</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55b27da0</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d98</span><span class="w"></span>
</code></pre></div>
<p>where the <code>ip</code> is seemingly correct in that this was a mutally recursive set of functions as part of the test case and the <code>sp</code> is indeed increasing, but there seems to be no limit to <code>sp</code> increasing and apparently no reads/writes of memory are being done because presumably it would have otherwise segfaulted at this point!</p>
<p>In any case it appears that bad unwinding information is to blame here on Windows, so this issue is intended to track fixing that, and a fix for this issue should likely be accompanied with a revert of <a href="https://github.com/bytecodealliance/wasmtime/pull/3854">https://github.com/bytecodealliance/wasmtime/pull/3854</a> as well.</p>
</blockquote>



<a name="281708636"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233859%20Unwind%20info%20for%20Windows%20may%20not%20be.../near/281708636" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233859.20Unwind.20info.20for.20Windows.20may.20not.20be.2E.2E.2E.html#281708636">(May 09 2022 at 16:18)</a>:</h4>
<p>alexcrichton edited <a href="https://github.com/bytecodealliance/wasmtime/issues/3859">issue #3859</a>:</p>
<blockquote>
<p>With a debugging session last Friday about Windows-specific CI failures we ended up concluding that CI failures were tied to Github Actions' recent upgrade of the <code>windows-latest</code> image from <code>windows-2019</code> to <code>windows-2022</code>. The PR to <a href="https://github.com/bytecodealliance/wasmtime/pull/3854">temporarily pin to <code>windows-2019</code></a> has landed and CI is fixed for now but we also did some further investigation to figure out what about <code>windows-2022</code> was causing breakage.</p>
<p>With the investigation on <a href="https://github.com/bytecodealliance/wasmtime/pull/3853">https://github.com/bytecodealliance/wasmtime/pull/3853</a> the conclusion was that one of the failing tests was <code>wast::Cranelift::misc::stack_overflow</code>. Some further investigation showed that all stack overflow tests were failing. Digging further into this our first conclusion was <a href="https://github.com/bytecodealliance/wasmtime/issues/3857">https://github.com/bytecodealliance/wasmtime/issues/3857</a> which is separate from this issue, but we realized that reproducing this issue required running tests on separate threads, at least with <code>--test-threads 2</code>. </p>
<p>The previous CI failures we were seeing were out-of-memory errors on the tune of 5GiB allocations. It turns out that <code>Backtrace::new_unresolved</code> was the culprit as the stack trace was hitting an "infinite loop" where the stack wasn't actually infinite but the stack unwinder was infinitely looping over frames. We attempted to collect (<a href="https://github.com/bytecodealliance/wasmtime/issues/3858">https://github.com/bytecodealliance/wasmtime/issues/3858</a>) all these frames which resulted in OOM.</p>
<p>That's all basically a long-winded way of saying that the system-generated stack trace on <code>windows-2019</code> was correct while the stack trace on <code>windows-2022</code> was an "infinite" stack trace (despite it not actually being infinite). For a simple WebAssembly module:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">module</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>the cranelift machine IR emitted for this is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">VCode_ShowWithRRU</span><span class="w"> </span><span class="p">{{</span><span class="w"></span>
<span class="w">  </span><span class="n">Entry</span><span class="w"> </span><span class="n">block</span>: <span class="mi">0</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="mi">0</span>:
  <span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="n">IR</span><span class="w"> </span><span class="n">block</span>: <span class="nc">block0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">successor</span>: <span class="nc">Block</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="n">range</span>: <span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">13</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">0</span>:   <span class="nc">pushq</span><span class="w">   </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">1</span>:   <span class="nc">unwind</span><span class="w"> </span><span class="n">PushFrameRegs</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">offset_upward_to_caller_sp</span>: <span class="mi">16</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">2</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">3</span>:   <span class="nc">movq</span><span class="w">    </span><span class="mi">0</span><span class="p">(</span><span class="o">%</span><span class="n">rdi</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">r10</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">4</span>:   <span class="nc">movq</span><span class="w">    </span><span class="mi">0</span><span class="p">(</span><span class="o">%</span><span class="n">r10</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">r10</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">5</span>:   <span class="nc">cmpq</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r10</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">6</span>:   <span class="nc">jbe</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">ud2</span><span class="w"> </span><span class="n">stk_ovf</span><span class="w"> </span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">7</span>:   <span class="nc">unwind</span><span class="w"> </span><span class="n">DefineNewFrame</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">offset_upward_to_caller_sp</span>: <span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="n">offset_downward_to_clobbers</span>: <span class="mi">0</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">8</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rax</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">9</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rdi</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">10</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsi</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">11</span>:   <span class="nc">call</span><span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">namespace</span>: <span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">index</span>: <span class="mi">0</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">12</span>:   <span class="nc">jmp</span><span class="w">     </span><span class="n">label1</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="mi">1</span>:
  <span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="n">IR</span><span class="w"> </span><span class="n">block</span>: <span class="nc">block1</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="n">range</span>: <span class="mi">13</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">13</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">14</span>:   <span class="nc">popq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">15</span>:   <span class="nc">ret</span><span class="w"></span>
<span class="p">}}</span><span class="w"></span>
</code></pre></div>
<p>When wasm hits the fault at <code>"Inst 6"</code> above due to stack overflow this is before the <code>DefineNewFrame</code> unwind pseudo-instruction, but that instruction should probably be just after "Inst 2" instead of at the end of the prologue that checks the out-of-stack condition. The current suspicion is that this probably-incorrect location of <code>DefineNewFrame</code> is why the <code>windows-2022</code> stack unwinding hits an infinite loop.</p>
<p>It's worth noting that one of the debugging runs on <a href="https://github.com/bytecodealliance/wasmtime/pull/3853">https://github.com/bytecodealliance/wasmtime/pull/3853</a> printed out the ip/sp of each frame on the stack and it looked like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">0</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7ff62df77637</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55af8d20</span><span class="w"></span>
<span class="mi">1</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7ff62df77637</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55af8d20</span><span class="w"></span>
<span class="mi">2</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7ff62df77527</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afabd0</span><span class="w"></span>
<span class="mi">3</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7ff62df54c33</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afac40</span><span class="w"></span>
<span class="mi">4</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7ff62df55303</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afae30</span><span class="w"></span>
<span class="mi">5</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7ff62df635a7</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afaea0</span><span class="w"></span>
<span class="mi">6</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7ff62df55238</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afaf10</span><span class="w"></span>
<span class="mi">7</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7fff1896b592</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afaf60</span><span class="w"></span>
<span class="mi">8</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7fff18922022</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afb000</span><span class="w"></span>
<span class="mi">9</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7fff18992e1e</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afb240</span><span class="w"></span>
<span class="mi">10</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1013</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afc010</span><span class="w"></span>
<span class="mi">11</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55afc020</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afc018</span><span class="w"></span>
<span class="mi">12</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afc020</span><span class="w"></span>
<span class="mi">13</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55afc030</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afc028</span><span class="w"></span>
<span class="mi">14</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afc030</span><span class="w"></span>
<span class="mi">15</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55afc040</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afc038</span><span class="w"></span>
<span class="mi">16</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55afc040</span><span class="w"></span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="mi">22446</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d30</span><span class="w"></span>
<span class="mi">22447</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55b27d40</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d38</span><span class="w"></span>
<span class="mi">22448</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d40</span><span class="w"></span>
<span class="mi">22449</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55b27d50</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d48</span><span class="w"></span>
<span class="mi">22450</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d50</span><span class="w"></span>
<span class="mi">22451</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55b27d60</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d58</span><span class="w"></span>
<span class="mi">22452</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d60</span><span class="w"></span>
<span class="mi">22453</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55b27d70</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d68</span><span class="w"></span>
<span class="mi">22454</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d70</span><span class="w"></span>
<span class="mi">22455</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55b27d80</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d78</span><span class="w"></span>
<span class="mi">22456</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d80</span><span class="w"></span>
<span class="mi">22457</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55b27d90</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d88</span><span class="w"></span>
<span class="mi">22458</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x1d76a8f1023</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d90</span><span class="w"></span>
<span class="mi">22459</span>: <span class="nc">ip</span><span class="o">=</span><span class="mh">0x7c55b27da0</span><span class="w"> </span><span class="n">sp</span><span class="o">=</span><span class="mh">0x7c55b27d98</span><span class="w"></span>
</code></pre></div>
<p>where the <code>ip</code> is seemingly correct in that this was a mutally recursive set of functions as part of the test case and the <code>sp</code> is indeed increasing, but there seems to be no limit to <code>sp</code> increasing and apparently no reads/writes of memory are being done because presumably it would have otherwise segfaulted at this point!</p>
<p>In any case it appears that bad unwinding information is to blame here on Windows, so this issue is intended to track fixing that, and a fix for this issue should likely be accompanied with a revert of <a href="https://github.com/bytecodealliance/wasmtime/pull/3854">https://github.com/bytecodealliance/wasmtime/pull/3854</a> as well.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>