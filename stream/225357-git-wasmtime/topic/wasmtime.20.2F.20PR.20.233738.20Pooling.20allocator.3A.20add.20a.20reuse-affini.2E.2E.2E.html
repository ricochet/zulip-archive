<html>
<head><meta charset="utf-8"><title>wasmtime / PR #3738 Pooling allocator: add a reuse-affini... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html">wasmtime / PR #3738 Pooling allocator: add a reuse-affini...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="269699326"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/269699326" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#269699326">(Jan 28 2022 at 08:04)</a>:</h4>
<p>cfallin opened <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a> from <code>pooling-affinity</code> to <code>main</code>:</p>
<blockquote>
<p>(Builds on #3697.)</p>
<p>This policy attempts to reuse the same instance slot for subsequent                                                                                                                           <br>
instantiations of the same module. This is particularly useful when                                                                                                                           <br>
using a pooling backend such as memfd that benefits from this reuse: for                                                                                                                      <br>
example, in the memfd case, instantiating the same module into the same                                                                                                                       <br>
slot allows us to avoid several calls to mmap() because the same                                                                                                                              <br>
mappings can be reused.                                                                                                                                                                       </p>
<p>The policy tracks a freelist per "compiled module ID", and when                                                                                                                               <br>
allocating a slot for an instance, tries these three options in order:                                                                                                                        </p>
<ol>
<li>
<p>A slot from the freelist for this module (i.e., last used for another                                                                                                                      <br>
   instantiation of this particular module);                                                                                                                                                  </p>
</li>
<li>
<p>A slot that has never been used before; or                                                                                                                                                 </p>
</li>
<li>A slot that was last used by some other module.                                                                                                                                            </li>
</ol>
<p>The "victim" module for choice 3 is randomly chosen, to avoid biases due                                                                                                                      <br>
to the hashmap's ordering (which would be persistent across the lifetime                                                                                                                      <br>
of the pooling allocator).                                                                                                                                                                    </p>
<p>This policy is now the default when the memfd backend is selected via                                                                                                                         <br>
the <code>memfd-allocator</code> feature flag.     </p>
</blockquote>



<a name="269699327"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/269699327" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#269699327">(Jan 28 2022 at 08:04)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a>.</p>



<a name="269803797"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/269803797" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#269803797">(Jan 28 2022 at 21:17)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#pullrequestreview-866714870">PR review</a>.</p>



<a name="269803798"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/269803798" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#269803798">(Jan 28 2022 at 21:17)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#pullrequestreview-866714870">PR review</a>.</p>



<a name="269803799"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/269803799" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#269803799">(Jan 28 2022 at 21:17)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r794893304">PR review comment</a>:</p>
<blockquote>
<p>Why not change <code>CompiledModuleId</code> to be a newtype around <code>NonZeroU64</code> and then we can use plain <code>Option</code> and <code>None</code> without pessimizing size, instead of having our own custom sentinel that we can forget to check for?</p>
</blockquote>



<a name="269803800"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/269803800" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#269803800">(Jan 28 2022 at 21:17)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r794895029">PR review comment</a>:</p>
<blockquote>
<p>Also, this is an existing issue (introduced in the memfd PR?) that is maybe going to become worse with these changes, but we use a relaxed ordering in the <code>fetch_add</code> when allocating new <code>CompiledModuleId</code>s below -- it seems like this could be a problem on non-x86?</p>
</blockquote>



<a name="269806510"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/269806510" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#269806510">(Jan 28 2022 at 21:40)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r794906569">PR review comment</a>:</p>
<blockquote>
<p>Re: relaxed ordering, that's fine -- all that means is that the atomic ID-allocation event is not synchronized with respect to any other loads/stores in the system (there are no fences). But the fetch-add itself is still an atomic action, with some linear ordering amongst the other accesses to the "next ID" atomic. That's sufficient for the invariants we need: we just need unique IDs for each module, we don't care what they are.</p>
<p>(Good idea wrt <code>NonZeroU64</code>; I'll make that change!)</p>
</blockquote>



<a name="269806511"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/269806511" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#269806511">(Jan 28 2022 at 21:40)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#pullrequestreview-866733546">PR review</a>.</p>



<a name="269806744"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/269806744" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#269806744">(Jan 28 2022 at 21:42)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#pullrequestreview-866735135">PR review</a>.</p>



<a name="269806745"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/269806745" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#269806745">(Jan 28 2022 at 21:42)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r794907745">PR review comment</a>:</p>
<blockquote>
<p>Ah yes, I didn't think about how the <code>fetch_add</code> itself was still atomic. Thanks!</p>
</blockquote>



<a name="269809865"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/269809865" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#269809865">(Jan 28 2022 at 22:10)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a> from <code>pooling-affinity</code> to <code>main</code>.</p>



<a name="269821671"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/269821671" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#269821671">(Jan 29 2022 at 00:08)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a> from <code>pooling-affinity</code> to <code>main</code>.</p>



<a name="269822291"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/269822291" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#269822291">(Jan 29 2022 at 00:15)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a> from <code>pooling-affinity</code> to <code>main</code>.</p>



<a name="269827490"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/269827490" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#269827490">(Jan 29 2022 at 01:24)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a> from <code>pooling-affinity</code> to <code>main</code>.</p>



<a name="269827532"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/269827532" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#269827532">(Jan 29 2022 at 01:25)</a>:</h4>
<p>cfallin edited <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a> from <code>pooling-affinity</code> to <code>main</code>:</p>
<blockquote>
<p>(Builds on #3697.)</p>
<p>This policy attempts to reuse the same instance slot for subsequent<br>
instantiations of the same module. This is particularly useful when<br>
using a pooling backend such as memfd that benefits from this reuse: for<br>
example, in the memfd case, instantiating the same module into the same<br>
slot allows us to avoid several calls to mmap() because the same<br>
mappings can be reused.</p>
<p>The policy tracks a freelist per "compiled module ID", and when<br>
allocating a slot for an instance, tries these three options in order:</p>
<ol>
<li>
<p>A slot from the freelist for this module (i.e., last used for another<br>
   instantiation of this particular module), or</p>
</li>
<li>
<p>A slot that was last used by some other module or never before.</p>
</li>
</ol>
<p>The "victim" slot for choice 2 is randomly chosen.</p>
<p>The data structures are carefully designed so that all updates are O(1),<br>
and there is no retry-loop in any of the random selection.</p>
<p>This policy is now the default when the memfd backend is selected via<br>
the <code>memfd-allocator</code> feature flag.<br>
</p>
</blockquote>



<a name="269827788"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/269827788" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#269827788">(Jan 29 2022 at 01:29)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a> from <code>pooling-affinity</code> to <code>main</code>.</p>



<a name="269828375"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/269828375" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#269828375">(Jan 29 2022 at 01:38)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a> from <code>pooling-affinity</code> to <code>main</code>.</p>



<a name="269830008"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/269830008" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#269830008">(Jan 29 2022 at 02:07)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a> from <code>pooling-affinity</code> to <code>main</code>.</p>



<a name="269834299"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/269834299" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#269834299">(Jan 29 2022 at 03:27)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a> from <code>pooling-affinity</code> to <code>main</code>.</p>



<a name="270071889"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270071889" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270071889">(Jan 31 2022 at 17:37)</a>:</h4>
<p>cfallin edited <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a> from <code>pooling-affinity</code> to <code>main</code>:</p>
<blockquote>
<p>(Builds on #3697.)</p>
<p>This policy attempts to reuse the same instance slot for subsequent<br>
instantiations of the same module. This is particularly useful when<br>
using a pooling backend such as memfd that benefits from this reuse: for<br>
example, in the memfd case, instantiating the same module into the same<br>
slot allows us to avoid several calls to mmap() because the same<br>
mappings can be reused.</p>
<p>The policy tracks a freelist per "compiled module ID", and when<br>
allocating a slot for an instance, tries these two options in order:</p>
<ol>
<li>
<p>A slot from the freelist for this module (i.e., last used for another<br>
   instantiation of this particular module), or</p>
</li>
<li>
<p>A slot that was last used by some other module or never before.</p>
</li>
</ol>
<p>The "victim" slot for choice 2 is randomly chosen.</p>
<p>The data structures are carefully designed so that all updates are O(1),<br>
and there is no retry-loop in any of the random selection.</p>
<p>This policy is now the default when the memfd backend is selected via<br>
the <code>memfd-allocator</code> feature flag.<br>
</p>
</blockquote>



<a name="270072587"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270072587" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270072587">(Jan 31 2022 at 17:41)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a> from <code>pooling-affinity</code> to <code>main</code>.</p>



<a name="270075065"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270075065" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270075065">(Jan 31 2022 at 17:56)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#pullrequestreview-868165370">PR review</a>.</p>



<a name="270075067"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270075067" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270075067">(Jan 31 2022 at 17:56)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#pullrequestreview-868165370">PR review</a>.</p>



<a name="270075068"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270075068" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270075068">(Jan 31 2022 at 17:56)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r795888181">PR review comment</a>:</p>
<blockquote>
<p>This is <em>all</em> slot indices that are free, right? That is, an invariant of this code is that every free slot index is always in this list, right?</p>
<p>If my understanding is correct, then I think it makes sense to clarify this comment as such.</p>
</blockquote>



<a name="270075069"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270075069" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270075069">(Jan 31 2022 at 17:56)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r795897665">PR review comment</a>:</p>
<blockquote>
<p>All of the methods on <code>SlotState</code> panic if the <code>SlotState</code> is <code>Taken</code>. What do you think of refactoring <code>SlotState</code> to look like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">enum</span> <span class="nc">SlotState</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Taken</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Free</span><span class="p">(</span><span class="n">FreeSlotState</span><span class="p">),</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">SlotState</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Do the expected matching where `Taken` returns `None` here...</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">as_free_slot</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="n">FreeSlotState</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">as_free_slot_mut</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">FreeSlotState</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">enum</span> <span class="nc">FreeSlotState</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Empty</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="n">Affinity</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">FreeSlotState</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// all the methods above, which don't need to have panicking paths anymore</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>This way we can consolidate all the is-this-a-taken-slot checking into a single <code>slot_state[i].as_free_slot().expect("blah blah blah")</code> call, our types give us guarantees about their data, and potential panics aren't hidden behind method calls.</p>
</blockquote>



<a name="270075070"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270075070" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270075070">(Jan 31 2022 at 17:56)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r795905658">PR review comment</a>:</p>
<blockquote>
<p>Is the idea that as <code>Module</code>s get dropped, we don't need to actively empty the <code>per_module</code> free lists, because they will eventually get stolen by other instance allocations, and once the dropped module's free list is empty, it is removed from the <code>per_module</code> free lists? I think this would be good to test somehow, since it seems like an easy memory leak if we mess this up. Also, it seems like it would be good to document in a comment somewhere.</p>
</blockquote>



<a name="270075071"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270075071" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270075071">(Jan 31 2022 at 17:56)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r795903689">PR review comment</a>:</p>
<blockquote>
<p>Maybe</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="fm">debug_assert!</span><span class="p">(</span><span class="n">per_module</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="p">));</span><span class="w"></span>
<span class="fm">debug_assert!</span><span class="p">(</span><span class="o">!</span><span class="n">per_module</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="p">).</span><span class="n">is_empty</span><span class="p">());</span><span class="w"></span>
</code></pre></div>
<p>at the start of this function?</p>
</blockquote>



<a name="270075073"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270075073" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270075073">(Jan 31 2022 at 17:56)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r795908537">PR review comment</a>:</p>
<blockquote>
<p>Nitpick: maybe name this <code>remove_global_free_list_item</code> to clarify the difference between this and <code>remove_module_free_list_item</code>?</p>
<p>Ditto about freeling like a free function.</p>
</blockquote>



<a name="270075075"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270075075" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270075075">(Jan 31 2022 at 17:56)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r795901428">PR review comment</a>:</p>
<blockquote>
<p>Nitpick: sort of feels like this should be a free function.</p>
</blockquote>



<a name="270075076"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270075076" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270075076">(Jan 31 2022 at 17:56)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r795918667">PR review comment</a>:</p>
<blockquote>
<p>This is a very helpful comment, thanks for writing this!</p>
</blockquote>



<a name="270075077"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270075077" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270075077">(Jan 31 2022 at 17:56)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r795920315">PR review comment</a>:</p>
<blockquote>
<p>I think the <code>id</code> is unnecessary here, and we can recover this from the <code>slot_state[index]</code>, if it exists? If so, removing <code>id</code> would help move us towards a single source of truth with fewer things that can get misaligned and out of sync, and would allow us to clean up slots that have a module affinity even when callers forgot to pass a module id here.</p>
</blockquote>



<a name="270075078"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270075078" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270075078">(Jan 31 2022 at 17:56)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r795916660">PR review comment</a>:</p>
<blockquote>
<p>It would be nice to have a newtype for slot indices (<code>SlotId</code>?) too.</p>
<p><code>new_id</code> threw me for a little bit of a loop, and made me double check that this wasn't a <code>CompiledModuleId</code> and was actually a slot index, which is what I expected it to be, but just the naming made me doubt myself enough that I had to double check.</p>
</blockquote>



<a name="270075079"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270075079" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270075079">(Jan 31 2022 at 17:56)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r795921319">PR review comment</a>:</p>
<blockquote>
<p>Nitpick: we know we are going to insert into this new vec so we can do <code>.or_insert_with(|| Vec::with_capacity(1))</code> here.</p>
</blockquote>



<a name="270075080"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270075080" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270075080">(Jan 31 2022 at 17:56)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r795923029">PR review comment</a>:</p>
<blockquote>
<p>Yeah so calling <code>free</code> without an <code>id</code> will create new <code>SlotState::Empty</code>s which goes against that steady-state comment above (ignoring a global analysis of all <code>free</code> callers). So yeah I think removing the <code>id</code> param would be nice if we can, since it also helps make it easier to verify statements about the correctness of this system.</p>
</blockquote>



<a name="270075081"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270075081" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270075081">(Jan 31 2022 at 17:56)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r795899340">PR review comment</a>:</p>
<blockquote>
<p>Could also have <code>SlotState::unwrap_free_slot[_mut]</code> methods to avoid the <code>exepect</code> at every call site, but still have the potential panics "visible" to callers.</p>
</blockquote>



<a name="270075082"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270075082" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270075082">(Jan 31 2022 at 17:56)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r795917079">PR review comment</a>:</p>
<blockquote>
<p>and/or we could <code>s/new_id/slot_index/</code> here</p>
</blockquote>



<a name="270112715"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270112715" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270112715">(Jan 31 2022 at 22:03)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a> from <code>pooling-affinity</code> to <code>main</code>.</p>



<a name="270118297"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270118297" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270118297">(Jan 31 2022 at 22:39)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a> from <code>pooling-affinity</code> to <code>main</code>.</p>



<a name="270118310"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270118310" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270118310">(Jan 31 2022 at 22:39)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#pullrequestreview-868498946">PR review</a>.</p>



<a name="270118311"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270118311" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270118311">(Jan 31 2022 at 22:40)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r796123117">PR review comment</a>:</p>
<blockquote>
<p>Yep, clarified, thanks!</p>
</blockquote>



<a name="270118429"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270118429" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270118429">(Jan 31 2022 at 22:40)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#pullrequestreview-868499497">PR review</a>.</p>



<a name="270118430"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270118430" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270118430">(Jan 31 2022 at 22:40)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r796123562">PR review comment</a>:</p>
<blockquote>
<p>Sure, I refactored along these lines (and took the route of panic'ing in the as_free accessors). Good idea, thanks!</p>
</blockquote>



<a name="270118441"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270118441" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270118441">(Jan 31 2022 at 22:40)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#pullrequestreview-868499593">PR review</a>.</p>



<a name="270118442"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270118442" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270118442">(Jan 31 2022 at 22:40)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r796123636">PR review comment</a>:</p>
<blockquote>
<p>Yep, exactly; a slot's affinity remains until the slot is overwritten (reused for a different module). Extended the doc-comment, and added some testing for the keys of this hashmap (and that its values are non-empty lists) as well.</p>
</blockquote>



<a name="270118472"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270118472" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270118472">(Jan 31 2022 at 22:41)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#pullrequestreview-868499759">PR review</a>.</p>



<a name="270118473"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270118473" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270118473">(Jan 31 2022 at 22:41)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r796123752">PR review comment</a>:</p>
<blockquote>
<p>Yup, done on both.</p>
</blockquote>



<a name="270118510"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270118510" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270118510">(Jan 31 2022 at 22:41)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#pullrequestreview-868500123">PR review</a>.</p>



<a name="270118511"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270118511" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270118511">(Jan 31 2022 at 22:41)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r796124034">PR review comment</a>:</p>
<blockquote>
<p>I newtyped All The Things (<code>SlotId</code>, <code>GlobalFreeListIndex</code>, <code>PerModuleFreeListIndex</code>); hopefully this is better!</p>
</blockquote>



<a name="270118524"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270118524" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270118524">(Jan 31 2022 at 22:41)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#pullrequestreview-868500239">PR review</a>.</p>



<a name="270118525"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270118525" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270118525">(Jan 31 2022 at 22:41)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r796124119">PR review comment</a>:</p>
<blockquote>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
</blockquote>



<a name="270118590"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270118590" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270118590">(Jan 31 2022 at 22:42)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#pullrequestreview-868500454">PR review</a>.</p>



<a name="270118594"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270118594" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270118594">(Jan 31 2022 at 22:42)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r796124285">PR review comment</a>:</p>
<blockquote>
<p>Yes, that's a good point; made it a field of the <code>Taken</code> state now, to remember it for the free.</p>
</blockquote>



<a name="270118606"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270118606" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270118606">(Jan 31 2022 at 22:42)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#pullrequestreview-868500542">PR review</a>.</p>



<a name="270118607"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270118607" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270118607">(Jan 31 2022 at 22:42)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r796124360">PR review comment</a>:</p>
<blockquote>
<p>Good point!</p>
</blockquote>



<a name="270118720"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270118720" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270118720">(Jan 31 2022 at 22:43)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#pullrequestreview-868501370">PR review</a>.</p>



<a name="270118722"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270118722" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270118722">(Jan 31 2022 at 22:43)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r796124966">PR review comment</a>:</p>
<blockquote>
<p>Indeed. The intent was to be a little more general (one could in theory choose <em>not</em> to retain the state that makes a slot have affinity) but as you say that complexifies things a bit and we should probably approach that as we need it. (And it need not necessarily touch the affinity state either; there's little harm in a stray affinity for a module that will never exist again.)</p>
</blockquote>



<a name="270118736"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270118736" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270118736">(Jan 31 2022 at 22:43)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#pullrequestreview-868501443">PR review</a>.</p>



<a name="270118737"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270118737" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270118737">(Jan 31 2022 at 22:43)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r796125020">PR review comment</a>:</p>
<blockquote>
<p>The first is covered by the <code>get_mut()</code> at the top; I added a <code>.expect()</code> rather than <code>.unwrap()</code> to make any failure clearer though. Added the second.</p>
</blockquote>



<a name="270118745"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270118745" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270118745">(Jan 31 2022 at 22:43)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#pullrequestreview-868501525">PR review</a>.</p>



<a name="270118747"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270118747" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270118747">(Jan 31 2022 at 22:43)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r796125076">PR review comment</a>:</p>
<blockquote>
<p>Done!</p>
</blockquote>



<a name="270119356"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270119356" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270119356">(Jan 31 2022 at 22:48)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#pullrequestreview-868505055">PR review</a>.</p>



<a name="270119357"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270119357" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270119357">(Jan 31 2022 at 22:48)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r796127760">PR review comment</a>:</p>
<blockquote>
<blockquote>
<p>The first is covered by the <code>get_mut()</code> at the top</p>
</blockquote>
<p>FWIW, I don't mind having "redundant" assertions because, in some sense, debug assertions are <em>always</em> redundant, since we are checking things that we believe should always be true.</p>
</blockquote>



<a name="270120574"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270120574" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270120574">(Jan 31 2022 at 22:58)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a> from <code>pooling-affinity</code> to <code>main</code>.</p>



<a name="270121102"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270121102" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270121102">(Jan 31 2022 at 23:01)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#pullrequestreview-868513731">PR review</a>.</p>



<a name="270121103"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270121103" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270121103">(Jan 31 2022 at 23:01)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#pullrequestreview-868513731">PR review</a>.</p>



<a name="270121104"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270121104" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270121104">(Jan 31 2022 at 23:01)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r796134276">PR review comment</a>:</p>
<blockquote>
<p>I'd personally add <code>unwrap_</code> as a prefix to these match-on-a-variant-and-return-the-inner-bits-or-else-panic methods. Typically a plain <code>as_blah</code> would return an <code>Option&lt;&amp;T&gt;</code> if it is possibly not a <code>T</code>, rather than panicking.</p>
</blockquote>



<a name="270122438"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270122438" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270122438">(Jan 31 2022 at 23:11)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a> from <code>pooling-affinity</code> to <code>main</code>.</p>



<a name="270122450"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270122450" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270122450">(Jan 31 2022 at 23:11)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#pullrequestreview-868520425">PR review</a>.</p>



<a name="270122451"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270122451" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270122451">(Jan 31 2022 at 23:11)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3738#discussion_r796139113">PR review comment</a>:</p>
<blockquote>
<p>Done!</p>
</blockquote>



<a name="270135203"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270135203" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270135203">(Feb 01 2022 at 01:12)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a> from <code>pooling-affinity</code> to <code>main</code>.</p>



<a name="270135334"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270135334" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270135334">(Feb 01 2022 at 01:13)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a> from <code>pooling-affinity</code> to <code>main</code>.</p>



<a name="270155834"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270155834" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270155834">(Feb 01 2022 at 05:33)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a> from <code>pooling-affinity</code> to <code>main</code>.</p>



<a name="270158235"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270158235" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270158235">(Feb 01 2022 at 06:13)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a> from <code>pooling-affinity</code> to <code>main</code>.</p>



<a name="270159963"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270159963" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270159963">(Feb 01 2022 at 06:39)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a> from <code>pooling-affinity</code> to <code>main</code>.</p>



<a name="270309768"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270309768" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270309768">(Feb 01 2022 at 23:57)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a> from <code>pooling-affinity</code> to <code>main</code>.</p>



<a name="270313885"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270313885" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270313885">(Feb 02 2022 at 00:37)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a> from <code>pooling-affinity</code> to <code>main</code>.</p>



<a name="270431124"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270431124" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270431124">(Feb 02 2022 at 18:04)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a> from <code>pooling-affinity</code> to <code>main</code>.</p>



<a name="270443609"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270443609" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270443609">(Feb 02 2022 at 19:29)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a> from <code>pooling-affinity</code> to <code>main</code>.</p>



<a name="270444630"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270444630" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270444630">(Feb 02 2022 at 19:35)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a> from <code>pooling-affinity</code> to <code>main</code>.</p>



<a name="270445863"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270445863" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270445863">(Feb 02 2022 at 19:43)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a> from <code>pooling-affinity</code> to <code>main</code>.</p>



<a name="270451804"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270451804" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270451804">(Feb 02 2022 at 20:25)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a> from <code>pooling-affinity</code> to <code>main</code>.</p>



<a name="270458245"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233738%20Pooling%20allocator%3A%20add%20a%20reuse-affini.../near/270458245" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233738.20Pooling.20allocator.3A.20add.20a.20reuse-affini.2E.2E.2E.html#270458245">(Feb 02 2022 at 21:11)</a>:</h4>
<p>cfallin merged <a href="https://github.com/bytecodealliance/wasmtime/pull/3738">PR #3738</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>