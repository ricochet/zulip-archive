<html>
<head><meta charset="utf-8"><title>wasmtime / issue #5229 wiggle: adapt Wiggle guest slices ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235229.20wiggle.3A.20adapt.20Wiggle.20guest.20slices.20.2E.2E.2E.html">wasmtime / issue #5229 wiggle: adapt Wiggle guest slices ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="308678601"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235229%20wiggle%3A%20adapt%20Wiggle%20guest%20slices%20.../near/308678601" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235229.20wiggle.3A.20adapt.20Wiggle.20guest.20slices.20.2E.2E.2E.html#308678601">(Nov 08 2022 at 21:41)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/5229#issuecomment-1307865953">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5229">issue #5229</a>:</p>
<blockquote>
<p>Would it make sense to have a method that returns <code>&amp;UnsafeCell&lt;[T]&gt;</code> or <code>&amp;Cell&lt;[T]&gt;</code>?</p>
</blockquote>



<a name="308689242"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235229%20wiggle%3A%20adapt%20Wiggle%20guest%20slices%20.../near/308689242" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235229.20wiggle.3A.20adapt.20Wiggle.20guest.20slices.20.2E.2E.2E.html#308689242">(Nov 08 2022 at 23:03)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/5229#issuecomment-1307953582">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5229">issue #5229</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @kubkon</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "wasi"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>kubkon: wasi</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="308690247"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235229%20wiggle%3A%20adapt%20Wiggle%20guest%20slices%20.../near/308690247" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235229.20wiggle.3A.20adapt.20Wiggle.20guest.20slices.20.2E.2E.2E.html#308690247">(Nov 08 2022 at 23:12)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/pull/5229#issuecomment-1307962509">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5229">issue #5229</a>:</p>
<blockquote>
<blockquote>
<p>Would it make sense to have a method that returns <code>&amp;UnsafeCell&lt;[T]&gt;</code> or <code>&amp;Cell&lt;[T]&gt;</code>?</p>
</blockquote>
<p>I'm open to it; not sure if all of the functions exposed are necessary, though. Let's see what @alexcrichton and @pchickey think?</p>
</blockquote>



<a name="308826258"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235229%20wiggle%3A%20adapt%20Wiggle%20guest%20slices%20.../near/308826258" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235229.20wiggle.3A.20adapt.20Wiggle.20guest.20slices.20.2E.2E.2E.html#308826258">(Nov 09 2022 at 16:42)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/pull/5229#issuecomment-1309037216">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5229">issue #5229</a>:</p>
<blockquote>
<blockquote>
<p>Otherwise I think it should be able to implement:</p>
<p><code>rust
impl&lt;T&gt; Deref for UnsafeGuestSlice&lt;'_, T&gt; {
    type Target = [UnsafeCell&lt;T&gt;];
    // ...
}
</code></p>
<p>which could actually be relatively convenient to work with.</p>
</blockquote>
<p>Thinking about this more, I don't think accessing <code>T</code> through an <code>UnsafeCell</code> is right: <code>UnsafeCell::get_mut</code> would give us a <code>&amp;mut T</code> and the documentation of that method claims that "this call borrows the <code>UnsafeCell</code> mutably (at compile-time) which guarantees that we possess the only reference," which is incorrect. It's incorrect because <code>UnsafeGuestSlice</code> is pointing to shared memory which could be modified at any time by any WASI thread, outside of the Rust borrowing world. @alexcrichton, what do you think?</p>
</blockquote>



<a name="308829445"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235229%20wiggle%3A%20adapt%20Wiggle%20guest%20slices%20.../near/308829445" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235229.20wiggle.3A.20adapt.20Wiggle.20guest.20slices.20.2E.2E.2E.html#308829445">(Nov 09 2022 at 16:57)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/5229#issuecomment-1309057250">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5229">issue #5229</a>:</p>
<blockquote>
<p>The <code>get_mut</code> method requires <code>&amp;mut self</code> so we won't have to worry about that here since we'll never hand out <code>&amp;mut UnsafeCell&lt;T&gt;</code>. By more-or-less handing out <code>&amp;[UnsafeCell&lt;T&gt;]</code> we're basically saying "here's a 100% valid region of memory in terms of in-bounds, you have access to it, and it's all aligned correctly and whatnot -- but the contents of memory are ruled by other mechanisms"</p>
<p>The only way to interact with the contents of <code>&amp;UnsafeCell&lt;T&gt;</code> is to have <code>unsafe</code>, which is the goal here, so I think it'll work out well. For unshared cases the wrapper methods to go to safe slices will work, and for shared cases it's clear that atomics/raw intrinsics/etc need to get used (and is something we'll document).</p>
</blockquote>



<a name="308843462"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235229%20wiggle%3A%20adapt%20Wiggle%20guest%20slices%20.../near/308843462" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235229.20wiggle.3A.20adapt.20Wiggle.20guest.20slices.20.2E.2E.2E.html#308843462">(Nov 09 2022 at 18:15)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/pull/5229#issuecomment-1309177517">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5229">issue #5229</a>:</p>
<blockquote>
<blockquote>
<p>The <code>get_mut</code> method requires <code>&amp;mut self</code></p>
</blockquote>
<p>Ah, yeah, I see what you mean; this makes more sense. I'm not sure how/when this would be used, though; I guess this would be yet another way to modify a slice besides the <code>unsafe</code> <code>UnsafeGuestSlice::get_mut</code>? (I guess we could also expose an <code>unsafe</code> <code>`UnsafeGuestSlice::get</code> which would return a <code>&amp;[T]</code>). If this isn't going to be used just yet, should we  implement this in this PR or wait until it is needed?</p>
</blockquote>



<a name="308843495"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235229%20wiggle%3A%20adapt%20Wiggle%20guest%20slices%20.../near/308843495" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235229.20wiggle.3A.20adapt.20Wiggle.20guest.20slices.20.2E.2E.2E.html#308843495">(Nov 09 2022 at 18:15)</a>:</h4>
<p>abrown edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/5229#issuecomment-1309177517">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5229">issue #5229</a>:</p>
<blockquote>
<blockquote>
<p>The <code>get_mut</code> method requires <code>&amp;mut self</code></p>
</blockquote>
<p>Ah, yeah, I see what you mean; this makes more sense. I'm not sure how/when this would be used, though; I guess this would be yet another way to modify a slice besides the <code>unsafe</code> <code>UnsafeGuestSlice::get_mut</code>? (I guess we could also expose an <code>unsafe</code> <code>UnsafeGuestSlice::get</code> which would return a <code>&amp;[T]</code>). If this isn't going to be used just yet, should we  implement this in this PR or wait until it is needed?</p>
</blockquote>



<a name="308843566"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235229%20wiggle%3A%20adapt%20Wiggle%20guest%20slices%20.../near/308843566" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235229.20wiggle.3A.20adapt.20Wiggle.20guest.20slices.20.2E.2E.2E.html#308843566">(Nov 09 2022 at 18:16)</a>:</h4>
<p>abrown edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/5229#issuecomment-1309177517">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5229">issue #5229</a>:</p>
<blockquote>
<blockquote>
<p>The <code>get_mut</code> method requires <code>&amp;mut self</code></p>
</blockquote>
<p>Ah, yeah, I see what you mean; this makes more sense. I'm not sure how/when this would be used, though; I guess this would be yet another way to modify a slice besides the <code>unsafe</code> <code>UnsafeGuestSlice::get_mut</code>? (I guess for completeness we could also expose an <code>unsafe</code> <code>UnsafeGuestSlice::get</code> which would return a <code>&amp;[T]</code>). If this isn't going to be used just yet, should we  implement this in this PR or wait until it is needed?</p>
</blockquote>



<a name="308853667"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235229%20wiggle%3A%20adapt%20Wiggle%20guest%20slices%20.../near/308853667" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235229.20wiggle.3A.20adapt.20Wiggle.20guest.20slices.20.2E.2E.2E.html#308853667">(Nov 09 2022 at 19:09)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/5229#issuecomment-1309235290">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5229">issue #5229</a>:</p>
<blockquote>
<p>Oh I don't think the <code>Deref</code> impl is really all that important to have, it's just a "might as well" sort of thing. I think though having an interim <code>UnsafeGuestSlice</code> get constructed on the way to a <code>GuestSlice{,Mut}</code> will exercise it and make it useful. Only for niche cases will <code>UnsafeGuestSlice</code> be useful. Note though we could have <code>UnsafeGuestSlice::copy_from_slice</code> as a safe method which only fails due to active borrows.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>