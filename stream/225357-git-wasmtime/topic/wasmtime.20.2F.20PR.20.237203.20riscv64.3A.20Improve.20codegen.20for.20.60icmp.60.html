<html>
<head><meta charset="utf-8"><title>wasmtime / PR #7203 riscv64: Improve codegen for `icmp` · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237203.20riscv64.3A.20Improve.20codegen.20for.20.60icmp.60.html">wasmtime / PR #7203 riscv64: Improve codegen for `icmp`</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="395852084"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237203%20riscv64%3A%20Improve%20codegen%20for%20%60icmp%60/near/395852084" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237203.20riscv64.3A.20Improve.20codegen.20for.20.60icmp.60.html#395852084">(Oct 10 2023 at 10:26)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/afonso360">afonso360</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7203">PR #7203</a>.</p>



<a name="395852085"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237203%20riscv64%3A%20Improve%20codegen%20for%20%60icmp%60/near/395852085" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237203.20riscv64.3A.20Improve.20codegen.20for.20.60icmp.60.html#395852085">(Oct 10 2023 at 10:26)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/7203">PR #7203</a> from <code>alexcrichton:rv64-icmp</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This PR is another stab towards improving <code>icmp</code> along the lines of <a href="https://github.com/bytecodealliance/wasmtime/pull/6112">https://github.com/bytecodealliance/wasmtime/pull/6112</a> and <a href="https://github.com/bytecodealliance/wasmtime/pull/7113">https://github.com/bytecodealliance/wasmtime/pull/7113</a>. This tries to draw on both of those PRs a bit to end up with something that's usable by the majority of the backend for use with branches.</p>
<p>I've attempted to break things up piecemeal here so the commits in theory are understandable commit-by-commit. This additionally doesn't implement every single optimization I could think of, mostly just a few that seemed to be the low-hanging fruit ones.</p>
</blockquote>



<a name="395852087"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237203%20riscv64%3A%20Improve%20codegen%20for%20%60icmp%60/near/395852087" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237203.20riscv64.3A.20Improve.20codegen.20for.20.60icmp.60.html#395852087">(Oct 10 2023 at 10:26)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7203">PR #7203</a>.</p>



<a name="395852088"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237203%20riscv64%3A%20Improve%20codegen%20for%20%60icmp%60/near/395852088" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237203.20riscv64.3A.20Improve.20codegen.20for.20.60icmp.60.html#395852088">(Oct 10 2023 at 10:26)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7203">PR #7203</a>.</p>



<a name="395865609"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237203%20riscv64%3A%20Improve%20codegen%20for%20%60icmp%60/near/395865609" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237203.20riscv64.3A.20Improve.20codegen.20for.20.60icmp.60.html#395865609">(Oct 10 2023 at 11:51)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7203">PR #7203</a>.</p>



<a name="395906418"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237203%20riscv64%3A%20Improve%20codegen%20for%20%60icmp%60/near/395906418" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237203.20riscv64.3A.20Improve.20codegen.20for.20.60icmp.60.html#395906418">(Oct 10 2023 at 15:17)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7203#pullrequestreview-1667763202">PR review</a>:</p>
<blockquote>
<p>This is very nice! Thank you! Having the commits separated neatly really helped review this.</p>
<p>It all looks correct to me. But I'm not entirely sure I didn't miss anything, so a second pair of eyes would be helpful!</p>
<p>I'm also going to run the fuzzer on this for a few days to check if anything comes up. (Although I don't think that should prevent merging this)</p>
</blockquote>



<a name="395906419"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237203%20riscv64%3A%20Improve%20codegen%20for%20%60icmp%60/near/395906419" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237203.20riscv64.3A.20Improve.20codegen.20for.20.60icmp.60.html#395906419">(Oct 10 2023 at 15:17)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7203#pullrequestreview-1667763202">PR review</a>:</p>
<blockquote>
<p>This is very nice! Thank you! Having the commits separated neatly really helped review this.</p>
<p>It all looks correct to me. But I'm not entirely sure I didn't miss anything, so a second pair of eyes would be helpful!</p>
<p>I'm also going to run the fuzzer on this for a few days to check if anything comes up. (Although I don't think that should prevent merging this)</p>
</blockquote>



<a name="395906421"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237203%20riscv64%3A%20Improve%20codegen%20for%20%60icmp%60/near/395906421" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237203.20riscv64.3A.20Improve.20codegen.20for.20.60icmp.60.html#395906421">(Oct 10 2023 at 15:17)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/7203#discussion_r1352552789">PR review comment</a>:</p>
<blockquote>
<p>I don't think this is entirely correct, but it probably doesn't matter. </p>
<p>Due to #6922 we don't generate all 32bit constants from <code>lui+addi</code> so there are some that fallback to the general load from const pool path.</p>
<p>That path uses the <code>ld</code> instruction to load the full 8 bytes, but we never sign extend that value while lowering (<em>I think</em>). So there is a chance that in some of the 32bit constants that we miss we may not sign extend them.</p>
<p>I've built a small test to check which constants fail to generate, and the lowest one is <code>0x7FFF_F801</code> so all the negatives are covered. So I don't think there's anything wrong here.</p>
<p>It might be worth ensuring that the value is sign extended before emitting it to the constant pool anyway. Or switching to <code>lw</code> that only loads 4 bytes and sign extends the load result. Just to make sure that this doesn't happen in the future.</p>
</blockquote>



<a name="395906503"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237203%20riscv64%3A%20Improve%20codegen%20for%20%60icmp%60/near/395906503" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237203.20riscv64.3A.20Improve.20codegen.20for.20.60icmp.60.html#395906503">(Oct 10 2023 at 15:18)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7203#pullrequestreview-1667763202">PR review</a>:</p>
<blockquote>
<p>This is very nice! Thank you! <span aria-label="heart" class="emoji emoji-2764" role="img" title="heart">:heart:</span>  Having the commits separated neatly really helped review this.</p>
<p>It all looks correct to me. But I'm not entirely sure I didn't miss anything, so a second pair of eyes would be helpful!</p>
<p>I'm also going to run the fuzzer on this for a few days to check if anything comes up. (Although I don't think that should prevent merging this)</p>
</blockquote>



<a name="395908359"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237203%20riscv64%3A%20Improve%20codegen%20for%20%60icmp%60/near/395908359" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237203.20riscv64.3A.20Improve.20codegen.20for.20.60icmp.60.html#395908359">(Oct 10 2023 at 15:27)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/7203#discussion_r1352552789">PR review comment</a>.</p>



<a name="395908502"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237203%20riscv64%3A%20Improve%20codegen%20for%20%60icmp%60/near/395908502" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237203.20riscv64.3A.20Improve.20codegen.20for.20.60icmp.60.html#395908502">(Oct 10 2023 at 15:28)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/7203#discussion_r1352552789">PR review comment</a>.</p>



<a name="396017153"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237203%20riscv64%3A%20Improve%20codegen%20for%20%60icmp%60/near/396017153" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237203.20riscv64.3A.20Improve.20codegen.20for.20.60icmp.60.html#396017153">(Oct 11 2023 at 06:15)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7203#pullrequestreview-1670015947">PR review</a>.</p>



<a name="396017154"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237203%20riscv64%3A%20Improve%20codegen%20for%20%60icmp%60/near/396017154" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237203.20riscv64.3A.20Improve.20codegen.20for.20.60icmp.60.html#396017154">(Oct 11 2023 at 06:15)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/7203#discussion_r1354149115">PR review comment</a>:</p>
<blockquote>
<p>Thanks for the good eye here, I'll dig into this a bit more and possibly omit this now that there's more constant-related optimizations for comparisons anyway. I'll probably leave this out for an initial attempt.</p>
</blockquote>



<a name="396220562"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237203%20riscv64%3A%20Improve%20codegen%20for%20%60icmp%60/near/396220562" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237203.20riscv64.3A.20Improve.20codegen.20for.20.60icmp.60.html#396220562">(Oct 12 2023 at 06:06)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7203">PR #7203</a>.</p>



<a name="396221693"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237203%20riscv64%3A%20Improve%20codegen%20for%20%60icmp%60/near/396221693" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237203.20riscv64.3A.20Improve.20codegen.20for.20.60icmp.60.html#396221693">(Oct 12 2023 at 06:17)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7203">PR #7203</a>.</p>



<a name="396221837"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237203%20riscv64%3A%20Improve%20codegen%20for%20%60icmp%60/near/396221837" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237203.20riscv64.3A.20Improve.20codegen.20for.20.60icmp.60.html#396221837">(Oct 12 2023 at 06:18)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7203">PR #7203</a>.</p>



<a name="396662704"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237203%20riscv64%3A%20Improve%20codegen%20for%20%60icmp%60/near/396662704" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237203.20riscv64.3A.20Improve.20codegen.20for.20.60icmp.60.html#396662704">(Oct 14 2023 at 16:16)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7203">PR #7203</a>.</p>



<a name="396894077"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237203%20riscv64%3A%20Improve%20codegen%20for%20%60icmp%60/near/396894077" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237203.20riscv64.3A.20Improve.20codegen.20for.20.60icmp.60.html#396894077">(Oct 16 2023 at 12:40)</a>:</h4>
<p>afonso360 merged <a href="https://github.com/bytecodealliance/wasmtime/pull/7203">PR #7203</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>