<html>
<head><meta charset="utf-8"><title>wasmtime / PR #2140 wasi-common: refactor error types · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232140.20wasi-common.3A.20refactor.20error.20types.html">wasmtime / PR #2140 wasi-common: refactor error types</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="207292660"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232140%20wasi-common%3A%20refactor%20error%20types/near/207292660" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232140.20wasi-common.3A.20refactor.20error.20types.html#207292660">(Aug 18 2020 at 17:57)</a>:</h4>
<p>pchickey opened <a href="https://github.com/bytecodealliance/wasmtime/pull/2140">PR #2140</a> from <code>pch/wasi_error_handling</code> to <code>main</code>:</p>
<blockquote>
<p>Prior to this PR, wasi-common used the wiggle-generated <code>Errno</code> type throughout, and had a variety of <code>impl From&lt;OtherErrorType&gt; for Errno</code> impls that took care of conversions.</p>
<p>This PR replaces that with a hand-written <code>Error</code> type that contains both the <code>Errno</code> variants the crate actually use, and variants for rich error types like <code>GuestError</code>, <code>std::io::Error</code>, and others. It uses <code>thiserror::Error</code> to derive a nice <code>Error</code> impl. Wiggle's error mapping feature takes care of converting this rich <code>Error</code> into an <code>Errno</code>.</p>
<p>This decouples a huge amount of code in wasi-common from the details of the wiggle-generated type, which will be useful as we start supporting multiple snapshots through wiggle (i'm working on that now). It also means we can keep around richer error information for longer, which is better for error reporting.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207292756"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232140%20wasi-common%3A%20refactor%20error%20types/near/207292756" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232140.20wasi-common.3A.20refactor.20error.20types.html#207292756">(Aug 18 2020 at 17:58)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2140">PR #2140</a> from <code>pch/wasi_error_handling</code> to <code>main</code>:</p>
<blockquote>
<p>Prior to this PR, wasi-common used the wiggle-generated <code>Errno</code> type throughout, and had a variety of <code>impl From&lt;OtherErrorType&gt; for Errno</code> impls that took care of conversions.</p>
<p>This PR replaces that with a hand-written <code>Error</code> type that contains both the <code>Errno</code> variants the crate actually use, and variants for rich error types like <code>GuestError</code>, <code>std::io::Error</code>, and others. It uses <code>thiserror::Error</code> to derive a nice <code>Error</code> impl. Wiggle's error mapping feature takes care of converting this rich <code>Error</code> into an <code>Errno</code>.</p>
<p>This decouples a huge amount of code in wasi-common from the details of the wiggle-generated type, which will be useful as we start supporting multiple snapshots through wiggle (i'm working on that now). It also means we can keep around richer error information for longer, which is better for error reporting.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207293573"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232140%20wasi-common%3A%20refactor%20error%20types/near/207293573" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232140.20wasi-common.3A.20refactor.20error.20types.html#207293573">(Aug 18 2020 at 18:03)</a>:</h4>
<p><strong>pchickey</strong> requested <a href="https://github.com/kubkon">kubkon</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/2140">PR #2140</a>.</p>



<a name="207296835"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232140%20wasi-common%3A%20refactor%20error%20types/near/207296835" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232140.20wasi-common.3A.20refactor.20error.20types.html#207296835">(Aug 18 2020 at 18:31)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2140">PR #2140</a> from <code>pch/wasi_error_handling</code> to <code>main</code>:</p>
<blockquote>
<p>Prior to this PR, wasi-common used the wiggle-generated <code>Errno</code> type throughout, and had a variety of <code>impl From&lt;OtherErrorType&gt; for Errno</code> impls that took care of conversions.</p>
<p>This PR replaces that with a hand-written <code>Error</code> type that contains both the <code>Errno</code> variants the crate actually use, and variants for rich error types like <code>GuestError</code>, <code>std::io::Error</code>, and others. It uses <code>thiserror::Error</code> to derive a nice <code>Error</code> impl. Wiggle's error mapping feature takes care of converting this rich <code>Error</code> into an <code>Errno</code>.</p>
<p>This decouples a huge amount of code in wasi-common from the details of the wiggle-generated type, which will be useful as we start supporting multiple snapshots through wiggle (i'm working on that now). It also means we can keep around richer error information for longer, which is better for error reporting.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207296852"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232140%20wasi-common%3A%20refactor%20error%20types/near/207296852" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232140.20wasi-common.3A.20refactor.20error.20types.html#207296852">(Aug 18 2020 at 18:31)</a>:</h4>
<p><strong>pchickey</strong> requested <a href="https://github.com/kubkon">kubkon</a> and <a href="https://github.com/sunfishcode">sunfishcode</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/2140">PR #2140</a>.</p>



<a name="207347807"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232140%20wasi-common%3A%20refactor%20error%20types/near/207347807" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232140.20wasi-common.3A.20refactor.20error.20types.html#207347807">(Aug 18 2020 at 22:03)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2140">PR #2140</a> from <code>pch/wasi_error_handling</code> to <code>main</code>:</p>
<blockquote>
<p>Prior to this PR, wasi-common used the wiggle-generated <code>Errno</code> type throughout, and had a variety of <code>impl From&lt;OtherErrorType&gt; for Errno</code> impls that took care of conversions.</p>
<p>This PR replaces that with a hand-written <code>Error</code> type that contains both the <code>Errno</code> variants the crate actually use, and variants for rich error types like <code>GuestError</code>, <code>std::io::Error</code>, and others. It uses <code>thiserror::Error</code> to derive a nice <code>Error</code> impl. Wiggle's error mapping feature takes care of converting this rich <code>Error</code> into an <code>Errno</code>.</p>
<p>This decouples a huge amount of code in wasi-common from the details of the wiggle-generated type, which will be useful as we start supporting multiple snapshots through wiggle (i'm working on that now). It also means we can keep around richer error information for longer, which is better for error reporting.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207353129"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232140%20wasi-common%3A%20refactor%20error%20types/near/207353129" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232140.20wasi-common.3A.20refactor.20error.20types.html#207353129">(Aug 18 2020 at 23:06)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2140">PR #2140</a> from <code>pch/wasi_error_handling</code> to <code>main</code>:</p>
<blockquote>
<p>Prior to this PR, wasi-common used the wiggle-generated <code>Errno</code> type throughout, and had a variety of <code>impl From&lt;OtherErrorType&gt; for Errno</code> impls that took care of conversions.</p>
<p>This PR replaces that with a hand-written <code>Error</code> type that contains both the <code>Errno</code> variants the crate actually use, and variants for rich error types like <code>GuestError</code>, <code>std::io::Error</code>, and others. It uses <code>thiserror::Error</code> to derive a nice <code>Error</code> impl. Wiggle's error mapping feature takes care of converting this rich <code>Error</code> into an <code>Errno</code>.</p>
<p>This decouples a huge amount of code in wasi-common from the details of the wiggle-generated type, which will be useful as we start supporting multiple snapshots through wiggle (i'm working on that now). It also means we can keep around richer error information for longer, which is better for error reporting.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207353723"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232140%20wasi-common%3A%20refactor%20error%20types/near/207353723" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232140.20wasi-common.3A.20refactor.20error.20types.html#207353723">(Aug 18 2020 at 23:12)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2140">PR #2140</a> from <code>pch/wasi_error_handling</code> to <code>main</code>:</p>
<blockquote>
<p>Prior to this PR, wasi-common used the wiggle-generated <code>Errno</code> type throughout, and had a variety of <code>impl From&lt;OtherErrorType&gt; for Errno</code> impls that took care of conversions.</p>
<p>This PR replaces that with a hand-written <code>Error</code> type that contains both the <code>Errno</code> variants the crate actually use, and variants for rich error types like <code>GuestError</code>, <code>std::io::Error</code>, and others. It uses <code>thiserror::Error</code> to derive a nice <code>Error</code> impl. Wiggle's error mapping feature takes care of converting this rich <code>Error</code> into an <code>Errno</code>.</p>
<p>This decouples a huge amount of code in wasi-common from the details of the wiggle-generated type, which will be useful as we start supporting multiple snapshots through wiggle (i'm working on that now). It also means we can keep around richer error information for longer, which is better for error reporting.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207354443"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232140%20wasi-common%3A%20refactor%20error%20types/near/207354443" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232140.20wasi-common.3A.20refactor.20error.20types.html#207354443">(Aug 18 2020 at 23:22)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2140">PR #2140</a> from <code>pch/wasi_error_handling</code> to <code>main</code>:</p>
<blockquote>
<p>Prior to this PR, wasi-common used the wiggle-generated <code>Errno</code> type throughout, and had a variety of <code>impl From&lt;OtherErrorType&gt; for Errno</code> impls that took care of conversions.</p>
<p>This PR replaces that with a hand-written <code>Error</code> type that contains both the <code>Errno</code> variants the crate actually use, and variants for rich error types like <code>GuestError</code>, <code>std::io::Error</code>, and others. It uses <code>thiserror::Error</code> to derive a nice <code>Error</code> impl. Wiggle's error mapping feature takes care of converting this rich <code>Error</code> into an <code>Errno</code>.</p>
<p>This decouples a huge amount of code in wasi-common from the details of the wiggle-generated type, which will be useful as we start supporting multiple snapshots through wiggle (i'm working on that now). It also means we can keep around richer error information for longer, which is better for error reporting.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207443794"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232140%20wasi-common%3A%20refactor%20error%20types/near/207443794" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232140.20wasi-common.3A.20refactor.20error.20types.html#207443794">(Aug 19 2020 at 18:25)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2140">PR #2140</a> from <code>pch/wasi_error_handling</code> to <code>main</code>:</p>
<blockquote>
<p>Prior to this PR, wasi-common used the wiggle-generated <code>Errno</code> type throughout, and had a variety of <code>impl From&lt;OtherErrorType&gt; for Errno</code> impls that took care of conversions.</p>
<p>This PR replaces that with a hand-written <code>Error</code> type that contains both the <code>Errno</code> variants the crate actually use, and variants for rich error types like <code>GuestError</code>, <code>std::io::Error</code>, and others. It uses <code>thiserror::Error</code> to derive a nice <code>Error</code> impl. Wiggle's error mapping feature takes care of converting this rich <code>Error</code> into an <code>Errno</code>.</p>
<p>This decouples a huge amount of code in wasi-common from the details of the wiggle-generated type, which will be useful as we start supporting multiple snapshots through wiggle (i'm working on that now). It also means we can keep around richer error information for longer, which is better for error reporting.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207444218"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232140%20wasi-common%3A%20refactor%20error%20types/near/207444218" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232140.20wasi-common.3A.20refactor.20error.20types.html#207444218">(Aug 19 2020 at 18:29)</a>:</h4>
<p>pchickey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2140">PR #2140</a> from <code>pch/wasi_error_handling</code> to <code>main</code>:</p>
<blockquote>
<p>Prior to this PR, wasi-common used the wiggle-generated <code>Errno</code> type throughout, and had a variety of <code>impl From&lt;OtherErrorType&gt; for Errno</code> impls that took care of conversions.</p>
<p>This PR replaces that with a hand-written <code>Error</code> type that contains both the <code>Errno</code> variants the crate actually use, and variants for rich error types like <code>GuestError</code>, <code>Utf8Error</code>, and others. It uses <code>thiserror::Error</code> to derive a nice <code>Error</code> impl. Wiggle's error mapping feature takes care of converting this rich <code>Error</code> into an <code>Errno</code>.</p>
<p>This decouples a huge amount of code in wasi-common from the details of the wiggle-generated type, which will be useful as we start supporting multiple snapshots through wiggle (i'm working on that now). It also means we can keep around richer error information for longer, which is better for error reporting. Rather than having ad-hoc log statements sprinkled in various <code>From</code> impls, we rely on the error conversion hooks that Wiggle provides to perform logging.</p>
<p>This PR also changes, in a subtle way, the way a <code>std::io::Error</code> gets translated through to a wasi <code>Errno</code>.</p>
<ul>
<li>
<p>a certain subset of io::Errors are expected - these we have<br>
  a (platform-specific, because windows) method to translate into<br>
  one of the wasi errno variants in the Error enum.</p>
</li>
<li>
<p>some io::Errors are unexpected - wasi-common doesnt expect them from<br>
  the underlying OS. rather than preserve any fidelity in reporting<br>
  those to the user (only the unix impl attempts this), lets collect<br>
  those as an <code>Error::UnexpectedIo(#[source] std::io::Error)</code>.<br>
  We convert all of these unexpected into <code>Errno::Io</code> for returning<br>
  to the guest.</p>
</li>
</ul>
<p>This is a different behavior from before, and I don't have any firm<br>
guarantees that nobody was depending on the old behavior, but it<br>
appears to me that none of those unexpected errnos were reasonable<br>
to expect from any of the filesystem syscalls wasi-common is making.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207444398"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232140%20wasi-common%3A%20refactor%20error%20types/near/207444398" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232140.20wasi-common.3A.20refactor.20error.20types.html#207444398">(Aug 19 2020 at 18:31)</a>:</h4>
<p>pchickey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2140">PR #2140</a> from <code>pch/wasi_error_handling</code> to <code>main</code>:</p>
<blockquote>
<p>Prior to this PR, wasi-common used the wiggle-generated <code>Errno</code> type throughout, and had a variety of <code>impl From&lt;OtherErrorType&gt; for Errno</code> impls that took care of conversions.</p>
<p>This PR replaces that with a hand-written <code>Error</code> type that contains both the <code>Errno</code> variants the crate actually use, and variants for rich error types like <code>GuestError</code>, <code>Utf8Error</code>, and others. It uses <code>thiserror::Error</code> to derive a nice <code>Error</code> impl. Wiggle's error mapping feature takes care of converting this rich <code>Error</code> into an <code>Errno</code>.</p>
<p>This decouples a huge amount of code in wasi-common from the details of the wiggle-generated type, which will be useful as we start supporting multiple snapshots through wiggle (i'm working on that now). It also means we can keep around richer error information for longer, which is better for error reporting. Rather than having ad-hoc log statements sprinkled in various <code>From</code> impls, we rely on the error conversion hooks that Wiggle provides to perform logging.</p>
<p>This PR also changes, in a subtle way, the way a <code>std::io::Error</code> gets translated through to a wasi <code>Errno</code>.</p>
<ul>
<li>
<p>a certain subset of io::Errors are expected - these we have<br>
  a (platform-specific, because windows) method to translate into<br>
  one of the wasi errno variants in the Error enum.</p>
</li>
<li>
<p>some io::Errors are unexpected - wasi-common doesnt expect them from<br>
  the underlying OS. rather than preserve any fidelity in reporting<br>
  those to the user (only the unix impl attempts this), lets collect<br>
  those as an <code>Error::UnexpectedIo(#[source] std::io::Error)</code>.<br>
  We convert all of these unexpected into <code>Errno::Io</code> for returning<br>
  to the guest.</p>
</li>
</ul>
<p>This is a different behavior from before, where e.g. if the OS returned a <code>libc::ECONNABORTED</code> we would surface that to the guest as <code>Errno::Econnaborted</code>, and I don't have any firm guarantees that nobody was depending on the old behavior, but it appears to me that none of those unexpected errnos were reasonable to expect from any of the filesystem syscalls wasi-common is making. When wasi-common expands in responsibility to include sockets syscalls etc, we can add these behaviors back in explicitly.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207445116"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232140%20wasi-common%3A%20refactor%20error%20types/near/207445116" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232140.20wasi-common.3A.20refactor.20error.20types.html#207445116">(Aug 19 2020 at 18:37)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2140">PR #2140</a> from <code>pch/wasi_error_handling</code> to <code>main</code>:</p>
<blockquote>
<p>Prior to this PR, wasi-common used the wiggle-generated <code>Errno</code> type throughout, and had a variety of <code>impl From&lt;OtherErrorType&gt; for Errno</code> impls that took care of conversions.</p>
<p>This PR replaces that with a hand-written <code>Error</code> type that contains both the <code>Errno</code> variants the crate actually use, and variants for rich error types like <code>GuestError</code>, <code>Utf8Error</code>, and others. It uses <code>thiserror::Error</code> to derive a nice <code>Error</code> impl. Wiggle's error mapping feature takes care of converting this rich <code>Error</code> into an <code>Errno</code>.</p>
<p>This decouples a huge amount of code in wasi-common from the details of the wiggle-generated type, which will be useful as we start supporting multiple snapshots through wiggle (i'm working on that now). It also means we can keep around richer error information for longer, which is better for error reporting. Rather than having ad-hoc log statements sprinkled in various <code>From</code> impls, we rely on the error conversion hooks that Wiggle provides to perform logging.</p>
<p>This PR also changes, in a subtle way, the way a <code>std::io::Error</code> gets translated through to a wasi <code>Errno</code>.</p>
<ul>
<li>
<p>a certain subset of io::Errors are expected - these we have<br>
  a (platform-specific, because windows) method to translate into<br>
  one of the wasi errno variants in the Error enum.</p>
</li>
<li>
<p>some io::Errors are unexpected - wasi-common doesnt expect them from<br>
  the underlying OS. rather than preserve any fidelity in reporting<br>
  those to the user (only the unix impl attempts this), lets collect<br>
  those as an <code>Error::UnexpectedIo(#[source] std::io::Error)</code>.<br>
  We convert all of these unexpected into <code>Errno::Io</code> for returning<br>
  to the guest.</p>
</li>
</ul>
<p>This is a different behavior from before, where e.g. if the OS returned a <code>libc::ECONNABORTED</code> we would surface that to the guest as <code>Errno::Econnaborted</code>, and I don't have any firm guarantees that nobody was depending on the old behavior, but it appears to me that none of those unexpected errnos were reasonable to expect from any of the filesystem syscalls wasi-common is making. When wasi-common expands in responsibility to include sockets syscalls etc, we can add these behaviors back in explicitly.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207448087"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232140%20wasi-common%3A%20refactor%20error%20types/near/207448087" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232140.20wasi-common.3A.20refactor.20error.20types.html#207448087">(Aug 19 2020 at 19:01)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2140">PR #2140</a> from <code>pch/wasi_error_handling</code> to <code>main</code>:</p>
<blockquote>
<p>Prior to this PR, wasi-common used the wiggle-generated <code>Errno</code> type throughout, and had a variety of <code>impl From&lt;OtherErrorType&gt; for Errno</code> impls that took care of conversions.</p>
<p>This PR replaces that with a hand-written <code>Error</code> type that contains both the <code>Errno</code> variants the crate actually use, and variants for rich error types like <code>GuestError</code>, <code>Utf8Error</code>, and others. It uses <code>thiserror::Error</code> to derive a nice <code>Error</code> impl. Wiggle's error mapping feature takes care of converting this rich <code>Error</code> into an <code>Errno</code>.</p>
<p>This decouples a huge amount of code in wasi-common from the details of the wiggle-generated type, which will be useful as we start supporting multiple snapshots through wiggle (i'm working on that now). It also means we can keep around richer error information for longer, which is better for error reporting. Rather than having ad-hoc log statements sprinkled in various <code>From</code> impls, we rely on the error conversion hooks that Wiggle provides to perform logging.</p>
<p>This PR also changes, in a subtle way, the way a <code>std::io::Error</code> gets translated through to a wasi <code>Errno</code>.</p>
<ul>
<li>
<p>a certain subset of io::Errors are expected - these we have<br>
  a (platform-specific, because windows) method to translate into<br>
  one of the wasi errno variants in the Error enum.</p>
</li>
<li>
<p>some io::Errors are unexpected - wasi-common doesnt expect them from<br>
  the underlying OS. rather than preserve any fidelity in reporting<br>
  those to the user (only the unix impl attempts this), lets collect<br>
  those as an <code>Error::UnexpectedIo(#[source] std::io::Error)</code>.<br>
  We convert all of these unexpected into <code>Errno::Io</code> for returning<br>
  to the guest.</p>
</li>
</ul>
<p>This is a different behavior from before, where e.g. if the OS returned a <code>libc::ECONNABORTED</code> we would surface that to the guest as <code>Errno::Econnaborted</code>, and I don't have any firm guarantees that nobody was depending on the old behavior, but it appears to me that none of those unexpected errnos were reasonable to expect from any of the filesystem syscalls wasi-common is making. When wasi-common expands in responsibility to include sockets syscalls etc, we can add these behaviors back in explicitly.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207448371"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232140%20wasi-common%3A%20refactor%20error%20types/near/207448371" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232140.20wasi-common.3A.20refactor.20error.20types.html#207448371">(Aug 19 2020 at 19:03)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2140">PR #2140</a> from <code>pch/wasi_error_handling</code> to <code>main</code>:</p>
<blockquote>
<p>Prior to this PR, wasi-common used the wiggle-generated <code>Errno</code> type throughout, and had a variety of <code>impl From&lt;OtherErrorType&gt; for Errno</code> impls that took care of conversions.</p>
<p>This PR replaces that with a hand-written <code>Error</code> type that contains both the <code>Errno</code> variants the crate actually use, and variants for rich error types like <code>GuestError</code>, <code>Utf8Error</code>, and others. It uses <code>thiserror::Error</code> to derive a nice <code>Error</code> impl. Wiggle's error mapping feature takes care of converting this rich <code>Error</code> into an <code>Errno</code>.</p>
<p>This decouples a huge amount of code in wasi-common from the details of the wiggle-generated type, which will be useful as we start supporting multiple snapshots through wiggle (i'm working on that now). It also means we can keep around richer error information for longer, which is better for error reporting. Rather than having ad-hoc log statements sprinkled in various <code>From</code> impls, we rely on the error conversion hooks that Wiggle provides to perform logging.</p>
<p>This PR also changes, in a subtle way, the way a <code>std::io::Error</code> gets translated through to a wasi <code>Errno</code>.</p>
<ul>
<li>
<p>a certain subset of io::Errors are expected - these we have<br>
  a (platform-specific, because windows) method to translate into<br>
  one of the wasi errno variants in the Error enum.</p>
</li>
<li>
<p>some io::Errors are unexpected - wasi-common doesnt expect them from<br>
  the underlying OS. rather than preserve any fidelity in reporting<br>
  those to the user (only the unix impl attempts this), lets collect<br>
  those as an <code>Error::UnexpectedIo(#[source] std::io::Error)</code>.<br>
  We convert all of these unexpected into <code>Errno::Io</code> for returning<br>
  to the guest.</p>
</li>
</ul>
<p>This is a different behavior from before, where e.g. if the OS returned a <code>libc::ECONNABORTED</code> we would surface that to the guest as <code>Errno::Econnaborted</code>, and I don't have any firm guarantees that nobody was depending on the old behavior, but it appears to me that none of those unexpected errnos were reasonable to expect from any of the filesystem syscalls wasi-common is making. When wasi-common expands in responsibility to include sockets syscalls etc, we can add these behaviors back in explicitly.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207463772"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232140%20wasi-common%3A%20refactor%20error%20types/near/207463772" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232140.20wasi-common.3A.20refactor.20error.20types.html#207463772">(Aug 19 2020 at 21:29)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2140">PR #2140</a> from <code>pch/wasi_error_handling</code> to <code>main</code>:</p>
<blockquote>
<p>Prior to this PR, wasi-common used the wiggle-generated <code>Errno</code> type throughout, and had a variety of <code>impl From&lt;OtherErrorType&gt; for Errno</code> impls that took care of conversions.</p>
<p>This PR replaces that with a hand-written <code>Error</code> type that contains both the <code>Errno</code> variants the crate actually use, and variants for rich error types like <code>GuestError</code>, <code>Utf8Error</code>, and others. It uses <code>thiserror::Error</code> to derive a nice <code>Error</code> impl. Wiggle's error mapping feature takes care of converting this rich <code>Error</code> into an <code>Errno</code>.</p>
<p>This decouples a huge amount of code in wasi-common from the details of the wiggle-generated type, which will be useful as we start supporting multiple snapshots through wiggle (i'm working on that now). It also means we can keep around richer error information for longer, which is better for error reporting. Rather than having ad-hoc log statements sprinkled in various <code>From</code> impls, we rely on the error conversion hooks that Wiggle provides to perform logging.</p>
<p>This PR also changes, in a subtle way, the way a <code>std::io::Error</code> gets translated through to a wasi <code>Errno</code>.</p>
<ul>
<li>
<p>a certain subset of io::Errors are expected - these we have<br>
  a (platform-specific, because windows) method to translate into<br>
  one of the wasi errno variants in the Error enum.</p>
</li>
<li>
<p>some io::Errors are unexpected - wasi-common doesnt expect them from<br>
  the underlying OS. rather than preserve any fidelity in reporting<br>
  those to the user (only the unix impl attempts this), lets collect<br>
  those as an <code>Error::UnexpectedIo(#[source] std::io::Error)</code>.<br>
  We convert all of these unexpected into <code>Errno::Io</code> for returning<br>
  to the guest.</p>
</li>
</ul>
<p>This is a different behavior from before, where e.g. if the OS returned a <code>libc::ECONNABORTED</code> we would surface that to the guest as <code>Errno::Econnaborted</code>, and I don't have any firm guarantees that nobody was depending on the old behavior, but it appears to me that none of those unexpected errnos were reasonable to expect from any of the filesystem syscalls wasi-common is making. When wasi-common expands in responsibility to include sockets syscalls etc, we can add these behaviors back in explicitly.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207467354"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232140%20wasi-common%3A%20refactor%20error%20types/near/207467354" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232140.20wasi-common.3A.20refactor.20error.20types.html#207467354">(Aug 19 2020 at 22:10)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2140">PR #2140</a> from <code>pch/wasi_error_handling</code> to <code>main</code>:</p>
<blockquote>
<p>Prior to this PR, wasi-common used the wiggle-generated <code>Errno</code> type throughout, and had a variety of <code>impl From&lt;OtherErrorType&gt; for Errno</code> impls that took care of conversions.</p>
<p>This PR replaces that with a hand-written <code>Error</code> type that contains both the <code>Errno</code> variants the crate actually use, and variants for rich error types like <code>GuestError</code>, <code>Utf8Error</code>, and others. It uses <code>thiserror::Error</code> to derive a nice <code>Error</code> impl. Wiggle's error mapping feature takes care of converting this rich <code>Error</code> into an <code>Errno</code>.</p>
<p>This decouples a huge amount of code in wasi-common from the details of the wiggle-generated type, which will be useful as we start supporting multiple snapshots through wiggle (i'm working on that now). It also means we can keep around richer error information for longer, which is better for error reporting. Rather than having ad-hoc log statements sprinkled in various <code>From</code> impls, we rely on the error conversion hooks that Wiggle provides to perform logging.</p>
<p>This PR also changes, in a subtle way, the way a <code>std::io::Error</code> gets translated through to a wasi <code>Errno</code>.</p>
<ul>
<li>
<p>a certain subset of io::Errors are expected - these we have<br>
  a (platform-specific, because windows) method to translate into<br>
  one of the wasi errno variants in the Error enum.</p>
</li>
<li>
<p>some io::Errors are unexpected - wasi-common doesnt expect them from<br>
  the underlying OS. rather than preserve any fidelity in reporting<br>
  those to the user (only the unix impl attempts this), lets collect<br>
  those as an <code>Error::UnexpectedIo(#[source] std::io::Error)</code>.<br>
  We convert all of these unexpected into <code>Errno::Io</code> for returning<br>
  to the guest.</p>
</li>
</ul>
<p>This is a different behavior from before, where e.g. if the OS returned a <code>libc::ECONNABORTED</code> we would surface that to the guest as <code>Errno::Econnaborted</code>, and I don't have any firm guarantees that nobody was depending on the old behavior, but it appears to me that none of those unexpected errnos were reasonable to expect from any of the filesystem syscalls wasi-common is making. When wasi-common expands in responsibility to include sockets syscalls etc, we can add these behaviors back in explicitly.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207875200"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232140%20wasi-common%3A%20refactor%20error%20types/near/207875200" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232140.20wasi-common.3A.20refactor.20error.20types.html#207875200">(Aug 24 2020 at 18:02)</a>:</h4>
<p><strong>pchickey</strong> requested <a href="https://github.com/sunfishcode">sunfishcode</a> and <a href="https://github.com/iximeow">iximeow</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/2140">PR #2140</a>.</p>



<a name="208031730"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232140%20wasi-common%3A%20refactor%20error%20types/near/208031730" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232140.20wasi-common.3A.20refactor.20error.20types.html#208031730">(Aug 25 2020 at 22:23)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2140">PR #2140</a> from <code>pch/wasi_error_handling</code> to <code>main</code>:</p>
<blockquote>
<p>Prior to this PR, wasi-common used the wiggle-generated <code>Errno</code> type throughout, and had a variety of <code>impl From&lt;OtherErrorType&gt; for Errno</code> impls that took care of conversions.</p>
<p>This PR replaces that with a hand-written <code>Error</code> type that contains both the <code>Errno</code> variants the crate actually use, and variants for rich error types like <code>GuestError</code>, <code>Utf8Error</code>, and others. It uses <code>thiserror::Error</code> to derive a nice <code>Error</code> impl. Wiggle's error mapping feature takes care of converting this rich <code>Error</code> into an <code>Errno</code>.</p>
<p>This decouples a huge amount of code in wasi-common from the details of the wiggle-generated type, which will be useful as we start supporting multiple snapshots through wiggle (i'm working on that now). It also means we can keep around richer error information for longer, which is better for error reporting. Rather than having ad-hoc log statements sprinkled in various <code>From</code> impls, we rely on the error conversion hooks that Wiggle provides to perform logging.</p>
<p>This PR also changes, in a subtle way, the way a <code>std::io::Error</code> gets translated through to a wasi <code>Errno</code>.</p>
<ul>
<li>
<p>a certain subset of io::Errors are expected - these we have<br>
  a (platform-specific, because windows) method to translate into<br>
  one of the wasi errno variants in the Error enum.</p>
</li>
<li>
<p>some io::Errors are unexpected - wasi-common doesnt expect them from<br>
  the underlying OS. rather than preserve any fidelity in reporting<br>
  those to the user (only the unix impl attempts this), lets collect<br>
  those as an <code>Error::UnexpectedIo(#[source] std::io::Error)</code>.<br>
  We convert all of these unexpected into <code>Errno::Io</code> for returning<br>
  to the guest.</p>
</li>
</ul>
<p>This is a different behavior from before, where e.g. if the OS returned a <code>libc::ECONNABORTED</code> we would surface that to the guest as <code>Errno::Econnaborted</code>, and I don't have any firm guarantees that nobody was depending on the old behavior, but it appears to me that none of those unexpected errnos were reasonable to expect from any of the filesystem syscalls wasi-common is making. When wasi-common expands in responsibility to include sockets syscalls etc, we can add these behaviors back in explicitly.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="208166210"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232140%20wasi-common%3A%20refactor%20error%20types/near/208166210" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232140.20wasi-common.3A.20refactor.20error.20types.html#208166210">(Aug 27 2020 at 00:26)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2140">PR #2140</a> from <code>pch/wasi_error_handling</code> to <code>main</code>:</p>
<blockquote>
<p>Prior to this PR, wasi-common used the wiggle-generated <code>Errno</code> type throughout, and had a variety of <code>impl From&lt;OtherErrorType&gt; for Errno</code> impls that took care of conversions.</p>
<p>This PR replaces that with a hand-written <code>Error</code> type that contains both the <code>Errno</code> variants the crate actually use, and variants for rich error types like <code>GuestError</code>, <code>Utf8Error</code>, and others. It uses <code>thiserror::Error</code> to derive a nice <code>Error</code> impl. Wiggle's error mapping feature takes care of converting this rich <code>Error</code> into an <code>Errno</code>.</p>
<p>This decouples a huge amount of code in wasi-common from the details of the wiggle-generated type, which will be useful as we start supporting multiple snapshots through wiggle (i'm working on that now). It also means we can keep around richer error information for longer, which is better for error reporting. Rather than having ad-hoc log statements sprinkled in various <code>From</code> impls, we rely on the error conversion hooks that Wiggle provides to perform logging.</p>
<p>This PR also changes, in a subtle way, the way a <code>std::io::Error</code> gets translated through to a wasi <code>Errno</code>.</p>
<ul>
<li>
<p>a certain subset of io::Errors are expected - these we have<br>
  a (platform-specific, because windows) method to translate into<br>
  one of the wasi errno variants in the Error enum.</p>
</li>
<li>
<p>some io::Errors are unexpected - wasi-common doesnt expect them from<br>
  the underlying OS. rather than preserve any fidelity in reporting<br>
  those to the user (only the unix impl attempts this), lets collect<br>
  those as an <code>Error::UnexpectedIo(#[source] std::io::Error)</code>.<br>
  We convert all of these unexpected into <code>Errno::Io</code> for returning<br>
  to the guest.</p>
</li>
</ul>
<p>This is a different behavior from before, where e.g. if the OS returned a <code>libc::ECONNABORTED</code> we would surface that to the guest as <code>Errno::Econnaborted</code>, and I don't have any firm guarantees that nobody was depending on the old behavior, but it appears to me that none of those unexpected errnos were reasonable to expect from any of the filesystem syscalls wasi-common is making. When wasi-common expands in responsibility to include sockets syscalls etc, we can add these behaviors back in explicitly.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="208725578"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232140%20wasi-common%3A%20refactor%20error%20types/near/208725578" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232140.20wasi-common.3A.20refactor.20error.20types.html#208725578">(Sep 01 2020 at 18:10)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2140#pullrequestreview-479966288">PR Review</a>.</p>



<a name="208725580"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232140%20wasi-common%3A%20refactor%20error%20types/near/208725580" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232140.20wasi-common.3A.20refactor.20error.20types.html#208725580">(Sep 01 2020 at 18:10)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2140#pullrequestreview-479966288">PR Review</a>.</p>



<a name="208725582"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232140%20wasi-common%3A%20refactor%20error%20types/near/208725582" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232140.20wasi-common.3A.20refactor.20error.20types.html#208725582">(Sep 01 2020 at 18:10)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/wasmtime/pull/2140#discussion_r481312680">PR Review Comment</a>:</p>
<blockquote>
<p><code>ERROR_BUFFER_OVERFLOW</code> is .. a fascinatingly-named error.</p>
</blockquote>



<a name="208725583"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232140%20wasi-common%3A%20refactor%20error%20types/near/208725583" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232140.20wasi-common.3A.20refactor.20error.20types.html#208725583">(Sep 01 2020 at 18:10)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/wasmtime/pull/2140#discussion_r481318954">PR Review Comment</a>:</p>
<blockquote>
<div class="codehilite"><pre><span></span><code>                                Err(Error::Inval) | Err(Error::Noent) =&gt; {}
                                Err(Error::Notdir) =&gt; {
</code></pre></div>


<p>I'm having a hard time reconstructing how this works with symlinks, but I think the comment is describing the specific <code>readlinkat-returns-Notdir</code> case.</p>
</blockquote>



<a name="208739311"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232140%20wasi-common%3A%20refactor%20error%20types/near/208739311" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232140.20wasi-common.3A.20refactor.20error.20types.html#208739311">(Sep 01 2020 at 19:57)</a>:</h4>
<p>pchickey submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2140#pullrequestreview-480070789">PR Review</a>.</p>



<a name="208739312"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232140%20wasi-common%3A%20refactor%20error%20types/near/208739312" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232140.20wasi-common.3A.20refactor.20error.20types.html#208739312">(Sep 01 2020 at 19:57)</a>:</h4>
<p>pchickey created <a href="https://github.com/bytecodealliance/wasmtime/pull/2140#discussion_r481395842">PR Review Comment</a>:</p>
<blockquote>
<p>Me too. This is a transformation of code that existed before (when we had Eq; we no longer do) that I am not 100% convinced is correct, but don't have a sufficient understanding of the problem or test suite to disprove. </p>
</blockquote>



<a name="208739460"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232140%20wasi-common%3A%20refactor%20error%20types/near/208739460" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232140.20wasi-common.3A.20refactor.20error.20types.html#208739460">(Sep 01 2020 at 19:58)</a>:</h4>
<p>pchickey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2140#discussion_r481395842">PR Review Comment</a>.</p>



<a name="208739906"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232140%20wasi-common%3A%20refactor%20error%20types/near/208739906" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232140.20wasi-common.3A.20refactor.20error.20types.html#208739906">(Sep 01 2020 at 20:01)</a>:</h4>
<p>pchickey merged <a href="https://github.com/bytecodealliance/wasmtime/pull/2140">PR #2140</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>