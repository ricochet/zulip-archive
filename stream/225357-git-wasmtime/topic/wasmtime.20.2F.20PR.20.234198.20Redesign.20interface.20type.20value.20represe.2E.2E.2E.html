<html>
<head><meta charset="utf-8"><title>wasmtime / PR #4198 Redesign interface type value represe... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234198.20Redesign.20interface.20type.20value.20represe.2E.2E.2E.html">wasmtime / PR #4198 Redesign interface type value represe...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="284494839"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234198%20Redesign%20interface%20type%20value%20represe.../near/284494839" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234198.20Redesign.20interface.20type.20value.20represe.2E.2E.2E.html#284494839">(May 31 2022 at 15:39)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/4198">PR #4198</a> from <code>no-component-value</code> to <code>main</code>:</p>
<blockquote>
<p>Prior to this PR a major feature of calling component exports (#4039)<br>
was the usage of the <code>Value&lt;T&gt;</code> type. This type represents a value<br>
stored in wasm linear memory (the type <code>T</code> stored there). This<br>
implementation had a number of drawbacks though:</p>
<ul>
<li>
<p>When returning a value it's ABI-specific whether you use <code>T</code> or<br>
<code>Value&lt;T&gt;</code> as a return value. If <code>T</code> is represented with one wasm<br>
  primitive then you have to return <code>T</code>, otherwise the return value must<br>
  be <code>Value&lt;T&gt;</code>. This is somewhat non-obvious and leaks ABI-details into<br>
  the API which is unfortunate.</p>
</li>
<li>
<p>The <code>T</code> in <code>Value&lt;T&gt;</code> was somewhat non-obvious. For example a<br>
  wasm-owned string was <code>Value&lt;String&gt;</code>. Using <code>Value&lt;&amp;str&gt;</code> didn't<br>
  work.</p>
</li>
<li>
<p>Working with <code>Value&lt;T&gt;</code> was unergonomic in the sense that you had to<br>
  first "pair" it with a <code>&amp;Store&lt;U&gt;</code> to get a <code>Cursor&lt;T&gt;</code> and then you<br>
  could start reading the value.</p>
</li>
<li>
<p>Custom structs and enums, while not implemented yet, were planned to<br>
  be quite wonky where when you had <code>Cursor&lt;MyStruct&gt;</code> then you would<br>
  have to import a <code>CursorMyStructExt</code> trait generated by a proc-macro<br>
  (think a <code>#[derive]</code> on the definition of <code>MyStruct</code>) which would<br>
  enable field accessors, returning cursors of all the fields.</p>
</li>
<li>
<p>In general there was no "generic way" to load a <code>T</code> from memory. Other<br>
  operations like lift/lower/store all had methods in the<br>
<code>ComponentValue</code> trait but load had no equivalent.</p>
</li>
</ul>
<p>None of these drawbacks were deal-breakers per-se. When I started<br>
to implement imported functions, though, the <code>Value&lt;T&gt;</code> type no longer<br>
worked. The major difference between imports and exports is that when<br>
receiving values from wasm an export returns at most one wasm primitive<br>
where an import can yield (through arguments) up to 16 wasm primitives.<br>
This means that if an export returned a string it would always be<br>
<code>Value&lt;String&gt;</code> but if an import took a string as an argument there was<br>
actually no way to represent this with <code>Value&lt;String&gt;</code> since the value<br>
wasn't actually stored in memory but rather the pointer/length pair is<br>
received as arguments. Overall this meant that <code>Value&lt;T&gt;</code> couldn't be<br>
used for arguments-to-imports, which means that altogether something new<br>
would be required.</p>
<p>This PR completely removes the <code>Value&lt;T&gt;</code> and <code>Cursor&lt;T&gt;</code> type in favor<br>
of a different implementation. The inspiration from this comes from the<br>
fact that all primitives can be both lifted and lowered into wasm while<br>
it's just some times which can only go one direction. For example<br>
<code>String</code> can be lowered into wasm but can't be lifted from wasm. Instead<br>
some sort of "view" into wasm needs to be created during lifting.</p>
<p>One of the realizations from #4039 was that we could leverage<br>
run-time-type-checking to reject static constructions that don't make<br>
sense. For example if an embedder asserts that a wasm function returns a<br>
Rust <code>String</code> we can reject that at typechecking time because it's<br>
impossible for a wasm module to ever do that.</p>
<p>The new system of imports/exports in this PR now looks like:</p>
<ul>
<li>
<p>Type-checking takes into accont an <code>Op</code> operation which indicates<br>
  whether we'll be lifting or lowering the type. This means that we can<br>
  allow the lowering operation for <code>String</code> but disallow the lifting<br>
  operation. While we can't statically rule out an embedder saying that<br>
  a component returns a <code>String</code> we can now reject it at runtime and<br>
  disallow it from being called.</p>
</li>
<li>
<p>The <code>ComponentValue</code> trait now sports a new <code>load</code> function. This<br>
  function will load and instance of <code>Self</code> from the byte-array<br>
  provided. This is implemented for all types but only ever actually<br>
  executed when the <code>lift</code> operation is allowed during type-checking.</p>
</li>
<li>
<p>The <code>Lift</code> associated type is removed since it's now expected that the<br>
  lift operation returns <code>Self</code>.</p>
</li>
<li>
<p>The <code>ComponentReturn</code> trait is now no longer necessary and is removed.<br>
  Instead returns are bounded by <code>ComponentValue</code>. During type-checking<br>
  it's required that the return value can be lifted, disallowing, for<br>
  example, returning a <code>String</code> or <code>&amp;str</code>.</p>
</li>
<li>
<p>With <code>Value</code> gone there's no need to specify the ABI details of the<br>
  return value, or whether it's communicated through memory or not. This<br>
  means that handling return values through memory is transparently<br>
  handled by Wasmtime.</p>
</li>
<li>
<p>Validation is in a sense more eagerly performed now. Whenever a value<br>
<code>T</code> is loaded the entire immediate structure of <code>T</code> is loaded and<br>
  validated. Note that recursive through memory validation still does<br>
  not happen, so the contents of lists or strings aren't validated, it's<br>
  just validated that the pointers are in-bounds.</p>
</li>
</ul>
<p>Overall this felt like a much clearer system to work with and should be<br>
much easier to integrate with imported functions as well. The new<br>
<code>WasmStr</code> and <code>WasmList&lt;T&gt;</code> types can be used in import arguments and<br>
lifted from the immediate arguments provided rather than forcing them to<br>
always be stored in memory.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="284646931"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234198%20Redesign%20interface%20type%20value%20represe.../near/284646931" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234198.20Redesign.20interface.20type.20value.20represe.2E.2E.2E.html#284646931">(Jun 01 2022 at 17:55)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/4198">PR #4198</a>.</p>



<a name="284648579"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234198%20Redesign%20interface%20type%20value%20represe.../near/284648579" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234198.20Redesign.20interface.20type.20value.20represe.2E.2E.2E.html#284648579">(Jun 01 2022 at 18:07)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4198">PR #4198</a> from <code>no-component-value</code> to <code>main</code>.</p>



<a name="284663722"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234198%20Redesign%20interface%20type%20value%20represe.../near/284663722" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234198.20Redesign.20interface.20type.20value.20represe.2E.2E.2E.html#284663722">(Jun 01 2022 at 20:17)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4198#pullrequestreview-992629124">PR review</a>.</p>



<a name="284666338"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234198%20Redesign%20interface%20type%20value%20represe.../near/284666338" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234198.20Redesign.20interface.20type.20value.20represe.2E.2E.2E.html#284666338">(Jun 01 2022 at 20:38)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/4198">PR #4198</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>