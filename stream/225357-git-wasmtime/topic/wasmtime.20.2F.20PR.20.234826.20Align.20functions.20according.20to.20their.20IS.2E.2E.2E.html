<html>
<head><meta charset="utf-8"><title>wasmtime / PR #4826 Align functions according to their IS... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html">wasmtime / PR #4826 Align functions according to their IS...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="296221569"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296221569" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296221569">(Aug 30 2022 at 21:08)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/4826">PR #4826</a> from <code>trevor/fix-4812</code> to <code>main</code>:</p>
<blockquote>
<ul>
<li>Add function alignment to the TargetIsa trait</li>
<li>Align functions by their ISA's requirements</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="296221853"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296221853" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296221853">(Aug 30 2022 at 21:10)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/4826">PR #4826</a> from <code>trevor/fix-4812</code> to <code>main</code>:</p>
<blockquote>
<p>Add a <code>function_alignment</code> function to the <code>TargetIsa</code> trait, and use it to align functions when generating objects. This fixes a bug on x86_64 where rip-relative loads to sse registers could cause a segfault, as functions weren't always guaranteed to be aligned to 16-byte addresses.</p>
<p>Fixes #4812 </p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="296221863"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296221863" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296221863">(Aug 30 2022 at 21:10)</a>:</h4>
<p><strong>elliottt</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/4826">PR #4826</a>.</p>



<a name="296223207"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296223207" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296223207">(Aug 30 2022 at 21:21)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4826#pullrequestreview-1090980440">PR review</a>.</p>



<a name="296223209"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296223209" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296223209">(Aug 30 2022 at 21:21)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/4826#discussion_r958939636">PR review comment</a>:</p>
<blockquote>
<p>I think this may have actually been the only place that <code>None</code> was passed in, so with this changing would it be possible to switch the alignment parameter to <code>u32</code> instead of <code>Option&lt;u32&gt;</code>?</p>
</blockquote>



<a name="296223210"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296223210" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296223210">(Aug 30 2022 at 21:21)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4826#pullrequestreview-1090980440">PR review</a>.</p>



<a name="296223211"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296223211" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296223211">(Aug 30 2022 at 21:21)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/4826#discussion_r958939817">PR review comment</a>:</p>
<blockquote>
<p>Could you leave a comment here for why this is 16? (reading this in isolation I'd naively expect it to be 1)</p>
</blockquote>



<a name="296223465"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296223465" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296223465">(Aug 30 2022 at 21:23)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4826#discussion_r958941590">PR review comment</a>:</p>
<blockquote>
<p>Can you also use this method in cranelift-object and cranelift-jit?</p>
</blockquote>



<a name="296223466"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296223466" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296223466">(Aug 30 2022 at 21:23)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4826#pullrequestreview-1090983373">PR review</a>.</p>



<a name="296224495"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296224495" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296224495">(Aug 30 2022 at 21:30)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4826#pullrequestreview-1090991247">PR review</a>.</p>



<a name="296224496"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296224496" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296224496">(Aug 30 2022 at 21:30)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4826#pullrequestreview-1090991247">PR review</a>.</p>



<a name="296224501"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296224501" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296224501">(Aug 30 2022 at 21:30)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/4826#discussion_r958947081">PR review comment</a>:</p>
<blockquote>
<p>I'm wondering if this is enough?</p>
<p>Specifically, couldn't we hit the same bug on aarch64, where:</p>
<ul>
<li>We have a constant that needs to be 16-byte-aligned (else fault);</li>
<li>We 16-align it in the function body;</li>
<li>But the function is only 4-aligned, and has a starting offset != 0 mod 16.</li>
</ul>
<p>So I think we need to either set <code>function_alignment</code> to the highest alignment statically that we know we use, or compute it dynamically based on the alignments actually present in the constant pool, on every architecture; otherwise we don't satisfy the alignment constraints.</p>
</blockquote>



<a name="296225109"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296225109" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296225109">(Aug 30 2022 at 21:35)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4826">PR #4826</a> from <code>trevor/fix-4812</code> to <code>main</code>.</p>



<a name="296225145"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296225145" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296225145">(Aug 30 2022 at 21:35)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4826#pullrequestreview-1090995932">PR review</a>.</p>



<a name="296225146"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296225146" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296225146">(Aug 30 2022 at 21:35)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/4826#discussion_r958950541">PR review comment</a>:</p>
<blockquote>
<p>Great point, added!</p>
</blockquote>



<a name="296225193"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296225193" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296225193">(Aug 30 2022 at 21:36)</a>:</h4>
<p><strong>elliottt</strong> has marked <a href="https://github.com/bytecodealliance/wasmtime/pull/4826">PR #4826</a> as ready for review.</p>



<a name="296225702"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296225702" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296225702">(Aug 30 2022 at 21:40)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/4826#discussion_r958953205">PR review comment</a>:</p>
<blockquote>
<p>cranelift-object already has support for specifying function alignment as the <code>function_alignment</code> field on <code>ObjectBuilder</code>, is that sufficient?</p>
<p>cranelift-jit takes an argument that implements <code>TargetIsa</code> already, do we need to modify it to ensure that it's emitting aligned function bodies?</p>
</blockquote>



<a name="296225703"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296225703" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296225703">(Aug 30 2022 at 21:40)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4826#pullrequestreview-1090999710">PR review</a>.</p>



<a name="296228340"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296228340" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296228340">(Aug 30 2022 at 22:03)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/4826#discussion_r958967161">PR review comment</a>:</p>
<blockquote>
<p>That's a good point. I'm going to include the minimum alignment requirement in the output when compiling the function, and then take the max of that and the isa function_alignment when emitting instructions.</p>
</blockquote>



<a name="296228341"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296228341" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296228341">(Aug 30 2022 at 22:03)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4826#pullrequestreview-1091018382">PR review</a>.</p>



<a name="296232259"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296232259" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296232259">(Aug 30 2022 at 22:44)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4826">PR #4826</a> from <code>trevor/fix-4812</code> to <code>main</code>.</p>



<a name="296233874"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296233874" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296233874">(Aug 30 2022 at 23:02)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/4826#discussion_r959002592">PR review comment</a>:</p>
<blockquote>
<p>Can we call this just <code>alignment</code>? From a consumer point of view, the <code>EmitResult</code> represents a blob of machine code that has to be placed somewhere, with an alignment specified here; the fact that this alignment requirement comes from our constant pool in this instance is sort of an incidental detail (and there could be other reasons later).</p>
</blockquote>



<a name="296233875"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296233875" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296233875">(Aug 30 2022 at 23:02)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4826#pullrequestreview-1091065318">PR review</a>.</p>



<a name="296233876"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296233876" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296233876">(Aug 30 2022 at 23:02)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4826#pullrequestreview-1091065318">PR review</a>.</p>



<a name="296234906"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296234906" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296234906">(Aug 30 2022 at 23:13)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4826">PR #4826</a> from <code>trevor/fix-4812</code> to <code>main</code>.</p>



<a name="296236230"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296236230" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296236230">(Aug 30 2022 at 23:30)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/4826#discussion_r959014347">PR review comment</a>:</p>
<blockquote>
<p>What do you think about removing the <code>function_alignment</code> field from <code>ObjectBuilder</code> and calling the <code>function_alignment()</code> function in <code>TargetIsa</code> instead? Also it looks like we'll need to slightly adapt the <code>Module</code> trait to pass through the individual function alignment requirements so that we can pick the largest one when emitting machine code. I've made that change on this branch, but held off on removing <code>function_alignment</code> from <code>ObjectBuilder</code>.</p>
<p>Looking through cranelift-jit, it seems like it always 16-byte aligns functions, so there might not be any work needed there.</p>
</blockquote>



<a name="296236231"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296236231" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296236231">(Aug 30 2022 at 23:30)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4826#pullrequestreview-1091080845">PR review</a>.</p>



<a name="296236261"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296236261" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296236261">(Aug 30 2022 at 23:31)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4826">PR #4826</a> from <code>trevor/fix-4812</code> to <code>main</code>.</p>



<a name="296353955"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296353955" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296353955">(Aug 31 2022 at 15:16)</a>:</h4>
<p>akirilov-arm submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4826#pullrequestreview-1092071244">PR review</a>.</p>



<a name="296353956"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296353956" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296353956">(Aug 31 2022 at 15:16)</a>:</h4>
<p>akirilov-arm created <a href="https://github.com/bytecodealliance/wasmtime/pull/4826#discussion_r959715493">PR review comment</a>:</p>
<blockquote>
<p>I don't think that this is much of a problem because the only instructions I can think of off the top of my head that have strict alignment requirements are the atomic instructions (or SP-relative operations, but they are not applicable in this case), and it sounds a bit unusual to apply them to literals in the instruction stream. Yes, it is possible to enable alignment checking for almost all relevant instructions, but I am not aware of any platform that does that, and in fact unaligned accesses by default is pretty much an aspect of the ABI at this point.</p>
<p>However, stricter function alignment is in fact recommended for performance reasons, i.e. to maximize fetch bandwidth. The recommendation for some of Arm's recent processors is 32 bytes.</p>
</blockquote>



<a name="296401791"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296401791" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296401791">(Aug 31 2022 at 16:29)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4826">PR #4826</a> from <code>trevor/fix-4812</code> to <code>main</code>.</p>



<a name="296402164"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296402164" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296402164">(Aug 31 2022 at 16:31)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/4826#discussion_r959794234">PR review comment</a>:</p>
<blockquote>
<p>@akirilov-arm is it worth changing this to <code>32</code> here, or should we leave that for another PR?</p>
</blockquote>



<a name="296402165"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296402165" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296402165">(Aug 31 2022 at 16:31)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4826#pullrequestreview-1092183905">PR review</a>.</p>



<a name="296403747"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296403747" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296403747">(Aug 31 2022 at 16:38)</a>:</h4>
<p>akirilov-arm submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4826#pullrequestreview-1092193797">PR review</a>.</p>



<a name="296403748"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296403748" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296403748">(Aug 31 2022 at 16:38)</a>:</h4>
<p>akirilov-arm created <a href="https://github.com/bytecodealliance/wasmtime/pull/4826#discussion_r959801396">PR review comment</a>:</p>
<blockquote>
<p>Doing it in this PR is fine, but you should add a comment that the value has been chosen for performance reasons; otherwise the correctness requirement is 4 bytes, as in your current code.</p>
</blockquote>



<a name="296424719"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296424719" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296424719">(Aug 31 2022 at 18:29)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4826">PR #4826</a> from <code>trevor/fix-4812</code> to <code>main</code>.</p>



<a name="296445918"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296445918" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296445918">(Aug 31 2022 at 20:40)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/4826#discussion_r960006768">PR review comment</a>:</p>
<blockquote>
<p>I changed this to <code>32</code> and added a comment, thanks!</p>
</blockquote>



<a name="296445919"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296445919" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296445919">(Aug 31 2022 at 20:40)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4826#pullrequestreview-1092485524">PR review</a>.</p>



<a name="296454591"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234826%20Align%20functions%20according%20to%20their%20IS.../near/296454591" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234826.20Align.20functions.20according.20to.20their.20IS.2E.2E.2E.html#296454591">(Aug 31 2022 at 21:41)</a>:</h4>
<p>elliottt merged <a href="https://github.com/bytecodealliance/wasmtime/pull/4826">PR #4826</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>