<html>
<head><meta charset="utf-8"><title>wasmtime / PR #9765  Add a guide for adding instructions ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html">wasmtime / PR #9765  Add a guide for adding instructions ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="486719960"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/486719960" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#486719960">(Dec 08 2024 at 00:55)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/9765">PR #9765</a> from <code>alexcrichton:pulley-new-instructions</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>In helping others contribute to Pulley I've written up the steps I took<br>
to make this commit itself. I've picked a random test in <code>misc_testsuite</code><br>
that previously didn't work on Pulley and was relatively small. I<br>
implemented a few lowerings and some new instructions and now the test<br>
passes. I've added <code>pulley/CONTRIBUTING.md</code> to document the experience<br>
along the way in case anyone else is interested to help out in the<br>
future.</p>
</blockquote>



<a name="486719961"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/486719961" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#486719961">(Dec 08 2024 at 00:55)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9765">PR #9765</a>.</p>



<a name="486719962"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/486719962" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#486719962">(Dec 08 2024 at 00:55)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9765">PR #9765</a>.</p>



<a name="486719963"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/486719963" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#486719963">(Dec 08 2024 at 00:55)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9765">PR #9765</a>.</p>



<a name="486719964"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/486719964" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#486719964">(Dec 08 2024 at 00:55)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers">wasmtime-default-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9765">PR #9765</a>.</p>



<a name="486720030"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/486720030" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#486720030">(Dec 08 2024 at 00:56)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/9765#issuecomment-2525364170">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9765">PR #9765</a>:</p>
<blockquote>
<p>I'll note that this is built on <a href="https://github.com/bytecodealliance/wasmtime/pull/9760">https://github.com/bytecodealliance/wasmtime/pull/9760</a> so only the last commit here is the guide part. </p>
</blockquote>



<a name="487028113"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487028113" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487028113">(Dec 09 2024 at 15:39)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9765">PR #9765</a>.</p>



<a name="487274746"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487274746" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487274746">(Dec 10 2024 at 15:19)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/9765#discussion_r1878194230">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>you're interested in helping to improve the situation. This is intended to be a
</code></pre></div><br>
</p>
</blockquote>



<a name="487274748"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487274748" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487274748">(Dec 10 2024 at 15:19)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/9765#discussion_r1878204227">PR review comment</a>:</p>
<blockquote>
<p>Just to make it more clear which args are for <code>cargo</code> and which are for <code>wasmtime</code>:</p>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>$ cargo run --features pulley -- wast --target pulley64 ./tests/misc_testsuite/control-flow.wast
````
~~~
</code></pre></div><br>
</p>
</blockquote>



<a name="487274749"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487274749" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487274749">(Dec 10 2024 at 15:19)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9765#pullrequestreview-2492492285">PR review</a>:</p>
<blockquote>
<p>Looks great!</p>
<p>I have a bunch of nitpicks and suggestions to make things flow a little smoother IMO or to link to other references and resources, but those are tiny nitpicks and this is fantastic.</p>
<p>Excited to start onboarding new contributors with this!</p>
</blockquote>



<a name="487274751"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487274751" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487274751">(Dec 10 2024 at 15:19)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/9765#discussion_r1878193285">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>## Adding an instruction to Pulley
</code></pre></div><br>
</p>
</blockquote>



<a name="487274752"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487274752" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487274752">(Dec 10 2024 at 15:19)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/9765#discussion_r1878277046">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>`cranelift/codegen/src/isa/pulley_shared/lower.isle`.

Our ISLE lowering rules are generally written like this:

\```lisp
(rule (lower &lt;CLIF&gt;)
      &lt;Pulley&gt;)
\```

This means "when lowering Cranelift's mid-level IR down to Pulley bytecode, and we match the snippet `&lt;CLIF&gt;`, replace it with `&lt;Pulley&gt;`". (For more details, see the [ISLE Language Reference](https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/isle/docs/language-reference.md) and [How ISLE is Integrated with Cranelift](https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/docs/isle-integration.md).)

In our case, we need to match an `sdiv` CLIF instruction that is operating on 32-bit values (this is the `(has_type $I32 ...)` bit) and then replace it with our new Pulley `xdiv32_s` instruction:
</code></pre></div><br>
</p>
</blockquote>



<a name="487274754"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487274754" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487274754">(Dec 10 2024 at 15:19)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/9765#discussion_r1878207606">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>the same test under a variety of configurations, but the test is expected to fail under Pulley. You can update the `WastTest::should_fail` method in
`crates/wast-util/src/lib.rs` to say the test is expected to pass, and then you
</code></pre></div><br>
</p>
</blockquote>



<a name="487274757"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487274757" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487274757">(Dec 10 2024 at 15:19)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/9765#discussion_r1878206364">PR review comment</a>:</p>
<blockquote>
<p>stray empty line<br>
</p>
</blockquote>



<a name="487274759"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487274759" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487274759">(Dec 10 2024 at 15:19)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/9765#discussion_r1878246443">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>method is used to specifically match the width and signedness of the instruction itself, signed
</code></pre></div><br>
</p>
</blockquote>



<a name="487274760"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487274760" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487274760">(Dec 10 2024 at 15:19)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/9765#discussion_r1878279670">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>Note that ISLE constructors for Pulley instructions, including the `pulley_xdivs32_s`
constructor for our new `xdiv32_s` Pulley instruction, are automatically
generated from the `for_each_op!` macro.
</code></pre></div><br>
</p>
</blockquote>



<a name="487274761"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487274761" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487274761">(Dec 10 2024 at 15:19)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/9765#discussion_r1878232816">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>This defines the snake-case name of the instruction (`xdiv32_s`) that is used by the disassembler and visitor trait, the upper-camel-case name of the instruction (`I32DivS`) used for the Rust type and `enum` variant, and immediates and operands in the instruction
itself. In this case it's a binary operation using integer ("x") registers.

Note: By convention, we tend to include the class ("x") and width ("32") of
registers operated upon by an instruction in its name. This distinguishes
between, for example, 32-bit integer addition (`xadd32`) and 64-bit floating
point addition (`fadd64`).
</code></pre></div><br>
</p>
</blockquote>



<a name="487274762"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487274762" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487274762">(Dec 10 2024 at 15:19)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/9765#discussion_r1878200689">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>for an up-to-date list check out the `WastTest::should_fail` method in `crates/wast-util/src/lib.rs`. Here we're going
</code></pre></div><br>
</p>
</blockquote>



<a name="487274763"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487274763" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487274763">(Dec 10 2024 at 15:19)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/9765#discussion_r1878290433">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>Success!

But we aren't quite done yet: the new lowerings we added might have made additional tests that previously failed start passing as well. If so, then we also want to mark those tests as expected to pass now. We can double check by running the full `wast` test suite:
</code></pre></div><br>
</p>
</blockquote>



<a name="487274764"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487274764" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487274764">(Dec 10 2024 at 15:19)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/9765#discussion_r1878239617">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>    |                 ---------------------------------------------------------------------------- `xdiv32_s` from trait
</code></pre></div><br>
</p>
</blockquote>



<a name="487274765"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487274765" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487274765">(Dec 10 2024 at 15:19)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/9765#discussion_r1878238683">PR review comment</a>:</p>
<blockquote>
<p>FWIW, I would probably name the instruction <code>xdivs32</code> but it really doesn't matter. What does matter is that the guide is consistent, so as not to confuse contributors:</p>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>error[E0046]: not all trait items implemented, missing: `xdiv32_s`
   --&gt; pulley/src/interp.rs:807:1
    |
807 | impl OpVisitor for Interpreter&lt;'_&gt; {
    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ missing `xdiv32_s` in implementation
</code></pre></div><br>
</p>
</blockquote>



<a name="487274766"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487274766" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487274766">(Dec 10 2024 at 15:19)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/9765#discussion_r1878284234">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>assertion is no longer true! Update the `WastTest::should_fail` method in `crates/wast-util/src/lib.rs` so that it expects the test to pass and we'll see:
</code></pre></div><br>
</p>
</blockquote>



<a name="487274769"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487274769" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487274769">(Dec 10 2024 at 15:19)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/9765#discussion_r1878296301">PR review comment</a>:</p>
<blockquote>
<p>Could we make <code>done_trap</code> generic over an instruction and then avoid the need to do <code>let me = self.current_pc::&lt;...&gt;();</code> and instead do</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">ControlFlow</span><span class="p">::</span><span class="n">Break</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">done_trap</span><span class="p">::</span><span class="o">&lt;..</span><span class="p">.</span><span class="o">&gt;</span><span class="p">())</span>
</code></pre></div>
<p>or even fold the <code>ControlFlow::Break</code> into the helper?</p>
<p>This both delays the computation until its demanded (which LLVM can probably do, but might be foiled if there are zero/overflow whatever checks hidden in there) and is a little more concise at usage/call sites.</p>
</blockquote>



<a name="487274783"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487274783" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487274783">(Dec 10 2024 at 15:20)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/9765#discussion_r1878251254">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>When we run our test again we don't get a compilation error anymore, but instead we see the ISLE lowering error again!

\`\`\`
$ cargo run --features pulley wast --target pulley64 ./tests/misc_testsuite/control-flow.wast
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.08s
     Running `target/debug/wasmtime wast --target pulley64 ./tests/misc_testsuite/control-flow.wast`
Error: failed to run script file './tests/misc_testsuite/control-flow.wast'
Caused by:
    0: failed directive on ./tests/misc_testsuite/control-flow.wast:77:1
    1: Compilation error: Unsupported feature: should be implemented in ISLE: inst = `v5 = sdiv.i32 v2, v3`, type = `Some(types::I32)`
\`\`\`

This leads us to the next part...
</code></pre></div><br>
</p>
</blockquote>



<a name="487281098"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487281098" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487281098">(Dec 10 2024 at 15:40)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9765#pullrequestreview-2492743134">PR review</a>.</p>



<a name="487281101"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487281101" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487281101">(Dec 10 2024 at 15:40)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9765#discussion_r1878337751">PR review comment</a>:</p>
<blockquote>
<p>Heh you can see I switched halfway through :)</p>
</blockquote>



<a name="487284519"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487284519" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487284519">(Dec 10 2024 at 15:51)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9765">PR #9765</a>.</p>



<a name="487284637"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487284637" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487284637">(Dec 10 2024 at 15:52)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9765#pullrequestreview-2492775139">PR review</a>.</p>



<a name="487284640"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487284640" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487284640">(Dec 10 2024 at 15:52)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9765#discussion_r1878357813">PR review comment</a>:</p>
<blockquote>
<p>Excellent idea <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
</blockquote>



<a name="487284704"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487284704" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487284704">(Dec 10 2024 at 15:52)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9765">PR #9765</a>.</p>



<a name="487290941"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487290941" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487290941">(Dec 10 2024 at 16:18)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/9765#discussion_r1878400137">PR review comment</a>:</p>
<blockquote>
<p>Maybe also link to this PR at the end?</p>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>To view the complete pull request that implemented `xdiv32_s` and `xand32` Pulley instructions and got `./tests/misc_testsuite/control-flow.wast` passing (and also introduced this documentation) check out https://github.com/bytecodealliance/wasmtime/pull/9765

Thanks for helping out!
</code></pre></div><br>
</p>
</blockquote>



<a name="487290942"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487290942" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487290942">(Dec 10 2024 at 16:18)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9765#pullrequestreview-2492846335">PR review</a>.</p>



<a name="487292084"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487292084" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487292084">(Dec 10 2024 at 16:23)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9765">PR #9765</a>.</p>



<a name="487292116"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487292116" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487292116">(Dec 10 2024 at 16:23)</a>:</h4>
<p>alexcrichton has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/9765">PR #9765</a>.</p>



<a name="487293585"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487293585" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487293585">(Dec 10 2024 at 16:30)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9765">PR #9765</a>.</p>



<a name="487301353"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239765%20%20Add%20a%20guide%20for%20adding%20instructions%20.../near/487301353" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239765.20.20Add.20a.20guide.20for.20adding.20instructions.20.2E.2E.2E.html#487301353">(Dec 10 2024 at 17:05)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/9765">PR #9765</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>