<html>
<head><meta charset="utf-8"><title>wasmtime / PR #2723 Mach ports continued + support aarch6... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html">wasmtime / PR #2723 Mach ports continued + support aarch6...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="230060570"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230060570" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230060570">(Mar 12 2021 at 16:40)</a>:</h4>
<p>bnjbvr opened <a href="https://github.com/bytecodealliance/wasmtime/pull/2723">PR #2723</a> from <code>mach-ports-continued</code> to <code>main</code>:</p>
<blockquote>
<p>This is #2632 rebased and continued. Many thanks to @alexcrichton for providing a lot of help with the CFI directives in the custom assembly stub; this really helped simplify the design of frame unwinding.</p>
<p>This is sufficient to make mach ports work on Mac M1, with the slight exception that the system's libunwind on this machine doesn't correctly interpret the CFI directives generated by the assembly stub. As a consequence, the stack trace information for wasm call frames is missing. Retrieving the source of another libunwind implementation, in Apple's LLVM fork or from the <a href="http://opensource.apple.com">opensource.apple.com</a> website, building it and linking it against wasmtime is sufficient to get it working as expected. In addition to this, some experiments showed that the system libunwind's source code doesn't match what's on Apple's repository: this was inferred from looking at an abort error message's line number, and seeing it didn't match the line number for the same message in local sources. As a matter of fact, this is impossible to debug as is. Yet it seemed better to have something that worked, even incompletely. In the future, either we can wait for a new functioning version of OSX libunwind, or we could consider shipping our own, as a small C/C++ dependency.</p>
<p>This is also blocked on <a href="https://github.com/fitzgen/mach/pull/64">https://github.com/fitzgen/mach/pull/64</a> to be landed and released first.</p>
<p>There's a bit more work to do to fully support Mac M1: I'm seeing WASI failures when trying to run the full test suite, to be handled in a second time.</p>
</blockquote>



<a name="230073466"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230073466" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230073466">(Mar 12 2021 at 18:07)</a>:</h4>
<p>bnjbvr updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2723">PR #2723</a> from <code>mach-ports-continued</code> to <code>main</code>.</p>



<a name="230322460"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230322460" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230322460">(Mar 15 2021 at 10:30)</a>:</h4>
<p>bnjbvr closed without merge <a href="https://github.com/bytecodealliance/wasmtime/pull/2723">PR #2723</a>.</p>



<a name="230322464"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230322464" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230322464">(Mar 15 2021 at 10:30)</a>:</h4>
<p>bnjbvr reopened <a href="https://github.com/bytecodealliance/wasmtime/pull/2723">PR #2723</a> from <code>mach-ports-continued</code> to <code>main</code>.</p>



<a name="230357813"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230357813" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230357813">(Mar 15 2021 at 14:55)</a>:</h4>
<p>bnjbvr updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2723">PR #2723</a> from <code>mach-ports-continued</code> to <code>main</code>.</p>



<a name="230364456"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230364456" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230364456">(Mar 15 2021 at 15:30)</a>:</h4>
<p>bnjbvr updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2723">PR #2723</a> from <code>mach-ports-continued</code> to <code>main</code>.</p>



<a name="230365226"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230365226" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230365226">(Mar 15 2021 at 15:35)</a>:</h4>
<p>bnjbvr updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2723">PR #2723</a> from <code>mach-ports-continued</code> to <code>main</code>.</p>



<a name="230373335"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230373335" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230373335">(Mar 15 2021 at 16:11)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#pullrequestreview-612347386">PR Review</a>.</p>



<a name="230373339"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230373339" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230373339">(Mar 15 2021 at 16:11)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#pullrequestreview-612347386">PR Review</a>.</p>



<a name="230373340"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230373340" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230373340">(Mar 15 2021 at 16:11)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#discussion_r594451658">PR Review Comment</a>:</p>
<blockquote>
<p>Could this be moved to the bottom of the loop since we'll only possibly hit this case after a resumption from a suspend?</p>
</blockquote>



<a name="230373341"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230373341" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230373341">(Mar 15 2021 at 16:11)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#discussion_r594466362">PR Review Comment</a>:</p>
<blockquote>
<p>You know, thinking about it, we could probably store these values in volatile registers like x3/4, and the unwinding information could restore the information from those registers rather than from the stack possibly. That may avoid needing a stack allocation here at all.</p>
<p>(or we could store them in callee-save registers which are more likely to be restored when unwinding in native code)</p>
</blockquote>



<a name="230373342"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230373342" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230373342">(Mar 15 2021 at 16:11)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#discussion_r594467768">PR Review Comment</a>:</p>
<blockquote>
<p>eh I wouldn't really say that this function has a signature  because it's not natively callable, but this could perhaps describe the input register expectations.</p>
</blockquote>



<a name="230373343"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230373343" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230373343">(Mar 15 2021 at 16:11)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#discussion_r594464744">PR Review Comment</a>:</p>
<blockquote>
<p>Does overwriting <code>fp</code> need to happen? I think that the unwinding from the assembly stub doesn't restore this overwritten value as well?</p>
</blockquote>



<a name="230373344"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230373344" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230373344">(Mar 15 2021 at 16:11)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#discussion_r594459428">PR Review Comment</a>:</p>
<blockquote>
<p>(that may also remove the need to call <code>lazy_per_thread_init</code> manually)</p>
</blockquote>



<a name="230373345"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230373345" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230373345">(Mar 15 2021 at 16:11)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#discussion_r594459166">PR Review Comment</a>:</p>
<blockquote>
<p>I think with thread-switching support this map will need to be updated when async wasm crosses thread. I think in <code>TlsRestore::take</code> we'd remove something from this map and in <code>TlsRestore::restore</code> we'd re-insert back into the map.</p>
</blockquote>



<a name="230391879"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230391879" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230391879">(Mar 15 2021 at 18:01)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#pullrequestreview-612473714">PR Review</a>.</p>



<a name="230391880"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230391880" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230391880">(Mar 15 2021 at 18:01)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#discussion_r594560246">PR Review Comment</a>:</p>
<blockquote>
<p>"strictly different from LR" instead?</p>
</blockquote>



<a name="230391881"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230391881" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230391881">(Mar 15 2021 at 18:01)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#pullrequestreview-612473714">PR Review</a>.</p>



<a name="230391882"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230391882" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230391882">(Mar 15 2021 at 18:01)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#discussion_r594548672">PR Review Comment</a>:</p>
<blockquote>
<p>Can we link the SpiderMonkey source here (e.g. via Searchfox)?</p>
</blockquote>



<a name="230391883"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230391883" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230391883">(Mar 15 2021 at 18:01)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#discussion_r594563285">PR Review Comment</a>:</p>
<blockquote>
<p>I <em>think</em> it's necessary because there is no saved FP in the unwinding info for the stub (?) -- the 16-byte pushed frame is the pair (x3, LR). But then, why <code>SP + 16</code> rather than the actual prior <code>FP</code> value?</p>
</blockquote>



<a name="230391884"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230391884" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230391884">(Mar 15 2021 at 18:01)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#discussion_r594562125">PR Review Comment</a>:</p>
<blockquote>
<p>The overall flow here was slightly unclear to me at first -- it might be good to add a figure summarizing how the stack is manipulated (here or where the frame is created in <a href="http://traphandlers.rs">traphandlers.rs</a>, doesn't matter much).</p>
</blockquote>



<a name="230488442"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230488442" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230488442">(Mar 16 2021 at 10:20)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#discussion_r595033268">PR Review Comment</a>:</p>
<blockquote>
<p>Indeed! What I did was subtle: the <code>raw::replace</code> function was also registering the new CallThreadState for this thread, so it was done by the <code>raw::replace</code> calls in <code>TlsRestore::take</code> and <code>TlsRestore::restore</code>. The missing piece was to call the lazy per thread init in restore, as we might have crossed a thread boundary there. Commented to this effect. It's much simpler, thanks.</p>
</blockquote>



<a name="230488443"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230488443" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230488443">(Mar 16 2021 at 10:20)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#pullrequestreview-613068747">PR Review</a>.</p>



<a name="230493275"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230493275" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230493275">(Mar 16 2021 at 11:05)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#pullrequestreview-613110851">PR Review</a>.</p>



<a name="230493276"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230493276" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230493276">(Mar 16 2021 at 11:05)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#discussion_r595066486">PR Review Comment</a>:</p>
<blockquote>
<p>Good idea, done!</p>
</blockquote>



<a name="230512171"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230512171" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230512171">(Mar 16 2021 at 13:34)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#pullrequestreview-613247645">PR Review</a>.</p>



<a name="230512172"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230512172" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230512172">(Mar 16 2021 at 13:34)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#discussion_r595172502">PR Review Comment</a>:</p>
<blockquote>
<p>Alex is right, we were not restoring its value; it appears to work equally well without it, so I've removed it.</p>
</blockquote>



<a name="230512346"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230512346" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230512346">(Mar 16 2021 at 13:35)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#pullrequestreview-613248945">PR Review</a>.</p>



<a name="230512347"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230512347" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230512347">(Mar 16 2021 at 13:35)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#discussion_r595173437">PR Review Comment</a>:</p>
<blockquote>
<p>I've tried this, and it doesn't work; apparently libunwind reaaaally wants to restore the register value from the CFA. Tried both <code>cfa_register x3, x3</code> or <code>cfa_same_value x3</code> to indicate the value hadn't changed, but this wasn't apparently sufficient. Oh well.</p>
<p>Any concern about doing it this way? I think it should be fine, even in case of stack overflow, because we should have some ballast before the actual stack overflow guard page, etc.</p>
</blockquote>



<a name="230512588"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230512588" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230512588">(Mar 16 2021 at 13:36)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#pullrequestreview-613250887">PR Review</a>.</p>



<a name="230512590"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230512590" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230512590">(Mar 16 2021 at 13:36)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#discussion_r595174972">PR Review Comment</a>:</p>
<blockquote>
<p>btw, it was only necessary to save pc, not LR: in the cranelift generated prologue of wasm functions, LR is saved, with an accompanying cfi directive, so there's no need to save it ourselves.</p>
</blockquote>



<a name="230514341"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230514341" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230514341">(Mar 16 2021 at 13:48)</a>:</h4>
<p>bnjbvr updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2723">PR #2723</a> from <code>mach-ports-continued</code> to <code>main</code>.</p>



<a name="230518922"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230518922" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230518922">(Mar 16 2021 at 14:15)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#pullrequestreview-613298078">PR Review</a>.</p>



<a name="230518923"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230518923" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230518923">(Mar 16 2021 at 14:15)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#discussion_r595210184">PR Review Comment</a>:</p>
<blockquote>
<p>Nah no concerns, just wondering if we could be super clever. Now's probably not the time to be clever though!</p>
</blockquote>



<a name="230519653"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230519653" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230519653">(Mar 16 2021 at 14:20)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#pullrequestreview-613303754">PR Review</a>.</p>



<a name="230519654"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230519654" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230519654">(Mar 16 2021 at 14:20)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#discussion_r595214570">PR Review Comment</a>:</p>
<blockquote>
<p>This feels somewhat iffy to me that we rely on Cranelift to restore <code>lr</code> to unwind since this <code>blr</code> is otherwise overwriting the value of the wasm frame's <code>lr</code>. In the future if we optimize cranelift to not save <code>lr</code> to the stack for leaf functions, for example, we'd have to update this?</p>
<p>I figured it was easy enough to push <code>lr</code> to the stack and have a CFI directive for how to restore it?</p>
</blockquote>



<a name="230530788"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230530788" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230530788">(Mar 16 2021 at 15:16)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#pullrequestreview-613378615">PR Review</a>.</p>



<a name="230530791"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230530791" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230530791">(Mar 16 2021 at 15:16)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#discussion_r595270284">PR Review Comment</a>:</p>
<blockquote>
<p>As discussed on zulip, turns out we can even:</p>
<ul>
<li>set <code>lr</code> from the faulting pc</li>
<li>jump to unwind directly</li>
<li>burn the assembly stub with <span aria-label="fire" class="emoji emoji-1f525" role="img" title="fire">:fire:</span> </li>
</ul>
<p>I tried doing something like this a week or so ago, but it wasn't working (probably because of the intertwined return-address signing issue!). Good riddance!</p>
</blockquote>



<a name="230534282"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230534282" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230534282">(Mar 16 2021 at 15:35)</a>:</h4>
<p>bnjbvr updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2723">PR #2723</a> from <code>mach-ports-continued</code> to <code>main</code>.</p>



<a name="230661427"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230661427" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230661427">(Mar 17 2021 at 09:32)</a>:</h4>
<p>bnjbvr updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2723">PR #2723</a> from <code>mach-ports-continued</code> to <code>main</code>.</p>



<a name="230666377"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230666377" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230666377">(Mar 17 2021 at 10:13)</a>:</h4>
<p>bnjbvr updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2723">PR #2723</a> from <code>mach-ports-continued</code> to <code>main</code>.</p>



<a name="230701361"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232723%20Mach%20ports%20continued%20%2B%20support%20aarch6.../near/230701361" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232723.20Mach.20ports.20continued.20.2B.20support.20aarch6.2E.2E.2E.html#230701361">(Mar 17 2021 at 14:43)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/2723">PR #2723</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>