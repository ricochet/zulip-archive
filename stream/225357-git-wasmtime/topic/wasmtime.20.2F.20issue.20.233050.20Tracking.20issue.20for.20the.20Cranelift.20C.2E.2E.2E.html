<html>
<head><meta charset="utf-8"><title>wasmtime / issue #3050 Tracking issue for the Cranelift C... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html">wasmtime / issue #3050 Tracking issue for the Cranelift C...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="244549125"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/244549125" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#244549125">(Jul 01 2021 at 11:03)</a>:</h4>
<p>afonso360 opened <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<p>In #3038 we introduced the initial version of the Cranelift CLIF-level differential fuzzer. </p>
<p>This fuzzer generates CLIF modules that are run on the interpreter and subsequently on the host machine (assuming no traps / invalid memory accesses) comparing the outputs of each run.</p>
<p>Roadmap:</p>
<ul>
<li>[x] Initial introduction (#3038)</li>
<li>[ ] Generating test inputs with control flow</li>
<li>[ ] Generating calls (just to builtins/intrinsics? or just between multiple functions in one testcase?)</li>
<li>[ ] Generating memory loads/stores (stack and heap)<ul>
<li>[ ] Catch out of bounds memory accesses in the interpreter</li>
</ul>
</li>
<li>[ ] Full coverage of arithmetic ops<ul>
<li>[ ] Extend the codegen in the <code>cranelift-meta</code> crate to provide a table of acceptable opcodes and types</li>
</ul>
</li>
<li>[ ] Full coverage of SIMD ops</li>
</ul>
</blockquote>



<a name="246373244"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/246373244" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#246373244">(Jul 18 2021 at 11:41)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<p>In #3038 we introduced the initial version of the Cranelift CLIF-level differential fuzzer. </p>
<p>This fuzzer generates CLIF modules that are run on the interpreter and subsequently on the host machine (assuming no traps / invalid memory accesses) comparing the outputs of each run.</p>
<p>Roadmap:</p>
<ul>
<li>[x] Initial introduction (#3038)</li>
<li>[ ] Generating test inputs with control flow<ul>
<li>[ ] Generate multiple blocks and basic jump instructions (#3094)</li>
<li>[ ] Generate <code>brtable</code>'s, <code>brif</code>, <code>brff</code> branches</li>
</ul>
</li>
<li>[ ] Generating calls (just to builtins/intrinsics? or just between multiple functions in one testcase?)</li>
<li>[ ] Generating memory loads/stores (stack and heap)<ul>
<li>[ ] Catch out of bounds memory accesses in the interpreter</li>
</ul>
</li>
<li>[ ] Full coverage of arithmetic ops<ul>
<li>[ ] Extend the codegen in the <code>cranelift-meta</code> crate to provide a table of acceptable opcodes and types</li>
</ul>
</li>
<li>[ ] Full coverage of SIMD ops</li>
</ul>
</blockquote>



<a name="246697971"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/246697971" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#246697971">(Jul 21 2021 at 09:42)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<p>In #3038 we introduced the initial version of the Cranelift CLIF-level differential fuzzer. </p>
<p>This fuzzer generates CLIF modules that are run on the interpreter and subsequently on the host machine (assuming no traps / invalid memory accesses) comparing the outputs of each run.</p>
<p>Roadmap:</p>
<ul>
<li>[x] Initial introduction (#3038)</li>
<li>[ ] Generating test inputs with control flow<ul>
<li>[ ] Generate multiple blocks and basic jump instructions (#3094)</li>
<li>[ ] Generate <code>brtable</code>'s</li>
<li>[ ] Generate <code>brif</code>, <code>brff</code>? (Are these staying after the legacy x86 backend is removed?)</li>
</ul>
</li>
<li>[ ] Generating calls (just to builtins/intrinsics? or just between multiple functions in one testcase?)</li>
<li>[ ] Generating memory loads/stores (stack and heap)<ul>
<li>[ ] Catch out of bounds memory accesses in the interpreter</li>
</ul>
</li>
<li>[ ] Full coverage of arithmetic ops<ul>
<li>[ ] Extend the codegen in the <code>cranelift-meta</code> crate to provide a table of acceptable opcodes and types</li>
</ul>
</li>
<li>[ ] Full coverage of SIMD ops</li>
</ul>
</blockquote>



<a name="246697988"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/246697988" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#246697988">(Jul 21 2021 at 09:42)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<p>In #3038 we introduced the initial version of the Cranelift CLIF-level differential fuzzer. </p>
<p>This fuzzer generates CLIF modules that are run on the interpreter and subsequently on the host machine (assuming no traps / invalid memory accesses) comparing the outputs of each run.</p>
<p>Roadmap:</p>
<ul>
<li>[x] Initial introduction (#3038)</li>
<li>[ ] Generating test inputs with control flow<ul>
<li>[ ] Generate multiple blocks and basic jump instructions (#3094)</li>
<li>[ ] Generate <code>br_table</code>'s</li>
<li>[ ] Generate <code>brif</code>, <code>brff</code>? (Are these staying after the legacy x86 backend is removed?)</li>
</ul>
</li>
<li>[ ] Generating calls (just to builtins/intrinsics? or just between multiple functions in one testcase?)</li>
<li>[ ] Generating memory loads/stores (stack and heap)<ul>
<li>[ ] Catch out of bounds memory accesses in the interpreter</li>
</ul>
</li>
<li>[ ] Full coverage of arithmetic ops<ul>
<li>[ ] Extend the codegen in the <code>cranelift-meta</code> crate to provide a table of acceptable opcodes and types</li>
</ul>
</li>
<li>[ ] Full coverage of SIMD ops</li>
</ul>
</blockquote>



<a name="251923564"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/251923564" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#251923564">(Sep 03 2021 at 18:29)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<p>In #3038 we introduced the initial version of the Cranelift CLIF-level differential fuzzer. </p>
<p>This fuzzer generates CLIF modules that are run on the interpreter and subsequently on the host machine (assuming no traps / invalid memory accesses) comparing the outputs of each run.</p>
<p>Roadmap:</p>
<ul>
<li>[x] Initial introduction (#3038)</li>
<li>[x] Generating test inputs with control flow<ul>
<li>[x] Generate multiple blocks and basic jump instructions (#3094)</li>
<li>[ ] Generate <code>br_table</code>'s and other jump table jumps</li>
</ul>
</li>
<li>[ ] Generating memory loads/stores (stack and heap)<ul>
<li>[x] Add stack support to the interpreter with virtual addresses (#3187)</li>
<li>[ ] Add heap support to the interpreter with virtual addresses</li>
</ul>
</li>
<li>[ ] Generating calls (just to builtins/intrinsics? or just between multiple functions in one testcase?)</li>
<li>[ ] Full coverage of arithmetic ops<ul>
<li>[ ] Extend the codegen in the <code>cranelift-meta</code> crate to provide a table of acceptable opcodes and types</li>
</ul>
</li>
<li>[ ] Full coverage of SIMD ops</li>
</ul>
</blockquote>



<a name="251925258"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/251925258" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#251925258">(Sep 03 2021 at 18:43)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<p>In #3038 we introduced the initial version of the Cranelift CLIF-level differential fuzzer. </p>
<p>This fuzzer generates CLIF modules that are run on the interpreter and subsequently on the host machine (assuming no traps / invalid memory accesses) comparing the outputs of each run.</p>
<p>Roadmap:</p>
<ul>
<li>[x] Initial introduction (#3038)</li>
<li>[x] Generating test inputs with control flow<ul>
<li>[x] Generate multiple blocks and basic jump instructions (#3094)</li>
<li>[ ] Generate <code>br_table</code>'s and other jump table jumps (#3299)</li>
</ul>
</li>
<li>[ ] Generating memory loads/stores (stack and heap)<ul>
<li>[x] Add stack support to the interpreter with virtual addresses (#3187)</li>
<li>[ ] Add heap support to the interpreter with virtual addresses</li>
</ul>
</li>
<li>[ ] Generating calls (just to builtins/intrinsics? or just between multiple functions in one testcase?)</li>
<li>[ ] Full coverage of arithmetic ops<ul>
<li>[ ] Extend the codegen in the <code>cranelift-meta</code> crate to provide a table of acceptable opcodes and types</li>
</ul>
</li>
<li>[ ] Full coverage of SIMD ops</li>
</ul>
</blockquote>



<a name="252210213"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/252210213" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#252210213">(Sep 06 2021 at 18:37)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<p>In #3038 we introduced the initial version of the Cranelift CLIF-level differential fuzzer. </p>
<p>This fuzzer generates CLIF modules that are run on the interpreter and subsequently on the host machine (assuming no traps / invalid memory accesses) comparing the outputs of each run.</p>
<p>Roadmap:</p>
<ul>
<li>[x] Initial introduction (#3038)</li>
<li>[x] Generating test inputs with control flow<ul>
<li>[x] Generate multiple blocks and basic jump instructions (#3094)</li>
<li>[x] Generate <code>br_table</code>'s and other jump table jumps (#3299)</li>
</ul>
</li>
<li>[ ] Generating memory loads/stores (stack and heap)<ul>
<li>[x] Add stack support to the interpreter with virtual addresses (#3187)</li>
<li>[ ] Add heap support to the interpreter with virtual addresses</li>
</ul>
</li>
<li>[ ] Generating calls (just to builtins/intrinsics? or just between multiple functions in one testcase?)</li>
<li>[ ] Full coverage of arithmetic ops<ul>
<li>[ ] Extend the codegen in the <code>cranelift-meta</code> crate to provide a table of acceptable opcodes and types</li>
</ul>
</li>
<li>[ ] Full coverage of SIMD ops</li>
</ul>
</blockquote>



<a name="252210260"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/252210260" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#252210260">(Sep 06 2021 at 18:37)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<p>In #3038 we introduced the initial version of the Cranelift CLIF-level differential fuzzer. </p>
<p>This fuzzer generates CLIF modules that are run on the interpreter and subsequently on the host machine (assuming no traps / invalid memory accesses) comparing the outputs of each run.</p>
<p>Roadmap:</p>
<ul>
<li>[x] Initial introduction (#3038)</li>
<li>[x] Generating test inputs with control flow<ul>
<li>[x] Generate multiple blocks and basic jump instructions (#3094)</li>
<li>[x] Generate <code>br_table</code>'s and other jump table jumps (#3299)</li>
</ul>
</li>
<li>[ ] Generating memory loads/stores (stack and heap)<ul>
<li>[x] Add stack support to the interpreter with virtual addresses (#3187)</li>
<li>[ ] Add heap support to the interpreter with virtual addresses (#3302)</li>
</ul>
</li>
<li>[ ] Generating calls (just to builtins/intrinsics? or just between multiple functions in one testcase?)</li>
<li>[ ] Full coverage of arithmetic ops<ul>
<li>[ ] Extend the codegen in the <code>cranelift-meta</code> crate to provide a table of acceptable opcodes and types</li>
</ul>
</li>
<li>[ ] Full coverage of SIMD ops</li>
</ul>
</blockquote>



<a name="252935400"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/252935400" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#252935400">(Sep 11 2021 at 21:04)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<p>In #3038 we introduced the initial version of the Cranelift CLIF-level differential fuzzer. </p>
<p>This fuzzer generates CLIF modules that are run on the interpreter and subsequently on the host machine (assuming no traps / invalid memory accesses) comparing the outputs of each run.</p>
<p>Roadmap:</p>
<ul>
<li>[x] Initial introduction (#3038)</li>
<li>[x] Generating test inputs with control flow<ul>
<li>[x] Generate multiple blocks and basic jump instructions (#3094)</li>
<li>[x] Generate <code>br_table</code>'s and other jump table jumps (#3299)</li>
</ul>
</li>
<li>[ ] Generating memory loads/stores (stack and heap)<ul>
<li>[x] Add stack support to the interpreter with virtual addresses (#3187)</li>
<li>[ ] Add heap support to the interpreter with virtual addresses (#3302)</li>
<li>[ ] Cross endianness support for loads/store</li>
</ul>
</li>
<li>[ ] Generating calls (just to builtins/intrinsics? or just between multiple functions in one testcase?)</li>
<li>[ ] Full coverage of arithmetic ops<ul>
<li>[ ] Extend the codegen in the <code>cranelift-meta</code> crate to provide a table of acceptable opcodes and types</li>
</ul>
</li>
<li>[ ] Full coverage of SIMD ops</li>
</ul>
</blockquote>



<a name="252935554"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/252935554" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#252935554">(Sep 11 2021 at 21:07)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<p>In #3038 we introduced the initial version of the Cranelift CLIF-level differential fuzzer. </p>
<p>This fuzzer generates CLIF modules that are run on the interpreter and subsequently on the host machine (assuming no traps / invalid memory accesses) comparing the outputs of each run.</p>
<p>Roadmap:</p>
<ul>
<li>[x] Initial introduction (#3038)</li>
<li>[x] Generating test inputs with control flow<ul>
<li>[x] Generate multiple blocks and basic jump instructions (#3094)</li>
<li>[x] Generate <code>br_table</code>'s and other jump table jumps (#3299)</li>
</ul>
</li>
<li>[ ] Generating memory loads/stores (stack and heap)<ul>
<li>[x] Add stack support to the interpreter with virtual addresses (#3187)</li>
<li>[ ] Add heap support to the interpreter with virtual addresses (#3302)</li>
<li>[ ] Cross endianness support for loads/stores</li>
</ul>
</li>
<li>[ ] Generating calls (just to builtins/intrinsics? or just between multiple functions in one testcase?)</li>
<li>[ ] Full coverage of arithmetic ops<ul>
<li>[ ] Extend the codegen in the <code>cranelift-meta</code> crate to provide a table of acceptable opcodes and types</li>
</ul>
</li>
<li>[ ] Full coverage of SIMD ops</li>
</ul>
</blockquote>



<a name="252936422"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/252936422" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#252936422">(Sep 11 2021 at 21:23)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<p>In #3038 we introduced the initial version of the Cranelift CLIF-level differential fuzzer. </p>
<p>This fuzzer generates CLIF modules that are run on the interpreter and subsequently on the host machine (assuming no traps / invalid memory accesses) comparing the outputs of each run.</p>
<p>Roadmap:</p>
<ul>
<li>[x] Initial introduction (#3038)</li>
<li>[x] Generating test inputs with control flow<ul>
<li>[x] Generate multiple blocks and basic jump instructions (#3094)</li>
<li>[x] Generate <code>br_table</code>'s and other jump table jumps (#3299)</li>
</ul>
</li>
<li>[ ] Generating memory loads/stores (stack and heap)<ul>
<li>[x] Add stack support to the interpreter with virtual addresses (#3187)</li>
<li>[ ] Add heap support to the interpreter with virtual addresses (#3302)</li>
<li>[ ] Cross endianness loads/stores</li>
</ul>
</li>
<li>[ ] Generating calls (just to builtins/intrinsics? or just between multiple functions in one testcase?)</li>
<li>[ ] Full coverage of arithmetic ops<ul>
<li>[ ] Extend the codegen in the <code>cranelift-meta</code> crate to provide a table of acceptable opcodes and types</li>
</ul>
</li>
<li>[ ] Full coverage of SIMD ops</li>
</ul>
</blockquote>



<a name="255809442"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/255809442" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#255809442">(Oct 01 2021 at 21:22)</a>:</h4>
<p>akirilov-arm labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<p>In #3038 we introduced the initial version of the Cranelift CLIF-level differential fuzzer. </p>
<p>This fuzzer generates CLIF modules that are run on the interpreter and subsequently on the host machine (assuming no traps / invalid memory accesses) comparing the outputs of each run.</p>
<p>Roadmap:</p>
<ul>
<li>[x] Initial introduction (#3038)</li>
<li>[x] Generating test inputs with control flow<ul>
<li>[x] Generate multiple blocks and basic jump instructions (#3094)</li>
<li>[x] Generate <code>br_table</code>'s and other jump table jumps (#3299)</li>
</ul>
</li>
<li>[ ] Generating memory loads/stores (stack and heap)<ul>
<li>[x] Add stack support to the interpreter with virtual addresses (#3187)</li>
<li>[ ] Add heap support to the interpreter with virtual addresses (#3302)</li>
<li>[ ] Cross endianness loads/stores</li>
</ul>
</li>
<li>[ ] Generating calls (just to builtins/intrinsics? or just between multiple functions in one testcase?)</li>
<li>[ ] Full coverage of arithmetic ops<ul>
<li>[ ] Extend the codegen in the <code>cranelift-meta</code> crate to provide a table of acceptable opcodes and types</li>
</ul>
</li>
<li>[ ] Full coverage of SIMD ops</li>
</ul>
</blockquote>



<a name="289209004"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/289209004" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#289209004">(Jul 11 2022 at 15:36)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<p>In #3038 we introduced the initial version of the Cranelift CLIF-level differential fuzzer. </p>
<p>This fuzzer generates CLIF modules that are run on the interpreter and subsequently on the host machine (assuming no traps / invalid memory accesses) comparing the outputs of each run.</p>
<p>Roadmap:</p>
<ul>
<li>[x] Initial introduction (#3038)</li>
<li>[x] Generating test inputs with control flow<ul>
<li>[x] Generate multiple blocks and basic jump instructions (#3094)</li>
<li>[x] Generate <code>br_table</code>'s and other jump table jumps (#3299)</li>
</ul>
</li>
<li>[ ] Generating memory loads/stores (stack and heap)<ul>
<li>[x] Add stack support to the interpreter with virtual addresses (#3187)</li>
<li>[x] Add heap support to the interpreter with virtual addresses (#3302)</li>
<li>[ ] Cross endianness loads/stores</li>
</ul>
</li>
<li>[ ] Generating calls (just to builtins/intrinsics? or just between multiple functions in one testcase?)</li>
<li>[ ] Full coverage of arithmetic ops<ul>
<li>[ ] Extend the codegen in the <code>cranelift-meta</code> crate to provide a table of acceptable opcodes and types</li>
</ul>
</li>
<li>[ ] Full coverage of SIMD ops</li>
</ul>
</blockquote>



<a name="289209866"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/289209866" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#289209866">(Jul 11 2022 at 15:41)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<p>In #3038 we introduced the initial version of the Cranelift CLIF-level differential fuzzer. </p>
<p>This fuzzer generates CLIF modules that are run on the interpreter and subsequently on the host machine (assuming no traps / invalid memory accesses) comparing the outputs of each run.</p>
<p>Roadmap:</p>
<ul>
<li>[x] Initial introduction (#3038)</li>
<li>[x] Generating test inputs with control flow<ul>
<li>[x] Generate multiple blocks and basic jump instructions (#3094)</li>
<li>[x] Generate <code>br_table</code>'s and other jump table jumps (#3299)</li>
</ul>
</li>
<li>[ ] Generating memory loads/stores (stack and heap)<ul>
<li>[x] Add stack support to the interpreter with virtual addresses (#3187)</li>
<li>[x] Add heap support to the interpreter with virtual addresses (#3302)</li>
<li>[ ] Add table support to the interpreter with virtual addresses</li>
<li>[ ] Cross endianness loads/stores</li>
</ul>
</li>
<li>[ ] Generating calls (just to builtins/intrinsics? or just between multiple functions in one testcase?)</li>
<li>[ ] Full coverage of arithmetic ops<ul>
<li>[ ] Extend the codegen in the <code>cranelift-meta</code> crate to provide a table of acceptable opcodes and types</li>
</ul>
</li>
<li>[ ] Full coverage of SIMD ops</li>
</ul>
</blockquote>



<a name="289210271"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/289210271" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#289210271">(Jul 11 2022 at 15:44)</a>:</h4>
<p>jameysharp labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<p>In #3038 we introduced the initial version of the Cranelift CLIF-level differential fuzzer. </p>
<p>This fuzzer generates CLIF modules that are run on the interpreter and subsequently on the host machine (assuming no traps / invalid memory accesses) comparing the outputs of each run.</p>
<p>Roadmap:</p>
<ul>
<li>[x] Initial introduction (#3038)</li>
<li>[x] Generating test inputs with control flow<ul>
<li>[x] Generate multiple blocks and basic jump instructions (#3094)</li>
<li>[x] Generate <code>br_table</code>'s and other jump table jumps (#3299)</li>
</ul>
</li>
<li>[ ] Generating memory loads/stores (stack and heap)<ul>
<li>[x] Add stack support to the interpreter with virtual addresses (#3187)</li>
<li>[x] Add heap support to the interpreter with virtual addresses (#3302)</li>
<li>[ ] Add table support to the interpreter with virtual addresses</li>
<li>[ ] Cross endianness loads/stores</li>
</ul>
</li>
<li>[ ] Generating calls (just to builtins/intrinsics? or just between multiple functions in one testcase?)</li>
<li>[ ] Full coverage of arithmetic ops<ul>
<li>[ ] Extend the codegen in the <code>cranelift-meta</code> crate to provide a table of acceptable opcodes and types</li>
</ul>
</li>
<li>[ ] Full coverage of SIMD ops</li>
</ul>
</blockquote>



<a name="289210476"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/289210476" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#289210476">(Jul 11 2022 at 15:45)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/issues/3050#issuecomment-1180573683">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "fuzzing"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>fitzgen: fuzzing</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="289443421"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/289443421" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#289443421">(Jul 13 2022 at 11:18)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<p>In #3038 we introduced the initial version of the Cranelift CLIF-level differential fuzzer. </p>
<p>This fuzzer generates CLIF modules that are run on the interpreter and subsequently on the host machine (assuming no traps / invalid memory accesses) comparing the outputs of each run.</p>
<p>Roadmap:</p>
<ul>
<li>[x] Initial introduction (#3038)</li>
<li>[x] Generating test inputs with control flow<ul>
<li>[x] Generate multiple blocks and basic jump instructions (#3094)</li>
<li>[x] Generate <code>br_table</code>'s and other jump table jumps (#3299)</li>
</ul>
</li>
<li>[ ] Generating memory loads/stores (stack and heap)<ul>
<li>[x] Add stack support to the interpreter with virtual addresses (#3187)</li>
<li>[x] Add heap support to the interpreter with virtual addresses (#3302)</li>
<li>[ ] Add table support to the interpreter with virtual addresses (#4433)</li>
<li>[ ] Generate Stack Load/Store instructions on fuzzgen (#4438)</li>
<li>[ ] Cross endianness loads/stores</li>
</ul>
</li>
<li>[ ] Generating calls (just to builtins/intrinsics? or just between multiple functions in one testcase?)</li>
<li>[ ] Full coverage of arithmetic ops<ul>
<li>[ ] Extend the codegen in the <code>cranelift-meta</code> crate to provide a table of acceptable opcodes and types</li>
</ul>
</li>
<li>[ ] Full coverage of SIMD ops</li>
</ul>
</blockquote>



<a name="289577216"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/289577216" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#289577216">(Jul 14 2022 at 11:05)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<p>In #3038 we introduced the initial version of the Cranelift CLIF-level differential fuzzer. </p>
<p>This fuzzer generates CLIF modules that are run on the interpreter and subsequently on the host machine (assuming no traps / invalid memory accesses) comparing the outputs of each run.</p>
<p>Roadmap:</p>
<ul>
<li>[x] Initial introduction (#3038)</li>
<li>[x] Generating test inputs with control flow<ul>
<li>[x] Generate multiple blocks and basic jump instructions (#3094)</li>
<li>[x] Generate <code>br_table</code>'s and other jump table jumps (#3299)</li>
</ul>
</li>
<li>[ ] Generating memory loads/stores (stack and heap)<ul>
<li>[x] Add stack support to the interpreter with virtual addresses (#3187)</li>
<li>[x] Add heap support to the interpreter with virtual addresses (#3302)</li>
<li>[x] Add table support to the interpreter with virtual addresses (#4433)</li>
<li>[ ] Generate Stack Load/Store instructions on fuzzgen (#4438)</li>
<li>[ ] Cross endianness loads/stores</li>
</ul>
</li>
<li>[ ] Generating calls (just to builtins/intrinsics? or just between multiple functions in one testcase?)</li>
<li>[ ] Full coverage of arithmetic ops<ul>
<li>[ ] Extend the codegen in the <code>cranelift-meta</code> crate to provide a table of acceptable opcodes and types</li>
</ul>
</li>
<li>[ ] Full coverage of SIMD ops</li>
</ul>
</blockquote>



<a name="289577220"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/289577220" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#289577220">(Jul 14 2022 at 11:05)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<p>In #3038 we introduced the initial version of the Cranelift CLIF-level differential fuzzer. </p>
<p>This fuzzer generates CLIF modules that are run on the interpreter and subsequently on the host machine (assuming no traps / invalid memory accesses) comparing the outputs of each run.</p>
<p>Roadmap:</p>
<ul>
<li>[x] Initial introduction (#3038)</li>
<li>[x] Generating test inputs with control flow<ul>
<li>[x] Generate multiple blocks and basic jump instructions (#3094)</li>
<li>[x] Generate <code>br_table</code>'s and other jump table jumps (#3299)</li>
</ul>
</li>
<li>[ ] Generating memory loads/stores (stack and heap)<ul>
<li>[x] Add stack support to the interpreter with virtual addresses (#3187)</li>
<li>[x] Add heap support to the interpreter with virtual addresses (#3302)</li>
<li>[x] Add table support to the interpreter with virtual addresses (#4433)</li>
<li>[x] Generate Stack Load/Store instructions on fuzzgen (#4438)</li>
<li>[ ] Cross endianness loads/stores</li>
</ul>
</li>
<li>[ ] Generating calls (just to builtins/intrinsics? or just between multiple functions in one testcase?)</li>
<li>[ ] Full coverage of arithmetic ops<ul>
<li>[ ] Extend the codegen in the <code>cranelift-meta</code> crate to provide a table of acceptable opcodes and types</li>
</ul>
</li>
<li>[ ] Full coverage of SIMD ops</li>
</ul>
</blockquote>



<a name="295719602"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/295719602" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#295719602">(Aug 28 2022 at 14:58)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<p>In #3038 we introduced the initial version of the Cranelift CLIF-level differential fuzzer. </p>
<p>This fuzzer generates CLIF modules that are run on the interpreter and subsequently on the host machine (assuming no traps / invalid memory accesses) comparing the outputs of each run.</p>
<p>Roadmap:</p>
<ul>
<li>[x] Initial introduction (#3038)</li>
<li>[x] Generating test inputs with control flow<ul>
<li>[x] Generate multiple blocks and basic jump instructions (#3094)</li>
<li>[x] Generate <code>br_table</code>'s and other jump table jumps (#3299)</li>
</ul>
</li>
<li>[ ] Generating memory loads/stores<ul>
<li>[x] Stack<ul>
<li>[x] Interpreter Support (#3187)</li>
<li>[x] Fuzzer Support (#4438)</li>
</ul>
</li>
<li>[ ] Heap<ul>
<li>[x] Interpreter Support (#3302)</li>
<li>[ ] Fuzzer Support</li>
</ul>
</li>
<li>[ ] Table<ul>
<li>[x] Interpreter Support (#4433)</li>
<li>[ ] Fuzzer Support</li>
</ul>
</li>
<li>[ ] Symbols<ul>
<li>[ ] Interpreter Support</li>
<li>[ ] Fuzzer Support</li>
</ul>
</li>
<li>[ ] Others<ul>
<li>[ ] Cross endianness loads/stores</li>
<li>[ ] <code>notrap</code> MemFlags</li>
<li>[ ] <code>aligned</code> MemFlags</li>
<li>[ ] <code>readonly</code> MemFlags</li>
</ul>
</li>
</ul>
</li>
<li>[ ] Generating calls<ul>
<li>[x] Generating LibCall's (#4782)</li>
<li>[ ] Generating Function Calls</li>
<li>[ ] Indirect Function Calls</li>
</ul>
</li>
<li>[ ] Full coverage of arithmetic ops<ul>
<li>[ ] Extend the codegen in the <code>cranelift-meta</code> crate to provide a table of acceptable opcodes and types</li>
</ul>
</li>
<li>[ ] Full coverage of SIMD ops</li>
</ul>
</blockquote>



<a name="297138421"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/297138421" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#297138421">(Sep 04 2022 at 20:27)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/issues/3050#issuecomment-1236409671">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<p>We've been having performance issues with fuzzgen. So I decided to implement a statistics framework and measure <span aria-label="science" class="emoji emoji-1f52c" role="img" title="science">:science:</span>  a bunch of stuff!</p>
<p>Be warned, this comment is really long. These are the notes that I took while doing these improvements.</p>
<p>TL;DR: We have issues with input formats, we waste about 60% of our inputs. Did some improvements that doubled fuzzgen's performance.</p>
<h1>Setup</h1>
<p>All of these measurements are done on AArch64 (Ampere Altra) running on a single core. Mostly because it was easier for me to run them there.</p>
<p>All the measurements are started from the OSS-Fuzz corpus which is 10744 files (50MB). I also don't pass any <code>-max_len</code> flags since the fuzzer is selecting a default of about 1MB which IIRC was what Alex Crichton mentioned OSS-Fuzz uses.</p>
<p>#4868 introduces a statistics framework for fuzzgen to allow us to measure what is going on and where we are losing performance.</p>
<p>All of these steps cause a fuzzer input format change, but so does the baseline due to #4867 so hopefully they are all somewhat on equal standing? I'm not sure how to avoid / compensate for this but I don't think it turned out to be too relevant.</p>
<p>For all of these I ran them with the following command:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cargo</span><span class="w"> </span><span class="n">fuzz</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">fuzzgen</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">default</span><span class="o">-</span><span class="n">features</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="o">-</span><span class="n">runs</span><span class="o">=</span><span class="mi">100010</span><span class="w"> </span><span class="o">-</span><span class="n">seed</span><span class="o">=</span><span class="mi">1588797004</span><span class="w"></span>
</code></pre></div>
<h1>Baseline</h1>
<p>Baseline is <code>main</code> with the following PR's on top:</p>
<ul>
<li>cranelift: Implement missing i128 rotates on AArch64 (#4866)</li>
<li>cranelift: Prepare fuzzgen for AArch64 (#4867) </li>
<li>fuzzgen: Statistics framework (#4868)</li>
</ul>
<p>The <code>aarch64</code> ones were necessary for stable execution.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="mi">99818</span><span class="w">  </span><span class="n">REDUCE</span><span class="w"> </span><span class="n">cov</span>: <span class="mi">30635</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">178125</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">5452</span><span class="o">/</span><span class="mi">5451</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">48702</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">18</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">1510</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">58</span><span class="o">/</span><span class="mi">45498</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">2</span><span class="w"> </span><span class="n">EraseBytes</span><span class="o">-</span><span class="n">PersAutoDict</span><span class="o">-</span><span class="w"> </span><span class="n">DE</span>: <span class="s">"</span><span class="se">\x01\x00\x00\x00\x00\x00\x00\x0d</span><span class="s">"</span><span class="o">-</span><span class="w"></span>
<span class="o">==</span><span class="w"> </span><span class="n">FuzzGen</span><span class="w"> </span><span class="n">Statistics</span><span class="w">  </span><span class="o">====================</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">100000</span><span class="w"></span>
<span class="n">Well</span><span class="w"> </span><span class="n">Formed</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">48458</span><span class="w"> </span><span class="p">(</span><span class="mf">48.5</span><span class="o">%</span><span class="p">)</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">76648</span><span class="w"></span>
<span class="n">Successful</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">38549</span><span class="w"> </span><span class="p">(</span><span class="mf">50.3</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Timed</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">32679</span><span class="w"> </span><span class="p">(</span><span class="mf">42.6</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Traps</span>:
        <span class="nc">stk_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">heap_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">icall_null</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">int_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">unreachable</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">interrupt</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">heap_misaligned</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">bad_sig</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">int_divz</span>: <span class="mi">5420</span><span class="w"> </span><span class="p">(</span><span class="mf">7.1</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">bad_toint</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">table_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<blockquote>
<p><strong>Note</strong><br>
Each "Well Formed Input" can have multiple "Runs", each run is an input to a fuzzgen generated function by the interpreter and if successful also a host execution with that same input.</p>
</blockquote>
<p>This is surprising to me in a bunch of ways!</p>
<ul>
<li>
<p>We are indeed dropping a lot of inputs as malformed (52.5%)<br>
    * This is better than I expected, I was thinking we would get something along the lines of 80-90%.<br>
    * See @jameysharp comment about <a href="https://github.com/bytecodealliance/wasmtime/pull/4824#issuecomment-1236025832">possible reasons why</a></p>
</li>
<li>
<p>42.6% of runs are timeouts!<br>
    * I did not expect this! </p>
</li>
<li>
<p>Traps are about 7.1% of runs<br>
    * Not great, not terrible, lets look at the 50%'s first<br>
    * Also important to note that when a run trap's the entire input is dropped, so this also roughly translates into 7% of inputs being dropped.</p>
</li>
<li>
<p>0% Invalid memory accesses! Awesome!</p>
</li>
</ul>
<h1>Applying @jameysharp recent patches</h1>
<p>The previous PR's plus:</p>
<ul>
<li><a href="https://github.com/jameysharp/wasmtime/tree/test-inputs-length">jameysharp:test-inputs-length</a>   (#4862)</li>
<li><a href="https://github.com/jameysharp/wasmtime/tree/cranelift-fuzzgen">jameysharp:cranelift-fuzzgen</a> (#4863)</li>
</ul>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="mi">99897</span><span class="w">  </span><span class="n">NEW</span><span class="w">    </span><span class="n">cov</span>: <span class="mi">30628</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">177683</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">5448</span><span class="o">/</span><span class="mi">5433</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">48702</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">19</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">1735</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">6707</span><span class="o">/</span><span class="mi">32810</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">1</span><span class="w"> </span><span class="n">ChangeBinInt</span><span class="o">-</span><span class="w"></span>
<span class="o">==</span><span class="w"> </span><span class="n">FuzzGen</span><span class="w"> </span><span class="n">Statistics</span><span class="w">  </span><span class="o">====================</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">100000</span><span class="w"></span>
<span class="n">Well</span><span class="w"> </span><span class="n">Formed</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">49089</span><span class="w"> </span><span class="p">(</span><span class="mf">49.1</span><span class="o">%</span><span class="p">)</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">155175</span><span class="w"></span>
<span class="n">Successful</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">116304</span><span class="w"> </span><span class="p">(</span><span class="mf">75.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Timed</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">33061</span><span class="w"> </span><span class="p">(</span><span class="mf">21.3</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Traps</span>:
        <span class="nc">heap_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">heap_misaligned</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">bad_sig</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">bad_toint</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">icall_null</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">int_ovf</span>: <span class="mi">5</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">unreachable</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">int_divz</span>: <span class="mi">5805</span><span class="w"> </span><span class="p">(</span><span class="mf">3.7</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">stk_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">table_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">interrupt</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>This increases the amount of runs that we do by a lot! It also seems neutral on execs/s and coverage.</p>
<p>The percentage of div by zero traps probably goes down because we stop running the input function as soon as one trap is found, and don't execute the rest of the inputs. Timed out runs have the same issue.</p>
<p>Also we now hit a <code>int_ovf</code> trap, I suspect we could also reach that without these changes but it makes it more likeley due to more inputs, so that a nice win!</p>
<h1>Mostly Forward Branching</h1>
<p>I haven't yet submitted a PR for this since I want to clean it up a little bit before submitting (<a href="https://github.com/afonso360/wasmtime/commit/6af4285074340838eed2c8e3b5659b623341220c">WIP commit here</a>).</p>
<p>The idea is to try to always generate forward branches with a small amount of backwards branches. This should avoid the amount of infinite loops we produce. </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="mi">99983</span><span class="w">  </span><span class="n">REDUCE</span><span class="w"> </span><span class="n">cov</span>: <span class="mi">29993</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">166091</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">4265</span><span class="o">/</span><span class="mi">5351</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">393617</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">44</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">1316</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">850</span><span class="o">/</span><span class="mi">393581</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">1</span><span class="w"> </span><span class="n">EraseBytes</span><span class="o">-</span><span class="w"></span>
<span class="o">==</span><span class="w"> </span><span class="n">FuzzGen</span><span class="w"> </span><span class="n">Statistics</span><span class="w">  </span><span class="o">====================</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">100000</span><span class="w"></span>
<span class="n">Well</span><span class="w"> </span><span class="n">Formed</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">37680</span><span class="w"> </span><span class="p">(</span><span class="mf">37.7</span><span class="o">%</span><span class="p">)</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">792534</span><span class="w"></span>
<span class="n">Successful</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">785981</span><span class="w"> </span><span class="p">(</span><span class="mf">99.2</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Timed</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">893</span><span class="w"> </span><span class="p">(</span><span class="mf">0.1</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Traps</span>:
        <span class="nc">heap_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">heap_misaligned</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">bad_sig</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">bad_toint</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">int_divz</span>: <span class="mi">5660</span><span class="w"> </span><span class="p">(</span><span class="mf">0.7</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">unreachable</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">stk_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">table_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">icall_null</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">interrupt</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">int_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>A 130% improvement in execs/s (19 -&gt; 44)! We were indeed wasting a lot of time in timed out runs.</p>
<p>We now timeout on about 2.3% of well formed inputs, which is a lot better. The 0.1% number is misleading because as soon as a timeout is found we instantly drop the entire input, so we find much fewer of these cases when comparing to runs.</p>
<p>The number of runs has exploded (785k)! Eventually we may want to tune this if we find we are spending too much time in runs vs inputs.</p>
<h1>Better Instruction Selection</h1>
<p>This is @jameysharp's <a href="https://github.com/bytecodealliance/wasmtime/commit/0c9689ba978276bd925b47db0d20623a118699fb">WIP commit</a> that tries to make the input format more resilient by never trying to insert opcodes unless we have the input data types for it.</p>
<p>See this <a href="https://github.com/bytecodealliance/wasmtime/pull/4824#issuecomment-1236025832">comment</a> for a longer explanation</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="mi">99998</span><span class="w">  </span><span class="n">REDUCE</span><span class="w"> </span><span class="n">cov</span>: <span class="mi">30503</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">168926</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">4522</span><span class="o">/</span><span class="mi">5062</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">1048576</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">29</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">1548</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">367</span><span class="o">/</span><span class="mi">394877</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">5</span><span class="w"> </span><span class="n">ChangeBit</span><span class="o">-</span><span class="n">ChangeBit</span><span class="o">-</span><span class="n">ChangeByte</span><span class="o">-</span><span class="n">CMP</span><span class="o">-</span><span class="n">EraseBytes</span><span class="o">-</span><span class="w"> </span><span class="n">DE</span>: <span class="s">"</span><span class="se">\x01\x00\x00</span><span class="s">q"</span><span class="o">-</span><span class="w"></span>
<span class="o">==</span><span class="w"> </span><span class="n">FuzzGen</span><span class="w"> </span><span class="n">Statistics</span><span class="w">  </span><span class="o">====================</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">100000</span><span class="w"></span>
<span class="n">Well</span><span class="w"> </span><span class="n">Formed</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">40927</span><span class="w"> </span><span class="p">(</span><span class="mf">40.9</span><span class="o">%</span><span class="p">)</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">739299</span><span class="w"></span>
<span class="n">Successful</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">726769</span><span class="w"> </span><span class="p">(</span><span class="mf">98.3</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Timed</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">416</span><span class="w"> </span><span class="p">(</span><span class="mf">0.1</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Traps</span>:
        <span class="nc">int_ovf</span>: <span class="mi">9</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">bad_sig</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">icall_null</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">table_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">int_divz</span>: <span class="mi">12105</span><span class="w"> </span><span class="p">(</span><span class="mf">1.6</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">heap_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">heap_misaligned</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">stk_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">unreachable</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">bad_toint</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">interrupt</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>A 3% improvement in Well Formed Inputs (I also ran this a few more times but it was always within 3-4%)</p>
<p>I don't understand why our <code>int_divz</code> numbers exploded here (Aprox 29% of "Well Formed Inputs"!), but its something we definitely have to improve.</p>
<p>Please don't derive any sort of performance measurements from this, I implemented it in probably the worst way possible. It was just to check the "Well Formed Inputs" difference.</p>
<h1>End notes</h1>
<p>Here's the <a href="https://github.com/afonso360/wasmtime/commits/fuzz-next">branch</a> that I used for all of these, In the mean time I've iterated on some of those and separated them into individual PR's.</p>
<ul>
<li>
<p>Generating "Well Formed Inputs" remains a big issue and I think its probably going to take a few iterations improving various parts of our input format, like @jameysharp did for instruction selection (Thanks!)<br>
    * We lose about 60% of our inputs to this!<br>
    * Is there a good way to collect stats about where we are trying to select something that is not available? Or why <code>arbitrary</code> decided our input wasn't valid?</p>
</li>
<li>
<p>With some of the other issues solved <code>int_divz</code> is now also a big issue.<br>
    * We get 12105 on a Well Formed Input size of 40927 (29%)!<br>
    * This means that 29% of input programs were dropped due to a div by zero, and I would guess that it was on the first execution for a lot of them. Which means that we potentially never even run them in the host.</p>
</li>
</ul>
</blockquote>



<a name="297141443"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/297141443" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#297141443">(Sep 04 2022 at 21:15)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/3050#issuecomment-1236409671">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<p>We've been having performance issues with fuzzgen. So I decided to implement a statistics framework and measure <span aria-label="science" class="emoji emoji-1f52c" role="img" title="science">:science:</span>  a bunch of stuff!</p>
<p>Be warned, this comment is really long. These are the notes that I took while doing these improvements.</p>
<p>TL;DR: We have issues with input formats, we waste about 60% of our inputs. Did some improvements that doubled fuzzgen's performance.</p>
<p>&lt;details&gt;<br>
&lt;summary&gt;&lt;h2&gt;Setup&lt;/h2&gt;&lt;/summary</p>
<p>All of these measurements are done on AArch64 (Ampere Altra) running on a single core. Mostly because it was easier for me to run them there.</p>
<p>All the measurements are started from the OSS-Fuzz corpus which is 10744 files (50MB). I also don't pass any <code>-max_len</code> flags since the fuzzer is selecting a default of about 1MB which IIRC was what Alex Crichton mentioned OSS-Fuzz uses.</p>
<p>#4868 introduces a statistics framework for fuzzgen to allow us to measure what is going on and where we are losing performance.</p>
<p>All of these steps cause a fuzzer input format change, but so does the baseline due to #4867 so hopefully they are all somewhat on equal standing? I'm not sure how to avoid / compensate for this but I don't think it turned out to be too relevant.</p>
<p>For all of these I ran them with the following command:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cargo</span><span class="w"> </span><span class="n">fuzz</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">fuzzgen</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">default</span><span class="o">-</span><span class="n">features</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="o">-</span><span class="n">runs</span><span class="o">=</span><span class="mi">100010</span><span class="w"> </span><span class="o">-</span><span class="n">seed</span><span class="o">=</span><span class="mi">1588797004</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>&lt;details&gt;<br>
&lt;summary&gt;&lt;h2&gt;Baseline&lt;/h2&gt;&lt;/summary&gt;</p>
<p>Baseline is <code>main</code> with the following PR's on top:</p>
<ul>
<li>cranelift: Implement missing i128 rotates on AArch64 (#4866)</li>
<li>cranelift: Prepare fuzzgen for AArch64 (#4867) </li>
<li>fuzzgen: Statistics framework (#4868)</li>
</ul>
<p>The <code>aarch64</code> ones were necessary for stable execution.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="mi">99818</span><span class="w">  </span><span class="n">REDUCE</span><span class="w"> </span><span class="n">cov</span>: <span class="mi">30635</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">178125</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">5452</span><span class="o">/</span><span class="mi">5451</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">48702</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">18</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">1510</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">58</span><span class="o">/</span><span class="mi">45498</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">2</span><span class="w"> </span><span class="n">EraseBytes</span><span class="o">-</span><span class="n">PersAutoDict</span><span class="o">-</span><span class="w"> </span><span class="n">DE</span>: <span class="s">"</span><span class="se">\x01\x00\x00\x00\x00\x00\x00\x0d</span><span class="s">"</span><span class="o">-</span><span class="w"></span>
<span class="o">==</span><span class="w"> </span><span class="n">FuzzGen</span><span class="w"> </span><span class="n">Statistics</span><span class="w">  </span><span class="o">====================</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">100000</span><span class="w"></span>
<span class="n">Well</span><span class="w"> </span><span class="n">Formed</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">48458</span><span class="w"> </span><span class="p">(</span><span class="mf">48.5</span><span class="o">%</span><span class="p">)</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">76648</span><span class="w"></span>
<span class="n">Successful</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">38549</span><span class="w"> </span><span class="p">(</span><span class="mf">50.3</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Timed</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">32679</span><span class="w"> </span><span class="p">(</span><span class="mf">42.6</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Traps</span>:
        <span class="nc">stk_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">heap_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">icall_null</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">int_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">unreachable</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">interrupt</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">heap_misaligned</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">bad_sig</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">int_divz</span>: <span class="mi">5420</span><span class="w"> </span><span class="p">(</span><span class="mf">7.1</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">bad_toint</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">table_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<blockquote>
<p><strong>Note</strong><br>
Each "Well Formed Input" can have multiple "Runs", each run is an input to a fuzzgen generated function by the interpreter and if successful also a host execution with that same input.</p>
</blockquote>
<p>This is surprising to me in a bunch of ways!</p>
<ul>
<li>
<p>We are indeed dropping a lot of inputs as malformed (52.5%)<br>
    * This is better than I expected, I was thinking we would get something along the lines of 80-90%.<br>
    * See @jameysharp comment about <a href="https://github.com/bytecodealliance/wasmtime/pull/4824#issuecomment-1236025832">possible reasons why</a></p>
</li>
<li>
<p>42.6% of runs are timeouts!<br>
    * I did not expect this! </p>
</li>
<li>
<p>Traps are about 7.1% of runs<br>
    * Not great, not terrible, lets look at the 50%'s first<br>
    * Also important to note that when a run trap's the entire input is dropped, so this also roughly translates into 7% of inputs being dropped.</p>
</li>
<li>
<p>0% Invalid memory accesses! Awesome!</p>
</li>
</ul>
<p>&lt;/details&gt;</p>
<p>&lt;details&gt;<br>
&lt;summary&gt;&lt;h2&gt; Applying @jameysharp recent patches&lt;/h2&gt;&lt;/summary&gt;</p>
<p>The previous PR's plus:</p>
<ul>
<li><a href="https://github.com/jameysharp/wasmtime/tree/test-inputs-length">jameysharp:test-inputs-length</a>   (#4862)</li>
<li><a href="https://github.com/jameysharp/wasmtime/tree/cranelift-fuzzgen">jameysharp:cranelift-fuzzgen</a> (#4863)</li>
</ul>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="mi">99897</span><span class="w">  </span><span class="n">NEW</span><span class="w">    </span><span class="n">cov</span>: <span class="mi">30628</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">177683</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">5448</span><span class="o">/</span><span class="mi">5433</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">48702</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">19</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">1735</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">6707</span><span class="o">/</span><span class="mi">32810</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">1</span><span class="w"> </span><span class="n">ChangeBinInt</span><span class="o">-</span><span class="w"></span>
<span class="o">==</span><span class="w"> </span><span class="n">FuzzGen</span><span class="w"> </span><span class="n">Statistics</span><span class="w">  </span><span class="o">====================</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">100000</span><span class="w"></span>
<span class="n">Well</span><span class="w"> </span><span class="n">Formed</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">49089</span><span class="w"> </span><span class="p">(</span><span class="mf">49.1</span><span class="o">%</span><span class="p">)</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">155175</span><span class="w"></span>
<span class="n">Successful</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">116304</span><span class="w"> </span><span class="p">(</span><span class="mf">75.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Timed</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">33061</span><span class="w"> </span><span class="p">(</span><span class="mf">21.3</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Traps</span>:
        <span class="nc">heap_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">heap_misaligned</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">bad_sig</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">bad_toint</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">icall_null</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">int_ovf</span>: <span class="mi">5</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">unreachable</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">int_divz</span>: <span class="mi">5805</span><span class="w"> </span><span class="p">(</span><span class="mf">3.7</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">stk_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">table_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">interrupt</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>This increases the amount of runs that we do by a lot! It also seems neutral on execs/s and coverage.</p>
<p>The percentage of div by zero traps probably goes down because we stop running the input function as soon as one trap is found, and don't execute the rest of the inputs. Timed out runs have the same issue.</p>
<p>Also we now hit a <code>int_ovf</code> trap, I suspect we could also reach that without these changes but it makes it more likeley due to more inputs, so that a nice win!<br>
&lt;/details&gt;</p>
<p>&lt;details&gt;<br>
&lt;summary&gt;&lt;h2&gt;Mostly Forward Branching&lt;/h2&gt;&lt;/summary&gt;</p>
<p>I haven't yet submitted a PR for this since I want to clean it up a little bit before submitting (<a href="https://github.com/afonso360/wasmtime/commit/6af4285074340838eed2c8e3b5659b623341220c">WIP commit here</a>).</p>
<p>The idea is to try to always generate forward branches with a small amount of backwards branches. This should avoid the amount of infinite loops we produce. </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="mi">99983</span><span class="w">  </span><span class="n">REDUCE</span><span class="w"> </span><span class="n">cov</span>: <span class="mi">29993</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">166091</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">4265</span><span class="o">/</span><span class="mi">5351</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">393617</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">44</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">1316</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">850</span><span class="o">/</span><span class="mi">393581</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">1</span><span class="w"> </span><span class="n">EraseBytes</span><span class="o">-</span><span class="w"></span>
<span class="o">==</span><span class="w"> </span><span class="n">FuzzGen</span><span class="w"> </span><span class="n">Statistics</span><span class="w">  </span><span class="o">====================</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">100000</span><span class="w"></span>
<span class="n">Well</span><span class="w"> </span><span class="n">Formed</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">37680</span><span class="w"> </span><span class="p">(</span><span class="mf">37.7</span><span class="o">%</span><span class="p">)</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">792534</span><span class="w"></span>
<span class="n">Successful</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">785981</span><span class="w"> </span><span class="p">(</span><span class="mf">99.2</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Timed</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">893</span><span class="w"> </span><span class="p">(</span><span class="mf">0.1</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Traps</span>:
        <span class="nc">heap_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">heap_misaligned</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">bad_sig</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">bad_toint</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">int_divz</span>: <span class="mi">5660</span><span class="w"> </span><span class="p">(</span><span class="mf">0.7</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">unreachable</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">stk_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">table_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">icall_null</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">interrupt</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">int_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>A 130% improvement in execs/s (19 -&gt; 44)! We were indeed wasting a lot of time in timed out runs.</p>
<p>We now timeout on about 2.3% of well formed inputs, which is a lot better. The 0.1% number is misleading because as soon as a timeout is found we instantly drop the entire input, so we find much fewer of these cases when comparing to runs.</p>
<p>The number of runs has exploded (785k)! Eventually we may want to tune this if we find we are spending too much time in runs vs inputs.</p>
<p>&lt;/details&gt;</p>
<p>&lt;details&gt;<br>
&lt;summary&gt;&lt;h2&gt;Better Instruction Selection&lt;/h2&gt;&lt;/summary&gt;</p>
<p>This is @jameysharp's <a href="https://github.com/bytecodealliance/wasmtime/commit/0c9689ba978276bd925b47db0d20623a118699fb">WIP commit</a> that tries to make the input format more resilient by never trying to insert opcodes unless we have the input data types for it.</p>
<p>See this <a href="https://github.com/bytecodealliance/wasmtime/pull/4824#issuecomment-1236025832">comment</a> for a longer explanation</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="mi">99998</span><span class="w">  </span><span class="n">REDUCE</span><span class="w"> </span><span class="n">cov</span>: <span class="mi">30503</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">168926</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">4522</span><span class="o">/</span><span class="mi">5062</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">1048576</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">29</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">1548</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">367</span><span class="o">/</span><span class="mi">394877</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">5</span><span class="w"> </span><span class="n">ChangeBit</span><span class="o">-</span><span class="n">ChangeBit</span><span class="o">-</span><span class="n">ChangeByte</span><span class="o">-</span><span class="n">CMP</span><span class="o">-</span><span class="n">EraseBytes</span><span class="o">-</span><span class="w"> </span><span class="n">DE</span>: <span class="s">"</span><span class="se">\x01\x00\x00</span><span class="s">q"</span><span class="o">-</span><span class="w"></span>
<span class="o">==</span><span class="w"> </span><span class="n">FuzzGen</span><span class="w"> </span><span class="n">Statistics</span><span class="w">  </span><span class="o">====================</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">100000</span><span class="w"></span>
<span class="n">Well</span><span class="w"> </span><span class="n">Formed</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">40927</span><span class="w"> </span><span class="p">(</span><span class="mf">40.9</span><span class="o">%</span><span class="p">)</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">739299</span><span class="w"></span>
<span class="n">Successful</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">726769</span><span class="w"> </span><span class="p">(</span><span class="mf">98.3</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Timed</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">416</span><span class="w"> </span><span class="p">(</span><span class="mf">0.1</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Traps</span>:
        <span class="nc">int_ovf</span>: <span class="mi">9</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">bad_sig</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">icall_null</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">table_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">int_divz</span>: <span class="mi">12105</span><span class="w"> </span><span class="p">(</span><span class="mf">1.6</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">heap_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">heap_misaligned</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">stk_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">unreachable</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">bad_toint</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">interrupt</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>A 3% improvement in Well Formed Inputs (I also ran this a few more times but it was always within 3-4%)</p>
<p>I don't understand why our <code>int_divz</code> numbers exploded here (Aprox 29% of "Well Formed Inputs"!), but its something we definitely have to improve.</p>
<p>Please don't derive any sort of performance measurements from this, I implemented it in probably the worst way possible. It was just to check the "Well Formed Inputs" difference.</p>
<p>&lt;/details&gt;</p>
<h2>End notes</h2>
<p>Here's the <a href="https://github.com/afonso360/wasmtime/commits/fuzz-next">branch</a> that I used for all of these, In the mean time I've iterated on some of those and separated them into individual PR's.</p>
<ul>
<li>
<p>Generating "Well Formed Inputs" remains a big issue and I think its probably going to take a few iterations improving various parts of our input format, like @jameysharp did for instruction selection (Thanks!)<br>
    * We lose about 60% of our inputs to this!<br>
    * Is there a good way to collect stats about where we are trying to select something that is not available? Or why <code>arbitrary</code> decided our input wasn't valid?</p>
</li>
<li>
<p>With some of the other issues solved <code>int_divz</code> is now also a big issue.<br>
    * We get 12105 on a Well Formed Input size of 40927 (29%)!<br>
    * This means that 29% of input programs were dropped due to a div by zero, and I would guess that it was on the first execution for a lot of them. Which means that we potentially never even run them in the host.</p>
</li>
</ul>
</blockquote>



<a name="297189724"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/297189724" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#297189724">(Sep 05 2022 at 09:01)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/3050#issuecomment-1236409671">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<p>We've been having performance issues with fuzzgen. So I decided to implement a statistics framework and measure <span aria-label="science" class="emoji emoji-1f52c" role="img" title="science">:science:</span>  a bunch of stuff!</p>
<p>Be warned, this comment is really long. These are the notes that I took while doing these improvements.</p>
<p>TL;DR: We have issues with input formats, we waste about 60% of our inputs. Did some improvements that doubled fuzzgen's performance.</p>
<p>&lt;details&gt;<br>
&lt;summary&gt;&lt;h2&gt;Setup&lt;/h2&gt;&lt;/summary</p>
<p>All of these measurements are done on AArch64 (Ampere Altra) running on a single core. Mostly because it was easier for me to run them there.</p>
<p>All the measurements are started from the OSS-Fuzz corpus which is 10744 files (50MB). I also don't pass any <code>-max_len</code> flags since the fuzzer is selecting a default of about 1MB which IIRC was what Alex Crichton mentioned OSS-Fuzz uses.</p>
<p>#4868 introduces a statistics framework for fuzzgen to allow us to measure what is going on and where we are losing performance.</p>
<p>All of these steps cause a fuzzer input format change, but so does the baseline due to #4867 so hopefully they are all somewhat on equal standing? I'm not sure how to avoid / compensate for this but I don't think it turned out to be too relevant.</p>
<p>For all of these I ran them with the following command:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cargo</span><span class="w"> </span><span class="n">fuzz</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">fuzzgen</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">default</span><span class="o">-</span><span class="n">features</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="o">-</span><span class="n">runs</span><span class="o">=</span><span class="mi">100010</span><span class="w"> </span><span class="o">-</span><span class="n">seed</span><span class="o">=</span><span class="mi">1588797004</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>&lt;details&gt;<br>
&lt;summary&gt;&lt;h2&gt;Baseline&lt;/h2&gt;&lt;/summary&gt;</p>
<p>Baseline is <code>main</code> with the following PR's on top:</p>
<ul>
<li>cranelift: Implement missing i128 rotates on AArch64 (#4866)</li>
<li>cranelift: Prepare fuzzgen for AArch64 (#4867) </li>
<li>fuzzgen: Statistics framework (#4868)</li>
</ul>
<p>The <code>aarch64</code> ones were necessary for stable execution.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="mi">99818</span><span class="w">  </span><span class="n">REDUCE</span><span class="w"> </span><span class="n">cov</span>: <span class="mi">30635</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">178125</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">5452</span><span class="o">/</span><span class="mi">5451</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">48702</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">18</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">1510</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">58</span><span class="o">/</span><span class="mi">45498</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">2</span><span class="w"> </span><span class="n">EraseBytes</span><span class="o">-</span><span class="n">PersAutoDict</span><span class="o">-</span><span class="w"> </span><span class="n">DE</span>: <span class="s">"</span><span class="se">\x01\x00\x00\x00\x00\x00\x00\x0d</span><span class="s">"</span><span class="o">-</span><span class="w"></span>
<span class="o">==</span><span class="w"> </span><span class="n">FuzzGen</span><span class="w"> </span><span class="n">Statistics</span><span class="w">  </span><span class="o">====================</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">100000</span><span class="w"></span>
<span class="n">Well</span><span class="w"> </span><span class="n">Formed</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">48458</span><span class="w"> </span><span class="p">(</span><span class="mf">48.5</span><span class="o">%</span><span class="p">)</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">76648</span><span class="w"></span>
<span class="n">Successful</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">38549</span><span class="w"> </span><span class="p">(</span><span class="mf">50.3</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Timed</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">32679</span><span class="w"> </span><span class="p">(</span><span class="mf">42.6</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Traps</span>:
        <span class="nc">stk_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">heap_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">icall_null</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">int_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">unreachable</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">interrupt</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">heap_misaligned</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">bad_sig</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">int_divz</span>: <span class="mi">5420</span><span class="w"> </span><span class="p">(</span><span class="mf">7.1</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">bad_toint</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">table_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<blockquote>
<p><strong>Note</strong><br>
Each "Well Formed Input" can have multiple "Runs", each run is an input to a fuzzgen generated function by the interpreter and if successful also a host execution with that same input.</p>
</blockquote>
<p>This is surprising to me in a bunch of ways!</p>
<ul>
<li>
<p>We are indeed dropping a lot of inputs as malformed (52.5%)<br>
    * This is better than I expected, I was thinking we would get something along the lines of 80-90%.<br>
    * See @jameysharp comment about <a href="https://github.com/bytecodealliance/wasmtime/pull/4824#issuecomment-1236025832">possible reasons why</a></p>
</li>
<li>
<p>42.6% of runs are timeouts!<br>
    * I did not expect this! </p>
</li>
<li>
<p>Traps are about 7.1% of runs<br>
    * Not great, not terrible, lets look at the 50%'s first<br>
    * Also important to note that when a run trap's the entire input is dropped, so this also roughly translates into 7% of inputs being dropped.</p>
</li>
<li>
<p>0% Invalid memory accesses! Awesome!</p>
</li>
</ul>
<p>&lt;/details&gt;</p>
<p>&lt;details&gt;<br>
&lt;summary&gt;&lt;h2&gt; Applying @jameysharp recent patches&lt;/h2&gt;&lt;/summary&gt;</p>
<p>The previous PR's plus:</p>
<ul>
<li><a href="https://github.com/jameysharp/wasmtime/tree/test-inputs-length">jameysharp:test-inputs-length</a>   (#4862)</li>
<li><a href="https://github.com/jameysharp/wasmtime/tree/cranelift-fuzzgen">jameysharp:cranelift-fuzzgen</a> (#4863)</li>
</ul>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="mi">99897</span><span class="w">  </span><span class="n">NEW</span><span class="w">    </span><span class="n">cov</span>: <span class="mi">30628</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">177683</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">5448</span><span class="o">/</span><span class="mi">5433</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">48702</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">19</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">1735</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">6707</span><span class="o">/</span><span class="mi">32810</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">1</span><span class="w"> </span><span class="n">ChangeBinInt</span><span class="o">-</span><span class="w"></span>
<span class="o">==</span><span class="w"> </span><span class="n">FuzzGen</span><span class="w"> </span><span class="n">Statistics</span><span class="w">  </span><span class="o">====================</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">100000</span><span class="w"></span>
<span class="n">Well</span><span class="w"> </span><span class="n">Formed</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">49089</span><span class="w"> </span><span class="p">(</span><span class="mf">49.1</span><span class="o">%</span><span class="p">)</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">155175</span><span class="w"></span>
<span class="n">Successful</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">116304</span><span class="w"> </span><span class="p">(</span><span class="mf">75.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Timed</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">33061</span><span class="w"> </span><span class="p">(</span><span class="mf">21.3</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Traps</span>:
        <span class="nc">heap_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">heap_misaligned</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">bad_sig</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">bad_toint</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">icall_null</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">int_ovf</span>: <span class="mi">5</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">unreachable</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">int_divz</span>: <span class="mi">5805</span><span class="w"> </span><span class="p">(</span><span class="mf">3.7</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">stk_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">table_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">interrupt</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>This increases the amount of runs that we do by a lot! It also seems neutral on execs/s and coverage.</p>
<p>The percentage of div by zero traps probably goes down because we stop running the input function as soon as one trap is found, and don't execute the rest of the inputs. Timed out runs have the same issue.</p>
<p>Also we now hit a <code>int_ovf</code> trap, I suspect we could also reach that without these changes but it makes it more likeley due to more inputs, so that a nice win!<br>
&lt;/details&gt;</p>
<p>&lt;details&gt;<br>
&lt;summary&gt;&lt;h2&gt;Mostly Forward Branching&lt;/h2&gt;&lt;/summary&gt;</p>
<p>I haven't yet submitted a PR for this since I want to clean it up a little bit before submitting (<a href="https://github.com/afonso360/wasmtime/commit/6af4285074340838eed2c8e3b5659b623341220c">WIP commit here</a>).</p>
<p>The idea is to try to always generate forward branches with a small amount of backwards branches. This should reduce the amount of infinite loops we produce. </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="mi">99983</span><span class="w">  </span><span class="n">REDUCE</span><span class="w"> </span><span class="n">cov</span>: <span class="mi">29993</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">166091</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">4265</span><span class="o">/</span><span class="mi">5351</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">393617</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">44</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">1316</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">850</span><span class="o">/</span><span class="mi">393581</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">1</span><span class="w"> </span><span class="n">EraseBytes</span><span class="o">-</span><span class="w"></span>
<span class="o">==</span><span class="w"> </span><span class="n">FuzzGen</span><span class="w"> </span><span class="n">Statistics</span><span class="w">  </span><span class="o">====================</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">100000</span><span class="w"></span>
<span class="n">Well</span><span class="w"> </span><span class="n">Formed</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">37680</span><span class="w"> </span><span class="p">(</span><span class="mf">37.7</span><span class="o">%</span><span class="p">)</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">792534</span><span class="w"></span>
<span class="n">Successful</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">785981</span><span class="w"> </span><span class="p">(</span><span class="mf">99.2</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Timed</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">893</span><span class="w"> </span><span class="p">(</span><span class="mf">0.1</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Traps</span>:
        <span class="nc">heap_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">heap_misaligned</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">bad_sig</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">bad_toint</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">int_divz</span>: <span class="mi">5660</span><span class="w"> </span><span class="p">(</span><span class="mf">0.7</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">unreachable</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">stk_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">table_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">icall_null</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">interrupt</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">int_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>A 130% improvement in execs/s (19 -&gt; 44)! We were indeed wasting a lot of time in timed out runs.</p>
<p>We now timeout on about 2.3% of well formed inputs, which is a lot better. The 0.1% number is misleading because as soon as a timeout is found we instantly drop the entire input, so we find much fewer of these cases when comparing to runs.</p>
<p>The number of runs has exploded (785k)! Eventually we may want to tune this if we find we are spending too much time in runs vs inputs.</p>
<p>&lt;/details&gt;</p>
<p>&lt;details&gt;<br>
&lt;summary&gt;&lt;h2&gt;Better Instruction Selection&lt;/h2&gt;&lt;/summary&gt;</p>
<p>This is @jameysharp's <a href="https://github.com/bytecodealliance/wasmtime/commit/0c9689ba978276bd925b47db0d20623a118699fb">WIP commit</a> that tries to make the input format more resilient by never trying to insert opcodes unless we have the input data types for it.</p>
<p>See this <a href="https://github.com/bytecodealliance/wasmtime/pull/4824#issuecomment-1236025832">comment</a> for a longer explanation</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="mi">99998</span><span class="w">  </span><span class="n">REDUCE</span><span class="w"> </span><span class="n">cov</span>: <span class="mi">30503</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">168926</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">4522</span><span class="o">/</span><span class="mi">5062</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">1048576</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">29</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">1548</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">367</span><span class="o">/</span><span class="mi">394877</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">5</span><span class="w"> </span><span class="n">ChangeBit</span><span class="o">-</span><span class="n">ChangeBit</span><span class="o">-</span><span class="n">ChangeByte</span><span class="o">-</span><span class="n">CMP</span><span class="o">-</span><span class="n">EraseBytes</span><span class="o">-</span><span class="w"> </span><span class="n">DE</span>: <span class="s">"</span><span class="se">\x01\x00\x00</span><span class="s">q"</span><span class="o">-</span><span class="w"></span>
<span class="o">==</span><span class="w"> </span><span class="n">FuzzGen</span><span class="w"> </span><span class="n">Statistics</span><span class="w">  </span><span class="o">====================</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">100000</span><span class="w"></span>
<span class="n">Well</span><span class="w"> </span><span class="n">Formed</span><span class="w"> </span><span class="n">Inputs</span>: <span class="mi">40927</span><span class="w"> </span><span class="p">(</span><span class="mf">40.9</span><span class="o">%</span><span class="p">)</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">739299</span><span class="w"></span>
<span class="n">Successful</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">726769</span><span class="w"> </span><span class="p">(</span><span class="mf">98.3</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Timed</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">Runs</span>: <span class="mi">416</span><span class="w"> </span><span class="p">(</span><span class="mf">0.1</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="n">Traps</span>:
        <span class="nc">int_ovf</span>: <span class="mi">9</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">bad_sig</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">icall_null</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">table_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">int_divz</span>: <span class="mi">12105</span><span class="w"> </span><span class="p">(</span><span class="mf">1.6</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">heap_oob</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">heap_misaligned</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">stk_ovf</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">unreachable</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">bad_toint</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">interrupt</span>: <span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Runs</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>A 3% improvement in Well Formed Inputs (I also ran this a few more times but it was always within 3-4%)</p>
<p>I don't understand why our <code>int_divz</code> numbers exploded here (Aprox 29% of "Well Formed Inputs"!), but its something we definitely have to improve.</p>
<p>Please don't derive any sort of performance measurements from this, I implemented it in probably the worst way possible. It was just to check the "Well Formed Inputs" difference.</p>
<p>&lt;/details&gt;</p>
<h2>End notes</h2>
<p>Here's the <a href="https://github.com/afonso360/wasmtime/commits/fuzz-next">branch</a> that I used for all of these, In the mean time I've iterated on some of those and separated them into individual PR's.</p>
<ul>
<li>
<p>Generating "Well Formed Inputs" remains a big issue and I think its probably going to take a few iterations improving various parts of our input format, like @jameysharp did for instruction selection (Thanks!)<br>
    * We lose about 60% of our inputs to this!<br>
    * Is there a good way to collect stats about where we are trying to select something that is not available? Or why <code>arbitrary</code> decided our input wasn't valid?</p>
</li>
<li>
<p>With some of the other issues solved <code>int_divz</code> is now also a big issue.<br>
    * We get 12105 on a Well Formed Input size of 40927 (29%)!<br>
    * This means that 29% of input programs were dropped due to a div by zero, and I would guess that it was on the first execution for a lot of them. Which means that we potentially never even run them in the host.</p>
</li>
</ul>
</blockquote>



<a name="297510772"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/297510772" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#297510772">(Sep 07 2022 at 01:23)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/issues/3050#issuecomment-1238804548">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<p>I am so excited about all this work you did over the weekend! I need to dig into it all. But until then, I'll reply to <a href="https://github.com/bytecodealliance/wasmtime/pull/4824#issuecomment-1236408856">https://github.com/bytecodealliance/wasmtime/pull/4824#issuecomment-1236408856</a> here:</p>
<blockquote>
<blockquote>
<p>You could still use something like the current opcodes table, as long as you have a way of filtering it to ensure that all the resources needed are available for each opcode. I don't think just input/output type signatures are sufficient for that.</p>
</blockquote>
<p>Is there any opcode that you think could be problematic? I'm not seeing why we couldn't do that based on signature.</p>
</blockquote>
<p>Any instructions with at least one operand which is not a "value". For example, stack load/store, with their need for a stack slot operand. Or function calls, which need a function reference, and also have a type signature that depends on the selected function reference. My WIP patch handles stack slots in <a href="https://github.com/bytecodealliance/wasmtime/commit/0c9689ba978276bd925b47db0d20623a118699fb#diff-226e0f113ddbbcedaa5265109a951e52d30aa35307537684f56a5e6bedc9ba0eR369-R390">https://github.com/bytecodealliance/wasmtime/commit/0c9689ba978276bd925b47db0d20623a118699fb#diff-226e0f113ddbbcedaa5265109a951e52d30aa35307537684f56a5e6bedc9ba0eR369-R390</a> but I didn't get to handling calls yet.</p>
<blockquote>
<blockquote>
<p>I think this is important because I suspect that we're currently discarding a lot of inputs due to, say, not generating any I128 variables up front but then trying to insert an I128 "add", or things like that. I'm betting that we'll find more bugs with the same number of test executions if we fix this. But I haven't done any measurements to check this guess.<br>
Either way, I think it's nice to apply the patches that allow just borrowing slices everywhere. So I've opened #4863 with those. The remaining work-in-progress part is no longer on that branch but is still accessible as <a href="https://github.com/bytecodealliance/wasmtime/commit/0c9689ba978276bd925b47db0d20623a118699fb">0c9689b</a>.</p>
</blockquote>
<p>I did some measurements on these! With #4863 and the WIP commit we get a 3-4% improvement in the number of valid inputs that we generate (vs total inputs). While these are not earth shattering numbers, I think we definitely should either commit this or something like it.</p>
</blockquote>
<p>I hope #4863 by itself didn't affect any of these numbers. It may have changed which stack slot is selected in some tests but otherwise if it changed how things are generated then I probably introduced a bug. <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>
<p>But it looks like you measured #4862 and #4863 together and saw a 1% increase in well-formed inputs. I don't think that's surprising from either #4862 or random noise, so that's reassuring.</p>
<p>As for "Better Instruction Selection": by my count, going from 38k well-formed inputs to 41k is an 8% increase (40927 / 37680 is 108%). Going from 38% to 41% is a difference of 3 percentage points but I'm not sure that's the best way to measure that change.</p>
<p>The "Mostly Forward Branching" work has very promising-looking results!</p>
<blockquote>
<p>Also important to note that when a run trap's the entire input is dropped, so this also roughly translates into 7% of inputs being dropped.</p>
</blockquote>
<p>How about continuing on to the remaining test inputs for the given function? If any of them don't trap then at least we've successfully tested something.</p>
<p>As a bigger project, maybe we should try doing something like <a href="https://github.com/bytecodealliance/wasm-tools/commit/f229c4fa03d45884f95ab392f672f4477c5ab4df">wasm-smith's new no-trapping mode</a>.</p>
<blockquote>
<p>Is there a good way to collect stats about where we are trying to select something that is not available? Or why <code>arbitrary</code> decided our input wasn't valid?</p>
</blockquote>
<p>I'm not sure yet; I'm thinking about it. Some observations that might help:</p>
<ul>
<li>There's a general goal in <code>arbitrary</code> that it shouldn't fail (<a href="https://github.com/rust-fuzz/arbitrary/commit/1d2f65360f634968b5525f4d6430a88a376277f0">https://github.com/rust-fuzz/arbitrary/commit/1d2f65360f634968b5525f4d6430a88a376277f0</a>). <code>Unstructured::choose</code> may be the only method that ever actually fails, though I haven't checked. If so, we primarily need to audit for calls to <code>choose</code> where we might pass in an empty slice, and avoid doing that. We can also try replacing <code>?</code> operators with <code>.unwrap()</code> and see if any fail. Or maybe print a stack trace before returning the error, with <a href="https://doc.rust-lang.org/nightly/std/backtrace/struct.Backtrace.html">std::backtrace::Backtrace</a>.</li>
<li>I've observed that we discard an input if CLIF validation fails after the NaN canonicalization pass. I think we should defer canonicalization until we're about to run the function, instead of while we're generating it. And probably panic instead of ignoring the error.</li>
<li>In general, let's try to minimize the number of ways that test-case generation can fail, so that <code>cargo fuzz fmt</code> is reliable.<br>
</li>
</ul>
</blockquote>



<a name="298287618"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/298287618" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#298287618">(Sep 11 2022 at 20:29)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/issues/3050#issuecomment-1243037213">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<blockquote>
<p>There's a general goal in arbitrary that it shouldn't fail (rust-fuzz/arbitrary@1d2f653). Unstructured::choose may be the only method that ever actually fails, though I haven't checked. If so, we primarily need to audit for calls to choose where we might pass in an empty slice, and avoid doing that. We can also try replacing ? operators with .unwrap() and see if any fail. Or maybe print a stack trace before returning the error, with std::backtrace::Backtrace.</p>
</blockquote>
<p>So I did this last one, I recorded backtraces for <code>Unstructured::choose</code> where we fail due to a empty choice. And from the numbers it appears to be <em>most</em> of the cases where fail to generate an input. It tracks with previous measurements of being about 50% of the inputs.</p>
<p>See this <a href="https://github.com/afonso360/wasmtime/tree/fuzz-rejection">branch</a> for the backtrace printing.<br>
I used <a href="https://gist.github.com/afonso360/f5278ab32d450658110f5c741c5896a7">this script</a> to group and print the backtraces.</p>
<p>With 150k execs we got the following results: (Reordered for better readability)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Loaded</span><span class="w"> </span><span class="mi">71331</span><span class="w"> </span><span class="n">stacks</span><span class="w"></span>

<span class="n">First</span><span class="w"> </span><span class="n">Line</span><span class="w"> </span><span class="n">duplicates</span><span class="w"></span>
<span class="mf">55.8</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">39787</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="mf">15.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">10731</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_target_block</span><span class="w"></span>
<span class="mf">13.4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>:  <span class="mi">9554</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">stack_slot_with_size</span><span class="w"></span>
<span class="w"> </span><span class="mf">9.8</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>:  <span class="mi">6974</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_jumptables</span><span class="w"></span>
<span class="w"> </span><span class="mf">3.3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>:  <span class="mi">2381</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_switch</span><span class="w"></span>
<span class="w"> </span><span class="mf">2.2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>:  <span class="mi">1561</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_br_table</span><span class="w"></span>
<span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>:   <span class="mi">343</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">insert_call</span><span class="w"></span>
</code></pre></div>
<p>&lt;details&gt;<br>
    &lt;summary&gt;<br>
    I also tried grouping by the first two stack frames, and about 30% come from &lt;code&gt;insert_opcode&lt;/code&gt; which is not unexpected.<br>
    &lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Two</span><span class="w"> </span><span class="n">Line</span><span class="w"> </span><span class="n">duplicates</span><span class="w"></span>
<span class="mf">29.6</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">21108</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">insert_opcode</span><span class="w"></span>
<span class="mf">12.8</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">9163</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_target_block</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_bricmp</span><span class="w"></span>
<span class="mf">9.8</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">6974</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_jumptables</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate</span><span class="w"></span>
<span class="mf">7.9</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">5615</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">stack_slot_with_size</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_load_store_address</span><span class="w"></span>
<span class="mf">7.3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">5209</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_bricmp</span><span class="w"></span>
<span class="mf">4.8</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">3401</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">stack_slot_with_size</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">insert_stack_store</span><span class="w"></span>
<span class="mf">4.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">2833</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">insert_stack_store</span><span class="w"></span>
<span class="mf">3.7</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">2642</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="o">&lt;</span><span class="n">alloc</span>::<span class="n">vec</span>::<span class="nb">Vec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">vec</span>::<span class="n">spec_from_iter_nested</span>::<span class="n">SpecFromIterNested</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">I</span><span class="o">&gt;&gt;</span>::<span class="n">from_iter</span><span class="w"></span>
<span class="mf">3.3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">2381</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_switch</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">finalize_block</span><span class="w"></span>
<span class="mf">2.2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">1603</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">insert_load_store</span><span class="w"></span>
<span class="mf">2.2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">1561</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_br_table</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">finalize_block</span><span class="w"></span>
<span class="mf">1.9</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">1389</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">alloc</span>::<span class="n">vec</span>::<span class="nb">Vec</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">A</span><span class="o">&gt;</span>::<span class="n">extend_desugared</span><span class="w"></span>
<span class="mf">1.7</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">1236</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_switch</span><span class="w"></span>
<span class="mf">1.6</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">1144</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_br_table</span><span class="w"></span>
<span class="mf">1.3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">940</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_target_block</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_br</span><span class="w"></span>
<span class="mf">1.1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">769</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_br</span><span class="w"></span>
<span class="mf">0.9</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">628</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_target_block</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_jump</span><span class="w"></span>
<span class="mf">0.8</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">564</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">insert_const</span><span class="w"></span>
<span class="mf">0.8</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">550</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">insert_cmp</span><span class="w"></span>
<span class="mf">0.8</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">538</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">stack_slot_with_size</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">insert_stack_load</span><span class="w"></span>
<span class="mf">0.7</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">526</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate</span><span class="w"></span>
<span class="mf">0.5</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">343</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">insert_call</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_instructions</span><span class="w"></span>
<span class="mf">0.3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">214</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">insert_stack_load</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<h3>Fixing <code>get_variable_of_type</code></h3>
<p>Most of the issues with <code>get_variable_of_type</code> should go away when we start doing proper instruction selection. </p>
<p>If there are tail uses elsewhere I think we can change <code>get_variable_of_type</code> to generate a variable on demand with a random default value and making sure this variable is not used anywhere else (by not including it in the variable pool).</p>
<p>This should pretty much cover all scenarios.</p>
<h3>Fixing issues with invalid blocks / jumptables</h3>
<p>I've updated the "Mostly forward branching" PR to entirely fix these issues by being smarter about which terminators we can insert.</p>
<p>See: <a href="https://github.com/bytecodealliance/wasmtime/pull/4894">https://github.com/bytecodealliance/wasmtime/pull/4894</a></p>
<h3><code>insert_call</code></h3>
<p>I think we can easily fix this by not generating a call if we don't have a func ref, but its only about 0.5% so I'm going to leave this for later.</p>
<blockquote>
<p>Any instructions with at least one operand which is not a "value". For example, stack load/store, with their need for a stack slot operand. Or function calls, which need a function reference, and also have a type signature that depends on the selected function reference. My WIP patch handles stack slots in 0c9689b#diff-226e0f113ddbbcedaa5265109a951e52d30aa35307537684f56a5e6bedc9ba0eR369-R390 but I didn't get to handling calls yet.</p>
</blockquote>
<p>What do you think about doing something similar to what you did in the WIP patch but with a base on the opcode signature table.</p>
<p>After generating the resources for the function we filter the opcodes based on signature. Most opcodes are fairly easy, we just need to ensure that we have the right variable types.</p>
<p>For <code>call</code> and <code>call_indirect</code>, we can also filter out function references where we don't have the correct types. If we end up with 0 valid references we can also filter out these opcodes from ever being selected.</p>
<p><code>stack_load</code>/<code>stack_stores</code> are also similar in that we can filter them out based on if we have stack slots with enough space for the type and if we have variables to store or load those types.</p>
<p>I think this is pretty much what you were doing in the WIP patch, but instead of generating the options we filter the options. This is also closer to how I imagine it working when we move to generating the opcodes from <code>cranelift-meta</code>.</p>
<p>I'll try to implement something along these lines during the week.</p>
<blockquote>
<p>I've observed that we discard an input if CLIF validation fails after the NaN canonicalization pass. I think we should defer canonicalization until we're about to run the function, instead of while we're generating it. And probably panic instead of ignoring the error.</p>
</blockquote>
<p>Panicking sounds like a good idea because it should never fail there. (I've opened #4896 for this)</p>
<p>I'd still like to keep canonicalization on the <code>fuzzgen</code> crate. If anyone else wants to run random clif it would be nice to be able to depend on only that crate. Inside <code>fuzzgen</code> we can run those passes later, but not by much we only run them after fully generating the function.</p>
<blockquote>
<p>As a bigger project, maybe we should try doing something like <a href="https://github.com/bytecodealliance/wasm-tools/commit/f229c4fa03d45884f95ab392f672f4477c5ab4df">wasm-smith's new no-trapping mode</a>.</p>
</blockquote>
<p>I think we should still allow some degree of trapping, we've caught a bunch of issues with the interpreter due to this. However I also think we shou<br>
[message truncated]</p>
</blockquote>



<a name="298433711"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/298433711" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#298433711">(Sep 12 2022 at 17:59)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/3050#issuecomment-1243037213">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<blockquote>
<p>There's a general goal in arbitrary that it shouldn't fail (rust-fuzz/arbitrary@1d2f653). Unstructured::choose may be the only method that ever actually fails, though I haven't checked. If so, we primarily need to audit for calls to choose where we might pass in an empty slice, and avoid doing that. We can also try replacing ? operators with .unwrap() and see if any fail. Or maybe print a stack trace before returning the error, with std::backtrace::Backtrace.</p>
</blockquote>
<p>So I did this last one, I recorded backtraces for <code>Unstructured::choose</code> where we fail due to a empty choice. And from the numbers it appears to be <em>most</em> of the cases where fail to generate an input. It tracks with previous measurements of being about 50% of the inputs.</p>
<p>See this <a href="https://github.com/afonso360/wasmtime/tree/fuzz-rejection">branch</a> for the backtrace printing.<br>
I used <a href="https://gist.github.com/afonso360/f5278ab32d450658110f5c741c5896a7">this script</a> to group and print the backtraces.</p>
<p>With 150k execs we got the following results: (Reordered for better readability)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Loaded</span><span class="w"> </span><span class="mi">71331</span><span class="w"> </span><span class="n">stacks</span><span class="w"></span>

<span class="n">First</span><span class="w"> </span><span class="n">Line</span><span class="w"> </span><span class="n">duplicates</span><span class="w"></span>
<span class="mf">55.8</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">39787</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="mf">15.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">10731</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_target_block</span><span class="w"></span>
<span class="mf">13.4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>:  <span class="mi">9554</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">stack_slot_with_size</span><span class="w"></span>
<span class="w"> </span><span class="mf">9.8</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>:  <span class="mi">6974</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_jumptables</span><span class="w"></span>
<span class="w"> </span><span class="mf">3.3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>:  <span class="mi">2381</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_switch</span><span class="w"></span>
<span class="w"> </span><span class="mf">2.2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>:  <span class="mi">1561</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_br_table</span><span class="w"></span>
<span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>:   <span class="mi">343</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">insert_call</span><span class="w"></span>
</code></pre></div>
<p>&lt;details&gt;<br>
    &lt;summary&gt;<br>
    I also tried grouping by the first two stack frames, and about 30% come from &lt;code&gt;insert_opcode&lt;/code&gt; which is not unexpected.<br>
    &lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Two</span><span class="w"> </span><span class="n">Line</span><span class="w"> </span><span class="n">duplicates</span><span class="w"></span>
<span class="mf">29.6</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">21108</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">insert_opcode</span><span class="w"></span>
<span class="mf">12.8</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">9163</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_target_block</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_bricmp</span><span class="w"></span>
<span class="mf">9.8</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">6974</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_jumptables</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate</span><span class="w"></span>
<span class="mf">7.9</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">5615</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">stack_slot_with_size</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_load_store_address</span><span class="w"></span>
<span class="mf">7.3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">5209</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_bricmp</span><span class="w"></span>
<span class="mf">4.8</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">3401</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">stack_slot_with_size</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">insert_stack_store</span><span class="w"></span>
<span class="mf">4.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">2833</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">insert_stack_store</span><span class="w"></span>
<span class="mf">3.7</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">2642</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="o">&lt;</span><span class="n">alloc</span>::<span class="n">vec</span>::<span class="nb">Vec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">vec</span>::<span class="n">spec_from_iter_nested</span>::<span class="n">SpecFromIterNested</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">I</span><span class="o">&gt;&gt;</span>::<span class="n">from_iter</span><span class="w"></span>
<span class="mf">3.3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">2381</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_switch</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">finalize_block</span><span class="w"></span>
<span class="mf">2.2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">1603</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">insert_load_store</span><span class="w"></span>
<span class="mf">2.2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">1561</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_br_table</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">finalize_block</span><span class="w"></span>
<span class="mf">1.9</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">1389</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">alloc</span>::<span class="n">vec</span>::<span class="nb">Vec</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">A</span><span class="o">&gt;</span>::<span class="n">extend_desugared</span><span class="w"></span>
<span class="mf">1.7</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">1236</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_switch</span><span class="w"></span>
<span class="mf">1.6</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">1144</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_br_table</span><span class="w"></span>
<span class="mf">1.3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">940</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_target_block</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_br</span><span class="w"></span>
<span class="mf">1.1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">769</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_br</span><span class="w"></span>
<span class="mf">0.9</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">628</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_target_block</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_jump</span><span class="w"></span>
<span class="mf">0.8</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">564</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">insert_const</span><span class="w"></span>
<span class="mf">0.8</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">550</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">insert_cmp</span><span class="w"></span>
<span class="mf">0.8</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">538</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">stack_slot_with_size</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">insert_stack_load</span><span class="w"></span>
<span class="mf">0.7</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">526</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate</span><span class="w"></span>
<span class="mf">0.5</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">343</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">insert_call</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">generate_instructions</span><span class="w"></span>
<span class="mf">0.3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Count</span>: <span class="mi">214</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Line</span>:
    <span class="mi">0</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">FunctionGenerator</span>::<span class="n">get_variable_of_type</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">cranelift_fuzzgen</span>::<span class="n">function_generator</span>::<span class="n">insert_stack_load</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<h3>Fixing <code>get_variable_of_type</code></h3>
<p>Most of the issues with <code>get_variable_of_type</code> should go away when we start doing proper instruction selection. </p>
<p>If there are tail uses elsewhere I think we can change <code>get_variable_of_type</code> to generate a variable on demand with a random default value and making sure this variable is not used anywhere else (by not including it in the variable pool).</p>
<p>This should pretty much cover all scenarios.</p>
<h3>Fixing issues with invalid blocks / jumptables</h3>
<p>I've updated the "Mostly forward branching" PR to entirely fix these issues by being smarter about which terminators we can insert.</p>
<p>See: <a href="https://github.com/bytecodealliance/wasmtime/pull/4894">https://github.com/bytecodealliance/wasmtime/pull/4894</a></p>
<h3><code>insert_call</code></h3>
<p>I think we can easily fix this by not generating a call if we don't have a func ref, but its only about 0.5% so I'm going to leave this for later.</p>
<blockquote>
<p>Any instructions with at least one operand which is not a "value". For example, stack load/store, with their need for a stack slot operand. Or function calls, which need a function reference, and also have a type signature that depends on the selected function reference. My WIP patch handles stack slots in 0c9689b#diff-226e0f113ddbbcedaa5265109a951e52d30aa35307537684f56a5e6bedc9ba0eR369-R390 but I didn't get to handling calls yet.</p>
</blockquote>
<p>What do you think about doing something similar to what you did in the WIP patch but with a base on the opcode signature table.</p>
<p>After generating the resources for the function we filter the opcodes based on signature. Most opcodes are fairly easy, we just need to ensure that we have the right variable types.</p>
<p>For <code>call</code> and <code>call_indirect</code>, we can also filter out function references where we don't have the correct types. If we end up with 0 valid references we can also filter out these opcodes from ever being selected.</p>
<p><code>stack_load</code>/<code>stack_stores</code> are also similar in that we can filter them out based on if we have stack slots with enough space for the type and if we have variables to store or load those types.</p>
<p>I think this is pretty much what you were doing in the WIP patch, but instead of generating the options we filter the options. This is also closer to how I imagine it working when we move to generating the opcodes from <code>cranelift-meta</code>.</p>
<p>I'll try to implement something along these lines during the week.</p>
<blockquote>
<p>I've observed that we discard an input if CLIF validation fails after the NaN canonicalization pass. I think we should defer canonicalization until we're about to run the function, instead of while we're generating it. And probably panic instead of ignoring the error.</p>
</blockquote>
<p>Panicking sounds like a good idea because it should never fail there. (I've opened #4896 for this)</p>
<p>I'd still like to keep canonicalization on the <code>fuzzgen</code> crate. If anyone else wants to run random clif it would be nice to be able to depend on only that crate. Inside <code>fuzzgen</code> we can run those passes later, but not by much we only run them after fully generating the function.</p>
<p>Edit: Reading <a href="https://github.com/bytecodealliance/wasmtime/pull/4896#pullrequestreview-1104415283">https://github.com/bytecodealliance/wasmtime/pull/4896#pullrequestreview-1104415283</a> made me realize why this would be important. </p>
<blockquote>
<p>As a bigger project, maybe we should try doing something like [wasm-smith's new no-trapping mode](<a href="https://github.com/bytecodealliance/wasm-tools/commit/f229c4fa03d45884f95ab392f672f4477c5ab4df">https://github.com/bytecodealliance/wasm-tools/commit/f229c4fa03d45884f95ab392f672f4477c5ab4df</a><br>
[message truncated]</p>
</blockquote>
</blockquote>



<a name="298500772"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/298500772" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#298500772">(Sep 13 2022 at 01:00)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/issues/3050#issuecomment-1244761070">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<blockquote>
<p>So I did this last one, I recorded backtraces for <code>Unstructured::choose</code> where we fail due to a empty choice. [...] With 150k execs we got the following results:</p>
<p>```<br>
Loaded 71331 stacks  </p>
<p>First Line duplicates<br>
55.8 - Count: 39787 - Line:    0: cranelift_fuzzgen::function_generator::FunctionGenerator::get_variable_of_type<br>
...<br>
```</p>
<p>I also tried grouping by the first two stack frames, and about 30% come from <code>insert_opcode</code> which is not unexpected.</p>
</blockquote>
<p>This is so cool!</p>
<p>The numbers in #4894 are confusing me though. The number of valid inputs doesn't agree with the number of stack traces. For example, the baseline reported in that PR had 31,622 invalid inputs according to the stats, but only 20,139 stack traces. Were those from different runs, or are there invalid inputs that are not being measured?</p>
<p>Also: of failures during the baseline run, roughly 27% were due to choosing an impossible terminator, and the other 73% were from instruction selection. After the PR, you captured about 71% as many stack traces, which is close enough to 73% to seem plausibly like variation due to random chance.</p>
<p>So I'd assumed the PR would have 71-73% as many invalid inputs. Instead it had about 92% as many invalid inputs. So the effect of the PR on the number of valid inputs was rather smaller than I thought it would be. I think this is consistent with a bunch of invalid inputs not capturing stack traces.</p>
<p>I've written a throwaway patch for the <code>arbitrary</code> crate that applies the same backtrace logic you used, but does it in the few places where that crate can actually construct a new error. Apply <a href="https://github.com/bytecodealliance/wasmtime/files/9552538/trace-arbitrary-errors.txt">trace-arbitrary-errors.txt</a> to a local clone of <a href="https://github.com/rust-fuzz/arbitrary/">rust-fuzz/arbitrary</a>, then tell Cargo to <a href="https://doc.rust-lang.org/cargo/reference/overriding-dependencies.html">override dependencies</a> with your copy.</p>
<p>You should get similar results as your current branch without having to wrap your <code>choose!</code> macro around every single thing, except for a couple changes that I think might be informative. For one, this means the stack trace includes calls inside <code>arbitrary</code>, so you'll want to compare more stack frames. I also changed it to report which error occurred (<code>EmptyChoose</code>, <code>NotEnoughData</code>, or <code>IncorrectFormat</code>), although you can also tell from the stack trace, so feel free to remove that.</p>
<p>This still misses stack traces for errors which originated from <code>DataValue::from_integer</code> (which I think shouldn't fail) or other calls that don't invoke <code>arbitrary</code> (but with #4896 merged, I can't find any others). But I hope it will be very close to getting a stack trace for every invalid input.</p>
<p>By the way, do you need to limit the number of stack frames at all? I'd expect comparing the entire stack trace to work fine in this case because there aren't many control flow paths in cranelift-fuzzgen. So on Linux/Cygwin/WSL I'd do something like <code>sha1sum stack/* | sort | uniq -cw40 | sort -rn</code> to get a list of representative stack traces sorted by how often they occurred.</p>
<blockquote>
<p>I think we can easily fix [insert_call] by not generating a call if we don't have a func ref, but its only about 0.5% so I'm going to leave this for later.</p>
</blockquote>
<p>It may be easy when you're doing the rest of the instruction selection work, but I agree, at 0.5% there's no rush. That said, in #4894 you measured double-digit percentages of failures in <code>insert_call</code>. Maybe in the run above you happened to get really lucky?</p>
<blockquote>
<p>What do you think about doing something similar to what you did in the WIP patch but with a base on the opcode signature table. [...] I think this is pretty much what you were doing in the WIP patch, but instead of generating the options we filter the options.</p>
</blockquote>
<p>That all sounds great. I don't have a strong attachment to the style I used. The main thing I liked about it was capturing borrows of the appropriate slices in each option. I liked being able to avoid looking up resources when generating an instruction, by remembering what resources I already looked up when generating the list of choices. If there's a lookup in both places, I worry that they could get out of sync. So if you find that it's easy to do that while filtering options, I'd like that; but if it's not easy, I don't care that much.</p>
<blockquote>
<blockquote>
<p>As a bigger project, maybe we should try doing something like <a href="https://github.com/bytecodealliance/wasm-tools/commit/f229c4fa03d45884f95ab392f672f4477c5ab4df">wasm-smith's new no-trapping mode</a>.</p>
</blockquote>
<p>I think we should still allow some degree of trapping, we've caught a bunch of issues with the interpreter due to this.</p>
</blockquote>
<p>I don't understand: how do we catch interpreter bugs if we silently throw out cases where the interpreter traps? Are these bugs where the interpreter should have trapped but it didn't, so we only saw the trap during native-code execution?</p>
<p>To make sure we're talking about the same thing: "no-trapping mode" means generating extra code to ensure that the inputs are always valid for instructions that may trap. It doesn't mean disabling instructions that could trap. For example, you could bitwise-or 1 into the denominator of a division, so that it's never 0 regardless of how the value was generated.</p>
</blockquote>



<a name="299025291"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/299025291" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#299025291">(Sep 15 2022 at 18:12)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/issues/3050#issuecomment-1248439036">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<blockquote>
<p>The numbers in #4894 are confusing me though. The number of valid inputs doesn't agree with the number of stack traces. For example, the baseline reported in that PR had 31,622 invalid inputs according to the stats, but only 20,139 stack traces. Were those from different runs, or are there invalid inputs that are not being measured?</p>
</blockquote>
<p>I think this was an issue with #4894. I've re run the new benchmarks with your patch and it looks like we are now getting the expected results. See: <a href="https://github.com/bytecodealliance/wasmtime/pull/4894#issuecomment-1248438739">https://github.com/bytecodealliance/wasmtime/pull/4894#issuecomment-1248438739</a></p>
<blockquote>
<p>By the way, do you need to limit the number of stack frames at all? I'd expect comparing the entire stack trace to work fine in this case because there aren't many control flow paths in cranelift-fuzzgen. So on Linux/Cygwin/WSL I'd do something like <code>sha1sum stack/* | sort | uniq -cw40 | sort -rn</code> to get a list of representative stack traces sorted by how often they occurred.</p>
</blockquote>
<p>No issues, it all seemed to work fine, although it was a bit slow with 70k inputs, but no big deal.</p>
<blockquote>
<p>It may be easy when you're doing the rest of the instruction selection work, but I agree, at 0.5% there's no rush. That said, in #4894 you measured double-digit percentages of failures in <code>insert_call</code>. Maybe in the run above you happened to get really lucky?</p>
</blockquote>
<p>I have no explanation for this. The 150k run above did start from a slightly larger corpus that I kept using while developing. But the one on #4894 is the OSS-Fuzz original corpus, maybe that makes a difference? That one is also only 50k runs and maybe that also figures into it? To be honest I'm kind of at a loss here.</p>
<blockquote>
<p>That all sounds great. I don't have a strong attachment to the style I used. The main thing I liked about it was capturing borrows of the appropriate slices in each option. I liked being able to avoid looking up resources when generating an instruction, by remembering what resources I already looked up when generating the list of choices. If there's a lookup in both places, I worry that they could get out of sync. So if you find that it's easy to do that while filtering options, I'd like that; but if it's not easy, I don't care that much.</p>
</blockquote>
<p>I'll try to work something out where we can preserver those constraints, I agree, I don't like the lookup in both places.</p>
<blockquote>
<blockquote>
<p>I think we should still allow some degree of trapping, we've caught a bunch of issues with the interpreter due to this.</p>
</blockquote>
<p>I don't understand: how do we catch interpreter bugs if we silently throw out cases where the interpreter traps? Are these bugs where the interpreter should have trapped but it didn't, so we only saw the trap during native-code execution?</p>
</blockquote>
<p>Yes, that's exactly it. So far it has happened 2 or 3 times (not sure) and it was in <code>div</code>, where we didn't properly catch div by zero and in <code>rem</code> where the remainder of <code>-1</code> should also trap. In these cases the interpreter actually crashed, but even if it didn't hopefully we would have caught those when comparing the results with the native execution.</p>
<p>Another reason is that eventually I want to work on correct trapping semantics for the interpreter and testing those via the fuzzer and building the possible test cases now is easier than trying to do it all later.</p>
<blockquote>
<p>To make sure we're talking about the same thing: "no-trapping mode" means generating extra code to ensure that the inputs are always valid for instructions that may trap. It doesn't mean disabling instructions that could trap. For example, you could bitwise-or 1 into the denominator of a division, so that it's never 0 regardless of how the value was generated.</p>
</blockquote>
<p>Yeah, and that is pretty much how I'm planing to fix <code>int_divz</code> issues, however I want to add a config where sometimes we don't insert those. Or insert them only for some instructions.</p>
</blockquote>



<a name="300674446"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/300674446" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#300674446">(Sep 25 2022 at 17:30)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<p>In #3038 we introduced the initial version of the Cranelift CLIF-level differential fuzzer. </p>
<p>This fuzzer generates CLIF modules that are run on the interpreter and subsequently on the host machine (assuming no traps / invalid memory accesses) comparing the outputs of each run.</p>
<p>Roadmap:</p>
<ul>
<li>[x] Initial introduction (#3038)</li>
<li>[x] Generating test inputs with control flow<ul>
<li>[x] Generate multiple blocks and basic jump instructions (#3094)</li>
<li>[x] Generate <code>br_table</code>'s and other jump table jumps (#3299)</li>
</ul>
</li>
<li>[ ] Generating memory loads/stores<ul>
<li>[x] Stack<ul>
<li>[x] Interpreter Support (#3187)</li>
<li>[x] Fuzzer Support (#4438)</li>
</ul>
</li>
<li>[ ] Heap<ul>
<li>[x] Interpreter Support (#3302)</li>
<li>[ ] Fuzzer Support</li>
</ul>
</li>
<li>[ ] Table<ul>
<li>[x] Interpreter Support (#4433)</li>
<li>[ ] Fuzzer Support</li>
</ul>
</li>
<li>[ ] Symbols<ul>
<li>[ ] Interpreter Support</li>
<li>[ ] Fuzzer Support</li>
</ul>
</li>
<li>[ ] Others<ul>
<li>[ ] Cross endianness loads/stores</li>
<li>[ ] <code>notrap</code> MemFlags</li>
<li>[ ] <code>aligned</code> MemFlags</li>
<li>[ ] <code>readonly</code> MemFlags</li>
</ul>
</li>
</ul>
</li>
<li>[ ] Generating calls<ul>
<li>[x] Generating LibCall's (#4782)</li>
<li>[ ] Generating Function Calls</li>
<li>[ ] Indirect Function Calls</li>
</ul>
</li>
<li>[ ] Full coverage of arithmetic ops<ul>
<li>[ ] Extend the codegen in the <code>cranelift-meta</code> crate to provide a table of acceptable opcodes and types</li>
</ul>
</li>
<li>[ ] Full coverage of SIMD ops</li>
<li>[ ] Misc<ul>
<li>[ ] Add <code>SourceLoc</code> to instructions</li>
<li>[ ] Add ValueLabels to instructions<br>
</li>
</ul>
</li>
</ul>
</blockquote>



<a name="319432596"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233050%20Tracking%20issue%20for%20the%20Cranelift%20C.../near/319432596" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233050.20Tracking.20issue.20for.20the.20Cranelift.20C.2E.2E.2E.html#319432596">(Jan 04 2023 at 17:09)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/issues/3050#issuecomment-1371194702">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3050">issue #3050</a>:</p>
<blockquote>
<p>@jameysharp @elliottt <span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> </p>
<p>Here's what I played around with regarding generating the Opcodes, I tried to use the <a href="https://docs.rs/cranelift-codegen/latest/cranelift_codegen/ir/instructions/struct.OpcodeConstraints.html">constraints</a> encoded in the opcodes to generate valid signatures. IIRC I think they were too underspecified and at some point I stopped looking into it, but I don't remember a lot.</p>
<p>It does work for some opcodes, I do remember that.</p>
<p>It also needs a custom branch of cranelift with some additional interfaces on some types.</p>
<p>Repository:<br>
<a href="https://github.com/afonso360/cranelift-opcode-gen">https://github.com/afonso360/cranelift-opcode-gen</a></p>
<p>Custom Branch<br>
<a href="https://github.com/afonso360/wasmtime/commits/fuzzgen-gen-inst">https://github.com/afonso360/wasmtime/commits/fuzzgen-gen-inst</a></p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>