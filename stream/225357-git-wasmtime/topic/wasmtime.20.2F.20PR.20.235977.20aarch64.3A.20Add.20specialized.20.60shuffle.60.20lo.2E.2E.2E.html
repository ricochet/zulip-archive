<html>
<head><meta charset="utf-8"><title>wasmtime / PR #5977 aarch64: Add specialized `shuffle` lo... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235977.20aarch64.3A.20Add.20specialized.20.60shuffle.60.20lo.2E.2E.2E.html">wasmtime / PR #5977 aarch64: Add specialized `shuffle` lo...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="340756953"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235977%20aarch64%3A%20Add%20specialized%20%60shuffle%60%20lo.../near/340756953" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235977.20aarch64.3A.20Add.20specialized.20.60shuffle.60.20lo.2E.2E.2E.html#340756953">(Mar 10 2023 at 03:28)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/5977">PR #5977</a> from <code>aarch64-shuffles</code> to <code>main</code>:</p>
<blockquote>
<p>This is the equivalent of <a href="https://github.com/bytecodealliance/wasmtime/pull/5930">https://github.com/bytecodealliance/wasmtime/pull/5930</a> but for AArch64. I went through various instructions I saw for AArch64 and added corresponding <code>shuffle</code> lowerings where appropriate. These lowerings cover all the lowerings I found in the meshoptimizer repository plus a few more based on various instructions I found while perusing ARM's documentation. Like with x86_64 I've tried to make sure there's a runtest and a precise-output test for each lowering, even if some of them probably overlap with the x86_64 runtests.</p>
<p>I'll note that many of these lowerings probably won't end up getting used by "portable" wasm binaries since some of the shifts here are pretty specific to AArch64 and don't have efficient 1/2 instruction lowerings on x86_64. That being said these are useful to any sort of hypothetical Cranelift-as-an-AArch64-backend-compiler such as rustc_cranelift_codegen since this broadens the spectrum of instructions supported by Cranelift's AArch64 backend.</p>
</blockquote>



<a name="340894689"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235977%20aarch64%3A%20Add%20specialized%20%60shuffle%60%20lo.../near/340894689" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235977.20aarch64.3A.20Add.20specialized.20.60shuffle.60.20lo.2E.2E.2E.html#340894689">(Mar 10 2023 at 15:35)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5977">PR #5977</a> from <code>aarch64-shuffles</code> to <code>main</code>.</p>



<a name="340945823"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235977%20aarch64%3A%20Add%20specialized%20%60shuffle%60%20lo.../near/340945823" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235977.20aarch64.3A.20Add.20specialized.20.60shuffle.60.20lo.2E.2E.2E.html#340945823">(Mar 10 2023 at 19:15)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5977#pullrequestreview-1335467277">PR review</a>.</p>



<a name="340945825"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235977%20aarch64%3A%20Add%20specialized%20%60shuffle%60%20lo.../near/340945825" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235977.20aarch64.3A.20Add.20specialized.20.60shuffle.60.20lo.2E.2E.2E.html#340945825">(Mar 10 2023 at 19:15)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5977#pullrequestreview-1335467277">PR review</a>.</p>



<a name="340945827"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235977%20aarch64%3A%20Add%20specialized%20%60shuffle%60%20lo.../near/340945827" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235977.20aarch64.3A.20Add.20specialized.20.60shuffle.60.20lo.2E.2E.2E.html#340945827">(Mar 10 2023 at 19:15)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5977#discussion_r1132778452">PR review comment</a>:</p>
<blockquote>
<p>I wonder if it would make these patterns clearer to have an extractor something like <code>(shuffle_immediate 30 28 26 ...)</code> (with external Rust impl that is <code>Fn(&amp;mut self, imm: Immediate) -&gt; Option&lt;(u8, u8, u8, u8, ...)&gt;</code>)?</p>
</blockquote>



<a name="340945828"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235977%20aarch64%3A%20Add%20specialized%20%60shuffle%60%20lo.../near/340945828" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235977.20aarch64.3A.20Add.20specialized.20.60shuffle.60.20lo.2E.2E.2E.html#340945828">(Mar 10 2023 at 19:15)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5977#discussion_r1132775878">PR review comment</a>:</p>
<blockquote>
<p>Can we add doc comments here to describe what pattern in the <code>Immediate</code> each of these etors matches on? (Likewise below)</p>
</blockquote>



<a name="340955858"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235977%20aarch64%3A%20Add%20specialized%20%60shuffle%60%20lo.../near/340955858" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235977.20aarch64.3A.20Add.20specialized.20.60shuffle.60.20lo.2E.2E.2E.html#340955858">(Mar 10 2023 at 20:11)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5977#pullrequestreview-1335548191">PR review</a>.</p>



<a name="340955859"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235977%20aarch64%3A%20Add%20specialized%20%60shuffle%60%20lo.../near/340955859" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235977.20aarch64.3A.20Add.20specialized.20.60shuffle.60.20lo.2E.2E.2E.html#340955859">(Mar 10 2023 at 20:11)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/5977#discussion_r1132830743">PR review comment</a>:</p>
<blockquote>
<p>I originally did this in <a href="https://github.com/bytecodealliance/wasmtime/pull/5905">https://github.com/bytecodealliance/wasmtime/pull/5905</a> but @jameysharp preferred the hex masks instead. I don't mind myself, but I do think it's worth being consistent across the backends so I'd want to update all the x64 things if these aarch64 rules change as wlel.</p>
</blockquote>



<a name="340956045"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235977%20aarch64%3A%20Add%20specialized%20%60shuffle%60%20lo.../near/340956045" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235977.20aarch64.3A.20Add.20specialized.20.60shuffle.60.20lo.2E.2E.2E.html#340956045">(Mar 10 2023 at 20:12)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5977#pullrequestreview-1335549224">PR review</a>.</p>



<a name="340956046"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235977%20aarch64%3A%20Add%20specialized%20%60shuffle%60%20lo.../near/340956046" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235977.20aarch64.3A.20Add.20specialized.20.60shuffle.60.20lo.2E.2E.2E.html#340956046">(Mar 10 2023 at 20:12)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5977#discussion_r1132831394">PR review comment</a>:</p>
<blockquote>
<p>Funny, I suggested exactly the opposite in a previous PR <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span> </p>
</blockquote>



<a name="340956071"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235977%20aarch64%3A%20Add%20specialized%20%60shuffle%60%20lo.../near/340956071" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235977.20aarch64.3A.20Add.20specialized.20.60shuffle.60.20lo.2E.2E.2E.html#340956071">(Mar 10 2023 at 20:12)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5977">PR #5977</a> from <code>aarch64-shuffles</code> to <code>main</code>.</p>



<a name="340957987"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235977%20aarch64%3A%20Add%20specialized%20%60shuffle%60%20lo.../near/340957987" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235977.20aarch64.3A.20Add.20specialized.20.60shuffle.60.20lo.2E.2E.2E.html#340957987">(Mar 10 2023 at 20:24)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5977#pullrequestreview-1335564406">PR review</a>.</p>



<a name="340957990"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235977%20aarch64%3A%20Add%20specialized%20%60shuffle%60%20lo.../near/340957990" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235977.20aarch64.3A.20Add.20specialized.20.60shuffle.60.20lo.2E.2E.2E.html#340957990">(Mar 10 2023 at 20:24)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5977#discussion_r1132840658">PR review comment</a>:</p>
<blockquote>
<p>Interesting!</p>
<p>I see the points in #5905 now about exposing more opportunity to islec by making the full mask visible as one value; that's a reasonable argument I think. My rationale was that I was having some friction converting hex values in my head to understand the permutation (but maybe the right answer to that is just to think in hex directly). I don't feel too strongly about it, so this is fine as-is.</p>
</blockquote>



<a name="340975394"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235977%20aarch64%3A%20Add%20specialized%20%60shuffle%60%20lo.../near/340975394" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235977.20aarch64.3A.20Add.20specialized.20.60shuffle.60.20lo.2E.2E.2E.html#340975394">(Mar 10 2023 at 22:19)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/5977">PR #5977</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>