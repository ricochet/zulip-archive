<html>
<head><meta charset="utf-8"><title>wasmtime / PR #1916 Fix running filetests with custom flags · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231916.20Fix.20running.20filetests.20with.20custom.20flags.html">wasmtime / PR #1916 Fix running filetests with custom flags</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="201889255"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231916%20Fix%20running%20filetests%20with%20custom%20flags/near/201889255" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231916.20Fix.20running.20filetests.20with.20custom.20flags.html#201889255">(Jun 24 2020 at 18:58)</a>:</h4>
<p>abrown opened <a href="https://github.com/bytecodealliance/wasmtime/pull/1916">PR #1916</a> from <code>fix-1891</code> to <code>master</code>:</p>
<blockquote>
<p>This change fixes the issues described in #1891:</p>
<ul>
<li>it makes the test-running infrastructure aware of what filetests will not be able to run on the current host machine by means of new implementations of <code>TargetIsa::is_compatible_with</code> and <code>Flags::is_compatible_with</code> (generated)</li>
<li>it fixes the issue @bnjbvr described where the <code>TargetIsa</code> created by <code>Parser</code> is unaware of what host it is running on: for <code>test run</code> filetests, this is fixed with a use of <code>Triple::host()</code></li>
</ul>
<p>I now feel like <code>is_compatible_with</code> (like <code>matches</code>) is the wrong wording for that function; it should express that one configuration subsumes another so that it is clear that the opposite may not be true. I'm open to suggestions on that. I also likely need to adjust the ordering of commits at some point. </p>
</blockquote>



<a name="201889269"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231916%20Fix%20running%20filetests%20with%20custom%20flags/near/201889269" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231916.20Fix.20running.20filetests.20with.20custom.20flags.html#201889269">(Jun 24 2020 at 18:58)</a>:</h4>
<p><strong>abrown</strong> requested <a href="https://github.com/bnjbvr">bnjbvr</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1916">PR #1916</a>.</p>



<a name="201889578"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231916%20Fix%20running%20filetests%20with%20custom%20flags/near/201889578" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231916.20Fix.20running.20filetests.20with.20custom.20flags.html#201889578">(Jun 24 2020 at 19:01)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1916#pullrequestreview-436925032">PR Review</a>.</p>



<a name="201889579"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231916%20Fix%20running%20filetests%20with%20custom%20flags/near/201889579" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231916.20Fix.20running.20filetests.20with.20custom.20flags.html#201889579">(Jun 24 2020 at 19:01)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1916#discussion_r445107461">PR Review Comment</a>:</p>
<blockquote>
<div class="codehilite"><pre><span></span><code>                    fmtln!(fmt, &quot;Detail::Preset =&gt; {},&quot;);
</code></pre></div>


<p>This should not short-circuit.</p>
</blockquote>



<a name="201889947"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231916%20Fix%20running%20filetests%20with%20custom%20flags/near/201889947" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231916.20Fix.20running.20filetests.20with.20custom.20flags.html#201889947">(Jun 24 2020 at 19:04)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1916#pullrequestreview-436926818">PR Review</a>.</p>



<a name="201889948"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231916%20Fix%20running%20filetests%20with%20custom%20flags/near/201889948" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231916.20Fix.20running.20filetests.20with.20custom.20flags.html#201889948">(Jun 24 2020 at 19:04)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/1916#discussion_r445108830">PR Review Comment</a>:</p>
<blockquote>
<p>I ended up omitting the <code>self.shared_flags.is_compatible_with(&amp;other.shared_flags)</code> here because here I'm saying "self.isa_flags is more specific than other.isa_flags" (e.g. the host machine has more ISA flags set than the filetest will) but that same logic doesn't apply to the shared flags (e.g. the default shared flags will almost always have less flags set than the filetest).</p>
</blockquote>



<a name="201890122"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231916%20Fix%20running%20filetests%20with%20custom%20flags/near/201890122" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231916.20Fix.20running.20filetests.20with.20custom.20flags.html#201890122">(Jun 24 2020 at 19:05)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1916#pullrequestreview-436927961">PR Review</a>.</p>



<a name="201890124"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231916%20Fix%20running%20filetests%20with%20custom%20flags/near/201890124" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231916.20Fix.20running.20filetests.20with.20custom.20flags.html#201890124">(Jun 24 2020 at 19:05)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/1916#discussion_r445109708">PR Review Comment</a>:</p>
<blockquote>
<p>I was under the impression that once the descriptors move into presets then it will be presets from there on?</p>
</blockquote>



<a name="201923450"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231916%20Fix%20running%20filetests%20with%20custom%20flags/near/201923450" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231916.20Fix.20running.20filetests.20with.20custom.20flags.html#201923450">(Jun 25 2020 at 01:25)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1916#pullrequestreview-437109967">PR Review</a>.</p>



<a name="201923451"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231916%20Fix%20running%20filetests%20with%20custom%20flags/near/201923451" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231916.20Fix.20running.20filetests.20with.20custom.20flags.html#201923451">(Jun 25 2020 at 01:25)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/1916#discussion_r445257789">PR Review Comment</a>:</p>
<blockquote>
<p>And here's an example of the skipped tests on Windows: <a href="https://github.com/bytecodealliance/wasmtime/pull/1916/checks?check_run_id=804670568#step:12:652">https://github.com/bytecodealliance/wasmtime/pull/1916/checks?check_run_id=804670568#step:12:652</a>.</p>
</blockquote>



<a name="201949776"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231916%20Fix%20running%20filetests%20with%20custom%20flags/near/201949776" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231916.20Fix.20running.20filetests.20with.20custom.20flags.html#201949776">(Jun 25 2020 at 09:50)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1916#pullrequestreview-437339752">PR Review</a>.</p>



<a name="201949777"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231916%20Fix%20running%20filetests%20with%20custom%20flags/near/201949777" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231916.20Fix.20running.20filetests.20with.20custom.20flags.html#201949777">(Jun 25 2020 at 09:50)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1916#discussion_r445441316">PR Review Comment</a>:</p>
<blockquote>
<p>It seems so. It isn't guaranteed anywhere though.</p>
</blockquote>



<a name="202009175"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231916%20Fix%20running%20filetests%20with%20custom%20flags/near/202009175" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231916.20Fix.20running.20filetests.20with.20custom.20flags.html#202009175">(Jun 25 2020 at 18:48)</a>:</h4>
<p>alexcrichton edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1916">PR #1916</a> from <code>fix-1891</code> to <code>main</code>:</p>
<blockquote>
<p>This change fixes the issues described in #1891:</p>
<ul>
<li>it makes the test-running infrastructure aware of what filetests will not be able to run on the current host machine by means of new implementations of <code>TargetIsa::is_compatible_with</code> and <code>Flags::is_compatible_with</code> (generated)</li>
<li>it fixes the issue @bnjbvr described where the <code>TargetIsa</code> created by <code>Parser</code> is unaware of what host it is running on: for <code>test run</code> filetests, this is fixed with a use of <code>Triple::host()</code></li>
</ul>
<p>I now feel like <code>is_compatible_with</code> (like <code>matches</code>) is the wrong wording for that function; it should express that one configuration subsumes another so that it is clear that the opposite may not be true. I'm open to suggestions on that. I also likely need to adjust the ordering of commits at some point. </p>
</blockquote>



<a name="202694244"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231916%20Fix%20running%20filetests%20with%20custom%20flags/near/202694244" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231916.20Fix.20running.20filetests.20with.20custom.20flags.html#202694244">(Jul 02 2020 at 14:17)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1916#discussion_r449011586">PR Review Comment</a>:</p>
<blockquote>
<p>Generating Rust code from the meta crate has a cost, in particular it's harder to read, correct errors and maintain over time. For a simple function that doesn't seem to use much of the meta machinery anyways, would it make sense to just implement as a plain function in the codegen (non-meta) crate instead? (With the extra argument that really only x86 needs it, so only this ISA can implement right now)</p>
</blockquote>



<a name="202694245"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231916%20Fix%20running%20filetests%20with%20custom%20flags/near/202694245" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231916.20Fix.20running.20filetests.20with.20custom.20flags.html#202694245">(Jul 02 2020 at 14:17)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1916#pullrequestreview-441691362">PR Review</a>.</p>



<a name="202694246"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231916%20Fix%20running%20filetests%20with%20custom%20flags/near/202694246" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231916.20Fix.20running.20filetests.20with.20custom.20flags.html#202694246">(Jul 02 2020 at 14:17)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1916#pullrequestreview-441691362">PR Review</a>.</p>



<a name="202694247"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231916%20Fix%20running%20filetests%20with%20custom%20flags/near/202694247" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231916.20Fix.20running.20filetests.20with.20custom.20flags.html#202694247">(Jul 02 2020 at 14:17)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1916#discussion_r449012396">PR Review Comment</a>:</p>
<blockquote>
<p>This check is a bit tricky and might be incorrect: if the setting was explicitly set to the default value, then it's different from being unset and inheriting the default value. This suggests that we'd need a different data structure with <code>Option</code>s instead of direct values, and using this to store what's requested by the CLI arguments / test annotations, and comparing this against the real machine capabilities.</p>
</blockquote>



<a name="202694248"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231916%20Fix%20running%20filetests%20with%20custom%20flags/near/202694248" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231916.20Fix.20running.20filetests.20with.20custom.20flags.html#202694248">(Jul 02 2020 at 14:17)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1916#discussion_r449025544">PR Review Comment</a>:</p>
<blockquote>
<p>Same comment as below; could this be implemented in Rust with the same effect but making it easier to maintain?</p>
</blockquote>



<a name="202694249"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231916%20Fix%20running%20filetests%20with%20custom%20flags/near/202694249" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231916.20Fix.20running.20filetests.20with.20custom.20flags.html#202694249">(Jul 02 2020 at 14:17)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1916#discussion_r449027049">PR Review Comment</a>:</p>
<blockquote>
<p>I'm not sure if the question makes sense, but is there a chance that since the x64 new backend uses a different TargetIsa, this downcast may fail when comparing on a native x86 host?</p>
</blockquote>



<a name="203518930"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231916%20Fix%20running%20filetests%20with%20custom%20flags/near/203518930" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231916.20Fix.20running.20filetests.20with.20custom.20flags.html#203518930">(Jul 10 2020 at 15:13)</a>:</h4>
<p>abrown closed without merge <a href="https://github.com/bytecodealliance/wasmtime/pull/1916">PR #1916</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>