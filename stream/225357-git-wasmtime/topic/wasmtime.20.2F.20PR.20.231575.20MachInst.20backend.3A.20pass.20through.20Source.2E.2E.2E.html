<html>
<head><meta charset="utf-8"><title>wasmtime / PR #1575 MachInst backend: pass through Source... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html">wasmtime / PR #1575 MachInst backend: pass through Source...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="194880536"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/194880536" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#194880536">(Apr 22 2020 at 01:37)</a>:</h4>
<p>cfallin opened <a href="https://github.com/bytecodealliance/wasmtime/pull/1575" title="https://github.com/bytecodealliance/wasmtime/pull/1575">PR #1575</a> from <code>test-fixes</code> to <code>master</code>:</p>
<blockquote>
<p>This change adds SourceLoc information per instruction in a <code>VCode&lt;Inst&gt;</code><br>
container, and keeps this information up-to-date across register allocation<br>
and branch reordering. The information is initially collected during<br>
instruction lowering, eventually collected on the MachSection, and finally<br>
provided to the environment that wraps the codegen crate for wasmtime.</p>
<p>This PR is based on top of #1570 and #1571 (part of a series fixing tests).</p>
<p>This PR depends on wasmtime/regalloc.rs#50, a change to the register<br>
allocator to provide instruction-granularity info on the rewritten<br>
instruction stream (rather than block-granularity).</p>
<p>With the prior PRs applied as well, quite a few more unit tests pass;<br>
the exclusion list in #1526 should be updated if this PR lands first.</p>
</blockquote>



<a name="194880537"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/194880537" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#194880537">(Apr 22 2020 at 01:37)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/bnjbvr" title="https://github.com/bnjbvr">bnjbvr</a> and <a href="https://github.com/julian-seward1" title="https://github.com/julian-seward1">julian-seward1</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1575" title="https://github.com/bytecodealliance/wasmtime/pull/1575">PR #1575</a>.</p>



<a name="194880538"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/194880538" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#194880538">(Apr 22 2020 at 01:37)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/bnjbvr" title="https://github.com/bnjbvr">bnjbvr</a> and <a href="https://github.com/julian-seward1" title="https://github.com/julian-seward1">julian-seward1</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1575" title="https://github.com/bytecodealliance/wasmtime/pull/1575">PR #1575</a>.</p>



<a name="194880542"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/194880542" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#194880542">(Apr 22 2020 at 01:37)</a>:</h4>
<p>cfallin edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1575" title="https://github.com/bytecodealliance/wasmtime/pull/1575">PR #1575</a> from <code>test-fixes</code> to <code>master</code>:</p>
<blockquote>
<p>This change adds SourceLoc information per instruction in a <code>VCode&lt;Inst&gt;</code><br>
container, and keeps this information up-to-date across register allocation<br>
and branch reordering. The information is initially collected during<br>
instruction lowering, eventually collected on the MachSection, and finally<br>
provided to the environment that wraps the codegen crate for wasmtime.</p>
<p>This PR is based on top of #1570 and #1571 (part of a series fixing tests).</p>
<p>This PR depends on bytecodealliance/regalloc.rs#50, a change to the register<br>
allocator to provide instruction-granularity info on the rewritten<br>
instruction stream (rather than block-granularity).</p>
<p>With the prior PRs applied as well, quite a few more unit tests pass;<br>
the exclusion list in #1526 should be updated if this PR lands first.</p>
</blockquote>



<a name="194880593"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/194880593" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#194880593">(Apr 22 2020 at 01:38)</a>:</h4>
<p>cfallin edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1575" title="https://github.com/bytecodealliance/wasmtime/pull/1575">PR #1575</a> from <code>test-fixes</code> to <code>master</code>:</p>
<blockquote>
<p>This change adds SourceLoc information per instruction in a <code>VCode&lt;Inst&gt;</code><br>
container, and keeps this information up-to-date across register allocation<br>
and branch reordering. The information is initially collected during<br>
instruction lowering, eventually collected on the MachSection, and finally<br>
provided to the environment that wraps the codegen crate for wasmtime.</p>
<p>This PR is based on top of #1570 and #1571 (part of a series fixing tests).</p>
<p>This PR depends on bytecodealliance/regalloc.rs#50, a change to the register<br>
allocator to provide instruction-granularity info on the rewritten<br>
instruction stream (rather than block-granularity). I have not yet<br>
updated <code>cranelift/codegen/Cargo.toml</code>; we will need to land that PR<br>
and do a release first.</p>
<p>With the prior PRs applied as well, quite a few more unit tests pass;<br>
the exclusion list in #1526 should be updated if this PR lands first.</p>
</blockquote>



<a name="194880615"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/194880615" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#194880615">(Apr 22 2020 at 01:39)</a>:</h4>
<p>cfallin edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1575" title="https://github.com/bytecodealliance/wasmtime/pull/1575">PR #1575</a> from <code>test-fixes</code> to <code>master</code>:</p>
<blockquote>
<p>This change adds SourceLoc information per instruction in a <code>VCode&lt;Inst&gt;</code><br>
container, and keeps this information up-to-date across register allocation<br>
and branch reordering. The information is initially collected during<br>
instruction lowering, eventually collected on the MachSection, and finally<br>
provided to the environment that wraps the codegen crate for wasmtime.</p>
<p>This PR is based on top of #1570 and #1571 (part of a series fixing tests).</p>
<p>This PR depends on bytecodealliance/regalloc.rs#50, a change to the register<br>
allocator to provide instruction-granularity info on the rewritten<br>
instruction stream (rather than block-granularity). I have not yet<br>
updated <code>cranelift/codegen/Cargo.toml</code>; we will need to land that PR<br>
and do a release first.</p>
<p>With the prior PRs applied as well, quite a few more unit tests pass;<br>
the exclusion list in #1526 should be updated if this PR lands first.</p>
<p>Addresses part of #1523 (debug info), though debug info consists of<br>
more than just source-location mapping.</p>
</blockquote>



<a name="194903906"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/194903906" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#194903906">(Apr 22 2020 at 08:59)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1575#pullrequestreview-397984665" title="https://github.com/bytecodealliance/wasmtime/pull/1575#pullrequestreview-397984665">PR Review</a>.</p>



<a name="194903907"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/194903907" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#194903907">(Apr 22 2020 at 08:59)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1575#pullrequestreview-397984665" title="https://github.com/bytecodealliance/wasmtime/pull/1575#pullrequestreview-397984665">PR Review</a>.</p>



<a name="194903909"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/194903909" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#194903909">(Apr 22 2020 at 08:59)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r412801946" title="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r412801946">PR Review Comment</a>:</p>
<blockquote>
<p>Every function is compiled separately without knowledge of the final location in memory, so this can never be absolute. Did you mean relative tot the start of the function?</p>
</blockquote>



<a name="194903910"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/194903910" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#194903910">(Apr 22 2020 at 08:59)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r412802338" title="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r412802338">PR Review Comment</a>:</p>
<blockquote>
<p>There is already a SourceLoc reserved for when the source loc is unknown: SourceLoc::default().</p>
</blockquote>



<a name="194930714"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/194930714" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#194930714">(Apr 22 2020 at 13:34)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1575#pullrequestreview-398157665" title="https://github.com/bytecodealliance/wasmtime/pull/1575#pullrequestreview-398157665">PR Review</a>.</p>



<a name="194930715"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/194930715" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#194930715">(Apr 22 2020 at 13:34)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1575#pullrequestreview-398157665" title="https://github.com/bytecodealliance/wasmtime/pull/1575#pullrequestreview-398157665">PR Review</a>.</p>



<a name="194930716"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/194930716" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#194930716">(Apr 22 2020 at 13:34)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r412954692" title="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r412954692">PR Review Comment</a>:</p>
<blockquote>
<p>nit: current</p>
</blockquote>



<a name="194930718"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/194930718" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#194930718">(Apr 22 2020 at 13:34)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r412981285" title="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r412981285">PR Review Comment</a>:</p>
<blockquote>
<p>nit: to remove one extra level of indent, use <code>expect</code> on the result of take.</p>
</blockquote>



<a name="194930719"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/194930719" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#194930719">(Apr 22 2020 at 13:34)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r412969258" title="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r412969258">PR Review Comment</a>:</p>
<blockquote>
<p>Could the copy be avoided here? (Either by letting the one client iterate on the sections, or return a Map iterator with <code>self.sections.iter().map(|section| &amp;section.srclocs)</code> or something like this)</p>
<p>I think this requires sorting the srclocs before we actually sort them, but this is doable.</p>
</blockquote>



<a name="194930720"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/194930720" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#194930720">(Apr 22 2020 at 13:34)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r412957901" title="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r412957901">PR Review Comment</a>:</p>
<blockquote>
<p>Agreed, it'd be nice to reuse it in lieu of all the <code>Option&lt;SourceLoc&gt;</code> in this patch.</p>
</blockquote>



<a name="194930721"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/194930721" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#194930721">(Apr 22 2020 at 13:34)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r412983613" title="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r412983613">PR Review Comment</a>:</p>
<blockquote>
<p>Could <code>final_srclocs</code> (and thus <code>srclocs</code>) store range of instructions mapping to a single srcloc, instead? (Just the start instruction should be enough, since the next entry's start instruction would be next to the previous' entry end)</p>
</blockquote>



<a name="194930722"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/194930722" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#194930722">(Apr 22 2020 at 13:34)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r412956785" title="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r412956785">PR Review Comment</a>:</p>
<blockquote>
<p>nit: double space between <code>the</code> and <code>region</code></p>
</blockquote>



<a name="194930723"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/194930723" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#194930723">(Apr 22 2020 at 13:34)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r412985557" title="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r412985557">PR Review Comment</a>:</p>
<blockquote>
<p>could you debug_assert that <code>end &gt;= start</code>, for sanity?</p>
</blockquote>



<a name="195005842"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/195005842" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#195005842">(Apr 23 2020 at 00:04)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1575#pullrequestreview-398672879" title="https://github.com/bytecodealliance/wasmtime/pull/1575#pullrequestreview-398672879">PR Review</a>.</p>



<a name="195005843"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/195005843" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#195005843">(Apr 23 2020 at 00:04)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r413414785" title="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r413414785">PR Review Comment</a>:</p>
<blockquote>
<p>I thought about this briefly, but it makes the rearranging after regalloc somewhat more complicated: we have to reconstitute the original per-instruction <code>srcloc</code>s because the block reordering may have split one of the same-location extents in two. I'd rather avoid that complexity (and branchiness), at the cost of slightly more memory... (but perhaps there's another way I've missed).</p>
</blockquote>



<a name="195005894"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/195005894" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#195005894">(Apr 23 2020 at 00:05)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1575" title="https://github.com/bytecodealliance/wasmtime/pull/1575">PR #1575</a> from <code>test-fixes</code> to <code>master</code>:</p>
<blockquote>
<p>This change adds SourceLoc information per instruction in a <code>VCode&lt;Inst&gt;</code><br>
container, and keeps this information up-to-date across register allocation<br>
and branch reordering. The information is initially collected during<br>
instruction lowering, eventually collected on the MachSection, and finally<br>
provided to the environment that wraps the codegen crate for wasmtime.</p>
<p>This PR is based on top of #1570 and #1571 (part of a series fixing tests).</p>
<p>This PR depends on bytecodealliance/regalloc.rs#50, a change to the register<br>
allocator to provide instruction-granularity info on the rewritten<br>
instruction stream (rather than block-granularity). I have not yet<br>
updated <code>cranelift/codegen/Cargo.toml</code>; we will need to land that PR<br>
and do a release first.</p>
<p>With the prior PRs applied as well, quite a few more unit tests pass;<br>
the exclusion list in #1526 should be updated if this PR lands first.</p>
<p>Addresses part of #1523 (debug info), though debug info consists of<br>
more than just source-location mapping.</p>
</blockquote>



<a name="195005904"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/195005904" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#195005904">(Apr 23 2020 at 00:05)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1575#pullrequestreview-398673194" title="https://github.com/bytecodealliance/wasmtime/pull/1575#pullrequestreview-398673194">PR Review</a>.</p>



<a name="195005905"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/195005905" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#195005905">(Apr 23 2020 at 00:05)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r413415126" title="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r413415126">PR Review Comment</a>:</p>
<blockquote>
<p>Yup, fixed, thanks!</p>
</blockquote>



<a name="195005978"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/195005978" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#195005978">(Apr 23 2020 at 00:06)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1575#pullrequestreview-398673421" title="https://github.com/bytecodealliance/wasmtime/pull/1575#pullrequestreview-398673421">PR Review</a>.</p>



<a name="195005980"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/195005980" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#195005980">(Apr 23 2020 at 00:06)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r413415383" title="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r413415383">PR Review Comment</a>:</p>
<blockquote>
<p>Ah, yes, this is much nicer (as well as the corresponding change to not-present indices on the regalloc side) -- done.</p>
</blockquote>



<a name="195006072"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/195006072" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#195006072">(Apr 23 2020 at 00:08)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1575#pullrequestreview-398674059" title="https://github.com/bytecodealliance/wasmtime/pull/1575#pullrequestreview-398674059">PR Review</a>.</p>



<a name="195006074"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/195006074" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#195006074">(Apr 23 2020 at 00:08)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r413416042" title="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r413416042">PR Review Comment</a>:</p>
<blockquote>
<p>Yup, done; wrote a little custom iterator. (I might have been able to get it to work returning an <code>impl Iterator&lt;Item = &amp;'a MachSrcLoc&gt;</code> but getting the types to align for the zero-sections case and otherwise is tricky, since impl-returns must match on all returning paths...)</p>
</blockquote>



<a name="195036478"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/195036478" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#195036478">(Apr 23 2020 at 09:27)</a>:</h4>
<p><strong>bnjbvr</strong> requested <a href="https://github.com/bnjbvr" title="https://github.com/bnjbvr">bnjbvr</a> and <a href="https://github.com/julian-seward1" title="https://github.com/julian-seward1">julian-seward1</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1575" title="https://github.com/bytecodealliance/wasmtime/pull/1575">PR #1575</a>.</p>



<a name="195192833"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/195192833" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#195192833">(Apr 24 2020 at 14:10)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1575#pullrequestreview-399981126" title="https://github.com/bytecodealliance/wasmtime/pull/1575#pullrequestreview-399981126">PR Review</a>.</p>



<a name="195238431"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/195238431" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#195238431">(Apr 24 2020 at 20:07)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1575" title="https://github.com/bytecodealliance/wasmtime/pull/1575">PR #1575</a> from <code>test-fixes</code> to <code>master</code>:</p>
<blockquote>
<p>This change adds SourceLoc information per instruction in a <code>VCode&lt;Inst&gt;</code><br>
container, and keeps this information up-to-date across register allocation<br>
and branch reordering. The information is initially collected during<br>
instruction lowering, eventually collected on the MachSection, and finally<br>
provided to the environment that wraps the codegen crate for wasmtime.</p>
<p>This PR is based on top of #1570 and #1571 (part of a series fixing tests).</p>
<p>This PR depends on bytecodealliance/regalloc.rs#50, a change to the register<br>
allocator to provide instruction-granularity info on the rewritten<br>
instruction stream (rather than block-granularity). I have not yet<br>
updated <code>cranelift/codegen/Cargo.toml</code>; we will need to land that PR<br>
and do a release first.</p>
<p>With the prior PRs applied as well, quite a few more unit tests pass;<br>
the exclusion list in #1526 should be updated if this PR lands first.</p>
<p>Addresses part of #1523 (debug info), though debug info consists of<br>
more than just source-location mapping.</p>
</blockquote>



<a name="195239623"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/195239623" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#195239623">(Apr 24 2020 at 20:18)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1575" title="https://github.com/bytecodealliance/wasmtime/pull/1575">PR #1575</a> from <code>test-fixes</code> to <code>master</code>:</p>
<blockquote>
<p>This change adds SourceLoc information per instruction in a <code>VCode&lt;Inst&gt;</code><br>
container, and keeps this information up-to-date across register allocation<br>
and branch reordering. The information is initially collected during<br>
instruction lowering, eventually collected on the MachSection, and finally<br>
provided to the environment that wraps the codegen crate for wasmtime.</p>
<p>This PR is based on top of #1570 and #1571 (part of a series fixing tests).</p>
<p>This PR depends on bytecodealliance/regalloc.rs#50, a change to the register<br>
allocator to provide instruction-granularity info on the rewritten<br>
instruction stream (rather than block-granularity). I have not yet<br>
updated <code>cranelift/codegen/Cargo.toml</code>; we will need to land that PR<br>
and do a release first.</p>
<p>With the prior PRs applied as well, quite a few more unit tests pass;<br>
the exclusion list in #1526 should be updated if this PR lands first.</p>
<p>Addresses part of #1523 (debug info), though debug info consists of<br>
more than just source-location mapping.</p>
</blockquote>



<a name="195251702"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/195251702" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#195251702">(Apr 24 2020 at 22:25)</a>:</h4>
<p>cfallin merged <a href="https://github.com/bytecodealliance/wasmtime/pull/1575" title="https://github.com/bytecodealliance/wasmtime/pull/1575">PR #1575</a>.</p>



<a name="195281105"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/195281105" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#195281105">(Apr 25 2020 at 11:35)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1575#pullrequestreview-400385205" title="https://github.com/bytecodealliance/wasmtime/pull/1575#pullrequestreview-400385205">PR Review</a>.</p>



<a name="195281106"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/195281106" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#195281106">(Apr 25 2020 at 11:35)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r415044360" title="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r415044360">PR Review Comment</a>:</p>
<blockquote>
<p>I actually want to know about all instructions, not just those with a non-default srcloc.</p>
</blockquote>



<a name="195748046"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/195748046" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#195748046">(Apr 29 2020 at 18:04)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1575#pullrequestreview-402911975" title="https://github.com/bytecodealliance/wasmtime/pull/1575#pullrequestreview-402911975">PR Review</a>.</p>



<a name="195748047"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231575%20MachInst%20backend%3A%20pass%20through%20Source.../near/195748047" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231575.20MachInst.20backend.3A.20pass.20through.20Source.2E.2E.2E.html#195748047">(Apr 29 2020 at 18:04)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r417509624" title="https://github.com/bytecodealliance/wasmtime/pull/1575#discussion_r417509624">PR Review Comment</a>:</p>
<blockquote>
<p>Thanks for pointing this out -- you're right! New PR here: #1632</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>