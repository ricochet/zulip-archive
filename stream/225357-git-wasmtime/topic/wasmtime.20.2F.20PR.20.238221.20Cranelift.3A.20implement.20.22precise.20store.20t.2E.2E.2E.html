<html>
<head><meta charset="utf-8"><title>wasmtime / PR #8221 Cranelift: implement &quot;precise store t... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html">wasmtime / PR #8221 Cranelift: implement &quot;precise store t...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="428379224"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238221%20Cranelift%3A%20implement%20%22precise%20store%20t.../near/428379224" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html#428379224">(Mar 22 2024 at 17:31)</a>:</h4>
<p>cfallin opened <a href="https://github.com/bytecodealliance/wasmtime/pull/8221">PR #8221</a> from <code>cfallin:a-load-a-day-keeps-the-torn-stores-away</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>As discussed at in #7237 and <a href="https://github.com/WebAssembly/design/issues/1490">WebAssembly/design#1490</a>, some instruction-set architectures do not guarantee that a store that "partially traps" (overlaps multiple pages, only one of which disallows the store) does not also have some side-effects. In particular, the part of the store that <em>is</em> legal might succeed.</p>
<p>This has fascinating implications for virtual memory-based WebAssembly heap implementations: when a store is partially out-of-bounds, it should trap (there is no "partially" here: if the last byte is out of bounds, the store is out of bounds). A trapping store should not alter the final memory state, which is observable by the outside world after the trap. Yet, the simple lowering of a Wasm store to a machine store instruction could violate this expectation, in the presence of "store tearing" as described above.</p>
<p>Neither ARMv8 (aarch64) nor RISC-V guarantee lack of store-tearing, and we have observed it in tests on RISC-V.</p>
<p>This PR implements the idea first proposed [here], namely to prepend a load of the same size to every store. The idea is that if the store will trap, the load will as well; and precise exception handling, a well-established principle in all modern ISAs, guarantees that instructions beyond a trapping instruction have no effect.</p>
<p>This is off by default, and is mainly meant as an option to study the impact of this idea and to allow for precise trap execution semantics on affected machines unless/until the spec is clarified.</p>
<p>On an Apple M2 Max machine (aarch64), this was measured to have a 2% performance impact when running <code>spidermonkey.wasm</code> with a simple recursive Fibonacci program. It can be used via the <code>-Ccranelift-ensure_precise_store_traps=true</code> flag to Wasmtime.</p>
<p>[here]:<br>
<a href="https://github.com/WebAssembly/design/issues/1490#issuecomment-1762043224">https://github.com/WebAssembly/design/issues/1490#issuecomment-1762043224</a></p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="428379225"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238221%20Cranelift%3A%20implement%20%22precise%20store%20t.../near/428379225" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html#428379225">(Mar 22 2024 at 17:31)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/elliottt">elliottt</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8221">PR #8221</a>.</p>



<a name="428379226"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238221%20Cranelift%3A%20implement%20%22precise%20store%20t.../near/428379226" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html#428379226">(Mar 22 2024 at 17:31)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8221">PR #8221</a>.</p>



<a name="428379228"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238221%20Cranelift%3A%20implement%20%22precise%20store%20t.../near/428379228" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html#428379228">(Mar 22 2024 at 17:31)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8221">PR #8221</a>.</p>



<a name="428379229"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238221%20Cranelift%3A%20implement%20%22precise%20store%20t.../near/428379229" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html#428379229">(Mar 22 2024 at 17:31)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8221">PR #8221</a>.</p>



<a name="428379835"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238221%20Cranelift%3A%20implement%20%22precise%20store%20t.../near/428379835" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html#428379835">(Mar 22 2024 at 17:35)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/8221#issuecomment-2015578774">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8221">PR #8221</a>:</p>
<blockquote>
<p>@afonso360, if you still have access to your RISC-V hardware and a bit of time to test, it would be useful to confirm that this changes the result of the "torn stores" test case from earlier! @candymate, it would be interesting to confirm that this resolves your fuzzbug as well, and this could be useful for further fuzzing for you.</p>
</blockquote>



<a name="428380647"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238221%20Cranelift%3A%20implement%20%22precise%20store%20t.../near/428380647" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html#428380647">(Mar 22 2024 at 17:40)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8221">PR #8221</a>.</p>



<a name="428381202"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238221%20Cranelift%3A%20implement%20%22precise%20store%20t.../near/428381202" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html#428381202">(Mar 22 2024 at 17:43)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8221#pullrequestreview-1955411415">PR review</a>.</p>



<a name="428381203"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238221%20Cranelift%3A%20implement%20%22precise%20store%20t.../near/428381203" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html#428381203">(Mar 22 2024 at 17:43)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/8221#discussion_r1535968882">PR review comment</a>:</p>
<blockquote>
<p>Stack stores are guaranteed to succeed when stack probing (or some other kind of stack size check) is used.</p>
</blockquote>



<a name="428381419"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238221%20Cranelift%3A%20implement%20%22precise%20store%20t.../near/428381419" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html#428381419">(Mar 22 2024 at 17:45)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/8221#issuecomment-2015607511">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8221">PR #8221</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @peterhuene</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "cranelift:meta", "wasmtime:api"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>peterhuene: wasmtime:api</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="428381638"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238221%20Cranelift%3A%20implement%20%22precise%20store%20t.../near/428381638" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html#428381638">(Mar 22 2024 at 17:46)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/8221#issuecomment-2015610340">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8221">PR #8221</a>:</p>
<blockquote>
<blockquote>
<p>this was measured to have a 2% performance impact</p>
</blockquote>
<p>How does this only have a 2% perf impact? Is some optimization pass removing part of the loads or is it the M2 chip being able to exploit a lot of instruction level parallelism?</p>
</blockquote>



<a name="428381939"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238221%20Cranelift%3A%20implement%20%22precise%20store%20t.../near/428381939" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html#428381939">(Mar 22 2024 at 17:48)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/8221#issuecomment-2015613276">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8221">PR #8221</a>:</p>
<blockquote>
<p>Probably the latter -- the loads are not removed, and make it all the way to machine code.</p>
</blockquote>



<a name="428382081"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238221%20Cranelift%3A%20implement%20%22precise%20store%20t.../near/428382081" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html#428382081">(Mar 22 2024 at 17:49)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/8221#issuecomment-2015615336">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8221">PR #8221</a>:</p>
<blockquote>
<p>(More specifically, a load inserted by this pass <em>could</em> later be removed by alias analysis, but only if subsumed by another earlier load to the same address, so there is still always some load before the store.)</p>
</blockquote>



<a name="428382583"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238221%20Cranelift%3A%20implement%20%22precise%20store%20t.../near/428382583" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html#428382583">(Mar 22 2024 at 17:52)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/8221#issuecomment-2015621067">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8221">PR #8221</a>:</p>
<blockquote>
<p>One other performance-related note: this will possibly have worse impact when the pooling allocator with copy-on-write is enabled in Wasmtime, as the "first touch" to a page matters: if demanded in by a load first, a read-only mapping is created, which might immediately fault again on the store (doing the actual CoW). We've seen such "mapping change" operations become bottlenecks in multithreaded processes due to IPIs. I don't expect we would turn this option on in any production setting though; rather we'd ensure (as is already the case on x86) any production hardware does not have the torn-write behavior. But that's something to consider if we ever discuss having this on by default in all cases.</p>
</blockquote>



<a name="428394593"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238221%20Cranelift%3A%20implement%20%22precise%20store%20t.../near/428394593" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html#428394593">(Mar 22 2024 at 19:13)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/pull/8221#issuecomment-2015751614">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8221">PR #8221</a>:</p>
<blockquote>
<p>I can confirm that this fixes the torn writes at least on QEMU. <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> </p>
<p>Interestingly QEMU RISC-V only shows this torn write test when using the vector extensions to perform the write (<code>v128</code>), but not using the normal <code>i64.store</code>.</p>
<p>I'm going to test this on real hardware over the weekend, and also see if I can run some benchmarks.</p>
<p>For completeness here's the WAST test that I used.<br>
&lt;details&gt;&lt;summary&gt;WAST Test&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">module</span>
<span class="w">  </span><span class="p">(</span><span class="n">memory</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"i128.store"</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">v128</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="n">i32x4</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="w"> </span><span class="mh">0xffffffff</span>
<span class="w">    </span><span class="n">v128</span><span class="p">.</span><span class="n">store</span><span class="w"> </span><span class="n">align</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"i32.load8_u"</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="kt">i32</span><span class="p">.</span><span class="n">load8_u</span><span class="p">))</span>

<span class="p">(</span><span class="n">assert_trap</span><span class="w"> </span><span class="p">(</span><span class="n">invoke</span><span class="w"> </span><span class="s">"i128.store"</span>
<span class="w">                     </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">65529</span><span class="p">)</span>
<span class="w">                     </span><span class="p">(</span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mh">0xffffffffffffffff</span><span class="p">))</span>
<span class="w">             </span><span class="s">"out of bounds memory access"</span><span class="p">)</span>

<span class="p">;;</span><span class="w"> </span><span class="n">Partial</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">were</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">written</span><span class="p">.</span>
<span class="p">(</span><span class="n">assert_return</span><span class="w"> </span><span class="p">(</span><span class="n">invoke</span><span class="w"> </span><span class="s">"i32.load8_u"</span><span class="w"> </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">65529</span><span class="p">))</span>
<span class="w">               </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="p">(</span><span class="n">assert_return</span><span class="w"> </span><span class="p">(</span><span class="n">invoke</span><span class="w"> </span><span class="s">"i32.load8_u"</span><span class="w"> </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">65530</span><span class="p">))</span>
<span class="w">               </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="p">(</span><span class="n">assert_return</span><span class="w"> </span><span class="p">(</span><span class="n">invoke</span><span class="w"> </span><span class="s">"i32.load8_u"</span><span class="w"> </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">65531</span><span class="p">))</span>
<span class="w">               </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="p">(</span><span class="n">assert_return</span><span class="w"> </span><span class="p">(</span><span class="n">invoke</span><span class="w"> </span><span class="s">"i32.load8_u"</span><span class="w"> </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">65532</span><span class="p">))</span>
<span class="w">               </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="p">(</span><span class="n">assert_return</span><span class="w"> </span><span class="p">(</span><span class="n">invoke</span><span class="w"> </span><span class="s">"i32.load8_u"</span><span class="w"> </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">65533</span><span class="p">))</span>
<span class="w">               </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="p">(</span><span class="n">assert_return</span><span class="w"> </span><span class="p">(</span><span class="n">invoke</span><span class="w"> </span><span class="s">"i32.load8_u"</span><span class="w"> </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">65534</span><span class="p">))</span>
<span class="w">               </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="p">(</span><span class="n">assert_return</span><span class="w"> </span><span class="p">(</span><span class="n">invoke</span><span class="w"> </span><span class="s">"i32.load8_u"</span><span class="w"> </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">65535</span><span class="p">))</span>
<span class="w">               </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
</blockquote>



<a name="428395165"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238221%20Cranelift%3A%20implement%20%22precise%20store%20t.../near/428395165" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html#428395165">(Mar 22 2024 at 19:17)</a>:</h4>
<p>cfallin edited <a href="https://github.com/bytecodealliance/wasmtime/pull/8221">PR #8221</a>:</p>
<blockquote>
<p>As discussed at in #7237 and <a href="https://github.com/WebAssembly/design/issues/1490">WebAssembly/design#1490</a>, some instruction-set architectures do not guarantee that a store that "partially traps" (overlaps multiple pages, only one of which disallows the store) does not also have some side-effects. In particular, the part of the store that <em>is</em> legal might succeed.</p>
<p>This has fascinating implications for virtual memory-based WebAssembly heap implementations: when a store is partially out-of-bounds, it should trap (there is no "partially" here: if the last byte is out of bounds, the store is out of bounds). A trapping store should not alter the final memory state, which is observable by the outside world after the trap. Yet, the simple lowering of a Wasm store to a machine store instruction could violate this expectation, in the presence of "store tearing" as described above.</p>
<p>Neither ARMv8 (aarch64) nor RISC-V guarantee lack of store-tearing, and we have observed it in tests on RISC-V.</p>
<p>This PR implements the idea first proposed [here], namely to prepend a load of the same size to every store. The idea is that if the store will trap, the load will as well; and precise exception handling, a well-established principle in all modern ISAs, guarantees that instructions beyond a trapping instruction have no effect.</p>
<p>This is off by default, and is mainly meant as an option to study the impact of this idea and to allow for precise trap execution semantics on affected machines unless/until the spec is clarified.</p>
<p>On an Apple M2 Pro machine (aarch64), this was measured to have a 2% performance impact when running <code>spidermonkey.wasm</code> with a simple recursive Fibonacci program. It can be used via the <code>-Ccranelift-ensure_precise_store_traps=true</code> flag to Wasmtime.</p>
<p>[here]:<br>
<a href="https://github.com/WebAssembly/design/issues/1490#issuecomment-1762043224">https://github.com/WebAssembly/design/issues/1490#issuecomment-1762043224</a></p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="428403211"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238221%20Cranelift%3A%20implement%20%22precise%20store%20t.../near/428403211" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html#428403211">(Mar 22 2024 at 20:15)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8221#pullrequestreview-1955714563">PR review</a>.</p>



<a name="428403212"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238221%20Cranelift%3A%20implement%20%22precise%20store%20t.../near/428403212" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html#428403212">(Mar 22 2024 at 20:15)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8221#pullrequestreview-1955714563">PR review</a>.</p>



<a name="428403214"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238221%20Cranelift%3A%20implement%20%22precise%20store%20t.../near/428403214" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html#428403214">(Mar 22 2024 at 20:15)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/8221#discussion_r1536154020">PR review comment</a>:</p>
<blockquote>
<p>I think atomics can be exempted here because they are already required to be aligned? At least at the wasm layer that's validated, I'm not sure about the Cranelift layer. This isn't needed for the wasm-level problem though.</p>
</blockquote>



<a name="428403215"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238221%20Cranelift%3A%20implement%20%22precise%20store%20t.../near/428403215" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html#428403215">(Mar 22 2024 at 20:15)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/8221#discussion_r1536154958">PR review comment</a>:</p>
<blockquote>
<p>Can this be skipped if <code>flags.trap_code().is_none()</code> or if <code>flags.aligned()</code>? Only possibly-trapping non-aligned loads (which is all wasm loads, but not anything to a vmctx for example)</p>
</blockquote>



<a name="428411160"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238221%20Cranelift%3A%20implement%20%22precise%20store%20t.../near/428411160" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html#428411160">(Mar 22 2024 at 21:21)</a>:</h4>
<p>tschneidereit <a href="https://github.com/bytecodealliance/wasmtime/pull/8221#issuecomment-2015948118">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8221">PR #8221</a>:</p>
<blockquote>
<p>I fully assume that I'm missing something and the answer is no, but just in case: would it not also work to first attempt to do the part of the store operation touching the highest page, and then do the rest of the write? ISTM that if any writes would fail that'd be guaranteed to include the highest page, and if that one succeeds, a write to all lower pages for the rest of the store operation is certain to succeed as well?</p>
</blockquote>



<a name="428413237"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238221%20Cranelift%3A%20implement%20%22precise%20store%20t.../near/428413237" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html#428413237">(Mar 22 2024 at 21:39)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/8221#issuecomment-2015967816">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8221">PR #8221</a>:</p>
<blockquote>
<p>The problem I see with that approach is that we only know that dynamically: consider if we have a 64-bit store (allowed to be unaligned) to address <code>X</code>, we would have to decompose it into bytes and perform them in reverse order (store <code>X+7</code>, then <code>X+6</code>, then ...) always, because we know nothing about <code>X</code>'s alignment. A static analysis could sometimes know <code>X</code>'s alignment, but usually not, e.g. if it is a value loaded from memory itself. So that is a store-amplification factor of 8 for 64-bit ops, 4 for 32-bit ops, etc, likely to have quite a big perf impact, I think.</p>
</blockquote>



<a name="428417086"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238221%20Cranelift%3A%20implement%20%22precise%20store%20t.../near/428417086" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html#428417086">(Mar 22 2024 at 22:18)</a>:</h4>
<p>tschneidereit <a href="https://github.com/bytecodealliance/wasmtime/pull/8221#issuecomment-2016013034">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8221">PR #8221</a>:</p>
<blockquote>
<p>Hmm, I see, I think. Could we then instead write a single byte (of whatever value) at the highest address, and do the actual store if that succeeded?</p>
</blockquote>



<a name="428417765"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238221%20Cranelift%3A%20implement%20%22precise%20store%20t.../near/428417765" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html#428417765">(Mar 22 2024 at 22:25)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/8221#issuecomment-2016020565">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8221">PR #8221</a>:</p>
<blockquote>
<p>I think that would work, yeah. There are some other interesting performance tradeoffs here -- two that come to mind are "partial-store forwarding" (partially overlapping loads/stores can be problematic for uarch memory perf) and the fact that stores in general are more expensive than loads (store buffers typically fewer entries than load buffers so can stall the OoO window, stores take extra effort at retire) that, balanced against all the other considerations here (we want something we could turn on by default on tier-2 architecture(s) if needed, and aren't as concerned with interactions with IPIs in pooling allocator where we're more likely to be very careful to select the right configuration and avoid this mechanism), I think I'd still prefer the load+store over narrow-store+store.</p>
</blockquote>



<a name="428421547"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238221%20Cranelift%3A%20implement%20%22precise%20store%20t.../near/428421547" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html#428421547">(Mar 22 2024 at 23:04)</a>:</h4>
<p>tschneidereit <a href="https://github.com/bytecodealliance/wasmtime/pull/8221#issuecomment-2016061986">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8221">PR #8221</a>:</p>
<blockquote>
<p>That all makes sense to me. I was mainly concerned about the impact on the pooling allocator, and the missing piece was the ability to select a configuration that'd allow us to avoid any of this.</p>
</blockquote>



<a name="428421839"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238221%20Cranelift%3A%20implement%20%22precise%20store%20t.../near/428421839" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html#428421839">(Mar 22 2024 at 23:07)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/8221#issuecomment-2016070932">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8221">PR #8221</a>:</p>
<blockquote>
<p>Ah yes, indeed. This is only a problem on aarch64 and riscv64, and AFAICT all aarch64 hardware one would <em>want</em> to run a high-performance server on (Apple implementations, AWS machines, Ampere CPUs, even RPi4) do not exhibit store-tearing, so on aarch64 it's mostly theoretical and/or on very small (low-power / embedded) cores I think.</p>
</blockquote>



<a name="429107147"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238221%20Cranelift%3A%20implement%20%22precise%20store%20t.../near/429107147" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html#429107147">(Mar 23 2024 at 19:15)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/pull/8221#issuecomment-2016579832">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8221">PR #8221</a>:</p>
<blockquote>
<p>I can confirm that this fix also works in real hardware. I ran a few benchmarks at random, and it does have a bit of impact on smaller cores (as expected). Most benchmarks are 5-10% slower, but there is one outlier at 40%</p>
<p>The results below are on a Dual-Issue In Order Core (Sifive u74).</p>
<p>&lt;details&gt;&lt;summary&gt;Results&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1459784.00</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">60785.14</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="n">noload</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.07</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.07</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">22663159</span><span class="w"> </span><span class="mf">22821360.40</span><span class="w"> </span><span class="mi">22862178</span><span class="p">]</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">21326450</span><span class="w"> </span><span class="mf">21361576.40</span><span class="w"> </span><span class="mi">21405304</span><span class="p">]</span><span class="w"> </span><span class="n">noload</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2560349.00</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">1538031.16</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="n">noload</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.01</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.04</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">110537308</span><span class="w"> </span><span class="mf">111942491.90</span><span class="w"> </span><span class="mi">113530980</span><span class="p">]</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">108818829</span><span class="w"> </span><span class="mf">109382142.90</span><span class="w"> </span><span class="mi">111609052</span><span class="p">]</span><span class="w"> </span><span class="n">noload</span><span class="p">.</span><span class="n">so</span>

<span class="n">instantiation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="n">No</span><span class="w"> </span><span class="n">difference</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">performance</span><span class="p">.</span>

<span class="w">  </span><span class="p">[</span><span class="mi">3465</span><span class="w"> </span><span class="mf">3954.40</span><span class="w"> </span><span class="mi">6169</span><span class="p">]</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">3444</span><span class="w"> </span><span class="mf">4122.00</span><span class="w"> </span><span class="mi">6204</span><span class="p">]</span><span class="w"> </span><span class="n">noload</span><span class="p">.</span><span class="n">so</span>

<span class="w">  </span><span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">92094.60</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">29972.88</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="n">noload</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.06</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.12</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">1100973</span><span class="w"> </span><span class="mf">1120327.60</span><span class="w"> </span><span class="mi">1169522</span><span class="p">]</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">1019878</span><span class="w"> </span><span class="mf">1028233.00</span><span class="w"> </span><span class="mi">1083605</span><span class="p">]</span><span class="w"> </span><span class="n">noload</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="n">No</span><span class="w"> </span><span class="n">difference</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">performance</span><span class="p">.</span>

<span class="w">  </span><span class="p">[</span><span class="mi">2281318</span><span class="w"> </span><span class="mf">2391173.30</span><span class="w"> </span><span class="mi">2505976</span><span class="p">]</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">2212191</span><span class="w"> </span><span class="mf">2312207.60</span><span class="w"> </span><span class="mi">2376594</span><span class="p">]</span><span class="w"> </span><span class="n">noload</span><span class="p">.</span><span class="n">so</span>

<span class="n">instantiation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="n">No</span><span class="w"> </span><span class="n">difference</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">performance</span><span class="p">.</span>

<span class="w">  </span><span class="p">[</span><span class="mi">1028</span><span class="w"> </span><span class="mf">1098.00</span><span class="w"> </span><span class="mi">1448</span><span class="p">]</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">1050</span><span class="w"> </span><span class="mf">1103.10</span><span class="w"> </span><span class="mi">1170</span><span class="p">]</span><span class="w"> </span><span class="n">noload</span><span class="p">.</span><span class="n">so</span>

<span class="w">  </span><span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">66417.80</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">543.64</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="n">noload</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.39</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.40</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">233706</span><span class="w"> </span><span class="mf">234547.90</span><span class="w"> </span><span class="mi">235270</span><span class="p">]</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">167648</span><span class="w"> </span><span class="mf">168130.10</span><span class="w"> </span><span class="mi">168742</span><span class="p">]</span><span class="w"> </span><span class="n">noload</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="n">No</span><span class="w"> </span><span class="n">difference</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">performance</span><span class="p">.</span>

<span class="w">  </span><span class="p">[</span><span class="mi">4541616</span><span class="w"> </span><span class="mf">4965704.40</span><span class="w"> </span><span class="mi">5992445</span><span class="p">]</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">4423989</span><span class="w"> </span><span class="mf">4751356.50</span><span class="w"> </span><span class="mi">5875859</span><span class="p">]</span><span class="w"> </span><span class="n">noload</span><span class="p">.</span><span class="n">so</span>

<span class="n">instantiation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="n">No</span><span class="w"> </span><span class="n">difference</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">performance</span><span class="p">.</span>

<span class="w">  </span><span class="p">[</span><span class="mi">1714</span><span class="w"> </span><span class="mf">2113.50</span><span class="w"> </span><span class="mi">2415</span><span class="p">]</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">1798</span><span class="w"> </span><span class="mf">2135.50</span><span class="w"> </span><span class="mi">2299</span><span class="p">]</span><span class="w"> </span><span class="n">noload</span><span class="p">.</span><span class="n">so</span>


<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">blake3</span><span class="o">-</span><span class="n">scalar</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">44240.30</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">40968.63</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="n">noload</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.00</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.03</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">2848804</span><span class="w"> </span><span class="mf">2880309.90</span><span class="w"> </span><span class="mi">2923861</span><span class="p">]</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">2803879</span><span class="w"> </span><span class="mf">2836069.60</span><span class="w"> </span><span class="mi">2912357</span><span class="p">]</span><span class="w"> </span><span class="n">noload</span><span class="p">.</span><span class="n">so</span>

<span class="n">instantiation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">blake3</span><span class="o">-</span><span class="n">scalar</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="n">No</span><span class="w"> </span><span class="n">difference</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">performance</span><span class="p">.</span>

<span class="w">  </span><span class="p">[</span><span class="mi">1186</span><span class="w"> </span><span class="mf">1391.10</span><span class="w"> </span><span class="mi">1495</span><span class="p">]</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">1185</span><span class="w"> </span><span class="mf">1445.70</span><span class="w"> </span><span class="mi">1604</span><span class="p">]</span><span class="w"> </span><span class="n">noload</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">blake3</span><span class="o">-</span><span class="n">scalar</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="n">No</span><span class="w"> </span><span class="n">difference</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">performance</span><span class="p">.</span>

<span class="w">  </span><span class="p">[</span><span class="mi">9675</span><span class="w"> </span><span class="mf">9782.10</span><span class="w"> </span><span class="mi">10005</span><span class="p">]</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">9572</span><span class="w"> </span><span class="mf">9637.80</span><span class="w"> </span><span class="mi">9814</span><span class="p">]</span><span class="w"> </span><span class="n">noload</span><span class="p">.</span><span class="n">so</span>

<span class="w">  </span><span class="n">instantiation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">regex</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">340.10</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">243.11</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="n">noload</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.03</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.19</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">2939</span><span class="w"> </span><span class="mf">3406.10</span><span class="w"> </span><span class="mi">3681</span><span class="p">]</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">2992</span><span class="w"> </span><span class="mf">3066.00</span><span class="w"> </span><span class="mi">3281</span><span class="p">]</span><span class="w"> </span><span class="n">noload</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">regex</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">245010.10</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">1279.07</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="n">noload</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.06</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.06</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">4076050</span><span class="w"> </span><span class="mf">4077873.90</span><span class="w"> </span><span class="mi">4079406</span><span class="p">]</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">3831298</span><span class="w"> </span><span class="mf">3832863.80</span><span class="w"> </span><span class="mi">3834736</span><span class="p">]</span><span class="w"> </span><span class="n">noload</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">regex</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">369482.20</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">93448.03</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="n">noload</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.03</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.04</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">10706461</span><span class="w"> </span><span class="mf">10872794.20</span><span class="w"> </span><span class="mi">10932079</span><span class="p">]</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">10360994</span><span class="w"> </span><span class="mf">10503312.00</span><span class="w"> </span><span class="mi">10590922</span><span class="p">]</span><span class="w"> </span><span class="n">noload</span><span class="p">.</span><span class="n">so</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
</blockquote>



<a name="431202140"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238221%20Cranelift%3A%20implement%20%22precise%20store%20t.../near/431202140" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html#431202140">(Apr 04 2024 at 00:50)</a>:</h4>
<p>candymate <a href="https://github.com/bytecodealliance/wasmtime/pull/8221#issuecomment-2035884422">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8221">PR #8221</a>:</p>
<blockquote>
<blockquote>
<p>@afonso360, if you still have access to your RISC-V hardware and a bit of time to test, it would be useful to confirm that this changes the result of the "torn stores" test case from earlier! @candymate, it would be interesting to confirm that this resolves your fuzzbug as well, and this could be useful for further fuzzing for you.</p>
</blockquote>
<p>I'm sorry that I saw this just now - I'll check this in a day or two from now and let you know.</p>
</blockquote>



<a name="435098352"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238221%20Cranelift%3A%20implement%20%22precise%20store%20t.../near/435098352" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238221.20Cranelift.3A.20implement.20.22precise.20store.20t.2E.2E.2E.html#435098352">(Apr 24 2024 at 02:50)</a>:</h4>
<p>candymate edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/8221#issuecomment-2035884422">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8221">PR #8221</a>:</p>
<blockquote>
<blockquote>
<p>@afonso360, if you still have access to your RISC-V hardware and a bit of time to test, it would be useful to confirm that this changes the result of the "torn stores" test case from earlier! @candymate, it would be interesting to confirm that this resolves your fuzzbug as well, and this could be useful for further fuzzing for you.</p>
</blockquote>
<p>I'm sorry that I saw this just now - I'll check this in a day or two from now and let you know.</p>
<p>Tiny update: I'm sorry to say this, but I'm not available till 5/1. I'll see this again at that time.</p>
<p>I'm not sure about this, but I think I observed that this problem persists with QEMU 8.1.5 - need recheck...</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>