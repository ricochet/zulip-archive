<html>
<head><meta charset="utf-8"><title>wasmtime / issue #9250 Cranelift: Incorrect abi for i128,... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239250.20Cranelift.3A.20Incorrect.20abi.20for.20i128.2C.2E.2E.2E.html">wasmtime / issue #9250 Cranelift: Incorrect abi for i128,...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="470381695"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239250%20Cranelift%3A%20Incorrect%20abi%20for%20i128%2C.../near/470381695" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239250.20Cranelift.3A.20Incorrect.20abi.20for.20i128.2C.2E.2E.2E.html#470381695">(Sep 15 2024 at 19:56)</a>:</h4>
<p><a href="https://github.com/bjorn3">bjorn3</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/9250">Issue #9250</a>.</p>



<a name="470381696"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239250%20Cranelift%3A%20Incorrect%20abi%20for%20i128%2C.../near/470381696" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239250.20Cranelift.3A.20Incorrect.20abi.20for.20i128.2C.2E.2E.2E.html#470381696">(Sep 15 2024 at 19:56)</a>:</h4>
<p><a href="https://github.com/bjorn3">bjorn3</a> added the cranelift label to <a href="https://github.com/bytecodealliance/wasmtime/issues/9250">Issue #9250</a>.</p>



<a name="470381713"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239250%20Cranelift%3A%20Incorrect%20abi%20for%20i128%2C.../near/470381713" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239250.20Cranelift.3A.20Incorrect.20abi.20for.20i128.2C.2E.2E.2E.html#470381713">(Sep 15 2024 at 19:56)</a>:</h4>
<p>bjorn3 opened <a href="https://github.com/bytecodealliance/wasmtime/issues/9250">issue #9250</a>:</p>
<blockquote>
<h3>Expected Results</h3>
<p>All return values are returned using a single return pointer.</p>
<h3>Actual Results</h3>
<p>Return values are put into registers where possible and on the stack for the rest.</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: 0.111</p>
<p>Operating system: Linux</p>
<p>Architecture: x86_64</p>
<h3>Extra Info</h3>
<p>This is one of the causes for <a href="https://github.com/rust-lang/rustc_codegen_cranelift/issues/1525">https://github.com/rust-lang/rustc_codegen_cranelift/issues/1525</a>. The same issue may exist on aarch64 and other archs too, but haven't checked yet.</p>
</blockquote>



<a name="470718363"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239250%20Cranelift%3A%20Incorrect%20abi%20for%20i128%2C.../near/470718363" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239250.20Cranelift.3A.20Incorrect.20abi.20for.20i128.2C.2E.2E.2E.html#470718363">(Sep 16 2024 at 19:21)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/9250#issuecomment-2353731835">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9250">issue #9250</a>:</p>
<blockquote>
<p>PR's opened while working on this:</p>
<ul>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/9253">https://github.com/bytecodealliance/wasmtime/pull/9253</a></li>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/9258">https://github.com/bytecodealliance/wasmtime/pull/9258</a></li>
</ul>
</blockquote>



<a name="470723742"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239250%20Cranelift%3A%20Incorrect%20abi%20for%20i128%2C.../near/470723742" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239250.20Cranelift.3A.20Incorrect.20abi.20for.20i128.2C.2E.2E.2E.html#470723742">(Sep 16 2024 at 19:41)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/9250#issuecomment-2353768103">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9250">issue #9250</a>:</p>
<blockquote>
<p>Found another issue: The x86_64 and riscv64 backends add an implicit return pointer after all other arguments rather than as first argument. </p>
</blockquote>



<a name="471071132"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239250%20Cranelift%3A%20Incorrect%20abi%20for%20i128%2C.../near/471071132" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239250.20Cranelift.3A.20Incorrect.20abi.20for.20i128.2C.2E.2E.2E.html#471071132">(Sep 17 2024 at 19:15)</a>:</h4>
<p>bjorn3 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/9250#issuecomment-2353731835">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9250">issue #9250</a>:</p>
<blockquote>
<p>PR's opened while working on this:</p>
<ul>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/9253">https://github.com/bytecodealliance/wasmtime/pull/9253</a></li>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/9258">https://github.com/bytecodealliance/wasmtime/pull/9258</a></li>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/9267">https://github.com/bytecodealliance/wasmtime/pull/9267</a></li>
</ul>
</blockquote>



<a name="471071162"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239250%20Cranelift%3A%20Incorrect%20abi%20for%20i128%2C.../near/471071162" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239250.20Cranelift.3A.20Incorrect.20abi.20for.20i128.2C.2E.2E.2E.html#471071162">(Sep 17 2024 at 19:15)</a>:</h4>
<p>bjorn3 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/9250#issuecomment-2353768103">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9250">issue #9250</a>:</p>
<blockquote>
<p>Found another issue: The x86_64 and riscv64 backends add an implicit return pointer after all other arguments rather than as first argument. </p>
<p>Edit: Fixed in <a href="https://github.com/bytecodealliance/wasmtime/pull/9267">https://github.com/bytecodealliance/wasmtime/pull/9267</a></p>
</blockquote>



<a name="471534768"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239250%20Cranelift%3A%20Incorrect%20abi%20for%20i128%2C.../near/471534768" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239250.20Cranelift.3A.20Incorrect.20abi.20for.20i128.2C.2E.2E.2E.html#471534768">(Sep 19 2024 at 17:38)</a>:</h4>
<p>bjorn3 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/9250#issuecomment-2353731835">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9250">issue #9250</a>:</p>
<blockquote>
<p>PR's opened while working on this:</p>
<ul>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/9253">https://github.com/bytecodealliance/wasmtime/pull/9253</a></li>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/9258">https://github.com/bytecodealliance/wasmtime/pull/9258</a></li>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/9267">https://github.com/bytecodealliance/wasmtime/pull/9267</a></li>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/9284">https://github.com/bytecodealliance/wasmtime/pull/9284</a></li>
</ul>
</blockquote>



<a name="471552888"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239250%20Cranelift%3A%20Incorrect%20abi%20for%20i128%2C.../near/471552888" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239250.20Cranelift.3A.20Incorrect.20abi.20for.20i128.2C.2E.2E.2E.html#471552888">(Sep 19 2024 at 19:44)</a>:</h4>
<p>bjorn3 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/9250#issuecomment-2353731835">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9250">issue #9250</a>:</p>
<blockquote>
<p>PR's opened while working on this:</p>
<ul>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/9253">https://github.com/bytecodealliance/wasmtime/pull/9253</a></li>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/9258">https://github.com/bytecodealliance/wasmtime/pull/9258</a></li>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/9267">https://github.com/bytecodealliance/wasmtime/pull/9267</a></li>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/9284">https://github.com/bytecodealliance/wasmtime/pull/9284</a></li>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/9287">https://github.com/bytecodealliance/wasmtime/pull/9287</a></li>
</ul>
</blockquote>



<a name="474588525"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239250%20Cranelift%3A%20Incorrect%20abi%20for%20i128%2C.../near/474588525" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239250.20Cranelift.3A.20Incorrect.20abi.20for.20i128.2C.2E.2E.2E.html#474588525">(Oct 03 2024 at 13:15)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/9250#issuecomment-2391395242">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9250">issue #9250</a>:</p>
<blockquote>
<blockquote>
<p>Expected Results</p>
<p>All return values are returned using a single return pointer.</p>
</blockquote>
<p>Actually, LLVM passes the return value on the stack if it doesn't fit in registers. It doesn't use a return area pointer.</p>
</blockquote>



<a name="474602249"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239250%20Cranelift%3A%20Incorrect%20abi%20for%20i128%2C.../near/474602249" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239250.20Cranelift.3A.20Incorrect.20abi.20for.20i128.2C.2E.2E.2E.html#474602249">(Oct 03 2024 at 14:21)</a>:</h4>
<p>bjorn3 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/9250#issuecomment-2391395242">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9250">issue #9250</a>:</p>
<blockquote>
<blockquote>
<p>Expected Results</p>
<p>All return values are returned using a single return pointer.</p>
</blockquote>
<p>Actually, LLVM passes the return value on the stack if it doesn't fit in registers. It doesn't use a return area pointer.</p>
<p>Edit: Never mind. I was wrong about this.</p>
</blockquote>



<a name="477823855"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239250%20Cranelift%3A%20Incorrect%20abi%20for%20i128%2C.../near/477823855" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239250.20Cranelift.3A.20Incorrect.20abi.20for.20i128.2C.2E.2E.2E.html#477823855">(Oct 19 2024 at 17:14)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/9250#issuecomment-2424096249">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9250">issue #9250</a>:</p>
<blockquote>
<p>As of <a href="https://github.com/rust-lang/rust/pull/131211">https://github.com/rust-lang/rust/pull/131211</a> rustc should no longer emit this return type. If this is indeed the case, I propose to deny any return type that doesn't fit in the abi designated return value registers for at least the system_v and windows_fastcall call convs. And ideally also for every other call conv to be able to get rid of the implicit sret argument introduction in the abi calculation code which complicates this code by a fair bit.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>