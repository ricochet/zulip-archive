<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #1537 Cranelift aarch64 backend: impleme... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231537.20Cranelift.20aarch64.20backend.3A.20impleme.2E.2E.2E.html">wasmtime / Issue #1537 Cranelift aarch64 backend: impleme...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="194470787"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231537%20Cranelift%20aarch64%20backend%3A%20impleme.../near/194470787" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231537.20Cranelift.20aarch64.20backend.3A.20impleme.2E.2E.2E.html#194470787">(Apr 17 2020 at 17:04)</a>:</h4>
<p>cfallin opened <a href="https://github.com/bytecodealliance/wasmtime/issues/1537" title="https://github.com/bytecodealliance/wasmtime/issues/1537">Issue #1537</a>:</p>
<blockquote>
<p>We currently use a sequence of instructions intended for 64-bit operation, and zero-extend narrower inputs. The original implementation by @jgouly almost works for 32 bits (and 8/16 bits extended to 32 bits), with a slight issue. We should rework the lowering to fix this issue and remove the need for zero-extending 32-bit operands.</p>
</blockquote>



<a name="194472025"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231537%20Cranelift%20aarch64%20backend%3A%20impleme.../near/194472025" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231537.20Cranelift.20aarch64.20backend.3A.20impleme.2E.2E.2E.html#194472025">(Apr 17 2020 at 17:12)</a>:</h4>
<p>bnjbvr labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/1537" title="https://github.com/bytecodealliance/wasmtime/issues/1537">Issue #1537</a>:</p>
<blockquote>
<p>We currently use a sequence of instructions intended for 64-bit operation, and zero-extend narrower inputs. The original implementation by @jgouly almost works for 32 bits (and 8/16 bits extended to 32 bits), with a slight issue. We should rework the lowering to fix this issue and remove the need for zero-extending 32-bit operands.</p>
</blockquote>



<a name="194472026"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231537%20Cranelift%20aarch64%20backend%3A%20impleme.../near/194472026" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231537.20Cranelift.20aarch64.20backend.3A.20impleme.2E.2E.2E.html#194472026">(Apr 17 2020 at 17:12)</a>:</h4>
<p>bnjbvr labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/1537" title="https://github.com/bytecodealliance/wasmtime/issues/1537">Issue #1537</a>:</p>
<blockquote>
<p>We currently use a sequence of instructions intended for 64-bit operation, and zero-extend narrower inputs. The original implementation by @jgouly almost works for 32 bits (and 8/16 bits extended to 32 bits), with a slight issue. We should rework the lowering to fix this issue and remove the need for zero-extending 32-bit operands.</p>
</blockquote>



<a name="194473165"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231537%20Cranelift%20aarch64%20backend%3A%20impleme.../near/194473165" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231537.20Cranelift.20aarch64.20backend.3A.20impleme.2E.2E.2E.html#194473165">(Apr 17 2020 at 17:21)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/issues/1537#issuecomment-615367693" title="https://github.com/bytecodealliance/wasmtime/issues/1537#issuecomment-615367693">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1537" title="https://github.com/bytecodealliance/wasmtime/issues/1537">Issue #1537</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @bnjbvr</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>bnjbvr: cranelift</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action" title="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="194515909"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231537%20Cranelift%20aarch64%20backend%3A%20impleme.../near/194515909" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231537.20Cranelift.20aarch64.20backend.3A.20impleme.2E.2E.2E.html#194515909">(Apr 18 2020 at 00:21)</a>:</h4>
<p>cfallin labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/1537" title="https://github.com/bytecodealliance/wasmtime/issues/1537">Issue #1537</a>:</p>
<blockquote>
<p>We currently use a sequence of instructions intended for 64-bit operation, and zero-extend narrower inputs. The original implementation by @jgouly almost works for 32 bits (and 8/16 bits extended to 32 bits), with a slight issue. We should rework the lowering to fix this issue and remove the need for zero-extending 32-bit operands.</p>
</blockquote>



<a name="194809629"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231537%20Cranelift%20aarch64%20backend%3A%20impleme.../near/194809629" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231537.20Cranelift.20aarch64.20backend.3A.20impleme.2E.2E.2E.html#194809629">(Apr 21 2020 at 14:28)</a>:</h4>
<p>bnjbvr <a href="https://github.com/bytecodealliance/wasmtime/issues/1537#issuecomment-617215842" title="https://github.com/bytecodealliance/wasmtime/issues/1537#issuecomment-617215842">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1537" title="https://github.com/bytecodealliance/wasmtime/issues/1537">Issue #1537</a>:</p>
<blockquote>
<p>For what it's worth, the <code>x86</code> legalization used a slightly <a href="https://github.com/bytecodealliance/wasmtime/blob/master/cranelift/codegen/meta/src/isa/x86/legalize.rs#L231-L247" title="https://github.com/bytecodealliance/wasmtime/blob/master/cranelift/codegen/meta/src/isa/x86/legalize.rs#L231-L247">different sequence</a> that ought to be reusable here. Would it make sense to make it a target-independent legalization, and use it in <code>simple_legalize</code> then? (doing it at the CLIR level would allow applying optimizations onto the constants, esp. GVN could common out the constants instead of regenerating as many times as the popcnt instruction is used)</p>
</blockquote>



<a name="209676581"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231537%20Cranelift%20aarch64%20backend%3A%20impleme.../near/209676581" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231537.20Cranelift.20aarch64.20backend.3A.20impleme.2E.2E.2E.html#209676581">(Sep 10 2020 at 16:56)</a>:</h4>
<p>akirilov-arm <a href="https://github.com/bytecodealliance/wasmtime/issues/1537#issuecomment-690505468">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1537">Issue #1537</a>:</p>
<blockquote>
<p>Note that the proper implementation for 32- and 64-bit operands may use the Neon <code>CNT</code> instruction (for example, <a href="https://godbolt.org/z/78EWMe">this</a> is what GCC and LLVM do), so a target-independent legalization may be counterproductive. However, I am not sure about 8- and 16-bit operands.</p>
</blockquote>



<a name="223267138"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231537%20Cranelift%20aarch64%20backend%3A%20impleme.../near/223267138" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231537.20Cranelift.20aarch64.20backend.3A.20impleme.2E.2E.2E.html#223267138">(Jan 19 2021 at 18:06)</a>:</h4>
<p>akirilov-arm <a href="https://github.com/bytecodealliance/wasmtime/issues/1537#issuecomment-763021734">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1537">Issue #1537</a>:</p>
<blockquote>
<p>I decided to compare the approach using the Neon <code>CNT</code> instruction (which I'll call "vector") with the one that just used operations on general-purpose registers (i.e. the existing implementation in Cranelift, which I'll call "scalar"), so I wrote several microbenchmarks.</p>
<p>Here's the scalar implementation for 8-bit operands:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="n">lsr</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">ws</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x55555555</span><span class="w"></span>
<span class="w">  </span><span class="n">sub</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">ws</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">wt</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x33333333</span><span class="w"></span>
<span class="w">  </span><span class="n">lsr</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">2</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x33333333</span><span class="w"></span>
<span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wt</span><span class="w"></span>
<span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">lsr</span><span class="w"> </span><span class="err">#</span><span class="mi">4</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xf</span><span class="w"></span>
</code></pre></div>
<p>And the vector one:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="n">fmov</span><span class="w"> </span><span class="n">st</span><span class="p">,</span><span class="w"> </span><span class="n">ws</span><span class="w"></span>
<span class="w">  </span><span class="n">cnt</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="mi">8</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="mi">8</span><span class="n">b</span><span class="w"></span>
<span class="w">  </span><span class="n">umov</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<p>16-bit scalar:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="n">lsr</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">ws</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x55555555</span><span class="w"></span>
<span class="w">  </span><span class="n">sub</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">ws</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">wt</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x33333333</span><span class="w"></span>
<span class="w">  </span><span class="n">lsr</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">2</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x33333333</span><span class="w"></span>
<span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wt</span><span class="w"></span>
<span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">lsr</span><span class="w"> </span><span class="err">#</span><span class="mi">4</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0f0f0f0f</span><span class="w"></span>
<span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">lsr</span><span class="w"> </span><span class="err">#</span><span class="mi">8</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xff</span><span class="w"></span>
</code></pre></div>
<p>16-bit vector:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="n">fmov</span><span class="w"> </span><span class="n">st</span><span class="p">,</span><span class="w"> </span><span class="n">ws</span><span class="w"></span>
<span class="w">  </span><span class="n">cnt</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="mi">8</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="mi">8</span><span class="n">b</span><span class="w"></span>
<span class="w">  </span><span class="n">addp</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="mi">8</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="mi">8</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="mi">8</span><span class="n">b</span><span class="w"></span>
<span class="w">  </span><span class="n">umov</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<p>32-bit scalar:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="n">lsr</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">ws</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x55555555</span><span class="w"></span>
<span class="w">  </span><span class="n">sub</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">ws</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">wt</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x33333333</span><span class="w"></span>
<span class="w">  </span><span class="n">lsr</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">2</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x33333333</span><span class="w"></span>
<span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wt</span><span class="w"></span>
<span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">lsr</span><span class="w"> </span><span class="err">#</span><span class="mi">4</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0f0f0f0f</span><span class="w"></span>
<span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">wt</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x01010101</span><span class="w"></span>
<span class="w">  </span><span class="n">mul</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wt</span><span class="w"></span>
<span class="w">  </span><span class="n">lsr</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">24</span><span class="w"></span>
</code></pre></div>
<p>32-bit vector (almost the same as the 64-bit one - only the first instruction differs):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="n">fmov</span><span class="w"> </span><span class="n">st</span><span class="p">,</span><span class="w"> </span><span class="n">ws</span><span class="w"></span>
<span class="w">  </span><span class="n">cnt</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="mi">8</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="mi">8</span><span class="n">b</span><span class="w"></span>
<span class="w">  </span><span class="n">addv</span><span class="w"> </span><span class="n">bt</span><span class="p">,</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="mi">8</span><span class="n">b</span><span class="w"></span>
<span class="w">  </span><span class="n">umov</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<p>For the 64-bit case I tried 2 scalar variants - one that doesn't use multiplication and another one that does; here's the first one:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="n">lsr</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xs</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x5555555555555555</span><span class="w"></span>
<span class="w">  </span><span class="n">sub</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xs</span><span class="p">,</span><span class="w"> </span><span class="n">xd</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x3333333333333333</span><span class="w"></span>
<span class="w">  </span><span class="n">lsr</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">2</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x3333333333333333</span><span class="w"></span>
<span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="w"></span>
<span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">lsr</span><span class="w"> </span><span class="err">#</span><span class="mi">4</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0f0f0f0f0f0f0f0f</span><span class="w"></span>
<span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">lsl</span><span class="w"> </span><span class="err">#</span><span class="mi">8</span><span class="w"></span>
<span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">lsl</span><span class="w"> </span><span class="err">#</span><span class="mi">16</span><span class="w"></span>
<span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">lsl</span><span class="w"> </span><span class="err">#</span><span class="mi">32</span><span class="w"></span>
<span class="w">  </span><span class="n">lsr</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">56</span><span class="w"></span>
</code></pre></div>
<p>And the second one:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="n">lsr</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xs</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x5555555555555555</span><span class="w"></span>
<span class="w">  </span><span class="n">sub</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xs</span><span class="p">,</span><span class="w"> </span><span class="n">xd</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x3333333333333333</span><span class="w"></span>
<span class="w">  </span><span class="n">lsr</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">2</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x3333333333333333</span><span class="w"></span>
<span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="w"></span>
<span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">lsr</span><span class="w"> </span><span class="err">#</span><span class="mi">4</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0f0f0f0f0f0f0f0f</span><span class="w"></span>
<span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0101010101010101</span><span class="w"></span>
<span class="w">  </span><span class="n">mul</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="w"></span>
<span class="w">  </span><span class="n">lsr</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">56</span><span class="w"></span>
</code></pre></div>
<p>64-bit vector:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="n">fmov</span><span class="w"> </span><span class="n">dt</span><span class="p">,</span><span class="w"> </span><span class="n">xs</span><span class="w"></span>
<span class="w">  </span><span class="n">cnt</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="mi">8</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="mi">8</span><span class="n">b</span><span class="w"></span>
<span class="w">  </span><span class="n">addv</span><span class="w"> </span><span class="n">bt</span><span class="p">,</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="mi">8</span><span class="n">b</span><span class="w"></span>
<span class="w">  </span><span class="n">umov</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<p>Here are the results for various microarchitectures in terms of speedup achieved by the vector implementation, i.e. higher numbers mean that the latter is better (the raw values that are measured are actually runtimes, hence speedup):</p>
<table>
<thead>
<tr>
<th>CPU core</th>
<th>8-bit latency speedup</th>
<th>8-bit throughput speedup</th>
<th>16-bit latency speedup</th>
<th>16-bit throughput speedup</th>
<th>32-bit latency speedup</th>
<th>32-bit throughput speedup</th>
<th>64-bit latency speedup</th>
<th>64-bit throughput speedup</th>
</tr>
</thead>
<tbody>
<tr>
<td>Arm Cortex-A55</td>
<td>252.84%</td>
<td>276.55%</td>
<td>224.39%</td>
<td>241.52%</td>
<td>256.10%</td>
<td>282.28%</td>
<td>293.79%</td>
<td>321.77%</td>
</tr>
<tr>
<td>Arm Neoverse N1</td>
<td>132.56%</td>
<td>348.84%</td>
<td>135.26%</td>
<td>243.04%</td>
<td>96.96%</td>
<td>197.12%</td>
<td>123.08%</td>
<td>213.46%</td>
</tr>
</tbody>
</table>
<p>In addition, here's how the alternative 64-bit scalar implementation (using multiplication) performs:<br>
CPU core|Latency speedup|Throughput speedup<br>
-|-|-<br>
Arm Cortex-A55|111.81%|109.10%<br>
Arm Neoverse N1|112.60%|110.45%</p>
<p>The results demonstrate quite clearly that the vector variant is better than the scalar one; the only regression is in the 32-bit latency value. While the alternative 64-bit scalar implementation is a definite improvement, it still lags behind the vector one.</p>
</blockquote>



<a name="223270507"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231537%20Cranelift%20aarch64%20backend%3A%20impleme.../near/223270507" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231537.20Cranelift.20aarch64.20backend.3A.20impleme.2E.2E.2E.html#223270507">(Jan 19 2021 at 18:28)</a>:</h4>
<p>akirilov-arm edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/1537#issuecomment-763021734">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1537">Issue #1537</a>:</p>
<blockquote>
<p>I decided to compare the approach using the Neon <code>CNT</code> instruction (which I'll call "vector") with the one that just used operations on general-purpose registers (i.e. the existing implementation in Cranelift, which I'll call "scalar"), so I wrote several microbenchmarks.</p>
<p>Here's the scalar implementation for 8-bit operands:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="n">lsr</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">ws</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x55555555</span><span class="w"></span>
<span class="w">  </span><span class="n">sub</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">ws</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">wt</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x33333333</span><span class="w"></span>
<span class="w">  </span><span class="n">lsr</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">2</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x33333333</span><span class="w"></span>
<span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wt</span><span class="w"></span>
<span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">lsr</span><span class="w"> </span><span class="err">#</span><span class="mi">4</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xf</span><span class="w"></span>
</code></pre></div>
<p>And the vector one:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="n">fmov</span><span class="w"> </span><span class="n">st</span><span class="p">,</span><span class="w"> </span><span class="n">ws</span><span class="w"></span>
<span class="w">  </span><span class="n">cnt</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="mi">8</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="mi">8</span><span class="n">b</span><span class="w"></span>
<span class="w">  </span><span class="n">umov</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<p>16-bit scalar:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="n">lsr</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">ws</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x55555555</span><span class="w"></span>
<span class="w">  </span><span class="n">sub</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">ws</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">wt</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x33333333</span><span class="w"></span>
<span class="w">  </span><span class="n">lsr</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">2</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x33333333</span><span class="w"></span>
<span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wt</span><span class="w"></span>
<span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">lsr</span><span class="w"> </span><span class="err">#</span><span class="mi">4</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0f0f0f0f</span><span class="w"></span>
<span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">lsr</span><span class="w"> </span><span class="err">#</span><span class="mi">8</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xff</span><span class="w"></span>
</code></pre></div>
<p>16-bit vector:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="n">fmov</span><span class="w"> </span><span class="n">st</span><span class="p">,</span><span class="w"> </span><span class="n">ws</span><span class="w"></span>
<span class="w">  </span><span class="n">cnt</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="mi">8</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="mi">8</span><span class="n">b</span><span class="w"></span>
<span class="w">  </span><span class="n">addp</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="mi">8</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="mi">8</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="mi">8</span><span class="n">b</span><span class="w"></span>
<span class="w">  </span><span class="n">umov</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<p>32-bit scalar:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="n">lsr</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">ws</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x55555555</span><span class="w"></span>
<span class="w">  </span><span class="n">sub</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">ws</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">wt</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x33333333</span><span class="w"></span>
<span class="w">  </span><span class="n">lsr</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">2</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x33333333</span><span class="w"></span>
<span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wt</span><span class="w"></span>
<span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">lsr</span><span class="w"> </span><span class="err">#</span><span class="mi">4</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0f0f0f0f</span><span class="w"></span>
<span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">wt</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x01010101</span><span class="w"></span>
<span class="w">  </span><span class="n">mul</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wt</span><span class="w"></span>
<span class="w">  </span><span class="n">lsr</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">24</span><span class="w"></span>
</code></pre></div>
<p>32-bit vector (almost the same as the 64-bit one - only the first instruction differs):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="n">fmov</span><span class="w"> </span><span class="n">st</span><span class="p">,</span><span class="w"> </span><span class="n">ws</span><span class="w"></span>
<span class="w">  </span><span class="n">cnt</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="mi">8</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="mi">8</span><span class="n">b</span><span class="w"></span>
<span class="w">  </span><span class="n">addv</span><span class="w"> </span><span class="n">bt</span><span class="p">,</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="mi">8</span><span class="n">b</span><span class="w"></span>
<span class="w">  </span><span class="n">umov</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<p>For the 64-bit case I tried 2 scalar variants - one that doesn't use multiplication and another one that does; here's the first one:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="n">lsr</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xs</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x5555555555555555</span><span class="w"></span>
<span class="w">  </span><span class="n">sub</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xs</span><span class="p">,</span><span class="w"> </span><span class="n">xd</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x3333333333333333</span><span class="w"></span>
<span class="w">  </span><span class="n">lsr</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">2</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x3333333333333333</span><span class="w"></span>
<span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="w"></span>
<span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">lsr</span><span class="w"> </span><span class="err">#</span><span class="mi">4</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0f0f0f0f0f0f0f0f</span><span class="w"></span>
<span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">lsl</span><span class="w"> </span><span class="err">#</span><span class="mi">8</span><span class="w"></span>
<span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">lsl</span><span class="w"> </span><span class="err">#</span><span class="mi">16</span><span class="w"></span>
<span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">lsl</span><span class="w"> </span><span class="err">#</span><span class="mi">32</span><span class="w"></span>
<span class="w">  </span><span class="n">lsr</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">56</span><span class="w"></span>
</code></pre></div>
<p>And the second one:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="n">lsr</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xs</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x5555555555555555</span><span class="w"></span>
<span class="w">  </span><span class="n">sub</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xs</span><span class="p">,</span><span class="w"> </span><span class="n">xd</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x3333333333333333</span><span class="w"></span>
<span class="w">  </span><span class="n">lsr</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">2</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x3333333333333333</span><span class="w"></span>
<span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="w"></span>
<span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">lsr</span><span class="w"> </span><span class="err">#</span><span class="mi">4</span><span class="w"></span>
<span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0f0f0f0f0f0f0f0f</span><span class="w"></span>
<span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0101010101010101</span><span class="w"></span>
<span class="w">  </span><span class="n">mul</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xt</span><span class="w"></span>
<span class="w">  </span><span class="n">lsr</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="n">xd</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">56</span><span class="w"></span>
</code></pre></div>
<p>64-bit vector:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="n">fmov</span><span class="w"> </span><span class="n">dt</span><span class="p">,</span><span class="w"> </span><span class="n">xs</span><span class="w"></span>
<span class="w">  </span><span class="n">cnt</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="mi">8</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="mi">8</span><span class="n">b</span><span class="w"></span>
<span class="w">  </span><span class="n">addv</span><span class="w"> </span><span class="n">bt</span><span class="p">,</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="mi">8</span><span class="n">b</span><span class="w"></span>
<span class="w">  </span><span class="n">umov</span><span class="w"> </span><span class="n">wd</span><span class="p">,</span><span class="w"> </span><span class="n">vt</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<p>Here are the results for various microarchitectures in terms of speedup achieved by the vector implementation, i.e. higher numbers mean that the latter is better:</p>
<table>
<thead>
<tr>
<th>CPU core</th>
<th>8-bit latency speedup</th>
<th>8-bit throughput speedup</th>
<th>16-bit latency speedup</th>
<th>16-bit throughput speedup</th>
<th>32-bit latency speedup</th>
<th>32-bit throughput speedup</th>
<th>64-bit latency speedup</th>
<th>64-bit throughput speedup</th>
</tr>
</thead>
<tbody>
<tr>
<td>Arm Cortex-A55</td>
<td>252.84%</td>
<td>276.55%</td>
<td>224.39%</td>
<td>241.52%</td>
<td>256.10%</td>
<td>282.28%</td>
<td>293.79%</td>
<td>321.77%</td>
</tr>
<tr>
<td>Arm Neoverse N1</td>
<td>132.56%</td>
<td>348.84%</td>
<td>135.26%</td>
<td>243.04%</td>
<td>96.96%</td>
<td>197.12%</td>
<td>123.08%</td>
<td>213.46%</td>
</tr>
</tbody>
</table>
<p>In addition, here's how the alternative 64-bit scalar implementation (using multiplication) performs:<br>
CPU core|Latency speedup|Throughput speedup<br>
-|-|-<br>
Arm Cortex-A55|111.81%|109.10%<br>
Arm Neoverse N1|112.60%|110.45%</p>
<p>The results are based on median runtimes from 20 runs; standard errors were 0.02% or less.</p>
<p>The data demonstrates quite clearly that the vector variant is better than the scalar one; the only regression is in the 32-bit latency value. While the alternative 64-bit scalar implementation is a definite improvement, it still lags behind the vector one.</p>
</blockquote>



<a name="223300282"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231537%20Cranelift%20aarch64%20backend%3A%20impleme.../near/223300282" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231537.20Cranelift.20aarch64.20backend.3A.20impleme.2E.2E.2E.html#223300282">(Jan 19 2021 at 21:47)</a>:</h4>
<p>cfallin closed <a href="https://github.com/bytecodealliance/wasmtime/issues/1537">Issue #1537</a>:</p>
<blockquote>
<p>We currently use a sequence of instructions intended for 64-bit operation, and zero-extend narrower inputs. The original implementation by @jgouly almost works for 32 bits (and 8/16 bits extended to 32 bits), with a slight issue. We should rework the lowering to fix this issue and remove the need for zero-extending 32-bit operands.</p>
</blockquote>



<a name="223300387"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231537%20Cranelift%20aarch64%20backend%3A%20impleme.../near/223300387" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231537.20Cranelift.20aarch64.20backend.3A.20impleme.2E.2E.2E.html#223300387">(Jan 19 2021 at 21:48)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/1537#issuecomment-763163039">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1537">Issue #1537</a>:</p>
<blockquote>
<p>Thanks very much for this very detailed benchmarking!</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>