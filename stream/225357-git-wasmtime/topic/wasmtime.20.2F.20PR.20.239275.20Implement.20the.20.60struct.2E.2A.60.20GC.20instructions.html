<html>
<head><meta charset="utf-8"><title>wasmtime / PR #9275 Implement the `struct.*` GC instructions · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html">wasmtime / PR #9275 Implement the `struct.*` GC instructions</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="471135637"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471135637" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471135637">(Sep 18 2024 at 01:15)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/elliottt">elliottt</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9275">PR #9275</a>.</p>



<a name="471135638"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471135638" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471135638">(Sep 18 2024 at 01:15)</a>:</h4>
<p>fitzgen opened <a href="https://github.com/bytecodealliance/wasmtime/pull/9275">PR #9275</a> from <code>fitzgen:gc-struct-instructions</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This commit implements the <code>struct.*</code> instructions for the GC proposal.  These instructions allow allocating new structs and getting and setting their fields.</p>
<p>The implemented instructions are:</p>
<ul>
<li><code>struct.new</code></li>
<li><code>struct.new_default</code></li>
<li><code>struct.get</code></li>
<li><code>struct.get_s</code></li>
<li><code>struct.get_u</code></li>
<li><code>struct.set</code></li>
</ul>
<p>The <code>struct.new*</code> instructions are also allowed in constant expressions, but support for that is not yet implemented.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="471135639"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471135639" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471135639">(Sep 18 2024 at 01:15)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9275">PR #9275</a>.</p>



<a name="471135640"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471135640" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471135640">(Sep 18 2024 at 01:15)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9275">PR #9275</a>.</p>



<a name="471135655"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471135655" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471135655">(Sep 18 2024 at 01:15)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9275">PR #9275</a>.</p>



<a name="471137075"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471137075" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471137075">(Sep 18 2024 at 01:27)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9275">PR #9275</a>.</p>



<a name="471150078"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471150078" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471150078">(Sep 18 2024 at 02:54)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/9275#issuecomment-2357390707">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9275">PR #9275</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "cranelift:wasm", "wasmtime:api", "wasmtime:ref-types"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>fitzgen: wasmtime:ref-types</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="471152757"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471152757" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471152757">(Sep 18 2024 at 03:14)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1764326506">PR review comment</a>:</p>
<blockquote>
<p>TODO</p>
</blockquote>



<a name="471152758"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471152758" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471152758">(Sep 18 2024 at 03:14)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9275#pullrequestreview-2311515528">PR review</a>:</p>
<blockquote>
<p>Nice progress! <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
</blockquote>



<a name="471152759"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471152759" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471152759">(Sep 18 2024 at 03:14)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1764327902">PR review comment</a>:</p>
<blockquote>
<p>If you want I think it'd be fine to <code>pub use</code> the inner module up to here. That loses the "type check" that it's exactly the same signature with/without gc but I think that's ok given all the CI checks we have.</p>
</blockquote>



<a name="471152760"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471152760" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471152760">(Sep 18 2024 at 03:14)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1764329248">PR review comment</a>:</p>
<blockquote>
<p>Another alternative would be a cranelift pass perhaps? Optimizing away <code>trapz</code> shouldn't be too too hard in theory for most simple cases. (I realize egraphs won't work for this at all, but we can always write a custom pass too)</p>
</blockquote>



<a name="471152761"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471152761" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471152761">(Sep 18 2024 at 03:14)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1764332544">PR review comment</a>:</p>
<blockquote>
<p>Is <code>::trusted()</code> the right default here? I would have thought that this would be "can possibly trap" flags. We can stuff in a debug trap code which doesn't cause trap table information to get emitted but it should still hinder optimizations and such in Cranelift (which I think we want at least for now?)</p>
</blockquote>



<a name="471152762"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471152762" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471152762">(Sep 18 2024 at 03:14)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1764333637">PR review comment</a>:</p>
<blockquote>
<p>This method may want to be refactored to return <code>(ir::Value, u32)</code> to enable optionally embedding the offset in the load/store instruction. For now it'd always return 0 but maybe a future refactoring to have to optimize this a bit in the future.</p>
</blockquote>



<a name="471152763"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471152763" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471152763">(Sep 18 2024 at 03:14)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1764328861">PR review comment</a>:</p>
<blockquote>
<p>Another idea, if you're interested to cut down on the duplication here, change the spec trait to be like the component compiler where it has a method to return <code>fn gc_compiler(&amp;mut self) -&gt; Option&lt;&amp;mut dyn GcCompiler&gt;;</code> (in the cranelift-wasm crate) where the <code>GcCompiler</code> trait has all these struct translation methods. That way when gc is disabled you don't even need to impl <code>GcCompiler</code>, it just returns <code>None</code>, and only in the gc enabled case are there all the methods.</p>
</blockquote>



<a name="471152764"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471152764" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471152764">(Sep 18 2024 at 03:14)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1764335379">PR review comment</a>:</p>
<blockquote>
<p>As a minor possible optimization (future PR) this should be pretty easy to optimize in the egraph pass to downgrade this to <code>iadd</code>. It's pretty obvious by construction that this can't overflow, along with many other patterns too.</p>
<p>Whether it's worth it I'm not sure. Optimizing bounds checks is naturally going to be much more involved than just this b/c we want to rely on guard pages exclusively in theory.</p>
</blockquote>



<a name="471152765"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471152765" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471152765">(Sep 18 2024 at 03:14)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1764327336">PR review comment</a>:</p>
<blockquote>
<p>Perhaps route these all to a shared definition of a function to avoid needing to duplicate the message?</p>
</blockquote>



<a name="471152766"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471152766" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471152766">(Sep 18 2024 at 03:14)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1764335898">PR review comment</a>:</p>
<blockquote>
<p>One idea for a future trick: we could unmap the lowest page of memory in the GC heap so address 0 in the gc heap translates to a fault. That way we could push this trap into an annotated trap code on the <code>MemFlags</code> on the load below (or store for <code>struct.set</code>) which means we could, by construction, completely eliminate this trap as well. </p>
<p>(possibly all on top of a cranelift optimization pass to remove the checks entirely)</p>
</blockquote>



<a name="471299394"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471299394" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471299394">(Sep 18 2024 at 16:16)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9275#pullrequestreview-2313191313">PR review</a>.</p>



<a name="471299396"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471299396" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471299396">(Sep 18 2024 at 16:16)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1765353560">PR review comment</a>:</p>
<blockquote>
<p>This is a good idea -- I'll do a follow up to cut down on the boilerplate but leave it as-is for this PR.</p>
</blockquote>



<a name="471299854"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471299854" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471299854">(Sep 18 2024 at 16:18)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1765357035">PR review comment</a>:</p>
<blockquote>
<p>If it is a GC ref that this function allocated, or has already accessed, then we should be able to clean it up. In theory at least; in practice it might be a little tricky without introducing some new powers to the mid-end. But for an argument that we haven't accessed yet, then we can't really do anything without the type info, I don't think.</p>
</blockquote>



<a name="471299855"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471299855" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471299855">(Sep 18 2024 at 16:18)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9275#pullrequestreview-2313196972">PR review</a>.</p>



<a name="471300237"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471300237" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471300237">(Sep 18 2024 at 16:20)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9275#pullrequestreview-2313200383">PR review</a>.</p>



<a name="471300238"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471300238" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471300238">(Sep 18 2024 at 16:20)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1765360881">PR review comment</a>:</p>
<blockquote>
<p>I think we actually don't want to hinder optimizations. These aren't visible to Wasm semantics, or at least the whole point is they shouldn't be, so if the optimizer can prove that a load is redundant or whatever then I think we should let it.</p>
</blockquote>



<a name="471300463"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471300463" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471300463">(Sep 18 2024 at 16:21)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1765362437">PR review comment</a>:</p>
<blockquote>
<p>Yeah, I was also thinking it may want to take a <code>object_size: Option&lt;u32&gt;</code> argument as well to make bounds checks of repeated accesses dedupe-able by the mid-end. (Has to be an <code>Option</code> because we don't statically know array lengths).</p>
</blockquote>



<a name="471300464"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471300464" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471300464">(Sep 18 2024 at 16:21)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9275#pullrequestreview-2313202860">PR review</a>.</p>



<a name="471300798"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471300798" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471300798">(Sep 18 2024 at 16:23)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9275#pullrequestreview-2313206830">PR review</a>.</p>



<a name="471300801"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471300801" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471300801">(Sep 18 2024 at 16:23)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1765364540">PR review comment</a>:</p>
<blockquote>
<p>But: simple, naive things first and we can clean up the code we generate in follow ups.</p>
</blockquote>



<a name="471301544"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471301544" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471301544">(Sep 18 2024 at 16:27)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9275#pullrequestreview-2313214927">PR review</a>.</p>



<a name="471301545"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471301545" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471301545">(Sep 18 2024 at 16:27)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1765371333">PR review comment</a>:</p>
<blockquote>
<p>Ideally we'd have a mid-end ISLE rule something like</p>
<div class="codehilite" data-code-language="Common Lisp"><pre><span></span><code><span class="p">(</span><span class="nv">rule</span><span class="w"> </span><span class="p">(</span><span class="nv">simplify</span><span class="w"> </span><span class="p">(</span><span class="nv">uadd_overflow_trap</span><span class="w"> </span><span class="nv">$i64</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="nv">if-let</span><span class="w"> </span><span class="nv">$true</span><span class="w"> </span><span class="p">(</span><span class="nv">add_cannot_overflow</span><span class="w"> </span><span class="nv">$I64</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="nv">iadd</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="p">))</span>
</code></pre></div>
<p>where <code>add_cannot_overflow</code> handles constants and <code>(uextend ...)</code>s and such.</p>
<p>But because <code>uadd_overflow_trap</code> has side effects, we can't write such a rule in the mid-end today.</p>
</blockquote>



<a name="471302124"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471302124" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471302124">(Sep 18 2024 at 16:30)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9275#pullrequestreview-2313221037">PR review</a>.</p>



<a name="471302126"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471302126" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471302126">(Sep 18 2024 at 16:30)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1765375045">PR review comment</a>:</p>
<blockquote>
<p>We discussed this a bit in today's cranelift meeting. In summary, this is neat but kind of conflicts with our plans of eventually using linear memories to implement the GC heap, since the pooling allocator would have to allocate a linear memory for the GC heap, then unmap the first page, give it to Wasm until the instance is done, then remap the first page before returning it to the memory pool. This is all doable of course, but the extra special-case code paths are annoying and adding more virtual memory calls in the pooling allocator is always fraught perf-wise.</p>
</blockquote>



<a name="471304482"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471304482" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471304482">(Sep 18 2024 at 16:42)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9275">PR #9275</a>.</p>



<a name="471304501"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471304501" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471304501">(Sep 18 2024 at 16:42)</a>:</h4>
<p>fitzgen has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/9275">PR #9275</a>.</p>



<a name="471307330"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471307330" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471307330">(Sep 18 2024 at 16:59)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9275">PR #9275</a>.</p>



<a name="471312128"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239275%20Implement%20the%20%60struct.%2A%60%20GC%20instructions/near/471312128" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239275.20Implement.20the.20.60struct.2E.2A.60.20GC.20instructions.html#471312128">(Sep 18 2024 at 17:27)</a>:</h4>
<p>fitzgen merged <a href="https://github.com/bytecodealliance/wasmtime/pull/9275">PR #9275</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>