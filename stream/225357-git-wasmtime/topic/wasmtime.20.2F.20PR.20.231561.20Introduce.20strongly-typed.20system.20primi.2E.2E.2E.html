<html>
<head><meta charset="utf-8"><title>wasmtime / PR #1561 Introduce strongly-typed system primi... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html">wasmtime / PR #1561 Introduce strongly-typed system primi...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="194902397"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/194902397" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#194902397">(Apr 22 2020 at 08:45)</a>:</h4>
<p>kubkon edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1561" title="https://github.com/bytecodealliance/wasmtime/pull/1561">PR #1561</a> from <code>handle-rights</code> to <code>master</code>:</p>
<blockquote>
<p>This commit does a lot of reshuffling and even some more. It introduces<br>
strongly-typed system primitives which are: <code>OsFile</code>, <code>OsDir</code>, <code>Stdio</code>,<br>
and <code>OsOther</code>. Those primitives are separate structs now, each implementing<br>
a subset of <code>Handle</code> methods, rather than all being an enumeration of some<br>
supertype such as <code>OsHandle</code>. To summarise the structs:</p>
<ul>
<li>
<p><code>OsFile</code> represents a regular file, and implements fd-ops<br>
  of <code>Handle</code> trait</p>
</li>
<li>
<p><code>OsDir</code> represents a directory, and primarily implements path-ops, plus<br>
<code>readdir</code> and some common fd-ops such as <code>fdstat</code>, etc.</p>
</li>
<li>
<p><code>Stdio</code> represents a stdio handle, and implements a subset of fd-ops<br>
  such as <code>fdstat</code> _and_ <code>read_</code> and <code>write_vectored</code> calls</p>
</li>
<li>
<p><code>OsOther</code> currently represents anything else and implements a set similar<br>
  to that implemented by <code>Stdio</code></p>
</li>
</ul>
<p>This commit is effectively an experiment and an excercise into better<br>
understanding what's going on for each OS resource/type under-the-hood.<br>
It's meant to give us some intuition in order to move on with the idea<br>
of having strongly-typed handles in WASI both in the syscall impl as well<br>
as at the libc level.</p>
<p>Some more minor changes include making <code>OsHandle</code> represent an OS-specific<br>
wrapper for a raw OS handle (Unix fd or Windows handle). Also, since <code>OsDir</code><br>
is tricky across OSes, we also have a supertype of <code>OsHandle</code> called<br>
<code>OsDirHandle</code> which may store a <code>DIR*</code> stream pointer (mainly BSD). Last but not<br>
least, the <code>Filetype</code> and <code>Rights</code> are now computed when the resource is created,<br>
rather than every time we call <code>Handle::get_file_type</code> and <code>Handle::get_rights</code>.<br>
Finally, in order to facilitate the latter, I've converted <code>EntryRights</code> into<br>
<code>HandleRights</code> and pushed them into each <code>Handle</code> implementor.</p>
</blockquote>



<a name="194909347"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/194909347" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#194909347">(Apr 22 2020 at 09:52)</a>:</h4>
<p>kubkon updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1561" title="https://github.com/bytecodealliance/wasmtime/pull/1561">PR #1561</a> from <code>handle-rights</code> to <code>master</code>:</p>
<blockquote>
<p>This commit does a lot of reshuffling and even some more. It introduces<br>
strongly-typed system primitives which are: <code>OsFile</code>, <code>OsDir</code>, <code>Stdio</code>,<br>
and <code>OsOther</code>. Those primitives are separate structs now, each implementing<br>
a subset of <code>Handle</code> methods, rather than all being an enumeration of some<br>
supertype such as <code>OsHandle</code>. To summarise the structs:</p>
<ul>
<li>
<p><code>OsFile</code> represents a regular file, and implements fd-ops<br>
  of <code>Handle</code> trait</p>
</li>
<li>
<p><code>OsDir</code> represents a directory, and primarily implements path-ops, plus<br>
<code>readdir</code> and some common fd-ops such as <code>fdstat</code>, etc.</p>
</li>
<li>
<p><code>Stdio</code> represents a stdio handle, and implements a subset of fd-ops<br>
  such as <code>fdstat</code> _and_ <code>read_</code> and <code>write_vectored</code> calls</p>
</li>
<li>
<p><code>OsOther</code> currently represents anything else and implements a set similar<br>
  to that implemented by <code>Stdio</code></p>
</li>
</ul>
<p>This commit is effectively an experiment and an excercise into better<br>
understanding what's going on for each OS resource/type under-the-hood.<br>
It's meant to give us some intuition in order to move on with the idea<br>
of having strongly-typed handles in WASI both in the syscall impl as well<br>
as at the libc level.</p>
<p>Some more minor changes include making <code>OsHandle</code> represent an OS-specific<br>
wrapper for a raw OS handle (Unix fd or Windows handle). Also, since <code>OsDir</code><br>
is tricky across OSes, we also have a supertype of <code>OsHandle</code> called<br>
<code>OsDirHandle</code> which may store a <code>DIR*</code> stream pointer (mainly BSD). Last but not<br>
least, the <code>Filetype</code> and <code>Rights</code> are now computed when the resource is created,<br>
rather than every time we call <code>Handle::get_file_type</code> and <code>Handle::get_rights</code>.<br>
Finally, in order to facilitate the latter, I've converted <code>EntryRights</code> into<br>
<code>HandleRights</code> and pushed them into each <code>Handle</code> implementor.</p>
</blockquote>



<a name="195322730"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195322730" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195322730">(Apr 26 2020 at 07:50)</a>:</h4>
<p>kubkon updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1561" title="https://github.com/bytecodealliance/wasmtime/pull/1561">PR #1561</a> from <code>handle-rights</code> to <code>master</code>:</p>
<blockquote>
<p>This commit does a lot of reshuffling and even some more. It introduces<br>
strongly-typed system primitives which are: <code>OsFile</code>, <code>OsDir</code>, <code>Stdio</code>,<br>
and <code>OsOther</code>. Those primitives are separate structs now, each implementing<br>
a subset of <code>Handle</code> methods, rather than all being an enumeration of some<br>
supertype such as <code>OsHandle</code>. To summarise the structs:</p>
<ul>
<li>
<p><code>OsFile</code> represents a regular file, and implements fd-ops<br>
  of <code>Handle</code> trait</p>
</li>
<li>
<p><code>OsDir</code> represents a directory, and primarily implements path-ops, plus<br>
<code>readdir</code> and some common fd-ops such as <code>fdstat</code>, etc.</p>
</li>
<li>
<p><code>Stdio</code> represents a stdio handle, and implements a subset of fd-ops<br>
  such as <code>fdstat</code> _and_ <code>read_</code> and <code>write_vectored</code> calls</p>
</li>
<li>
<p><code>OsOther</code> currently represents anything else and implements a set similar<br>
  to that implemented by <code>Stdio</code></p>
</li>
</ul>
<p>This commit is effectively an experiment and an excercise into better<br>
understanding what's going on for each OS resource/type under-the-hood.<br>
It's meant to give us some intuition in order to move on with the idea<br>
of having strongly-typed handles in WASI both in the syscall impl as well<br>
as at the libc level.</p>
<p>Some more minor changes include making <code>OsHandle</code> represent an OS-specific<br>
wrapper for a raw OS handle (Unix fd or Windows handle). Also, since <code>OsDir</code><br>
is tricky across OSes, we also have a supertype of <code>OsHandle</code> called<br>
<code>OsDirHandle</code> which may store a <code>DIR*</code> stream pointer (mainly BSD). Last but not<br>
least, the <code>Filetype</code> and <code>Rights</code> are now computed when the resource is created,<br>
rather than every time we call <code>Handle::get_file_type</code> and <code>Handle::get_rights</code>.<br>
Finally, in order to facilitate the latter, I've converted <code>EntryRights</code> into<br>
<code>HandleRights</code> and pushed them into each <code>Handle</code> implementor.</p>
</blockquote>



<a name="195476263"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195476263" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195476263">(Apr 27 2020 at 21:17)</a>:</h4>
<p>pchickey submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401297787" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401297787">PR Review</a>.</p>



<a name="195476264"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195476264" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195476264">(Apr 27 2020 at 21:17)</a>:</h4>
<p>pchickey submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401297787" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401297787">PR Review</a>.</p>



<a name="195476266"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195476266" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195476266">(Apr 27 2020 at 21:17)</a>:</h4>
<p>pchickey created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416149497" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416149497">PR Review Comment</a>:</p>
<blockquote>
<p>This is maybe a comment for the PR that introduced <code>Handle</code>, but if instead of having an <code>as_any(&amp;self) -&gt; &amp;dyn Any</code>, the <code>Handle</code> trait instead depended on <code>Any</code>, then you could drop that trivial method, and also this <code>'static' constraint, because </code>Any<code> implies </code>'static`.</p>
</blockquote>



<a name="195476267"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195476267" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195476267">(Apr 27 2020 at 21:17)</a>:</h4>
<p>pchickey created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416122367" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416122367">PR Review Comment</a>:</p>
<blockquote>
<p>I think its pretty dangerous to panic here - instead, can we return a Result, so we can bubble this error outwards without crashing?</p>
</blockquote>



<a name="195476268"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195476268" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195476268">(Apr 27 2020 at 21:17)</a>:</h4>
<p>pchickey created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416154967" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416154967">PR Review Comment</a>:</p>
<blockquote>
<p>Can you leave a comment specifically on why we have to handle the tty and non-tty cases separately? Whether <code>io::stdout()</code> gives us a tty or not depends on how the embedding process is invoked, right? Is there any way to avoid exposing that to the guest?</p>
</blockquote>



<a name="195566317"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195566317" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195566317">(Apr 28 2020 at 13:48)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401853025" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401853025">PR Review</a>.</p>



<a name="195566318"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195566318" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195566318">(Apr 28 2020 at 13:48)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416627626" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416627626">PR Review Comment</a>:</p>
<blockquote>
<p>Agreed! I'll redo it returning a <code>Result</code> instead as suggested :-)</p>
</blockquote>



<a name="195566432"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195566432" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195566432">(Apr 28 2020 at 13:49)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401853874" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401853874">PR Review</a>.</p>



<a name="195566433"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195566433" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195566433">(Apr 28 2020 at 13:49)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416628328" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416628328">PR Review Comment</a>:</p>
<blockquote>
<p>Oh nice, I didn't think of that! Lemme give it a spin and report back. Oh, and thanks for the suggestion!</p>
</blockquote>



<a name="195567034"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195567034" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195567034">(Apr 28 2020 at 13:53)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401858527" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401858527">PR Review</a>.</p>



<a name="195567035"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195567035" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195567035">(Apr 28 2020 at 13:53)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416631961" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416631961">PR Review Comment</a>:</p>
<blockquote>
<p>Yeah, that's correct. I actually need to revisit at some point, but the reason we ended up with custom <code>Stdio</code> type which is a proxy for Rust's stdio handles, is because Windows was doing some crazy stdio redirects on the CI which were nontrivial to handle. I'll add some comments about for posterity. Thanks for spotting that one!</p>
</blockquote>



<a name="195587408"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195587408" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195587408">(Apr 28 2020 at 16:10)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401994192" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401994192">PR Review</a>.</p>



<a name="195587410"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195587410" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195587410">(Apr 28 2020 at 16:11)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416741253" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416741253">PR Review Comment</a>:</p>
<blockquote>
<p><em>drops in</em> This is just a <code>&amp;File -&gt; ManuallyDrop&lt;File&gt;</code> conversion, right? You ought to be able to remove this line (and the <code>AsFile</code> impl above, it seems?</p>
</blockquote>



<a name="195587480"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195587480" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195587480">(Apr 28 2020 at 16:11)</a>:</h4>
<p>kubkon updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1561" title="https://github.com/bytecodealliance/wasmtime/pull/1561">PR #1561</a> from <code>handle-rights</code> to <code>master</code>:</p>
<blockquote>
<p>This commit does a lot of reshuffling and even some more. It introduces<br>
strongly-typed system primitives which are: <code>OsFile</code>, <code>OsDir</code>, <code>Stdio</code>,<br>
and <code>OsOther</code>. Those primitives are separate structs now, each implementing<br>
a subset of <code>Handle</code> methods, rather than all being an enumeration of some<br>
supertype such as <code>OsHandle</code>. To summarise the structs:</p>
<ul>
<li>
<p><code>OsFile</code> represents a regular file, and implements fd-ops<br>
  of <code>Handle</code> trait</p>
</li>
<li>
<p><code>OsDir</code> represents a directory, and primarily implements path-ops, plus<br>
<code>readdir</code> and some common fd-ops such as <code>fdstat</code>, etc.</p>
</li>
<li>
<p><code>Stdio</code> represents a stdio handle, and implements a subset of fd-ops<br>
  such as <code>fdstat</code> _and_ <code>read_</code> and <code>write_vectored</code> calls</p>
</li>
<li>
<p><code>OsOther</code> currently represents anything else and implements a set similar<br>
  to that implemented by <code>Stdio</code></p>
</li>
</ul>
<p>This commit is effectively an experiment and an excercise into better<br>
understanding what's going on for each OS resource/type under-the-hood.<br>
It's meant to give us some intuition in order to move on with the idea<br>
of having strongly-typed handles in WASI both in the syscall impl as well<br>
as at the libc level.</p>
<p>Some more minor changes include making <code>OsHandle</code> represent an OS-specific<br>
wrapper for a raw OS handle (Unix fd or Windows handle). Also, since <code>OsDir</code><br>
is tricky across OSes, we also have a supertype of <code>OsHandle</code> called<br>
<code>OsDirHandle</code> which may store a <code>DIR*</code> stream pointer (mainly BSD). Last but not<br>
least, the <code>Filetype</code> and <code>Rights</code> are now computed when the resource is created,<br>
rather than every time we call <code>Handle::get_file_type</code> and <code>Handle::get_rights</code>.<br>
Finally, in order to facilitate the latter, I've converted <code>EntryRights</code> into<br>
<code>HandleRights</code> and pushed them into each <code>Handle</code> implementor.</p>
</blockquote>



<a name="195587980"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195587980" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195587980">(Apr 28 2020 at 16:14)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401997524" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401997524">PR Review</a>.</p>



<a name="195587982"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195587982" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195587982">(Apr 28 2020 at 16:15)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416744081" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416744081">PR Review Comment</a>:</p>
<blockquote>
<p>Ah, well spotted, thanks!</p>
<p>As far as the <code>AsFile</code> impl goes, this blanket impl is needed so that any type that wraps <code>OsHandle</code> (which itself implements <code>AsRawFd</code>) to be able to convert automatically to <code>std::fs::File</code>.</p>
</blockquote>



<a name="195588077"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195588077" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195588077">(Apr 28 2020 at 16:15)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401998128" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401998128">PR Review</a>.</p>



<a name="195588078"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195588078" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195588078">(Apr 28 2020 at 16:15)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416744560" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416744560">PR Review Comment</a>:</p>
<blockquote>
<p>That's why, if you look closely, the impl goes for any <code>T: AsRawFd</code>.</p>
</blockquote>



<a name="195588225"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195588225" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195588225">(Apr 28 2020 at 16:16)</a>:</h4>
<p>kubkon updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1561" title="https://github.com/bytecodealliance/wasmtime/pull/1561">PR #1561</a> from <code>handle-rights</code> to <code>master</code>:</p>
<blockquote>
<p>This commit does a lot of reshuffling and even some more. It introduces<br>
strongly-typed system primitives which are: <code>OsFile</code>, <code>OsDir</code>, <code>Stdio</code>,<br>
and <code>OsOther</code>. Those primitives are separate structs now, each implementing<br>
a subset of <code>Handle</code> methods, rather than all being an enumeration of some<br>
supertype such as <code>OsHandle</code>. To summarise the structs:</p>
<ul>
<li>
<p><code>OsFile</code> represents a regular file, and implements fd-ops<br>
  of <code>Handle</code> trait</p>
</li>
<li>
<p><code>OsDir</code> represents a directory, and primarily implements path-ops, plus<br>
<code>readdir</code> and some common fd-ops such as <code>fdstat</code>, etc.</p>
</li>
<li>
<p><code>Stdio</code> represents a stdio handle, and implements a subset of fd-ops<br>
  such as <code>fdstat</code> _and_ <code>read_</code> and <code>write_vectored</code> calls</p>
</li>
<li>
<p><code>OsOther</code> currently represents anything else and implements a set similar<br>
  to that implemented by <code>Stdio</code></p>
</li>
</ul>
<p>This commit is effectively an experiment and an excercise into better<br>
understanding what's going on for each OS resource/type under-the-hood.<br>
It's meant to give us some intuition in order to move on with the idea<br>
of having strongly-typed handles in WASI both in the syscall impl as well<br>
as at the libc level.</p>
<p>Some more minor changes include making <code>OsHandle</code> represent an OS-specific<br>
wrapper for a raw OS handle (Unix fd or Windows handle). Also, since <code>OsDir</code><br>
is tricky across OSes, we also have a supertype of <code>OsHandle</code> called<br>
<code>OsDirHandle</code> which may store a <code>DIR*</code> stream pointer (mainly BSD). Last but not<br>
least, the <code>Filetype</code> and <code>Rights</code> are now computed when the resource is created,<br>
rather than every time we call <code>Handle::get_file_type</code> and <code>Handle::get_rights</code>.<br>
Finally, in order to facilitate the latter, I've converted <code>EntryRights</code> into<br>
<code>HandleRights</code> and pushed them into each <code>Handle</code> implementor.</p>
</blockquote>



<a name="195588477"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195588477" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195588477">(Apr 28 2020 at 16:18)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-402000359" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-402000359">PR Review</a>.</p>



<a name="195588479"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195588479" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195588479">(Apr 28 2020 at 16:18)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416746482" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416746482">PR Review Comment</a>:</p>
<blockquote>
<p>Done in 26c894a.</p>
</blockquote>



<a name="195588527"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195588527" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195588527">(Apr 28 2020 at 16:18)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-402000765" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-402000765">PR Review</a>.</p>



<a name="195588528"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195588528" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195588528">(Apr 28 2020 at 16:18)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416746834" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416746834">PR Review Comment</a>:</p>
<blockquote>
<p>The line removed in 5b7e54e BTW.</p>
</blockquote>



<a name="195681419"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195681419" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195681419">(Apr 29 2020 at 09:21)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-402497394" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-402497394">PR Review</a>.</p>



<a name="195681420"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195681420" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195681420">(Apr 29 2020 at 09:21)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r417179216" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r417179216">PR Review Comment</a>:</p>
<blockquote>
<p>OK, so after some careful analysis, I believe we'll still require <code>as_any(&amp;self) -&gt; &amp;dyn Any</code> method defined in each implementor of the <code>Handle</code> trait. Here's the breakout of the reasons I discovered:</p>
<ol>
<li>vtables in Rust currently do not permit for trait upcasting (see <a href="https://articles.bchlr.de/traits-dynamic-dispatch-upcasting" title="https://articles.bchlr.de/traits-dynamic-dispatch-upcasting">here</a> and <a href="https://github.com/rust-lang/rust/pull/60900" title="https://github.com/rust-lang/rust/pull/60900">here</a>). This then implies that, even if <code>Handle: Any</code>, we can't go from <code>dyn Handle</code> to <code>dyn Any</code>.</li>
<li>Even if we added the constraint <code>Handle: Any</code> and made <code>as_any(&amp;self) -&gt; &amp;dyn Any</code> a provided method, we'd still need to require that, at the very least, for <code>as_any(...)</code> <code>Self: Sized</code>. But then, <code>as_any(...)</code> is not available for <code>dyn Handle</code> trait object.</li>
</ol>
<p>All in all, requiring <code>Any</code> on <code>Handle</code> seems to only get rid of the <code>'static</code> requirement in the referenced <code>impl AsFile</code> which I don't think is worth it? Lemme know what you think! Maybe there's something obvious that I missed and this will actually work, or perhaps I misunderstood what you meant! :-)</p>
</blockquote>



<a name="195683051"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195683051" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195683051">(Apr 29 2020 at 09:37)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r417188079" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r417188079">PR Review Comment</a>:</p>
<blockquote>
<p>Just clarify further, as far as the guest is concerned, <code>Stdio</code> should be transparent to them. As I mentioned above, the only reason we have a separate <code>Stdio</code> type in <code>wasi-common</code> is to correctly facilitate redirects on Windows. To elaborate further, in POSIX, we can get a stdio handle by opening a specific fd <code>{0,1,2}</code>. On Windows however, we need to issue a syscall that's separate from standard Windows "open" to get a console handle, and this is <a href="https://docs.microsoft.com/en-us/windows/console/getstdhandle" title="https://docs.microsoft.com/en-us/windows/console/getstdhandle"><code>GetStdHandle</code></a>. This is exactly what Rust does and what is wrapped inside their <code>Stdio</code> object in the <code>libstd</code>. We wrap it here as well because of this nuance on Windows:</p>
<blockquote>
<p>The standard handles of a process may be redirected by a call to SetStdHandle, in which case GetStdHandle returns the redirected handle.</p>
</blockquote>
<p>The <a href="https://docs.microsoft.com/en-us/windows/console/getstdhandle" title="https://docs.microsoft.com/en-us/windows/console/getstdhandle">MSDN</a> also says this however:</p>
<blockquote>
<p>If the standard handles have been redirected, you can specify the CONIN$ value in a call to the CreateFile function to get a handle to a console's input buffer. Similarly, you can specify the CONOUT$ value to get a handle to a console's active screen buffer.</p>
</blockquote>
<p>But I'm not that well versed in Windows programming to know how to do this properly, which is not to say we shouldn't (re-)investigate at some point.</p>
<p>Anyway, do you think this explanation would do here? Oh, and as far as the check for <code>TTY</code> goes, I'm actually not sure what to do here. I'm not sure whether the handle returned by <code>GetStdHandle</code> will be treated like a <code>TTY</code>. I guess we should investigate further, but I'd vouch for leaving a TODO comment in and do it in a subsequent PR?</p>
</blockquote>



<a name="195683053"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195683053" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195683053">(Apr 29 2020 at 09:37)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-402508430" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-402508430">PR Review</a>.</p>



<a name="195685337"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195685337" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195685337">(Apr 29 2020 at 09:57)</a>:</h4>
<p>kubkon updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1561" title="https://github.com/bytecodealliance/wasmtime/pull/1561">PR #1561</a> from <code>handle-rights</code> to <code>master</code>:</p>
<blockquote>
<p>This commit does a lot of reshuffling and even some more. It introduces<br>
strongly-typed system primitives which are: <code>OsFile</code>, <code>OsDir</code>, <code>Stdio</code>,<br>
and <code>OsOther</code>. Those primitives are separate structs now, each implementing<br>
a subset of <code>Handle</code> methods, rather than all being an enumeration of some<br>
supertype such as <code>OsHandle</code>. To summarise the structs:</p>
<ul>
<li>
<p><code>OsFile</code> represents a regular file, and implements fd-ops<br>
  of <code>Handle</code> trait</p>
</li>
<li>
<p><code>OsDir</code> represents a directory, and primarily implements path-ops, plus<br>
<code>readdir</code> and some common fd-ops such as <code>fdstat</code>, etc.</p>
</li>
<li>
<p><code>Stdio</code> represents a stdio handle, and implements a subset of fd-ops<br>
  such as <code>fdstat</code> _and_ <code>read_</code> and <code>write_vectored</code> calls</p>
</li>
<li>
<p><code>OsOther</code> currently represents anything else and implements a set similar<br>
  to that implemented by <code>Stdio</code></p>
</li>
</ul>
<p>This commit is effectively an experiment and an excercise into better<br>
understanding what's going on for each OS resource/type under-the-hood.<br>
It's meant to give us some intuition in order to move on with the idea<br>
of having strongly-typed handles in WASI both in the syscall impl as well<br>
as at the libc level.</p>
<p>Some more minor changes include making <code>OsHandle</code> represent an OS-specific<br>
wrapper for a raw OS handle (Unix fd or Windows handle). Also, since <code>OsDir</code><br>
is tricky across OSes, we also have a supertype of <code>OsHandle</code> called<br>
<code>OsDirHandle</code> which may store a <code>DIR*</code> stream pointer (mainly BSD). Last but not<br>
least, the <code>Filetype</code> and <code>Rights</code> are now computed when the resource is created,<br>
rather than every time we call <code>Handle::get_file_type</code> and <code>Handle::get_rights</code>.<br>
Finally, in order to facilitate the latter, I've converted <code>EntryRights</code> into<br>
<code>HandleRights</code> and pushed them into each <code>Handle</code> implementor.</p>
</blockquote>



<a name="195685383"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195685383" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195685383">(Apr 29 2020 at 09:57)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-402521873" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-402521873">PR Review</a>.</p>



<a name="195685385"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195685385" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195685385">(Apr 29 2020 at 09:57)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r417198843" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r417198843">PR Review Comment</a>:</p>
<blockquote>
<p>OK, after careful analysis, I think we can remove the check and _always_ santise the output to <code>stdout</code> since <code>is_tty</code> will always resolve to true for <code>Stdio</code> handle type. However, I think we need to keep the check in case of <code>OsOther</code> handle type which can encapsulate user-specified handle to redirected stdio. I'm thinking here of piping and mainly on Unix, but perhaps it might also be possible on Windows.</p>
<p>I've done that now in f76e7c4.</p>
</blockquote>



<a name="195770891"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195770891" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195770891">(Apr 29 2020 at 21:13)</a>:</h4>
<p><strong>kubkon</strong> requested <a href="https://github.com/alexcrichton" title="https://github.com/alexcrichton">alexcrichton</a>, <a href="https://github.com/pchickey" title="https://github.com/pchickey">pchickey</a>, <a href="https://github.com/peterhuene" title="https://github.com/peterhuene">peterhuene</a> and <a href="https://github.com/sunfishcode" title="https://github.com/sunfishcode">sunfishcode</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1561" title="https://github.com/bytecodealliance/wasmtime/pull/1561">PR #1561</a>.</p>



<a name="195780655"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195780655" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195780655">(Apr 29 2020 at 23:01)</a>:</h4>
<p>pchickey submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-403098669" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-403098669">PR Review</a>.</p>



<a name="195780657"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195780657" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195780657">(Apr 29 2020 at 23:01)</a>:</h4>
<p>pchickey created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r417661606" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r417661606">PR Review Comment</a>:</p>
<blockquote>
<p>I had no idea that trait upcasting was not allowed. That is a bummer and a sufficient reason for this design.</p>
</blockquote>



<a name="195781154"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195781154" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195781154">(Apr 29 2020 at 23:07)</a>:</h4>
<p>pchickey submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-403101098" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-403101098">PR Review</a>.</p>



<a name="195781155"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195781155" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195781155">(Apr 29 2020 at 23:07)</a>:</h4>
<p>pchickey created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r417663791" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r417663791">PR Review Comment</a>:</p>
<blockquote>
<p>Thanks, I understand this a lot better now. Thanks for the explanation and adding it to the docs!</p>
</blockquote>



<a name="195781228"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195781228" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195781228">(Apr 29 2020 at 23:08)</a>:</h4>
<p>pchickey submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-403101291" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-403101291">PR Review</a>.</p>



<a name="195811613"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195811613" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195811613">(Apr 30 2020 at 08:41)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-403317233" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-403317233">PR Review</a>.</p>



<a name="195811614"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/195811614" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#195811614">(Apr 30 2020 at 08:41)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r417849999" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r417849999">PR Review Comment</a>:</p>
<blockquote>
<p>I didn't either, so thanks for prodding me to have a look! :-)</p>
</blockquote>



<a name="196023891"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196023891" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196023891">(May 02 2020 at 00:24)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404446669" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404446669">PR Review</a>.</p>



<a name="196023892"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196023892" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196023892">(May 02 2020 at 00:24)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404446669" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404446669">PR Review</a>.</p>



<a name="196023893"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196023893" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196023893">(May 02 2020 at 00:24)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418778444" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418778444">PR Review Comment</a>:</p>
<blockquote>
<p>And <code>stderr</code> here?</p>
</blockquote>



<a name="196023894"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196023894" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196023894">(May 02 2020 at 00:24)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418783655" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418783655">PR Review Comment</a>:</p>
<blockquote>
<p>How difficult would it be to split this enum out into three separate structs that all implement the <code>Handle</code> trait independently? Besides the additional dynamic dispatch inside the <code>read</code> and <code>write</code> methods, I think that'd really illustrate how this <code>Handle</code> trait works -- every different kind of stream has its own impl. There'd be some duplication in the other methods, but it seems like that could be factored out with helper methods. </p>
</blockquote>



<a name="196023895"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196023895" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196023895">(May 02 2020 at 00:24)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418778417" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418778417">PR Review Comment</a>:</p>
<blockquote>
<p>Should this be <code>stdout</code>?</p>
</blockquote>



<a name="196023896"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196023896" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196023896">(May 02 2020 at 00:24)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418779246" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418779246">PR Review Comment</a>:</p>
<blockquote>
<p>This can be written as <code>Self::In { rights } | Self::Out { rights } | Self::Err { rights } =&gt; rights.get(),</code>, and similar in <code>set_rights</code>.</p>
</blockquote>



<a name="196023897"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196023897" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196023897">(May 02 2020 at 00:24)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418778968" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418778968">PR Review Comment</a>:</p>
<blockquote>
<p>Stdio won't always be a character device, such as when it's redirected from a file ("grep foo &lt; file.txt") or a pipe ("cat file.txt | grep foo"). We still need to do <code>fstat</code> on it to determine its type.</p>
</blockquote>



<a name="196023898"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196023898" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196023898">(May 02 2020 at 00:24)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418784914" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418784914">PR Review Comment</a>:</p>
<blockquote>
<p>Should <code>OsHandle</code> have a name with <code>Raw</code> in it, since it wraps a <code>RawFd</code>/<code>RawHandle</code>? Maybe <code>RawOSHandle</code>?</p>
</blockquote>



<a name="196023899"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196023899" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196023899">(May 02 2020 at 00:24)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418784679" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418784679">PR Review Comment</a>:</p>
<blockquote>
<p>Can you add a comment here briefly explaining what <code>OsOther</code> is?</p>
</blockquote>



<a name="196023900"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196023900" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196023900">(May 02 2020 at 00:24)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418787377" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418787377">PR Review Comment</a>:</p>
<blockquote>
<p>Why does this use <code>OsOther</code> here? Looking at the code, that seems to be for things that aren't files.</p>
</blockquote>



<a name="196023901"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196023901" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196023901">(May 02 2020 at 00:24)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418786597" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418786597">PR Review Comment</a>:</p>
<blockquote>
<p>If I understand correctly, the main use for <code>update_from</code> is for the <code>fdstat_set_flags</code>, which on Windows opens a new handle. If that's the only thing that needs it, could we make <code>update_from</code> on Unix just panic?</p>
<p>And, if we don't need to implement <code>update_from</code>, can <code>OsHandle</code> on Unix hold a plain <code>RawFd</code> instead of a <code>Cell&lt;RawFd&gt;</code>?</p>
</blockquote>



<a name="196037809"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196037809" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196037809">(May 02 2020 at 07:03)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404506427" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404506427">PR Review</a>.</p>



<a name="196037810"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196037810" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196037810">(May 02 2020 at 07:03)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418923344" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418923344">PR Review Comment</a>:</p>
<blockquote>
<p>Oh shoot, you're absolutely correct, thanks for spotting it!</p>
</blockquote>



<a name="196037855"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196037855" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196037855">(May 02 2020 at 07:04)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404506468" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404506468">PR Review</a>.</p>



<a name="196037856"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196037856" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196037856">(May 02 2020 at 07:04)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418923439" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418923439">PR Review Comment</a>:</p>
<blockquote>
<p>Likewise here! Makes me start questioning our test suite. Then again, I'm not sure if there will be an obvious way of verifying stdio handles in the CI.</p>
</blockquote>



<a name="196037858"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196037858" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196037858">(May 02 2020 at 07:05)</a>:</h4>
<p>kubkon edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418923439" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418923439">PR Review Comment</a>.</p>



<a name="196037981"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196037981" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196037981">(May 02 2020 at 07:09)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404506724" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404506724">PR Review</a>.</p>



<a name="196037982"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196037982" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196037982">(May 02 2020 at 07:09)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418923851" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418923851">PR Review Comment</a>:</p>
<blockquote>
<p>Right, however, here, I think it's safe to assume that our internal <code>Stdio</code> type will always be a character device since it is meant to be a wrapper for Rust's stdio primitives. I envisioned that redirections should be handled by a separate entity in the codebase, namely, <code>OsOther</code> which is something like a catch-all for everything not covered with the specific handle types. Does that make sense? In fact, that's why in <code>ctx.rs</code> we map <code>std::fs::File</code> to <code>OsOther</code> as currently we only ever permit specifying custom fds/handles for stdio when builing the context.</p>
</blockquote>



<a name="196037986"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196037986" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196037986">(May 02 2020 at 07:10)</a>:</h4>
<p>kubkon edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418923851" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418923851">PR Review Comment</a>.</p>



<a name="196038024"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196038024" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196038024">(May 02 2020 at 07:10)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404506751" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404506751">PR Review</a>.</p>



<a name="196038025"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196038025" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196038025">(May 02 2020 at 07:10)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418923898" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418923898">PR Review Comment</a>:</p>
<blockquote>
<p>Ah excellent, thanks!</p>
</blockquote>



<a name="196038072"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196038072" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196038072">(May 02 2020 at 07:12)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404506867" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404506867">PR Review</a>.</p>



<a name="196038073"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196038073" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196038073">(May 02 2020 at 07:12)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418924107" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418924107">PR Review Comment</a>:</p>
<blockquote>
<p>Oh right, sure thing!</p>
</blockquote>



<a name="196038135"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196038135" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196038135">(May 02 2020 at 07:15)</a>:</h4>
<p>kubkon updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1561" title="https://github.com/bytecodealliance/wasmtime/pull/1561">PR #1561</a> from <code>handle-rights</code> to <code>master</code>:</p>
<blockquote>
<p>This commit does a lot of reshuffling and even some more. It introduces<br>
strongly-typed system primitives which are: <code>OsFile</code>, <code>OsDir</code>, <code>Stdio</code>,<br>
and <code>OsOther</code>. Those primitives are separate structs now, each implementing<br>
a subset of <code>Handle</code> methods, rather than all being an enumeration of some<br>
supertype such as <code>OsHandle</code>. To summarise the structs:</p>
<ul>
<li>
<p><code>OsFile</code> represents a regular file, and implements fd-ops<br>
  of <code>Handle</code> trait</p>
</li>
<li>
<p><code>OsDir</code> represents a directory, and primarily implements path-ops, plus<br>
<code>readdir</code> and some common fd-ops such as <code>fdstat</code>, etc.</p>
</li>
<li>
<p><code>Stdio</code> represents a stdio handle, and implements a subset of fd-ops<br>
  such as <code>fdstat</code> _and_ <code>read_</code> and <code>write_vectored</code> calls</p>
</li>
<li>
<p><code>OsOther</code> currently represents anything else and implements a set similar<br>
  to that implemented by <code>Stdio</code></p>
</li>
</ul>
<p>This commit is effectively an experiment and an excercise into better<br>
understanding what's going on for each OS resource/type under-the-hood.<br>
It's meant to give us some intuition in order to move on with the idea<br>
of having strongly-typed handles in WASI both in the syscall impl as well<br>
as at the libc level.</p>
<p>Some more minor changes include making <code>OsHandle</code> represent an OS-specific<br>
wrapper for a raw OS handle (Unix fd or Windows handle). Also, since <code>OsDir</code><br>
is tricky across OSes, we also have a supertype of <code>OsHandle</code> called<br>
<code>OsDirHandle</code> which may store a <code>DIR*</code> stream pointer (mainly BSD). Last but not<br>
least, the <code>Filetype</code> and <code>Rights</code> are now computed when the resource is created,<br>
rather than every time we call <code>Handle::get_file_type</code> and <code>Handle::get_rights</code>.<br>
Finally, in order to facilitate the latter, I've converted <code>EntryRights</code> into<br>
<code>HandleRights</code> and pushed them into each <code>Handle</code> implementor.</p>
</blockquote>



<a name="196038178"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196038178" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196038178">(May 02 2020 at 07:17)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404507081" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404507081">PR Review</a>.</p>



<a name="196038179"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196038179" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196038179">(May 02 2020 at 07:17)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418924471" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418924471">PR Review Comment</a>:</p>
<blockquote>
<p>Hmm, I think this should be fine. It will require some additional tweaks to <code>WasiCtxBuilder</code> but nothing major I think.</p>
</blockquote>



<a name="196038244"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196038244" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196038244">(May 02 2020 at 07:18)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404507136" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404507136">PR Review</a>.</p>



<a name="196038245"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196038245" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196038245">(May 02 2020 at 07:18)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418924573" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418924573">PR Review Comment</a>:</p>
<blockquote>
<p>Makes sense!</p>
</blockquote>



<a name="196038250"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196038250" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196038250">(May 02 2020 at 07:18)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404507163" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404507163">PR Review</a>.</p>



<a name="196038251"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196038251" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196038251">(May 02 2020 at 07:18)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418924611" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418924611">PR Review Comment</a>:</p>
<blockquote>
<p>Oh, see my reply to your comment about <code>Stdio</code> :-)</p>
</blockquote>



<a name="196071060"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196071060" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196071060">(May 02 2020 at 21:33)</a>:</h4>
<p>kubkon updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1561" title="https://github.com/bytecodealliance/wasmtime/pull/1561">PR #1561</a> from <code>handle-rights</code> to <code>master</code>:</p>
<blockquote>
<p>This commit does a lot of reshuffling and even some more. It introduces<br>
strongly-typed system primitives which are: <code>OsFile</code>, <code>OsDir</code>, <code>Stdio</code>,<br>
and <code>OsOther</code>. Those primitives are separate structs now, each implementing<br>
a subset of <code>Handle</code> methods, rather than all being an enumeration of some<br>
supertype such as <code>OsHandle</code>. To summarise the structs:</p>
<ul>
<li>
<p><code>OsFile</code> represents a regular file, and implements fd-ops<br>
  of <code>Handle</code> trait</p>
</li>
<li>
<p><code>OsDir</code> represents a directory, and primarily implements path-ops, plus<br>
<code>readdir</code> and some common fd-ops such as <code>fdstat</code>, etc.</p>
</li>
<li>
<p><code>Stdio</code> represents a stdio handle, and implements a subset of fd-ops<br>
  such as <code>fdstat</code> _and_ <code>read_</code> and <code>write_vectored</code> calls</p>
</li>
<li>
<p><code>OsOther</code> currently represents anything else and implements a set similar<br>
  to that implemented by <code>Stdio</code></p>
</li>
</ul>
<p>This commit is effectively an experiment and an excercise into better<br>
understanding what's going on for each OS resource/type under-the-hood.<br>
It's meant to give us some intuition in order to move on with the idea<br>
of having strongly-typed handles in WASI both in the syscall impl as well<br>
as at the libc level.</p>
<p>Some more minor changes include making <code>OsHandle</code> represent an OS-specific<br>
wrapper for a raw OS handle (Unix fd or Windows handle). Also, since <code>OsDir</code><br>
is tricky across OSes, we also have a supertype of <code>OsHandle</code> called<br>
<code>OsDirHandle</code> which may store a <code>DIR*</code> stream pointer (mainly BSD). Last but not<br>
least, the <code>Filetype</code> and <code>Rights</code> are now computed when the resource is created,<br>
rather than every time we call <code>Handle::get_file_type</code> and <code>Handle::get_rights</code>.<br>
Finally, in order to facilitate the latter, I've converted <code>EntryRights</code> into<br>
<code>HandleRights</code> and pushed them into each <code>Handle</code> implementor.</p>
</blockquote>



<a name="196071114"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196071114" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196071114">(May 02 2020 at 21:34)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404562434" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404562434">PR Review</a>.</p>



<a name="196071115"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196071115" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196071115">(May 02 2020 at 21:34)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419010783" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419010783">PR Review Comment</a>:</p>
<blockquote>
<p>OK, I've separated it out into 3 standalone structs: <code>Stdin</code>, <code>Stdout</code> and <code>Stderr</code>.</p>
</blockquote>



<a name="196071122"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196071122" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196071122">(May 02 2020 at 21:34)</a>:</h4>
<p>kubkon edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419010783" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419010783">PR Review Comment</a>.</p>



<a name="196071197"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196071197" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196071197">(May 02 2020 at 21:36)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404562563" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404562563">PR Review</a>.</p>



<a name="196071198"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196071198" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196071198">(May 02 2020 at 21:36)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419011014" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419011014">PR Review Comment</a>:</p>
<blockquote>
<p>In order to clear it up a little bit, I've renamed <code>PendingEntry::File</code> to <code>PendingEntry::OsHandle</code>. This naming was somewhat confusing since the <code>File</code> in this case represented for instance a pipe which we then used in place of a stdio handle. Oh and this is precisely why we use <code>OsOther</code> here instead of an <code>OsFile</code>, since the former is meant to represent pipes as well, whereas the latter only regular files.</p>
</blockquote>



<a name="196145652"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196145652" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196145652">(May 04 2020 at 06:51)</a>:</h4>
<p>kubkon updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1561" title="https://github.com/bytecodealliance/wasmtime/pull/1561">PR #1561</a> from <code>handle-rights</code> to <code>master</code>:</p>
<blockquote>
<p>This commit does a lot of reshuffling and even some more. It introduces<br>
strongly-typed system primitives which are: <code>OsFile</code>, <code>OsDir</code>, <code>Stdio</code>,<br>
and <code>OsOther</code>. Those primitives are separate structs now, each implementing<br>
a subset of <code>Handle</code> methods, rather than all being an enumeration of some<br>
supertype such as <code>OsHandle</code>. To summarise the structs:</p>
<ul>
<li>
<p><code>OsFile</code> represents a regular file, and implements fd-ops<br>
  of <code>Handle</code> trait</p>
</li>
<li>
<p><code>OsDir</code> represents a directory, and primarily implements path-ops, plus<br>
<code>readdir</code> and some common fd-ops such as <code>fdstat</code>, etc.</p>
</li>
<li>
<p><code>Stdio</code> represents a stdio handle, and implements a subset of fd-ops<br>
  such as <code>fdstat</code> _and_ <code>read_</code> and <code>write_vectored</code> calls</p>
</li>
<li>
<p><code>OsOther</code> currently represents anything else and implements a set similar<br>
  to that implemented by <code>Stdio</code></p>
</li>
</ul>
<p>This commit is effectively an experiment and an excercise into better<br>
understanding what's going on for each OS resource/type under-the-hood.<br>
It's meant to give us some intuition in order to move on with the idea<br>
of having strongly-typed handles in WASI both in the syscall impl as well<br>
as at the libc level.</p>
<p>Some more minor changes include making <code>OsHandle</code> represent an OS-specific<br>
wrapper for a raw OS handle (Unix fd or Windows handle). Also, since <code>OsDir</code><br>
is tricky across OSes, we also have a supertype of <code>OsHandle</code> called<br>
<code>OsDirHandle</code> which may store a <code>DIR*</code> stream pointer (mainly BSD). Last but not<br>
least, the <code>Filetype</code> and <code>Rights</code> are now computed when the resource is created,<br>
rather than every time we call <code>Handle::get_file_type</code> and <code>Handle::get_rights</code>.<br>
Finally, in order to facilitate the latter, I've converted <code>EntryRights</code> into<br>
<code>HandleRights</code> and pushed them into each <code>Handle</code> implementor.</p>
</blockquote>



<a name="196145975"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196145975" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196145975">(May 04 2020 at 06:56)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404742344" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404742344">PR Review</a>.</p>



<a name="196145976"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196145976" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196145976">(May 04 2020 at 06:56)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419241485" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419241485">PR Review Comment</a>:</p>
<blockquote>
<p>OK, it's done now. Since, as you rightly pointed out in one of the comments above, we don't really need interior mutability on *nix wrt the inner <code>RawFd</code> instance, I've also replaced <code>RawFd</code> with <code>File</code> instance which takes care of a couple of ownership related things for us. I believe this is what @iximeow was suggesting all along as well. Now that @sunfishcode pointed out that issuing <code>RawOsHandle::update_from</code> call on *nix is a bug, using <code>File</code> was now possible.</p>
</blockquote>



<a name="196147434"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196147434" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196147434">(May 04 2020 at 07:15)</a>:</h4>
<p>kubkon updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1561" title="https://github.com/bytecodealliance/wasmtime/pull/1561">PR #1561</a> from <code>handle-rights</code> to <code>master</code>:</p>
<blockquote>
<p>This commit does a lot of reshuffling and even some more. It introduces<br>
strongly-typed system primitives which are: <code>OsFile</code>, <code>OsDir</code>, <code>Stdio</code>,<br>
and <code>OsOther</code>. Those primitives are separate structs now, each implementing<br>
a subset of <code>Handle</code> methods, rather than all being an enumeration of some<br>
supertype such as <code>OsHandle</code>. To summarise the structs:</p>
<ul>
<li>
<p><code>OsFile</code> represents a regular file, and implements fd-ops<br>
  of <code>Handle</code> trait</p>
</li>
<li>
<p><code>OsDir</code> represents a directory, and primarily implements path-ops, plus<br>
<code>readdir</code> and some common fd-ops such as <code>fdstat</code>, etc.</p>
</li>
<li>
<p><code>Stdio</code> represents a stdio handle, and implements a subset of fd-ops<br>
  such as <code>fdstat</code> _and_ <code>read_</code> and <code>write_vectored</code> calls</p>
</li>
<li>
<p><code>OsOther</code> currently represents anything else and implements a set similar<br>
  to that implemented by <code>Stdio</code></p>
</li>
</ul>
<p>This commit is effectively an experiment and an excercise into better<br>
understanding what's going on for each OS resource/type under-the-hood.<br>
It's meant to give us some intuition in order to move on with the idea<br>
of having strongly-typed handles in WASI both in the syscall impl as well<br>
as at the libc level.</p>
<p>Some more minor changes include making <code>OsHandle</code> represent an OS-specific<br>
wrapper for a raw OS handle (Unix fd or Windows handle). Also, since <code>OsDir</code><br>
is tricky across OSes, we also have a supertype of <code>OsHandle</code> called<br>
<code>OsDirHandle</code> which may store a <code>DIR*</code> stream pointer (mainly BSD). Last but not<br>
least, the <code>Filetype</code> and <code>Rights</code> are now computed when the resource is created,<br>
rather than every time we call <code>Handle::get_file_type</code> and <code>Handle::get_rights</code>.<br>
Finally, in order to facilitate the latter, I've converted <code>EntryRights</code> into<br>
<code>HandleRights</code> and pushed them into each <code>Handle</code> implementor.</p>
</blockquote>



<a name="196147517"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196147517" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196147517">(May 04 2020 at 07:16)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404751476" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404751476">PR Review</a>.</p>



<a name="196147518"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196147518" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196147518">(May 04 2020 at 07:16)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419248601" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419248601">PR Review Comment</a>:</p>
<blockquote>
<p>Done!</p>
</blockquote>



<a name="196235936"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196235936" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196235936">(May 04 2020 at 20:30)</a>:</h4>
<p><strong>kubkon</strong> requested <a href="https://github.com/alexcrichton" title="https://github.com/alexcrichton">alexcrichton</a>, <a href="https://github.com/peterhuene" title="https://github.com/peterhuene">peterhuene</a> and <a href="https://github.com/sunfishcode" title="https://github.com/sunfishcode">sunfishcode</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1561" title="https://github.com/bytecodealliance/wasmtime/pull/1561">PR #1561</a>.</p>



<a name="196239560"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196239560" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196239560">(May 04 2020 at 21:00)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-405343640" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-405343640">PR Review</a>.</p>



<a name="196239561"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196239561" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196239561">(May 04 2020 at 21:00)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419725489" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419725489">PR Review Comment</a>:</p>
<blockquote>
<p>The logic for flushing Rust's stdout buffer is in the <code>Stdout</code> implementation here, and we need that for files too. I expect we're always going to want to use <code>Stdout</code> for stdout, even when it's attached to a file, in order to ensure that we always stay in sync with Rust's stdout.</p>
</blockquote>



<a name="196240266"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196240266" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196240266">(May 04 2020 at 21:07)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-405347964" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-405347964">PR Review</a>.</p>



<a name="196240267"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196240267" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196240267">(May 04 2020 at 21:07)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419729048" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419729048">PR Review Comment</a>:</p>
<blockquote>
<p>Hmm, I'm a little bit confused here. We cannot create a <code>std::io::Stdout</code> instance from a raw file descriptor, so I'm not sure we can ever enforce that we always use <code>sys::stdio::Stdout</code> for stdout. I think we could probably think of extracting <code>PipedStdout</code> or something from <code>OsOther</code> that would have <code>RawFd</code>/<code>RawHandle</code> attached to it.</p>
</blockquote>



<a name="196240863"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196240863" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196240863">(May 04 2020 at 21:13)</a>:</h4>
<p>kubkon edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419729048" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419729048">PR Review Comment</a>.</p>



<a name="196241068"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196241068" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196241068">(May 04 2020 at 21:15)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-405353137" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-405353137">PR Review</a>.</p>



<a name="196241069"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196241069" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196241069">(May 04 2020 at 21:15)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419733289" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419733289">PR Review Comment</a>:</p>
<blockquote>
<p>Oh, wait, I think I get it now. If the OS redirects the stdio handles, Rust's <code>Stdout</code> will use the redirected <code>RawFd</code> underneath, and this one doesn't necessarily have to be a character device. Is that what you meant?</p>
</blockquote>



<a name="196241189"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196241189" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196241189">(May 04 2020 at 21:16)</a>:</h4>
<p>kubkon edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419733289" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419733289">PR Review Comment</a>.</p>



<a name="196243668"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196243668" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196243668">(May 04 2020 at 21:42)</a>:</h4>
<p>kubkon updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1561" title="https://github.com/bytecodealliance/wasmtime/pull/1561">PR #1561</a> from <code>handle-rights</code> to <code>master</code>:</p>
<blockquote>
<p>This commit does a lot of reshuffling and even some more. It introduces<br>
strongly-typed system primitives which are: <code>OsFile</code>, <code>OsDir</code>, <code>Stdio</code>,<br>
and <code>OsOther</code>. Those primitives are separate structs now, each implementing<br>
a subset of <code>Handle</code> methods, rather than all being an enumeration of some<br>
supertype such as <code>OsHandle</code>. To summarise the structs:</p>
<ul>
<li>
<p><code>OsFile</code> represents a regular file, and implements fd-ops<br>
  of <code>Handle</code> trait</p>
</li>
<li>
<p><code>OsDir</code> represents a directory, and primarily implements path-ops, plus<br>
<code>readdir</code> and some common fd-ops such as <code>fdstat</code>, etc.</p>
</li>
<li>
<p><code>Stdio</code> represents a stdio handle, and implements a subset of fd-ops<br>
  such as <code>fdstat</code> _and_ <code>read_</code> and <code>write_vectored</code> calls</p>
</li>
<li>
<p><code>OsOther</code> currently represents anything else and implements a set similar<br>
  to that implemented by <code>Stdio</code></p>
</li>
</ul>
<p>This commit is effectively an experiment and an excercise into better<br>
understanding what's going on for each OS resource/type under-the-hood.<br>
It's meant to give us some intuition in order to move on with the idea<br>
of having strongly-typed handles in WASI both in the syscall impl as well<br>
as at the libc level.</p>
<p>Some more minor changes include making <code>OsHandle</code> represent an OS-specific<br>
wrapper for a raw OS handle (Unix fd or Windows handle). Also, since <code>OsDir</code><br>
is tricky across OSes, we also have a supertype of <code>OsHandle</code> called<br>
<code>OsDirHandle</code> which may store a <code>DIR*</code> stream pointer (mainly BSD). Last but not<br>
least, the <code>Filetype</code> and <code>Rights</code> are now computed when the resource is created,<br>
rather than every time we call <code>Handle::get_file_type</code> and <code>Handle::get_rights</code>.<br>
Finally, in order to facilitate the latter, I've converted <code>EntryRights</code> into<br>
<code>HandleRights</code> and pushed them into each <code>Handle</code> implementor.</p>
</blockquote>



<a name="196243862"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196243862" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196243862">(May 04 2020 at 21:45)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-405370836" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-405370836">PR Review</a>.</p>



<a name="196243863"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196243863" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196243863">(May 04 2020 at 21:45)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419747847" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419747847">PR Review Comment</a>:</p>
<blockquote>
<p>Fixed in 0945267. @sunfishcode if you could have a look and lemme know if that's what you had in mind!</p>
</blockquote>



<a name="196251520"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196251520" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196251520">(May 04 2020 at 23:18)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-405411327" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-405411327">PR Review</a>.</p>



<a name="196251521"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196251521" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196251521">(May 04 2020 at 23:18)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419783680" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419783680">PR Review Comment</a>:</p>
<blockquote>
<p>Yes, that's right.</p>
</blockquote>



<a name="196671679"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196671679" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196671679">(May 06 2020 at 17:46)</a>:</h4>
<p>kubkon updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1561" title="https://github.com/bytecodealliance/wasmtime/pull/1561">PR #1561</a> from <code>handle-rights</code> to <code>master</code>:</p>
<blockquote>
<p>This commit does a lot of reshuffling and even some more. It introduces<br>
strongly-typed system primitives which are: <code>OsFile</code>, <code>OsDir</code>, <code>Stdio</code>,<br>
and <code>OsOther</code>. Those primitives are separate structs now, each implementing<br>
a subset of <code>Handle</code> methods, rather than all being an enumeration of some<br>
supertype such as <code>OsHandle</code>. To summarise the structs:</p>
<ul>
<li>
<p><code>OsFile</code> represents a regular file, and implements fd-ops<br>
  of <code>Handle</code> trait</p>
</li>
<li>
<p><code>OsDir</code> represents a directory, and primarily implements path-ops, plus<br>
<code>readdir</code> and some common fd-ops such as <code>fdstat</code>, etc.</p>
</li>
<li>
<p><code>Stdio</code> represents a stdio handle, and implements a subset of fd-ops<br>
  such as <code>fdstat</code> _and_ <code>read_</code> and <code>write_vectored</code> calls</p>
</li>
<li>
<p><code>OsOther</code> currently represents anything else and implements a set similar<br>
  to that implemented by <code>Stdio</code></p>
</li>
</ul>
<p>This commit is effectively an experiment and an excercise into better<br>
understanding what's going on for each OS resource/type under-the-hood.<br>
It's meant to give us some intuition in order to move on with the idea<br>
of having strongly-typed handles in WASI both in the syscall impl as well<br>
as at the libc level.</p>
<p>Some more minor changes include making <code>OsHandle</code> represent an OS-specific<br>
wrapper for a raw OS handle (Unix fd or Windows handle). Also, since <code>OsDir</code><br>
is tricky across OSes, we also have a supertype of <code>OsHandle</code> called<br>
<code>OsDirHandle</code> which may store a <code>DIR*</code> stream pointer (mainly BSD). Last but not<br>
least, the <code>Filetype</code> and <code>Rights</code> are now computed when the resource is created,<br>
rather than every time we call <code>Handle::get_file_type</code> and <code>Handle::get_rights</code>.<br>
Finally, in order to facilitate the latter, I've converted <code>EntryRights</code> into<br>
<code>HandleRights</code> and pushed them into each <code>Handle</code> implementor.</p>
</blockquote>



<a name="196776129"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196776129" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196776129">(May 07 2020 at 14:13)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-405412568" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-405412568">PR Review</a>.</p>



<a name="196776130"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196776130" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196776130">(May 07 2020 at 14:13)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-405412568" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-405412568">PR Review</a>.</p>



<a name="196776131"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196776131" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196776131">(May 07 2020 at 14:13)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419784821" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419784821">PR Review Comment</a>:</p>
<blockquote>
<p>This <code>expect</code> could fail if the user passes in the wrong kind of handle? That feels like something where should return a <code>Result</code> and forward the error on, rather than panicking.</p>
</blockquote>



<a name="196776134"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196776134" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196776134">(May 07 2020 at 14:13)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419790853" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419790853">PR Review Comment</a>:</p>
<blockquote>
<p>Can you comment on why this <code>as_file</code> method isn't part of the <code>Handle</code> trait? Looking at the implementation below, it's doing a lot of <code>as_any().downcast_ref&lt;Stuff&gt;()</code>, which seems like it would be avoided if you could just call <code>as_file</code> on a <code>Handle</code> directly.</p>
</blockquote>



<a name="196776616"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196776616" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196776616">(May 07 2020 at 14:16)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-407517049" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-407517049">PR Review</a>.</p>



<a name="196776617"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196776617" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196776617">(May 07 2020 at 14:16)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r421539423" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r421539423">PR Review Comment</a>:</p>
<blockquote>
<p>Ah, right! I was meant to do this and somehow forgot. Thanks for pointing this one out!</p>
</blockquote>



<a name="196776857"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196776857" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196776857">(May 07 2020 at 14:18)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-407518597" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-407518597">PR Review</a>.</p>



<a name="196776860"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196776860" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196776860">(May 07 2020 at 14:18)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r421540616" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r421540616">PR Review Comment</a>:</p>
<blockquote>
<p>Hmm, that's an interesting suggestion. So previously, <code>AsFile</code> wasn't part of <code>Handle</code> trait since it wasn't fallible, and hence, it wouldn't make much sense for <code>VirtualFile</code>, etc. But now, given that we return <code>Result</code> I guess we could in principle return <code>Errno::Badf</code> when called by a virtual handle? Or should be outright panic in such a case?</p>
</blockquote>



<a name="196788845"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196788845" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196788845">(May 07 2020 at 15:36)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r421600383" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r421600383">PR Review Comment</a>:</p>
<blockquote>
<p>Oh, right. I wasn't thinking about cases like <code>VirtualHandle</code>. I think it's fine as is then.</p>
</blockquote>



<a name="196788846"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196788846" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196788846">(May 07 2020 at 15:36)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-407595096" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-407595096">PR Review</a>.</p>



<a name="196833805"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196833805" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196833805">(May 07 2020 at 21:41)</a>:</h4>
<p>kubkon updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1561" title="https://github.com/bytecodealliance/wasmtime/pull/1561">PR #1561</a> from <code>handle-rights</code> to <code>master</code>:</p>
<blockquote>
<p>This commit does a lot of reshuffling and even some more. It introduces<br>
strongly-typed system primitives which are: <code>OsFile</code>, <code>OsDir</code>, <code>Stdio</code>,<br>
and <code>OsOther</code>. Those primitives are separate structs now, each implementing<br>
a subset of <code>Handle</code> methods, rather than all being an enumeration of some<br>
supertype such as <code>OsHandle</code>. To summarise the structs:</p>
<ul>
<li>
<p><code>OsFile</code> represents a regular file, and implements fd-ops<br>
  of <code>Handle</code> trait</p>
</li>
<li>
<p><code>OsDir</code> represents a directory, and primarily implements path-ops, plus<br>
<code>readdir</code> and some common fd-ops such as <code>fdstat</code>, etc.</p>
</li>
<li>
<p><code>Stdio</code> represents a stdio handle, and implements a subset of fd-ops<br>
  such as <code>fdstat</code> _and_ <code>read_</code> and <code>write_vectored</code> calls</p>
</li>
<li>
<p><code>OsOther</code> currently represents anything else and implements a set similar<br>
  to that implemented by <code>Stdio</code></p>
</li>
</ul>
<p>This commit is effectively an experiment and an excercise into better<br>
understanding what's going on for each OS resource/type under-the-hood.<br>
It's meant to give us some intuition in order to move on with the idea<br>
of having strongly-typed handles in WASI both in the syscall impl as well<br>
as at the libc level.</p>
<p>Some more minor changes include making <code>OsHandle</code> represent an OS-specific<br>
wrapper for a raw OS handle (Unix fd or Windows handle). Also, since <code>OsDir</code><br>
is tricky across OSes, we also have a supertype of <code>OsHandle</code> called<br>
<code>OsDirHandle</code> which may store a <code>DIR*</code> stream pointer (mainly BSD). Last but not<br>
least, the <code>Filetype</code> and <code>Rights</code> are now computed when the resource is created,<br>
rather than every time we call <code>Handle::get_file_type</code> and <code>Handle::get_rights</code>.<br>
Finally, in order to facilitate the latter, I've converted <code>EntryRights</code> into<br>
<code>HandleRights</code> and pushed them into each <code>Handle</code> implementor.</p>
</blockquote>



<a name="196834380"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196834380" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196834380">(May 07 2020 at 21:46)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-407860230" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-407860230">PR Review</a>.</p>



<a name="196834381"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196834381" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196834381">(May 07 2020 at 21:46)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r421813470" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r421813470">PR Review Comment</a>:</p>
<blockquote>
<p>Fixed in 36f07cf. So in order not to force public API changes, instead of throwing an error directly at the preopen callsite (either <code>preopened_dir</code> or <code>preopened_virt</code>), the creation of the actual instance is now postponed until we build the context object, much like creation of the stdio handles.</p>
</blockquote>



<a name="196834522"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196834522" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196834522">(May 07 2020 at 21:48)</a>:</h4>
<p>kubkon edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r421813470" title="https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r421813470">PR Review Comment</a>.</p>



<a name="196840933"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196840933" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196840933">(May 07 2020 at 23:00)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-407893133" title="https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-407893133">PR Review</a>.</p>



<a name="196840946"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231561%20Introduce%20strongly-typed%20system%20primi.../near/196840946" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231561.20Introduce.20strongly-typed.20system.20primi.2E.2E.2E.html#196840946">(May 07 2020 at 23:00)</a>:</h4>
<p>sunfishcode merged <a href="https://github.com/bytecodealliance/wasmtime/pull/1561" title="https://github.com/bytecodealliance/wasmtime/pull/1561">PR #1561</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>