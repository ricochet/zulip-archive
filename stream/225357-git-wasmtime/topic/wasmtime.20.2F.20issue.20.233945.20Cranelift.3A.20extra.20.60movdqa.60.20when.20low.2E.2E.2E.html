<html>
<head><meta charset="utf-8"><title>wasmtime / issue #3945 Cranelift: extra `movdqa` when low... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233945.20Cranelift.3A.20extra.20.60movdqa.60.20when.20low.2E.2E.2E.html">wasmtime / issue #3945 Cranelift: extra `movdqa` when low...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="275844214"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233945%20Cranelift%3A%20extra%20%60movdqa%60%20when%20low.../near/275844214" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233945.20Cranelift.3A.20extra.20.60movdqa.60.20when.20low.2E.2E.2E.html#275844214">(Mar 18 2022 at 18:28)</a>:</h4>
<p>abrown opened <a href="https://github.com/bytecodealliance/wasmtime/issues/3945">issue #3945</a>:</p>
<blockquote>
<p>#3886 ports CLIF <code>icmp</code> operations to ISLE but in the process added new, unnecessary moves to the lowering:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/e92cbfb28383fdd53b5a48bdd99f4ea48c57fa78/cranelift/filetests/filetests/isa/x64/simd-comparison-legalize.clif#L61-L64">https://github.com/bytecodealliance/wasmtime/blob/e92cbfb28383fdd53b5a48bdd99f4ea48c57fa78/cranelift/filetests/filetests/isa/x64/simd-comparison-legalize.clif#L61-L64</a></p>
<p>The two initial <code>movdqa</code> instructions are not needed with the proper use of registers; my current thinking is that ISLE's move elision may not be working as it should but this could be due to re-ordering of operands in a lowering rule that ISLE cannot resolve.</p>
</blockquote>



<a name="275844312"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233945%20Cranelift%3A%20extra%20%60movdqa%60%20when%20low.../near/275844312" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233945.20Cranelift.3A.20extra.20.60movdqa.60.20when.20low.2E.2E.2E.html#275844312">(Mar 18 2022 at 18:28)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/issues/3945#issuecomment-1072683003">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3945">issue #3945</a>:</p>
<blockquote>
<p>This may be similar to #3744.</p>
</blockquote>



<a name="276392873"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233945%20Cranelift%3A%20extra%20%60movdqa%60%20when%20low.../near/276392873" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233945.20Cranelift.3A.20extra.20.60movdqa.60.20when.20low.2E.2E.2E.html#276392873">(Mar 23 2022 at 20:10)</a>:</h4>
<p>alexcrichton labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/3945">issue #3945</a>:</p>
<blockquote>
<p>#3886 ports CLIF <code>icmp</code> operations to ISLE but in the process added new, unnecessary moves to the lowering:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/e92cbfb28383fdd53b5a48bdd99f4ea48c57fa78/cranelift/filetests/filetests/isa/x64/simd-comparison-legalize.clif#L61-L64">https://github.com/bytecodealliance/wasmtime/blob/e92cbfb28383fdd53b5a48bdd99f4ea48c57fa78/cranelift/filetests/filetests/isa/x64/simd-comparison-legalize.clif#L61-L64</a></p>
<p>The two initial <code>movdqa</code> instructions are not needed with the proper use of registers; my current thinking is that ISLE's move elision may not be working as it should but this could be due to re-ordering of operands in a lowering rule that ISLE cannot resolve.</p>
</blockquote>



<a name="276392874"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233945%20Cranelift%3A%20extra%20%60movdqa%60%20when%20low.../near/276392874" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233945.20Cranelift.3A.20extra.20.60movdqa.60.20when.20low.2E.2E.2E.html#276392874">(Mar 23 2022 at 20:10)</a>:</h4>
<p>alexcrichton labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/3945">issue #3945</a>:</p>
<blockquote>
<p>#3886 ports CLIF <code>icmp</code> operations to ISLE but in the process added new, unnecessary moves to the lowering:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/e92cbfb28383fdd53b5a48bdd99f4ea48c57fa78/cranelift/filetests/filetests/isa/x64/simd-comparison-legalize.clif#L61-L64">https://github.com/bytecodealliance/wasmtime/blob/e92cbfb28383fdd53b5a48bdd99f4ea48c57fa78/cranelift/filetests/filetests/isa/x64/simd-comparison-legalize.clif#L61-L64</a></p>
<p>The two initial <code>movdqa</code> instructions are not needed with the proper use of registers; my current thinking is that ISLE's move elision may not be working as it should but this could be due to re-ordering of operands in a lowering rule that ISLE cannot resolve.</p>
</blockquote>



<a name="276392875"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233945%20Cranelift%3A%20extra%20%60movdqa%60%20when%20low.../near/276392875" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233945.20Cranelift.3A.20extra.20.60movdqa.60.20when.20low.2E.2E.2E.html#276392875">(Mar 23 2022 at 20:10)</a>:</h4>
<p>alexcrichton labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/3945">issue #3945</a>:</p>
<blockquote>
<p>#3886 ports CLIF <code>icmp</code> operations to ISLE but in the process added new, unnecessary moves to the lowering:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/e92cbfb28383fdd53b5a48bdd99f4ea48c57fa78/cranelift/filetests/filetests/isa/x64/simd-comparison-legalize.clif#L61-L64">https://github.com/bytecodealliance/wasmtime/blob/e92cbfb28383fdd53b5a48bdd99f4ea48c57fa78/cranelift/filetests/filetests/isa/x64/simd-comparison-legalize.clif#L61-L64</a></p>
<p>The two initial <code>movdqa</code> instructions are not needed with the proper use of registers; my current thinking is that ISLE's move elision may not be working as it should but this could be due to re-ordering of operands in a lowering rule that ISLE cannot resolve.</p>
</blockquote>



<a name="281032520"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233945%20Cranelift%3A%20extra%20%60movdqa%60%20when%20low.../near/281032520" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233945.20Cranelift.3A.20extra.20.60movdqa.60.20when.20low.2E.2E.2E.html#281032520">(May 03 2022 at 15:43)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/3945#issuecomment-1116247942">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3945">issue #3945</a>:</p>
<blockquote>
<p>With the new regalloc the current test looks like:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/f85047b0842d26b4ac9797356a130c7697ec934c/cranelift/filetests/filetests/isa/x64/simd-comparison-legalize.clif#L47-L49">https://github.com/bytecodealliance/wasmtime/blob/f85047b0842d26b4ac9797356a130c7697ec934c/cranelift/filetests/filetests/isa/x64/simd-comparison-legalize.clif#L47-L49</a></p>
<p>I'm not familiar enough with these instructions to know whether this is fixed though (there's still a single movdqa)</p>
</blockquote>



<a name="281037183"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233945%20Cranelift%3A%20extra%20%60movdqa%60%20when%20low.../near/281037183" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233945.20Cranelift.3A.20extra.20.60movdqa.60.20when.20low.2E.2E.2E.html#281037183">(May 03 2022 at 16:12)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/issues/3945#issuecomment-1116279562">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3945">issue #3945</a>:</p>
<blockquote>
<p>I mean... this just looks wrong: I can never quite remember Cranelift's order of operands when using the x64 backend but our use of <code>%</code> makes this look like AT&amp;T syntax (so destination on the right). <code>%xmm0</code> and <code>%xmm1</code> are probably used for ABI arguments so it looks like we copy <code>%xmm0</code> to <code>%xmm5</code> in order to use the value twice--so far so good. But then the problem: I think what we need to do is to a) find the maximum between <code>%xmm5</code> and <code>%xmm1</code> and put that into <code>%xmm5</code> and b) equality-compare <code>%xmm0</code> and <code>%xmm5</code> and put that into <code>%xmm0</code> for the return. but the last two instructions there don't quite say that! Looks like it should be:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">pmaxsw</span><span class="w"> </span><span class="o">%</span><span class="n">xmm5</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">xmm5</span><span class="w"></span>
<span class="n">pcmpeqw</span><span class="w"> </span><span class="o">%</span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">xmm5</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">xmm0</span><span class="w"></span>
</code></pre></div>
<p>But even this is a bit silly because those SIMD instructions aren't really being used in their three-operand form.</p>
<hr>
<p>@alexcrichton, I think this issue is fixed though <span aria-label="grinning face with smiling eyes" class="emoji emoji-1f601" role="img" title="grinning face with smiling eyes">:grinning_face_with_smiling_eyes:</span>. The extra move is gone but we should resolve this debug output question...</p>
</blockquote>



<a name="281037227"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233945%20Cranelift%3A%20extra%20%60movdqa%60%20when%20low.../near/281037227" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233945.20Cranelift.3A.20extra.20.60movdqa.60.20when.20low.2E.2E.2E.html#281037227">(May 03 2022 at 16:13)</a>:</h4>
<p>abrown edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/3945#issuecomment-1116279562">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3945">issue #3945</a>:</p>
<blockquote>
<p>I mean... this just looks wrong: I can never quite remember Cranelift's order of operands when using the x64 backend but our use of <code>%</code> makes this look like AT&amp;T syntax (i.e., destination on the right). <code>%xmm0</code> and <code>%xmm1</code> are probably used for ABI arguments so it looks like we copy <code>%xmm0</code> to <code>%xmm5</code> in order to use the value twice--so far so good. But then the problem: I think what we need to do is to a) find the maximum between <code>%xmm5</code> and <code>%xmm1</code> and put that into <code>%xmm5</code> and b) equality-compare <code>%xmm0</code> and <code>%xmm5</code> and put that into <code>%xmm0</code> for the return. but the last two instructions there don't quite say that! Looks like it should be:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">pmaxsw</span><span class="w"> </span><span class="o">%</span><span class="n">xmm5</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">xmm5</span><span class="w"></span>
<span class="n">pcmpeqw</span><span class="w"> </span><span class="o">%</span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">xmm5</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">xmm0</span><span class="w"></span>
</code></pre></div>
<p>But even this is a bit silly because those SIMD instructions aren't really being used in their three-operand form.</p>
<hr>
<p>@alexcrichton, I think this issue is fixed though <span aria-label="grinning face with smiling eyes" class="emoji emoji-1f601" role="img" title="grinning face with smiling eyes">:grinning_face_with_smiling_eyes:</span>. The extra move is gone but we should resolve this debug output question...</p>
</blockquote>



<a name="281039174"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233945%20Cranelift%3A%20extra%20%60movdqa%60%20when%20low.../near/281039174" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233945.20Cranelift.3A.20extra.20.60movdqa.60.20when.20low.2E.2E.2E.html#281039174">(May 03 2022 at 16:26)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/3945#issuecomment-1116294304">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3945">issue #3945</a>:</p>
<blockquote>
<p>@abrown the output of <code>clif-util compile</code> on the function is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Disassembly</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="n">bytes</span>:
   <span class="mi">0</span>:   <span class="mi">55</span><span class="w">                      </span><span class="n">push</span><span class="w">    </span><span class="n">rbp</span><span class="w"></span>
<span class="w">   </span><span class="mi">1</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">e5</span><span class="w">                </span><span class="n">mov</span><span class="w">     </span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="n">rsp</span><span class="w"></span>
<span class="w">   </span><span class="mi">4</span>:   <span class="mi">66</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">6</span><span class="n">f</span><span class="w"> </span><span class="n">e8</span><span class="w">             </span><span class="n">movdqa</span><span class="w">  </span><span class="n">xmm5</span><span class="p">,</span><span class="w"> </span><span class="n">xmm0</span><span class="w"></span>
<span class="w">   </span><span class="mi">8</span>:   <span class="mi">66</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="n">ee</span><span class="w"> </span><span class="n">e9</span><span class="w">             </span><span class="n">pmaxsw</span><span class="w">  </span><span class="n">xmm5</span><span class="p">,</span><span class="w"> </span><span class="n">xmm1</span><span class="w"></span>
<span class="w">   </span><span class="n">c</span>:   <span class="mi">66</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">75</span><span class="w"> </span><span class="n">c5</span><span class="w">             </span><span class="n">pcmpeqw</span><span class="w"> </span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="n">xmm5</span><span class="w"></span>
<span class="w">  </span><span class="mi">10</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">ec</span><span class="w">                </span><span class="n">mov</span><span class="w">     </span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="mi">13</span>:   <span class="mi">5</span><span class="n">d</span><span class="w">                      </span><span class="n">pop</span><span class="w">     </span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="mi">14</span>:   <span class="nc">c3</span><span class="w">                      </span><span class="n">ret</span><span class="w"></span>
</code></pre></div>
<p>so this looks right in actuality (result is put in <code>xmm0</code>). I think it's a pretty-printing bug (argument swap) actually -- PR incoming to fix that.</p>
<p>The extra move is indeed elided now, so I think we can close this particular issue.</p>
</blockquote>



<a name="281039207"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233945%20Cranelift%3A%20extra%20%60movdqa%60%20when%20low.../near/281039207" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233945.20Cranelift.3A.20extra.20.60movdqa.60.20when.20low.2E.2E.2E.html#281039207">(May 03 2022 at 16:26)</a>:</h4>
<p>cfallin closed <a href="https://github.com/bytecodealliance/wasmtime/issues/3945">issue #3945</a>:</p>
<blockquote>
<p>#3886 ports CLIF <code>icmp</code> operations to ISLE but in the process added new, unnecessary moves to the lowering:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/e92cbfb28383fdd53b5a48bdd99f4ea48c57fa78/cranelift/filetests/filetests/isa/x64/simd-comparison-legalize.clif#L61-L64">https://github.com/bytecodealliance/wasmtime/blob/e92cbfb28383fdd53b5a48bdd99f4ea48c57fa78/cranelift/filetests/filetests/isa/x64/simd-comparison-legalize.clif#L61-L64</a></p>
<p>The two initial <code>movdqa</code> instructions are not needed with the proper use of registers; my current thinking is that ISLE's move elision may not be working as it should but this could be due to re-ordering of operands in a lowering rule that ISLE cannot resolve.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>