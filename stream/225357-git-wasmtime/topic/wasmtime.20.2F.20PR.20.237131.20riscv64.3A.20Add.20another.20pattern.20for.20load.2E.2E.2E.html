<html>
<head><meta charset="utf-8"><title>wasmtime / PR #7131 riscv64: Add another pattern for load... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237131.20riscv64.3A.20Add.20another.20pattern.20for.20load.2E.2E.2E.html">wasmtime / PR #7131 riscv64: Add another pattern for load...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="394507367"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237131%20riscv64%3A%20Add%20another%20pattern%20for%20load.../near/394507367" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237131.20riscv64.3A.20Add.20another.20pattern.20for.20load.2E.2E.2E.html#394507367">(Oct 02 2023 at 20:23)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/7131">PR #7131</a> from <code>alexcrichton:rv64-more-constants</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Currently any 32-bit constant can be materialized without a load from a constant pool on RISCV-64 but once constants start getting larger than this they're always loaded from the constant pool. This commit adds another special case for loading constants which appears to match what LLVM does which is to consider materializing a smaller constant and than shifting it left.</p>
<p>This is done by chopping off all trailing zeros from an immediate and then testing if the immediate can be materialized as a 32-bit constant. This means that the current constant loading sequence can optionally be followed by a trailing <code>slli</code> instruction to shift the zeros back into the constant. This namely means that loading <code>i64::MIN</code> (1 &lt;&lt; 63) no longer falls back to the constant pool.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="394507370"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237131%20riscv64%3A%20Add%20another%20pattern%20for%20load.../near/394507370" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237131.20riscv64.3A.20Add.20another.20pattern.20for.20load.2E.2E.2E.html#394507370">(Oct 02 2023 at 20:23)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/elliottt">elliottt</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7131">PR #7131</a>.</p>



<a name="394507371"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237131%20riscv64%3A%20Add%20another%20pattern%20for%20load.../near/394507371" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237131.20riscv64.3A.20Add.20another.20pattern.20for.20load.2E.2E.2E.html#394507371">(Oct 02 2023 at 20:23)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7131">PR #7131</a>.</p>



<a name="394507374"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237131%20riscv64%3A%20Add%20another%20pattern%20for%20load.../near/394507374" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237131.20riscv64.3A.20Add.20another.20pattern.20for.20load.2E.2E.2E.html#394507374">(Oct 02 2023 at 20:23)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/afonso360">afonso360</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7131">PR #7131</a>.</p>



<a name="394518472"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237131%20riscv64%3A%20Add%20another%20pattern%20for%20load.../near/394518472" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237131.20riscv64.3A.20Add.20another.20pattern.20for.20load.2E.2E.2E.html#394518472">(Oct 02 2023 at 21:54)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7131#pullrequestreview-1653573818">PR review</a>:</p>
<blockquote>
<p>LGTM! <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
</blockquote>



<a name="394523486"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237131%20riscv64%3A%20Add%20another%20pattern%20for%20load.../near/394523486" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237131.20riscv64.3A.20Add.20another.20pattern.20for.20load.2E.2E.2E.html#394523486">(Oct 02 2023 at 22:45)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7131">PR #7131</a>.</p>



<a name="394523494"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237131%20riscv64%3A%20Add%20another%20pattern%20for%20load.../near/394523494" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237131.20riscv64.3A.20Add.20another.20pattern.20for.20load.2E.2E.2E.html#394523494">(Oct 02 2023 at 22:45)</a>:</h4>
<p>alexcrichton has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/7131">PR #7131</a>.</p>



<a name="394530756"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237131%20riscv64%3A%20Add%20another%20pattern%20for%20load.../near/394530756" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237131.20riscv64.3A.20Add.20another.20pattern.20for.20load.2E.2E.2E.html#394530756">(Oct 03 2023 at 00:10)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/7131">PR #7131</a>.</p>



<a name="394600258"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237131%20riscv64%3A%20Add%20another%20pattern%20for%20load.../near/394600258" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237131.20riscv64.3A.20Add.20another.20pattern.20for.20load.2E.2E.2E.html#394600258">(Oct 03 2023 at 10:06)</a>:</h4>
<p>a1phyr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7131#pullrequestreview-1654832470">PR review</a>.</p>



<a name="394600269"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237131%20riscv64%3A%20Add%20another%20pattern%20for%20load.../near/394600269" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237131.20riscv64.3A.20Add.20another.20pattern.20for.20load.2E.2E.2E.html#394600269">(Oct 03 2023 at 10:06)</a>:</h4>
<p>a1phyr created <a href="https://github.com/bytecodealliance/wasmtime/pull/7131#discussion_r1343850674">PR review comment</a>:</p>
<blockquote>
<p><code>lui</code> accepts 20 bits immediates so this could probably be optimized further:</p>
<p><div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="w">   </span><span class="nf">lui</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="mi">0xffff</span>
<span class="w">   </span><span class="nf">slli</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="mi">0x14</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="394604541"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237131%20riscv64%3A%20Add%20another%20pattern%20for%20load.../near/394604541" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237131.20riscv64.3A.20Add.20another.20pattern.20for.20load.2E.2E.2E.html#394604541">(Oct 03 2023 at 10:28)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/7131#discussion_r1343878227">PR review comment</a>:</p>
<blockquote>
<p>Oh right, that's a good catch! Since we always test materializing the immediate at position 0, there could be another shift amount that would produce a better immediate generation sequence.</p>
<p>I wonder how we could better match these other cases.</p>
</blockquote>



<a name="394604542"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237131%20riscv64%3A%20Add%20another%20pattern%20for%20load.../near/394604542" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237131.20riscv64.3A.20Add.20another.20pattern.20for.20load.2E.2E.2E.html#394604542">(Oct 03 2023 at 10:28)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7131#pullrequestreview-1654872757">PR review</a>.</p>



<a name="394650530"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237131%20riscv64%3A%20Add%20another%20pattern%20for%20load.../near/394650530" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237131.20riscv64.3A.20Add.20another.20pattern.20for.20load.2E.2E.2E.html#394650530">(Oct 03 2023 at 14:43)</a>:</h4>
<p>a1phyr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7131#pullrequestreview-1655410531">PR review</a>.</p>



<a name="394650531"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237131%20riscv64%3A%20Add%20another%20pattern%20for%20load.../near/394650531" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237131.20riscv64.3A.20Add.20another.20pattern.20for.20load.2E.2E.2E.html#394650531">(Oct 03 2023 at 14:43)</a>:</h4>
<p>a1phyr created <a href="https://github.com/bytecodealliance/wasmtime/pull/7131#discussion_r1344239349">PR review comment</a>:</p>
<blockquote>
<p>Opened #7139</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>