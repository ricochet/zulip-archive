<html>
<head><meta charset="utf-8"><title>wasmtime / issue #3327 x64: Incorrect codegen for f32x4.a... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233327.20x64.3A.20Incorrect.20codegen.20for.20f32x4.2Ea.2E.2E.2E.html">wasmtime / issue #3327 x64: Incorrect codegen for f32x4.a...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="252885177"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233327%20x64%3A%20Incorrect%20codegen%20for%20f32x4.a.../near/252885177" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233327.20x64.3A.20Incorrect.20codegen.20for.20f32x4.2Ea.2E.2E.2E.html#252885177">(Sep 11 2021 at 05:50)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/issues/3327">issue #3327</a>:</p>
<blockquote>
<p>Found via fuzzing this module:</p>
<div class="codehilite" data-code-language="wasm"><pre><span></span><code>(module
  (func (result v128)
    v128.const f32x4 0 0 0 0
    f32x4.abs
    v128.not)
  (export "1" (func 0))
)
</code></pre></div>
<p>yields:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">testcase0</span><span class="p">.</span><span class="n">wat</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">simd</span><span class="w"></span>
<span class="n">warning</span>: <span class="nc">using</span><span class="w"> </span><span class="err">`</span><span class="o">--</span><span class="n">invoke</span><span class="err">`</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">returns</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">experimental</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">future</span><span class="w"></span>
<span class="mi">0</span><span class="w"></span>
</code></pre></div>
<p>when it should print <code>u128::MAX</code>.</p>
<p>The disassembly of this function is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">0000000000000000</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_wasm_function_0</span><span class="o">&gt;</span>:
       <span class="mi">0</span>:       <span class="mi">55</span><span class="w">                      </span><span class="n">push</span><span class="w">   </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">       </span><span class="mi">1</span>:       <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">e5</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">       </span><span class="mi">4</span>:       <span class="nc">f3</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">6</span><span class="n">f</span><span class="w"> </span><span class="mi">05</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="n">movdqu</span><span class="w"> </span><span class="mh">0x24</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">),</span><span class="o">%</span><span class="n">xmm0</span><span class="w">        </span>#<span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_wasm_function_0</span><span class="o">+</span><span class="mh">0x30</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">       </span><span class="n">b</span>:       <span class="mi">00</span><span class="w"></span>
<span class="w">       </span><span class="n">c</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">57</span><span class="w"> </span><span class="n">c9</span><span class="w">                </span><span class="n">xorps</span><span class="w">  </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">       </span><span class="n">f</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="n">c9</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">cmpeqps</span><span class="w"> </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">      </span><span class="mi">13</span>:       <span class="mi">66</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">72</span><span class="w"> </span><span class="n">d1</span><span class="w"> </span><span class="mi">01</span><span class="w">          </span><span class="n">psrld</span><span class="w">  </span><span class="cp">$</span><span class="mh">0x1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">      </span><span class="mi">18</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">54</span><span class="w"> </span><span class="n">c1</span><span class="w">                </span><span class="n">andps</span><span class="w">  </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm0</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="n">b</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="n">c9</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">cmpeqps</span><span class="w"> </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="n">f</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">57</span><span class="w"> </span><span class="n">c1</span><span class="w">                </span><span class="n">xorps</span><span class="w">  </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm0</span><span class="w"></span>
<span class="w">      </span><span class="mi">22</span>:       <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">ec</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="p">,</span><span class="o">%</span><span class="n">rsp</span><span class="w"></span>
<span class="w">      </span><span class="mi">25</span>:       <span class="mi">5</span><span class="n">d</span><span class="w">                      </span><span class="n">pop</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">      </span><span class="mi">26</span>:       <span class="nc">c3</span><span class="w">                      </span><span class="n">retq</span><span class="w"></span>
</code></pre></div>
<p>I don't for sure know what's going on here with each individual instruction, but this sort of looks like a register allocator issue? I'm not sure what the second <code>xorps</code> is doing there with those registers. If this is a register allocator thing it may or may not be related to <a href="https://github.com/bytecodealliance/wasmtime/issues/3216">https://github.com/bytecodealliance/wasmtime/issues/3216</a></p>
</blockquote>



<a name="252885178"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233327%20x64%3A%20Incorrect%20codegen%20for%20f32x4.a.../near/252885178" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233327.20x64.3A.20Incorrect.20codegen.20for.20f32x4.2Ea.2E.2E.2E.html#252885178">(Sep 11 2021 at 05:50)</a>:</h4>
<p>alexcrichton labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/3327">issue #3327</a>:</p>
<blockquote>
<p>Found via fuzzing this module:</p>
<div class="codehilite" data-code-language="wasm"><pre><span></span><code>(module
  (func (result v128)
    v128.const f32x4 0 0 0 0
    f32x4.abs
    v128.not)
  (export "1" (func 0))
)
</code></pre></div>
<p>yields:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">testcase0</span><span class="p">.</span><span class="n">wat</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">simd</span><span class="w"></span>
<span class="n">warning</span>: <span class="nc">using</span><span class="w"> </span><span class="err">`</span><span class="o">--</span><span class="n">invoke</span><span class="err">`</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">returns</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">experimental</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">future</span><span class="w"></span>
<span class="mi">0</span><span class="w"></span>
</code></pre></div>
<p>when it should print <code>u128::MAX</code>.</p>
<p>The disassembly of this function is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">0000000000000000</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_wasm_function_0</span><span class="o">&gt;</span>:
       <span class="mi">0</span>:       <span class="mi">55</span><span class="w">                      </span><span class="n">push</span><span class="w">   </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">       </span><span class="mi">1</span>:       <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">e5</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">       </span><span class="mi">4</span>:       <span class="nc">f3</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">6</span><span class="n">f</span><span class="w"> </span><span class="mi">05</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="n">movdqu</span><span class="w"> </span><span class="mh">0x24</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">),</span><span class="o">%</span><span class="n">xmm0</span><span class="w">        </span>#<span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_wasm_function_0</span><span class="o">+</span><span class="mh">0x30</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">       </span><span class="n">b</span>:       <span class="mi">00</span><span class="w"></span>
<span class="w">       </span><span class="n">c</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">57</span><span class="w"> </span><span class="n">c9</span><span class="w">                </span><span class="n">xorps</span><span class="w">  </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">       </span><span class="n">f</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="n">c9</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">cmpeqps</span><span class="w"> </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">      </span><span class="mi">13</span>:       <span class="mi">66</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">72</span><span class="w"> </span><span class="n">d1</span><span class="w"> </span><span class="mi">01</span><span class="w">          </span><span class="n">psrld</span><span class="w">  </span><span class="cp">$</span><span class="mh">0x1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">      </span><span class="mi">18</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">54</span><span class="w"> </span><span class="n">c1</span><span class="w">                </span><span class="n">andps</span><span class="w">  </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm0</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="n">b</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="n">c9</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">cmpeqps</span><span class="w"> </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="n">f</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">57</span><span class="w"> </span><span class="n">c1</span><span class="w">                </span><span class="n">xorps</span><span class="w">  </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm0</span><span class="w"></span>
<span class="w">      </span><span class="mi">22</span>:       <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">ec</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="p">,</span><span class="o">%</span><span class="n">rsp</span><span class="w"></span>
<span class="w">      </span><span class="mi">25</span>:       <span class="mi">5</span><span class="n">d</span><span class="w">                      </span><span class="n">pop</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">      </span><span class="mi">26</span>:       <span class="nc">c3</span><span class="w">                      </span><span class="n">retq</span><span class="w"></span>
</code></pre></div>
<p>I don't for sure know what's going on here with each individual instruction, but this sort of looks like a register allocator issue? I'm not sure what the second <code>xorps</code> is doing there with those registers. If this is a register allocator thing it may or may not be related to <a href="https://github.com/bytecodealliance/wasmtime/issues/3216">https://github.com/bytecodealliance/wasmtime/issues/3216</a></p>
</blockquote>



<a name="252885179"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233327%20x64%3A%20Incorrect%20codegen%20for%20f32x4.a.../near/252885179" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233327.20x64.3A.20Incorrect.20codegen.20for.20f32x4.2Ea.2E.2E.2E.html#252885179">(Sep 11 2021 at 05:50)</a>:</h4>
<p>alexcrichton labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/3327">issue #3327</a>:</p>
<blockquote>
<p>Found via fuzzing this module:</p>
<div class="codehilite" data-code-language="wasm"><pre><span></span><code>(module
  (func (result v128)
    v128.const f32x4 0 0 0 0
    f32x4.abs
    v128.not)
  (export "1" (func 0))
)
</code></pre></div>
<p>yields:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">testcase0</span><span class="p">.</span><span class="n">wat</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">simd</span><span class="w"></span>
<span class="n">warning</span>: <span class="nc">using</span><span class="w"> </span><span class="err">`</span><span class="o">--</span><span class="n">invoke</span><span class="err">`</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">returns</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">experimental</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">future</span><span class="w"></span>
<span class="mi">0</span><span class="w"></span>
</code></pre></div>
<p>when it should print <code>u128::MAX</code>.</p>
<p>The disassembly of this function is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">0000000000000000</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_wasm_function_0</span><span class="o">&gt;</span>:
       <span class="mi">0</span>:       <span class="mi">55</span><span class="w">                      </span><span class="n">push</span><span class="w">   </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">       </span><span class="mi">1</span>:       <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">e5</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">       </span><span class="mi">4</span>:       <span class="nc">f3</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">6</span><span class="n">f</span><span class="w"> </span><span class="mi">05</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="n">movdqu</span><span class="w"> </span><span class="mh">0x24</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">),</span><span class="o">%</span><span class="n">xmm0</span><span class="w">        </span>#<span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_wasm_function_0</span><span class="o">+</span><span class="mh">0x30</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">       </span><span class="n">b</span>:       <span class="mi">00</span><span class="w"></span>
<span class="w">       </span><span class="n">c</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">57</span><span class="w"> </span><span class="n">c9</span><span class="w">                </span><span class="n">xorps</span><span class="w">  </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">       </span><span class="n">f</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="n">c9</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">cmpeqps</span><span class="w"> </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">      </span><span class="mi">13</span>:       <span class="mi">66</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">72</span><span class="w"> </span><span class="n">d1</span><span class="w"> </span><span class="mi">01</span><span class="w">          </span><span class="n">psrld</span><span class="w">  </span><span class="cp">$</span><span class="mh">0x1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">      </span><span class="mi">18</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">54</span><span class="w"> </span><span class="n">c1</span><span class="w">                </span><span class="n">andps</span><span class="w">  </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm0</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="n">b</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="n">c9</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">cmpeqps</span><span class="w"> </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="n">f</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">57</span><span class="w"> </span><span class="n">c1</span><span class="w">                </span><span class="n">xorps</span><span class="w">  </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm0</span><span class="w"></span>
<span class="w">      </span><span class="mi">22</span>:       <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">ec</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="p">,</span><span class="o">%</span><span class="n">rsp</span><span class="w"></span>
<span class="w">      </span><span class="mi">25</span>:       <span class="mi">5</span><span class="n">d</span><span class="w">                      </span><span class="n">pop</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">      </span><span class="mi">26</span>:       <span class="nc">c3</span><span class="w">                      </span><span class="n">retq</span><span class="w"></span>
</code></pre></div>
<p>I don't for sure know what's going on here with each individual instruction, but this sort of looks like a register allocator issue? I'm not sure what the second <code>xorps</code> is doing there with those registers. If this is a register allocator thing it may or may not be related to <a href="https://github.com/bytecodealliance/wasmtime/issues/3216">https://github.com/bytecodealliance/wasmtime/issues/3216</a></p>
</blockquote>



<a name="252885180"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233327%20x64%3A%20Incorrect%20codegen%20for%20f32x4.a.../near/252885180" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233327.20x64.3A.20Incorrect.20codegen.20for.20f32x4.2Ea.2E.2E.2E.html#252885180">(Sep 11 2021 at 05:50)</a>:</h4>
<p>alexcrichton labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/3327">issue #3327</a>:</p>
<blockquote>
<p>Found via fuzzing this module:</p>
<div class="codehilite" data-code-language="wasm"><pre><span></span><code>(module
  (func (result v128)
    v128.const f32x4 0 0 0 0
    f32x4.abs
    v128.not)
  (export "1" (func 0))
)
</code></pre></div>
<p>yields:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">testcase0</span><span class="p">.</span><span class="n">wat</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">simd</span><span class="w"></span>
<span class="n">warning</span>: <span class="nc">using</span><span class="w"> </span><span class="err">`</span><span class="o">--</span><span class="n">invoke</span><span class="err">`</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">returns</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">experimental</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">future</span><span class="w"></span>
<span class="mi">0</span><span class="w"></span>
</code></pre></div>
<p>when it should print <code>u128::MAX</code>.</p>
<p>The disassembly of this function is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">0000000000000000</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_wasm_function_0</span><span class="o">&gt;</span>:
       <span class="mi">0</span>:       <span class="mi">55</span><span class="w">                      </span><span class="n">push</span><span class="w">   </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">       </span><span class="mi">1</span>:       <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">e5</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">       </span><span class="mi">4</span>:       <span class="nc">f3</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">6</span><span class="n">f</span><span class="w"> </span><span class="mi">05</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="n">movdqu</span><span class="w"> </span><span class="mh">0x24</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">),</span><span class="o">%</span><span class="n">xmm0</span><span class="w">        </span>#<span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_wasm_function_0</span><span class="o">+</span><span class="mh">0x30</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">       </span><span class="n">b</span>:       <span class="mi">00</span><span class="w"></span>
<span class="w">       </span><span class="n">c</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">57</span><span class="w"> </span><span class="n">c9</span><span class="w">                </span><span class="n">xorps</span><span class="w">  </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">       </span><span class="n">f</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="n">c9</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">cmpeqps</span><span class="w"> </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">      </span><span class="mi">13</span>:       <span class="mi">66</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">72</span><span class="w"> </span><span class="n">d1</span><span class="w"> </span><span class="mi">01</span><span class="w">          </span><span class="n">psrld</span><span class="w">  </span><span class="cp">$</span><span class="mh">0x1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">      </span><span class="mi">18</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">54</span><span class="w"> </span><span class="n">c1</span><span class="w">                </span><span class="n">andps</span><span class="w">  </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm0</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="n">b</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="n">c9</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">cmpeqps</span><span class="w"> </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="n">f</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">57</span><span class="w"> </span><span class="n">c1</span><span class="w">                </span><span class="n">xorps</span><span class="w">  </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm0</span><span class="w"></span>
<span class="w">      </span><span class="mi">22</span>:       <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">ec</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="p">,</span><span class="o">%</span><span class="n">rsp</span><span class="w"></span>
<span class="w">      </span><span class="mi">25</span>:       <span class="mi">5</span><span class="n">d</span><span class="w">                      </span><span class="n">pop</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">      </span><span class="mi">26</span>:       <span class="nc">c3</span><span class="w">                      </span><span class="n">retq</span><span class="w"></span>
</code></pre></div>
<p>I don't for sure know what's going on here with each individual instruction, but this sort of looks like a register allocator issue? I'm not sure what the second <code>xorps</code> is doing there with those registers. If this is a register allocator thing it may or may not be related to <a href="https://github.com/bytecodealliance/wasmtime/issues/3216">https://github.com/bytecodealliance/wasmtime/issues/3216</a></p>
</blockquote>



<a name="252885181"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233327%20x64%3A%20Incorrect%20codegen%20for%20f32x4.a.../near/252885181" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233327.20x64.3A.20Incorrect.20codegen.20for.20f32x4.2Ea.2E.2E.2E.html#252885181">(Sep 11 2021 at 05:50)</a>:</h4>
<p>alexcrichton labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/3327">issue #3327</a>:</p>
<blockquote>
<p>Found via fuzzing this module:</p>
<div class="codehilite" data-code-language="wasm"><pre><span></span><code>(module
  (func (result v128)
    v128.const f32x4 0 0 0 0
    f32x4.abs
    v128.not)
  (export "1" (func 0))
)
</code></pre></div>
<p>yields:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">testcase0</span><span class="p">.</span><span class="n">wat</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">simd</span><span class="w"></span>
<span class="n">warning</span>: <span class="nc">using</span><span class="w"> </span><span class="err">`</span><span class="o">--</span><span class="n">invoke</span><span class="err">`</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">returns</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">experimental</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">future</span><span class="w"></span>
<span class="mi">0</span><span class="w"></span>
</code></pre></div>
<p>when it should print <code>u128::MAX</code>.</p>
<p>The disassembly of this function is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">0000000000000000</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_wasm_function_0</span><span class="o">&gt;</span>:
       <span class="mi">0</span>:       <span class="mi">55</span><span class="w">                      </span><span class="n">push</span><span class="w">   </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">       </span><span class="mi">1</span>:       <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">e5</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">       </span><span class="mi">4</span>:       <span class="nc">f3</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">6</span><span class="n">f</span><span class="w"> </span><span class="mi">05</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="n">movdqu</span><span class="w"> </span><span class="mh">0x24</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">),</span><span class="o">%</span><span class="n">xmm0</span><span class="w">        </span>#<span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_wasm_function_0</span><span class="o">+</span><span class="mh">0x30</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">       </span><span class="n">b</span>:       <span class="mi">00</span><span class="w"></span>
<span class="w">       </span><span class="n">c</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">57</span><span class="w"> </span><span class="n">c9</span><span class="w">                </span><span class="n">xorps</span><span class="w">  </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">       </span><span class="n">f</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="n">c9</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">cmpeqps</span><span class="w"> </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">      </span><span class="mi">13</span>:       <span class="mi">66</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">72</span><span class="w"> </span><span class="n">d1</span><span class="w"> </span><span class="mi">01</span><span class="w">          </span><span class="n">psrld</span><span class="w">  </span><span class="cp">$</span><span class="mh">0x1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">      </span><span class="mi">18</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">54</span><span class="w"> </span><span class="n">c1</span><span class="w">                </span><span class="n">andps</span><span class="w">  </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm0</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="n">b</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="n">c9</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">cmpeqps</span><span class="w"> </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="n">f</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">57</span><span class="w"> </span><span class="n">c1</span><span class="w">                </span><span class="n">xorps</span><span class="w">  </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm0</span><span class="w"></span>
<span class="w">      </span><span class="mi">22</span>:       <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">ec</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="p">,</span><span class="o">%</span><span class="n">rsp</span><span class="w"></span>
<span class="w">      </span><span class="mi">25</span>:       <span class="mi">5</span><span class="n">d</span><span class="w">                      </span><span class="n">pop</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">      </span><span class="mi">26</span>:       <span class="nc">c3</span><span class="w">                      </span><span class="n">retq</span><span class="w"></span>
</code></pre></div>
<p>I don't for sure know what's going on here with each individual instruction, but this sort of looks like a register allocator issue? I'm not sure what the second <code>xorps</code> is doing there with those registers. If this is a register allocator thing it may or may not be related to <a href="https://github.com/bytecodealliance/wasmtime/issues/3216">https://github.com/bytecodealliance/wasmtime/issues/3216</a></p>
</blockquote>



<a name="252945318"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233327%20x64%3A%20Incorrect%20codegen%20for%20f32x4.a.../near/252945318" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233327.20x64.3A.20Incorrect.20codegen.20for.20f32x4.2Ea.2E.2E.2E.html#252945318">(Sep 12 2021 at 00:19)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/3327#issuecomment-917509720">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3327">issue #3327</a>:</p>
<blockquote>
<p>This is another module which I believe is broken:</p>
<div class="codehilite" data-code-language="wasm"><pre><span></span><code>(module
  (func (;0;) (result i32)
    v128.const i32x4 0xffffffff 0x80bfffff 0x80bf0a0a 0x80bf0a0a
    f64x2.promote_low_f32x4
    v128.not
    v128.not
    v128.not
    v128.not
    v128.not
    v128.not
    v128.not
    v128.const i32x4 0 0 0 0
    f64x2.gt
    v128.not
    i64x2.bitmask)
  (export "" (func 0)))
</code></pre></div>
<p>It still has <code>v128.not</code> but I don't know if it's the same bug, I'm just assuming it's related. This is fuzz-generated and v8 claims the function should produce 0 but Wasmtime produces 3 as the answer.</p>
</blockquote>



<a name="253120684"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233327%20x64%3A%20Incorrect%20codegen%20for%20f32x4.a.../near/253120684" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233327.20x64.3A.20Incorrect.20codegen.20for.20f32x4.2Ea.2E.2E.2E.html#253120684">(Sep 13 2021 at 16:37)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/3327#issuecomment-918371942">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3327">issue #3327</a>:</p>
<blockquote>
<p>cc @jlb6740, could you take a look?</p>
</blockquote>



<a name="253746266"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233327%20x64%3A%20Incorrect%20codegen%20for%20f32x4.a.../near/253746266" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233327.20x64.3A.20Incorrect.20codegen.20for.20f32x4.2Ea.2E.2E.2E.html#253746266">(Sep 17 2021 at 13:59)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/3327#issuecomment-921819967">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3327">issue #3327</a>:</p>
<blockquote>
<p>Another one cropped up today which I'm lumping in with this one, but recording to ensure we can test the fix:</p>
<p><div class="codehilite" data-code-language="wasm"><pre><span></span><code>(module
  (type (;0;) (func (param i32) (result i32)))
  (func (;0;) (type 0) (param i32) (result i32)
    local.get 0
    i32x4.splat
    f64x2.abs
    v128.not
    i64x2.bitmask)
  (memory (;0;) 1 1)
  (export "" (func 0))
  (export "1" (func 0)))
</code></pre></div><br>
</p>
</blockquote>



<a name="260462138"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233327%20x64%3A%20Incorrect%20codegen%20for%20f32x4.a.../near/260462138" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233327.20x64.3A.20Incorrect.20codegen.20for.20f32x4.2Ea.2E.2E.2E.html#260462138">(Nov 05 2021 at 20:43)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/3327#issuecomment-962208422">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3327">issue #3327</a>:</p>
<blockquote>
<p>I've got a <a href="https://github.com/alexcrichton/wasmtime/commit/f7ccaf2395b4fed071e97eaf6c9d490e42638a65">fix for this</a> when ISLE lands</p>
</blockquote>



<a name="261200432"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233327%20x64%3A%20Incorrect%20codegen%20for%20f32x4.a.../near/261200432" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233327.20x64.3A.20Incorrect.20codegen.20for.20f32x4.2Ea.2E.2E.2E.html#261200432">(Nov 12 2021 at 00:42)</a>:</h4>
<p>jlb6740 <a href="https://github.com/bytecodealliance/wasmtime/issues/3327#issuecomment-966726819">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3327">issue #3327</a>:</p>
<blockquote>
<p>@alexcrichton I think I see the issue here. The abs lowering:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">xorps</span><span class="w">   </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="n">xmm1</span><span class="w"></span>
<span class="n">cmpeqps</span><span class="w"> </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="n">xmm1</span><span class="w"></span>
<span class="n">psrld</span><span class="w">   </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="n">andps</span><span class="w">   </span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="n">xmm1</span><span class="w"></span>
</code></pre></div>
<p>leaves xmm1 with:<br>
<code>2147483647</code><br>
But this number (the largest 32-bit int) is not a float. The not instruction sequence:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="s">"cmpeqps %%xmm1, %%xmm1</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
<span class="s">"xorps %%xmm1, %%xmm0</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
</code></pre></div>
<p>Takes a register (in this case xmm1) and then tries to make it have the float value 1. It does this in order to do then do an xorps to flip the bits. The problem is that the abs sequence has left the register xmm1 with a number that cmpeqps returns an unexpected result. If we do this on another register that just so happens to have a valid float value then this sequence would work, but in our case it doesn't. The fix seems to be to do a logical xor on the float register before doing the cmpeqps. This logical or correctly zeros the register allowing the cmpeqps to work as expected. Maybe a better sequence but will push this to fix this bug. </p>
</blockquote>



<a name="261200474"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233327%20x64%3A%20Incorrect%20codegen%20for%20f32x4.a.../near/261200474" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233327.20x64.3A.20Incorrect.20codegen.20for.20f32x4.2Ea.2E.2E.2E.html#261200474">(Nov 12 2021 at 00:43)</a>:</h4>
<p>jlb6740 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/3327#issuecomment-966726819">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3327">issue #3327</a>:</p>
<blockquote>
<p>@alexcrichton I think I see the issue here. The abs lowering:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">xorps</span><span class="w">   </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="n">xmm1</span><span class="w"></span>
<span class="n">cmpeqps</span><span class="w"> </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="n">xmm1</span><span class="w"></span>
<span class="n">psrld</span><span class="w">   </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="n">andps</span><span class="w">   </span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="n">xmm1</span><span class="w"></span>
</code></pre></div>
<p>leaves xmm1 with:<br>
<code>2147483647</code><br>
But this number (the largest 32-bit int) is not a float. The not instruction sequence:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="s">"cmpeqps %%xmm1, %%xmm1</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
<span class="s">"xorps %%xmm1, %%xmm0</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
</code></pre></div>
<p>Takes a register (in this case xmm1) and then tries to make it have the float value 1. It does this in order to do then do an xorps to flip the bits. The problem is that the abs sequence has left the register xmm1 with a number that cmpeqps returns an unexpected result. If we do this on another register that just so happens to have a valid float value then this sequence would work, but in our case it doesn't. The fix seems to be to do a logical xor on the float register before doing the cmpeqps. This logical or correctly zeros the register allowing the cmpeqps to work as expected. Maybe a better sequence but will push this lowering for not:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="s">"xorps %%xmm1, %%xmm1</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
<span class="s">"cmpeqps %%xmm1, %%xmm1</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
<span class="s">"xorps %%xmm1, %%xmm0</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
</code></pre></div>
<p>to resolve this bug. </p>
</blockquote>



<a name="261200684"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233327%20x64%3A%20Incorrect%20codegen%20for%20f32x4.a.../near/261200684" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233327.20x64.3A.20Incorrect.20codegen.20for.20f32x4.2Ea.2E.2E.2E.html#261200684">(Nov 12 2021 at 00:47)</a>:</h4>
<p>jlb6740 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/3327#issuecomment-966726819">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3327">issue #3327</a>:</p>
<blockquote>
<p>@alexcrichton I think I see the issue here. The abs lowering:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">xorps</span><span class="w">   </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="n">xmm1</span><span class="w"></span>
<span class="n">cmpeqps</span><span class="w"> </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="n">xmm1</span><span class="w"></span>
<span class="n">psrld</span><span class="w">   </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="n">andps</span><span class="w">   </span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="n">xmm1</span><span class="w"></span>
</code></pre></div>
<p>leaves xmm1 with:<br>
<code>2147483647</code><br>
But this number (the largest 32-bit int) is not a float. The not instruction sequence:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="s">"cmpeqps %%xmm1, %%xmm1</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
<span class="s">"xorps %%xmm1, %%xmm0</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
</code></pre></div>
<p>takes a register (in this case xmm1) and then tries to make it have the float value 1. It does this in order to do then do an xorps to flip the bits. The problem is that the abs sequence has left the register xmm1 with a number that cmpeqps returns an unexpected result. If we do this on another register that just so happens to have a valid float value then this sequence would work, but in our case it doesn't. The fix seems to be to do a logical xor on the float register before doing the cmpeqps. This logical or correctly zeros the register allowing the cmpeqps to work as expected. Maybe a better sequence but will push this lowering for not:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="s">"xorps %%xmm1, %%xmm1</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
<span class="s">"cmpeqps %%xmm1, %%xmm1</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
<span class="s">"xorps %%xmm1, %%xmm0</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
</code></pre></div>
<p>to resolve this bug. </p>
</blockquote>



<a name="261202858"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233327%20x64%3A%20Incorrect%20codegen%20for%20f32x4.a.../near/261202858" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233327.20x64.3A.20Incorrect.20codegen.20for.20f32x4.2Ea.2E.2E.2E.html#261202858">(Nov 12 2021 at 01:29)</a>:</h4>
<p>jlb6740 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/3327#issuecomment-966726819">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3327">issue #3327</a>:</p>
<blockquote>
<p>@alexcrichton I think I see the issue here. The abs lowering:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">xorps</span><span class="w">   </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="n">xmm1</span><span class="w"></span>
<span class="n">cmpeqps</span><span class="w"> </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="n">xmm1</span><span class="w"></span>
<span class="n">psrld</span><span class="w">   </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="n">andps</span><span class="w">   </span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="n">xmm1</span><span class="w"></span>
</code></pre></div>
<p>leaves xmm1 with:<br>
<code>2147483647</code><br>
But this number (the largest 32-bit int) is not a float. The not instruction sequence:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="s">"cmpeqps %%xmm1, %%xmm1</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
<span class="s">"xorps %%xmm1, %%xmm0</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
</code></pre></div>
<p>takes a register (in this case xmm1) and then tries to make it have the float value 1. It does this in order to do then do an xorps to flip the bits. The problem is that the abs sequence has left the register xmm1 with a number that cmpeqps doesn't return as expected because it is not a valid float. If we do this on another register that just so happens to have a valid float value then this sequence would work, but in our case it doesn't. The fix seems to be to do a logical xor on the float register before doing the cmpeqps. This logical or correctly zeros the register allowing the cmpeqps to work as expected. Maybe a better sequence but will push this lowering for not:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="s">"xorps %%xmm1, %%xmm1</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
<span class="s">"cmpeqps %%xmm1, %%xmm1</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
<span class="s">"xorps %%xmm1, %%xmm0</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
</code></pre></div>
<p>to resolve this bug. </p>
</blockquote>



<a name="261203591"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233327%20x64%3A%20Incorrect%20codegen%20for%20f32x4.a.../near/261203591" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233327.20x64.3A.20Incorrect.20codegen.20for.20f32x4.2Ea.2E.2E.2E.html#261203591">(Nov 12 2021 at 01:44)</a>:</h4>
<p>jlb6740 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/3327#issuecomment-966726819">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3327">issue #3327</a>:</p>
<blockquote>
<p>@alexcrichton I think I see the issue here. The abs lowering:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">xorps</span><span class="w">   </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="n">xmm1</span><span class="w"></span>
<span class="n">cmpeqps</span><span class="w"> </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="n">xmm1</span><span class="w"></span>
<span class="n">psrld</span><span class="w">   </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="n">andps</span><span class="w">   </span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="n">xmm1</span><span class="w"></span>
</code></pre></div>
<p>leaves xmm1 with:<br>
<code>2147483647</code><br>
But this number (the largest 32-bit int) is not a float. The not instruction sequence:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="s">"cmpeqps %%xmm1, %%xmm1</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
<span class="s">"xorps %%xmm1, %%xmm0</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
</code></pre></div>
<p>takes a register (in this case xmm1) and then tries to make it have the float value 1. It does this in order to then do an xorps to flip the bits. The problem is that the abs sequence has left the register xmm1 with a number that cmpeqps doesn't return as expected because it is not a valid float. If we do this on another register that just so happens to have a valid float value then this sequence would work, but in our case it doesn't. The fix seems to be to do a logical xor on the float register before doing the cmpeqps. This logical or correctly zeros the register allowing the cmpeqps to work as expected. Maybe a better sequence but will push this lowering for not:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="s">"xorps %%xmm1, %%xmm1</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
<span class="s">"cmpeqps %%xmm1, %%xmm1</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
<span class="s">"xorps %%xmm1, %%xmm0</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
</code></pre></div>
<p>to resolve this bug. </p>
</blockquote>



<a name="261203655"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233327%20x64%3A%20Incorrect%20codegen%20for%20f32x4.a.../near/261203655" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233327.20x64.3A.20Incorrect.20codegen.20for.20f32x4.2Ea.2E.2E.2E.html#261203655">(Nov 12 2021 at 01:45)</a>:</h4>
<p>jlb6740 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/3327#issuecomment-966726819">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3327">issue #3327</a>:</p>
<blockquote>
<p>@alexcrichton I think I see the issue here. The abs lowering:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">xorps</span><span class="w">   </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="n">xmm1</span><span class="w"></span>
<span class="n">cmpeqps</span><span class="w"> </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="n">xmm1</span><span class="w"></span>
<span class="n">psrld</span><span class="w">   </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="n">andps</span><span class="w">   </span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="n">xmm1</span><span class="w"></span>
</code></pre></div>
<p>leaves xmm1 with:<br>
<code>2147483647</code><br>
But this number (the largest 32-bit int) is not a float. The not instruction sequence:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="s">"cmpeqps %%xmm1, %%xmm1</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
<span class="s">"xorps %%xmm1, %%xmm0</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
</code></pre></div>
<p>takes a register (in this case xmm1) and then tries to make it have the float value 1. It does this in order to then do an xorps to flip the bits. The problem is that the abs sequence has left the register xmm1 with an invalid float so cmpeqps doesn't return as expected. If we do this on another register that happens to have a valid float value then this sequence would work, but in our case it doesn't. The fix seems to be to do a logical xor on the float register before doing the cmpeqps. This logical or correctly zeros the register allowing the cmpeqps to work as expected. Maybe a better sequence but will push this lowering for not:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="s">"xorps %%xmm1, %%xmm1</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
<span class="s">"cmpeqps %%xmm1, %%xmm1</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
<span class="s">"xorps %%xmm1, %%xmm0</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
</code></pre></div>
<p>to resolve this bug. </p>
</blockquote>



<a name="261203668"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233327%20x64%3A%20Incorrect%20codegen%20for%20f32x4.a.../near/261203668" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233327.20x64.3A.20Incorrect.20codegen.20for.20f32x4.2Ea.2E.2E.2E.html#261203668">(Nov 12 2021 at 01:45)</a>:</h4>
<p>jlb6740 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/3327#issuecomment-966726819">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3327">issue #3327</a>:</p>
<blockquote>
<p>@alexcrichton I think I see the issue here. The abs lowering:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">xorps</span><span class="w">   </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="n">xmm1</span><span class="w"></span>
<span class="n">cmpeqps</span><span class="w"> </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="n">xmm1</span><span class="w"></span>
<span class="n">psrld</span><span class="w">   </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="n">andps</span><span class="w">   </span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="n">xmm1</span><span class="w"></span>
</code></pre></div>
<p>leaves xmm1 with:<br>
<code>2147483647</code><br>
But this number (the largest 32-bit int) is not a float. The not instruction sequence:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="s">"cmpeqps %%xmm1, %%xmm1</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
<span class="s">"xorps %%xmm1, %%xmm0</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
</code></pre></div>
<p>takes a register (in this case xmm1) and then tries to make it have the float value 1. It does this in order to then do an xorps to flip the bits. The problem is that the abs sequence has left the register xmm1 with an invalid float so cmpeqps doesn't return as expected. If we do this on another register that happens to have a valid float value then this sequence would work, but in our case it doesn't. The fix seems to be to do a logical xor on the float register before doing the cmpeqps. This logical xor correctly zeros the register allowing the cmpeqps to work as expected. Maybe a better sequence but will push this lowering for not:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="s">"xorps %%xmm1, %%xmm1</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
<span class="s">"cmpeqps %%xmm1, %%xmm1</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
<span class="s">"xorps %%xmm1, %%xmm0</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
</code></pre></div>
<p>to resolve this bug. </p>
</blockquote>



<a name="261203683"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233327%20x64%3A%20Incorrect%20codegen%20for%20f32x4.a.../near/261203683" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233327.20x64.3A.20Incorrect.20codegen.20for.20f32x4.2Ea.2E.2E.2E.html#261203683">(Nov 12 2021 at 01:45)</a>:</h4>
<p>jlb6740 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/3327#issuecomment-966726819">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3327">issue #3327</a>:</p>
<blockquote>
<p>@alexcrichton I think I see the issue here. The abs lowering:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">xorps</span><span class="w">   </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="n">xmm1</span><span class="w"></span>
<span class="n">cmpeqps</span><span class="w"> </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="n">xmm1</span><span class="w"></span>
<span class="n">psrld</span><span class="w">   </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="n">andps</span><span class="w">   </span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="n">xmm1</span><span class="w"></span>
</code></pre></div>
<p>leaves xmm1 with:<br>
<code>2147483647</code><br>
But this number (the largest 32-bit int) is not a float. The not instruction sequence:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="s">"cmpeqps %%xmm1, %%xmm1</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
<span class="s">"xorps %%xmm1, %%xmm0</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
</code></pre></div>
<p>takes a register (in this case xmm1) and then tries to make it have the float value 1. It does this in order to then do an xorps to flip the bits. The problem is that the abs sequence has left the register xmm1 with an invalid float so cmpeqps doesn't return as expected. If we do this on another register that happens to have a valid float value then this sequence would work, but in our case it doesn't. The fix seems to be to do a logical xor on the float register before doing the cmpeqps. This logical xor correctly zeros the register allowing the cmpeqps to return as desired. Maybe a another instruction sequence exist but will push this lowering for not:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="s">"xorps %%xmm1, %%xmm1</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
<span class="s">"cmpeqps %%xmm1, %%xmm1</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
<span class="s">"xorps %%xmm1, %%xmm0</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
</code></pre></div>
<p>to resolve this bug. </p>
</blockquote>



<a name="261203856"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233327%20x64%3A%20Incorrect%20codegen%20for%20f32x4.a.../near/261203856" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233327.20x64.3A.20Incorrect.20codegen.20for.20f32x4.2Ea.2E.2E.2E.html#261203856">(Nov 12 2021 at 01:49)</a>:</h4>
<p>jlb6740 <a href="https://github.com/bytecodealliance/wasmtime/issues/3327#issuecomment-966753300">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3327">issue #3327</a>:</p>
<blockquote>
<p>@alexcrichton btw .. just read your comment on <a href="https://github.com/alexcrichton/wasmtime/commit/f7ccaf2395b4fed071e97eaf6c9d490e42638a65">https://github.com/alexcrichton/wasmtime/commit/f7ccaf2395b4fed071e97eaf6c9d490e42638a65</a> and indeed the fabs/fneg lowering implements this correctly. The bnot implementation apparently didn't foresee this issue. </p>
<p>I created a jist here that may be useful for other bugs: <a href="https://gist.github.com/jlb6740/33e77c7f32beb99bdc392ff456fbc864">https://gist.github.com/jlb6740/33e77c7f32beb99bdc392ff456fbc864</a></p>
</blockquote>



<a name="261203917"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233327%20x64%3A%20Incorrect%20codegen%20for%20f32x4.a.../near/261203917" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233327.20x64.3A.20Incorrect.20codegen.20for.20f32x4.2Ea.2E.2E.2E.html#261203917">(Nov 12 2021 at 01:50)</a>:</h4>
<p>jlb6740 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/3327#issuecomment-966753300">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3327">issue #3327</a>:</p>
<blockquote>
<p>@alexcrichton btw .. just read your comment on <a href="https://github.com/alexcrichton/wasmtime/commit/f7ccaf2395b4fed071e97eaf6c9d490e42638a65">https://github.com/alexcrichton/wasmtime/commit/f7ccaf2395b4fed071e97eaf6c9d490e42638a65</a> and indeed the fabs/fneg lowering implements this correctly. The bnot implementation apparently didn't foresee this issue. </p>
<p>I created a jist here that may be useful for debugging similar bugs: <a href="https://gist.github.com/jlb6740/33e77c7f32beb99bdc392ff456fbc864">https://gist.github.com/jlb6740/33e77c7f32beb99bdc392ff456fbc864</a></p>
</blockquote>



<a name="261657627"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233327%20x64%3A%20Incorrect%20codegen%20for%20f32x4.a.../near/261657627" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233327.20x64.3A.20Incorrect.20codegen.20for.20f32x4.2Ea.2E.2E.2E.html#261657627">(Nov 16 2021 at 15:28)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/3327">issue #3327</a>:</p>
<blockquote>
<p>Found via fuzzing this module:</p>
<div class="codehilite" data-code-language="wasm"><pre><span></span><code>(module
  (func (result v128)
    v128.const f32x4 0 0 0 0
    f32x4.abs
    v128.not)
  (export "1" (func 0))
)
</code></pre></div>
<p>yields:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">testcase0</span><span class="p">.</span><span class="n">wat</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">simd</span><span class="w"></span>
<span class="n">warning</span>: <span class="nc">using</span><span class="w"> </span><span class="err">`</span><span class="o">--</span><span class="n">invoke</span><span class="err">`</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">returns</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">experimental</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">future</span><span class="w"></span>
<span class="mi">0</span><span class="w"></span>
</code></pre></div>
<p>when it should print <code>u128::MAX</code>.</p>
<p>The disassembly of this function is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">0000000000000000</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_wasm_function_0</span><span class="o">&gt;</span>:
       <span class="mi">0</span>:       <span class="mi">55</span><span class="w">                      </span><span class="n">push</span><span class="w">   </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">       </span><span class="mi">1</span>:       <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">e5</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">       </span><span class="mi">4</span>:       <span class="nc">f3</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">6</span><span class="n">f</span><span class="w"> </span><span class="mi">05</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="n">movdqu</span><span class="w"> </span><span class="mh">0x24</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">),</span><span class="o">%</span><span class="n">xmm0</span><span class="w">        </span>#<span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_wasm_function_0</span><span class="o">+</span><span class="mh">0x30</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">       </span><span class="n">b</span>:       <span class="mi">00</span><span class="w"></span>
<span class="w">       </span><span class="n">c</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">57</span><span class="w"> </span><span class="n">c9</span><span class="w">                </span><span class="n">xorps</span><span class="w">  </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">       </span><span class="n">f</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="n">c9</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">cmpeqps</span><span class="w"> </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">      </span><span class="mi">13</span>:       <span class="mi">66</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">72</span><span class="w"> </span><span class="n">d1</span><span class="w"> </span><span class="mi">01</span><span class="w">          </span><span class="n">psrld</span><span class="w">  </span><span class="cp">$</span><span class="mh">0x1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">      </span><span class="mi">18</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">54</span><span class="w"> </span><span class="n">c1</span><span class="w">                </span><span class="n">andps</span><span class="w">  </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm0</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="n">b</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="n">c9</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">cmpeqps</span><span class="w"> </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="n">f</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">57</span><span class="w"> </span><span class="n">c1</span><span class="w">                </span><span class="n">xorps</span><span class="w">  </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm0</span><span class="w"></span>
<span class="w">      </span><span class="mi">22</span>:       <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">ec</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="p">,</span><span class="o">%</span><span class="n">rsp</span><span class="w"></span>
<span class="w">      </span><span class="mi">25</span>:       <span class="mi">5</span><span class="n">d</span><span class="w">                      </span><span class="n">pop</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">      </span><span class="mi">26</span>:       <span class="nc">c3</span><span class="w">                      </span><span class="n">retq</span><span class="w"></span>
</code></pre></div>
<p>I don't for sure know what's going on here with each individual instruction, but this sort of looks like a register allocator issue? I'm not sure what the second <code>xorps</code> is doing there with those registers. If this is a register allocator thing it may or may not be related to <a href="https://github.com/bytecodealliance/wasmtime/issues/3216">https://github.com/bytecodealliance/wasmtime/issues/3216</a></p>
</blockquote>



<a name="261657633"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233327%20x64%3A%20Incorrect%20codegen%20for%20f32x4.a.../near/261657633" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233327.20x64.3A.20Incorrect.20codegen.20for.20f32x4.2Ea.2E.2E.2E.html#261657633">(Nov 16 2021 at 15:28)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/3327#issuecomment-970386047">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3327">issue #3327</a>:</p>
<blockquote>
<p>Fixed in <a href="https://github.com/bytecodealliance/wasmtime/pull/3517">https://github.com/bytecodealliance/wasmtime/pull/3517</a></p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>