<html>
<head><meta charset="utf-8"><title>wasmtime / issue #8257 FileOutputStream::write() modify t... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238257.20FileOutputStream.3A.3Awrite.28.29.20modify.20t.2E.2E.2E.html">wasmtime / issue #8257 FileOutputStream::write() modify t...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="430054234"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238257%20FileOutputStream%3A%3Awrite%28%29%20modify%20t.../near/430054234" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238257.20FileOutputStream.3A.3Awrite.28.29.20modify.20t.2E.2E.2E.html#430054234">(Mar 28 2024 at 12:11)</a>:</h4>
<p>liutao-liu opened <a href="https://github.com/bytecodealliance/wasmtime/issues/8257">issue #8257</a>:</p>
<blockquote>
<p>Two modifications to the <code>p</code> code：<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/filesystem.rs#L339">https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/filesystem.rs#L339</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/filesystem.rs#L359">https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/filesystem.rs#L359</a></p>
<p>The former is an invalid modification, because <code>p</code> is not a reference of self.mode.</p>
</blockquote>



<a name="430054705"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238257%20FileOutputStream%3A%3Awrite%28%29%20modify%20t.../near/430054705" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238257.20FileOutputStream.3A.3Awrite.28.29.20modify.20t.2E.2E.2E.html#430054705">(Mar 28 2024 at 12:14)</a>:</h4>
<p>liutao-liu edited <a href="https://github.com/bytecodealliance/wasmtime/issues/8257">issue #8257</a>:</p>
<blockquote>
<p>Two modifications to the <code>p</code> code：<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/filesystem.rs#L339">https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/filesystem.rs#L339</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/filesystem.rs#L359">https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/filesystem.rs#L359</a></p>
<p>The former is an invalid modification, because <code>p</code> is not a reference of self.mode.</p>
<p>Please help confirm if this is a bug. If it is, I'll submit a pr with my local changes.<br>
</p>
</blockquote>



<a name="430054717"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238257%20FileOutputStream%3A%3Awrite%28%29%20modify%20t.../near/430054717" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238257.20FileOutputStream.3A.3Awrite.28.29.20modify.20t.2E.2E.2E.html#430054717">(Mar 28 2024 at 12:14)</a>:</h4>
<p>liutao-liu edited <a href="https://github.com/bytecodealliance/wasmtime/issues/8257">issue #8257</a>:</p>
<blockquote>
<p>Two modifications to the <code>p</code> code：<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/filesystem.rs#L339">https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/filesystem.rs#L339</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/filesystem.rs#L359">https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/filesystem.rs#L359</a></p>
<p>The former is an invalid modification, because <code>p</code> is not a reference of self.mode.</p>
<p>Please help confirm if this is a bug. If it is, I'll submit a pr with my local changes.</p>
<p>```[tasklist]</p>
<h3>Tasks</h3>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">~~~</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="430054732"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238257%20FileOutputStream%3A%3Awrite%28%29%20modify%20t.../near/430054732" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238257.20FileOutputStream.3A.3Awrite.28.29.20modify.20t.2E.2E.2E.html#430054732">(Mar 28 2024 at 12:14)</a>:</h4>
<p>liutao-liu edited <a href="https://github.com/bytecodealliance/wasmtime/issues/8257">issue #8257</a>:</p>
<blockquote>
<p>Two modifications to the <code>p</code> code：<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/filesystem.rs#L339">https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/filesystem.rs#L339</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/filesystem.rs#L359">https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/filesystem.rs#L359</a></p>
<p>The former is an invalid modification, because <code>p</code> is not a reference of self.mode.</p>
<p>Please help confirm if this is a bug. If it is, I'll submit a pr with my local changes.</p>
</blockquote>



<a name="430067366"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238257%20FileOutputStream%3A%3Awrite%28%29%20modify%20t.../near/430067366" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238257.20FileOutputStream.3A.3Awrite.28.29.20modify.20t.2E.2E.2E.html#430067366">(Mar 28 2024 at 13:29)</a>:</h4>
<p>liutao-liu edited <a href="https://github.com/bytecodealliance/wasmtime/issues/8257">issue #8257</a>:</p>
<blockquote>
<p>Two modifications to the <code>p</code> code：<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/filesystem.rs#L359">https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/filesystem.rs#L359</a></p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/preview1.rs#L1705">https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/preview1.rs#L1705</a></p>
<p>The former is an invalid modification, because <code>self.mode</code> is not a reference of postion, which is value pass in <code>write_via_stream</code> .</p>
<p>Please help confirm if this is a bug. If it is, I'll submit a pr with my local changes.</p>
</blockquote>



<a name="430089334"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238257%20FileOutputStream%3A%3Awrite%28%29%20modify%20t.../near/430089334" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238257.20FileOutputStream.3A.3Awrite.28.29.20modify.20t.2E.2E.2E.html#430089334">(Mar 28 2024 at 15:07)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8257#issuecomment-2025453434">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8257">issue #8257</a>:</p>
<blockquote>
<p>Could you clarify with a test case what the expected behavior is? Reviewing these mutations I don't see anything amiss myself, but a test case could help understand if there's a bug here</p>
</blockquote>



<a name="430186173"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238257%20FileOutputStream%3A%3Awrite%28%29%20modify%20t.../near/430186173" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238257.20FileOutputStream.3A.3Awrite.28.29.20modify.20t.2E.2E.2E.html#430186173">(Mar 29 2024 at 01:10)</a>:</h4>
<p>liutao-liu edited <a href="https://github.com/bytecodealliance/wasmtime/issues/8257">issue #8257</a>:</p>
<blockquote>
<p>Two modifications to the <code>p</code> code：<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/filesystem.rs#L359">https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/filesystem.rs#L359</a></p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/preview1.rs#L1705">https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/preview1.rs#L1705</a></p>
<p>The former is an invalid modification, because <code>self.mode</code> is not a reference of postion in <a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/preview1.rs#L1670">fd_write</a> , which is passed by value in <a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/preview1.rs#L1690"><code>`write_via_stream</code></a>` .</p>
<p>Please help confirm if this is a bug. If it is, I'll submit a pr with my local changes.</p>
</blockquote>



<a name="430186204"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238257%20FileOutputStream%3A%3Awrite%28%29%20modify%20t.../near/430186204" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238257.20FileOutputStream.3A.3Awrite.28.29.20modify.20t.2E.2E.2E.html#430186204">(Mar 29 2024 at 01:10)</a>:</h4>
<p>liutao-liu edited <a href="https://github.com/bytecodealliance/wasmtime/issues/8257">issue #8257</a>:</p>
<blockquote>
<p>Two modifications to the <code>p</code> code：<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/filesystem.rs#L359">https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/filesystem.rs#L359</a></p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/preview1.rs#L1705">https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/preview1.rs#L1705</a></p>
<p>The former is an invalid modification, because <code>self.mode</code> is not a reference of postion in <a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/preview1.rs#L1670">fd_write</a> , which is passed by value in <a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/preview1.rs#L1690">write_via_stream</a>` .</p>
<p>Please help confirm if this is a bug. If it is, I'll submit a pr with my local changes.</p>
</blockquote>



<a name="430186219"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238257%20FileOutputStream%3A%3Awrite%28%29%20modify%20t.../near/430186219" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238257.20FileOutputStream.3A.3Awrite.28.29.20modify.20t.2E.2E.2E.html#430186219">(Mar 29 2024 at 01:11)</a>:</h4>
<p>liutao-liu edited <a href="https://github.com/bytecodealliance/wasmtime/issues/8257">issue #8257</a>:</p>
<blockquote>
<p>Two modifications to the <code>p</code> code：<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/filesystem.rs#L359">https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/filesystem.rs#L359</a></p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/preview1.rs#L1705">https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/preview1.rs#L1705</a></p>
<p>The former is an invalid modification, because <code>self.mode</code> is not a reference of postion in <a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/preview1.rs#L1670">fd_write</a> , which is passed by value in <a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/preview1.rs#L1690">write_via_stream</a>.</p>
<p>Please help confirm if this is a bug. If it is, I'll submit a pr with my local changes.</p>
</blockquote>



<a name="430376228"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238257%20FileOutputStream%3A%3Awrite%28%29%20modify%20t.../near/430376228" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238257.20FileOutputStream.3A.3Awrite.28.29.20modify.20t.2E.2E.2E.html#430376228">(Mar 30 2024 at 09:58)</a>:</h4>
<p>liutao-liu <a href="https://github.com/bytecodealliance/wasmtime/issues/8257#issuecomment-2027997155">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8257">issue #8257</a>:</p>
<blockquote>
<blockquote>
<p>Could you clarify with a test case what the expected behavior is? Reviewing these mutations I don't see anything amiss myself, but a test case could help understand if there's a bug here</p>
</blockquote>
<p>Delete the modification in <a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/filesystem.rs#L359">here</a> All test case can run success. The reason is what I said before:<code>self.mode</code> is not a reference of postion in <a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/preview1.rs#L1670">fd_write</a> , which is passed by value in <a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/preview1.rs#L1690">write_via_stream</a>.</p>
<p>![image](<a href="https://github.com/bytecodealliance/wasmtime/assets/10509166/b2d5fd02-8e3c-4273-8333-c1fe88432862">https://github.com/bytecodealliance/wasmtime/assets/10509166/b2d5fd02-8e3c-4273-8333-c1fe88432862</a>)</p>
</blockquote>



<a name="430376293"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238257%20FileOutputStream%3A%3Awrite%28%29%20modify%20t.../near/430376293" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238257.20FileOutputStream.3A.3Awrite.28.29.20modify.20t.2E.2E.2E.html#430376293">(Mar 30 2024 at 09:59)</a>:</h4>
<p>liutao-liu edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8257#issuecomment-2027997155">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8257">issue #8257</a>:</p>
<blockquote>
<blockquote>
<p>Could you clarify with a test case what the expected behavior is? Reviewing these mutations I don't see anything amiss myself, but a test case could help understand if there's a bug here</p>
</blockquote>
<p>Delete the modification in <a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/filesystem.rs#L359">here</a> All test case can run success:<br>
![image](<a href="https://github.com/bytecodealliance/wasmtime/assets/10509166/b2d5fd02-8e3c-4273-8333-c1fe88432862">https://github.com/bytecodealliance/wasmtime/assets/10509166/b2d5fd02-8e3c-4273-8333-c1fe88432862</a>)</p>
<p>The reason is what I said before:<code>self.mode</code> is not a reference of postion in <a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/preview1.rs#L1670">fd_write</a> , which is passed by value in <a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/preview1.rs#L1690">write_via_stream</a>:<br>
![Uploading image.png…]()</p>
</blockquote>



<a name="430376538"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238257%20FileOutputStream%3A%3Awrite%28%29%20modify%20t.../near/430376538" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238257.20FileOutputStream.3A.3Awrite.28.29.20modify.20t.2E.2E.2E.html#430376538">(Mar 30 2024 at 10:03)</a>:</h4>
<p>liutao-liu edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8257#issuecomment-2027997155">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8257">issue #8257</a>:</p>
<blockquote>
<blockquote>
<p>Could you clarify with a test case what the expected behavior is? Reviewing these mutations I don't see anything amiss myself, but a test case could help understand if there's a bug here</p>
</blockquote>
<p>Delete the modification in <a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/filesystem.rs#L359">here</a> All test case can run success:<br>
![image](<a href="https://github.com/bytecodealliance/wasmtime/assets/10509166/b2d5fd02-8e3c-4273-8333-c1fe88432862">https://github.com/bytecodealliance/wasmtime/assets/10509166/b2d5fd02-8e3c-4273-8333-c1fe88432862</a>)</p>
<p>The reason is what I said before:<code>self.mode</code> is not a reference of postion in <a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/preview1.rs#L1670">fd_write</a> , which is passed by value in <a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/preview1.rs#L1690">write_via_stream</a>:<br>
![image](<a href="https://github.com/bytecodealliance/wasmtime/assets/10509166/49819e93-765e-47dc-a970-eb9dd9afbc08">https://github.com/bytecodealliance/wasmtime/assets/10509166/49819e93-765e-47dc-a970-eb9dd9afbc08</a>)</p>
</blockquote>



<a name="430502127"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238257%20FileOutputStream%3A%3Awrite%28%29%20modify%20t.../near/430502127" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238257.20FileOutputStream.3A.3Awrite.28.29.20modify.20t.2E.2E.2E.html#430502127">(Mar 31 2024 at 19:44)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8257#issuecomment-2028887297">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8257">issue #8257</a>:</p>
<blockquote>
<p>Sorry yeah our test suite for preview2 is not overly comprehensive. I've added a test in <a href="https://github.com/bytecodealliance/wasmtime/pull/8271">https://github.com/bytecodealliance/wasmtime/pull/8271</a> which fails if the code you're linking to fails.</p>
<p>It's a bit subtle and it needs a few different things in play, but I believe that this code is still necessary. Can you elaborate more on why you're looking to see this deleted?</p>
</blockquote>



<a name="430532286"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238257%20FileOutputStream%3A%3Awrite%28%29%20modify%20t.../near/430532286" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238257.20FileOutputStream.3A.3Awrite.28.29.20modify.20t.2E.2E.2E.html#430532286">(Apr 01 2024 at 03:16)</a>:</h4>
<p>liutao-liu <a href="https://github.com/bytecodealliance/wasmtime/issues/8257#issuecomment-2029086973">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8257">issue #8257</a>:</p>
<blockquote>
<p>The postion has been modified in <code>fd_write</code>(<code>fd_read</code> is the same):<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/preview1.rs#L1705">https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/preview1.rs#L1705</a><br>
The implementation of <code>fd_write</code> is as follows: first call <code>write_via_stream</code>, then call <code>blocking_write_and_flush</code>, and finally modify the <code>position</code>.<br>
The test case you added in #8271: call <code>write_via_stream</code> <strong>once</strong>, then call <code>blocking_write_and_flush</code> <strong>twice</strong>.</p>
</blockquote>



<a name="430532979"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238257%20FileOutputStream%3A%3Awrite%28%29%20modify%20t.../near/430532979" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238257.20FileOutputStream.3A.3Awrite.28.29.20modify.20t.2E.2E.2E.html#430532979">(Apr 01 2024 at 03:26)</a>:</h4>
<p>liutao-liu edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8257#issuecomment-2029086973">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8257">issue #8257</a>:</p>
<blockquote>
<p>The postion has been modified in <code>fd_write</code>(<code>fd_read</code> is the same):<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/preview1.rs#L1705">https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/preview1.rs#L1705</a><br>
The implementation of <code>fd_write</code> is as follows: first call <code>write_via_stream</code>, then call <code>blocking_write_and_flush</code>, and finally modify the <code>position</code>.<br>
The test case you added in #8271: call <code>write_via_stream</code> <strong>once</strong>, then call <code>blocking_write_and_flush</code> <strong>twice</strong>, so, in this case, must change the position in <code>blocking_write_and_flush</code>.</p>
</blockquote>



<a name="430608603"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238257%20FileOutputStream%3A%3Awrite%28%29%20modify%20t.../near/430608603" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238257.20FileOutputStream.3A.3Awrite.28.29.20modify.20t.2E.2E.2E.html#430608603">(Apr 01 2024 at 15:07)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8257#issuecomment-2029912511">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8257">issue #8257</a>:</p>
<blockquote>
<p>You'll need to remember that there's a few layers here. The test I added in #8271 specifically uses preview2-based APIs and does not use preview1. You're correct that in a world where preview2 does not exist removing the write is ok, but in a world where preview2 exists removing the write is not correct.</p>
<p>I've asked a few times already, but can you clarify why you'd like this write removed? Is it causing performance problems or something like that? Or are you instead trying to understand why it's needed? (whatever's fine, I'm just curious!)</p>
</blockquote>



<a name="430688326"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238257%20FileOutputStream%3A%3Awrite%28%29%20modify%20t.../near/430688326" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238257.20FileOutputStream.3A.3Awrite.28.29.20modify.20t.2E.2E.2E.html#430688326">(Apr 02 2024 at 01:02)</a>:</h4>
<p>liutao-liu closed <a href="https://github.com/bytecodealliance/wasmtime/issues/8257">issue #8257</a>:</p>
<blockquote>
<p>Two modifications to the <code>p</code> code：<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/filesystem.rs#L359">https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/filesystem.rs#L359</a></p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/preview1.rs#L1705">https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/preview1.rs#L1705</a></p>
<p>The former is an invalid modification, because <code>self.mode</code> is not a reference of postion in <a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/preview1.rs#L1670">fd_write</a> , which is passed by value in <a href="https://github.com/bytecodealliance/wasmtime/blob/9c92881d3b936b5d2e593ded370609a6e31717d8/crates/wasi/src/preview1.rs#L1690">write_via_stream</a>.</p>
<p>Please help confirm if this is a bug. If it is, I'll submit a pr with my local changes.</p>
</blockquote>



<a name="430688327"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238257%20FileOutputStream%3A%3Awrite%28%29%20modify%20t.../near/430688327" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238257.20FileOutputStream.3A.3Awrite.28.29.20modify.20t.2E.2E.2E.html#430688327">(Apr 02 2024 at 01:02)</a>:</h4>
<p>liutao-liu <a href="https://github.com/bytecodealliance/wasmtime/issues/8257#issuecomment-2030892405">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8257">issue #8257</a>:</p>
<blockquote>
<blockquote>
<p>You'll need to remember that there's a few layers here. The test I added in #8271 specifically uses preview2-based APIs and does not use preview1. You're correct that in a world where preview2 does not exist removing the write is ok, but in a world where preview2 exists removing the write is not correct.</p>
<p>I've asked a few times already, but can you clarify why you'd like this write removed? Is it causing performance problems or something like that? Or are you instead trying to understand why it's needed? (whatever's fine, I'm just curious!)</p>
</blockquote>
<p>Sorry, I wasn't thinking from preview2's perspective. I see what you mean, thanks for your reply.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>