<html>
<head><meta charset="utf-8"><title>wasmtime / issue #5470 Cranelift: `srem.i8` giving wrong ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235470.20Cranelift.3A.20.60srem.2Ei8.60.20giving.20wrong.20.2E.2E.2E.html">wasmtime / issue #5470 Cranelift: `srem.i8` giving wrong ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="316778465"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235470%20Cranelift%3A%20%60srem.i8%60%20giving%20wrong%20.../near/316778465" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235470.20Cranelift.3A.20.60srem.2Ei8.60.20giving.20wrong.20.2E.2E.2E.html#316778465">(Dec 19 2022 at 16:10)</a>:</h4>
<p>afonso360 opened <a href="https://github.com/bytecodealliance/wasmtime/issues/5470">issue #5470</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>The fuzzer pointed this out when I added <code>srem</code>. This essentially does <code>srem -1, -1</code>, but we get the lhs with a <code>bmask</code>.</p>
<p>Doing a <code>srem</code> with both sides coming from an argument gives the correct result. I think we might be missing some masking on <code>srem</code>. The output of <code>bmask</code> seems correct. (i.e. 255).</p>
<p>This test passes on <code>aarch64</code>, <code>s390x</code> and <code>riscv64</code>.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">interpret</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">run</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">s390x</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">riscv64</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i8</span> <span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i8</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bmask</span><span class="p">.</span><span class="kt">i8</span><span class="w"> </span><span class="n">v0</span><span class="w"></span>
<span class="w">    </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">srem</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="mi">4352</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li><code>clif-util test ./the-above.clif</code></li>
</ul>
<h3>Expected Results</h3>
<p>The test to pass.</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="n">ERROR</span><span class="w"> </span><span class="n">cranelift_filetests</span>::<span class="n">concurrent</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FAIL</span>: <span class="nc">run</span><span class="w"></span>
<span class="n">FAIL</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">test</span><span class="p">.</span><span class="n">clif</span>: <span class="nc">run</span><span class="w"></span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="nc">Failed</span><span class="w"> </span><span class="n">test</span>: <span class="nc">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="mi">4352</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">actual</span>: <span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="mi">1</span><span class="w"> </span><span class="n">tests</span><span class="w"></span>
<span class="n">Error</span>: <span class="mi">1</span><span class="w"> </span><span class="n">failure</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: main<br>
Operating system: Linux<br>
Architecture: x86_64</p>
<h3>Extra Info</h3>
<p>&lt;details&gt;<br>
&lt;summary&gt; Disassembly: <code>cargo run  -- compile --target x86_64  -D ./test.clif</code>&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Disassembly</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">63</span><span class="w"> </span><span class="n">bytes</span>:
   <span class="mi">0</span>:   <span class="mi">55</span><span class="w">                      </span><span class="n">push</span><span class="w">    </span><span class="n">rbp</span><span class="w"></span>
<span class="w">   </span><span class="mi">1</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">e5</span><span class="w">                </span><span class="n">mov</span><span class="w">     </span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="n">rsp</span><span class="w"></span>
<span class="w">   </span><span class="mi">4</span>:   <span class="mi">49</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">fb</span><span class="w">                </span><span class="n">mov</span><span class="w">     </span><span class="n">r11</span><span class="p">,</span><span class="w"> </span><span class="n">rdi</span><span class="w"></span>
<span class="w">   </span><span class="mi">7</span>:   <span class="mi">49</span><span class="w"> </span><span class="n">f7</span><span class="w"> </span><span class="n">db</span><span class="w">                </span><span class="n">neg</span><span class="w">     </span><span class="n">r11</span><span class="w"></span>
<span class="w">   </span><span class="n">a</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">f8</span><span class="w">                </span><span class="n">mov</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">rdi</span><span class="w"></span>
<span class="w">   </span><span class="n">d</span>:   <span class="mi">19</span><span class="w"> </span><span class="n">f8</span><span class="w">                   </span><span class="n">sbb</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">edi</span><span class="w"></span>
<span class="w">   </span><span class="n">f</span>:   <span class="mi">31</span><span class="w"> </span><span class="n">d2</span><span class="w">                   </span><span class="n">xor</span><span class="w">     </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">edx</span><span class="w"></span>
<span class="w">  </span><span class="mi">11</span>:   <span class="mi">40</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="n">fe</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">cmp</span><span class="w">     </span><span class="n">sil</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="mi">15</span>:   <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">85</span><span class="w"> </span><span class="mi">02</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">       </span><span class="n">jne</span><span class="w">     </span><span class="mh">0x1d</span><span class="w"></span>
<span class="w">  </span><span class="mi">1</span><span class="n">b</span>:   <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">0</span><span class="n">b</span><span class="w">                   </span><span class="n">ud2</span><span class="w"></span>
<span class="w">  </span><span class="mi">1</span><span class="n">d</span>:   <span class="mi">40</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="n">fe</span><span class="w"> </span><span class="n">ff</span><span class="w">             </span><span class="n">cmp</span><span class="w">     </span><span class="n">sil</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="w"></span>
<span class="w">  </span><span class="mi">21</span>:   <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">85</span><span class="w"> </span><span class="mi">0</span><span class="n">a</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">       </span><span class="n">jne</span><span class="w">     </span><span class="mh">0x31</span><span class="w"></span>
<span class="w">  </span><span class="mi">27</span>:   <span class="nc">ba</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="n">mov</span><span class="w">     </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="mi">2</span><span class="n">c</span>:   <span class="nc">e9</span><span class="w"> </span><span class="mi">05</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="n">jmp</span><span class="w">     </span><span class="mh">0x36</span><span class="w"></span>
<span class="w">  </span><span class="mi">31</span>:   <span class="mi">66</span><span class="w"> </span><span class="mi">98</span><span class="w">                   </span><span class="n">cbw</span><span class="w"></span>
<span class="w">  </span><span class="mi">33</span>:   <span class="mi">40</span><span class="w"> </span><span class="n">f6</span><span class="w"> </span><span class="n">fe</span><span class="w">                </span><span class="n">idiv</span><span class="w">    </span><span class="n">sil</span><span class="w"></span>
<span class="w">  </span><span class="mi">36</span>:   <span class="mi">48</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="n">e8</span><span class="w"> </span><span class="mi">08</span><span class="w">             </span><span class="n">shr</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w">  </span><span class="mi">3</span><span class="n">a</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">ec</span><span class="w">                </span><span class="n">mov</span><span class="w">     </span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="mi">3</span><span class="n">d</span>:   <span class="mi">5</span><span class="n">d</span><span class="w">                      </span><span class="n">pop</span><span class="w">     </span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="mi">3</span><span class="n">e</span>:   <span class="nc">c3</span><span class="w">                      </span><span class="n">ret</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;<br>
</p>
</blockquote>



<a name="316778466"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235470%20Cranelift%3A%20%60srem.i8%60%20giving%20wrong%20.../near/316778466" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235470.20Cranelift.3A.20.60srem.2Ei8.60.20giving.20wrong.20.2E.2E.2E.html#316778466">(Dec 19 2022 at 16:10)</a>:</h4>
<p>afonso360 labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/5470">issue #5470</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>The fuzzer pointed this out when I added <code>srem</code>. This essentially does <code>srem -1, -1</code>, but we get the lhs with a <code>bmask</code>.</p>
<p>Doing a <code>srem</code> with both sides coming from an argument gives the correct result. I think we might be missing some masking on <code>srem</code>. The output of <code>bmask</code> seems correct. (i.e. 255).</p>
<p>This test passes on <code>aarch64</code>, <code>s390x</code> and <code>riscv64</code>.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">interpret</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">run</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">s390x</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">riscv64</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i8</span> <span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i8</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bmask</span><span class="p">.</span><span class="kt">i8</span><span class="w"> </span><span class="n">v0</span><span class="w"></span>
<span class="w">    </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">srem</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="mi">4352</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li><code>clif-util test ./the-above.clif</code></li>
</ul>
<h3>Expected Results</h3>
<p>The test to pass.</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="n">ERROR</span><span class="w"> </span><span class="n">cranelift_filetests</span>::<span class="n">concurrent</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FAIL</span>: <span class="nc">run</span><span class="w"></span>
<span class="n">FAIL</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">test</span><span class="p">.</span><span class="n">clif</span>: <span class="nc">run</span><span class="w"></span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="nc">Failed</span><span class="w"> </span><span class="n">test</span>: <span class="nc">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="mi">4352</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">actual</span>: <span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="mi">1</span><span class="w"> </span><span class="n">tests</span><span class="w"></span>
<span class="n">Error</span>: <span class="mi">1</span><span class="w"> </span><span class="n">failure</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: main<br>
Operating system: Linux<br>
Architecture: x86_64</p>
<h3>Extra Info</h3>
<p>&lt;details&gt;<br>
&lt;summary&gt; Disassembly: <code>cargo run  -- compile --target x86_64  -D ./test.clif</code>&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Disassembly</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">63</span><span class="w"> </span><span class="n">bytes</span>:
   <span class="mi">0</span>:   <span class="mi">55</span><span class="w">                      </span><span class="n">push</span><span class="w">    </span><span class="n">rbp</span><span class="w"></span>
<span class="w">   </span><span class="mi">1</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">e5</span><span class="w">                </span><span class="n">mov</span><span class="w">     </span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="n">rsp</span><span class="w"></span>
<span class="w">   </span><span class="mi">4</span>:   <span class="mi">49</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">fb</span><span class="w">                </span><span class="n">mov</span><span class="w">     </span><span class="n">r11</span><span class="p">,</span><span class="w"> </span><span class="n">rdi</span><span class="w"></span>
<span class="w">   </span><span class="mi">7</span>:   <span class="mi">49</span><span class="w"> </span><span class="n">f7</span><span class="w"> </span><span class="n">db</span><span class="w">                </span><span class="n">neg</span><span class="w">     </span><span class="n">r11</span><span class="w"></span>
<span class="w">   </span><span class="n">a</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">f8</span><span class="w">                </span><span class="n">mov</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">rdi</span><span class="w"></span>
<span class="w">   </span><span class="n">d</span>:   <span class="mi">19</span><span class="w"> </span><span class="n">f8</span><span class="w">                   </span><span class="n">sbb</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">edi</span><span class="w"></span>
<span class="w">   </span><span class="n">f</span>:   <span class="mi">31</span><span class="w"> </span><span class="n">d2</span><span class="w">                   </span><span class="n">xor</span><span class="w">     </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">edx</span><span class="w"></span>
<span class="w">  </span><span class="mi">11</span>:   <span class="mi">40</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="n">fe</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">cmp</span><span class="w">     </span><span class="n">sil</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="mi">15</span>:   <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">85</span><span class="w"> </span><span class="mi">02</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">       </span><span class="n">jne</span><span class="w">     </span><span class="mh">0x1d</span><span class="w"></span>
<span class="w">  </span><span class="mi">1</span><span class="n">b</span>:   <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">0</span><span class="n">b</span><span class="w">                   </span><span class="n">ud2</span><span class="w"></span>
<span class="w">  </span><span class="mi">1</span><span class="n">d</span>:   <span class="mi">40</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="n">fe</span><span class="w"> </span><span class="n">ff</span><span class="w">             </span><span class="n">cmp</span><span class="w">     </span><span class="n">sil</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="w"></span>
<span class="w">  </span><span class="mi">21</span>:   <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">85</span><span class="w"> </span><span class="mi">0</span><span class="n">a</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">       </span><span class="n">jne</span><span class="w">     </span><span class="mh">0x31</span><span class="w"></span>
<span class="w">  </span><span class="mi">27</span>:   <span class="nc">ba</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="n">mov</span><span class="w">     </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="mi">2</span><span class="n">c</span>:   <span class="nc">e9</span><span class="w"> </span><span class="mi">05</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="n">jmp</span><span class="w">     </span><span class="mh">0x36</span><span class="w"></span>
<span class="w">  </span><span class="mi">31</span>:   <span class="mi">66</span><span class="w"> </span><span class="mi">98</span><span class="w">                   </span><span class="n">cbw</span><span class="w"></span>
<span class="w">  </span><span class="mi">33</span>:   <span class="mi">40</span><span class="w"> </span><span class="n">f6</span><span class="w"> </span><span class="n">fe</span><span class="w">                </span><span class="n">idiv</span><span class="w">    </span><span class="n">sil</span><span class="w"></span>
<span class="w">  </span><span class="mi">36</span>:   <span class="mi">48</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="n">e8</span><span class="w"> </span><span class="mi">08</span><span class="w">             </span><span class="n">shr</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w">  </span><span class="mi">3</span><span class="n">a</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">ec</span><span class="w">                </span><span class="n">mov</span><span class="w">     </span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="mi">3</span><span class="n">d</span>:   <span class="mi">5</span><span class="n">d</span><span class="w">                      </span><span class="n">pop</span><span class="w">     </span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="mi">3</span><span class="n">e</span>:   <span class="nc">c3</span><span class="w">                      </span><span class="n">ret</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;<br>
</p>
</blockquote>



<a name="316778467"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235470%20Cranelift%3A%20%60srem.i8%60%20giving%20wrong%20.../near/316778467" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235470.20Cranelift.3A.20.60srem.2Ei8.60.20giving.20wrong.20.2E.2E.2E.html#316778467">(Dec 19 2022 at 16:10)</a>:</h4>
<p>afonso360 labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/5470">issue #5470</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>The fuzzer pointed this out when I added <code>srem</code>. This essentially does <code>srem -1, -1</code>, but we get the lhs with a <code>bmask</code>.</p>
<p>Doing a <code>srem</code> with both sides coming from an argument gives the correct result. I think we might be missing some masking on <code>srem</code>. The output of <code>bmask</code> seems correct. (i.e. 255).</p>
<p>This test passes on <code>aarch64</code>, <code>s390x</code> and <code>riscv64</code>.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">interpret</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">run</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">s390x</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">riscv64</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i8</span> <span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i8</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bmask</span><span class="p">.</span><span class="kt">i8</span><span class="w"> </span><span class="n">v0</span><span class="w"></span>
<span class="w">    </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">srem</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="mi">4352</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li><code>clif-util test ./the-above.clif</code></li>
</ul>
<h3>Expected Results</h3>
<p>The test to pass.</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="n">ERROR</span><span class="w"> </span><span class="n">cranelift_filetests</span>::<span class="n">concurrent</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FAIL</span>: <span class="nc">run</span><span class="w"></span>
<span class="n">FAIL</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">test</span><span class="p">.</span><span class="n">clif</span>: <span class="nc">run</span><span class="w"></span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="nc">Failed</span><span class="w"> </span><span class="n">test</span>: <span class="nc">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="mi">4352</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">actual</span>: <span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="mi">1</span><span class="w"> </span><span class="n">tests</span><span class="w"></span>
<span class="n">Error</span>: <span class="mi">1</span><span class="w"> </span><span class="n">failure</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: main<br>
Operating system: Linux<br>
Architecture: x86_64</p>
<h3>Extra Info</h3>
<p>&lt;details&gt;<br>
&lt;summary&gt; Disassembly: <code>cargo run  -- compile --target x86_64  -D ./test.clif</code>&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Disassembly</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">63</span><span class="w"> </span><span class="n">bytes</span>:
   <span class="mi">0</span>:   <span class="mi">55</span><span class="w">                      </span><span class="n">push</span><span class="w">    </span><span class="n">rbp</span><span class="w"></span>
<span class="w">   </span><span class="mi">1</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">e5</span><span class="w">                </span><span class="n">mov</span><span class="w">     </span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="n">rsp</span><span class="w"></span>
<span class="w">   </span><span class="mi">4</span>:   <span class="mi">49</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">fb</span><span class="w">                </span><span class="n">mov</span><span class="w">     </span><span class="n">r11</span><span class="p">,</span><span class="w"> </span><span class="n">rdi</span><span class="w"></span>
<span class="w">   </span><span class="mi">7</span>:   <span class="mi">49</span><span class="w"> </span><span class="n">f7</span><span class="w"> </span><span class="n">db</span><span class="w">                </span><span class="n">neg</span><span class="w">     </span><span class="n">r11</span><span class="w"></span>
<span class="w">   </span><span class="n">a</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">f8</span><span class="w">                </span><span class="n">mov</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">rdi</span><span class="w"></span>
<span class="w">   </span><span class="n">d</span>:   <span class="mi">19</span><span class="w"> </span><span class="n">f8</span><span class="w">                   </span><span class="n">sbb</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">edi</span><span class="w"></span>
<span class="w">   </span><span class="n">f</span>:   <span class="mi">31</span><span class="w"> </span><span class="n">d2</span><span class="w">                   </span><span class="n">xor</span><span class="w">     </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">edx</span><span class="w"></span>
<span class="w">  </span><span class="mi">11</span>:   <span class="mi">40</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="n">fe</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">cmp</span><span class="w">     </span><span class="n">sil</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="mi">15</span>:   <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">85</span><span class="w"> </span><span class="mi">02</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">       </span><span class="n">jne</span><span class="w">     </span><span class="mh">0x1d</span><span class="w"></span>
<span class="w">  </span><span class="mi">1</span><span class="n">b</span>:   <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">0</span><span class="n">b</span><span class="w">                   </span><span class="n">ud2</span><span class="w"></span>
<span class="w">  </span><span class="mi">1</span><span class="n">d</span>:   <span class="mi">40</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="n">fe</span><span class="w"> </span><span class="n">ff</span><span class="w">             </span><span class="n">cmp</span><span class="w">     </span><span class="n">sil</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="w"></span>
<span class="w">  </span><span class="mi">21</span>:   <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">85</span><span class="w"> </span><span class="mi">0</span><span class="n">a</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">       </span><span class="n">jne</span><span class="w">     </span><span class="mh">0x31</span><span class="w"></span>
<span class="w">  </span><span class="mi">27</span>:   <span class="nc">ba</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="n">mov</span><span class="w">     </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="mi">2</span><span class="n">c</span>:   <span class="nc">e9</span><span class="w"> </span><span class="mi">05</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="n">jmp</span><span class="w">     </span><span class="mh">0x36</span><span class="w"></span>
<span class="w">  </span><span class="mi">31</span>:   <span class="mi">66</span><span class="w"> </span><span class="mi">98</span><span class="w">                   </span><span class="n">cbw</span><span class="w"></span>
<span class="w">  </span><span class="mi">33</span>:   <span class="mi">40</span><span class="w"> </span><span class="n">f6</span><span class="w"> </span><span class="n">fe</span><span class="w">                </span><span class="n">idiv</span><span class="w">    </span><span class="n">sil</span><span class="w"></span>
<span class="w">  </span><span class="mi">36</span>:   <span class="mi">48</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="n">e8</span><span class="w"> </span><span class="mi">08</span><span class="w">             </span><span class="n">shr</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w">  </span><span class="mi">3</span><span class="n">a</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">ec</span><span class="w">                </span><span class="n">mov</span><span class="w">     </span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="mi">3</span><span class="n">d</span>:   <span class="mi">5</span><span class="n">d</span><span class="w">                      </span><span class="n">pop</span><span class="w">     </span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="mi">3</span><span class="n">e</span>:   <span class="nc">c3</span><span class="w">                      </span><span class="n">ret</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;<br>
</p>
</blockquote>



<a name="316828467"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235470%20Cranelift%3A%20%60srem.i8%60%20giving%20wrong%20.../near/316828467" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235470.20Cranelift.3A.20.60srem.2Ei8.60.20giving.20wrong.20.2E.2E.2E.html#316828467">(Dec 19 2022 at 20:46)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/issues/5470#issuecomment-1358315876">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5470">issue #5470</a>:</p>
<blockquote>
<p>@cfallin has a guess about this bug: Maybe our x86 lowering of <code>srem.i8</code> is relying on the unspecified high bits in the register. It might need to sign-extend somewhere, or use an 8-bit version of the instruction, if there is one.</p>
</blockquote>



<a name="317608947"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235470%20Cranelift%3A%20%60srem.i8%60%20giving%20wrong%20.../near/317608947" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235470.20Cranelift.3A.20.60srem.2Ei8.60.20giving.20wrong.20.2E.2E.2E.html#317608947">(Dec 23 2022 at 17:03)</a>:</h4>
<p>avanhatt <a href="https://github.com/bytecodealliance/wasmtime/issues/5470#issuecomment-1364118248">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5470">issue #5470</a>:</p>
<blockquote>
<p>@mpardesh and I were looking to see if we could tackle this from the verification side, but we think the relevant logic is all within external constructors' Rust code (rather than the ISLE itself).</p>
<p>From staring at the disassembly for a bit, though, we are wondering if this line is the problem:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">27</span>:   <span class="nc">ba</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="n">mov</span><span class="w">     </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
</code></pre></div>
<p>Which is being generated by [this line][link] in <code>emit.rs</code> in the specific case that the divisor is -1 and we are doing a remainder: </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Inst</span>::<span class="n">imm</span><span class="p">(</span><span class="n">OperandSize</span>::<span class="n">Size64</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Writable</span>::<span class="n">from_reg</span><span class="p">(</span><span class="n">regs</span>::<span class="n">rdx</span><span class="p">()));</span><span class="w"></span>
</code></pre></div>
<p>Should 27 instead write to <code>eax</code> instead of <code>edx</code> in this case?</p>
<p>In particular, next instruction after 27 is an unconditional jump to the following, which uses <code>rax</code> and seems to leave the results of <code>edx</code> unused (granted, it's been a while since I started at x86 disassembly, so we could totally be missing an implicit register use). </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="mi">36</span>:   <span class="mi">48</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="n">e8</span><span class="w"> </span><span class="mi">08</span><span class="w">             </span><span class="n">shr</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w">  </span><span class="mi">3</span><span class="n">a</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">ec</span><span class="w">                </span><span class="n">mov</span><span class="w">     </span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="mi">3</span><span class="n">d</span>:   <span class="mi">5</span><span class="n">d</span><span class="w">                      </span><span class="n">pop</span><span class="w">     </span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="mi">3</span><span class="n">e</span>:   <span class="nc">c3</span><span class="w">                      </span><span class="n">ret</span><span class="w"></span>
</code></pre></div>
<p>[link]: <a href="https://github.com/bytecodealliance/wasmtime/blob/ff995d910b64ea7937ccfd982dd431b1487a1ec8/cranelift/codegen/src/isa/x64/inst/emit.rs#L549">https://github.com/bytecodealliance/wasmtime/blob/ff995d910b64ea7937ccfd982dd431b1487a1ec8/cranelift/codegen/src/isa/x64/inst/emit.rs#L549</a></p>
</blockquote>



<a name="318508306"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235470%20Cranelift%3A%20%60srem.i8%60%20giving%20wrong%20.../near/318508306" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235470.20Cranelift.3A.20.60srem.2Ei8.60.20giving.20wrong.20.2E.2E.2E.html#318508306">(Dec 30 2022 at 01:10)</a>:</h4>
<p>mpardesh <a href="https://github.com/bytecodealliance/wasmtime/issues/5470#issuecomment-1367671109">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5470">issue #5470</a>:</p>
<blockquote>
<p>While we were staring at <code>idiv</code>, we were wondering if division by 8 bit values is handled correctly. If the divisor is 8 bits long, <code>idiv</code> should not modify <code>rdx</code> at all and should only place results in <code>ax</code>. We dug into the code a bit but not deeply enough to really understand how 8 bit division works.</p>
<p>(this is probably unrelated to the bug, but we thought it might be worth checking anyway)</p>
</blockquote>



<a name="319872821"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235470%20Cranelift%3A%20%60srem.i8%60%20giving%20wrong%20.../near/319872821" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235470.20Cranelift.3A.20.60srem.2Ei8.60.20giving.20wrong.20.2E.2E.2E.html#319872821">(Jan 06 2023 at 22:18)</a>:</h4>
<p>jameysharp closed <a href="https://github.com/bytecodealliance/wasmtime/issues/5470">issue #5470</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>The fuzzer pointed this out when I added <code>srem</code>. This essentially does <code>srem -1, -1</code>, but we get the lhs with a <code>bmask</code>.</p>
<p>Doing a <code>srem</code> with both sides coming from an argument gives the correct result. I think we might be missing some masking on <code>srem</code>. The output of <code>bmask</code> seems correct. (i.e. 255).</p>
<p>This test passes on <code>aarch64</code>, <code>s390x</code> and <code>riscv64</code>.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">interpret</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">run</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">s390x</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">riscv64</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i8</span> <span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i8</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bmask</span><span class="p">.</span><span class="kt">i8</span><span class="w"> </span><span class="n">v0</span><span class="w"></span>
<span class="w">    </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">srem</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="mi">4352</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li><code>clif-util test ./the-above.clif</code></li>
</ul>
<h3>Expected Results</h3>
<p>The test to pass.</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="n">ERROR</span><span class="w"> </span><span class="n">cranelift_filetests</span>::<span class="n">concurrent</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FAIL</span>: <span class="nc">run</span><span class="w"></span>
<span class="n">FAIL</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">test</span><span class="p">.</span><span class="n">clif</span>: <span class="nc">run</span><span class="w"></span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="nc">Failed</span><span class="w"> </span><span class="n">test</span>: <span class="nc">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="mi">4352</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">actual</span>: <span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="mi">1</span><span class="w"> </span><span class="n">tests</span><span class="w"></span>
<span class="n">Error</span>: <span class="mi">1</span><span class="w"> </span><span class="n">failure</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: main<br>
Operating system: Linux<br>
Architecture: x86_64</p>
<h3>Extra Info</h3>
<p>&lt;details&gt;<br>
&lt;summary&gt; Disassembly: <code>cargo run  -- compile --target x86_64  -D ./test.clif</code>&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Disassembly</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">63</span><span class="w"> </span><span class="n">bytes</span>:
   <span class="mi">0</span>:   <span class="mi">55</span><span class="w">                      </span><span class="n">push</span><span class="w">    </span><span class="n">rbp</span><span class="w"></span>
<span class="w">   </span><span class="mi">1</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">e5</span><span class="w">                </span><span class="n">mov</span><span class="w">     </span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="n">rsp</span><span class="w"></span>
<span class="w">   </span><span class="mi">4</span>:   <span class="mi">49</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">fb</span><span class="w">                </span><span class="n">mov</span><span class="w">     </span><span class="n">r11</span><span class="p">,</span><span class="w"> </span><span class="n">rdi</span><span class="w"></span>
<span class="w">   </span><span class="mi">7</span>:   <span class="mi">49</span><span class="w"> </span><span class="n">f7</span><span class="w"> </span><span class="n">db</span><span class="w">                </span><span class="n">neg</span><span class="w">     </span><span class="n">r11</span><span class="w"></span>
<span class="w">   </span><span class="n">a</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">f8</span><span class="w">                </span><span class="n">mov</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">rdi</span><span class="w"></span>
<span class="w">   </span><span class="n">d</span>:   <span class="mi">19</span><span class="w"> </span><span class="n">f8</span><span class="w">                   </span><span class="n">sbb</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">edi</span><span class="w"></span>
<span class="w">   </span><span class="n">f</span>:   <span class="mi">31</span><span class="w"> </span><span class="n">d2</span><span class="w">                   </span><span class="n">xor</span><span class="w">     </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">edx</span><span class="w"></span>
<span class="w">  </span><span class="mi">11</span>:   <span class="mi">40</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="n">fe</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">cmp</span><span class="w">     </span><span class="n">sil</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="mi">15</span>:   <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">85</span><span class="w"> </span><span class="mi">02</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">       </span><span class="n">jne</span><span class="w">     </span><span class="mh">0x1d</span><span class="w"></span>
<span class="w">  </span><span class="mi">1</span><span class="n">b</span>:   <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">0</span><span class="n">b</span><span class="w">                   </span><span class="n">ud2</span><span class="w"></span>
<span class="w">  </span><span class="mi">1</span><span class="n">d</span>:   <span class="mi">40</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="n">fe</span><span class="w"> </span><span class="n">ff</span><span class="w">             </span><span class="n">cmp</span><span class="w">     </span><span class="n">sil</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="w"></span>
<span class="w">  </span><span class="mi">21</span>:   <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">85</span><span class="w"> </span><span class="mi">0</span><span class="n">a</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">       </span><span class="n">jne</span><span class="w">     </span><span class="mh">0x31</span><span class="w"></span>
<span class="w">  </span><span class="mi">27</span>:   <span class="nc">ba</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="n">mov</span><span class="w">     </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="mi">2</span><span class="n">c</span>:   <span class="nc">e9</span><span class="w"> </span><span class="mi">05</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="n">jmp</span><span class="w">     </span><span class="mh">0x36</span><span class="w"></span>
<span class="w">  </span><span class="mi">31</span>:   <span class="mi">66</span><span class="w"> </span><span class="mi">98</span><span class="w">                   </span><span class="n">cbw</span><span class="w"></span>
<span class="w">  </span><span class="mi">33</span>:   <span class="mi">40</span><span class="w"> </span><span class="n">f6</span><span class="w"> </span><span class="n">fe</span><span class="w">                </span><span class="n">idiv</span><span class="w">    </span><span class="n">sil</span><span class="w"></span>
<span class="w">  </span><span class="mi">36</span>:   <span class="mi">48</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="n">e8</span><span class="w"> </span><span class="mi">08</span><span class="w">             </span><span class="n">shr</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w">  </span><span class="mi">3</span><span class="n">a</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">ec</span><span class="w">                </span><span class="n">mov</span><span class="w">     </span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="mi">3</span><span class="n">d</span>:   <span class="mi">5</span><span class="n">d</span><span class="w">                      </span><span class="n">pop</span><span class="w">     </span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="mi">3</span><span class="n">e</span>:   <span class="nc">c3</span><span class="w">                      </span><span class="n">ret</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;<br>
</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>