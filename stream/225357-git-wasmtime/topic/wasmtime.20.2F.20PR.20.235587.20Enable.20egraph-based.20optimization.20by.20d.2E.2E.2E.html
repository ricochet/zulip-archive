<html>
<head><meta charset="utf-8"><title>wasmtime / PR #5587 Enable egraph-based optimization by d... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235587.20Enable.20egraph-based.20optimization.20by.20d.2E.2E.2E.html">wasmtime / PR #5587 Enable egraph-based optimization by d...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="321962124"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235587%20Enable%20egraph-based%20optimization%20by%20d.../near/321962124" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235587.20Enable.20egraph-based.20optimization.20by.20d.2E.2E.2E.html#321962124">(Jan 18 2023 at 02:08)</a>:</h4>
<p>cfallin opened <a href="https://github.com/bytecodealliance/wasmtime/pull/5587">PR #5587</a> from <code>enable-egraphs</code> to <code>main</code>:</p>
<blockquote>
<p>This PR follows up on #5382 and #5391, which rebuilt the egraph-based optimization framework to be more performant, by enabling it by default.</p>
<p>Based on performance results in #5382 (my measurements on SpiderMonkey and bjorn3's independent confirmation with cg_clif), it seems that this is reasonable to enable. Now that we have been fuzzing compiler configurations with egraph opts (#5388) for 6 weeks, having fixed a few fuzzbugs that came up (#5409, #5420, #5438) and subsequently received no further reports from OSS-Fuzz, I believe it is stable enough to rely on.</p>
<p>This PR enables <code>use_egraphs</code>, and also normalizes its meaning: previously it forced optimization (it basically meant "turn on the egraph optimization machinery"), now it runs egraph opts if the opt level indicates (it means "use egraphs to optimize if we are going to optimize"). The conditionals in the top-level pass driver are a little subtle, but will get simpler once we can remove the non-egraph path (which we plan to do eventually!).</p>
</blockquote>



<a name="321962125"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235587%20Enable%20egraph-based%20optimization%20by%20d.../near/321962125" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235587.20Enable.20egraph-based.20optimization.20by.20d.2E.2E.2E.html#321962125">(Jan 18 2023 at 02:08)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/elliottt">elliottt</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/5587">PR #5587</a>.</p>



<a name="321962126"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235587%20Enable%20egraph-based%20optimization%20by%20d.../near/321962126" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235587.20Enable.20egraph-based.20optimization.20by.20d.2E.2E.2E.html#321962126">(Jan 18 2023 at 02:08)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/5587">PR #5587</a>.</p>



<a name="321962127"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235587%20Enable%20egraph-based%20optimization%20by%20d.../near/321962127" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235587.20Enable.20egraph-based.20optimization.20by.20d.2E.2E.2E.html#321962127">(Jan 18 2023 at 02:08)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/jameysharp">jameysharp</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/5587">PR #5587</a>.</p>



<a name="321965988"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235587%20Enable%20egraph-based%20optimization%20by%20d.../near/321965988" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235587.20Enable.20egraph-based.20optimization.20by.20d.2E.2E.2E.html#321965988">(Jan 18 2023 at 03:04)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5587">PR #5587</a> from <code>enable-egraphs</code> to <code>main</code>.</p>



<a name="321992240"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235587%20Enable%20egraph-based%20optimization%20by%20d.../near/321992240" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235587.20Enable.20egraph-based.20optimization.20by.20d.2E.2E.2E.html#321992240">(Jan 18 2023 at 08:02)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5587">PR #5587</a> from <code>enable-egraphs</code> to <code>main</code>.</p>



<a name="322105489"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235587%20Enable%20egraph-based%20optimization%20by%20d.../near/322105489" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235587.20Enable.20egraph-based.20optimization.20by.20d.2E.2E.2E.html#322105489">(Jan 18 2023 at 17:08)</a>:</h4>
<p>fitzgen edited <a href="https://github.com/bytecodealliance/wasmtime/pull/5587">PR #5587</a> from <code>enable-egraphs</code> to <code>main</code>:</p>
<blockquote>
<p>This PR follows up on #5382 and #5391, which rebuilt the egraph-based optimization framework to be more performant, by enabling it by default.</p>
<p>Based on performance results in #5382 (my measurements on SpiderMonkey and bjorn3's independent confirmation with cg_clif), it seems that this is reasonable to enable. Now that we have been fuzzing compiler configurations with egraph opts (#5388) for 6 weeks, having fixed a few fuzzbugs that came up (#5409, #5420, #5438) and subsequently received no further reports from OSS-Fuzz, I believe it is stable enough to rely on.</p>
<p>This PR enables <code>use_egraphs</code>, and also normalizes its meaning: previously it forced optimization (it basically meant "turn on the egraph optimization machinery"), now it runs egraph opts if the opt level indicates (it means "use egraphs to optimize if we are going to optimize"). The conditionals in the top-level pass driver are a little subtle, but will get simpler once we can remove the non-egraph path (which we plan to do eventually!).</p>
<p>Fixes <a href="https://github.com/bytecodealliance/wasmtime/issues/5181">https://github.com/bytecodealliance/wasmtime/issues/5181</a></p>
</blockquote>



<a name="322367099"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235587%20Enable%20egraph-based%20optimization%20by%20d.../near/322367099" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235587.20Enable.20egraph-based.20optimization.20by.20d.2E.2E.2E.html#322367099">(Jan 19 2023 at 19:59)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5587">PR #5587</a> from <code>enable-egraphs</code> to <code>main</code>.</p>



<a name="322367136"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235587%20Enable%20egraph-based%20optimization%20by%20d.../near/322367136" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235587.20Enable.20egraph-based.20optimization.20by.20d.2E.2E.2E.html#322367136">(Jan 19 2023 at 19:59)</a>:</h4>
<p><strong>cfallin</strong> has marked <a href="https://github.com/bytecodealliance/wasmtime/pull/5587">PR #5587</a> as ready for review.</p>



<a name="322373930"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235587%20Enable%20egraph-based%20optimization%20by%20d.../near/322373930" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235587.20Enable.20egraph-based.20optimization.20by.20d.2E.2E.2E.html#322373930">(Jan 19 2023 at 20:36)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5587">PR #5587</a> from <code>enable-egraphs</code> to <code>main</code>.</p>



<a name="322390859"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235587%20Enable%20egraph-based%20optimization%20by%20d.../near/322390859" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235587.20Enable.20egraph-based.20optimization.20by.20d.2E.2E.2E.html#322390859">(Jan 19 2023 at 22:21)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5587#pullrequestreview-1262717333">PR review</a>.</p>



<a name="322390860"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235587%20Enable%20egraph-based%20optimization%20by%20d.../near/322390860" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235587.20Enable.20egraph-based.20optimization.20by.20d.2E.2E.2E.html#322390860">(Jan 19 2023 at 22:21)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5587#pullrequestreview-1262717333">PR review</a>.</p>



<a name="322390861"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235587%20Enable%20egraph-based%20optimization%20by%20d.../near/322390861" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235587.20Enable.20egraph-based.20optimization.20by.20d.2E.2E.2E.html#322390861">(Jan 19 2023 at 22:21)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/5587#discussion_r1081931184">PR review comment</a>:</p>
<blockquote>
<p>You can add</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[deprecated(since=</span><span class="s">"5.0.0"</span><span class="cp">, note=</span><span class="s">"egraphs will be the default and this method will be removed in a future version"</span><span class="cp">)]</span><span class="w"></span>
</code></pre></div>
<p>to get <code>rustc</code> to understand the deprecation and emit a warning as well.</p>
</blockquote>



<a name="322390862"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235587%20Enable%20egraph-based%20optimization%20by%20d.../near/322390862" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235587.20Enable.20egraph-based.20optimization.20by.20d.2E.2E.2E.html#322390862">(Jan 19 2023 at 22:21)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/5587#discussion_r1081929669">PR review comment</a>:</p>
<blockquote>
<p>For this test, and the other in this commit, I think we do want to enable egraphs (or at least use the default setting). The point of these tests is to make sure that we deduplicate the loads by default, not to exercise a particular pass.</p>
</blockquote>



<a name="322392042"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235587%20Enable%20egraph-based%20optimization%20by%20d.../near/322392042" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235587.20Enable.20egraph-based.20optimization.20by.20d.2E.2E.2E.html#322392042">(Jan 19 2023 at 22:29)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5587#pullrequestreview-1262727646">PR review</a>.</p>



<a name="322392043"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235587%20Enable%20egraph-based%20optimization%20by%20d.../near/322392043" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235587.20Enable.20egraph-based.20optimization.20by.20d.2E.2E.2E.html#322392043">(Jan 19 2023 at 22:29)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5587#discussion_r1081937112">PR review comment</a>:</p>
<blockquote>
<p>Indeed; this test and the corresponding static case were actually duplicated in #5594 to <code>-egraph.wat</code> copies of the files, with egraphs enabled. The point here is to keep coverage for both cases, until we delete the non-egraphs case.</p>
</blockquote>



<a name="322392444"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235587%20Enable%20egraph-based%20optimization%20by%20d.../near/322392444" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235587.20Enable.20egraph-based.20optimization.20by.20d.2E.2E.2E.html#322392444">(Jan 19 2023 at 22:32)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5587">PR #5587</a> from <code>enable-egraphs</code> to <code>main</code>.</p>



<a name="322392462"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235587%20Enable%20egraph-based%20optimization%20by%20d.../near/322392462" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235587.20Enable.20egraph-based.20optimization.20by.20d.2E.2E.2E.html#322392462">(Jan 19 2023 at 22:32)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5587#pullrequestreview-1262732795">PR review</a>.</p>



<a name="322392466"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235587%20Enable%20egraph-based%20optimization%20by%20d.../near/322392466" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235587.20Enable.20egraph-based.20optimization.20by.20d.2E.2E.2E.html#322392466">(Jan 19 2023 at 22:32)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5587#discussion_r1081939260">PR review comment</a>:</p>
<blockquote>
<p>Ah,nice, done!</p>
</blockquote>



<a name="322396928"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235587%20Enable%20egraph-based%20optimization%20by%20d.../near/322396928" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235587.20Enable.20egraph-based.20optimization.20by.20d.2E.2E.2E.html#322396928">(Jan 19 2023 at 23:01)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5587">PR #5587</a> from <code>enable-egraphs</code> to <code>main</code>.</p>



<a name="322402260"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235587%20Enable%20egraph-based%20optimization%20by%20d.../near/322402260" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235587.20Enable.20egraph-based.20optimization.20by.20d.2E.2E.2E.html#322402260">(Jan 19 2023 at 23:46)</a>:</h4>
<p>cfallin merged <a href="https://github.com/bytecodealliance/wasmtime/pull/5587">PR #5587</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>