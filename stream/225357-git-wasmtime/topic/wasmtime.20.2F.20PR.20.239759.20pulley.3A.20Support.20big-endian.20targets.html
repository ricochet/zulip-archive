<html>
<head><meta charset="utf-8"><title>wasmtime / PR #9759 pulley: Support big-endian targets · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239759.20pulley.3A.20Support.20big-endian.20targets.html">wasmtime / PR #9759 pulley: Support big-endian targets</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="486593115"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239759%20pulley%3A%20Support%20big-endian%20targets/near/486593115" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239759.20pulley.3A.20Support.20big-endian.20targets.html#486593115">(Dec 06 2024 at 20:55)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9759">PR #9759</a>.</p>



<a name="486593119"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239759%20pulley%3A%20Support%20big-endian%20targets/near/486593119" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239759.20pulley.3A.20Support.20big-endian.20targets.html#486593119">(Dec 06 2024 at 20:55)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9759">PR #9759</a>.</p>



<a name="486593120"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239759%20pulley%3A%20Support%20big-endian%20targets/near/486593120" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239759.20pulley.3A.20Support.20big-endian.20targets.html#486593120">(Dec 06 2024 at 20:55)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers">wasmtime-default-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9759">PR #9759</a>.</p>



<a name="486593121"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239759%20pulley%3A%20Support%20big-endian%20targets/near/486593121" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239759.20pulley.3A.20Support.20big-endian.20targets.html#486593121">(Dec 06 2024 at 20:55)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9759">PR #9759</a>.</p>



<a name="486593122"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239759%20pulley%3A%20Support%20big-endian%20targets/near/486593122" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239759.20pulley.3A.20Support.20big-endian.20targets.html#486593122">(Dec 06 2024 at 20:55)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/9759">PR #9759</a> from <code>alexcrichton:pulley-big-endian</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This commit fixes the Pulley interpreter and Cranelift backend to properly support big-endian targets. The problem beforehand was that loads/stores in Pulley were defined as the native endianness which means that big and little-endian platforms differed. Additionally the previously set of understood pulley targets were implicitly always little-endian which was not appropriate for a big-endian host where JIT data structures are stored in big-endian format.</p>
<p>This commit fixes all of these issues with a few changes:</p>
<ul>
<li>Pulley loads/stores are always little-endian now.</li>
<li>Pulley now has bswap32/bswap64 instructions.</li>
<li>Wasmtime/Cranelift now understand big-endian pulley targets (e.g. <code>pulley32be</code>).</li>
<li>CLIF translation of loads/stores now properly handles the endianness flags on <code>MemFlags</code>.</li>
</ul>
<p>In the future if necessary we could natively add a macro-op for big-endian loads/stores to Pulley but for now it's more minimal to just have <code>bswap32</code> and <code>bswap64</code>.</p>
<p>The result of this commit is that Pulley tests are now run and executed on s390x like all other platforms.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="486593213"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239759%20pulley%3A%20Support%20big-endian%20targets/near/486593213" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239759.20pulley.3A.20Support.20big-endian.20targets.html#486593213">(Dec 06 2024 at 20:56)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/9759#issuecomment-2524161490">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9759">PR #9759</a>:</p>
<blockquote>
<p>While this doesn't code-wise depend on <a href="https://github.com/bytecodealliance/wasmtime/pull/9758">https://github.com/bytecodealliance/wasmtime/pull/9758</a> it test-wise depends on that PR as otherwise unwinding doesn't actually work on s390x. With both PRs, however, tests pass for Pulley.</p>
</blockquote>



<a name="486595977"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239759%20pulley%3A%20Support%20big-endian%20targets/near/486595977" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239759.20pulley.3A.20Support.20big-endian.20targets.html#486595977">(Dec 06 2024 at 21:17)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9759">PR #9759</a>.</p>



<a name="486603479"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239759%20pulley%3A%20Support%20big-endian%20targets/near/486603479" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239759.20pulley.3A.20Support.20big-endian.20targets.html#486603479">(Dec 06 2024 at 22:21)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9759#pullrequestreview-2485998091">PR review</a>:</p>
<blockquote>
<p>r=me with the two below suggestions</p>
</blockquote>



<a name="486603480"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239759%20pulley%3A%20Support%20big-endian%20targets/near/486603480" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239759.20pulley.3A.20Support.20big-endian.20targets.html#486603480">(Dec 06 2024 at 22:21)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/9759#discussion_r1874053592">PR review comment</a>:</p>
<blockquote>
<p>Can we instead have a pure constructor like</p>
<div class="codehilite" data-code-language="Common Lisp"><pre><span></span><code><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="nv">Endian</span><span class="w"> </span><span class="p">(</span><span class="nv">enum</span><span class="w"> </span><span class="nv">Little</span><span class="w"> </span><span class="nv">Big</span><span class="p">))</span>

<span class="p">(</span><span class="nv">decl</span><span class="w"> </span><span class="nv">endian</span><span class="w"> </span><span class="p">(</span><span class="nv">MemFlags</span><span class="p">)</span><span class="w"> </span><span class="nv">Endian</span><span class="p">)</span>
<span class="p">(</span><span class="nv">extern</span><span class="w"> </span><span class="nv">pure</span><span class="w"> </span><span class="nv">constructor</span><span class="w"> </span><span class="nv">endian</span><span class="w"> </span><span class="nv">endian</span><span class="p">)</span>
</code></pre></div>
</blockquote>



<a name="486603481"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239759%20pulley%3A%20Support%20big-endian%20targets/near/486603481" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239759.20pulley.3A.20Support.20big-endian.20targets.html#486603481">(Dec 06 2024 at 22:21)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/9759#discussion_r1874055829">PR review comment</a>:</p>
<blockquote>
<p>... which we can then use like</p>
<div class="codehilite" data-code-language="suggestion"><pre><span></span><code>(decl xswap_if_be (XReg Type MemFlags) XReg)
(rule 0 (xswap_if_be val _ty flags)
      (if-let (endian flags) (Endian.Little))
      val)
(rule 1 (xswap_if_be val $I32 flags)
      (if-let (endian flags) (Endian.Big))
      (pulley_bswap32 val))
(rule 1 (xswap_if_be val $I64 flags)
      (if-let (endian flags) (Endian.Big))
      (pulley_bswap64 val))
</code></pre></div>
<p>and I think we could remove the explicit priorities at that point because isle's overlap checking would be able to see that the rules do not overlap, which would also result in better isle-generated rust code.</p>
</blockquote>



<a name="486603482"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239759%20pulley%3A%20Support%20big-endian%20targets/near/486603482" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239759.20pulley.3A.20Support.20big-endian.20targets.html#486603482">(Dec 06 2024 at 22:21)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/9759#discussion_r1874057657">PR review comment</a>:</p>
<blockquote>
<p>Want to move these to extended ops? I doubt they will be common.</p>
</blockquote>



<a name="486605137"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239759%20pulley%3A%20Support%20big-endian%20targets/near/486605137" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239759.20pulley.3A.20Support.20big-endian.20targets.html#486605137">(Dec 06 2024 at 22:37)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9759">PR #9759</a>.</p>



<a name="486605192"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239759%20pulley%3A%20Support%20big-endian%20targets/near/486605192" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239759.20pulley.3A.20Support.20big-endian.20targets.html#486605192">(Dec 06 2024 at 22:37)</a>:</h4>
<p>alexcrichton has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/9759">PR #9759</a>.</p>



<a name="486605526"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239759%20pulley%3A%20Support%20big-endian%20targets/near/486605526" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239759.20pulley.3A.20Support.20big-endian.20targets.html#486605526">(Dec 06 2024 at 22:40)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9759">PR #9759</a>.</p>



<a name="486608785"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239759%20pulley%3A%20Support%20big-endian%20targets/near/486608785" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239759.20pulley.3A.20Support.20big-endian.20targets.html#486608785">(Dec 06 2024 at 23:14)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/9759">PR #9759</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>