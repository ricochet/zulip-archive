<html>
<head><meta charset="utf-8"><title>wasmtime / PR #8811 Skip GC LIFO scope creation on some h... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238811.20Skip.20GC.20LIFO.20scope.20creation.20on.20some.20h.2E.2E.2E.html">wasmtime / PR #8811 Skip GC LIFO scope creation on some h...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="444776150"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238811%20Skip%20GC%20LIFO%20scope%20creation%20on%20some%20h.../near/444776150" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238811.20Skip.20GC.20LIFO.20scope.20creation.20on.20some.20h.2E.2E.2E.html#444776150">(Jun 14 2024 at 19:43)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/8811">PR #8811</a> from <code>alexcrichton:no-gc-scope-without-gc-values</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This commit skips the creation of a LIFO scope for GC <code>Rooted&lt;T&gt;</code> values for hostcalls using statically typed arguments/results (e.g. <code>Func::wrap</code>) where none of the arguments/results have GC values. This removes the last bit of "GC business" on <code>Func::wrap</code> calls that don't do anything related to GC.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="444776154"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238811%20Skip%20GC%20LIFO%20scope%20creation%20on%20some%20h.../near/444776154" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238811.20Skip.20GC.20LIFO.20scope.20creation.20on.20some.20h.2E.2E.2E.html#444776154">(Jun 14 2024 at 19:43)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8811">PR #8811</a>.</p>



<a name="444776155"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238811%20Skip%20GC%20LIFO%20scope%20creation%20on%20some%20h.../near/444776155" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238811.20Skip.20GC.20LIFO.20scope.20creation.20on.20some.20h.2E.2E.2E.html#444776155">(Jun 14 2024 at 19:43)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8811">PR #8811</a>.</p>



<a name="444777953"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238811%20Skip%20GC%20LIFO%20scope%20creation%20on%20some%20h.../near/444777953" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238811.20Skip.20GC.20LIFO.20scope.20creation.20on.20some.20h.2E.2E.2E.html#444777953">(Jun 14 2024 at 19:55)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8811#pullrequestreview-2119153722">PR review</a>.</p>



<a name="444777954"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238811%20Skip%20GC%20LIFO%20scope%20creation%20on%20some%20h.../near/444777954" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238811.20Skip.20GC.20LIFO.20scope.20creation.20on.20some.20h.2E.2E.2E.html#444777954">(Jun 14 2024 at 19:55)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8811#pullrequestreview-2119153722">PR review</a>.</p>



<a name="444777956"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238811%20Skip%20GC%20LIFO%20scope%20creation%20on%20some%20h.../near/444777956" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238811.20Skip.20GC.20LIFO.20scope.20creation.20on.20some.20h.2E.2E.2E.html#444777956">(Jun 14 2024 at 19:55)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8811#discussion_r1640280312">PR review comment</a>:</p>
<blockquote>
<p>I think this could actually be bad: if I define a host call with only integer params and results, but then create an <code>externref</code> inside it[^0], then that <code>externref</code> will be rooted in the outer LIFO scope, rather than just being rooted in the <code>Caller</code>'s scope, which is probably the store's scope. That means the <code>externref</code> is going to leak for the whole extent of the program. So I don't think we can actually do this.</p>
<p>Is <a href="https://github.com/bytecodealliance/wasmtime/blob/9ffc9e67f6c19b8a3a80a4bd31aac8a08e628d3f/crates/wasmtime/src/runtime/gc/enabled/rooting.rs#L409">reading a vec's length</a> and then later <a href="https://github.com/bytecodealliance/wasmtime/blob/9ffc9e67f6c19b8a3a80a4bd31aac8a08e628d3f/crates/wasmtime/src/runtime/gc/enabled/rooting.rs#L420-L427">a well-predicted compare-and-branch to out-of-line code</a> really that expensive?</p>
<p>[^0]: Maybe I then re-entrantly call some other Wasm export, giving it that <code>externref</code>. Doesn't really matter <em>why</em> I did it, just that I did it.</p>
</blockquote>



<a name="444791785"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238811%20Skip%20GC%20LIFO%20scope%20creation%20on%20some%20h.../near/444791785" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238811.20Skip.20GC.20LIFO.20scope.20creation.20on.20some.20h.2E.2E.2E.html#444791785">(Jun 14 2024 at 21:20)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8811#pullrequestreview-2119320805">PR review</a>.</p>



<a name="444791786"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238811%20Skip%20GC%20LIFO%20scope%20creation%20on%20some%20h.../near/444791786" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238811.20Skip.20GC.20LIFO.20scope.20creation.20on.20some.20h.2E.2E.2E.html#444791786">(Jun 14 2024 at 21:20)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/8811#discussion_r1640365309">PR review comment</a>:</p>
<blockquote>
<p>My thinking was that it's still safe in that case, right? It means it'll be rooted long but a manual rooting scope can always be created to avoid that.</p>
<p>Perf-wise this was locally showing a 40% perf improvement but I cannot reproduce it against the latest <code>main</code>. Turns out that I was testing before #8806 landed, and now that that PR has landed this PR is largely perf-neutral. The benchmark here is pretty micro-benchmark-y but at the same time I think it's a nice feature of Wasmtime that the overhead for calling the host is as low as possible, so cleaning up the assembly as much as we can I think is reasonable.</p>
</blockquote>



<a name="444792108"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238811%20Skip%20GC%20LIFO%20scope%20creation%20on%20some%20h.../near/444792108" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238811.20Skip.20GC.20LIFO.20scope.20creation.20on.20some.20h.2E.2E.2E.html#444792108">(Jun 14 2024 at 21:23)</a>:</h4>
<p>alexcrichton edited <a href="https://github.com/bytecodealliance/wasmtime/pull/8811#discussion_r1640365309">PR review comment</a>.</p>



<a name="444792671"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238811%20Skip%20GC%20LIFO%20scope%20creation%20on%20some%20h.../near/444792671" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238811.20Skip.20GC.20LIFO.20scope.20creation.20on.20some.20h.2E.2E.2E.html#444792671">(Jun 14 2024 at 21:27)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8811#pullrequestreview-2119340911">PR review</a>.</p>



<a name="444792673"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238811%20Skip%20GC%20LIFO%20scope%20creation%20on%20some%20h.../near/444792673" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238811.20Skip.20GC.20LIFO.20scope.20creation.20on.20some.20h.2E.2E.2E.html#444792673">(Jun 14 2024 at 21:27)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8811#discussion_r1640370813">PR review comment</a>:</p>
<blockquote>
<blockquote>
<p>it's a nice feature of Wasmtime that the overhead for calling the host is as low as possible, so cleaning up the assembly as much as we can I think is reasonable.</p>
</blockquote>
<p>Agreed in general.</p>
<blockquote>
<p>My thinking was that it's still safe in that case, right? It means it'll be rooted longer but a manual rooting scope can always be created to avoid that.</p>
</blockquote>
<p>It is memory safe, yes, but it is a fairly big footgun, IMO. At minimum, we would need to be very clear about when a <code>Caller</code> is vs. isn't a rooting scope in our existing docs around rooting and scopes (I think on <code>Rooted</code>? maybe on <code>RootScope</code>? I forget)</p>
<p>But if this isn't a perf win anymore, then is it really worth adding the footgun?</p>
</blockquote>



<a name="445024259"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238811%20Skip%20GC%20LIFO%20scope%20creation%20on%20some%20h.../near/445024259" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238811.20Skip.20GC.20LIFO.20scope.20creation.20on.20some.20h.2E.2E.2E.html#445024259">(Jun 16 2024 at 21:59)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8811#pullrequestreview-2121608663">PR review</a>.</p>



<a name="445024263"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238811%20Skip%20GC%20LIFO%20scope%20creation%20on%20some%20h.../near/445024263" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238811.20Skip.20GC.20LIFO.20scope.20creation.20on.20some.20h.2E.2E.2E.html#445024263">(Jun 16 2024 at 21:59)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/8811#discussion_r1641991044">PR review comment</a>:</p>
<blockquote>
<p>Ok I think that's reasonable yeah. I'll close this and we can revisit if it ever becomes necessary but that seems unlikely too.</p>
</blockquote>



<a name="445024276"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238811%20Skip%20GC%20LIFO%20scope%20creation%20on%20some%20h.../near/445024276" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238811.20Skip.20GC.20LIFO.20scope.20creation.20on.20some.20h.2E.2E.2E.html#445024276">(Jun 16 2024 at 21:59)</a>:</h4>
<p>alexcrichton closed without merge <a href="https://github.com/bytecodealliance/wasmtime/pull/8811">PR #8811</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>