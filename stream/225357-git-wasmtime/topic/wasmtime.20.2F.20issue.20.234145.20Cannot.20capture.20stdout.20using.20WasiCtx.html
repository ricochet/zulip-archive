<html>
<head><meta charset="utf-8"><title>wasmtime / issue #4145 Cannot capture stdout using WasiCtx · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234145.20Cannot.20capture.20stdout.20using.20WasiCtx.html">wasmtime / issue #4145 Cannot capture stdout using WasiCtx</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="282118065"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234145%20Cannot%20capture%20stdout%20using%20WasiCtx/near/282118065" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234145.20Cannot.20capture.20stdout.20using.20WasiCtx.html#282118065">(May 12 2022 at 14:54)</a>:</h4>
<p>jlkiri opened <a href="https://github.com/bytecodealliance/wasmtime/issues/4145">issue #4145</a>:</p>
<blockquote>
<p>If I understand correctly, <code>stdout</code> method on <code>WasiCtxBuilder</code> can be used to set what the instance will treat as stdout. This something needs to implement <code>WasiFile</code> trait and I discovered that <code>File</code> from <code>cap-std</code> create implements it. It also allows creating cap-std-files from usual std files. I guessed that I can then created a usual file, and then through some conversions turn it into a <code>WasiCtxBuilder</code>-usable stdout target. Since all these methods own the file, I obtain the raw fd which I then use to open the file again and read its contents. However it appears to be empty, although I do print text in the Rust program compiled to wasm. Note that the execution itself is successful - I just don't see any side effects. Here's the code that I compile to wasm:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Hello"</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>and here's what I use to execute it in wasmtime:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">wasm_execute</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">engine</span>: <span class="kp">&amp;</span><span class="nc">wasmtime</span>::<span class="n">Engine</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">module_path</span>: <span class="nc">impl</span><span class="w"> </span><span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">anyhow</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">cap_std</span>::<span class="n">fs</span>::<span class="n">File</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">CapStdFile</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">wasmtime_wasi</span>::<span class="p">{</span><span class="n">add_to_linker</span><span class="p">,</span><span class="w"> </span><span class="n">sync</span>::<span class="n">file</span>::<span class="n">File</span><span class="p">,</span><span class="w"> </span><span class="n">WasiCtxBuilder</span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span>::<span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">module_path</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tmpfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tempfile</span>::<span class="n">tempfile</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tmpfile_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmpfile</span><span class="p">.</span><span class="n">as_raw_fd</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">cap_std_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CapStdFile</span>::<span class="n">from_std</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">stdout_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span>::<span class="n">from_cap_std</span><span class="p">(</span><span class="n">cap_std_file</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasiCtxBuilder</span>::<span class="n">new</span><span class="p">().</span><span class="n">stdout</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">stdout_file</span><span class="p">)).</span><span class="n">build</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">store_limits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StoreLimits</span>::<span class="n">default</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">wasi</span><span class="p">,</span><span class="w"> </span><span class="n">store_limits</span><span class="w"> </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="p">.</span><span class="n">limiter</span><span class="p">(</span><span class="o">|</span><span class="n">data</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">store_limits</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span>: <span class="nc">Linker</span><span class="o">&lt;</span><span class="n">Data</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">add_to_linker</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">state</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">wasi</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">linker</span><span class="p">.</span><span class="n">module</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">linker</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">linker</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">get_default</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">)</span><span class="o">?</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">typed</span>::<span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">_</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">)</span><span class="o">?</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="p">())</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">stdout_file_handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">File</span>::<span class="n">from_raw_fd</span><span class="p">(</span><span class="n">tmpfile_fd</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">bytes_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stdout_file_handle</span><span class="p">.</span><span class="n">read_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">output</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">tracing</span>::<span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="n">bytes_read</span><span class="p">);</span><span class="w"> </span><span class="c1">// 0 bytes read</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Could it be that raw_fd is no longer valid at that point?</p>
</blockquote>



<a name="282118209"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234145%20Cannot%20capture%20stdout%20using%20WasiCtx/near/282118209" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234145.20Cannot.20capture.20stdout.20using.20WasiCtx.html#282118209">(May 12 2022 at 14:55)</a>:</h4>
<p>jlkiri edited <a href="https://github.com/bytecodealliance/wasmtime/issues/4145">issue #4145</a>:</p>
<blockquote>
<p>If I understand correctly, <code>stdout</code> method on <a href="https://docs.rs/wasi-common/latest/wasi_common/?search=WasiCtxBuilder"><code>WasiCtxBuilder</code></a> can be used to set what the instance will treat as stdout. This something needs to implement <code>WasiFile</code> trait and I discovered that <code>File</code> from <code>cap-std</code> create implements it. It also allows creating cap-std-files from usual std files. I guessed that I can then created a usual file, and then through some conversions turn it into a <code>WasiCtxBuilder</code>-usable stdout target. Since all these methods own the file, I obtain the raw fd which I then use to open the file again and read its contents. However it appears to be empty, although I do print text in the Rust program compiled to wasm. Note that the execution itself is successful - I just don't see any side effects. Here's the code that I compile to wasm:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Hello"</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>and here's what I use to execute it in wasmtime:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">wasm_execute</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">engine</span>: <span class="kp">&amp;</span><span class="nc">wasmtime</span>::<span class="n">Engine</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">module_path</span>: <span class="nc">impl</span><span class="w"> </span><span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">anyhow</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">cap_std</span>::<span class="n">fs</span>::<span class="n">File</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">CapStdFile</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">wasmtime_wasi</span>::<span class="p">{</span><span class="n">add_to_linker</span><span class="p">,</span><span class="w"> </span><span class="n">sync</span>::<span class="n">file</span>::<span class="n">File</span><span class="p">,</span><span class="w"> </span><span class="n">WasiCtxBuilder</span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span>::<span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">module_path</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tmpfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tempfile</span>::<span class="n">tempfile</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tmpfile_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmpfile</span><span class="p">.</span><span class="n">as_raw_fd</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">cap_std_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CapStdFile</span>::<span class="n">from_std</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">stdout_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span>::<span class="n">from_cap_std</span><span class="p">(</span><span class="n">cap_std_file</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasiCtxBuilder</span>::<span class="n">new</span><span class="p">().</span><span class="n">stdout</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">stdout_file</span><span class="p">)).</span><span class="n">build</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">store_limits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StoreLimits</span>::<span class="n">default</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">wasi</span><span class="p">,</span><span class="w"> </span><span class="n">store_limits</span><span class="w"> </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="p">.</span><span class="n">limiter</span><span class="p">(</span><span class="o">|</span><span class="n">data</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">store_limits</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span>: <span class="nc">Linker</span><span class="o">&lt;</span><span class="n">Data</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">add_to_linker</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">state</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">wasi</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">linker</span><span class="p">.</span><span class="n">module</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">linker</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">linker</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">get_default</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">)</span><span class="o">?</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">typed</span>::<span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">_</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">)</span><span class="o">?</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="p">())</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">stdout_file_handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">File</span>::<span class="n">from_raw_fd</span><span class="p">(</span><span class="n">tmpfile_fd</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">bytes_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stdout_file_handle</span><span class="p">.</span><span class="n">read_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">output</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">tracing</span>::<span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="n">bytes_read</span><span class="p">);</span><span class="w"> </span><span class="c1">// 0 bytes read</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Could it be that raw_fd is no longer valid at that point?</p>
</blockquote>



<a name="282118292"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234145%20Cannot%20capture%20stdout%20using%20WasiCtx/near/282118292" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234145.20Cannot.20capture.20stdout.20using.20WasiCtx.html#282118292">(May 12 2022 at 14:55)</a>:</h4>
<p>jlkiri edited <a href="https://github.com/bytecodealliance/wasmtime/issues/4145">issue #4145</a>:</p>
<blockquote>
<p>If I understand correctly, <code>stdout</code> method on <a href="https://docs.wasmtime.dev/api/wasmtime_wasi/sync/struct.WasiCtxBuilder.html"><code>WasiCtxBuilder</code></a> can be used to set what the instance will treat as stdout. This something needs to implement <code>WasiFile</code> trait and I discovered that <code>File</code> from <code>cap-std</code> create implements it. It also allows creating cap-std-files from usual std files. I guessed that I can then created a usual file, and then through some conversions turn it into a <code>WasiCtxBuilder</code>-usable stdout target. Since all these methods own the file, I obtain the raw fd which I then use to open the file again and read its contents. However it appears to be empty, although I do print text in the Rust program compiled to wasm. Note that the execution itself is successful - I just don't see any side effects. Here's the code that I compile to wasm:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Hello"</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>and here's what I use to execute it in wasmtime:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">wasm_execute</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">engine</span>: <span class="kp">&amp;</span><span class="nc">wasmtime</span>::<span class="n">Engine</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">module_path</span>: <span class="nc">impl</span><span class="w"> </span><span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">anyhow</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">cap_std</span>::<span class="n">fs</span>::<span class="n">File</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">CapStdFile</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">wasmtime_wasi</span>::<span class="p">{</span><span class="n">add_to_linker</span><span class="p">,</span><span class="w"> </span><span class="n">sync</span>::<span class="n">file</span>::<span class="n">File</span><span class="p">,</span><span class="w"> </span><span class="n">WasiCtxBuilder</span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span>::<span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">module_path</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tmpfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tempfile</span>::<span class="n">tempfile</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tmpfile_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmpfile</span><span class="p">.</span><span class="n">as_raw_fd</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">cap_std_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CapStdFile</span>::<span class="n">from_std</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">stdout_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span>::<span class="n">from_cap_std</span><span class="p">(</span><span class="n">cap_std_file</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasiCtxBuilder</span>::<span class="n">new</span><span class="p">().</span><span class="n">stdout</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">stdout_file</span><span class="p">)).</span><span class="n">build</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">store_limits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StoreLimits</span>::<span class="n">default</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">wasi</span><span class="p">,</span><span class="w"> </span><span class="n">store_limits</span><span class="w"> </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="p">.</span><span class="n">limiter</span><span class="p">(</span><span class="o">|</span><span class="n">data</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">store_limits</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span>: <span class="nc">Linker</span><span class="o">&lt;</span><span class="n">Data</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">add_to_linker</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">state</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">wasi</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">linker</span><span class="p">.</span><span class="n">module</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">linker</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">linker</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">get_default</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">)</span><span class="o">?</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">typed</span>::<span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">_</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">)</span><span class="o">?</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="p">())</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">stdout_file_handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">File</span>::<span class="n">from_raw_fd</span><span class="p">(</span><span class="n">tmpfile_fd</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">bytes_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stdout_file_handle</span><span class="p">.</span><span class="n">read_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">output</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">tracing</span>::<span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="n">bytes_read</span><span class="p">);</span><span class="w"> </span><span class="c1">// 0 bytes read</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Could it be that raw_fd is no longer valid at that point?</p>
</blockquote>



<a name="282118319"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234145%20Cannot%20capture%20stdout%20using%20WasiCtx/near/282118319" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234145.20Cannot.20capture.20stdout.20using.20WasiCtx.html#282118319">(May 12 2022 at 14:55)</a>:</h4>
<p>jlkiri edited <a href="https://github.com/bytecodealliance/wasmtime/issues/4145">issue #4145</a>:</p>
<blockquote>
<p>If I understand correctly, <code>stdout</code> method on <a href="https://docs.wasmtime.dev/api/wasmtime_wasi/sync/struct.WasiCtxBuilder.html"><code>WasiCtxBuilder</code></a> can be used to set what the instance will treat as stdout. This something needs to implement <code>WasiFile</code> trait and I discovered that <code>File</code> from <code>cap-std</code> crate implements it. It also allows creating cap-std-files from usual std files. I guessed that I can then created a usual file, and then through some conversions turn it into a <code>WasiCtxBuilder</code>-usable stdout target. Since all these methods own the file, I obtain the raw fd which I then use to open the file again and read its contents. However it appears to be empty, although I do print text in the Rust program compiled to wasm. Note that the execution itself is successful - I just don't see any side effects. Here's the code that I compile to wasm:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Hello"</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>and here's what I use to execute it in wasmtime:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">wasm_execute</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">engine</span>: <span class="kp">&amp;</span><span class="nc">wasmtime</span>::<span class="n">Engine</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">module_path</span>: <span class="nc">impl</span><span class="w"> </span><span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">anyhow</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">cap_std</span>::<span class="n">fs</span>::<span class="n">File</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">CapStdFile</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">wasmtime_wasi</span>::<span class="p">{</span><span class="n">add_to_linker</span><span class="p">,</span><span class="w"> </span><span class="n">sync</span>::<span class="n">file</span>::<span class="n">File</span><span class="p">,</span><span class="w"> </span><span class="n">WasiCtxBuilder</span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span>::<span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">module_path</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tmpfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tempfile</span>::<span class="n">tempfile</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tmpfile_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmpfile</span><span class="p">.</span><span class="n">as_raw_fd</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">cap_std_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CapStdFile</span>::<span class="n">from_std</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">stdout_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span>::<span class="n">from_cap_std</span><span class="p">(</span><span class="n">cap_std_file</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasiCtxBuilder</span>::<span class="n">new</span><span class="p">().</span><span class="n">stdout</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">stdout_file</span><span class="p">)).</span><span class="n">build</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">store_limits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StoreLimits</span>::<span class="n">default</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">wasi</span><span class="p">,</span><span class="w"> </span><span class="n">store_limits</span><span class="w"> </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="p">.</span><span class="n">limiter</span><span class="p">(</span><span class="o">|</span><span class="n">data</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">store_limits</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span>: <span class="nc">Linker</span><span class="o">&lt;</span><span class="n">Data</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">add_to_linker</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">state</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">wasi</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">linker</span><span class="p">.</span><span class="n">module</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">linker</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">linker</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">get_default</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">)</span><span class="o">?</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">typed</span>::<span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">_</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">)</span><span class="o">?</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="p">())</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">stdout_file_handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">File</span>::<span class="n">from_raw_fd</span><span class="p">(</span><span class="n">tmpfile_fd</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">bytes_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stdout_file_handle</span><span class="p">.</span><span class="n">read_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">output</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">tracing</span>::<span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="n">bytes_read</span><span class="p">);</span><span class="w"> </span><span class="c1">// 0 bytes read</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Could it be that raw_fd is no longer valid at that point?</p>
</blockquote>



<a name="282118389"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234145%20Cannot%20capture%20stdout%20using%20WasiCtx/near/282118389" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234145.20Cannot.20capture.20stdout.20using.20WasiCtx.html#282118389">(May 12 2022 at 14:56)</a>:</h4>
<p>jlkiri edited <a href="https://github.com/bytecodealliance/wasmtime/issues/4145">issue #4145</a>:</p>
<blockquote>
<p>If I understand correctly, <code>stdout</code> method on <a href="https://docs.wasmtime.dev/api/wasmtime_wasi/sync/struct.WasiCtxBuilder.html"><code>WasiCtxBuilder</code></a> can be used to set what the instance will treat as stdout. This something needs to implement <code>WasiFile</code> trait and I discovered that <code>File</code> from <a href="https://github.com/bytecodealliance/cap-std"><code>cap-std</code></a> crate implements it. It also allows creating cap-std-files from usual std files. I guessed that I can then created a usual file, and then through some conversions turn it into a <code>WasiCtxBuilder</code>-usable stdout target. Since all these methods own the file, I obtain the raw fd which I then use to open the file again and read its contents. However it appears to be empty, although I do print text in the Rust program compiled to wasm. Note that the execution itself is successful - I just don't see any side effects. Here's the code that I compile to wasm:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Hello"</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>and here's what I use to execute it in wasmtime:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">wasm_execute</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">engine</span>: <span class="kp">&amp;</span><span class="nc">wasmtime</span>::<span class="n">Engine</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">module_path</span>: <span class="nc">impl</span><span class="w"> </span><span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">anyhow</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">cap_std</span>::<span class="n">fs</span>::<span class="n">File</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">CapStdFile</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">wasmtime_wasi</span>::<span class="p">{</span><span class="n">add_to_linker</span><span class="p">,</span><span class="w"> </span><span class="n">sync</span>::<span class="n">file</span>::<span class="n">File</span><span class="p">,</span><span class="w"> </span><span class="n">WasiCtxBuilder</span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span>::<span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">module_path</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tmpfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tempfile</span>::<span class="n">tempfile</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tmpfile_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmpfile</span><span class="p">.</span><span class="n">as_raw_fd</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">cap_std_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CapStdFile</span>::<span class="n">from_std</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">stdout_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span>::<span class="n">from_cap_std</span><span class="p">(</span><span class="n">cap_std_file</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasiCtxBuilder</span>::<span class="n">new</span><span class="p">().</span><span class="n">stdout</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">stdout_file</span><span class="p">)).</span><span class="n">build</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">store_limits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StoreLimits</span>::<span class="n">default</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">wasi</span><span class="p">,</span><span class="w"> </span><span class="n">store_limits</span><span class="w"> </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="p">.</span><span class="n">limiter</span><span class="p">(</span><span class="o">|</span><span class="n">data</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">store_limits</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span>: <span class="nc">Linker</span><span class="o">&lt;</span><span class="n">Data</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">add_to_linker</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">state</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">wasi</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">linker</span><span class="p">.</span><span class="n">module</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">linker</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">linker</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">get_default</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">)</span><span class="o">?</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">typed</span>::<span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">_</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">)</span><span class="o">?</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="p">())</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">stdout_file_handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">File</span>::<span class="n">from_raw_fd</span><span class="p">(</span><span class="n">tmpfile_fd</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">bytes_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stdout_file_handle</span><span class="p">.</span><span class="n">read_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">output</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">tracing</span>::<span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="n">bytes_read</span><span class="p">);</span><span class="w"> </span><span class="c1">// 0 bytes read</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Could it be that raw_fd is no longer valid at that point?</p>
</blockquote>



<a name="282118417"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234145%20Cannot%20capture%20stdout%20using%20WasiCtx/near/282118417" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234145.20Cannot.20capture.20stdout.20using.20WasiCtx.html#282118417">(May 12 2022 at 14:56)</a>:</h4>
<p>jlkiri edited <a href="https://github.com/bytecodealliance/wasmtime/issues/4145">issue #4145</a>:</p>
<blockquote>
<p>If I understand correctly, <code>stdout</code> method on <a href="https://docs.wasmtime.dev/api/wasmtime_wasi/sync/struct.WasiCtxBuilder.html"><code>WasiCtxBuilder</code></a> can be used to set what the instance will treat as stdout. This something needs to implement <code>WasiFile</code> trait and I discovered that <code>File</code> from <a href="https://github.com/bytecodealliance/cap-std"><code>cap-std</code></a> crate implements it. It also allows creating cap-std-files from usual std files. I guessed that I can then create a usual file, and then through some conversions turn it into a <code>WasiCtxBuilder</code>-usable stdout target. Since all these methods own the file, I obtain the raw fd which I then use to open the file again and read its contents. However it appears to be empty, although I do print text in the Rust program compiled to wasm. Note that the execution itself is successful - I just don't see any side effects. Here's the code that I compile to wasm:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Hello"</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>and here's what I use to execute it in wasmtime:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">wasm_execute</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">engine</span>: <span class="kp">&amp;</span><span class="nc">wasmtime</span>::<span class="n">Engine</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">module_path</span>: <span class="nc">impl</span><span class="w"> </span><span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">anyhow</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">cap_std</span>::<span class="n">fs</span>::<span class="n">File</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">CapStdFile</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">wasmtime_wasi</span>::<span class="p">{</span><span class="n">add_to_linker</span><span class="p">,</span><span class="w"> </span><span class="n">sync</span>::<span class="n">file</span>::<span class="n">File</span><span class="p">,</span><span class="w"> </span><span class="n">WasiCtxBuilder</span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span>::<span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">module_path</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tmpfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tempfile</span>::<span class="n">tempfile</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tmpfile_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmpfile</span><span class="p">.</span><span class="n">as_raw_fd</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">cap_std_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CapStdFile</span>::<span class="n">from_std</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">stdout_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span>::<span class="n">from_cap_std</span><span class="p">(</span><span class="n">cap_std_file</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasiCtxBuilder</span>::<span class="n">new</span><span class="p">().</span><span class="n">stdout</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">stdout_file</span><span class="p">)).</span><span class="n">build</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">store_limits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StoreLimits</span>::<span class="n">default</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">wasi</span><span class="p">,</span><span class="w"> </span><span class="n">store_limits</span><span class="w"> </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="p">.</span><span class="n">limiter</span><span class="p">(</span><span class="o">|</span><span class="n">data</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">store_limits</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span>: <span class="nc">Linker</span><span class="o">&lt;</span><span class="n">Data</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">add_to_linker</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">state</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">wasi</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">linker</span><span class="p">.</span><span class="n">module</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">linker</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">linker</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">get_default</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">)</span><span class="o">?</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">typed</span>::<span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">_</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">)</span><span class="o">?</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="p">())</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">stdout_file_handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">File</span>::<span class="n">from_raw_fd</span><span class="p">(</span><span class="n">tmpfile_fd</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">bytes_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stdout_file_handle</span><span class="p">.</span><span class="n">read_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">output</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">tracing</span>::<span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="n">bytes_read</span><span class="p">);</span><span class="w"> </span><span class="c1">// 0 bytes read</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Could it be that raw_fd is no longer valid at that point?</p>
</blockquote>



<a name="282118704"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234145%20Cannot%20capture%20stdout%20using%20WasiCtx/near/282118704" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234145.20Cannot.20capture.20stdout.20using.20WasiCtx.html#282118704">(May 12 2022 at 14:58)</a>:</h4>
<p>jlkiri edited <a href="https://github.com/bytecodealliance/wasmtime/issues/4145">issue #4145</a>:</p>
<blockquote>
<p>If I understand correctly, <code>stdout</code> method on <a href="https://docs.wasmtime.dev/api/wasmtime_wasi/sync/struct.WasiCtxBuilder.html"><code>WasiCtxBuilder</code></a> can be used to set what the instance will treat as stdout. This something needs to implement <code>WasiFile</code> trait and I discovered that <code>File</code> from <a href="https://github.com/bytecodealliance/cap-std"><code>cap-std</code></a> crate implements it. It also allows creating cap-std-files from usual std files. I guessed that I can then create a usual file, and then through some conversions turn it into a <code>WasiCtxBuilder</code>-usable stdout target. Since all these methods own the file, I obtain the raw fd which I then use to open the file again and read its contents. However it appears to be empty, although I do print text in the Rust program compiled to wasm. Note that the execution itself is successful - I just don't see any side effects. Also inheriting stdio also works properly. Here's the code that I compile to wasm:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Hello"</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>and here's what I use to execute it in wasmtime:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">wasm_execute</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">engine</span>: <span class="kp">&amp;</span><span class="nc">wasmtime</span>::<span class="n">Engine</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">module_path</span>: <span class="nc">impl</span><span class="w"> </span><span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">anyhow</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">cap_std</span>::<span class="n">fs</span>::<span class="n">File</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">CapStdFile</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">wasmtime_wasi</span>::<span class="p">{</span><span class="n">add_to_linker</span><span class="p">,</span><span class="w"> </span><span class="n">sync</span>::<span class="n">file</span>::<span class="n">File</span><span class="p">,</span><span class="w"> </span><span class="n">WasiCtxBuilder</span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span>::<span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">module_path</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tmpfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tempfile</span>::<span class="n">tempfile</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tmpfile_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmpfile</span><span class="p">.</span><span class="n">as_raw_fd</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">cap_std_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CapStdFile</span>::<span class="n">from_std</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">stdout_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span>::<span class="n">from_cap_std</span><span class="p">(</span><span class="n">cap_std_file</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasiCtxBuilder</span>::<span class="n">new</span><span class="p">().</span><span class="n">stdout</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">stdout_file</span><span class="p">)).</span><span class="n">build</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">store_limits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StoreLimits</span>::<span class="n">default</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">wasi</span><span class="p">,</span><span class="w"> </span><span class="n">store_limits</span><span class="w"> </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="p">.</span><span class="n">limiter</span><span class="p">(</span><span class="o">|</span><span class="n">data</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">store_limits</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span>: <span class="nc">Linker</span><span class="o">&lt;</span><span class="n">Data</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">add_to_linker</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">state</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">wasi</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">linker</span><span class="p">.</span><span class="n">module</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">linker</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">linker</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">get_default</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">)</span><span class="o">?</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">typed</span>::<span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">_</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">)</span><span class="o">?</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="p">())</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">stdout_file_handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">File</span>::<span class="n">from_raw_fd</span><span class="p">(</span><span class="n">tmpfile_fd</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">bytes_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stdout_file_handle</span><span class="p">.</span><span class="n">read_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">output</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">tracing</span>::<span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="n">bytes_read</span><span class="p">);</span><span class="w"> </span><span class="c1">// 0 bytes read</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Could it be that raw_fd is no longer valid at that point?</p>
</blockquote>



<a name="282118725"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234145%20Cannot%20capture%20stdout%20using%20WasiCtx/near/282118725" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234145.20Cannot.20capture.20stdout.20using.20WasiCtx.html#282118725">(May 12 2022 at 14:58)</a>:</h4>
<p>jlkiri edited <a href="https://github.com/bytecodealliance/wasmtime/issues/4145">issue #4145</a>:</p>
<blockquote>
<p>If I understand correctly, <code>stdout</code> method on <a href="https://docs.wasmtime.dev/api/wasmtime_wasi/sync/struct.WasiCtxBuilder.html"><code>WasiCtxBuilder</code></a> can be used to set what the instance will treat as stdout. This something needs to implement <code>WasiFile</code> trait and I discovered that <code>File</code> from <a href="https://github.com/bytecodealliance/cap-std"><code>cap-std</code></a> crate implements it. It also allows creating cap-std-files from usual std files. I guessed that I can then create a usual file, and then through some conversions turn it into a <code>WasiCtxBuilder</code>-usable stdout target. Since all these methods own the file, I obtain the raw fd which I then use to open the file again and read its contents. However it appears to be empty, although I do print text in the Rust program compiled to wasm. Note that the execution itself is successful - I just don't see any side effects. Inheriting stdio also works properly. Here's the code that I compile to wasm:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Hello"</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>and here's what I use to execute it in wasmtime:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">wasm_execute</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">engine</span>: <span class="kp">&amp;</span><span class="nc">wasmtime</span>::<span class="n">Engine</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">module_path</span>: <span class="nc">impl</span><span class="w"> </span><span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">anyhow</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">cap_std</span>::<span class="n">fs</span>::<span class="n">File</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">CapStdFile</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">wasmtime_wasi</span>::<span class="p">{</span><span class="n">add_to_linker</span><span class="p">,</span><span class="w"> </span><span class="n">sync</span>::<span class="n">file</span>::<span class="n">File</span><span class="p">,</span><span class="w"> </span><span class="n">WasiCtxBuilder</span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span>::<span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">module_path</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tmpfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tempfile</span>::<span class="n">tempfile</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tmpfile_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmpfile</span><span class="p">.</span><span class="n">as_raw_fd</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">cap_std_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CapStdFile</span>::<span class="n">from_std</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">stdout_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span>::<span class="n">from_cap_std</span><span class="p">(</span><span class="n">cap_std_file</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasiCtxBuilder</span>::<span class="n">new</span><span class="p">().</span><span class="n">stdout</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">stdout_file</span><span class="p">)).</span><span class="n">build</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">store_limits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StoreLimits</span>::<span class="n">default</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">wasi</span><span class="p">,</span><span class="w"> </span><span class="n">store_limits</span><span class="w"> </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="p">.</span><span class="n">limiter</span><span class="p">(</span><span class="o">|</span><span class="n">data</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">store_limits</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span>: <span class="nc">Linker</span><span class="o">&lt;</span><span class="n">Data</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">add_to_linker</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">state</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">wasi</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">linker</span><span class="p">.</span><span class="n">module</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">linker</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">linker</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">get_default</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">)</span><span class="o">?</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">typed</span>::<span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">_</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">)</span><span class="o">?</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="p">())</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">stdout_file_handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">File</span>::<span class="n">from_raw_fd</span><span class="p">(</span><span class="n">tmpfile_fd</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">bytes_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stdout_file_handle</span><span class="p">.</span><span class="n">read_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">output</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">tracing</span>::<span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="n">bytes_read</span><span class="p">);</span><span class="w"> </span><span class="c1">// 0 bytes read</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Could it be that raw_fd is no longer valid at that point?</p>
</blockquote>



<a name="282119494"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234145%20Cannot%20capture%20stdout%20using%20WasiCtx/near/282119494" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234145.20Cannot.20capture.20stdout.20using.20WasiCtx.html#282119494">(May 12 2022 at 15:02)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/4145#issuecomment-1125105681">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4145">issue #4145</a>:</p>
<blockquote>
<p>I believe you're reading the same file descriptor that was used for writes, so I think you might need to <code>seek</code> to the beginning to reset the internal cursor?</p>
</blockquote>



<a name="282119579"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234145%20Cannot%20capture%20stdout%20using%20WasiCtx/near/282119579" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234145.20Cannot.20capture.20stdout.20using.20WasiCtx.html#282119579">(May 12 2022 at 15:03)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/4145#issuecomment-1125106488">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4145">issue #4145</a>:</p>
<blockquote>
<p>I think you will need to seek to the start of the file. Also you should probably use <code>cap_std::fs::File</code> directly instead of trying to convert it into an <code>std::fs::File</code>. I'm pretty sure the code you have right now would close the fd twice.</p>
</blockquote>



<a name="282121283"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234145%20Cannot%20capture%20stdout%20using%20WasiCtx/near/282121283" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234145.20Cannot.20capture.20stdout.20using.20WasiCtx.html#282121283">(May 12 2022 at 15:14)</a>:</h4>
<p>jlkiri <a href="https://github.com/bytecodealliance/wasmtime/issues/4145#issuecomment-1125119039">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4145">issue #4145</a>:</p>
<blockquote>
<p>Seeking to start of the file solved the problem!</p>
<blockquote>
<p>Also you should probably use cap_std::fs::File directly instead of trying to convert it into an std::fs::File<br>
Are you talking about this line?</p>
</blockquote>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">File</span>::<span class="n">from_cap_std</span><span class="p">(</span><span class="n">cap_std_file</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>This File is <code>wasmtime::File</code>.</p>
</blockquote>



<a name="282121293"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234145%20Cannot%20capture%20stdout%20using%20WasiCtx/near/282121293" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234145.20Cannot.20capture.20stdout.20using.20WasiCtx.html#282121293">(May 12 2022 at 15:14)</a>:</h4>
<p>jlkiri edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4145#issuecomment-1125119039">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4145">issue #4145</a>:</p>
<blockquote>
<p>Seeking to start of the file solved the problem!</p>
<blockquote>
<p>Also you should probably use cap_std::fs::File directly instead of trying to convert it into an std::fs::File</p>
</blockquote>
<p>Are you talking about this line?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">File</span>::<span class="n">from_cap_std</span><span class="p">(</span><span class="n">cap_std_file</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>This File is <code>wasmtime::File</code>.</p>
</blockquote>



<a name="282121300"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234145%20Cannot%20capture%20stdout%20using%20WasiCtx/near/282121300" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234145.20Cannot.20capture.20stdout.20using.20WasiCtx.html#282121300">(May 12 2022 at 15:14)</a>:</h4>
<p>jlkiri edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4145#issuecomment-1125119039">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4145">issue #4145</a>:</p>
<blockquote>
<p>Seeking to start of the file solved the problem! Thanks!</p>
<blockquote>
<p>Also you should probably use cap_std::fs::File directly instead of trying to convert it into an std::fs::File</p>
</blockquote>
<p>Are you talking about this line?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">File</span>::<span class="n">from_cap_std</span><span class="p">(</span><span class="n">cap_std_file</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>This File is <code>wasmtime::File</code>.</p>
</blockquote>



<a name="282121345"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234145%20Cannot%20capture%20stdout%20using%20WasiCtx/near/282121345" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234145.20Cannot.20capture.20stdout.20using.20WasiCtx.html#282121345">(May 12 2022 at 15:14)</a>:</h4>
<p>jlkiri edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4145#issuecomment-1125119039">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4145">issue #4145</a>:</p>
<blockquote>
<p>Seeking to the start of the file solved the problem! Thanks!</p>
<blockquote>
<p>Also you should probably use cap_std::fs::File directly instead of trying to convert it into an std::fs::File</p>
</blockquote>
<p>Are you talking about this line?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">File</span>::<span class="n">from_cap_std</span><span class="p">(</span><span class="n">cap_std_file</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>This File is <code>wasmtime::File</code>.</p>
</blockquote>



<a name="282129563"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234145%20Cannot%20capture%20stdout%20using%20WasiCtx/near/282129563" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234145.20Cannot.20capture.20stdout.20using.20WasiCtx.html#282129563">(May 12 2022 at 16:06)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/4145#issuecomment-1125175699">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4145">issue #4145</a>:</p>
<blockquote>
<blockquote>
<p>Are you talking about this line?</p>
</blockquote>
<p>No, I'm talking about <code>std::fs::File::from_raw_fd(tmpfile_fd)</code>. I think you should use <code>cap_std_file</code> there instead. You may need to change <code>File::from_cap_std(cap_std_file)</code> to <code>File::from_cap_std(cap_std_file.clone())</code> for that to be possible.</p>
</blockquote>



<a name="282212495"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234145%20Cannot%20capture%20stdout%20using%20WasiCtx/near/282212495" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234145.20Cannot.20capture.20stdout.20using.20WasiCtx.html#282212495">(May 13 2022 at 07:34)</a>:</h4>
<p>jlkiri <a href="https://github.com/bytecodealliance/wasmtime/issues/4145#issuecomment-1125745496">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4145">issue #4145</a>:</p>
<blockquote>
<p>Oh I see! Thanks, I thought that the file cannot have multiple owners by cloning.</p>
</blockquote>



<a name="282212500"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234145%20Cannot%20capture%20stdout%20using%20WasiCtx/near/282212500" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234145.20Cannot.20capture.20stdout.20using.20WasiCtx.html#282212500">(May 13 2022 at 07:34)</a>:</h4>
<p>jlkiri closed <a href="https://github.com/bytecodealliance/wasmtime/issues/4145">issue #4145</a>:</p>
<blockquote>
<p>If I understand correctly, <code>stdout</code> method on <a href="https://docs.wasmtime.dev/api/wasmtime_wasi/sync/struct.WasiCtxBuilder.html"><code>WasiCtxBuilder</code></a> can be used to set what the instance will treat as stdout. This something needs to implement <code>WasiFile</code> trait and I discovered that <code>File</code> from <a href="https://github.com/bytecodealliance/cap-std"><code>cap-std</code></a> crate implements it. It also allows creating cap-std-files from usual std files. I guessed that I can then create a usual file, and then through some conversions turn it into a <code>WasiCtxBuilder</code>-usable stdout target. Since all these methods own the file, I obtain the raw fd which I then use to open the file again and read its contents. However it appears to be empty, although I do print text in the Rust program compiled to wasm. Note that the execution itself is successful - I just don't see any side effects. Inheriting stdio also works properly. Here's the code that I compile to wasm:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Hello"</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>and here's what I use to execute it in wasmtime:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">wasm_execute</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">engine</span>: <span class="kp">&amp;</span><span class="nc">wasmtime</span>::<span class="n">Engine</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">module_path</span>: <span class="nc">impl</span><span class="w"> </span><span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">anyhow</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">cap_std</span>::<span class="n">fs</span>::<span class="n">File</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">CapStdFile</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">wasmtime_wasi</span>::<span class="p">{</span><span class="n">add_to_linker</span><span class="p">,</span><span class="w"> </span><span class="n">sync</span>::<span class="n">file</span>::<span class="n">File</span><span class="p">,</span><span class="w"> </span><span class="n">WasiCtxBuilder</span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span>::<span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">module_path</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tmpfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tempfile</span>::<span class="n">tempfile</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tmpfile_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmpfile</span><span class="p">.</span><span class="n">as_raw_fd</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">cap_std_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CapStdFile</span>::<span class="n">from_std</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">stdout_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span>::<span class="n">from_cap_std</span><span class="p">(</span><span class="n">cap_std_file</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasiCtxBuilder</span>::<span class="n">new</span><span class="p">().</span><span class="n">stdout</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">stdout_file</span><span class="p">)).</span><span class="n">build</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">store_limits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StoreLimits</span>::<span class="n">default</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">wasi</span><span class="p">,</span><span class="w"> </span><span class="n">store_limits</span><span class="w"> </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="p">.</span><span class="n">limiter</span><span class="p">(</span><span class="o">|</span><span class="n">data</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">store_limits</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span>: <span class="nc">Linker</span><span class="o">&lt;</span><span class="n">Data</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">add_to_linker</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">state</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">wasi</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">linker</span><span class="p">.</span><span class="n">module</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">linker</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">linker</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">get_default</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">)</span><span class="o">?</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">typed</span>::<span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">_</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">)</span><span class="o">?</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="p">())</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">stdout_file_handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">File</span>::<span class="n">from_raw_fd</span><span class="p">(</span><span class="n">tmpfile_fd</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">bytes_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stdout_file_handle</span><span class="p">.</span><span class="n">read_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">output</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">tracing</span>::<span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="n">bytes_read</span><span class="p">);</span><span class="w"> </span><span class="c1">// 0 bytes read</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Could it be that raw_fd is no longer valid at that point?</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>