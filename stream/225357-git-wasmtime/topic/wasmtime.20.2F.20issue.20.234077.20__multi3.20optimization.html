<html>
<head><meta charset="utf-8"><title>wasmtime / issue #4077 __multi3 optimization · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234077.20__multi3.20optimization.html">wasmtime / issue #4077 __multi3 optimization</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="280421456"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234077%20__multi3%20optimization/near/280421456" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234077.20__multi3.20optimization.html#280421456">(Apr 27 2022 at 22:44)</a>:</h4>
<p>shamatar opened <a href="https://github.com/bytecodealliance/wasmtime/issues/4077">issue #4077</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>Implement an optimization pass that would eliminate the <code>__multi3</code> function from WASM binary during JIT by replacing it with ISA specific (mainly for <code>x86_64</code> and <code>arm64</code>) sequences, and then inline such sequences into callsites that would allow further optimizations</p>
<h4>Benefit</h4>
<p>A lot of code dealing with cryptography would benefit form faster full width <code>u64</code> multiplications where such <code>__multi3</code> arises</p>
<h4>Implementation</h4>
<p>If someone would give a few hints about where to start I'd try to implement it by myself</p>
<h4>Alternatives</h4>
<p>Not that I'm aware of. Patching into calling come native library function is a huge overhead for modern CPUs (4 cycles for <code>x86_64</code> for e.g. <code>mulx</code> or <code>mul</code>), and while it would be faster most likely, it's still far from optimal case on a hot path</p>
<p>As an example a simple multiply-add-carry function like <code>a*b + c + carry -&gt; (high, low)</code> that accumulates into <code>u128</code> without overflows compiles down to the listing below, and it can be a good test subject (transformed from <code>wasm</code> into <code>wat</code>, may be not the best readable)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">module</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k">type</span> <span class="p">(;</span><span class="mi">0</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$mac</span><span class="w"> </span><span class="p">(</span><span class="k">type</span> <span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">local</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">global</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="cp">$__stack_pointer</span><span class="w"></span>
<span class="w">    </span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
<span class="w">    </span><span class="kt">i32</span><span class="p">.</span><span class="n">sub</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="n">global</span><span class="p">.</span><span class="n">set</span><span class="w"> </span><span class="cp">$__stack_pointer</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">call</span><span class="w"> </span><span class="cp">$__multi3</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">load</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">store</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="kt">i32</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">load</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">lt_u</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">extend_i32_u</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">lt_u</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">extend_i32_u</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">store</span><span class="w"> </span><span class="n">offset</span><span class="o">=</span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
<span class="w">    </span><span class="kt">i32</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="n">global</span><span class="p">.</span><span class="n">set</span><span class="w"> </span><span class="cp">$__stack_pointer</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$__multi3</span><span class="w"> </span><span class="p">(</span><span class="k">type</span> <span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">local</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">4294967295</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">and</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">4294967295</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">and</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">6</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">mul</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">7</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">shr_u</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">mul</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">9</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">shr_u</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">6</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">mul</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">shl</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">6</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">store</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">mul</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">9</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">lt_u</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">extend_i32_u</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">shl</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">shr_u</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">or</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">6</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">7</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">lt_u</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">extend_i32_u</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">mul</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">mul</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">store</span><span class="w"> </span><span class="n">offset</span><span class="o">=</span><span class="mi">8</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">table</span><span class="w"> </span><span class="p">(;</span><span class="mi">0</span><span class="p">;)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">funcref</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">memory</span><span class="w"> </span><span class="p">(;</span><span class="mi">0</span><span class="p">;)</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">global</span><span class="w"> </span><span class="cp">$__stack_pointer</span><span class="w"> </span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">1048576</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">global</span><span class="w"> </span><span class="p">(;</span><span class="mi">1</span><span class="p">;)</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">1048576</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">global</span><span class="w"> </span><span class="p">(;</span><span class="mi">2</span><span class="p">;)</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">1048576</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"memory"</span><span class="w"> </span><span class="p">(</span><span class="n">memory</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"mac"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$mac</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"__data_end"</span><span class="w"> </span><span class="p">(</span><span class="n">global</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"__heap_base"</span><span class="w"> </span><span class="p">(</span><span class="n">global</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</code></pre></div>
</blockquote>



<a name="280422509"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234077%20__multi3%20optimization/near/280422509" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234077.20__multi3.20optimization.html#280422509">(Apr 27 2022 at 22:56)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/4077#issuecomment-1111557141">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4077">issue #4077</a>:</p>
<blockquote>
<p>Hi @shamatar -- thanks for raising this issue! I agree that the lack of "architecture-specific acceleration" for wide arithmetic lowered into Wasm bytecode is suboptimal and annoying.</p>
<p>On the other hand, somehow recognizing that a Wasm module's internal function happens to be the <code>__multi3</code> function from the Wasm toolchain's runtime, and then actually replacing that function with another function, seems very likely to me to break the abstraction boundary (and hence security and portability properties) that the Wasm runtime provides. Either we check that it is exactly the <code>__multi3</code> that we expect (same Wasm bytecode body), in which case this is a very brittle optimization (breaks with any little Wasm-toolchain implementation detail change), or we don't, in which case we might replace the code with an implementation that does something different (incorrectly). So, for certain, we would not implement logic that somehow recognizes <code>__multi3</code> by name as special.</p>
<p>I think that there is a way around this though: we could pattern-match the actual operations and use the faster architecture-specific lowering when possible. In this specific case, a pattern could match whatever subgraphs correspond to the fast x64 instructions (<code>mulx</code> and friends?). I don't know enough about the state of the art of computer arithmetic implementations on x64 or aarch64 to suggest specific mappings.</p>
<p>The place to put such lowerings would be in the ISLE DSL (see e.g. cranelift/codegen/src/isa/x64/lower.isle); we'd be happy to help if you want to try to implement something here.</p>
</blockquote>



<a name="280424296"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234077%20__multi3%20optimization/near/280424296" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234077.20__multi3.20optimization.html#280424296">(Apr 27 2022 at 23:15)</a>:</h4>
<p>shamatar <a href="https://github.com/bytecodealliance/wasmtime/issues/4077#issuecomment-1111567745">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4077">issue #4077</a>:</p>
<blockquote>
<p>Hey @cfallin </p>
<p>Thank you for a detailed response. I was only mentioning <code>__multi3</code> replacement by name as I have seen in one of the old threads an idea to call external library for it for a speedup. But if name matching is potentially too fragile (it may be safely-enough allowed under some feature flag if such flag would exist :) ) I'd try to implement matching-by-logic. <code>__multi3</code> body looks like a standard <code>u64 -&gt; u32</code> and <code>u32 * u32 -&gt; u64</code> approach for simulation and hopefully should be catchable.</p>
<p>As for "state of the art" - the best one can get is <code>adx + mulx</code> combo for generic case I believe, but e.g. llvm never emits <code>mulx</code>, so I'd start with trying to optimize into <code>add + mul</code> for <code>x86_64</code></p>
<p>I'm not use that a file you have mentioned is a right place as <a href="https://github.com/bytecodealliance/wasmtime/blob/b69fede72f6df81edbb0b3286b01e0a101a1758f/cranelift/codegen/src/isa/x64/lower.isle#L916">https://github.com/bytecodealliance/wasmtime/blob/b69fede72f6df81edbb0b3286b01e0a101a1758f/cranelift/codegen/src/isa/x64/lower.isle#L916</a> has a rule for full width multiplication lowering already, but the optimization first needs to catch <code>__multi3</code>, and emit just <code>imul x y</code> for it + inline into callsite. May be it also requires more than one pass, but the first step is to get to just <code>imul x y</code></p>
</blockquote>



<a name="280425243"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234077%20__multi3%20optimization/near/280425243" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234077.20__multi3.20optimization.html#280425243">(Apr 27 2022 at 23:27)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/4077#issuecomment-1111573715">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4077">issue #4077</a>:</p>
<blockquote>
<blockquote>
<p>catch __multi3, and emit just imul x y for it + inline into callsite.</p>
</blockquote>
<p>That's true, one way this could work in the future is to recognize the whole function and replace it with an <code>imul.i128</code> (if that's what you mean by "catch `__multi3, and emit just imul"?) but that would I think hit the brittleness issues I mentioned.</p>
<p>Maybe the right way to start is to draw the dataflow graph of the bytecode you listed above, and find subgraphs that correspond to what <code>adx</code> and <code>mulx</code> do? If we can write a pattern that matches each of those, maybe we can get something at least slightly better than what we have today.</p>
<p>Eventually we will also have an inliner (it's really an orthogonal improvement) and when we do, it could combine with good-enough pattern matching on the function body here to produce an inlined sequence of instructions. In other words, getting to a tight sequence of instructions, and inlining that at the callsite, are two separate problems so let's solve each separately.</p>
<p>cc @abrown and @jlb6740 for thoughts on the x86-64 lowering here...</p>
</blockquote>



<a name="280493338"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234077%20__multi3%20optimization/near/280493338" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234077.20__multi3.20optimization.html#280493338">(Apr 28 2022 at 13:29)</a>:</h4>
<p>shamatar <a href="https://github.com/bytecodealliance/wasmtime/issues/4077#issuecomment-1112205606">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4077">issue #4077</a>:</p>
<blockquote>
<p><code>to recognize the whole function and replace it</code> - yes, it's a final goal, and ideally function body will be patter-matched somehow (and not by name). My impression on <a href="https://github.com/bytecodealliance/wasmtime/blob/b69fede72f6df81edbb0b3286b01e0a101a1758f/cranelift/codegen/src/isa/x64/lower.isle#L916">lower.isle</a> file is that it's a definition of "simple" rules to lower some short sequences of CLIF instructions to machine instructions, and not the rules for "large" pattern matching.</p>
<p>I'll make a dataflow, just need some time</p>
</blockquote>



<a name="280494291"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234077%20__multi3%20optimization/near/280494291" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234077.20__multi3.20optimization.html#280494291">(Apr 28 2022 at 13:36)</a>:</h4>
<p>shamatar <a href="https://github.com/bytecodealliance/wasmtime/issues/4077#issuecomment-1112213457">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4077">issue #4077</a>:</p>
<blockquote>
<p>More precisely a rule</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">;;</span><span class="w"> </span><span class="err">`</span><span class="kt">i64</span><span class="err">`</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">smaller</span><span class="p">.</span><span class="w"></span>

<span class="p">;;</span><span class="w"> </span><span class="n">Multiply</span><span class="w"> </span><span class="n">two</span><span class="w"> </span><span class="n">registers</span><span class="p">.</span><span class="w"></span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">lower</span><span class="w"> </span><span class="p">(</span><span class="n">has_type</span><span class="w"> </span><span class="p">(</span><span class="n">fits_in_64</span><span class="w"> </span><span class="n">ty</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">imul</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">x64_mul</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span><span class="w"></span>
<span class="w"> </span><span class="err">```</span><span class="w"></span>

<span class="w"> </span><span class="n">Would</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="n">multiplication</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">I</span><span class="o">'</span><span class="na">m</span><span class="w"> </span><span class="n">also</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">sure</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">about</span><span class="w"> </span><span class="n">getting</span><span class="w"> </span><span class="n">low</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="n">only</span><span class="w"> </span><span class="p">(</span><span class="n">half</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="n">mul</span><span class="p">)</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">them</span><span class="w"> </span><span class="p">(</span><span class="n">full</span><span class="w"> </span><span class="n">width</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">doesn</span><span class="o">'</span><span class="na">t</span><span class="w"> </span><span class="n">reflect</span><span class="w"> </span><span class="n">anything</span><span class="w"> </span><span class="n">about</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">type</span><span class="p">.</span><span class="w"></span>

<span class="w"> </span><span class="err">`</span><span class="n">__multi3</span><span class="err">`</span><span class="w"> </span><span class="n">indeed</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="err">`</span><span class="kt">i64</span><span class="p">.</span><span class="n">mul</span><span class="err">`</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">it</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">inputs</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="err">`</span><span class="kt">i64</span><span class="p">.</span><span class="n">mul</span><span class="err">`</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="mi">32</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">it</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">naturally</span><span class="w"> </span><span class="n">full</span><span class="o">-</span><span class="n">width</span><span class="w"> </span><span class="n">mul</span><span class="p">.</span><span class="w"> </span><span class="n">And</span><span class="w"> </span><span class="n">I</span><span class="o">'</span><span class="na">d</span><span class="w"> </span><span class="n">like</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="s">"guess"</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">larger</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">indeed</span><span class="w"> </span><span class="n">full</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="n">multiplication</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">doesn</span><span class="o">'</span><span class="na">t</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">WASM</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span>:<span class="p">)</span><span class="w"></span>
<span class="o">~~~</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="280522470"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234077%20__multi3%20optimization/near/280522470" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234077.20__multi3.20optimization.html#280522470">(Apr 28 2022 at 16:44)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/issues/4077#issuecomment-1112432050">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4077">issue #4077</a>:</p>
<blockquote>
<p>(Catching up on this thread...) For context, the code behind the WAT that you posted is probably coming from somewhere like this in Clang: <a href="https://github.com/llvm-mirror/compiler-rt/blob/master/lib/builtins/multi3.c">https://github.com/llvm-mirror/compiler-rt/blob/master/lib/builtins/multi3.c</a>. There is quite a bit of shifting and masking there which, as we can see in the WAT, get translated directly to WebAssembly.</p>
<p>I'd be interested to understand what library is being used and how you're using it (e.g., how come <code>__multi3</code> is on the hot path?). Here's why:<br>
 a. it could be that the library could be tweaked for better compilation to Wasm (e.g., should the algorithm use SIMD instead?)<br>
 b. if it is a widely-used library, then it motivates improving this sequence in Wasmtime</p>
<p>To optimize this in Wasmtime, I suspect the bottom-up approach (i.e., attempting to get rid of the extra shifting and masking) is going to be "good enough" relative to the code sequence currently emitted by Clang in native code (@cfallin has that) and will be less brittle than trying to match the entire function or the called name. But another option might be to attempt to optimize this at the LLVM layer: perhaps it does not need to be as literal about how it translates the C code I linked to to the WAT @shamatar posted.</p>
</blockquote>



<a name="280522514"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234077%20__multi3%20optimization/near/280522514" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234077.20__multi3.20optimization.html#280522514">(Apr 28 2022 at 16:45)</a>:</h4>
<p>abrown edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4077#issuecomment-1112432050">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4077">issue #4077</a>:</p>
<blockquote>
<p>(Catching up on this thread...) For context, the code behind the WAT that you posted is probably coming from somewhere like this in LLVM: <a href="https://github.com/llvm-mirror/compiler-rt/blob/master/lib/builtins/multi3.c">https://github.com/llvm-mirror/compiler-rt/blob/master/lib/builtins/multi3.c</a>. There is quite a bit of shifting and masking there which, as we can see in the WAT, get translated directly to WebAssembly.</p>
<p>I'd be interested to understand what library is being used and how you're using it (e.g., how come <code>__multi3</code> is on the hot path?). Here's why:<br>
 a. it could be that the library could be tweaked for better compilation to Wasm (e.g., should the algorithm use SIMD instead?)<br>
 b. if it is a widely-used library, then it motivates improving this sequence in Wasmtime</p>
<p>To optimize this in Wasmtime, I suspect the bottom-up approach (i.e., attempting to get rid of the extra shifting and masking) is going to be "good enough" relative to the code sequence currently emitted by Clang in native code (@cfallin has that) and will be less brittle than trying to match the entire function or the called name. But another option might be to attempt to optimize this at the LLVM layer: perhaps it does not need to be as literal about how it translates the C code I linked to to the WAT @shamatar posted.</p>
</blockquote>



<a name="280522569"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234077%20__multi3%20optimization/near/280522569" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234077.20__multi3.20optimization.html#280522569">(Apr 28 2022 at 16:45)</a>:</h4>
<p>abrown edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4077#issuecomment-1112432050">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4077">issue #4077</a>:</p>
<blockquote>
<p>(Catching up on this thread...) For context, the code behind the WAT that you posted is probably coming from somewhere like this in LLVM: <a href="https://github.com/llvm-mirror/compiler-rt/blob/master/lib/builtins/multi3.c">https://github.com/llvm-mirror/compiler-rt/blob/master/lib/builtins/multi3.c</a>. There is quite a bit of shifting and masking there which, as we can see in the WAT, get translated directly to WebAssembly.</p>
<p>I'd be interested to understand what library is being used and how you're using it (e.g., how come <code>__multi3</code> is on the hot path?). Here's why:<br>
 a. it could be that the library could be tweaked for better compilation to Wasm (e.g., should the algorithm use SIMD instead?)<br>
 b. if it is a widely-used library, then it motivates improving this sequence in Wasmtime (or even in Wasm itself)</p>
<p>To optimize this in Wasmtime, I suspect the bottom-up approach (i.e., attempting to get rid of the extra shifting and masking) is going to be "good enough" relative to the code sequence currently emitted by Clang in native code (@cfallin has that) and will be less brittle than trying to match the entire function or the called name. But another option might be to attempt to optimize this at the LLVM layer: perhaps it does not need to be as literal about how it translates the C code I linked to to the WAT @shamatar posted.</p>
</blockquote>



<a name="280524464"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234077%20__multi3%20optimization/near/280524464" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234077.20__multi3.20optimization.html#280524464">(Apr 28 2022 at 16:59)</a>:</h4>
<p>shamatar <a href="https://github.com/bytecodealliance/wasmtime/issues/4077#issuecomment-1112445074">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4077">issue #4077</a>:</p>
<blockquote>
<p>I've made a minimal example of the typical <code>u64 * u64 + u64 + u64</code> operation that is non-overflowing due to output range being <code>(2^64 - 1) * (2^64 - 1) + 2 * (2^64 - 1) = 2^128 - 1</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(bigint_helper_methods)]</span><span class="w"></span>

<span class="cp">#[repr(C)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">U128Pair</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">low</span>: <span class="kt">u64</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">high</span>: <span class="kt">u64</span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// #[no_mangle]</span>
<span class="c1">// pub extern "C" fn mac(a: u64, b: u64, c: u64, carry: u64) -&gt; U128Pair {</span>
<span class="c1">//     let result = (a as u128) * (b as u128) + (c as u128) + (carry as u128);</span>

<span class="c1">//     U128Pair {</span>
<span class="c1">//         low: result as u64,</span>
<span class="c1">//         high: (result &gt;&gt; 64) as u64</span>
<span class="c1">//     }</span>
<span class="c1">// }</span>

<span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">mac</span><span class="p">(</span><span class="n">a</span>: <span class="kt">u64</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="kt">u64</span><span class="p">,</span><span class="w"> </span><span class="n">c</span>: <span class="kt">u64</span><span class="p">,</span><span class="w"> </span><span class="n">carry</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">U128Pair</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">low</span><span class="p">,</span><span class="w"> </span><span class="n">high</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">carrying_mul</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">low</span><span class="p">,</span><span class="w"> </span><span class="n">of</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">low</span><span class="p">.</span><span class="n">overflowing_add</span><span class="p">(</span><span class="n">carry</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">high</span><span class="p">.</span><span class="n">wrapping_add</span><span class="p">(</span><span class="n">of</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">U128Pair</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">low</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">high</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>(both the commented code and one using more explicit operations provides the same assembly. This is a typical way to do big integer math on CPU. SIMD optimizations are possible, but a separate field of the art due to non-carry SIMD, non-widening SIMD, and CPU frequency quircks if SIMD is used e.g. on Intel. So my example is an "average case" and solving exactly this part would be the most beneficial (I'm actually not in the need to have a speedup in this problem for any production code, but it's a nice free time task)</p>
<p>So compiler fits <code>__multi3</code> in there as half-width u128 multiplication. Even though the name is the same, it's actually not used in "full power" since high parts of arguments are constant zeroes. I think it's possible to match the internals of <code>__multi3</code>, but it's still more then just elimination of shifts - it must be replaced just 1 machine instruction + stack manipulation</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">export</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">mac</span><span class="p">(</span><span class="n">a</span>:<span class="p">{</span><span class="w"> </span><span class="n">a</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>:<span class="nc">long</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">b</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">c</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">d</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">e</span>:<span class="nc">long</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">f</span>:<span class="nc">long_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_pointer</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">stack_pointer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">multi3</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">L</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="n">i64_extend_i32_u</span><span class="p">(</span><span class="n">e</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>:<span class="nc">long</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i64_extend_i32_u</span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">c</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">stack_pointer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="n">multi3</span><span class="p">(</span><span class="n">a</span>:<span class="p">{</span><span class="w"> </span><span class="n">a</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>:<span class="nc">long</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">b</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">c</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">d</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">e</span>:<span class="nc">long</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">f</span>:<span class="nc">long</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">g</span>:<span class="nc">long</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">h</span>:<span class="nc">long</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">i</span>:<span class="nc">long</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">j</span>:<span class="nc">long</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">k</span>:<span class="nc">long</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">4294967295</span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">4294967295</span><span class="n">L</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">         </span><span class="p">((</span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">32</span><span class="n">L</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">32</span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">g</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">32</span><span class="n">L</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">i64_extend_i32_u</span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">32</span><span class="n">L</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">32</span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">    </span><span class="n">i64_extend_i32_u</span><span class="p">(</span><span class="n">g</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">    </span><span class="n">e</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I can</p>
</blockquote>



<a name="280524482"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234077%20__multi3%20optimization/near/280524482" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234077.20__multi3.20optimization.html#280524482">(Apr 28 2022 at 16:59)</a>:</h4>
<p>shamatar edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4077#issuecomment-1112445074">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4077">issue #4077</a>:</p>
<blockquote>
<p>I've made a minimal example of the typical <code>u64 * u64 + u64 + u64</code> operation that is non-overflowing due to output range being <code>(2^64 - 1) * (2^64 - 1) + 2 * (2^64 - 1) = 2^128 - 1</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(bigint_helper_methods)]</span><span class="w"></span>

<span class="cp">#[repr(C)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">U128Pair</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">low</span>: <span class="kt">u64</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">high</span>: <span class="kt">u64</span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// #[no_mangle]</span>
<span class="c1">// pub extern "C" fn mac(a: u64, b: u64, c: u64, carry: u64) -&gt; U128Pair {</span>
<span class="c1">//     let result = (a as u128) * (b as u128) + (c as u128) + (carry as u128);</span>

<span class="c1">//     U128Pair {</span>
<span class="c1">//         low: result as u64,</span>
<span class="c1">//         high: (result &gt;&gt; 64) as u64</span>
<span class="c1">//     }</span>
<span class="c1">// }</span>

<span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">mac</span><span class="p">(</span><span class="n">a</span>: <span class="kt">u64</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="kt">u64</span><span class="p">,</span><span class="w"> </span><span class="n">c</span>: <span class="kt">u64</span><span class="p">,</span><span class="w"> </span><span class="n">carry</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">U128Pair</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">low</span><span class="p">,</span><span class="w"> </span><span class="n">high</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">carrying_mul</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">low</span><span class="p">,</span><span class="w"> </span><span class="n">of</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">low</span><span class="p">.</span><span class="n">overflowing_add</span><span class="p">(</span><span class="n">carry</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">high</span><span class="p">.</span><span class="n">wrapping_add</span><span class="p">(</span><span class="n">of</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">U128Pair</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">low</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">high</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>(both the commented code and one using more explicit operations provides the same assembly. This is a typical way to do big integer math on CPU. SIMD optimizations are possible, but a separate field of the art due to non-carry SIMD, non-widening SIMD, and CPU frequency quircks if SIMD is used e.g. on Intel. So my example is an "average case" and solving exactly this part would be the most beneficial (I'm actually not in the need to have a speedup in this problem for any production code, but it's a nice free time task)</p>
<p>So compiler fits <code>__multi3</code> in there as half-width u128 multiplication. Even though the name is the same, it's actually not used in "full power" since high parts of arguments are constant zeroes. I think it's possible to match the internals of <code>__multi3</code>, but it's still more then just elimination of shifts - it must be replaced just 1 machine instruction + stack manipulation</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">export</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">mac</span><span class="p">(</span><span class="n">a</span>:<span class="p">{</span><span class="w"> </span><span class="n">a</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>:<span class="nc">long</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">b</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">c</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">d</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">e</span>:<span class="nc">long</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">f</span>:<span class="nc">long_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_pointer</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">stack_pointer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">multi3</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">L</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="n">i64_extend_i32_u</span><span class="p">(</span><span class="n">e</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>:<span class="nc">long</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i64_extend_i32_u</span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">c</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">stack_pointer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="n">multi3</span><span class="p">(</span><span class="n">a</span>:<span class="p">{</span><span class="w"> </span><span class="n">a</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>:<span class="nc">long</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">b</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">c</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">d</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">e</span>:<span class="nc">long</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">f</span>:<span class="nc">long</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">g</span>:<span class="nc">long</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">h</span>:<span class="nc">long</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">i</span>:<span class="nc">long</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">j</span>:<span class="nc">long</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">k</span>:<span class="nc">long</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">4294967295</span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">4294967295</span><span class="n">L</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">         </span><span class="p">((</span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">32</span><span class="n">L</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">32</span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">g</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">32</span><span class="n">L</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">i64_extend_i32_u</span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">32</span><span class="n">L</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">32</span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">    </span><span class="n">i64_extend_i32_u</span><span class="p">(</span><span class="n">g</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">    </span><span class="n">e</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</blockquote>



<a name="280524753"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234077%20__multi3%20optimization/near/280524753" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234077.20__multi3.20optimization.html#280524753">(Apr 28 2022 at 17:01)</a>:</h4>
<p>shamatar edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4077#issuecomment-1112445074">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4077">issue #4077</a>:</p>
<blockquote>
<p>I've made a minimal example of the typical <code>u64 * u64 + u64 + u64</code> operation that is non-overflowing due to output range being <code>(2^64 - 1) * (2^64 - 1) + 2 * (2^64 - 1) = 2^128 - 1</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(bigint_helper_methods)]</span><span class="w"></span>

<span class="cp">#[repr(C)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">U128Pair</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">low</span>: <span class="kt">u64</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">high</span>: <span class="kt">u64</span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// #[no_mangle]</span>
<span class="c1">// pub extern "C" fn mac(a: u64, b: u64, c: u64, carry: u64) -&gt; U128Pair {</span>
<span class="c1">//     let result = (a as u128) * (b as u128) + (c as u128) + (carry as u128);</span>

<span class="c1">//     U128Pair {</span>
<span class="c1">//         low: result as u64,</span>
<span class="c1">//         high: (result &gt;&gt; 64) as u64</span>
<span class="c1">//     }</span>
<span class="c1">// }</span>

<span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">mac</span><span class="p">(</span><span class="n">a</span>: <span class="kt">u64</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="kt">u64</span><span class="p">,</span><span class="w"> </span><span class="n">c</span>: <span class="kt">u64</span><span class="p">,</span><span class="w"> </span><span class="n">carry</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">U128Pair</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">low</span><span class="p">,</span><span class="w"> </span><span class="n">high</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">carrying_mul</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">low</span><span class="p">,</span><span class="w"> </span><span class="n">of</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">low</span><span class="p">.</span><span class="n">overflowing_add</span><span class="p">(</span><span class="n">carry</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">high</span><span class="p">.</span><span class="n">wrapping_add</span><span class="p">(</span><span class="n">of</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">U128Pair</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">low</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">high</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>both the commented code and one using more explicit operations provides the same assembly. This is a typical way to do big integer math on CPU. SIMD optimizations are possible, but a separate field of the art due to non-carry SIMD, non-widening SIMD, and CPU frequency quircks if SIMD is used e.g. on Intel. So my example is an "average case" and solving exactly this part would be the most beneficial (I'm actually not in the need to have a speedup in this problem for any production code, but it's a nice free time task)</p>
<p>So compiler fits <code>__multi3</code> in there as half-width u128 multiplication. Even though the name is the same, it's actually not used in "full power" since high parts of arguments are constant zeroes. I think it's possible to match the internals of <code>__multi3</code>, but it's still more then just elimination of shifts - it must be replaced just 1 machine instruction + stack manipulation</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">export</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">mac</span><span class="p">(</span><span class="n">a</span>:<span class="p">{</span><span class="w"> </span><span class="n">a</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>:<span class="nc">long</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">b</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">c</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">d</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">e</span>:<span class="nc">long</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">f</span>:<span class="nc">long_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_pointer</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">stack_pointer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">multi3</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">L</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="n">i64_extend_i32_u</span><span class="p">(</span><span class="n">e</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>:<span class="nc">long</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i64_extend_i32_u</span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">c</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">stack_pointer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="n">multi3</span><span class="p">(</span><span class="n">a</span>:<span class="p">{</span><span class="w"> </span><span class="n">a</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>:<span class="nc">long</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">b</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">c</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">d</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">e</span>:<span class="nc">long</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">f</span>:<span class="nc">long</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">g</span>:<span class="nc">long</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">h</span>:<span class="nc">long</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">i</span>:<span class="nc">long</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">j</span>:<span class="nc">long</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">k</span>:<span class="nc">long</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">4294967295</span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">4294967295</span><span class="n">L</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">         </span><span class="p">((</span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">32</span><span class="n">L</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">32</span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">g</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">32</span><span class="n">L</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">i64_extend_i32_u</span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">32</span><span class="n">L</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">32</span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">    </span><span class="n">i64_extend_i32_u</span><span class="p">(</span><span class="n">g</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">    </span><span class="n">e</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</blockquote>



<a name="280524991"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234077%20__multi3%20optimization/near/280524991" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234077.20__multi3.20optimization.html#280524991">(Apr 28 2022 at 17:02)</a>:</h4>
<p>shamatar edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4077#issuecomment-1112445074">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4077">issue #4077</a>:</p>
<blockquote>
<p>I've made a minimal example of the typical <code>u64 * u64 + u64 + u64</code> operation that is non-overflowing due to output range being <code>(2^64 - 1) * (2^64 - 1) + 2 * (2^64 - 1) = 2^128 - 1</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(bigint_helper_methods)]</span><span class="w"></span>

<span class="cp">#[repr(C)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">U128Pair</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">low</span>: <span class="kt">u64</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">high</span>: <span class="kt">u64</span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// #[no_mangle]</span>
<span class="c1">// pub extern "C" fn mac(a: u64, b: u64, c: u64, carry: u64) -&gt; U128Pair {</span>
<span class="c1">//     let result = (a as u128) * (b as u128) + (c as u128) + (carry as u128);</span>

<span class="c1">//     U128Pair {</span>
<span class="c1">//         low: result as u64,</span>
<span class="c1">//         high: (result &gt;&gt; 64) as u64</span>
<span class="c1">//     }</span>
<span class="c1">// }</span>

<span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">mac</span><span class="p">(</span><span class="n">a</span>: <span class="kt">u64</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="kt">u64</span><span class="p">,</span><span class="w"> </span><span class="n">c</span>: <span class="kt">u64</span><span class="p">,</span><span class="w"> </span><span class="n">carry</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">U128Pair</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">low</span><span class="p">,</span><span class="w"> </span><span class="n">high</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">carrying_mul</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">low</span><span class="p">,</span><span class="w"> </span><span class="n">of</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">low</span><span class="p">.</span><span class="n">overflowing_add</span><span class="p">(</span><span class="n">carry</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">high</span><span class="p">.</span><span class="n">wrapping_add</span><span class="p">(</span><span class="n">of</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">U128Pair</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">low</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">high</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>both the commented code and one using more explicit operations provides the same assembly. This is a typical way to do big integer math on CPU. SIMD optimizations are possible, but a separate field of the art due to non-carry SIMD, non-widening SIMD, and CPU frequency quircks if SIMD is used e.g. on Intel. So my example is an "average case" and solving exactly this part would be the most beneficial (I'm actually not in the need to have a speedup in this problem for any production code, but it's a nice free time task)</p>
<p>So compiler fits <code>__multi3</code> in there as half-width u128 multiplication. Even though the name is the same, it's actually not used in "full power" since high parts of arguments are constant zeroes. I think it's possible to match the internals of <code>__multi3</code>, but it's still more then just elimination of shifts - it must be replaced just 1 machine instruction + stack manipulation</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">export</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">mac</span><span class="p">(</span><span class="n">a</span>:<span class="p">{</span><span class="w"> </span><span class="n">a</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>:<span class="nc">long</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">b</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">c</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">d</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">e</span>:<span class="nc">long</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">f</span>:<span class="nc">long_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_pointer</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">stack_pointer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">multi3</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">L</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="n">i64_extend_i32_u</span><span class="p">(</span><span class="n">e</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>:<span class="nc">long</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i64_extend_i32_u</span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">c</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">stack_pointer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="n">multi3</span><span class="p">(</span><span class="n">a</span>:<span class="p">{</span><span class="w"> </span><span class="n">a</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>:<span class="nc">long</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">b</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">c</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">d</span>:<span class="nc">long</span><span class="p">,</span><span class="w"> </span><span class="n">e</span>:<span class="nc">long</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">f</span>:<span class="nc">long</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">g</span>:<span class="nc">long</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">h</span>:<span class="nc">long</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">i</span>:<span class="nc">long</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">j</span>:<span class="nc">long</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">k</span>:<span class="nc">long</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">4294967295</span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">4294967295</span><span class="n">L</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">         </span><span class="p">((</span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">32</span><span class="n">L</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">32</span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">g</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">32</span><span class="n">L</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">i64_extend_i32_u</span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">32</span><span class="n">L</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">32</span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">    </span><span class="n">i64_extend_i32_u</span><span class="p">(</span><span class="n">g</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">    </span><span class="n">e</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Note: it's actually only possible to replace the way how <code>__multi3</code> is used in here, and not in general, since it's indeed full-width multiplication for u64 while expressed as half-width mul for u128 with constant zero high parts <code>multi3(f, c, 0L, b, 0L);</code> </p>
</blockquote>



<a name="280525583"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234077%20__multi3%20optimization/near/280525583" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234077.20__multi3.20optimization.html#280525583">(Apr 28 2022 at 17:07)</a>:</h4>
<p>shamatar <a href="https://github.com/bytecodealliance/wasmtime/issues/4077#issuecomment-1112452255">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4077">issue #4077</a>:</p>
<blockquote>
<p>I should add that even though it may be possible to fine tune LLVM too (even further from my world), it's still not possible to generate WASM code that would be better than internals of <code>__multi3</code> (we can only remove <code>e * b + d * c;</code> subexpression as trivial multiplications by 0), so the problem will move from matching current <code>__multi3</code> internals into matching just some other similar function body</p>
</blockquote>



<a name="280526027"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234077%20__multi3%20optimization/near/280526027" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234077.20__multi3.20optimization.html#280526027">(Apr 28 2022 at 17:11)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/4077#issuecomment-1112455510">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4077">issue #4077</a>:</p>
<blockquote>
<blockquote>
<p>My impression on <a href="https://github.com/bytecodealliance/wasmtime/blob/b69fede72f6df81edbb0b3286b01e0a101a1758f/cranelift/codegen/src/isa/x64/lower.isle#L916">lower.isle</a> file is that it's a definition of "simple" rules to lower some short sequences of CLIF instructions to machine instructions, and not the rules for "large" pattern matching.</p>
</blockquote>
<p>It's potentially both! We're still in the midst of translating all of the basic lowering into ISLE, so that is most of what we have. But the design goal is absolutely to allow arbitrarily complex patterns, and we hope to grow the library of patterns we match and optimize over time.</p>
<p>I took a look at the gcc output on x86-64 for an <code>__int128 * __int128</code> case (in C) and I saw:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r8</span><span class="w"></span>
<span class="w">    </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rax</span><span class="w"></span>
<span class="w">    </span><span class="n">mulq</span><span class="w">    </span><span class="o">%</span><span class="n">rdi</span><span class="w"></span>
<span class="w">    </span><span class="n">imulq</span><span class="w">   </span><span class="o">%</span><span class="n">r8</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsi</span><span class="w"></span>
<span class="w">    </span><span class="n">addq</span><span class="w">    </span><span class="o">%</span><span class="n">rsi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rdx</span><span class="w"></span>
<span class="w">    </span><span class="n">imulq</span><span class="w">   </span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rcx</span><span class="w"></span>
<span class="w">    </span><span class="n">addq</span><span class="w">    </span><span class="o">%</span><span class="n">rcx</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rdx</span><span class="w"></span>
</code></pre></div>
<p>so it should be possible to do a lot better here, and without recent extensions like mulx/adx.</p>
</blockquote>



<a name="280526793"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234077%20__multi3%20optimization/near/280526793" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234077.20__multi3.20optimization.html#280526793">(Apr 28 2022 at 17:16)</a>:</h4>
<p>shamatar <a href="https://github.com/bytecodealliance/wasmtime/issues/4077#issuecomment-1112460211">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4077">issue #4077</a>:</p>
<blockquote>
<blockquote>
<p>so it should be possible to do a lot better here, and without recent extensions like mulx/adx.</p>
</blockquote>
<p>Yes, it's kind of possible due to two carry chains (in my example of <code>u64 * u64 + u64 + u64</code>), but it would be the next step (and <code>adx</code> is much more useful for even "larger" math, like u256 full width multiplication).</p>
<p>So my example's "optimal" code is like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">mac</span>:
        <span class="nc">mov</span><span class="w">     </span><span class="n">r8</span><span class="p">,</span><span class="w"> </span><span class="n">rdx</span><span class="w"></span>
<span class="w">        </span><span class="n">mov</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">rsi</span><span class="w"></span>
<span class="w">        </span><span class="n">mul</span><span class="w">     </span><span class="n">rdi</span><span class="w"></span>
<span class="w">        </span><span class="n">add</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">r8</span><span class="w"></span>
<span class="w">        </span><span class="n">adc</span><span class="w">     </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">        </span><span class="n">add</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">rcx</span><span class="w"></span>
<span class="w">        </span><span class="n">adc</span><span class="w">     </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">        </span><span class="n">ret</span><span class="w"></span>
</code></pre></div>
<p>where <code>adx</code> will allow to speedup two carry propagation chains. <code>mulx</code> allows more flexible register allocation, but none of the compilers uses it in practice as far as I known</p>
</blockquote>



<a name="281171069"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234077%20__multi3%20optimization/near/281171069" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234077.20__multi3.20optimization.html#281171069">(May 04 2022 at 15:20)</a>:</h4>
<p>sparker-arm <a href="https://github.com/bytecodealliance/wasmtime/issues/4077#issuecomment-1117481076">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4077">issue #4077</a>:</p>
<blockquote>
<p>Since cranelift supports i128, maybe we could perform clif-to-clif transforms to generate a i128 mul (if a backend wants that). That way we can avoid each backend having to add complicated matching patterns. Plus, at least for aarch64, there's already a lot of existing support for i128.</p>
</blockquote>



<a name="281190063"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234077%20__multi3%20optimization/near/281190063" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234077.20__multi3.20optimization.html#281190063">(May 04 2022 at 17:27)</a>:</h4>
<p>shamatar <a href="https://github.com/bytecodealliance/wasmtime/issues/4077#issuecomment-1117614605">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4077">issue #4077</a>:</p>
<blockquote>
<p>I'm still trying to understand pattern-matching and have it (at least fragile) to capture the full body of <code>__multi3</code>. Then it can be replaced by <code>i128</code> half-width multiplication or something else. Then I'd have to make another large step to inline it and also constant-fold it (since in practice it's not <code>i128</code> half-mul, but <code>i64</code> full-mul), that is most likely even more complex</p>
</blockquote>



<a name="281376650"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234077%20__multi3%20optimization/near/281376650" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234077.20__multi3.20optimization.html#281376650">(May 06 2022 at 00:33)</a>:</h4>
<p>shamatar <a href="https://github.com/bytecodealliance/wasmtime/issues/4077#issuecomment-1119163032">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4077">issue #4077</a>:</p>
<blockquote>
<p>I've tried to insert an optimization into cranelift directly. I should be able to match the full body of the generated <code>__multi3</code> and transform it into <code>i128</code> multiplication. Please check the #4106</p>
</blockquote>



<a name="281512803"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234077%20__multi3%20optimization/near/281512803" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234077.20__multi3.20optimization.html#281512803">(May 07 2022 at 02:08)</a>:</h4>
<p>shamatar <a href="https://github.com/bytecodealliance/wasmtime/issues/4077#issuecomment-1120110793">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4077">issue #4077</a>:</p>
<blockquote>
<p>Made an initial functional PR, folds from</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v5</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v6</span>: <span class="kt">i64</span><span class="p">)</span>:
<span class="o">@</span><span class="mi">5130</span><span class="w">                               </span><span class="n">v7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="o">@</span><span class="mi">5136</span><span class="w">                               </span><span class="n">v8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mh">0xffff_ffff</span><span class="w"></span>
<span class="o">@</span><span class="mi">513</span><span class="n">c</span><span class="w">                               </span><span class="n">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">band_imm</span><span class="w"> </span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="mh">0xffff_ffff</span><span class="w"></span>
<span class="o">@</span><span class="mi">5141</span><span class="w">                               </span><span class="n">v10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mh">0xffff_ffff</span><span class="w"></span>
<span class="o">@</span><span class="mi">5147</span><span class="w">                               </span><span class="n">v11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">band_imm</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="mh">0xffff_ffff</span><span class="w"></span>
<span class="o">@</span><span class="mi">514</span><span class="n">a</span><span class="w">                               </span><span class="n">v12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imul</span><span class="w"> </span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">v11</span><span class="w"></span>
<span class="o">@</span><span class="mi">5151</span><span class="w">                               </span><span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">5153</span><span class="w">                               </span><span class="n">v14</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ushr_imm</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">5156</span><span class="w">                               </span><span class="n">v15</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imul</span><span class="w"> </span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span><span class="w"></span>
<span class="o">@</span><span class="mi">515</span><span class="n">b</span><span class="w">                               </span><span class="n">v16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">515</span><span class="n">d</span><span class="w">                               </span><span class="n">v17</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ushr_imm</span><span class="w"> </span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">5162</span><span class="w">                               </span><span class="n">v18</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imul</span><span class="w"> </span><span class="n">v17</span><span class="p">,</span><span class="w"> </span><span class="n">v11</span><span class="w"></span>
<span class="o">@</span><span class="mi">5163</span><span class="w">                               </span><span class="n">v19</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v18</span><span class="w"></span>
<span class="o">@</span><span class="mi">5166</span><span class="w">                               </span><span class="n">v20</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">5168</span><span class="w">                               </span><span class="n">v21</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ishl_imm</span><span class="w"> </span><span class="n">v19</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">5169</span><span class="w">                               </span><span class="n">v22</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v12</span><span class="p">,</span><span class="w"> </span><span class="n">v21</span><span class="w"></span>
<span class="o">@</span><span class="mi">516</span><span class="n">c</span><span class="w">                               </span><span class="n">v23</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">heap_addr</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">heap0</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="o">@</span><span class="mi">516</span><span class="n">c</span><span class="w">                               </span><span class="n">store</span><span class="w"> </span><span class="n">little</span><span class="w"> </span><span class="n">v22</span><span class="p">,</span><span class="w"> </span><span class="n">v23</span><span class="w"></span>
<span class="o">@</span><span class="mi">5175</span><span class="w">                               </span><span class="n">v24</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imul</span><span class="w"> </span><span class="n">v17</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span><span class="w"></span>
<span class="o">@</span><span class="mi">517</span><span class="n">a</span><span class="w">                               </span><span class="n">v25</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">ult</span><span class="w"> </span><span class="n">v19</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="w"></span>
<span class="o">@</span><span class="mi">517</span><span class="n">a</span><span class="w">                               </span><span class="n">v26</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bint</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="n">v25</span><span class="w"></span>
<span class="o">@</span><span class="mi">517</span><span class="n">b</span><span class="w">                               </span><span class="n">v27</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uextend</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v26</span><span class="w"></span>
<span class="o">@</span><span class="mi">517</span><span class="n">c</span><span class="w">                               </span><span class="n">v28</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">517</span><span class="n">e</span><span class="w">                               </span><span class="n">v29</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ishl_imm</span><span class="w"> </span><span class="n">v27</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">5181</span><span class="w">                               </span><span class="n">v30</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">5183</span><span class="w">                               </span><span class="n">v31</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ushr_imm</span><span class="w"> </span><span class="n">v19</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">5184</span><span class="w">                               </span><span class="n">v32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bor</span><span class="w"> </span><span class="n">v29</span><span class="p">,</span><span class="w"> </span><span class="n">v31</span><span class="w"></span>
<span class="o">@</span><span class="mi">5185</span><span class="w">                               </span><span class="n">v33</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v24</span><span class="p">,</span><span class="w"> </span><span class="n">v32</span><span class="w"></span>
<span class="o">@</span><span class="mi">518</span><span class="n">a</span><span class="w">                               </span><span class="n">v34</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">ult</span><span class="w"> </span><span class="n">v22</span><span class="p">,</span><span class="w"> </span><span class="n">v12</span><span class="w"></span>
<span class="o">@</span><span class="mi">518</span><span class="n">a</span><span class="w">                               </span><span class="n">v35</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bint</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="n">v34</span><span class="w"></span>
<span class="o">@</span><span class="mi">518</span><span class="n">b</span><span class="w">                               </span><span class="n">v36</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uextend</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v35</span><span class="w"></span>
<span class="o">@</span><span class="mi">518</span><span class="n">c</span><span class="w">                               </span><span class="n">v37</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v33</span><span class="p">,</span><span class="w"> </span><span class="n">v36</span><span class="w"></span>
<span class="o">@</span><span class="mi">5191</span><span class="w">                               </span><span class="n">v38</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imul</span><span class="w"> </span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>
<span class="o">@</span><span class="mi">5196</span><span class="w">                               </span><span class="n">v39</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imul</span><span class="w"> </span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span><span class="w"></span>
<span class="o">@</span><span class="mi">5197</span><span class="w">                               </span><span class="n">v40</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v38</span><span class="p">,</span><span class="w"> </span><span class="n">v39</span><span class="w"></span>
<span class="o">@</span><span class="mi">5198</span><span class="w">                               </span><span class="n">v41</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v37</span><span class="p">,</span><span class="w"> </span><span class="n">v40</span><span class="w"></span>
<span class="o">@</span><span class="mi">5199</span><span class="w">                               </span><span class="n">v42</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">heap_addr</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">heap0</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="o">@</span><span class="mi">5199</span><span class="w">                               </span><span class="n">store</span><span class="w"> </span><span class="n">little</span><span class="w"> </span><span class="n">v41</span><span class="p">,</span><span class="w"> </span><span class="n">v42</span><span class="o">+</span><span class="mi">8</span><span class="w"></span>
<span class="o">@</span><span class="mi">519</span><span class="n">c</span><span class="w">                               </span><span class="n">jump</span><span class="w"> </span><span class="n">block1</span><span class="w"></span>

<span class="w">                                </span><span class="n">block1</span>:
<span class="o">@</span><span class="mi">519</span><span class="n">c</span><span class="w">                               </span><span class="k">return</span><span class="w"></span>
</code></pre></div>
<p>into </p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v5</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v6</span>: <span class="kt">i64</span><span class="p">)</span>:
                                    <span class="nc">v43</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconcat</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span><span class="w"></span>
<span class="w">                                    </span><span class="n">v44</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconcat</span><span class="w"> </span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">v6</span><span class="w"></span>
<span class="w">                                    </span><span class="n">v45</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imul</span><span class="w"> </span><span class="n">v43</span><span class="p">,</span><span class="w"> </span><span class="n">v44</span><span class="w"></span>
<span class="w">                                    </span><span class="n">v46</span><span class="p">,</span><span class="w"> </span><span class="n">v47</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isplit</span><span class="w"> </span><span class="n">v45</span><span class="w"></span>
<span class="o">@</span><span class="mi">5130</span><span class="w">                               </span><span class="n">v7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="o">@</span><span class="mi">5136</span><span class="w">                               </span><span class="n">v8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mh">0xffff_ffff</span><span class="w"></span>
<span class="o">@</span><span class="mi">513</span><span class="n">c</span><span class="w">                               </span><span class="n">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5141</span><span class="w">                               </span><span class="n">v10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mh">0xffff_ffff</span><span class="w"></span>
<span class="o">@</span><span class="mi">5147</span><span class="w">                               </span><span class="n">v11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">514</span><span class="n">a</span><span class="w">                               </span><span class="n">v12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5151</span><span class="w">                               </span><span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">5153</span><span class="w">                               </span><span class="n">v14</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5156</span><span class="w">                               </span><span class="n">v15</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">515</span><span class="n">b</span><span class="w">                               </span><span class="n">v16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">515</span><span class="n">d</span><span class="w">                               </span><span class="n">v17</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5162</span><span class="w">                               </span><span class="n">v18</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5163</span><span class="w">                               </span><span class="n">v19</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5166</span><span class="w">                               </span><span class="n">v20</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">5168</span><span class="w">                               </span><span class="n">v21</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5169</span><span class="w">                               </span><span class="n">v22</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">516</span><span class="n">c</span><span class="w">                               </span><span class="n">v23</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">heap_addr</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">heap0</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="o">@</span><span class="mi">516</span><span class="n">c</span><span class="w">                               </span><span class="n">store</span><span class="w"> </span><span class="n">little</span><span class="w"> </span><span class="n">v46</span><span class="p">,</span><span class="w"> </span><span class="n">v23</span><span class="w"></span>
<span class="o">@</span><span class="mi">5175</span><span class="w">                               </span><span class="n">v24</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">517</span><span class="n">a</span><span class="w">                               </span><span class="n">v25</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">517</span><span class="n">a</span><span class="w">                               </span><span class="n">v26</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">517</span><span class="n">b</span><span class="w">                               </span><span class="n">v27</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">517</span><span class="n">c</span><span class="w">                               </span><span class="n">v28</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">517</span><span class="n">e</span><span class="w">                               </span><span class="n">v29</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5181</span><span class="w">                               </span><span class="n">v30</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">5183</span><span class="w">                               </span><span class="n">v31</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5184</span><span class="w">                               </span><span class="n">v32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5185</span><span class="w">                               </span><span class="n">v33</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">518</span><span class="n">a</span><span class="w">                               </span><span class="n">v34</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">518</span><span class="n">a</span><span class="w">                               </span><span class="n">v35</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">518</span><span class="n">b</span><span class="w">                               </span><span class="n">v36</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">518</span><span class="n">c</span><span class="w">                               </span><span class="n">v37</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5191</span><span class="w">                               </span><span class="n">v38</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5196</span><span class="w">                               </span><span class="n">v39</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5197</span><span class="w">                               </span><span class="n">v40</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5198</span><span class="w">                               </span><span class="n">v41</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5199</span><span class="w">                               </span><span class="n">v42</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">heap_addr</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">heap0</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="o">@</span><span class="mi">5199</span><span class="w">                               </span><span class="n">store</span><span class="w"> </span><span class="n">little</span><span class="w"> </span><span class="n">v47</span><span class="p">,</span><span class="w"> </span><span class="n">v42</span><span class="o">+</span><span class="mi">8</span><span class="w"></span>
<span class="o">@</span><span class="mi">519</span><span class="n">c</span><span class="w">                               </span><span class="n">jump</span><span class="w"> </span><span class="n">block1</span><span class="w"></span>

<span class="w">                                </span><span class="n">block1</span>:
<span class="o">@</span><span class="mi">519</span><span class="n">c</span><span class="w">                               </span><span class="k">return</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="281512858"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234077%20__multi3%20optimization/near/281512858" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234077.20__multi3.20optimization.html#281512858">(May 07 2022 at 02:09)</a>:</h4>
<p>shamatar edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4077#issuecomment-1120110793">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4077">issue #4077</a>:</p>
<blockquote>
<p>Made an initial functional PR, folds from</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v5</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v6</span>: <span class="kt">i64</span><span class="p">)</span>:
<span class="o">@</span><span class="mi">5130</span><span class="w">                               </span><span class="n">v7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="o">@</span><span class="mi">5136</span><span class="w">                               </span><span class="n">v8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mh">0xffff_ffff</span><span class="w"></span>
<span class="o">@</span><span class="mi">513</span><span class="n">c</span><span class="w">                               </span><span class="n">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">band_imm</span><span class="w"> </span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="mh">0xffff_ffff</span><span class="w"></span>
<span class="o">@</span><span class="mi">5141</span><span class="w">                               </span><span class="n">v10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mh">0xffff_ffff</span><span class="w"></span>
<span class="o">@</span><span class="mi">5147</span><span class="w">                               </span><span class="n">v11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">band_imm</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="mh">0xffff_ffff</span><span class="w"></span>
<span class="o">@</span><span class="mi">514</span><span class="n">a</span><span class="w">                               </span><span class="n">v12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imul</span><span class="w"> </span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">v11</span><span class="w"></span>
<span class="o">@</span><span class="mi">5151</span><span class="w">                               </span><span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">5153</span><span class="w">                               </span><span class="n">v14</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ushr_imm</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">5156</span><span class="w">                               </span><span class="n">v15</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imul</span><span class="w"> </span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span><span class="w"></span>
<span class="o">@</span><span class="mi">515</span><span class="n">b</span><span class="w">                               </span><span class="n">v16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">515</span><span class="n">d</span><span class="w">                               </span><span class="n">v17</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ushr_imm</span><span class="w"> </span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">5162</span><span class="w">                               </span><span class="n">v18</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imul</span><span class="w"> </span><span class="n">v17</span><span class="p">,</span><span class="w"> </span><span class="n">v11</span><span class="w"></span>
<span class="o">@</span><span class="mi">5163</span><span class="w">                               </span><span class="n">v19</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v18</span><span class="w"></span>
<span class="o">@</span><span class="mi">5166</span><span class="w">                               </span><span class="n">v20</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">5168</span><span class="w">                               </span><span class="n">v21</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ishl_imm</span><span class="w"> </span><span class="n">v19</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">5169</span><span class="w">                               </span><span class="n">v22</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v12</span><span class="p">,</span><span class="w"> </span><span class="n">v21</span><span class="w"></span>
<span class="o">@</span><span class="mi">516</span><span class="n">c</span><span class="w">                               </span><span class="n">v23</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">heap_addr</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">heap0</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="o">@</span><span class="mi">516</span><span class="n">c</span><span class="w">                               </span><span class="n">store</span><span class="w"> </span><span class="n">little</span><span class="w"> </span><span class="n">v22</span><span class="p">,</span><span class="w"> </span><span class="n">v23</span><span class="w"></span>
<span class="o">@</span><span class="mi">5175</span><span class="w">                               </span><span class="n">v24</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imul</span><span class="w"> </span><span class="n">v17</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span><span class="w"></span>
<span class="o">@</span><span class="mi">517</span><span class="n">a</span><span class="w">                               </span><span class="n">v25</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">ult</span><span class="w"> </span><span class="n">v19</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="w"></span>
<span class="o">@</span><span class="mi">517</span><span class="n">a</span><span class="w">                               </span><span class="n">v26</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bint</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="n">v25</span><span class="w"></span>
<span class="o">@</span><span class="mi">517</span><span class="n">b</span><span class="w">                               </span><span class="n">v27</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uextend</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v26</span><span class="w"></span>
<span class="o">@</span><span class="mi">517</span><span class="n">c</span><span class="w">                               </span><span class="n">v28</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">517</span><span class="n">e</span><span class="w">                               </span><span class="n">v29</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ishl_imm</span><span class="w"> </span><span class="n">v27</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">5181</span><span class="w">                               </span><span class="n">v30</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">5183</span><span class="w">                               </span><span class="n">v31</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ushr_imm</span><span class="w"> </span><span class="n">v19</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">5184</span><span class="w">                               </span><span class="n">v32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bor</span><span class="w"> </span><span class="n">v29</span><span class="p">,</span><span class="w"> </span><span class="n">v31</span><span class="w"></span>
<span class="o">@</span><span class="mi">5185</span><span class="w">                               </span><span class="n">v33</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v24</span><span class="p">,</span><span class="w"> </span><span class="n">v32</span><span class="w"></span>
<span class="o">@</span><span class="mi">518</span><span class="n">a</span><span class="w">                               </span><span class="n">v34</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">ult</span><span class="w"> </span><span class="n">v22</span><span class="p">,</span><span class="w"> </span><span class="n">v12</span><span class="w"></span>
<span class="o">@</span><span class="mi">518</span><span class="n">a</span><span class="w">                               </span><span class="n">v35</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bint</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="n">v34</span><span class="w"></span>
<span class="o">@</span><span class="mi">518</span><span class="n">b</span><span class="w">                               </span><span class="n">v36</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uextend</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v35</span><span class="w"></span>
<span class="o">@</span><span class="mi">518</span><span class="n">c</span><span class="w">                               </span><span class="n">v37</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v33</span><span class="p">,</span><span class="w"> </span><span class="n">v36</span><span class="w"></span>
<span class="o">@</span><span class="mi">5191</span><span class="w">                               </span><span class="n">v38</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imul</span><span class="w"> </span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>
<span class="o">@</span><span class="mi">5196</span><span class="w">                               </span><span class="n">v39</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imul</span><span class="w"> </span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span><span class="w"></span>
<span class="o">@</span><span class="mi">5197</span><span class="w">                               </span><span class="n">v40</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v38</span><span class="p">,</span><span class="w"> </span><span class="n">v39</span><span class="w"></span>
<span class="o">@</span><span class="mi">5198</span><span class="w">                               </span><span class="n">v41</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v37</span><span class="p">,</span><span class="w"> </span><span class="n">v40</span><span class="w"></span>
<span class="o">@</span><span class="mi">5199</span><span class="w">                               </span><span class="n">v42</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">heap_addr</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">heap0</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="o">@</span><span class="mi">5199</span><span class="w">                               </span><span class="n">store</span><span class="w"> </span><span class="n">little</span><span class="w"> </span><span class="n">v41</span><span class="p">,</span><span class="w"> </span><span class="n">v42</span><span class="o">+</span><span class="mi">8</span><span class="w"></span>
<span class="o">@</span><span class="mi">519</span><span class="n">c</span><span class="w">                               </span><span class="n">jump</span><span class="w"> </span><span class="n">block1</span><span class="w"></span>

<span class="w">                                </span><span class="n">block1</span>:
<span class="o">@</span><span class="mi">519</span><span class="n">c</span><span class="w">                               </span><span class="k">return</span><span class="w"></span>
</code></pre></div>
<p>into </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v5</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v6</span>: <span class="kt">i64</span><span class="p">)</span>:
                                    <span class="nc">v43</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconcat</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span><span class="w"></span>
<span class="w">                                    </span><span class="n">v44</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconcat</span><span class="w"> </span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">v6</span><span class="w"></span>
<span class="w">                                    </span><span class="n">v45</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imul</span><span class="w"> </span><span class="n">v43</span><span class="p">,</span><span class="w"> </span><span class="n">v44</span><span class="w"></span>
<span class="w">                                    </span><span class="n">v46</span><span class="p">,</span><span class="w"> </span><span class="n">v47</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isplit</span><span class="w"> </span><span class="n">v45</span><span class="w"></span>
<span class="o">@</span><span class="mi">5130</span><span class="w">                               </span><span class="n">v7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="o">@</span><span class="mi">5136</span><span class="w">                               </span><span class="n">v8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mh">0xffff_ffff</span><span class="w"></span>
<span class="o">@</span><span class="mi">513</span><span class="n">c</span><span class="w">                               </span><span class="n">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5141</span><span class="w">                               </span><span class="n">v10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mh">0xffff_ffff</span><span class="w"></span>
<span class="o">@</span><span class="mi">5147</span><span class="w">                               </span><span class="n">v11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">514</span><span class="n">a</span><span class="w">                               </span><span class="n">v12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5151</span><span class="w">                               </span><span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">5153</span><span class="w">                               </span><span class="n">v14</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5156</span><span class="w">                               </span><span class="n">v15</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">515</span><span class="n">b</span><span class="w">                               </span><span class="n">v16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">515</span><span class="n">d</span><span class="w">                               </span><span class="n">v17</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5162</span><span class="w">                               </span><span class="n">v18</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5163</span><span class="w">                               </span><span class="n">v19</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5166</span><span class="w">                               </span><span class="n">v20</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">5168</span><span class="w">                               </span><span class="n">v21</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5169</span><span class="w">                               </span><span class="n">v22</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">516</span><span class="n">c</span><span class="w">                               </span><span class="n">v23</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">heap_addr</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">heap0</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="o">@</span><span class="mi">516</span><span class="n">c</span><span class="w">                               </span><span class="n">store</span><span class="w"> </span><span class="n">little</span><span class="w"> </span><span class="n">v46</span><span class="p">,</span><span class="w"> </span><span class="n">v23</span><span class="w"></span>
<span class="o">@</span><span class="mi">5175</span><span class="w">                               </span><span class="n">v24</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">517</span><span class="n">a</span><span class="w">                               </span><span class="n">v25</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">517</span><span class="n">a</span><span class="w">                               </span><span class="n">v26</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">517</span><span class="n">b</span><span class="w">                               </span><span class="n">v27</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">517</span><span class="n">c</span><span class="w">                               </span><span class="n">v28</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">517</span><span class="n">e</span><span class="w">                               </span><span class="n">v29</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5181</span><span class="w">                               </span><span class="n">v30</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="o">@</span><span class="mi">5183</span><span class="w">                               </span><span class="n">v31</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5184</span><span class="w">                               </span><span class="n">v32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5185</span><span class="w">                               </span><span class="n">v33</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">518</span><span class="n">a</span><span class="w">                               </span><span class="n">v34</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">518</span><span class="n">a</span><span class="w">                               </span><span class="n">v35</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">518</span><span class="n">b</span><span class="w">                               </span><span class="n">v36</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">518</span><span class="n">c</span><span class="w">                               </span><span class="n">v37</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5191</span><span class="w">                               </span><span class="n">v38</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5196</span><span class="w">                               </span><span class="n">v39</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5197</span><span class="w">                               </span><span class="n">v40</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5198</span><span class="w">                               </span><span class="n">v41</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nop</span><span class="w"></span>
<span class="o">@</span><span class="mi">5199</span><span class="w">                               </span><span class="n">v42</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">heap_addr</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">heap0</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="o">@</span><span class="mi">5199</span><span class="w">                               </span><span class="n">store</span><span class="w"> </span><span class="n">little</span><span class="w"> </span><span class="n">v47</span><span class="p">,</span><span class="w"> </span><span class="n">v42</span><span class="o">+</span><span class="mi">8</span><span class="w"></span>
<span class="o">@</span><span class="mi">519</span><span class="n">c</span><span class="w">                               </span><span class="n">jump</span><span class="w"> </span><span class="n">block1</span><span class="w"></span>

<span class="w">                                </span><span class="n">block1</span>:
<span class="o">@</span><span class="mi">519</span><span class="n">c</span><span class="w">                               </span><span class="k">return</span><span class="w"></span>
</code></pre></div>
<p>Very naive benchmark gives around 30% speedup</p>
</blockquote>



<a name="281513981"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234077%20__multi3%20optimization/near/281513981" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234077.20__multi3.20optimization.html#281513981">(May 07 2022 at 02:30)</a>:</h4>
<p>shamatar <a href="https://github.com/bytecodealliance/wasmtime/issues/4077#issuecomment-1120114574">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4077">issue #4077</a>:</p>
<blockquote>
<p>Few comments:</p>
<ul>
<li>is there any pass that removes unused values? I believe it should be, but I'd like to trigger it manually</li>
<li>it may be a better options if instead of concat - imul - split I'd try manual implementation using imul/umulhi </li>
<li>is there any inlining step? In my benchmarks I've tried when the main MAC arithmetic function is "extern C" and normal Rust with "inline" attribute and there is no difference, that most likely indicated that "__multi3" is inserted by the compiler backend at the later stages. And after I substantially reduce the body of "__multi3" it should be a good candidate for inlining, and it will also give me more information to work with, like the fact that parts of the input are always 0</li>
</ul>
</blockquote>



<a name="281533007"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234077%20__multi3%20optimization/near/281533007" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234077.20__multi3.20optimization.html#281533007">(May 07 2022 at 10:33)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/4077#issuecomment-1120183754">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4077">issue #4077</a>:</p>
<blockquote>
<blockquote>
<p>is there any pass that removes unused values? I believe it should be, but I'd like to trigger it manually</p>
</blockquote>
<p>Yes, the dce pass. Note that lowering to the backend specific ir already does this implicitly. Also I think you shouldn't replace the instructions with nops. It results in invalid clif ir (as nop doesn't return any values) and it is incorrect if any of the instruction return values are used elsewhere. For example because you matched a function that looks somewhat like __multi3 but not exactly.</p>
<blockquote>
<p>is there any inlining step?</p>
</blockquote>
<p>No, there isn't. It is also non-trivial to implement as currently every function is independently lowered to clif ir, optimized and codegened to native code. Wasmtime even compiles multiple functions in parallel.</p>
</blockquote>



<a name="281539918"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234077%20__multi3%20optimization/near/281539918" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234077.20__multi3.20optimization.html#281539918">(May 07 2022 at 13:08)</a>:</h4>
<p>shamatar <a href="https://github.com/bytecodealliance/wasmtime/issues/4077#issuecomment-1120206950">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4077">issue #4077</a>:</p>
<blockquote>
<p>Ty @bjorn3 </p>
<p>I've analyzed my NOPing approach and it's overzealous indeed. </p>
<p>As for inlining - are there any plans to add it? It would require some form of "synchronization point" after CLIF generation, then inlining itself can also be parallelized, and then it's again a parallel native codegen again</p>
</blockquote>



<a name="281543364"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234077%20__multi3%20optimization/near/281543364" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234077.20__multi3.20optimization.html#281543364">(May 07 2022 at 14:32)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/4077#issuecomment-1120220068">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4077">issue #4077</a>:</p>
<blockquote>
<p>Yes, <a href="https://github.com/bytecodealliance/rfcs/blob/main/accepted/cranelift-roadmap-2022.md#inlining">https://github.com/bytecodealliance/rfcs/blob/main/accepted/cranelift-roadmap-2022.md#inlining</a></p>
</blockquote>



<a name="281773743"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234077%20__multi3%20optimization/near/281773743" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234077.20__multi3.20optimization.html#281773743">(May 10 2022 at 03:48)</a>:</h4>
<p>cfallin labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/4077">issue #4077</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>Implement an optimization pass that would eliminate the <code>__multi3</code> function from WASM binary during JIT by replacing it with ISA specific (mainly for <code>x86_64</code> and <code>arm64</code>) sequences, and then inline such sequences into callsites that would allow further optimizations</p>
<h4>Benefit</h4>
<p>A lot of code dealing with cryptography would benefit form faster full width <code>u64</code> multiplications where such <code>__multi3</code> arises</p>
<h4>Implementation</h4>
<p>If someone would give a few hints about where to start I'd try to implement it by myself</p>
<h4>Alternatives</h4>
<p>Not that I'm aware of. Patching into calling come native library function is a huge overhead for modern CPUs (4 cycles for <code>x86_64</code> for e.g. <code>mulx</code> or <code>mul</code>), and while it would be faster most likely, it's still far from optimal case on a hot path</p>
<p>As an example a simple multiply-add-carry function like <code>a*b + c + carry -&gt; (high, low)</code> that accumulates into <code>u128</code> without overflows compiles down to the listing below, and it can be a good test subject (transformed from <code>wasm</code> into <code>wat</code>, may be not the best readable)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">module</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k">type</span> <span class="p">(;</span><span class="mi">0</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$mac</span><span class="w"> </span><span class="p">(</span><span class="k">type</span> <span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">local</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">global</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="cp">$__stack_pointer</span><span class="w"></span>
<span class="w">    </span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
<span class="w">    </span><span class="kt">i32</span><span class="p">.</span><span class="n">sub</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="n">global</span><span class="p">.</span><span class="n">set</span><span class="w"> </span><span class="cp">$__stack_pointer</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">call</span><span class="w"> </span><span class="cp">$__multi3</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">load</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">store</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="kt">i32</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">load</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">lt_u</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">extend_i32_u</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">lt_u</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">extend_i32_u</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">store</span><span class="w"> </span><span class="n">offset</span><span class="o">=</span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
<span class="w">    </span><span class="kt">i32</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="n">global</span><span class="p">.</span><span class="n">set</span><span class="w"> </span><span class="cp">$__stack_pointer</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$__multi3</span><span class="w"> </span><span class="p">(</span><span class="k">type</span> <span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">local</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">4294967295</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">and</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">4294967295</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">and</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">6</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">mul</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">7</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">shr_u</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">mul</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">9</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">shr_u</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">6</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">mul</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">shl</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">6</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">store</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">mul</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">9</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">lt_u</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">extend_i32_u</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">shl</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">shr_u</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">or</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">6</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">7</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">lt_u</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">extend_i32_u</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">mul</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">mul</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">store</span><span class="w"> </span><span class="n">offset</span><span class="o">=</span><span class="mi">8</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">table</span><span class="w"> </span><span class="p">(;</span><span class="mi">0</span><span class="p">;)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">funcref</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">memory</span><span class="w"> </span><span class="p">(;</span><span class="mi">0</span><span class="p">;)</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">global</span><span class="w"> </span><span class="cp">$__stack_pointer</span><span class="w"> </span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">1048576</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">global</span><span class="w"> </span><span class="p">(;</span><span class="mi">1</span><span class="p">;)</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">1048576</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">global</span><span class="w"> </span><span class="p">(;</span><span class="mi">2</span><span class="p">;)</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">1048576</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"memory"</span><span class="w"> </span><span class="p">(</span><span class="n">memory</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"mac"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$mac</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"__data_end"</span><span class="w"> </span><span class="p">(</span><span class="n">global</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"__heap_base"</span><span class="w"> </span><span class="p">(</span><span class="n">global</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</code></pre></div>
</blockquote>



<a name="281773744"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234077%20__multi3%20optimization/near/281773744" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234077.20__multi3.20optimization.html#281773744">(May 10 2022 at 03:48)</a>:</h4>
<p>cfallin labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/4077">issue #4077</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>Implement an optimization pass that would eliminate the <code>__multi3</code> function from WASM binary during JIT by replacing it with ISA specific (mainly for <code>x86_64</code> and <code>arm64</code>) sequences, and then inline such sequences into callsites that would allow further optimizations</p>
<h4>Benefit</h4>
<p>A lot of code dealing with cryptography would benefit form faster full width <code>u64</code> multiplications where such <code>__multi3</code> arises</p>
<h4>Implementation</h4>
<p>If someone would give a few hints about where to start I'd try to implement it by myself</p>
<h4>Alternatives</h4>
<p>Not that I'm aware of. Patching into calling come native library function is a huge overhead for modern CPUs (4 cycles for <code>x86_64</code> for e.g. <code>mulx</code> or <code>mul</code>), and while it would be faster most likely, it's still far from optimal case on a hot path</p>
<p>As an example a simple multiply-add-carry function like <code>a*b + c + carry -&gt; (high, low)</code> that accumulates into <code>u128</code> without overflows compiles down to the listing below, and it can be a good test subject (transformed from <code>wasm</code> into <code>wat</code>, may be not the best readable)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">module</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k">type</span> <span class="p">(;</span><span class="mi">0</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$mac</span><span class="w"> </span><span class="p">(</span><span class="k">type</span> <span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">local</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">global</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="cp">$__stack_pointer</span><span class="w"></span>
<span class="w">    </span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
<span class="w">    </span><span class="kt">i32</span><span class="p">.</span><span class="n">sub</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="n">global</span><span class="p">.</span><span class="n">set</span><span class="w"> </span><span class="cp">$__stack_pointer</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">call</span><span class="w"> </span><span class="cp">$__multi3</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">load</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">store</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="kt">i32</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">load</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">lt_u</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">extend_i32_u</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">lt_u</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">extend_i32_u</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">store</span><span class="w"> </span><span class="n">offset</span><span class="o">=</span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
<span class="w">    </span><span class="kt">i32</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="n">global</span><span class="p">.</span><span class="n">set</span><span class="w"> </span><span class="cp">$__stack_pointer</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$__multi3</span><span class="w"> </span><span class="p">(</span><span class="k">type</span> <span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">local</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">4294967295</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">and</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">4294967295</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">and</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">6</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">mul</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">7</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">shr_u</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">mul</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">9</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">shr_u</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">6</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">mul</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">shl</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">6</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">store</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">mul</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">9</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">lt_u</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">extend_i32_u</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">shl</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">shr_u</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">or</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">6</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">7</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">lt_u</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">extend_i32_u</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">mul</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">mul</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="kt">i64</span><span class="p">.</span><span class="n">store</span><span class="w"> </span><span class="n">offset</span><span class="o">=</span><span class="mi">8</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">table</span><span class="w"> </span><span class="p">(;</span><span class="mi">0</span><span class="p">;)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">funcref</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">memory</span><span class="w"> </span><span class="p">(;</span><span class="mi">0</span><span class="p">;)</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">global</span><span class="w"> </span><span class="cp">$__stack_pointer</span><span class="w"> </span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">1048576</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">global</span><span class="w"> </span><span class="p">(;</span><span class="mi">1</span><span class="p">;)</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">1048576</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">global</span><span class="w"> </span><span class="p">(;</span><span class="mi">2</span><span class="p">;)</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">1048576</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"memory"</span><span class="w"> </span><span class="p">(</span><span class="n">memory</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"mac"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$mac</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"__data_end"</span><span class="w"> </span><span class="p">(</span><span class="n">global</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"__heap_base"</span><span class="w"> </span><span class="p">(</span><span class="n">global</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</code></pre></div>
</blockquote>



<a name="360664545"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234077%20__multi3%20optimization/near/360664545" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234077.20__multi3.20optimization.html#360664545">(May 24 2023 at 00:52)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/issues/4077#issuecomment-1560305088">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4077">issue #4077</a>:</p>
<blockquote>
<p>I've been investigating what we can do to improve the performance of <code>__multi3</code>. For reference, the C source for this function is in LLVM at <a href="https://github.com/llvm/llvm-project/blob/main/compiler-rt/lib/builtins/multi3.c"><code>compiler-rt/lib/builtins/multi3.c</code></a>, which helps a little with understanding what's going on.</p>
<p>Part of the solution proposed in earlier discussion here is function inlining. @elliottt and I discussed this some yesterday and what I'd like to see is a separate tool that supports an inlining transformation on core WebAssembly. I'd then recommend that people use that to eliminate the optimization barriers around <code>__multi3</code>. I don't see inlining actually happening soon in Wasmtime itself and it'd be nice to have something to recommend for that.</p>
<p>One difficult problem is that this function returns a two-member <code>struct</code>, which according to the <a href="https://github.com/WebAssembly/tool-conventions/blob/main/BasicCABI.md#function-signatures">WebAssembly basic C ABI</a> means it must be returned through linear memory. If it were returned on the wasm stack we'd be able to keep both parts in registers but instead we have to write to RAM. There is no optimization we can legally do to avoid the writes, even with inlining, although with inlining we likely can avoid reading the values back from RAM. Ideally the C ABI would be updated to take advantage of multi-value returns, which apparently didn't exist when it was specified.</p>
<p>Now, what is this function actually computing, and what patterns can we recognize and transform in the mid-end?</p>
<p>&lt;details&gt;<br>
&lt;summary&gt;Raw CLIF for __multi3, slightly edited&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">optimize</span><span class="w"> </span><span class="n">precise</span><span class="o">-</span><span class="n">output</span>
<span class="n">set</span><span class="w"> </span><span class="n">opt_level</span><span class="o">=</span><span class="n">speed_and_size</span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span>

<span class="p">;</span><span class="w"> </span><span class="n">v3</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a_lo</span>
<span class="p">;</span><span class="w"> </span><span class="n">v4</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a_hi</span>
<span class="p">;</span><span class="w"> </span><span class="n">v5</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">b_lo</span>
<span class="p">;</span><span class="w"> </span><span class="n">v6</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">b_hi</span>
<span class="p">;</span><span class="w"> </span><span class="n">v11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a0</span>
<span class="p">;</span><span class="w"> </span><span class="n">v14</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a1</span>
<span class="p">;</span><span class="w"> </span><span class="n">v9</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">b0</span>
<span class="p">;</span><span class="w"> </span><span class="n">v17</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b1</span>
<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">multi3</span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="n">vmctx</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="n">fast</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">gv0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmctx</span>
<span class="w">    </span><span class="n">gv1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">readonly</span><span class="w"> </span><span class="n">gv0</span><span class="o">+</span><span class="mi">80</span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v5</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v6</span>: <span class="kt">i64</span><span class="p">)</span>:
    <span class="nc">v7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">v8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mh">0xffff_ffff</span>
<span class="w">    </span><span class="n">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">band</span><span class="w"> </span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">v8</span>
<span class="w">    </span><span class="n">v10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mh">0xffff_ffff</span>
<span class="w">    </span><span class="n">v11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">band</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v10</span>
<span class="w">    </span><span class="n">v12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imul</span><span class="w"> </span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">v11</span>
<span class="w">    </span><span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">32</span>
<span class="w">    </span><span class="n">v14</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ushr</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span>
<span class="w">    </span><span class="n">v15</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imul</span><span class="w"> </span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span>
<span class="w">    </span><span class="n">v16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">32</span>
<span class="w">    </span><span class="n">v17</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ushr</span><span class="w"> </span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">v16</span>
<span class="w">    </span><span class="n">v18</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imul</span><span class="w"> </span><span class="n">v17</span><span class="p">,</span><span class="w"> </span><span class="n">v11</span>
<span class="w">    </span><span class="n">v19</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v18</span>
<span class="w">    </span><span class="n">v20</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">32</span>
<span class="w">    </span><span class="n">v21</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ishl</span><span class="w"> </span><span class="n">v19</span><span class="p">,</span><span class="w"> </span><span class="n">v20</span>
<span class="w">    </span><span class="n">v22</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v12</span><span class="p">,</span><span class="w"> </span><span class="n">v21</span>
<span class="w">    </span><span class="n">v23</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uextend</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v2</span>
<span class="w">    </span><span class="n">v24</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">global_value</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">gv1</span>
<span class="w">    </span><span class="n">v25</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v24</span><span class="p">,</span><span class="w"> </span><span class="n">v23</span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">little</span><span class="w"> </span><span class="n">heap</span><span class="w"> </span><span class="n">v22</span><span class="p">,</span><span class="w"> </span><span class="n">v25</span>
<span class="w">    </span><span class="n">v26</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imul</span><span class="w"> </span><span class="n">v17</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span>
<span class="w">    </span><span class="n">v27</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">ult</span><span class="w"> </span><span class="n">v19</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span>
<span class="w">    </span><span class="n">v28</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uextend</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="n">v27</span>
<span class="w">    </span><span class="n">v29</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uextend</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v28</span>
<span class="w">    </span><span class="n">v30</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">32</span>
<span class="w">    </span><span class="n">v31</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ishl</span><span class="w"> </span><span class="n">v29</span><span class="p">,</span><span class="w"> </span><span class="n">v30</span>
<span class="w">    </span><span class="n">v32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">32</span>
<span class="w">    </span><span class="n">v33</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ushr</span><span class="w"> </span><span class="n">v19</span><span class="p">,</span><span class="w"> </span><span class="n">v32</span>
<span class="w">    </span><span class="n">v34</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bor</span><span class="w"> </span><span class="n">v31</span><span class="p">,</span><span class="w"> </span><span class="n">v33</span>
<span class="w">    </span><span class="n">v35</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v26</span><span class="p">,</span><span class="w"> </span><span class="n">v34</span>
<span class="w">    </span><span class="n">v36</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">ult</span><span class="w"> </span><span class="n">v22</span><span class="p">,</span><span class="w"> </span><span class="n">v12</span>
<span class="w">    </span><span class="n">v37</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uextend</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="n">v36</span>
<span class="w">    </span><span class="n">v38</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uextend</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v37</span>
<span class="w">    </span><span class="n">v39</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v35</span><span class="p">,</span><span class="w"> </span><span class="n">v38</span>
<span class="w">    </span><span class="n">v40</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imul</span><span class="w"> </span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span>
<span class="w">    </span><span class="n">v41</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imul</span><span class="w"> </span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span>
<span class="w">    </span><span class="n">v42</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v40</span><span class="p">,</span><span class="w"> </span><span class="n">v41</span>
<span class="w">    </span><span class="n">v43</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v39</span><span class="p">,</span><span class="w"> </span><span class="n">v42</span>
<span class="w">    </span><span class="n">v44</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uextend</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v2</span>
<span class="w">    </span><span class="n">v45</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">global_value</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">gv1</span>
<span class="w">    </span><span class="n">v46</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v45</span><span class="p">,</span><span class="w"> </span><span class="n">v44</span>
<span class="w">    </span><span class="n">v47</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd_imm</span><span class="w"> </span><span class="n">v46</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">little</span><span class="w"> </span><span class="n">heap</span><span class="w"> </span><span class="n">v43</span><span class="p">,</span><span class="w"> </span><span class="n">v47</span>
<span class="w">    </span><span class="k">return</span>
<span class="p">}</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>This function implements a 128-bit multiply where the operands and result are stored as pairs of 64-bit integers. It builds up the result, in part, using a series of 32x32-&gt;64 multiplies. Viewed as a sequence of 32-bit "digits", the result of long multiplication should look like this, although each single-digit product may have a carry into the column to its left:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">     </span><span class="n">a3</span><span class="w">    </span><span class="n">a2</span><span class="w">    </span><span class="n">a1</span><span class="w">    </span><span class="n">a0</span>

<span class="w">   </span><span class="o">*</span><span class="w"> </span><span class="n">b3</span><span class="w">    </span><span class="n">b2</span><span class="w">    </span><span class="n">b1</span><span class="w">    </span><span class="n">b0</span>
<span class="w">  </span><span class="o">=======================</span>
<span class="w">  </span><span class="n">a0</span><span class="o">*</span><span class="n">b3</span><span class="w"> </span><span class="n">a0</span><span class="o">*</span><span class="n">b2</span><span class="w"> </span><span class="n">a0</span><span class="o">*</span><span class="n">b1</span><span class="w"> </span><span class="n">a0</span><span class="o">*</span><span class="n">b0</span>

<span class="o">+</span><span class="w"> </span><span class="n">a1</span><span class="o">*</span><span class="n">b2</span><span class="w"> </span><span class="n">a1</span><span class="o">*</span><span class="n">b1</span><span class="w"> </span><span class="n">a1</span><span class="o">*</span><span class="n">b0</span>
<span class="o">+</span><span class="w"> </span><span class="n">a2</span><span class="o">*</span><span class="n">b1</span><span class="w"> </span><span class="n">a2</span><span class="o">*</span><span class="n">b0</span>
<span class="o">+</span><span class="w"> </span><span class="n">a3</span><span class="o">*</span><span class="n">b0</span>
</code></pre></div>
<p>However only a1/a0 and b1/b0 are actually treated this way, to compute the lower half of the result along with part of the upper half.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">                 </span><span class="n">a1</span><span class="w">    </span><span class="n">a0</span>

<span class="w">   </span><span class="o">*</span><span class="w">             </span><span class="n">b1</span><span class="w">    </span><span class="n">b0</span>
<span class="w">  </span><span class="o">=======================</span>
<span class="w">              </span><span class="n">a0</span><span class="o">*</span><span class="n">b1</span><span class="w"> </span><span class="n">a0</span><span class="o">*</span><span class="n">b0</span>

<span class="o">+</span><span class="w">       </span><span class="n">a1</span><span class="o">*</span><span class="n">b1</span><span class="w"> </span><span class="n">a1</span><span class="o">*</span><span class="n">b0</span>
</code></pre></div>
<p>In Cranelift, we'd want to implement this with a pair of instructions: <code>imul</code> and <code>umulhi</code>, to produce the lower and upper 64 bits, respectively.</p>
<p>The remaining part of the upper half is just <code>a_lo*b_hi+a_hi*b_lo</code>, performed as regular 64-bit multiplies which are equivalent to these parts of the 32-bit-at-a-time long multiplication:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="n">a0</span><span class="o">*</span><span class="n">b3</span><span class="w"> </span><span class="n">a0</span><span class="o">*</span><span class="n">b2</span>

<span class="o">+</span><span class="w"> </span><span class="n">a1</span><span class="o">*</span><span class="n">b2</span>
<span class="o">+</span><span class="w"> </span><span class="n">a2</span><span class="o">*</span><span class="n">b1</span><span class="w"> </span><span class="n">a2</span><span class="o">*</span><span class="n">b0</span>
<span class="o">+</span><span class="w"> </span><span class="n">a3</span><span class="o">*</span><span class="n">b0</span>
</code></pre></div>
<p>There's actually nothing we can improve in this part, as shown in @cfallin's gcc-generated assembly listing, which has two <code>imulq</code> and two <code>addq</code>.</p>
<p>So back to the lower-half 64x64-&gt;128 multiply, performed 32 bits at a time. Our current optimizer produces this sequence which is equivalent to <code>v22 = imul.i64 v3, v5</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="n">v8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mh">0xffff_ffff</span>
<span class="w">    </span><span class="n">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">band</span><span class="w"> </span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">v8</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xffff_ffff</span>
<span class="w">    </span><span class="n">v11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">band</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v8</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xffff_ffff</span>
<span class="w">    </span><span class="n">v12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imul</span><span class="w"> </span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">v11</span>
<span class="w">    </span><span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">32</span>
<span class="w">    </span><span class="n">v14</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ushr</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span>
<span class="w">    </span><span class="n">v15</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imul</span><span class="w"> </span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span>
<span class="w">    </span><span class="n">v17</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ushr</span><span class="w"> </span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span>
<span class="w">    </span><span class="n">v18</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imul</span><span class="w"> </span><span class="n">v17</span><span class="p">,</span><span class="w"> </span><span class="n">v11</span>
<span class="w">    </span><span class="n">v19</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v18</span>
<span class="w">    </span><span class="n">v21</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ishl</span><span class="w"> </span><span class="n">v19</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span>
<span class="w">    </span><span class="n">v22</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v12</span><span class="p">,</span><span class="w"> </span><span class="n">v21</span>
</code></pre></div>
<p>Then I think this part (which reuses some of the intermediate values above) is equivalent to either <code>umulhi</code> or <code>smulhi</code>. I haven't yet figured out what purpose the <code>icmp</code> instructions serve, although I can see they're effectively checking if the adds overflowed for <code>v22</code> and <code>v19</code> above.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="n">v26</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imul</span><span class="w"> </span><span class="n">v17</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span>
<span class="w">    </span><span class="n">v27</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">ult</span><span class="w"> </span><span class="n">v19</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span>
<span class="w">    </span><span class="n">v49</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uextend</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v27</span>
<span class="w">    </span><span class="n">v31</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ishl</span><span class="w"> </span><span class="n">v49</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span>
<span class="w">    </span><span class="n">v33</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ushr</span><span class="w"> </span><span class="n">v19</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span>
<span class="w">    </span><span class="n">v34</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bor</span><span class="w"> </span><span class="n">v31</span><span class="p">,</span><span class="w"> </span><span class="n">v33</span>
<span class="w">    </span><span class="n">v35</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v26</span><span class="p">,</span><span class="w"> </span><span class="n">v34</span>
<span class="w">    </span><span class="n">v36</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">ult</span><span class="w"> </span><span class="n">v22</span><span class="p">,</span><span class="w"> </span><span class="n">v12</span>
<span class="w">    </span><span class="n">v51</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uextend</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v36</span>
<span class="w">    </span><span class="n">v39</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v35</span><span class="p">,</span><span class="w"> </span><span class="n">v51</span>
</code></pre></div>
<p>If we can get egraph rules to simplify these two sequences to the upper and lower halves of a 64-bit multiply, then once we also solve #5623 we'll get the same sequence of instructions out that gcc produces for 128-bit multiplies.</p>
<p>Alternatively, if we could match on multiple results at once then we could write a rule that matches this combination of three <code>imul</code>, one <code>umulhi</code>, and three <code>iadd</code> and turns them into a single 128-bit <code>imul</code> surrounded by <code>iconcat</code> and <code>isplit</code>. I believe on x64 we already lower that to something equivalent to the gcc-generated sequence.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>