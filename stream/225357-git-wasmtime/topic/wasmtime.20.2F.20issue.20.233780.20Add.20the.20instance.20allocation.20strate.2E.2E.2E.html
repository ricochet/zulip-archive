<html>
<head><meta charset="utf-8"><title>wasmtime / issue #3780 Add the instance allocation strate... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233780.20Add.20the.20instance.20allocation.20strate.2E.2E.2E.html">wasmtime / issue #3780 Add the instance allocation strate...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="271203737"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233780%20Add%20the%20instance%20allocation%20strate.../near/271203737" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233780.20Add.20the.20instance.20allocation.20strate.2E.2E.2E.html#271203737">(Feb 08 2022 at 22:54)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/3780#issuecomment-1033142869">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3780">issue #3780</a>:</p>
<blockquote>
<p>(on posting, I see fitzgen beat me to it -- strong +1 then to multiple-instantiate!)</p>
</blockquote>



<a name="271204520"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233780%20Add%20the%20instance%20allocation%20strate.../near/271204520" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233780.20Add.20the.20instance.20allocation.20strate.2E.2E.2E.html#271204520">(Feb 08 2022 at 23:01)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/3780#issuecomment-1033147069">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3780">issue #3780</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "fuzzing"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>fitzgen: fuzzing</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="271205047"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233780%20Add%20the%20instance%20allocation%20strate.../near/271205047" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233780.20Add.20the.20instance.20allocation.20strate.2E.2E.2E.html#271205047">(Feb 08 2022 at 23:05)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/pull/3780#issuecomment-1033149995">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3780">issue #3780</a>:</p>
<blockquote>
<p>I'll add a fuzz target for multi-instantiation.</p>
</blockquote>



<a name="271206020"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233780%20Add%20the%20instance%20allocation%20strate.../near/271206020" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233780.20Add.20the.20instance.20allocation.20strate.2E.2E.2E.html#271206020">(Feb 08 2022 at 23:14)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/3780#issuecomment-1033155418">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3780">issue #3780</a>:</p>
<blockquote>
<p>Thanks! The fuzz target should also drop instances in random orders as well, so that it exercises the pooling allocator free lists too.</p>
</blockquote>



<a name="271229112"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233780%20Add%20the%20instance%20allocation%20strate.../near/271229112" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233780.20Add.20the.20instance.20allocation.20strate.2E.2E.2E.html#271229112">(Feb 09 2022 at 04:19)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/pull/3780#issuecomment-1033330993">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3780">issue #3780</a>:</p>
<blockquote>
<p>I've added a <code>pooling</code> fuzz target that tests the pooling allocator by allocating instances from different modules and then dropping them in a different order.</p>
<p>Take a look at the last commit and let me know if this approach needs improvement.</p>
</blockquote>



<a name="271235216"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233780%20Add%20the%20instance%20allocation%20strate.../near/271235216" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233780.20Add.20the.20instance.20allocation.20strate.2E.2E.2E.html#271235216">(Feb 09 2022 at 06:12)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/3780#issuecomment-1033388949">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3780">issue #3780</a>:</p>
<blockquote>
<p>This is definitely in the right direction! If I understand correctly, this basically implements a two-phase approach: instantiate many times, picking from a group of modules (possibly instantiating the same module into multiple slots); then terminate all the instances, in some arbitrary order. Is that right?</p>
<p>The thing that I think would be good to add would be reuse of pool slots, from the instantiate-&gt;drop-&gt;instantiate pattern; in other words, there need to be instantiate and drop events interwoven, rather than in two separate phases, to get some of the interesting corner cases. (With memfd for example it'd be nice to have coverage of cases that instantiate the same module over the same slot.)</p>
<p>What about the "<code>Arbitrary</code> list of commands" fuzzing approach? Something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(Arbitrary)]</span><span class="w"></span>
<span class="k">enum</span> <span class="nc">Command</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">Instantiate</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">freelist_index</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">module_id</span>: <span class="kt">usize</span> <span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="n">Terminate</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">instantiated_list_index</span>: <span class="kt">usize</span> <span class="p">},</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>then take an <code>Arbitrary</code> of a <code>Vec&lt;Command&gt;</code> and stream through the events. (With the above I'm imagining <code>freelist_index</code> and <code>instantiated_list_index</code> are taken modulo the length of the respective list, then we can <code>swap_remove</code> and put it on the other list; a lot like the drop approach in your current implementation.) Thoughts?</p>
</blockquote>



<a name="271311155"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233780%20Add%20the%20instance%20allocation%20strate.../near/271311155" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233780.20Add.20the.20instance.20allocation.20strate.2E.2E.2E.html#271311155">(Feb 09 2022 at 17:05)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/3780#issuecomment-1033989513">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3780">issue #3780</a>:</p>
<blockquote>
<blockquote>
<p>What about the "<code>Arbitrary</code> list of commands" fuzzing approach? Something like:</p>
<p><code>
#[derive(Arbitrary)]
enum Command {
  Instantiate { freelist_index: usize, module_id: usize },
  Terminate { instantiated_list_index: usize },
}
</code></p>
<p>then take an <code>Arbitrary</code> of a <code>Vec&lt;Command&gt;</code> and stream through the events. (With the above I'm imagining <code>freelist_index</code> and <code>instantiated_list_index</code> are taken modulo the length of the respective list, then we can <code>swap_remove</code> and put it on the other list; a lot like the drop approach in your current implementation.) Thoughts?</p>
</blockquote>
<p>(+1 but I'm going to bow out from further review here since it seems like we're at risk of too many cooks in the kitchen and y'all have this covered :) )</p>
</blockquote>



<a name="271386294"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233780%20Add%20the%20instance%20allocation%20strate.../near/271386294" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233780.20Add.20the.20instance.20allocation.20strate.2E.2E.2E.html#271386294">(Feb 10 2022 at 04:56)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/pull/3780#issuecomment-1034493375">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3780">issue #3780</a>:</p>
<blockquote>
<p>@cfallin I replaced the <code>pooling</code> fuzz target with <code>instantiate-many</code> that tries to instantiate an arbitrary number of times followed by an interleaving of additional instantiations or terminations in an attempt to fuzz the reuse affinity.</p>
<p>Let me know if you think there's more than can be done with this approach.</p>
</blockquote>



<a name="271478544"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233780%20Add%20the%20instance%20allocation%20strate.../near/271478544" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233780.20Add.20the.20instance.20allocation.20strate.2E.2E.2E.html#271478544">(Feb 10 2022 at 19:03)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/pull/3780#issuecomment-1035352217">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3780">issue #3780</a>:</p>
<blockquote>
<p>I'll rebase this in a sec.</p>
</blockquote>



<a name="271479457"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233780%20Add%20the%20instance%20allocation%20strate.../near/271479457" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233780.20Add.20the.20instance.20allocation.20strate.2E.2E.2E.html#271479457">(Feb 10 2022 at 19:10)</a>:</h4>
<p>peterhuene deleted a <a href="https://github.com/bytecodealliance/wasmtime/pull/3780#issuecomment-1035352217">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3780">issue #3780</a>:</p>
<blockquote>
<p>I'll rebase this in a sec.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>