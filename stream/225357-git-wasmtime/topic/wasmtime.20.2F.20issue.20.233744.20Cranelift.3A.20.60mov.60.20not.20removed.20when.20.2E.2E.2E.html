<html>
<head><meta charset="utf-8"><title>wasmtime / issue #3744 Cranelift: `mov` not removed when ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233744.20Cranelift.3A.20.60mov.60.20not.20removed.20when.20.2E.2E.2E.html">wasmtime / issue #3744 Cranelift: `mov` not removed when ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="269828620"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233744%20Cranelift%3A%20%60mov%60%20not%20removed%20when%20.../near/269828620" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233744.20Cranelift.3A.20.60mov.60.20not.20removed.20when.20.2E.2E.2E.html#269828620">(Jan 29 2022 at 01:43)</a>:</h4>
<p>abrown opened <a href="https://github.com/bytecodealliance/wasmtime/issues/3744">issue #3744</a>:</p>
<blockquote>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">compile</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">select_eq_f32</span><span class="p">(</span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="kt">f32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">f32</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fcmp</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v5</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">RUST_LOG</span><span class="o">=</span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">compile</span><span class="o">=</span><span class="n">trace</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">tools</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">-</span><span class="n">dDp</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"> </span><span class="n">scratch</span><span class="p">.</span><span class="n">clif</span><span class="w"></span>
</code></pre></div>
<h3>Expected Results</h3>
<p>No extra <code>movl</code> instruction after the <code>ucomiss</code> comparison.</p>
<h3>Actual Results</h3>
<p>There is no need for instruction 7, <code>movl %edi, %edi</code>, but for some reason it is not being elided.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">compile</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vcode</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="n">regalloc</span>: <span class="nc">final</span><span class="w"> </span><span class="n">version</span>:
<span class="nc">VCode_ShowWithRRU</span><span class="w"> </span><span class="p">{{</span><span class="w"></span>
<span class="w">  </span><span class="n">Entry</span><span class="w"> </span><span class="n">block</span>: <span class="mi">0</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="mi">0</span>:
  <span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="n">IR</span><span class="w"> </span><span class="n">block</span>: <span class="nc">block0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="n">range</span>: <span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">13</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">0</span>:   <span class="nc">pushq</span><span class="w">   </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">1</span>:   <span class="nc">unwind</span><span class="w"> </span><span class="n">PushFrameRegs</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">offset_upward_to_caller_sp</span>: <span class="mi">16</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">2</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">3</span>:   <span class="nc">unwind</span><span class="w"> </span><span class="n">DefineNewFrame</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">offset_upward_to_caller_sp</span>: <span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="n">offset_downward_to_clobbers</span>: <span class="mi">0</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">4</span>:   <span class="nc">movl</span><span class="w">    </span><span class="cp">$</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">edi</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">5</span>:   <span class="nc">xorl</span><span class="w">    </span><span class="o">%</span><span class="n">esi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">esi</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">6</span>:   <span class="nc">ucomiss</span><span class="w"> </span><span class="o">%</span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">7</span>:   <span class="nc">movl</span><span class="w">    </span><span class="o">%</span><span class="n">edi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">edi</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">8</span>:   <span class="nc">cmovnzl</span><span class="w"> </span><span class="o">%</span><span class="n">esi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">edi</span><span class="p">;</span><span class="w"> </span><span class="n">cmovpl</span><span class="w">  </span><span class="o">%</span><span class="n">esi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">edi</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">9</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rax</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">10</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">11</span>:   <span class="nc">popq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">12</span>:   <span class="nc">ret</span><span class="w"></span>
<span class="p">}}</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: this redundant instruction is present in the ISLE changes to <code>select</code> currently under review at <a href="https://github.com/bytecodealliance/wasmtime/pull/3682">https://github.com/bytecodealliance/wasmtime/pull/3682</a>.</p>
</blockquote>



<a name="269828621"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233744%20Cranelift%3A%20%60mov%60%20not%20removed%20when%20.../near/269828621" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233744.20Cranelift.3A.20.60mov.60.20not.20removed.20when.20.2E.2E.2E.html#269828621">(Jan 29 2022 at 01:43)</a>:</h4>
<p>abrown labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/3744">issue #3744</a>:</p>
<blockquote>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">compile</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">select_eq_f32</span><span class="p">(</span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="kt">f32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">f32</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fcmp</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v5</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">RUST_LOG</span><span class="o">=</span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">compile</span><span class="o">=</span><span class="n">trace</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">tools</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">-</span><span class="n">dDp</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"> </span><span class="n">scratch</span><span class="p">.</span><span class="n">clif</span><span class="w"></span>
</code></pre></div>
<h3>Expected Results</h3>
<p>No extra <code>movl</code> instruction after the <code>ucomiss</code> comparison.</p>
<h3>Actual Results</h3>
<p>There is no need for instruction 7, <code>movl %edi, %edi</code>, but for some reason it is not being elided.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">compile</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vcode</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="n">regalloc</span>: <span class="nc">final</span><span class="w"> </span><span class="n">version</span>:
<span class="nc">VCode_ShowWithRRU</span><span class="w"> </span><span class="p">{{</span><span class="w"></span>
<span class="w">  </span><span class="n">Entry</span><span class="w"> </span><span class="n">block</span>: <span class="mi">0</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="mi">0</span>:
  <span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="n">IR</span><span class="w"> </span><span class="n">block</span>: <span class="nc">block0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="n">range</span>: <span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">13</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">0</span>:   <span class="nc">pushq</span><span class="w">   </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">1</span>:   <span class="nc">unwind</span><span class="w"> </span><span class="n">PushFrameRegs</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">offset_upward_to_caller_sp</span>: <span class="mi">16</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">2</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">3</span>:   <span class="nc">unwind</span><span class="w"> </span><span class="n">DefineNewFrame</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">offset_upward_to_caller_sp</span>: <span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="n">offset_downward_to_clobbers</span>: <span class="mi">0</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">4</span>:   <span class="nc">movl</span><span class="w">    </span><span class="cp">$</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">edi</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">5</span>:   <span class="nc">xorl</span><span class="w">    </span><span class="o">%</span><span class="n">esi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">esi</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">6</span>:   <span class="nc">ucomiss</span><span class="w"> </span><span class="o">%</span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">7</span>:   <span class="nc">movl</span><span class="w">    </span><span class="o">%</span><span class="n">edi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">edi</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">8</span>:   <span class="nc">cmovnzl</span><span class="w"> </span><span class="o">%</span><span class="n">esi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">edi</span><span class="p">;</span><span class="w"> </span><span class="n">cmovpl</span><span class="w">  </span><span class="o">%</span><span class="n">esi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">edi</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">9</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rax</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">10</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">11</span>:   <span class="nc">popq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">12</span>:   <span class="nc">ret</span><span class="w"></span>
<span class="p">}}</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: this redundant instruction is present in the ISLE changes to <code>select</code> currently under review at <a href="https://github.com/bytecodealliance/wasmtime/pull/3682">https://github.com/bytecodealliance/wasmtime/pull/3682</a>.</p>
</blockquote>



<a name="269828623"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233744%20Cranelift%3A%20%60mov%60%20not%20removed%20when%20.../near/269828623" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233744.20Cranelift.3A.20.60mov.60.20not.20removed.20when.20.2E.2E.2E.html#269828623">(Jan 29 2022 at 01:43)</a>:</h4>
<p>abrown labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/3744">issue #3744</a>:</p>
<blockquote>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">compile</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">select_eq_f32</span><span class="p">(</span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="kt">f32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">f32</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fcmp</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v5</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">RUST_LOG</span><span class="o">=</span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">compile</span><span class="o">=</span><span class="n">trace</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">tools</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">-</span><span class="n">dDp</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"> </span><span class="n">scratch</span><span class="p">.</span><span class="n">clif</span><span class="w"></span>
</code></pre></div>
<h3>Expected Results</h3>
<p>No extra <code>movl</code> instruction after the <code>ucomiss</code> comparison.</p>
<h3>Actual Results</h3>
<p>There is no need for instruction 7, <code>movl %edi, %edi</code>, but for some reason it is not being elided.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">compile</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vcode</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="n">regalloc</span>: <span class="nc">final</span><span class="w"> </span><span class="n">version</span>:
<span class="nc">VCode_ShowWithRRU</span><span class="w"> </span><span class="p">{{</span><span class="w"></span>
<span class="w">  </span><span class="n">Entry</span><span class="w"> </span><span class="n">block</span>: <span class="mi">0</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="mi">0</span>:
  <span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="n">IR</span><span class="w"> </span><span class="n">block</span>: <span class="nc">block0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="n">range</span>: <span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">13</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">0</span>:   <span class="nc">pushq</span><span class="w">   </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">1</span>:   <span class="nc">unwind</span><span class="w"> </span><span class="n">PushFrameRegs</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">offset_upward_to_caller_sp</span>: <span class="mi">16</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">2</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">3</span>:   <span class="nc">unwind</span><span class="w"> </span><span class="n">DefineNewFrame</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">offset_upward_to_caller_sp</span>: <span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="n">offset_downward_to_clobbers</span>: <span class="mi">0</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">4</span>:   <span class="nc">movl</span><span class="w">    </span><span class="cp">$</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">edi</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">5</span>:   <span class="nc">xorl</span><span class="w">    </span><span class="o">%</span><span class="n">esi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">esi</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">6</span>:   <span class="nc">ucomiss</span><span class="w"> </span><span class="o">%</span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">7</span>:   <span class="nc">movl</span><span class="w">    </span><span class="o">%</span><span class="n">edi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">edi</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">8</span>:   <span class="nc">cmovnzl</span><span class="w"> </span><span class="o">%</span><span class="n">esi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">edi</span><span class="p">;</span><span class="w"> </span><span class="n">cmovpl</span><span class="w">  </span><span class="o">%</span><span class="n">esi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">edi</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">9</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rax</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">10</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">11</span>:   <span class="nc">popq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">12</span>:   <span class="nc">ret</span><span class="w"></span>
<span class="p">}}</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: this redundant instruction is present in the ISLE changes to <code>select</code> currently under review at <a href="https://github.com/bytecodealliance/wasmtime/pull/3682">https://github.com/bytecodealliance/wasmtime/pull/3682</a>.</p>
</blockquote>



<a name="270077288"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233744%20Cranelift%3A%20%60mov%60%20not%20removed%20when%20.../near/270077288" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233744.20Cranelift.3A.20.60mov.60.20not.20removed.20when.20.2E.2E.2E.html#270077288">(Jan 31 2022 at 18:08)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/3744#issuecomment-1026062294">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3744">issue #3744</a>:</p>
<blockquote>
<p>As we discussed, this is <code>regalloc</code> failing to coalesce/elide the <code>mov</code> in this case. Funny because it is the "easiest" kind of move to elide. Should be fixed with regalloc2, or at least once we switch to regalloc2 we can make sure that it handles this and update regalloc2 if it doesn't.</p>
</blockquote>



<a name="281032812"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233744%20Cranelift%3A%20%60mov%60%20not%20removed%20when%20.../near/281032812" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233744.20Cranelift.3A.20.60mov.60.20not.20removed.20when.20.2E.2E.2E.html#281032812">(May 03 2022 at 15:44)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/3744#issuecomment-1116249818">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3744">issue #3744</a>:</p>
<blockquote>
<p>The current output is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Disassembly</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="n">bytes</span>:
   <span class="mi">0</span>:   <span class="mi">55</span><span class="w">                      </span><span class="n">push</span><span class="w">    </span><span class="n">rbp</span><span class="w"></span>
<span class="w">   </span><span class="mi">1</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">e5</span><span class="w">                </span><span class="n">mov</span><span class="w">     </span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="n">rsp</span><span class="w"></span>
<span class="w">   </span><span class="mi">4</span>:   <span class="mi">45</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="n">c0</span><span class="w">                </span><span class="n">xor</span><span class="w">     </span><span class="n">r8d</span><span class="p">,</span><span class="w"> </span><span class="n">r8d</span><span class="w"></span>
<span class="w">   </span><span class="mi">7</span>:   <span class="nc">b8</span><span class="w"> </span><span class="mi">01</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">   </span><span class="n">c</span>:   <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">2</span><span class="n">e</span><span class="w"> </span><span class="n">c8</span><span class="w">                </span><span class="n">ucomiss</span><span class="w"> </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="n">xmm0</span><span class="w"></span>
<span class="w">   </span><span class="n">f</span>:   <span class="mi">41</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">45</span><span class="w"> </span><span class="n">c0</span><span class="w">             </span><span class="n">cmovne</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">r8d</span><span class="w"></span>
<span class="w">  </span><span class="mi">13</span>:   <span class="mi">41</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">4</span><span class="n">a</span><span class="w"> </span><span class="n">c0</span><span class="w">             </span><span class="n">cmovp</span><span class="w">   </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">r8d</span><span class="w"></span>
<span class="w">  </span><span class="mi">17</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">ec</span><span class="w">                </span><span class="n">mov</span><span class="w">     </span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="mi">1</span><span class="n">a</span>:   <span class="mi">5</span><span class="n">d</span><span class="w">                      </span><span class="n">pop</span><span class="w">     </span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="mi">1</span><span class="n">b</span>:   <span class="nc">c3</span><span class="w">                      </span><span class="n">ret</span><span class="w"></span>
</code></pre></div>
<p>which I think means that this is fixed. Is this something we'll want a test for though before closing?</p>
</blockquote>



<a name="281039289"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233744%20Cranelift%3A%20%60mov%60%20not%20removed%20when%20.../near/281039289" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233744.20Cranelift.3A.20.60mov.60.20not.20removed.20when.20.2E.2E.2E.html#281039289">(May 03 2022 at 16:27)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/issues/3744#issuecomment-1116295018">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3744">issue #3744</a>:</p>
<blockquote>
<p>Yeah, I guess we could add a CLIF compile test for this but I think that if we use the debug output it could be unwittingly overwritten in a <code>BLESS</code>ed run and this issue could resurface. We can still use <code>test compile</code> instead of <code>test compile precise-output</code>, I think.</p>
</blockquote>



<a name="281040541"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233744%20Cranelift%3A%20%60mov%60%20not%20removed%20when%20.../near/281040541" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233744.20Cranelift.3A.20.60mov.60.20not.20removed.20when.20.2E.2E.2E.html#281040541">(May 03 2022 at 16:35)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/3744#issuecomment-1116303320">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3744">issue #3744</a>:</p>
<blockquote>
<blockquote>
<p>if we use the debug output it could be unwittingly overwritten in a BLESSed run and this issue could resurface</p>
</blockquote>
<p>Indeed, this was one of my concerns with the auto-blessing (though to be clear it's a big convenience improvement overall, so I don't think it was a mistake). I think the right answer is probably to use non-autoblessed tests for cases where we're asserting a certain property about the output, and possibly be a bit looser in the matching on details we don't care about (prologue/epilogue, specific registers), then reduce the number of precise-output tests overall (and make heavier use of run-tests).</p>
</blockquote>



<a name="281041206"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233744%20Cranelift%3A%20%60mov%60%20not%20removed%20when%20.../near/281041206" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233744.20Cranelift.3A.20.60mov.60.20not.20removed.20when.20.2E.2E.2E.html#281041206">(May 03 2022 at 16:40)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/issues/3744#issuecomment-1116307530">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3744">issue #3744</a>:</p>
<blockquote>
<p>I can add a <code>test compile</code> later today if no one else wants to take this?</p>
</blockquote>



<a name="281042553"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233744%20Cranelift%3A%20%60mov%60%20not%20removed%20when%20.../near/281042553" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233744.20Cranelift.3A.20.60mov.60.20not.20removed.20when.20.2E.2E.2E.html#281042553">(May 03 2022 at 16:49)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/3744#issuecomment-1116323835">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3744">issue #3744</a>:</p>
<blockquote>
<p>Go for it, happy to review, and thank you!</p>
</blockquote>



<a name="281083896"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233744%20Cranelift%3A%20%60mov%60%20not%20removed%20when%20.../near/281083896" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233744.20Cranelift.3A.20.60mov.60.20not.20removed.20when.20.2E.2E.2E.html#281083896">(May 03 2022 at 22:04)</a>:</h4>
<p>abrown closed <a href="https://github.com/bytecodealliance/wasmtime/issues/3744">issue #3744</a>:</p>
<blockquote>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">compile</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">select_eq_f32</span><span class="p">(</span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="kt">f32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">f32</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fcmp</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v5</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">RUST_LOG</span><span class="o">=</span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">compile</span><span class="o">=</span><span class="n">trace</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">tools</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">-</span><span class="n">dDp</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"> </span><span class="n">scratch</span><span class="p">.</span><span class="n">clif</span><span class="w"></span>
</code></pre></div>
<h3>Expected Results</h3>
<p>No extra <code>movl</code> instruction after the <code>ucomiss</code> comparison.</p>
<h3>Actual Results</h3>
<p>There is no need for instruction 7, <code>movl %edi, %edi</code>, but for some reason it is not being elided.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">compile</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vcode</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="n">regalloc</span>: <span class="nc">final</span><span class="w"> </span><span class="n">version</span>:
<span class="nc">VCode_ShowWithRRU</span><span class="w"> </span><span class="p">{{</span><span class="w"></span>
<span class="w">  </span><span class="n">Entry</span><span class="w"> </span><span class="n">block</span>: <span class="mi">0</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="mi">0</span>:
  <span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="n">IR</span><span class="w"> </span><span class="n">block</span>: <span class="nc">block0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="n">range</span>: <span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">13</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">0</span>:   <span class="nc">pushq</span><span class="w">   </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">1</span>:   <span class="nc">unwind</span><span class="w"> </span><span class="n">PushFrameRegs</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">offset_upward_to_caller_sp</span>: <span class="mi">16</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">2</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">3</span>:   <span class="nc">unwind</span><span class="w"> </span><span class="n">DefineNewFrame</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">offset_upward_to_caller_sp</span>: <span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="n">offset_downward_to_clobbers</span>: <span class="mi">0</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">4</span>:   <span class="nc">movl</span><span class="w">    </span><span class="cp">$</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">edi</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">5</span>:   <span class="nc">xorl</span><span class="w">    </span><span class="o">%</span><span class="n">esi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">esi</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">6</span>:   <span class="nc">ucomiss</span><span class="w"> </span><span class="o">%</span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">7</span>:   <span class="nc">movl</span><span class="w">    </span><span class="o">%</span><span class="n">edi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">edi</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">8</span>:   <span class="nc">cmovnzl</span><span class="w"> </span><span class="o">%</span><span class="n">esi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">edi</span><span class="p">;</span><span class="w"> </span><span class="n">cmovpl</span><span class="w">  </span><span class="o">%</span><span class="n">esi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">edi</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">9</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rax</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">10</span>:   <span class="nc">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">11</span>:   <span class="nc">popq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">12</span>:   <span class="nc">ret</span><span class="w"></span>
<span class="p">}}</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: this redundant instruction is present in the ISLE changes to <code>select</code> currently under review at <a href="https://github.com/bytecodealliance/wasmtime/pull/3682">https://github.com/bytecodealliance/wasmtime/pull/3682</a>.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>