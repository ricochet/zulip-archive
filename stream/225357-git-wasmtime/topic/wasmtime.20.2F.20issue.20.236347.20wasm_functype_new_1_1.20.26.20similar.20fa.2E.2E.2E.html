<html>
<head><meta charset="utf-8"><title>wasmtime / issue #6347 wasm_functype_new_1_1 &amp; similar fa... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236347.20wasm_functype_new_1_1.20.26.20similar.20fa.2E.2E.2E.html">wasmtime / issue #6347 wasm_functype_new_1_1 &amp; similar fa...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="356057771"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236347%20wasm_functype_new_1_1%20%26%20similar%20fa.../near/356057771" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236347.20wasm_functype_new_1_1.20.26.20similar.20fa.2E.2E.2E.html#356057771">(May 05 2023 at 13:25)</a>:</h4>
<p>adv-sw opened <a href="https://github.com/bytecodealliance/wasmtime/issues/6347">issue #6347</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>#include &lt;stdio.h&gt;<br>
#include &lt;stdlib.h&gt;<br>
#include &lt;wasm.h&gt;<br>
#include &lt;wasmtime.h&gt;</p>
<p>int main() <br>
{ <br>
  wasm_config_t* wasm_config = wasm_config_new();<br>
  wasmtime_config_debug_info_set(wasm_config, true);<br>
  wasm_engine_t *engine = wasm_engine_new_with_config(wasm_config);</p>
<p>printf("A");<br>
  wasm_valtype_t* val_i32 =  wasm_valtype_new(WASM_I32);<br>
  wasm_functype_t *__ft_i32_out_i32  = wasm_functype_new_1_1(val_i32, val_i32);<br>
  printf("B");<br>
  printf("\n");</p>
<p>return 0;<br>
}</p>
<h3>Steps to Reproduce</h3>
<p>Compile the above, Windows (might also fault other platforms, but untested). Run it.</p>
<h3>Expected Results</h3>
<p>Completes - Output: AB</p>
<h3>Actual Results</h3>
<p>Faults in: wasm_functype_new_1_1 </p>
<h3>Versions and Environment</h3>
<p>Tip as of 5/5/2023 at 13:00 GMT</p>
<p>Windows 11 Home, X64</p>
<h3>Extra Info</h3>
<p>Reverting the following resolves the regression.</p>
<p><a href="https://pastebin.com/2Yt3FG9E">https://pastebin.com/2Yt3FG9E</a></p>
</blockquote>



<a name="356057772"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236347%20wasm_functype_new_1_1%20%26%20similar%20fa.../near/356057772" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236347.20wasm_functype_new_1_1.20.26.20similar.20fa.2E.2E.2E.html#356057772">(May 05 2023 at 13:25)</a>:</h4>
<p>adv-sw labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/6347">issue #6347</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>#include &lt;stdio.h&gt;<br>
#include &lt;stdlib.h&gt;<br>
#include &lt;wasm.h&gt;<br>
#include &lt;wasmtime.h&gt;</p>
<p>int main() <br>
{ <br>
  wasm_config_t* wasm_config = wasm_config_new();<br>
  wasmtime_config_debug_info_set(wasm_config, true);<br>
  wasm_engine_t *engine = wasm_engine_new_with_config(wasm_config);</p>
<p>printf("A");<br>
  wasm_valtype_t* val_i32 =  wasm_valtype_new(WASM_I32);<br>
  wasm_functype_t *__ft_i32_out_i32  = wasm_functype_new_1_1(val_i32, val_i32);<br>
  printf("B");<br>
  printf("\n");</p>
<p>return 0;<br>
}</p>
<h3>Steps to Reproduce</h3>
<p>Compile the above, Windows (might also fault other platforms, but untested). Run it.</p>
<h3>Expected Results</h3>
<p>Completes - Output: AB</p>
<h3>Actual Results</h3>
<p>Faults in: wasm_functype_new_1_1 </p>
<h3>Versions and Environment</h3>
<p>Tip as of 5/5/2023 at 13:00 GMT</p>
<p>Windows 11 Home, X64</p>
<h3>Extra Info</h3>
<p>Reverting the following resolves the regression.</p>
<p><a href="https://pastebin.com/2Yt3FG9E">https://pastebin.com/2Yt3FG9E</a></p>
</blockquote>



<a name="356059486"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236347%20wasm_functype_new_1_1%20%26%20similar%20fa.../near/356059486" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236347.20wasm_functype_new_1_1.20.26.20similar.20fa.2E.2E.2E.html#356059486">(May 05 2023 at 13:31)</a>:</h4>
<p>adv-sw edited <a href="https://github.com/bytecodealliance/wasmtime/issues/6347">issue #6347</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>#include &lt;stdio.h&gt;<br>
#include &lt;stdlib.h&gt;<br>
#include &lt;wasm.h&gt;<br>
#include &lt;wasmtime.h&gt;</p>
<p>int main() <br>
{ <br>
  wasm_config_t* wasm_config = wasm_config_new();<br>
  wasmtime_config_debug_info_set(wasm_config, true);<br>
  wasm_engine_t *engine = wasm_engine_new_with_config(wasm_config);</p>
<p>printf("A");<br>
  wasm_valtype_t* val_i32 =  wasm_valtype_new(WASM_I32);<br>
  wasm_functype_t *__ft_i32_out_i32  = wasm_functype_new_1_1(val_i32, val_i32);<br>
  printf("B");<br>
  printf("\n");</p>
<p>return 0;<br>
}</p>
<h3>Steps to Reproduce</h3>
<p>Compile the above, Windows (might also fault other platforms, but untested). Run it.</p>
<h3>Expected Results</h3>
<p>Completes - Output: AB</p>
<h3>Actual Results</h3>
<p>Faults in: wasm_functype_new_1_1 </p>
<h3>Versions and Environment</h3>
<p>Tip as of 5/5/2023 at 13:00 GMT</p>
<p>Windows 11 Home, X64</p>
<h3>Extra Info</h3>
<p>Reverting the following resolves the regression.</p>
<p><a href="https://pastebin.com/2Yt3FG9E">https://pastebin.com/2Yt3FG9E</a></p>
<p>... though the spec apparently states that function should reassign owner rather than clone, rework of regressed functionality.<br>
</p>
</blockquote>



<a name="356059872"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236347%20wasm_functype_new_1_1%20%26%20similar%20fa.../near/356059872" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236347.20wasm_functype_new_1_1.20.26.20similar.20fa.2E.2E.2E.html#356059872">(May 05 2023 at 13:32)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/6347#issuecomment-1536269190">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6347">issue #6347</a>:</p>
<blockquote>
<p><code>wasm_functype_new_1_1</code> consumes both arguments according to the header declaration: <a href="https://github.com/WebAssembly/wasm-c-api/blob/c9d31284651b975f05ac27cee0bab1377560b87e/include/wasm.h#L607">https://github.com/WebAssembly/wasm-c-api/blob/c9d31284651b975f05ac27cee0bab1377560b87e/include/wasm.h#L607</a> This means that you can't pass the exact same argument twice without causing a crash. You have to call <code> wasm_valtype_new(WASM_I32)</code> once for each use and never reuse it after passing it to <code>wasm_functype_new_1_1</code>.</p>
</blockquote>



<a name="356062502"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236347%20wasm_functype_new_1_1%20%26%20similar%20fa.../near/356062502" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236347.20wasm_functype_new_1_1.20.26.20similar.20fa.2E.2E.2E.html#356062502">(May 05 2023 at 13:41)</a>:</h4>
<p>adv-sw <a href="https://github.com/bytecodealliance/wasmtime/issues/6347#issuecomment-1536281659">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6347">issue #6347</a>:</p>
<blockquote>
<p>ahhhh :)</p>
<p>what an odd api.</p>
</blockquote>



<a name="356069429"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236347%20wasm_functype_new_1_1%20%26%20similar%20fa.../near/356069429" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236347.20wasm_functype_new_1_1.20.26.20similar.20fa.2E.2E.2E.html#356069429">(May 05 2023 at 14:03)</a>:</h4>
<p>adv-sw <a href="https://github.com/bytecodealliance/wasmtime/issues/6347#issuecomment-1536311797">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6347">issue #6347</a>:</p>
<blockquote>
<p>The following faults on wasm_valtype_delete so it seems we should never call wasm_valtype_delete as the value has been sucked internal to wasm_valtype_new.</p>
<p>Hence wondering why wasm_valtype_delete API entrypoint even exists.</p>
<p>int main() <br>
{ <br>
  wasm_config_t* wasm_config = wasm_config_new();<br>
  wasmtime_config_debug_info_set(wasm_config, true);<br>
  wasm_engine_t *engine = wasm_engine_new_with_config(wasm_config);</p>
<p>printf("wasm_functype_new_1_1[before].\n");<br>
  wasm_valtype_t* val_i32_1 =  wasm_valtype_new(WASM_I32);<br>
  wasm_valtype_t* val_i32_2 =  wasm_valtype_new(WASM_I32);<br>
  wasm_functype_t *__ft_i32_out_i32  = wasm_functype_new_1_1(val_i32_1, val_i32_2);<br>
  printf("wasm_functype_new_1_1[after].\n");</p>
<p>wasm_functype_delete(__ft_i32_out_i32);</p>
<p>wasm_valtype_delete(val_i32_1);<br>
  wasm_valtype_delete(val_i32_2);</p>
<p>return 0;<br>
}</p>
</blockquote>



<a name="356069590"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236347%20wasm_functype_new_1_1%20%26%20similar%20fa.../near/356069590" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236347.20wasm_functype_new_1_1.20.26.20similar.20fa.2E.2E.2E.html#356069590">(May 05 2023 at 14:04)</a>:</h4>
<p>adv-sw edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/6347#issuecomment-1536311797">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6347">issue #6347</a>:</p>
<blockquote>
<p>The following faults on wasm_valtype_delete so it seems we should never call wasm_valtype_delete as the value has been sucked internal to wasm_functype_new_1_1.</p>
<p>Hence wondering why wasm_valtype_delete API entrypoint even exists.</p>
<p>int main() <br>
{ <br>
  wasm_config_t* wasm_config = wasm_config_new();<br>
  wasmtime_config_debug_info_set(wasm_config, true);<br>
  wasm_engine_t *engine = wasm_engine_new_with_config(wasm_config);</p>
<p>printf("wasm_functype_new_1_1[before].\n");<br>
  wasm_valtype_t* val_i32_1 =  wasm_valtype_new(WASM_I32);<br>
  wasm_valtype_t* val_i32_2 =  wasm_valtype_new(WASM_I32);<br>
  wasm_functype_t *__ft_i32_out_i32  = wasm_functype_new_1_1(val_i32_1, val_i32_2);<br>
  printf("wasm_functype_new_1_1[after].\n");</p>
<p>wasm_functype_delete(__ft_i32_out_i32);</p>
<p>wasm_valtype_delete(val_i32_1);<br>
  wasm_valtype_delete(val_i32_2);</p>
<p>return 0;<br>
}</p>
</blockquote>



<a name="356081282"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236347%20wasm_functype_new_1_1%20%26%20similar%20fa.../near/356081282" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236347.20wasm_functype_new_1_1.20.26.20similar.20fa.2E.2E.2E.html#356081282">(May 05 2023 at 14:41)</a>:</h4>
<p>adv-sw closed <a href="https://github.com/bytecodealliance/wasmtime/issues/6347">issue #6347</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>#include &lt;stdio.h&gt;<br>
#include &lt;stdlib.h&gt;<br>
#include &lt;wasm.h&gt;<br>
#include &lt;wasmtime.h&gt;</p>
<p>int main() <br>
{ <br>
  wasm_config_t* wasm_config = wasm_config_new();<br>
  wasmtime_config_debug_info_set(wasm_config, true);<br>
  wasm_engine_t *engine = wasm_engine_new_with_config(wasm_config);</p>
<p>printf("A");<br>
  wasm_valtype_t* val_i32 =  wasm_valtype_new(WASM_I32);<br>
  wasm_functype_t *__ft_i32_out_i32  = wasm_functype_new_1_1(val_i32, val_i32);<br>
  printf("B");<br>
  printf("\n");</p>
<p>return 0;<br>
}</p>
<h3>Steps to Reproduce</h3>
<p>Compile the above, Windows (might also fault other platforms, but untested). Run it.</p>
<h3>Expected Results</h3>
<p>Completes - Output: AB</p>
<h3>Actual Results</h3>
<p>Faults in: wasm_functype_new_1_1 </p>
<h3>Versions and Environment</h3>
<p>Tip as of 5/5/2023 at 13:00 GMT</p>
<p>Windows 11 Home, X64</p>
<h3>Extra Info</h3>
<p>Reverting the following resolves the regression.</p>
<p><a href="https://pastebin.com/2Yt3FG9E">https://pastebin.com/2Yt3FG9E</a></p>
<p>... though the spec apparently states that function should reassign owner rather than clone, rework of regressed functionality.<br>
</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>