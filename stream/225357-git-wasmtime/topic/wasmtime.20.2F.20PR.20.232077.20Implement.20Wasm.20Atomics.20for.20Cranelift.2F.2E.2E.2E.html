<html>
<head><meta charset="utf-8"><title>wasmtime / PR #2077 Implement Wasm Atomics for Cranelift/... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html">wasmtime / PR #2077 Implement Wasm Atomics for Cranelift/...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="205333563"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205333563" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205333563">(Jul 29 2020 at 09:17)</a>:</h4>
<p>julian-seward1 opened <a href="https://github.com/bytecodealliance/wasmtime/pull/2077">PR #2077</a> from <code>atomics-CL</code> to <code>main</code>:</p>
<blockquote>
<p>The implementation is pretty straightforward.  Wasm atomic instructions fall<br>
into 5 groups</p>
<ul>
<li>atomic read-modify-write</li>
<li>atomic compare-and-swap</li>
<li>atomic loads</li>
<li>atomic stores</li>
<li>fences</li>
</ul>
<p>and the implementation mirrors that structure, at both the CLIF and AArch64<br>
levels.</p>
<p>At the CLIF level, there are five new instructions, one for each group.  Some<br>
comments about these:</p>
<ul>
<li>
<p>for those that take addresses (all except fences), the address is contained<br>
  entirely in a single <code>Value</code>; there is no offset field as there is with<br>
  normal loads and stores.  Wasm atomics require alignment checks, and<br>
  removing the offset makes implementation of those checks a bit simpler.</p>
</li>
<li>
<p>atomic loads and stores get their own instructions, rather than reusing the<br>
  existing load and store instructions, for two reasons:</p>
<ul>
<li>
<p>per above comment, makes alignment checking simpler</p>
</li>
<li>
<p>reuse of existing loads and stores would require extension of <code>MemFlags</code><br>
  to indicate atomicity, which sounds semantically unclean.  For example,<br>
  then <em>any</em> instruction carrying <code>MemFlags</code> could be marked as atomic, even<br>
  in cases where it is meaningless or ambiguous.</p>
</li>
</ul>
</li>
<li>
<p>I tried to specify, in comments, the behaviour of these instructions as<br>
  tightly as I could.  Unfortunately there is no way (per my limited CLIF<br>
  knowledge) to enforce the constraint that they may only be used on I8, I16,<br>
  I32 and I64 types, and in particular not on floating point or vector types.</p>
</li>
</ul>
<p>The translation from Wasm to CLIF, in <code>code_translator.rs</code> is unremarkable.</p>
<p>At the AArch64 level, there are also five new instructions, one for each<br>
group.  All of them except <code>::Fence</code> contain multiple real machine<br>
instructions.  Atomic r-m-w and atomic c-a-s are emitted as the usual<br>
load-linked store-conditional loops, guarded at both ends by memory fences.<br>
Atomic loads and stores are emitted as a load preceded by a fence, and a store<br>
followed by a fence, respectively.  The amount of fencing may be overkill, but<br>
it reflects exactly what the SM Wasm baseline compiler for AArch64 does.</p>
<p>One reason to implement r-m-w and c-a-s as a single insn which is expanded<br>
only at emission time is that we must be very careful what instructions we<br>
allow in between the load-linked and store-conditional.  In particular, we<br>
cannot allow <em>any</em> extra memory transactions in there, since -- particularly<br>
on low-end hardware -- that might cause the transaction to fail, hence<br>
deadlocking the generated code.  That implies that we can't present the LL/SC<br>
loop to the register allocator as its constituent instructions, since it might<br>
insert spills anywhere.  Hence we must present it as a single indivisible<br>
unit, as we do here.  It also has the benefit of reducing the total amount of<br>
work the RA has to do.</p>
<p>The only other notable feature of the r-m-w and c-a-s translations into<br>
AArch64 code, is that they both need a scratch register internally.  Rather<br>
than faking one up by claiming, in <code>get_regs</code> that it modifies an extra<br>
scratch register, and having to have a dummy initialisation of it, these new<br>
instructions (<code>::LLSC</code> and <code>::CAS</code>) simply use fixed registers in the range<br>
x24-x28.  We rely on the RA's ability to coalesce V&lt;--&gt;R copies to make the<br>
cost of the resulting extra copies zero or almost zero.  x24-x28 are chosen so<br>
as to be call-clobbered, hence their use is less likely to interfere with long<br>
live ranges that span calls.</p>
<p>One subtlety regarding the use of completely fixed input and output registers<br>
is that we must be careful how the surrounding copy from/to of the arg/result<br>
registers is done.  In particular, it is not safe to simply emit copies in<br>
some arbitrary order if one of the arg registers is a real reg.  For that<br>
reason, the arguments are first moved into virtual regs if they are not<br>
already there, using a new method <code>&lt;LowerCtx for Lower&gt;::ensure_in_vreg</code>.<br>
Again, we rely on coalescing to turn them into no-ops in the common case.</p>
<p>There is also a ridealong fix for the AArch64 lowering case for<br>
<code>Opcode::Trapif | Opcode::Trapff</code>, which removes a bug in which two trap insns<br>
in a row were generated.</p>
<p>In the patch as submitted there are 6 "FIXME JRS" comments, which mark things<br>
which I believe to be correct, but for which I would appreciate a second<br>
opinion.  Unless otherwise directed, I will remove them for the final commit<br>
but leave the associated code/comments unchanged.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="205334312"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205334312" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205334312">(Jul 29 2020 at 09:27)</a>:</h4>
<p><strong>julian-seward1</strong> requested <a href="https://github.com/bnjbvr">bnjbvr</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/2077">PR #2077</a>.</p>



<a name="205334323"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205334323" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205334323">(Jul 29 2020 at 09:27)</a>:</h4>
<p><strong>julian-seward1</strong> requested <a href="https://github.com/cfallin">cfallin</a> and <a href="https://github.com/bnjbvr">bnjbvr</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/2077">PR #2077</a>.</p>



<a name="205334341"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205334341" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205334341">(Jul 29 2020 at 09:27)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#pullrequestreview-457345676">PR Review</a>.</p>



<a name="205334343"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205334343" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205334343">(Jul 29 2020 at 09:27)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#pullrequestreview-457345676">PR Review</a>.</p>



<a name="205334344"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205334344" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205334344">(Jul 29 2020 at 09:27)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462161536">PR Review Comment</a>:</p>
<blockquote>
<p><code>Mem</code> is defined at <a href="https://github.com/julian-seward1/wasmtime/blob/23b8640f2a016b7077f44f41501750a5d018a658/cranelift/codegen/meta/src/shared/instructions.rs#L791">https://github.com/julian-seward1/wasmtime/blob/23b8640f2a016b7077f44f41501750a5d018a658/cranelift/codegen/meta/src/shared/instructions.rs#L791</a>. You could create a new typevar to only allow i8..i64.</p>
</blockquote>



<a name="205334345"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205334345" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205334345">(Jul 29 2020 at 09:27)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462163432">PR Review Comment</a>:</p>
<blockquote>
<p>cg_clif also requires nand, max, min, umax, umin.</p>
</blockquote>



<a name="205412355"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205412355" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205412355">(Jul 29 2020 at 20:54)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#pullrequestreview-457715365">PR Review</a>.</p>



<a name="205412356"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205412356" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205412356">(Jul 29 2020 at 20:54)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#pullrequestreview-457715365">PR Review</a>.</p>



<a name="205412357"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205412357" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205412357">(Jul 29 2020 at 20:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462448799">PR Review Comment</a>:</p>
<blockquote>
<p>Slightly pedantic (sorry!) but let's write out "read-modify-write" here for clarity.</p>
</blockquote>



<a name="205412358"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205412358" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205412358">(Jul 29 2020 at 20:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462449315">PR Review Comment</a>:</p>
<blockquote>
<p>+1, let's limit to just the types that make sense.</p>
</blockquote>



<a name="205412359"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205412359" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205412359">(Jul 29 2020 at 20:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462450220">PR Review Comment</a>:</p>
<blockquote>
<p>nit: single backticks here for consistency with other descriptions.</p>
</blockquote>



<a name="205412360"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205412360" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205412360">(Jul 29 2020 at 20:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462451452">PR Review Comment</a>:</p>
<blockquote>
<p>For clarity: the old value is returned whether or not the CAS succeeds, I assume? (There's no bool success flag so this must be the case?)</p>
</blockquote>



<a name="205412361"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205412361" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205412361">(Jul 29 2020 at 20:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462531056">PR Review Comment</a>:</p>
<blockquote>
<p>Let's embed a <code>Type</code> instead.</p>
</blockquote>



<a name="205412362"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205412362" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205412362">(Jul 29 2020 at 20:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462506017">PR Review Comment</a>:</p>
<blockquote>
<p>Yes, I think that's reasonable; we try not to rely on the actual CLIF in the vcode, but there's no reason not to reuse its enum here.</p>
</blockquote>



<a name="205412363"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205412363" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205412363">(Jul 29 2020 at 20:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462530450">PR Review Comment</a>:</p>
<blockquote>
<p>Actually (after looking further down) I think it might be better to simply reuse <code>ALUOp</code>: in principle, any <code>AluRRR</code> instruction could be emitted as the op inside the r-m-w sequence, no?</p>
</blockquote>



<a name="205412364"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205412364" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205412364">(Jul 29 2020 at 20:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462452658">PR Review Comment</a>:</p>
<blockquote>
<p>We might want to say something about the memory ordering model here. In particular, do atomics follow sequential consistency, and do they create happens-before edges that order normal (non-atomic) loads/stores? I think this is the case based on the fences that are emitted (but we should double-check!).</p>
</blockquote>



<a name="205412365"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205412365" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205412365">(Jul 29 2020 at 20:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462536112">PR Review Comment</a>:</p>
<blockquote>
<p>No need for braces here</p>
</blockquote>



<a name="205412366"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205412366" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205412366">(Jul 29 2020 at 20:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462528890">PR Review Comment</a>:</p>
<blockquote>
<p>For consistency, I think it might be better to write an <code>enc_...() -&gt; u32</code> helper that takes the size as a parameter.</p>
</blockquote>



<a name="205412367"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205412367" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205412367">(Jul 29 2020 at 20:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462539798">PR Review Comment</a>:</p>
<blockquote>
<p>I think the no-extend is safe here for the ops this patch supports, but if we add e.g. min/max later, we need to reconsider...</p>
</blockquote>



<a name="205412368"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205412368" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205412368">(Jul 29 2020 at 20:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462537458">PR Review Comment</a>:</p>
<blockquote>
<p><code>writable_xreg()</code> here as well</p>
</blockquote>



<a name="205412369"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205412369" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205412369">(Jul 29 2020 at 20:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462535659">PR Review Comment</a>:</p>
<blockquote>
<p>Use a <code>Type</code> here; or if not that, let's use or define an enum for this.</p>
</blockquote>



<a name="205412370"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205412370" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205412370">(Jul 29 2020 at 20:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462541165">PR Review Comment</a>:</p>
<blockquote>
<p><code>emit_safepoint</code> if this is a resumable trap; if it kills the Wasm program, then no need (everything becomes dead on termination). I think a misalignment trap is the latter case?</p>
</blockquote>



<a name="205412371"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205412371" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205412371">(Jul 29 2020 at 20:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462542273">PR Review Comment</a>:</p>
<blockquote>
<p>I like this API -- an elegant solution to the problem!</p>
<p>We might want to add a note in the doc comment about when it might be necessary: e.g., a warning about parallel moves and overlapping registers when insts that emit sequences with fixed real regs are given real-reg arguments.</p>
</blockquote>



<a name="205412372"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205412372" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205412372">(Jul 29 2020 at 20:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462531800">PR Review Comment</a>:</p>
<blockquote>
<p>I'd prefer to encapsulate <code>ldxr</code> (and the store-conditional below too) in <code>enc_...</code> helpers as with most of the other cases; we haven't been perfect with this (and I should clean it up later) but I want to try to maintain the separation.</p>
</blockquote>



<a name="205412373"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205412373" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205412373">(Jul 29 2020 at 20:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462536489">PR Review Comment</a>:</p>
<blockquote>
<p>Use <code>writable_xreg()</code>?</p>
</blockquote>



<a name="205412374"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205412374" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205412374">(Jul 29 2020 at 20:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462540220">PR Review Comment</a>:</p>
<blockquote>
<p>Maybe add a comment here that the CAS sequence does its own masking, so we don't need to worry about zero-extending narrow (<code>I8</code>/<code>I16</code>) values.</p>
</blockquote>



<a name="205412375"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205412375" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205412375">(Jul 29 2020 at 20:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462546915">PR Review Comment</a>:</p>
<blockquote>
<p>Do we want to <code>return Err(wasm_unsupported!("Unsupported atomic access type {:?}", access_ty))</code> instead? It seems we only call this with hardcoded types in the big match above (so any failure is our error, not a bad input) but it at least hooks into the existing error-reporting path.</p>
</blockquote>



<a name="205412376"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205412376" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205412376">(Jul 29 2020 at 20:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462532724">PR Review Comment</a>:</p>
<blockquote>
<p>I'd prefer not to have the redundant information here regarding ALU-op encodings; I'd prefer to construct an <code>AluRRR</code> (with the hardcoded registers and an <code>ALUOp</code> from this inst's fields) and emit it here. Or, if not that, at least invoke the <code>enc_...</code> helper directly with the appropriate regs and op.</p>
<p>Aside from avoiding the redundancy, this change also makes it much easier to modify later; the hex constants are difficult to maintain if, e.g., we ever want to change which registers are used.</p>
</blockquote>



<a name="205412377"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205412377" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205412377">(Jul 29 2020 at 20:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462533652">PR Review Comment</a>:</p>
<blockquote>
<p>Similar comments here as above regarding hardcoded constants vs. encoding functions and labels.</p>
</blockquote>



<a name="205412378"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205412378" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205412378">(Jul 29 2020 at 20:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462538930">PR Review Comment</a>:</p>
<blockquote>
<p>Potential optimization (not needed for correctness): there's no need to mask to 32 bits if we use a <code>cmp w27, w24</code> instead (and <code>cbnz w24, ...</code>).</p>
</blockquote>



<a name="205412379"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205412379" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205412379">(Jul 29 2020 at 20:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462533293">PR Review Comment</a>:</p>
<blockquote>
<p>Let's use a label and fixup for the branch target; not doing so is potentially very error-prone in hard-to-debug ways if we ever change the length of the sequence above.</p>
</blockquote>



<a name="205412380"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205412380" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205412380">(Jul 29 2020 at 20:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462535360">PR Review Comment</a>:</p>
<blockquote>
<p>As hinted earlier -- I think the best way to go about this is to actually just reuse the <code>ALUOp</code> enum. I'm not sure of any reason to limit the allowed set of r-m-w opcodes; in principle, any two-source, one-dest operation might be desirable to perform in an atomic way.</p>
</blockquote>



<a name="205412381"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205412381" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205412381">(Jul 29 2020 at 20:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462581193">PR Review Comment</a>:</p>
<blockquote>
<p>close-paren after <code>i32</code> (and likewise below)?</p>
</blockquote>



<a name="205444394"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205444394" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205444394">(Jul 30 2020 at 05:56)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462752236">PR Review Comment</a>:</p>
<blockquote>
<p>The Wasm atomics spec requires sequential consistency, so for each of the 5 new CLIF insns, I have added <code>This operation is sequentially consistent.</code>.  For the happens-before relation to normal loads/stores, this exceeds my knowledge of such things.  I'll make enquiries.</p>
</blockquote>



<a name="205444395"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205444395" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205444395">(Jul 30 2020 at 05:56)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#pullrequestreview-458090266">PR Review</a>.</p>



<a name="205444855"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205444855" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205444855">(Jul 30 2020 at 06:06)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#pullrequestreview-458094094">PR Review</a>.</p>



<a name="205444856"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205444856" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205444856">(Jul 30 2020 at 06:06)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462755335">PR Review Comment</a>:</p>
<blockquote>
<p>On investigation, I am inclined to leave this as-is (although rename it to <code>AtomicRMWOp</code>) for two reasons:</p>
<ul>
<li><code>ALUOp</code> has 32- and 64-bit variants of each operation.  But <code>Inst::AtomicRMW</code> also has a <code>type</code> field, and so that gives the possibility of creating nonsensical combinations (it violates the no-junk no-confusion rule).  Eg, <code>type</code> indicating 64-bit, but with <code>op</code> being <code>ALUOp::Orr32</code>.</li>
<li>per @bjorn3's comment above ("cg_clif also requires nand, max, min, umax, umin."), <code>ALUOp</code> doesn't have max/min/umax/umin.</li>
</ul>
</blockquote>



<a name="205445355"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205445355" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205445355">(Jul 30 2020 at 06:20)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#pullrequestreview-458099656">PR Review</a>.</p>



<a name="205445356"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205445356" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205445356">(Jul 30 2020 at 06:20)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462760095">PR Review Comment</a>:</p>
<blockquote>
<p>I can write this as an <code>enc_*</code> function, no problem, but I didn't understand the comment about the size.  This is a fence; there is no size field.  Did you perhaps mean to parameterise it on the sharability domain (the <code>ISH</code> == "inner sharable") part?</p>
</blockquote>



<a name="205446761"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205446761" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205446761">(Jul 30 2020 at 06:55)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#pullrequestreview-458129807">PR Review</a>.</p>



<a name="205446762"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205446762" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205446762">(Jul 30 2020 at 06:55)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462779971">PR Review Comment</a>:</p>
<blockquote>
<p>Per comment above, it might in hindsight be cleaner to retain <code>LLSCOp</code> but rename it to <code>AtomicRMWOp</code>.</p>
</blockquote>



<a name="205448557"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205448557" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205448557">(Jul 30 2020 at 07:26)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462801416">PR Review Comment</a>:</p>
<blockquote>
<p>When you say "doc comment", do you mean this comment here (on <code>ensure_in_vreg</code>), or somewhere else?  (unclear)</p>
</blockquote>



<a name="205448558"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205448558" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205448558">(Jul 30 2020 at 07:26)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#pullrequestreview-458147467">PR Review</a>.</p>



<a name="205452020"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205452020" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205452020">(Jul 30 2020 at 08:13)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#pullrequestreview-458179869">PR Review</a>.</p>



<a name="205452021"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205452021" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205452021">(Jul 30 2020 at 08:13)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462826467">PR Review Comment</a>:</p>
<blockquote>
<p>Yes, it returns the old value regardless of whether the CAS succeeds or fails.  I updated the comment accordingly.</p>
</blockquote>



<a name="205452868"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205452868" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205452868">(Jul 30 2020 at 08:23)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#pullrequestreview-458187717">PR Review</a>.</p>



<a name="205452869"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205452869" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205452869">(Jul 30 2020 at 08:23)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462832585">PR Review Comment</a>:</p>
<blockquote>
<p>Regarding the happens-before edges, Lars writes: "Yes [they create h-b edges] ... normal loads and stores may be reordered among themselves but not across atomics, and atomics may not be reordered wrt each other".</p>
<p>So I think we're good (right?)  The implementation fences everything with <code>dmb ish</code>, which IIUC prevents movement of both loads and stores either forwards or backwards across the fence.  And FWIW, this is the same fencyness as SM/wasm/baseline; I just cloned the scheme that uses.</p>
</blockquote>



<a name="205453473"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205453473" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205453473">(Jul 30 2020 at 08:30)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#pullrequestreview-458192948">PR Review</a>.</p>



<a name="205453474"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205453474" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205453474">(Jul 30 2020 at 08:30)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462836677">PR Review Comment</a>:</p>
<blockquote>
<p>They are non-resumable; no stackmap needed.  Choosing plain <code>emit</code> therefore.</p>
</blockquote>



<a name="205453555"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205453555" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205453555">(Jul 30 2020 at 08:31)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#pullrequestreview-458193897">PR Review</a>.</p>



<a name="205453556"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205453556" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205453556">(Jul 30 2020 at 08:31)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462837411">PR Review Comment</a>:</p>
<blockquote>
<p>.. but then, why does <code>Opcode::Trap</code> use <code>emit_safepoint</code> ?</p>
</blockquote>



<a name="205453883"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205453883" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205453883">(Jul 30 2020 at 08:35)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#pullrequestreview-458196973">PR Review</a>.</p>



<a name="205453884"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205453884" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205453884">(Jul 30 2020 at 08:35)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462839730">PR Review Comment</a>:</p>
<blockquote>
<p>One thing that concerns me here is that it seems like we're conflating the semantics of wasm with the semantics of CLIF.  Whether or not <code>Opcode::Trapif | Opcode::Trapff</code> produces a safepoint should surely be specified as part of CLIF's semantics, and not be dependent of the semantics of whatever that CLIF was translated from.</p>
</blockquote>



<a name="205455735"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205455735" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205455735">(Jul 30 2020 at 08:59)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r462853739">PR Review Comment</a>:</p>
<blockquote>
<p>Done.</p>
</blockquote>



<a name="205455736"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205455736" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205455736">(Jul 30 2020 at 08:59)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#pullrequestreview-458215363">PR Review</a>.</p>



<a name="205494634"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205494634" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205494634">(Jul 30 2020 at 15:39)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#pullrequestreview-458523813">PR Review</a>.</p>



<a name="205494635"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205494635" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205494635">(Jul 30 2020 at 15:39)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r463088890">PR Review Comment</a>:</p>
<blockquote>
<p>Cool, that's what I suspected (and that's what the fences enforce, as far as I can tell), so as long as we document that in the descriptions, we're good!</p>
</blockquote>



<a name="205494836"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205494836" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205494836">(Jul 30 2020 at 15:40)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#pullrequestreview-458525210">PR Review</a>.</p>



<a name="205494838"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205494838" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205494838">(Jul 30 2020 at 15:40)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r463090010">PR Review Comment</a>:</p>
<blockquote>
<p>Yes, exactly, this comment here on the function declaration. Thanks!</p>
</blockquote>



<a name="205495859"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205495859" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205495859">(Jul 30 2020 at 15:49)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#pullrequestreview-458532704">PR Review</a>.</p>



<a name="205495861"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205495861" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205495861">(Jul 30 2020 at 15:49)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r463095686">PR Review Comment</a>:</p>
<blockquote>
<p>Hmm, I think I missed some context previously -- I thought for some reason that your additions here only had to do with atomics-related misalignments, but of course if I scroll up just a bit I see this is for any <code>Opcode::Trap{if,ff}</code>. D'oh. Yes, it should always have a safepoint if it is a trap at the CLIF level; the only non-safepoint-adorned traps are the ones that are internal to e.g. divides. I suppose we should specify in the CLIF descriptions that any traps generated by instruction error conditions (rather than explicit trap instructions) will not have safepoints.</p>
<p>Just to be sure -- @bnjbvr, could you confirm that we don't expect (or can get away with specifying) that there is no safepoint data for e.g. divide traps?</p>
</blockquote>



<a name="205560745"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205560745" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205560745">(Jul 31 2020 at 06:03)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#pullrequestreview-458934914">PR Review</a>.</p>



<a name="205560746"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205560746" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205560746">(Jul 31 2020 at 06:03)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r463421185">PR Review Comment</a>:</p>
<blockquote>
<p>Changing to <code>emit_safepoint</code>.</p>
</blockquote>



<a name="205560818"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205560818" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205560818">(Jul 31 2020 at 06:05)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#pullrequestreview-458935346">PR Review</a>.</p>



<a name="205560819"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205560819" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205560819">(Jul 31 2020 at 06:05)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r463421537">PR Review Comment</a>:</p>
<blockquote>
<p>The emit code is complicated enough as it is; would you be greatly offended if I punted on this, at least for now?</p>
</blockquote>



<a name="205561014"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205561014" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205561014">(Jul 31 2020 at 06:10)</a>:</h4>
<p>julian-seward1 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2077">PR #2077</a> from <code>atomics-CL</code> to <code>main</code>:</p>
<blockquote>
<p>The implementation is pretty straightforward.  Wasm atomic instructions fall<br>
into 5 groups</p>
<ul>
<li>atomic read-modify-write</li>
<li>atomic compare-and-swap</li>
<li>atomic loads</li>
<li>atomic stores</li>
<li>fences</li>
</ul>
<p>and the implementation mirrors that structure, at both the CLIF and AArch64<br>
levels.</p>
<p>At the CLIF level, there are five new instructions, one for each group.  Some<br>
comments about these:</p>
<ul>
<li>
<p>for those that take addresses (all except fences), the address is contained<br>
  entirely in a single <code>Value</code>; there is no offset field as there is with<br>
  normal loads and stores.  Wasm atomics require alignment checks, and<br>
  removing the offset makes implementation of those checks a bit simpler.</p>
</li>
<li>
<p>atomic loads and stores get their own instructions, rather than reusing the<br>
  existing load and store instructions, for two reasons:</p>
<ul>
<li>
<p>per above comment, makes alignment checking simpler</p>
</li>
<li>
<p>reuse of existing loads and stores would require extension of <code>MemFlags</code><br>
  to indicate atomicity, which sounds semantically unclean.  For example,<br>
  then <em>any</em> instruction carrying <code>MemFlags</code> could be marked as atomic, even<br>
  in cases where it is meaningless or ambiguous.</p>
</li>
</ul>
</li>
<li>
<p>I tried to specify, in comments, the behaviour of these instructions as<br>
  tightly as I could.  Unfortunately there is no way (per my limited CLIF<br>
  knowledge) to enforce the constraint that they may only be used on I8, I16,<br>
  I32 and I64 types, and in particular not on floating point or vector types.</p>
</li>
</ul>
<p>The translation from Wasm to CLIF, in <code>code_translator.rs</code> is unremarkable.</p>
<p>At the AArch64 level, there are also five new instructions, one for each<br>
group.  All of them except <code>::Fence</code> contain multiple real machine<br>
instructions.  Atomic r-m-w and atomic c-a-s are emitted as the usual<br>
load-linked store-conditional loops, guarded at both ends by memory fences.<br>
Atomic loads and stores are emitted as a load preceded by a fence, and a store<br>
followed by a fence, respectively.  The amount of fencing may be overkill, but<br>
it reflects exactly what the SM Wasm baseline compiler for AArch64 does.</p>
<p>One reason to implement r-m-w and c-a-s as a single insn which is expanded<br>
only at emission time is that we must be very careful what instructions we<br>
allow in between the load-linked and store-conditional.  In particular, we<br>
cannot allow <em>any</em> extra memory transactions in there, since -- particularly<br>
on low-end hardware -- that might cause the transaction to fail, hence<br>
deadlocking the generated code.  That implies that we can't present the LL/SC<br>
loop to the register allocator as its constituent instructions, since it might<br>
insert spills anywhere.  Hence we must present it as a single indivisible<br>
unit, as we do here.  It also has the benefit of reducing the total amount of<br>
work the RA has to do.</p>
<p>The only other notable feature of the r-m-w and c-a-s translations into<br>
AArch64 code, is that they both need a scratch register internally.  Rather<br>
than faking one up by claiming, in <code>get_regs</code> that it modifies an extra<br>
scratch register, and having to have a dummy initialisation of it, these new<br>
instructions (<code>::LLSC</code> and <code>::CAS</code>) simply use fixed registers in the range<br>
x24-x28.  We rely on the RA's ability to coalesce V&lt;--&gt;R copies to make the<br>
cost of the resulting extra copies zero or almost zero.  x24-x28 are chosen so<br>
as to be call-clobbered, hence their use is less likely to interfere with long<br>
live ranges that span calls.</p>
<p>One subtlety regarding the use of completely fixed input and output registers<br>
is that we must be careful how the surrounding copy from/to of the arg/result<br>
registers is done.  In particular, it is not safe to simply emit copies in<br>
some arbitrary order if one of the arg registers is a real reg.  For that<br>
reason, the arguments are first moved into virtual regs if they are not<br>
already there, using a new method <code>&lt;LowerCtx for Lower&gt;::ensure_in_vreg</code>.<br>
Again, we rely on coalescing to turn them into no-ops in the common case.</p>
<p>There is also a ridealong fix for the AArch64 lowering case for<br>
<code>Opcode::Trapif | Opcode::Trapff</code>, which removes a bug in which two trap insns<br>
in a row were generated.</p>
<p>In the patch as submitted there are 6 "FIXME JRS" comments, which mark things<br>
which I believe to be correct, but for which I would appreciate a second<br>
opinion.  Unless otherwise directed, I will remove them for the final commit<br>
but leave the associated code/comments unchanged.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="205563805"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205563805" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205563805">(Jul 31 2020 at 07:08)</a>:</h4>
<p>julian-seward1 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2077">PR #2077</a> from <code>atomics-CL</code> to <code>main</code>:</p>
<blockquote>
<p>The implementation is pretty straightforward.  Wasm atomic instructions fall<br>
into 5 groups</p>
<ul>
<li>atomic read-modify-write</li>
<li>atomic compare-and-swap</li>
<li>atomic loads</li>
<li>atomic stores</li>
<li>fences</li>
</ul>
<p>and the implementation mirrors that structure, at both the CLIF and AArch64<br>
levels.</p>
<p>At the CLIF level, there are five new instructions, one for each group.  Some<br>
comments about these:</p>
<ul>
<li>
<p>for those that take addresses (all except fences), the address is contained<br>
  entirely in a single <code>Value</code>; there is no offset field as there is with<br>
  normal loads and stores.  Wasm atomics require alignment checks, and<br>
  removing the offset makes implementation of those checks a bit simpler.</p>
</li>
<li>
<p>atomic loads and stores get their own instructions, rather than reusing the<br>
  existing load and store instructions, for two reasons:</p>
<ul>
<li>
<p>per above comment, makes alignment checking simpler</p>
</li>
<li>
<p>reuse of existing loads and stores would require extension of <code>MemFlags</code><br>
  to indicate atomicity, which sounds semantically unclean.  For example,<br>
  then <em>any</em> instruction carrying <code>MemFlags</code> could be marked as atomic, even<br>
  in cases where it is meaningless or ambiguous.</p>
</li>
</ul>
</li>
<li>
<p>I tried to specify, in comments, the behaviour of these instructions as<br>
  tightly as I could.  Unfortunately there is no way (per my limited CLIF<br>
  knowledge) to enforce the constraint that they may only be used on I8, I16,<br>
  I32 and I64 types, and in particular not on floating point or vector types.</p>
</li>
</ul>
<p>The translation from Wasm to CLIF, in <code>code_translator.rs</code> is unremarkable.</p>
<p>At the AArch64 level, there are also five new instructions, one for each<br>
group.  All of them except <code>::Fence</code> contain multiple real machine<br>
instructions.  Atomic r-m-w and atomic c-a-s are emitted as the usual<br>
load-linked store-conditional loops, guarded at both ends by memory fences.<br>
Atomic loads and stores are emitted as a load preceded by a fence, and a store<br>
followed by a fence, respectively.  The amount of fencing may be overkill, but<br>
it reflects exactly what the SM Wasm baseline compiler for AArch64 does.</p>
<p>One reason to implement r-m-w and c-a-s as a single insn which is expanded<br>
only at emission time is that we must be very careful what instructions we<br>
allow in between the load-linked and store-conditional.  In particular, we<br>
cannot allow <em>any</em> extra memory transactions in there, since -- particularly<br>
on low-end hardware -- that might cause the transaction to fail, hence<br>
deadlocking the generated code.  That implies that we can't present the LL/SC<br>
loop to the register allocator as its constituent instructions, since it might<br>
insert spills anywhere.  Hence we must present it as a single indivisible<br>
unit, as we do here.  It also has the benefit of reducing the total amount of<br>
work the RA has to do.</p>
<p>The only other notable feature of the r-m-w and c-a-s translations into<br>
AArch64 code, is that they both need a scratch register internally.  Rather<br>
than faking one up by claiming, in <code>get_regs</code> that it modifies an extra<br>
scratch register, and having to have a dummy initialisation of it, these new<br>
instructions (<code>::LLSC</code> and <code>::CAS</code>) simply use fixed registers in the range<br>
x24-x28.  We rely on the RA's ability to coalesce V&lt;--&gt;R copies to make the<br>
cost of the resulting extra copies zero or almost zero.  x24-x28 are chosen so<br>
as to be call-clobbered, hence their use is less likely to interfere with long<br>
live ranges that span calls.</p>
<p>One subtlety regarding the use of completely fixed input and output registers<br>
is that we must be careful how the surrounding copy from/to of the arg/result<br>
registers is done.  In particular, it is not safe to simply emit copies in<br>
some arbitrary order if one of the arg registers is a real reg.  For that<br>
reason, the arguments are first moved into virtual regs if they are not<br>
already there, using a new method <code>&lt;LowerCtx for Lower&gt;::ensure_in_vreg</code>.<br>
Again, we rely on coalescing to turn them into no-ops in the common case.</p>
<p>There is also a ridealong fix for the AArch64 lowering case for<br>
<code>Opcode::Trapif | Opcode::Trapff</code>, which removes a bug in which two trap insns<br>
in a row were generated.</p>
<p>In the patch as submitted there are 6 "FIXME JRS" comments, which mark things<br>
which I believe to be correct, but for which I would appreciate a second<br>
opinion.  Unless otherwise directed, I will remove them for the final commit<br>
but leave the associated code/comments unchanged.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="205586202"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205586202" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205586202">(Jul 31 2020 at 12:48)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#pullrequestreview-459146496">PR Review</a>.</p>



<a name="205586203"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205586203" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205586203">(Jul 31 2020 at 12:48)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r463590167">PR Review Comment</a>:</p>
<blockquote>
<blockquote>
<p>Just to be sure -- @bnjbvr, could you confirm that we don't expect (or can get away with specifying) that there is no safepoint data for e.g. divide traps?</p>
</blockquote>
<p>Agreed, and i think that indeed it should be specified that no GC must happen during stack unwinding (that sounds very scary and unsafe anyways)(now I wonder if wasm exception handling + wasm GC types could make this case actually possible).</p>
</blockquote>



<a name="205589102"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205589102" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205589102">(Jul 31 2020 at 13:20)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#pullrequestreview-459159926">PR Review</a>.</p>



<a name="205589103"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205589103" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205589103">(Jul 31 2020 at 13:20)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#pullrequestreview-459159926">PR Review</a>.</p>



<a name="205589104"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205589104" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205589104">(Jul 31 2020 at 13:20)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r463603064">PR Review Comment</a>:</p>
<blockquote>
<p>If this is implemented as a callout in general: yes. All the callouts in the "dummy" wasm to clif environment are implemented this way; this is only used when testing internally wasm compilation with clif-util, that is, when no proper environment can be used.</p>
</blockquote>



<a name="205589105"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205589105" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205589105">(Jul 31 2020 at 13:20)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r463600613">PR Review Comment</a>:</p>
<blockquote>
<p>nit: here and below, please remove the code commented out.</p>
</blockquote>



<a name="205589106"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205589106" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205589106">(Jul 31 2020 at 13:20)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r463603782">PR Review Comment</a>:</p>
<blockquote>
<p>In terms of API cleanliness, would it make sense to have a single function <code>translate_atomic_wait</code> that takes an extra Type parameter, that can be either I32 or I64? Going one step further, would it make sense to have a single <code>translate_atomic</code> method that would be passed an enum with variants <code>WaitI32/I64/Notify</code>?</p>
</blockquote>



<a name="205589119"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205589119" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205589119">(Jul 31 2020 at 13:20)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#pullrequestreview-459159926">PR Review</a>.</p>



<a name="205598088"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205598088" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205598088">(Jul 31 2020 at 14:40)</a>:</h4>
<p>julian-seward1 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2077">PR #2077</a> from <code>atomics-CL</code> to <code>main</code>:</p>
<blockquote>
<p>The implementation is pretty straightforward.  Wasm atomic instructions fall<br>
into 5 groups</p>
<ul>
<li>atomic read-modify-write</li>
<li>atomic compare-and-swap</li>
<li>atomic loads</li>
<li>atomic stores</li>
<li>fences</li>
</ul>
<p>and the implementation mirrors that structure, at both the CLIF and AArch64<br>
levels.</p>
<p>At the CLIF level, there are five new instructions, one for each group.  Some<br>
comments about these:</p>
<ul>
<li>
<p>for those that take addresses (all except fences), the address is contained<br>
  entirely in a single <code>Value</code>; there is no offset field as there is with<br>
  normal loads and stores.  Wasm atomics require alignment checks, and<br>
  removing the offset makes implementation of those checks a bit simpler.</p>
</li>
<li>
<p>atomic loads and stores get their own instructions, rather than reusing the<br>
  existing load and store instructions, for two reasons:</p>
<ul>
<li>
<p>per above comment, makes alignment checking simpler</p>
</li>
<li>
<p>reuse of existing loads and stores would require extension of <code>MemFlags</code><br>
  to indicate atomicity, which sounds semantically unclean.  For example,<br>
  then <em>any</em> instruction carrying <code>MemFlags</code> could be marked as atomic, even<br>
  in cases where it is meaningless or ambiguous.</p>
</li>
</ul>
</li>
<li>
<p>I tried to specify, in comments, the behaviour of these instructions as<br>
  tightly as I could.  Unfortunately there is no way (per my limited CLIF<br>
  knowledge) to enforce the constraint that they may only be used on I8, I16,<br>
  I32 and I64 types, and in particular not on floating point or vector types.</p>
</li>
</ul>
<p>The translation from Wasm to CLIF, in <code>code_translator.rs</code> is unremarkable.</p>
<p>At the AArch64 level, there are also five new instructions, one for each<br>
group.  All of them except <code>::Fence</code> contain multiple real machine<br>
instructions.  Atomic r-m-w and atomic c-a-s are emitted as the usual<br>
load-linked store-conditional loops, guarded at both ends by memory fences.<br>
Atomic loads and stores are emitted as a load preceded by a fence, and a store<br>
followed by a fence, respectively.  The amount of fencing may be overkill, but<br>
it reflects exactly what the SM Wasm baseline compiler for AArch64 does.</p>
<p>One reason to implement r-m-w and c-a-s as a single insn which is expanded<br>
only at emission time is that we must be very careful what instructions we<br>
allow in between the load-linked and store-conditional.  In particular, we<br>
cannot allow <em>any</em> extra memory transactions in there, since -- particularly<br>
on low-end hardware -- that might cause the transaction to fail, hence<br>
deadlocking the generated code.  That implies that we can't present the LL/SC<br>
loop to the register allocator as its constituent instructions, since it might<br>
insert spills anywhere.  Hence we must present it as a single indivisible<br>
unit, as we do here.  It also has the benefit of reducing the total amount of<br>
work the RA has to do.</p>
<p>The only other notable feature of the r-m-w and c-a-s translations into<br>
AArch64 code, is that they both need a scratch register internally.  Rather<br>
than faking one up by claiming, in <code>get_regs</code> that it modifies an extra<br>
scratch register, and having to have a dummy initialisation of it, these new<br>
instructions (<code>::LLSC</code> and <code>::CAS</code>) simply use fixed registers in the range<br>
x24-x28.  We rely on the RA's ability to coalesce V&lt;--&gt;R copies to make the<br>
cost of the resulting extra copies zero or almost zero.  x24-x28 are chosen so<br>
as to be call-clobbered, hence their use is less likely to interfere with long<br>
live ranges that span calls.</p>
<p>One subtlety regarding the use of completely fixed input and output registers<br>
is that we must be careful how the surrounding copy from/to of the arg/result<br>
registers is done.  In particular, it is not safe to simply emit copies in<br>
some arbitrary order if one of the arg registers is a real reg.  For that<br>
reason, the arguments are first moved into virtual regs if they are not<br>
already there, using a new method <code>&lt;LowerCtx for Lower&gt;::ensure_in_vreg</code>.<br>
Again, we rely on coalescing to turn them into no-ops in the common case.</p>
<p>There is also a ridealong fix for the AArch64 lowering case for<br>
<code>Opcode::Trapif | Opcode::Trapff</code>, which removes a bug in which two trap insns<br>
in a row were generated.</p>
<p>In the patch as submitted there are 6 "FIXME JRS" comments, which mark things<br>
which I believe to be correct, but for which I would appreciate a second<br>
opinion.  Unless otherwise directed, I will remove them for the final commit<br>
but leave the associated code/comments unchanged.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="205786825"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205786825" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205786825">(Aug 03 2020 at 12:18)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#pullrequestreview-459978790">PR Review</a>.</p>



<a name="205786826"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205786826" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205786826">(Aug 03 2020 at 12:18)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r464376548">PR Review Comment</a>:</p>
<blockquote>
<p>Merging the <code>wait</code> and <code>notify</code> cases is messy because they have different params.  However, the two <code>wait</code> cases can be merged without even needing an extra <code>Type</code> parameter, since the 32-vs-64 bit difference can be determined by inspecting the type of the <code>expected</code> parameter.  So that's what I did.</p>
</blockquote>



<a name="205790197"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205790197" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205790197">(Aug 03 2020 at 12:58)</a>:</h4>
<p>julian-seward1 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2077">PR #2077</a> from <code>atomics-CL</code> to <code>main</code>:</p>
<blockquote>
<p>The implementation is pretty straightforward.  Wasm atomic instructions fall<br>
into 5 groups</p>
<ul>
<li>atomic read-modify-write</li>
<li>atomic compare-and-swap</li>
<li>atomic loads</li>
<li>atomic stores</li>
<li>fences</li>
</ul>
<p>and the implementation mirrors that structure, at both the CLIF and AArch64<br>
levels.</p>
<p>At the CLIF level, there are five new instructions, one for each group.  Some<br>
comments about these:</p>
<ul>
<li>
<p>for those that take addresses (all except fences), the address is contained<br>
  entirely in a single <code>Value</code>; there is no offset field as there is with<br>
  normal loads and stores.  Wasm atomics require alignment checks, and<br>
  removing the offset makes implementation of those checks a bit simpler.</p>
</li>
<li>
<p>atomic loads and stores get their own instructions, rather than reusing the<br>
  existing load and store instructions, for two reasons:</p>
<ul>
<li>
<p>per above comment, makes alignment checking simpler</p>
</li>
<li>
<p>reuse of existing loads and stores would require extension of <code>MemFlags</code><br>
  to indicate atomicity, which sounds semantically unclean.  For example,<br>
  then <em>any</em> instruction carrying <code>MemFlags</code> could be marked as atomic, even<br>
  in cases where it is meaningless or ambiguous.</p>
</li>
</ul>
</li>
<li>
<p>I tried to specify, in comments, the behaviour of these instructions as<br>
  tightly as I could.  Unfortunately there is no way (per my limited CLIF<br>
  knowledge) to enforce the constraint that they may only be used on I8, I16,<br>
  I32 and I64 types, and in particular not on floating point or vector types.</p>
</li>
</ul>
<p>The translation from Wasm to CLIF, in <code>code_translator.rs</code> is unremarkable.</p>
<p>At the AArch64 level, there are also five new instructions, one for each<br>
group.  All of them except <code>::Fence</code> contain multiple real machine<br>
instructions.  Atomic r-m-w and atomic c-a-s are emitted as the usual<br>
load-linked store-conditional loops, guarded at both ends by memory fences.<br>
Atomic loads and stores are emitted as a load preceded by a fence, and a store<br>
followed by a fence, respectively.  The amount of fencing may be overkill, but<br>
it reflects exactly what the SM Wasm baseline compiler for AArch64 does.</p>
<p>One reason to implement r-m-w and c-a-s as a single insn which is expanded<br>
only at emission time is that we must be very careful what instructions we<br>
allow in between the load-linked and store-conditional.  In particular, we<br>
cannot allow <em>any</em> extra memory transactions in there, since -- particularly<br>
on low-end hardware -- that might cause the transaction to fail, hence<br>
deadlocking the generated code.  That implies that we can't present the LL/SC<br>
loop to the register allocator as its constituent instructions, since it might<br>
insert spills anywhere.  Hence we must present it as a single indivisible<br>
unit, as we do here.  It also has the benefit of reducing the total amount of<br>
work the RA has to do.</p>
<p>The only other notable feature of the r-m-w and c-a-s translations into<br>
AArch64 code, is that they both need a scratch register internally.  Rather<br>
than faking one up by claiming, in <code>get_regs</code> that it modifies an extra<br>
scratch register, and having to have a dummy initialisation of it, these new<br>
instructions (<code>::LLSC</code> and <code>::CAS</code>) simply use fixed registers in the range<br>
x24-x28.  We rely on the RA's ability to coalesce V&lt;--&gt;R copies to make the<br>
cost of the resulting extra copies zero or almost zero.  x24-x28 are chosen so<br>
as to be call-clobbered, hence their use is less likely to interfere with long<br>
live ranges that span calls.</p>
<p>One subtlety regarding the use of completely fixed input and output registers<br>
is that we must be careful how the surrounding copy from/to of the arg/result<br>
registers is done.  In particular, it is not safe to simply emit copies in<br>
some arbitrary order if one of the arg registers is a real reg.  For that<br>
reason, the arguments are first moved into virtual regs if they are not<br>
already there, using a new method <code>&lt;LowerCtx for Lower&gt;::ensure_in_vreg</code>.<br>
Again, we rely on coalescing to turn them into no-ops in the common case.</p>
<p>There is also a ridealong fix for the AArch64 lowering case for<br>
<code>Opcode::Trapif | Opcode::Trapff</code>, which removes a bug in which two trap insns<br>
in a row were generated.</p>
<p>In the patch as submitted there are 6 "FIXME JRS" comments, which mark things<br>
which I believe to be correct, but for which I would appreciate a second<br>
opinion.  Unless otherwise directed, I will remove them for the final commit<br>
but leave the associated code/comments unchanged.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="205796290"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205796290" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205796290">(Aug 03 2020 at 13:53)</a>:</h4>
<p><strong>julian-seward1</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/2077">PR #2077</a>.</p>



<a name="205820022"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205820022" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205820022">(Aug 03 2020 at 17:05)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#pullrequestreview-460190824">PR Review</a>.</p>



<a name="205820023"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205820023" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205820023">(Aug 03 2020 at 17:05)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r464541980">PR Review Comment</a>:</p>
<blockquote>
<p>Tiny nit, but this was very confusing to me for a moment; the difference between the CLIF's <code>AtomicRmwOp</code> and the aarch64 <code>Inst</code>'s <code>AtomicRMWOp</code> is just capitalization. Perhaps <code>use crate::ir</code> and then write <code>ir::AtomicRmwOp</code> here, for clarity?</p>
</blockquote>



<a name="205820024"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205820024" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205820024">(Aug 03 2020 at 17:05)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#pullrequestreview-460190824">PR Review</a>.</p>



<a name="205877620"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205877620" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205877620">(Aug 04 2020 at 06:42)</a>:</h4>
<p>julian-seward1 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2077">PR #2077</a> from <code>atomics-CL</code> to <code>main</code>:</p>
<blockquote>
<p>The implementation is pretty straightforward.  Wasm atomic instructions fall<br>
into 5 groups</p>
<ul>
<li>atomic read-modify-write</li>
<li>atomic compare-and-swap</li>
<li>atomic loads</li>
<li>atomic stores</li>
<li>fences</li>
</ul>
<p>and the implementation mirrors that structure, at both the CLIF and AArch64<br>
levels.</p>
<p>At the CLIF level, there are five new instructions, one for each group.  Some<br>
comments about these:</p>
<ul>
<li>
<p>for those that take addresses (all except fences), the address is contained<br>
  entirely in a single <code>Value</code>; there is no offset field as there is with<br>
  normal loads and stores.  Wasm atomics require alignment checks, and<br>
  removing the offset makes implementation of those checks a bit simpler.</p>
</li>
<li>
<p>atomic loads and stores get their own instructions, rather than reusing the<br>
  existing load and store instructions, for two reasons:</p>
<ul>
<li>
<p>per above comment, makes alignment checking simpler</p>
</li>
<li>
<p>reuse of existing loads and stores would require extension of <code>MemFlags</code><br>
  to indicate atomicity, which sounds semantically unclean.  For example,<br>
  then <em>any</em> instruction carrying <code>MemFlags</code> could be marked as atomic, even<br>
  in cases where it is meaningless or ambiguous.</p>
</li>
</ul>
</li>
<li>
<p>I tried to specify, in comments, the behaviour of these instructions as<br>
  tightly as I could.  Unfortunately there is no way (per my limited CLIF<br>
  knowledge) to enforce the constraint that they may only be used on I8, I16,<br>
  I32 and I64 types, and in particular not on floating point or vector types.</p>
</li>
</ul>
<p>The translation from Wasm to CLIF, in <code>code_translator.rs</code> is unremarkable.</p>
<p>At the AArch64 level, there are also five new instructions, one for each<br>
group.  All of them except <code>::Fence</code> contain multiple real machine<br>
instructions.  Atomic r-m-w and atomic c-a-s are emitted as the usual<br>
load-linked store-conditional loops, guarded at both ends by memory fences.<br>
Atomic loads and stores are emitted as a load preceded by a fence, and a store<br>
followed by a fence, respectively.  The amount of fencing may be overkill, but<br>
it reflects exactly what the SM Wasm baseline compiler for AArch64 does.</p>
<p>One reason to implement r-m-w and c-a-s as a single insn which is expanded<br>
only at emission time is that we must be very careful what instructions we<br>
allow in between the load-linked and store-conditional.  In particular, we<br>
cannot allow <em>any</em> extra memory transactions in there, since -- particularly<br>
on low-end hardware -- that might cause the transaction to fail, hence<br>
deadlocking the generated code.  That implies that we can't present the LL/SC<br>
loop to the register allocator as its constituent instructions, since it might<br>
insert spills anywhere.  Hence we must present it as a single indivisible<br>
unit, as we do here.  It also has the benefit of reducing the total amount of<br>
work the RA has to do.</p>
<p>The only other notable feature of the r-m-w and c-a-s translations into<br>
AArch64 code, is that they both need a scratch register internally.  Rather<br>
than faking one up by claiming, in <code>get_regs</code> that it modifies an extra<br>
scratch register, and having to have a dummy initialisation of it, these new<br>
instructions (<code>::LLSC</code> and <code>::CAS</code>) simply use fixed registers in the range<br>
x24-x28.  We rely on the RA's ability to coalesce V&lt;--&gt;R copies to make the<br>
cost of the resulting extra copies zero or almost zero.  x24-x28 are chosen so<br>
as to be call-clobbered, hence their use is less likely to interfere with long<br>
live ranges that span calls.</p>
<p>One subtlety regarding the use of completely fixed input and output registers<br>
is that we must be careful how the surrounding copy from/to of the arg/result<br>
registers is done.  In particular, it is not safe to simply emit copies in<br>
some arbitrary order if one of the arg registers is a real reg.  For that<br>
reason, the arguments are first moved into virtual regs if they are not<br>
already there, using a new method <code>&lt;LowerCtx for Lower&gt;::ensure_in_vreg</code>.<br>
Again, we rely on coalescing to turn them into no-ops in the common case.</p>
<p>There is also a ridealong fix for the AArch64 lowering case for<br>
<code>Opcode::Trapif | Opcode::Trapff</code>, which removes a bug in which two trap insns<br>
in a row were generated.</p>
<p>In the patch as submitted there are 6 "FIXME JRS" comments, which mark things<br>
which I believe to be correct, but for which I would appreciate a second<br>
opinion.  Unless otherwise directed, I will remove them for the final commit<br>
but leave the associated code/comments unchanged.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="205877641"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205877641" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205877641">(Aug 04 2020 at 06:43)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#pullrequestreview-460535584">PR Review</a>.</p>



<a name="205877642"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205877642" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205877642">(Aug 04 2020 at 06:43)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2077#discussion_r464833051">PR Review Comment</a>:</p>
<blockquote>
<p>Er, well spotted.  I didn't even notice.  Must have looked as if I'd simply written the identity function for atomic RMW ops :-)</p>
</blockquote>



<a name="205880062"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232077%20Implement%20Wasm%20Atomics%20for%20Cranelift/.../near/205880062" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232077.20Implement.20Wasm.20Atomics.20for.20Cranelift.2F.2E.2E.2E.html#205880062">(Aug 04 2020 at 07:35)</a>:</h4>
<p>julian-seward1 merged <a href="https://github.com/bytecodealliance/wasmtime/pull/2077">PR #2077</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>