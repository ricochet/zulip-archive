<html>
<head><meta charset="utf-8"><title>wasmtime / PR #2146 Enhance machinst x64 instruction sele... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html">wasmtime / PR #2146 Enhance machinst x64 instruction sele...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="207411645"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207411645" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207411645">(Aug 19 2020 at 14:02)</a>:</h4>
<p>bnjbvr opened <a href="https://github.com/bytecodealliance/wasmtime/pull/2146">PR #2146</a> from <code>x64-isel</code> to <code>main</code>:</p>
<blockquote>
<p>This implements a few instruction selection optimizations for x64:</p>
<ul>
<li>optimize select/brz/brnz when the input is a comparison, to avoid the materialization of the flag register. Float comparisons are a bit tricky because of Equal/NotEqual (and other float CC that don't convert to a single int CC), but the rest is pretty simple.</li>
<li>commuting operands of integer arithmetic commutative operations when one operand is an immediate, to avoid materializing the immediate</li>
<li>use more addressing modes for loads/stores. Unfortunately, impact is limited because of the way heap_addr is legalized (an uext64 of the 32-bit operator), preventing the use of e.g. the shift bits in the SIB amode, or folding integer immediates into the offset altogether. Range analysis could help with this...</li>
<li>fix the pinned register hack, which was not effectful; see commit message and patch. I'm not married to the longer name I've used for catching side-effectful instructions.</li>
</ul>
<p>On embenchen in Spidermonkey, this is between a 3 to 7% speedup in compilation time, and i see generated code runtime speedups up to 25%.</p>
</blockquote>



<a name="207411646"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207411646" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207411646">(Aug 19 2020 at 14:02)</a>:</h4>
<p><strong>bnjbvr</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/2146">PR #2146</a>.</p>



<a name="207476648"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207476648" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207476648">(Aug 20 2020 at 00:14)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#pullrequestreview-471024998">PR Review</a>.</p>



<a name="207476650"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207476650" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207476650">(Aug 20 2020 at 00:14)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#pullrequestreview-471024998">PR Review</a>.</p>



<a name="207476651"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207476651" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207476651">(Aug 20 2020 at 00:14)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r473422443">PR Review Comment</a>:</p>
<blockquote>
<p>Idle thought (not necessary for this PR): we should consolidate these tree-matching helpers among the backends (i.e. with aarch64) as we're doing for the ABI support; there's nothing machine-specific in the function below.</p>
</blockquote>



<a name="207476652"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207476652" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207476652">(Aug 20 2020 at 00:14)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r473420205">PR Review Comment</a>:</p>
<blockquote>
<p>I think I'd prefer to lift the <code>op != Opcode::GetPinnedReg</code> condition out of this helper and to its callsite; otherwise it's an oddly specific predicate to have as a general-purpose helper, IMHO.</p>
</blockquote>



<a name="207476653"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207476653" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207476653">(Aug 20 2020 at 00:14)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r473443242">PR Review Comment</a>:</p>
<blockquote>
<p><code>small_cst</code> =&gt; <code>small_constant</code> for clarity?</p>
</blockquote>



<a name="207476654"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207476654" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207476654">(Aug 20 2020 at 00:14)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r473442829">PR Review Comment</a>:</p>
<blockquote>
<p>code-style nit, but <code>match swap_operands { FcmpOperands::Swap =&gt; ..., FcmpOperands::DontSwap =&gt; ... }</code> would be a bit more idiomatic I think.</p>
</blockquote>



<a name="207476655"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207476655" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207476655">(Aug 20 2020 at 00:14)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r473424635">PR Review Comment</a>:</p>
<blockquote>
<p>This helper works but will call <code>ctx.get_input()</code> multiple times; could we factor this a bit more so that we pass one <code>LowerInput</code> around? Maybe <code>lowerinput_to_*()</code> and then wrap these with <code>input_to_*()</code>?</p>
</blockquote>



<a name="207476656"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207476656" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207476656">(Aug 20 2020 at 00:14)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r473444063">PR Review Comment</a>:</p>
<blockquote>
<p><code>match input_to_imm(...) { Some(shift_amt) if shift_amt &lt;= 3 =&gt; Some(...), _ =&gt; None }</code></p>
</blockquote>



<a name="207476657"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207476657" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207476657">(Aug 20 2020 at 00:14)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r473460155">PR Review Comment</a>:</p>
<blockquote>
<p>I'm not sure exactly what the right factoring is, but there seems to be a lot of duplication across all the points at which an fcmp / icmp is lowered. I think it'd be much better to centralize the common bits (e.g. the match on <code>FloatCC</code> below) into a helper.</p>
<p>At a high level, it seems what you want is, for any input that's a bool, "lower this somehow to the machine's condition flags and give me one or more conditions that indicate true". This would allow you to factor the input side (icmp or fcmp) and output side (csel for int or float, cond branch) into separate pieces.</p>
</blockquote>



<a name="207476658"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207476658" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207476658">(Aug 20 2020 at 00:14)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r473457099">PR Review Comment</a>:</p>
<blockquote>
<p>We should clarify an important rule/invariant here: hte target of the branch <em>must also be</em> a successor of the actual terminator (otherwise the CFG is incorrect, which would confuse the RA). Also perhaps we should note when this instruction might be used (sequence of multiple cond branches deriving form one comparison) and pointing to an example (fcmp lowering).</p>
</blockquote>



<a name="207476659"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207476659" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207476659">(Aug 20 2020 at 00:14)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r473462835">PR Review Comment</a>:</p>
<blockquote>
<p>Comment here for why the reg may not be virtual: we may directly return a machine register when we know that register holds the result of an opcode (by definition).</p>
</blockquote>



<a name="207476660"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207476660" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207476660">(Aug 20 2020 at 00:14)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r473461351">PR Review Comment</a>:</p>
<blockquote>
<p>Why only <code>size == 1</code>? Actually, I'm not sure I understand the need for any sort of extension: surely the output of a select, having the same type as the inputs, has the same property of "upper bits don't matter"? So we can always do a full-register cmove, no matter the type of value held by the register.</p>
</blockquote>



<a name="207538301"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207538301" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207538301">(Aug 20 2020 at 15:48)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#pullrequestreview-471752941">PR Review</a>.</p>



<a name="207538302"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207538302" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207538302">(Aug 20 2020 at 15:49)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r474088039">PR Review Comment</a>:</p>
<blockquote>
<p>I'm ok to do this, but since the helper is unused in other contexts that don't want to check for get_pinned_reg, this would be over-generalizing the helper without any clear benefits. Should we instead move this helper to the <code>machinst</code> directory, and rename it <code>has_lowering_side_effect</code> or something like this instead?</p>
</blockquote>



<a name="207539130"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207539130" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207539130">(Aug 20 2020 at 15:55)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#pullrequestreview-471758890">PR Review</a>.</p>



<a name="207539131"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207539131" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207539131">(Aug 20 2020 at 15:55)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r474092510">PR Review Comment</a>:</p>
<blockquote>
<p>Yeah, I've thought about this and realized that such an helper would have to return a condition code, or a conjunction (AND, for Equal), or disjunction (OR, for NotEqual) of those. And then, if you look at select, we can't handle properly the result for <code>Equal</code>, so we'd have to use something else. This is one of these cases where the code duplication seemed better than having overly complicated helpers that would have to shoehorn many edge cases. I'll try something...</p>
</blockquote>



<a name="207539374"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207539374" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207539374">(Aug 20 2020 at 15:57)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#pullrequestreview-471760502">PR Review</a>.</p>



<a name="207539375"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207539375" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207539375">(Aug 20 2020 at 15:57)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r474093715">PR Review Comment</a>:</p>
<blockquote>
<p>Because cmove can handle 16, 32 and 64-bits operands, but no 8-bits operands. But you're probably right about upper bits not mattering here.</p>
</blockquote>



<a name="207558899"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207558899" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207558899">(Aug 20 2020 at 18:43)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#pullrequestreview-471887531">PR Review</a>.</p>



<a name="207558900"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207558900" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207558900">(Aug 20 2020 at 18:43)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r474196345">PR Review Comment</a>:</p>
<blockquote>
<p>Hmm, yeah, that sounds fine. I think the thing that stuck out the most to me was the the function name essentially had the same complexity as its body :-) "Lowering side effect" is much better.</p>
</blockquote>



<a name="207559205"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207559205" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207559205">(Aug 20 2020 at 18:46)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#pullrequestreview-471889243">PR Review</a>.</p>



<a name="207559206"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207559206" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207559206">(Aug 20 2020 at 18:46)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r474197730">PR Review Comment</a>:</p>
<blockquote>
<p>Hmm, you would definitely have a better handle on this than I would -- it just seemed to want some factoring somewhere. I'm OK with landing this bit as-is, for what it's worth, if nothing easy occurs to us; we can always come back and refactor later.</p>
</blockquote>



<a name="207559348"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207559348" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207559348">(Aug 20 2020 at 18:47)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#pullrequestreview-471890114">PR Review</a>.</p>



<a name="207559349"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207559349" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207559349">(Aug 20 2020 at 18:47)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r474198406">PR Review Comment</a>:</p>
<blockquote>
<p>You can pretend that it is a 32bit int, as all bits above the size of the value are undefined, right? Also doing 32bit cmov for 16bit ints would safe a prefix byte.</p>
</blockquote>



<a name="207601659"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207601659" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207601659">(Aug 21 2020 at 05:28)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#pullrequestreview-472153296">PR Review</a>.</p>



<a name="207601660"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207601660" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207601660">(Aug 21 2020 at 05:28)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r474416297">PR Review Comment</a>:</p>
<blockquote>
<p>+1 for Chris' initial comment (produce a sequence of insns, the last one of which sets the condition codes somehow, and return the required test (Z, NZ, C, NB, etc) as the result of the lowering.  However you refactor this, it might be helpful to have a design that makes it easy to take advantage of the fact that most integer insns set the condition codes, at least the Z and S flags, in some useful way.  So for example then you could do the transformations</p>
<ul>
<li><code>(x ^ y) == 0</code>   --&gt;   <code>xor %x, %y ; jz ..</code></li>
<li><code>(x &lt;&lt; 1) != 0</code>  --&gt;  <code>shl $1, %x ; jnz ..</code></li>
<li><code>(x + y) &lt; 0</code>  --&gt;  <code>add %x, %y ; js ..</code> [because S is the top bit of the result]</li>
<li><code>(x &amp; $0b1001) != 0</code>  --&gt;  <code>tst $9, %x ; jnz ..</code> [important for efficient bitfield tests]</li>
</ul>
<p>GCC and LLVM both do this kind of trickery, nowadays quite extensively.</p>
<p>That would seem to be easy(er) if the only thing the helper returns is the final condition code -- in particular, that the helper doesn't assume that the next instruction will be a <code>cmp</code>.  Also [maybe obvious] once you have such a helper, you can use it also to generate the insns + test for a CLIF conditional move (select?) and simply emit a <code>cmov&lt;test&gt;</code> rather than <code>j&lt;test&gt;</code>.</p>
<p>Maybe having different helpers for conditions derived from FP and non-FP inputs might be clearer?  The set of tricks you can do in the integer-input case seems quite different from the FP-input case.</p>
</blockquote>



<a name="207601666"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207601666" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207601666">(Aug 21 2020 at 05:29)</a>:</h4>
<p>julian-seward1 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r474416297">PR Review Comment</a>.</p>



<a name="207601711"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207601711" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207601711">(Aug 21 2020 at 05:30)</a>:</h4>
<p>julian-seward1 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r474416297">PR Review Comment</a>.</p>



<a name="207602240"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207602240" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207602240">(Aug 21 2020 at 05:46)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#pullrequestreview-472158740">PR Review</a>.</p>



<a name="207602241"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207602241" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207602241">(Aug 21 2020 at 05:46)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r474421054">PR Review Comment</a>:</p>
<blockquote>
<p>Not to mention it would avoid a potential partial register use stall.  Basically 16-bit integer insns of any kind are bad.  +1 for @bjorn3's proposal of doing the cmov at 32 bits even for the 8- and 16-bit sizes.</p>
</blockquote>



<a name="207602391"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207602391" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207602391">(Aug 21 2020 at 05:51)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#pullrequestreview-472160389">PR Review</a>.</p>



<a name="207602392"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207602392" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207602392">(Aug 21 2020 at 05:51)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r474422485">PR Review Comment</a>:</p>
<blockquote>
<p>Clearer might be <code>lower_to_amode</code> ?</p>
</blockquote>



<a name="207602701"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207602701" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207602701">(Aug 21 2020 at 05:59)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#pullrequestreview-472163092">PR Review</a>.</p>



<a name="207602702"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207602702" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207602702">(Aug 21 2020 at 05:59)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r474424710">PR Review Comment</a>:</p>
<blockquote>
<p>All of the above assuming of course that neither operand is in memory.  If that is the case then we'd have to do it at the specified size else risk having unexpected traps at page boundaries.</p>
</blockquote>



<a name="207603687"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207603687" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207603687">(Aug 21 2020 at 06:26)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#pullrequestreview-472194342">PR Review</a>.</p>



<a name="207603688"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207603688" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207603688">(Aug 21 2020 at 06:26)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#pullrequestreview-472194342">PR Review</a>.</p>



<a name="207603689"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207603689" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207603689">(Aug 21 2020 at 06:26)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r474432320">PR Review Comment</a>:</p>
<blockquote>
<p>Maybe also add the expected index of the return param used for <code>input</code>?</p>
</blockquote>



<a name="207614499"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207614499" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207614499">(Aug 21 2020 at 09:27)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#pullrequestreview-472341841">PR Review</a>.</p>



<a name="207614500"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207614500" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207614500">(Aug 21 2020 at 09:27)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r474573165">PR Review Comment</a>:</p>
<blockquote>
<p>Good idea, added to todo list.</p>
</blockquote>



<a name="207616381"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207616381" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207616381">(Aug 21 2020 at 09:51)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#pullrequestreview-472357995">PR Review</a>.</p>



<a name="207616382"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207616382" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207616382">(Aug 21 2020 at 09:51)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r474595004">PR Review Comment</a>:</p>
<blockquote>
<p>Good point, added a note!</p>
</blockquote>



<a name="207616507"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207616507" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207616507">(Aug 21 2020 at 09:52)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#pullrequestreview-472359020">PR Review</a>.</p>



<a name="207616508"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207616508" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207616508">(Aug 21 2020 at 09:52)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r474596421">PR Review Comment</a>:</p>
<blockquote>
<p>I'm not sure what do you mean by this?</p>
</blockquote>



<a name="207619802"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207619802" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207619802">(Aug 21 2020 at 10:30)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#pullrequestreview-472382713">PR Review</a>.</p>



<a name="207619803"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207619803" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207619803">(Aug 21 2020 at 10:30)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r474614865">PR Review Comment</a>:</p>
<blockquote>
<p>You are currently ignoring the return param index part of <code>inputs.inst</code>. It would be better to check it against a value given by the caller and return <code>None</code> if they don't match.</p>
</blockquote>



<a name="207620438"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207620438" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207620438">(Aug 21 2020 at 10:40)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#pullrequestreview-472387733">PR Review</a>.</p>



<a name="207620439"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207620439" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207620439">(Aug 21 2020 at 10:40)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r474618828">PR Review Comment</a>:</p>
<blockquote>
<p>Ah, great point; the aarch64 backend suffers from the same issue. I'll fix it when refactoring helpers.</p>
</blockquote>



<a name="207620452"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207620452" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207620452">(Aug 21 2020 at 10:40)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#pullrequestreview-472387925">PR Review</a>.</p>



<a name="207620453"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207620453" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207620453">(Aug 21 2020 at 10:40)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r474618989">PR Review Comment</a>:</p>
<blockquote>
<p>Nice, it reduces the amount of code even for regular select.</p>
</blockquote>



<a name="207635010"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207635010" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207635010">(Aug 21 2020 at 13:41)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#pullrequestreview-472498471">PR Review</a>.</p>



<a name="207635012"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207635012" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207635012">(Aug 21 2020 at 13:41)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r474704920">PR Review Comment</a>:</p>
<blockquote>
<p>Actually, there might be a bug somewhere else, because i'm seeing a <code>Icmpif</code> with two results, and this seems to cause failures. I wonder if sometimes a result is replaced and the result index isn't getting updated correctly. Saving this for another yak shaving episode.</p>
</blockquote>



<a name="207637020"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207637020" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207637020">(Aug 21 2020 at 13:59)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#pullrequestreview-472512877">PR Review</a>.</p>



<a name="207637022"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207637022" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207637022">(Aug 21 2020 at 13:59)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#discussion_r474715674">PR Review Comment</a>:</p>
<blockquote>
<p>Found a way to factor this out that's not too terrible, and also implemented it correctly for <code>Trapff</code> lowering (probably not tested through Spidermonkey). Thanks for insisting on this!</p>
</blockquote>



<a name="207637037"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207637037" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207637037">(Aug 21 2020 at 13:59)</a>:</h4>
<p>bnjbvr updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2146">PR #2146</a> from <code>x64-isel</code> to <code>main</code>:</p>
<blockquote>
<p>This implements a few instruction selection optimizations for x64:</p>
<ul>
<li>optimize select/brz/brnz when the input is a comparison, to avoid the materialization of the flag register. Float comparisons are a bit tricky because of Equal/NotEqual (and other float CC that don't convert to a single int CC), but the rest is pretty simple.</li>
<li>commuting operands of integer arithmetic commutative operations when one operand is an immediate, to avoid materializing the immediate</li>
<li>use more addressing modes for loads/stores. Unfortunately, impact is limited because of the way heap_addr is legalized (an uext64 of the 32-bit operator), preventing the use of e.g. the shift bits in the SIB amode, or folding integer immediates into the offset altogether. Range analysis could help with this...</li>
<li>fix the pinned register hack, which was not effectful; see commit message and patch. I'm not married to the longer name I've used for catching side-effectful instructions.</li>
</ul>
<p>On embenchen in Spidermonkey, this is between a 3 to 7% speedup in compilation time, and i see generated code runtime speedups up to 25%.</p>
</blockquote>



<a name="207637463"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207637463" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207637463">(Aug 21 2020 at 14:02)</a>:</h4>
<p><strong>bnjbvr</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/2146">PR #2146</a>.</p>



<a name="207653633"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207653633" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207653633">(Aug 21 2020 at 16:17)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2146#pullrequestreview-472621769">PR Review</a>.</p>



<a name="207848789"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207848789" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207848789">(Aug 24 2020 at 14:21)</a>:</h4>
<p>bnjbvr updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2146">PR #2146</a> from <code>x64-isel</code> to <code>main</code>:</p>
<blockquote>
<p>This implements a few instruction selection optimizations for x64:</p>
<ul>
<li>optimize select/brz/brnz when the input is a comparison, to avoid the materialization of the flag register. Float comparisons are a bit tricky because of Equal/NotEqual (and other float CC that don't convert to a single int CC), but the rest is pretty simple.</li>
<li>commuting operands of integer arithmetic commutative operations when one operand is an immediate, to avoid materializing the immediate</li>
<li>use more addressing modes for loads/stores. Unfortunately, impact is limited because of the way heap_addr is legalized (an uext64 of the 32-bit operator), preventing the use of e.g. the shift bits in the SIB amode, or folding integer immediates into the offset altogether. Range analysis could help with this...</li>
<li>fix the pinned register hack, which was not effectful; see commit message and patch. I'm not married to the longer name I've used for catching side-effectful instructions.</li>
</ul>
<p>On embenchen in Spidermonkey, this is between a 3 to 7% speedup in compilation time, and i see generated code runtime speedups up to 25%.</p>
</blockquote>



<a name="207848817"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207848817" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207848817">(Aug 24 2020 at 14:21)</a>:</h4>
<p>bnjbvr updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2146">PR #2146</a> from <code>x64-isel</code> to <code>main</code>:</p>
<blockquote>
<p>This implements a few instruction selection optimizations for x64:</p>
<ul>
<li>optimize select/brz/brnz when the input is a comparison, to avoid the materialization of the flag register. Float comparisons are a bit tricky because of Equal/NotEqual (and other float CC that don't convert to a single int CC), but the rest is pretty simple.</li>
<li>commuting operands of integer arithmetic commutative operations when one operand is an immediate, to avoid materializing the immediate</li>
<li>use more addressing modes for loads/stores. Unfortunately, impact is limited because of the way heap_addr is legalized (an uext64 of the 32-bit operator), preventing the use of e.g. the shift bits in the SIB amode, or folding integer immediates into the offset altogether. Range analysis could help with this...</li>
<li>fix the pinned register hack, which was not effectful; see commit message and patch. I'm not married to the longer name I've used for catching side-effectful instructions.</li>
</ul>
<p>On embenchen in Spidermonkey, this is between a 3 to 7% speedup in compilation time, and i see generated code runtime speedups up to 25%.</p>
</blockquote>



<a name="207853829"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232146%20Enhance%20machinst%20x64%20instruction%20sele.../near/207853829" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232146.20Enhance.20machinst.20x64.20instruction.20sele.2E.2E.2E.html#207853829">(Aug 24 2020 at 15:00)</a>:</h4>
<p>bnjbvr merged <a href="https://github.com/bytecodealliance/wasmtime/pull/2146">PR #2146</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>