<html>
<head><meta charset="utf-8"><title>wasmtime / issue #5986 x64: Add lea-based lowering for iadd · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235986.20x64.3A.20Add.20lea-based.20lowering.20for.20iadd.html">wasmtime / issue #5986 x64: Add lea-based lowering for iadd</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="340967200"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235986%20x64%3A%20Add%20lea-based%20lowering%20for%20iadd/near/340967200" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235986.20x64.3A.20Add.20lea-based.20lowering.20for.20iadd.html#340967200">(Mar 10 2023 at 21:23)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/5986#issuecomment-1464492192">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5986">issue #5986</a>:</p>
<blockquote>
<p>Oh I should also mention that on the <code>meshoptimizer</code> program this improves performance by 5% for me on one of the benchmarks.</p>
</blockquote>



<a name="340970301"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235986%20x64%3A%20Add%20lea-based%20lowering%20for%20iadd/near/340970301" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235986.20x64.3A.20Add.20lea-based.20lowering.20for.20iadd.html#340970301">(Mar 10 2023 at 21:45)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/5986#issuecomment-1464510980">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5986">issue #5986</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @cfallin, @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "cranelift:area:x64", "isle"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>cfallin: isle</li>
<li>fitzgen: isle</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="341475264"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235986%20x64%3A%20Add%20lea-based%20lowering%20for%20iadd/near/341475264" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235986.20x64.3A.20Add.20lea-based.20lowering.20for.20iadd.html#341475264">(Mar 13 2023 at 14:21)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/5986#issuecomment-1466235523">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5986">issue #5986</a>:</p>
<blockquote>
<p>Before I merge this one thing I'd like to explore is to try a strategy of "always use <code>lea</code>" but then during emission switch to using <code>add</code> if the src/dst registers are the same. Something like an <code>AddOrLea</code> instruction which, depending on the results of regalloc, emits one of the two instructions. I'm interested to compare that to this performance and it more easily leaves this open in the future to a tweak in regalloc's constraints where something could be specified like "please try to make these two the same"</p>
</blockquote>



<a name="341943957"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235986%20x64%3A%20Add%20lea-based%20lowering%20for%20iadd/near/341943957" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235986.20x64.3A.20Add.20lea-based.20lowering.20for.20iadd.html#341943957">(Mar 15 2023 at 02:10)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/5986#issuecomment-1469189438">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5986">issue #5986</a>:</p>
<blockquote>
<p>Ok I've pushed up a different way of doing this, namely deciding after regalloc whether to use <code>add</code> or <code>lea</code>. The local <code>meshoptimizer</code> benchmark shows no loss on the number that went down if <code>lea</code> is always used, and the number that went up due to using <code>lea</code> still went up. Sightglass locally says:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>
<span class="w">  </span><span class="n">lea</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.05</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.06</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>
<span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>
<span class="w">  </span><span class="n">lea</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.02</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.03</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>
<span class="n">ution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>
<span class="w">  </span><span class="n">lea</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.01</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.02</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>
<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>
<span class="w">  </span><span class="n">lea</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.00</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.01</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>
</code></pre></div>
<p>with all others as "no difference"</p>
<p>Given that I'm tempted to go with this strategy instead and leave it open to, in the future, add a form of regalloc constraint or heuristic that attempts to keep the src/dst here in the same register.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>