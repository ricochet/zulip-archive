<html>
<head><meta charset="utf-8"><title>wasmtime / PR #7220 threads: log every `wait` and `notify` · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237220.20threads.3A.20log.20every.20.60wait.60.20and.20.60notify.60.html">wasmtime / PR #7220 threads: log every `wait` and `notify`</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="396147290"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237220%20threads%3A%20log%20every%20%60wait%60%20and%20%60notify%60/near/396147290" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237220.20threads.3A.20log.20every.20.60wait.60.20and.20.60notify.60.html#396147290">(Oct 11 2023 at 18:46)</a>:</h4>
<p>abrown opened <a href="https://github.com/bytecodealliance/wasmtime/pull/7220">PR #7220</a> from <code>abrown:log-wait-notify</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>When troubleshooting deadlocks in WebAssembly modules, it is important to understand which <code>wait</code> instructions are still pending a <code>notify</code>. It would be nice to have some kind of <code>--warn-deadlock-after=1s</code> flag available that would poll the parking lot for <code>wait</code>s hanging past the time limit, but I realized the real value would be to tie the <code>wait</code> instruction (through CLIF) to the original source code, if debug information were available. This did not seem to be entirely feasible, since CLIF loses the original Wasm source context (is this true?) and I was not confident that we would be able to use <code>addr2line</code> to map from Wasm instructions to source (e.g., see @cfallin's<br>
<a href="https://github.com/gimli-rs/addr2line/issues/265">issue</a>).</p>
<p>Instead, this change simply logs each valid <code>wait</code> and <code>notify</code> execution, leaving it to the user to figure out which one is hanging (should not be too difficult) and how to map this back to their source code (more difficult).</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="396147352"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237220%20threads%3A%20log%20every%20%60wait%60%20and%20%60notify%60/near/396147352" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237220.20threads.3A.20log.20every.20.60wait.60.20and.20.60notify.60.html#396147352">(Oct 11 2023 at 18:47)</a>:</h4>
<p>abrown edited <a href="https://github.com/bytecodealliance/wasmtime/pull/7220">PR #7220</a>:</p>
<blockquote>
<p>When troubleshooting deadlocks in WebAssembly modules, it is important to understand which <code>wait</code> instructions are still pending a <code>notify</code>. It would be nice to have some kind of <code>--warn-deadlock-after=1s</code> flag available that would poll the parking lot for <code>wait</code>s hanging past the time limit, but I realized the real value would be to tie the <code>wait</code> instruction (through CLIF) to the original source code, if debug information were available. This did not seem to be entirely feasible, since CLIF loses the original Wasm source context (is this true?) and I was not confident that we would be able to use <code>addr2line</code> to map from Wasm instructions to source (e.g., see @cfallin's <a href="https://github.com/gimli-rs/addr2line/issues/265">issue</a>).</p>
<p>Instead, this change simply logs each valid <code>wait</code> and <code>notify</code> execution, leaving it to the user to figure out which one is hanging (should not be too difficult) and how to map this back to their source code (more difficult).</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="396147390"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237220%20threads%3A%20log%20every%20%60wait%60%20and%20%60notify%60/near/396147390" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237220.20threads.3A.20log.20every.20.60wait.60.20and.20.60notify.60.html#396147390">(Oct 11 2023 at 18:47)</a>:</h4>
<p><strong>abrown</strong> has marked <a href="https://github.com/bytecodealliance/wasmtime/pull/7220">PR #7220</a> as ready for review.</p>



<a name="396147394"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237220%20threads%3A%20log%20every%20%60wait%60%20and%20%60notify%60/near/396147394" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237220.20threads.3A.20log.20every.20.60wait.60.20and.20.60notify.60.html#396147394">(Oct 11 2023 at 18:47)</a>:</h4>
<p><strong>abrown</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7220">PR #7220</a>.</p>



<a name="396147397"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237220%20threads%3A%20log%20every%20%60wait%60%20and%20%60notify%60/near/396147397" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237220.20threads.3A.20log.20every.20.60wait.60.20and.20.60notify.60.html#396147397">(Oct 11 2023 at 18:47)</a>:</h4>
<p><strong>abrown</strong> requested <a href="https://github.com/pchickey">pchickey</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7220">PR #7220</a>.</p>



<a name="396149027"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237220%20threads%3A%20log%20every%20%60wait%60%20and%20%60notify%60/near/396149027" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237220.20threads.3A.20log.20every.20.60wait.60.20and.20.60notify.60.html#396149027">(Oct 11 2023 at 18:58)</a>:</h4>
<p>pchickey submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7220#pullrequestreview-1672294075">PR review</a>:</p>
<blockquote>
<p>lgtm, modulo a style change across all of these traces</p>
</blockquote>



<a name="396149028"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237220%20threads%3A%20log%20every%20%60wait%60%20and%20%60notify%60/near/396149028" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237220.20threads.3A.20log.20every.20.60wait.60.20and.20.60notify.60.html#396149028">(Oct 11 2023 at 18:58)</a>:</h4>
<p>pchickey submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7220#pullrequestreview-1672294075">PR review</a>:</p>
<blockquote>
<p>lgtm, modulo a style change across all of these traces</p>
</blockquote>



<a name="396149029"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237220%20threads%3A%20log%20every%20%60wait%60%20and%20%60notify%60/near/396149029" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237220.20threads.3A.20log.20every.20.60wait.60.20and.20.60notify.60.html#396149029">(Oct 11 2023 at 18:58)</a>:</h4>
<p>pchickey created <a href="https://github.com/bytecodealliance/wasmtime/pull/7220#discussion_r1355614875">PR review comment</a>:</p>
<blockquote>
<p>instead of using the format string, use <code>log::trace!("memory.atomic.notify", addr=addr_index, count=count);</code> to provide structured values.</p>
</blockquote>



<a name="396170588"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237220%20threads%3A%20log%20every%20%60wait%60%20and%20%60notify%60/near/396170588" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237220.20threads.3A.20log.20every.20.60wait.60.20and.20.60notify.60.html#396170588">(Oct 11 2023 at 21:59)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7220#pullrequestreview-1672663490">PR review</a>.</p>



<a name="396170590"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237220%20threads%3A%20log%20every%20%60wait%60%20and%20%60notify%60/near/396170590" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237220.20threads.3A.20log.20every.20.60wait.60.20and.20.60notify.60.html#396170590">(Oct 11 2023 at 21:59)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/7220#discussion_r1355825934">PR review comment</a>:</p>
<blockquote>
<p>I tried that but it complains: I think to use the key-value syntax we need to set <code>target: ...,</code> up front and still provide a string at the end (see <a href="https://docs.rs/log/latest/log/macro.log.html"><code>log::log!</code></a>)?</p>
</blockquote>



<a name="396173849"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237220%20threads%3A%20log%20every%20%60wait%60%20and%20%60notify%60/near/396173849" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237220.20threads.3A.20log.20every.20.60wait.60.20and.20.60notify.60.html#396173849">(Oct 11 2023 at 22:28)</a>:</h4>
<p>pchickey submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7220#pullrequestreview-1672689744">PR review</a>.</p>



<a name="396173850"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237220%20threads%3A%20log%20every%20%60wait%60%20and%20%60notify%60/near/396173850" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237220.20threads.3A.20log.20every.20.60wait.60.20and.20.60notify.60.html#396173850">(Oct 11 2023 at 22:28)</a>:</h4>
<p>pchickey created <a href="https://github.com/bytecodealliance/wasmtime/pull/7220#discussion_r1355844192">PR review comment</a>:</p>
<blockquote>
<p>oh, my bad. I just realized this is <code>log</code> and the key value syntax only works with the <code>tracing</code> crate, and I forgot we use <code>log</code> in wasmtime-runtime in order to keep the dependencies as small as possible, but <code>tracing</code> in wasmtime-wit-bindgen, wasi, etc.</p>
<p>So, your PR is good to go as is. I don't think we need should using <code>log</code> vs <code>tracing</code> down in the runtime now, unless someone really wants to.</p>
</blockquote>



<a name="396173875"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237220%20threads%3A%20log%20every%20%60wait%60%20and%20%60notify%60/near/396173875" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237220.20threads.3A.20log.20every.20.60wait.60.20and.20.60notify.60.html#396173875">(Oct 11 2023 at 22:28)</a>:</h4>
<p>pchickey submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7220#pullrequestreview-1672689951">PR review</a>.</p>



<a name="396178568"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237220%20threads%3A%20log%20every%20%60wait%60%20and%20%60notify%60/near/396178568" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237220.20threads.3A.20log.20every.20.60wait.60.20and.20.60notify.60.html#396178568">(Oct 11 2023 at 23:24)</a>:</h4>
<p>abrown merged <a href="https://github.com/bytecodealliance/wasmtime/pull/7220">PR #7220</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>