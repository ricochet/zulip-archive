<html>
<head><meta charset="utf-8"><title>wasmtime / issue #6804 Cranelift: avoid quadratic behavio... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236804.20Cranelift.3A.20avoid.20quadratic.20behavio.2E.2E.2E.html">wasmtime / issue #6804 Cranelift: avoid quadratic behavio...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="382142467"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236804%20Cranelift%3A%20avoid%20quadratic%20behavio.../near/382142467" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236804.20Cranelift.3A.20avoid.20quadratic.20behavio.2E.2E.2E.html#382142467">(Aug 05 2023 at 13:19)</a>:</h4>
<p>TimonPost <a href="https://github.com/bytecodealliance/wasmtime/pull/6804#issuecomment-1666504662">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6804">issue #6804</a>:</p>
<blockquote>
<p>I ran your branch 3 times on the large module I experienced issus on. </p>
<p>x86_64: 11.5228035s, 11.0294104s, 11.2740543s<br>
aarch64: 12.8739ms, 17.9411ms, 14.3515ms</p>
<p>Where on main it is was:</p>
<p>x86_64: 13.9465882s, 11.2770526s, 11.0808334s<br>
aarch64: 157.5406149s, 144.1816011s, 144.1495896s</p>
<p>Seems like a very big improvement!</p>
</blockquote>



<a name="382148979"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236804%20Cranelift%3A%20avoid%20quadratic%20behavio.../near/382148979" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236804.20Cranelift.3A.20avoid.20quadratic.20behavio.2E.2E.2E.html#382148979">(Aug 05 2023 at 13:46)</a>:</h4>
<p>TimonPost edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/6804#issuecomment-1666504662">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6804">issue #6804</a>:</p>
<blockquote>
<p>I used your branch to compile a large module of ~115Mb, 3 times.</p>
<p>x86_64: 11.5228035s, 11.0294104s, 11.2740543s<br>
aarch64: 12.8739ms, 17.9411ms, 14.3515ms</p>
<p>Where on main it is was:</p>
<p>x86_64: 13.9465882s, 11.2770526s, 11.0808334s<br>
aarch64: 157.5406149s, 144.1816011s, 144.1495896s</p>
<p>Seems like a very big improvement!</p>
</blockquote>



<a name="382200492"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236804%20Cranelift%3A%20avoid%20quadratic%20behavio.../near/382200492" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236804.20Cranelift.3A.20avoid.20quadratic.20behavio.2E.2E.2E.html#382200492">(Aug 05 2023 at 17:49)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/6804#issuecomment-1666564099">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6804">issue #6804</a>:</p>
<blockquote>
<p>@TimonPost </p>
<blockquote>
<p>x86_64: 11.5228035s, 11.0294104s, 11.2740543s<br>
aarch64: 12.8739ms, 17.9411ms, 14.3515ms</p>
</blockquote>
<p>Thanks for testing this! Would you be able to share a performance profile of the x86_64 compilation? Having a 100x slowdown for x86_64 is pretty surprising and may mean that there's lurking quadratic behavior there too worth looking into.</p>
</blockquote>



<a name="382207026"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236804%20Cranelift%3A%20avoid%20quadratic%20behavio.../near/382207026" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236804.20Cranelift.3A.20avoid.20quadratic.20behavio.2E.2E.2E.html#382207026">(Aug 05 2023 at 18:30)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/6804#issuecomment-1666576285">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6804">issue #6804</a>:</p>
<blockquote>
<p>Given the other numbers, I suspect maybe the units were meant to be seconds rather than milliseconds on that line?</p>
</blockquote>



<a name="382208564"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236804%20Cranelift%3A%20avoid%20quadratic%20behavio.../near/382208564" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236804.20Cranelift.3A.20avoid.20quadratic.20behavio.2E.2E.2E.html#382208564">(Aug 05 2023 at 18:42)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/6804#issuecomment-1666578322">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6804">issue #6804</a>:</p>
<blockquote>
<blockquote>
<p>The quadratic-ness isn't necessarily inherent because <a href="https://github.com/bytecodealliance/wasmtime/issues/6798#issuecomment-1665539868">https://github.com/bytecodealliance/wasmtime/issues/6798#issuecomment-1665539868</a> by representing fixup_records with a BinaryHeap it's possible to restore local reasoning about branches without quadratic behavior. That solution isn't viable, however, with the branch optimizations happening in the buffer.</p>
</blockquote>
<p>Yeah, unfortunately the branch opts have to happen in the buffer -- that's important for compile-time performance and lifting them elsewhere would be a large complexity shift (on the order of months of work) in the remainder of the backend because of the lower-level branch forms. (As an example, @elliottt worked to remove the last vestiges of EBBs and make branches truly two-target in CLIF as well, and that was something like a few weeks of delicate full-time work with a few followup issues.) We've been there before, we learned!</p>
<p>That said, I don't know if I buy that the two issues are coupled to this degree. MachBuffer does both things -- branch folding and label fixups -- and the former has an invariant that any branches in the "most recent branches contiguous with end of buffer" list will have fixups -- but the invariant needs nothing (is vacuously true) if the recent-branches list is <em>empty</em>, and it is always empty after emitting an island. So I think one could do whatever one wants with a binary-heap or whatnot, leveraging that.</p>
<p>However, there's also a complexity tradeoff here: I worry very much about bugs in this code (see the series of issues three summers ago that resulted in me writing the correctness proof in the comments) and I'd rather keep it using uniformly simple data structures where we can. "Nonlocal reasoning" sounds undesirable but that's blurring a bit what's going on here: basically we now have islands that cause every forward-crossing edge to go through a veneer. There are plenty of other ways that changes in some code can push some other code toward a different decision (regalloc, block ordering, side-effects blocking hoisting, ...) and we don't really worry about those nonlocal effects, or at least we accept them as normal.</p>
<p>Anyway, I'll update on Monday based on your comments -- thanks very much for the review!</p>
</blockquote>



<a name="382339103"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236804%20Cranelift%3A%20avoid%20quadratic%20behavio.../near/382339103" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236804.20Cranelift.3A.20avoid.20quadratic.20behavio.2E.2E.2E.html#382339103">(Aug 06 2023 at 11:40)</a>:</h4>
<p>TimonPost <a href="https://github.com/bytecodealliance/wasmtime/pull/6804#issuecomment-1666828380">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6804">issue #6804</a>:</p>
<blockquote>
<p>Sorry, I made an error, my script errored for aarch64 with 'target not supported', used the wrong feature flag to compile wasmtime. I re-ran the script:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">SANDBOX_PATH</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="nb">static</span> <span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="s">"src/sandbox.wasm"</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">times</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">std</span>::<span class="n">time</span>::<span class="n">Duration</span><span class="p">,</span><span class="n">RandomState</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HashMap</span>::<span class="n">default</span><span class="p">();</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">arch</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="s">"x86_64"</span><span class="p">,</span><span class="w"> </span><span class="s">"aarch64"</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instant</span>::<span class="n">now</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Command</span>::<span class="n">new</span><span class="p">(</span><span class="s">"wasmtime"</span><span class="p">);</span>
<span class="w">        </span><span class="n">command</span><span class="p">.</span><span class="n">arg</span><span class="p">(</span><span class="s">"compile"</span><span class="p">).</span><span class="n">arg</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span><span class="s">"--target={os}"</span><span class="p">)).</span><span class="n">arg</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span><span class="s">"-o=output-{os}.wasm"</span><span class="p">)).</span><span class="n">arg</span><span class="p">(</span>
<span class="w">            </span><span class="n">SANDBOX_PATH</span><span class="p">,</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Start compiling on {}"</span><span class="p">,</span><span class="w"> </span><span class="n">arch</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">command</span><span class="p">.</span><span class="n">spawn</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">child</span><span class="p">.</span><span class="n">wait_with_output</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="n">times</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span><span class="s">"sandbox-{}"</span><span class="p">,</span><span class="w"> </span><span class="n">arch</span><span class="p">),</span><span class="w"> </span><span class="n">start</span><span class="p">.</span><span class="n">elapsed</span><span class="p">());</span>

<span class="w">        </span><span class="fm">println!</span><span class="p">(</span>
<span class="w">            </span><span class="s">"[{:?}]: {os} ({})"</span><span class="p">,</span>
<span class="w">            </span><span class="n">start</span><span class="p">.</span><span class="n">elapsed</span><span class="p">(),</span>
<span class="w">            </span><span class="nb">String</span>::<span class="n">from_utf8</span><span class="p">(</span><span class="n">output</span><span class="p">.</span><span class="n">stdout</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Running three times:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">x86_64</span>: <span class="mf">11.6531752</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="mf">11.5904301</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="mf">11.5270225</span><span class="n">s</span>
<span class="n">aarch64</span>: <span class="mf">12.006055</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="mf">11.5779827</span><span class="n">s</span><span class="p">,</span><span class="mf">11.9106966</span><span class="n">s</span>
</code></pre></div>
<p>Seems more plausible :)</p>
<p>Tho indeed I wouldn't expect a compile time of milliseconds. This could probably be a bug?! I can test in 24 hours on a real macbook and see how the branch works.</p>
</blockquote>



<a name="382339191"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236804%20Cranelift%3A%20avoid%20quadratic%20behavio.../near/382339191" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236804.20Cranelift.3A.20avoid.20quadratic.20behavio.2E.2E.2E.html#382339191">(Aug 06 2023 at 11:41)</a>:</h4>
<p>TimonPost edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/6804#issuecomment-1666828380">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6804">issue #6804</a>:</p>
<blockquote>
<p>Sorry, I made an error, my script errored for aarch64 with 'target not supported', used the wrong feature flag to compile wasmtime. I re-ran the script:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">SANDBOX_PATH</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="nb">static</span> <span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="s">"src/sandbox.wasm"</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">times</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">std</span>::<span class="n">time</span>::<span class="n">Duration</span><span class="p">,</span><span class="n">RandomState</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HashMap</span>::<span class="n">default</span><span class="p">();</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">arch</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="s">"x86_64"</span><span class="p">,</span><span class="w"> </span><span class="s">"aarch64"</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instant</span>::<span class="n">now</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Command</span>::<span class="n">new</span><span class="p">(</span><span class="s">"wasmtime"</span><span class="p">);</span>
<span class="w">        </span><span class="n">command</span><span class="p">.</span><span class="n">arg</span><span class="p">(</span><span class="s">"compile"</span><span class="p">).</span><span class="n">arg</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span><span class="s">"--target={os}"</span><span class="p">)).</span><span class="n">arg</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span><span class="s">"-o=output-{os}.wasm"</span><span class="p">)).</span><span class="n">arg</span><span class="p">(</span>
<span class="w">            </span><span class="n">SANDBOX_PATH</span><span class="p">,</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Start compiling on {}"</span><span class="p">,</span><span class="w"> </span><span class="n">arch</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">command</span><span class="p">.</span><span class="n">spawn</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">child</span><span class="p">.</span><span class="n">wait_with_output</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="n">times</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span><span class="s">"sandbox-{}"</span><span class="p">,</span><span class="w"> </span><span class="n">arch</span><span class="p">),</span><span class="w"> </span><span class="n">start</span><span class="p">.</span><span class="n">elapsed</span><span class="p">());</span>

<span class="w">        </span><span class="fm">println!</span><span class="p">(</span>
<span class="w">            </span><span class="s">"[{:?}]: {os} ({})"</span><span class="p">,</span>
<span class="w">            </span><span class="n">start</span><span class="p">.</span><span class="n">elapsed</span><span class="p">(),</span>
<span class="w">            </span><span class="nb">String</span>::<span class="n">from_utf8</span><span class="p">(</span><span class="n">output</span><span class="p">.</span><span class="n">stdout</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Running three times:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">x86_64</span>: <span class="mf">11.6531752</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="mf">11.5904301</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="mf">11.5270225</span><span class="n">s</span>
<span class="n">aarch64</span>: <span class="mf">12.006055</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="mf">11.5779827</span><span class="n">s</span><span class="p">,</span><span class="mf">11.9106966</span><span class="n">s</span>
</code></pre></div>
<p>Seems more plausible :)<br>
</p>
</blockquote>



<a name="382655776"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236804%20Cranelift%3A%20avoid%20quadratic%20behavio.../near/382655776" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236804.20Cranelift.3A.20avoid.20quadratic.20behavio.2E.2E.2E.html#382655776">(Aug 07 2023 at 14:39)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/6804#issuecomment-1667996603">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6804">issue #6804</a>:</p>
<blockquote>
<p>@cfallin I don't think it's worth belaboring the point too much, but I think it's important to have more rationale in the code other than "otherwise it's quadratic". The actual result of the generated code here I personally think is pretty surprising where the purpose of veneers/promotion is to incrementally get more distance and that's not what's happening here because everything is "flushed" all at once no matter whether or not we're about to go out of range of a branch. At least to me it's surprising that given the otherwise meticulous attention to detail throughout the file this seemingly-large detail is quickly glossed over.</p>
<p>And again to clarify I'm not advocating for here-and-now removing branch optimizations from the mach buffer. I realize it's a deep refactoring and would take quite some work and that additionally this is the result of historical work and balancing efforts. I still do believe though that this probably isn't the best place to do this because it's extremely late in the pipeline and we're already unable to perform optimization such as constant-branch-folding with knock-on effects from that. For example I'd imagine that if constant-branch-folding were implemented then many of the optimizations that the mach buffer does would probably fall out of that, where in such a situation it may not be necessary for the mach buffer to be as clever as it is today.</p>
<p>I mostly want to clarify that it sounds like you're advocating that this must stay as-is and there's no viable alternative to the mach buffer's optimizations today. I'm not personally convinced about that myself. In any case though this is all orthogonal to the compilation-time performance gains and is probably best left for a future issue/discussion rather than here.</p>
<hr>
<p>@TimonPost thanks for double-checking, and those new numbers make sense! It's true that 12 seconds still feels a bit high (although 115MB is a big module too). If you'd like it might be worth digging into the performance profile there. Locally in my <a href="https://github.com/bytecodealliance/wasmtime/issues/6798#issuecomment-1665539868">example program</a> most of the time was spent in b-trees in register allocation, which I don't know how to improve. If that's the case for your test case too it's probably at the limit of speed it's going to reach for now.</p>
</blockquote>



<a name="382658825"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236804%20Cranelift%3A%20avoid%20quadratic%20behavio.../near/382658825" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236804.20Cranelift.3A.20avoid.20quadratic.20behavio.2E.2E.2E.html#382658825">(Aug 07 2023 at 14:48)</a>:</h4>
<p>TimonPost <a href="https://github.com/bytecodealliance/wasmtime/pull/6804#issuecomment-1668012529">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6804">issue #6804</a>:</p>
<blockquote>
<p>I might do some more profiling to see where most time is spent now. Also compiling the workspace with:</p>
<div class="codehilite"><pre><span></span><code>            std::env::set_var(&quot;CARGO_INCREMENTAL&quot;, &quot;1&quot;);
            std::env::set_var(&quot;CARGO_PROFILE_RELEASE_LTO&quot;, &quot;false&quot;);
            std::env::set_var(&quot;CARGO_PROFILE_RELEASE_OPT_LEVEL&quot;, &quot;z&quot;);
            std::env::set_var(&quot;CARGO_PROFILE_RELEASE_DEBUG_ASSERTIONS&quot;, &quot;true&quot;);
</code></pre></div>

<p>Helps us to optimize for binary size and get ~59MB instead of the 115MB. </p>
</blockquote>



<a name="382658888"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236804%20Cranelift%3A%20avoid%20quadratic%20behavio.../near/382658888" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236804.20Cranelift.3A.20avoid.20quadratic.20behavio.2E.2E.2E.html#382658888">(Aug 07 2023 at 14:49)</a>:</h4>
<p>TimonPost edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/6804#issuecomment-1668012529">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6804">issue #6804</a>:</p>
<blockquote>
<p>I might do some more profiling to see where most time is spent now. Also compiling the workspace with release profile and:</p>
<div class="codehilite"><pre><span></span><code>            std::env::set_var(&quot;CARGO_INCREMENTAL&quot;, &quot;1&quot;);
            std::env::set_var(&quot;CARGO_PROFILE_RELEASE_LTO&quot;, &quot;false&quot;);
            std::env::set_var(&quot;CARGO_PROFILE_RELEASE_OPT_LEVEL&quot;, &quot;z&quot;);
            std::env::set_var(&quot;CARGO_PROFILE_RELEASE_DEBUG_ASSERTIONS&quot;, &quot;true&quot;);
</code></pre></div>

<p>Helps us to optimize for binary size and get ~59MB instead of the 115MB. </p>
</blockquote>



<a name="382659380"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236804%20Cranelift%3A%20avoid%20quadratic%20behavio.../near/382659380" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236804.20Cranelift.3A.20avoid.20quadratic.20behavio.2E.2E.2E.html#382659380">(Aug 07 2023 at 14:50)</a>:</h4>
<p>TimonPost edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/6804#issuecomment-1668012529">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6804">issue #6804</a>:</p>
<blockquote>
<p>I might do some more profiling to see where most time is spent now. Also compiling the workspace with release profile, CARGO_PROFILE_RELEASE_OPT_LEVEL=z, CARGO_INCREMENTAL=1, helps us to optimize for binary size and get ~59MB instead of the 115MB. </p>
</blockquote>



<a name="382659535"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236804%20Cranelift%3A%20avoid%20quadratic%20behavio.../near/382659535" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236804.20Cranelift.3A.20avoid.20quadratic.20behavio.2E.2E.2E.html#382659535">(Aug 07 2023 at 14:51)</a>:</h4>
<p>TimonPost edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/6804#issuecomment-1668012529">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6804">issue #6804</a>:</p>
<blockquote>
<p>I might do some more profiling to see where most time is spent now. Also compiling the workspace with release profile, CARGO_PROFILE_RELEASE_OPT_LEVEL=z, CARGO_INCREMENTAL=1, helps us to optimize for binary size and get ~59MB instead of the 115MB. So with this PR there are no big issues left.</p>
</blockquote>



<a name="382659571"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236804%20Cranelift%3A%20avoid%20quadratic%20behavio.../near/382659571" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236804.20Cranelift.3A.20avoid.20quadratic.20behavio.2E.2E.2E.html#382659571">(Aug 07 2023 at 14:51)</a>:</h4>
<p>TimonPost edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/6804#issuecomment-1668012529">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6804">issue #6804</a>:</p>
<blockquote>
<p>I might do some more profiling to see where most time is spent now. Also compiling the workspace with release profile, CARGO_PROFILE_RELEASE_OPT_LEVEL=z, CARGO_INCREMENTAL=1, helps us to optimize for binary size and get ~59MB instead of the 115MB. So after this PR there are no big issues left.</p>
</blockquote>



<a name="382746315"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236804%20Cranelift%3A%20avoid%20quadratic%20behavio.../near/382746315" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236804.20Cranelift.3A.20avoid.20quadratic.20behavio.2E.2E.2E.html#382746315">(Aug 07 2023 at 19:59)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/6804#issuecomment-1668493491">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6804">issue #6804</a>:</p>
<blockquote>
<p>Thanks @alexcrichton -- I filed #6818 to continue the larger discussion and added a more detailed "why" section to the top doc-comment here. I think actually doing deadlines properly might not be so bad, after more thought; will try to tackle this after some other higher-priority things.</p>
</blockquote>



<a name="382980837"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236804%20Cranelift%3A%20avoid%20quadratic%20behavio.../near/382980837" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236804.20Cranelift.3A.20avoid.20quadratic.20behavio.2E.2E.2E.html#382980837">(Aug 08 2023 at 14:38)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/6804#issuecomment-1669751510">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6804">issue #6804</a>:</p>
<blockquote>
<p>Looks good to me, and thanks for opening an issue! I'll read over that later today <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>