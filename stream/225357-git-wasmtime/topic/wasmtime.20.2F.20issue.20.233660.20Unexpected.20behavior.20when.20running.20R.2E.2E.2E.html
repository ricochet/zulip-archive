<html>
<head><meta charset="utf-8"><title>wasmtime / issue #3660 Unexpected behavior when running R... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233660.20Unexpected.20behavior.20when.20running.20R.2E.2E.2E.html">wasmtime / issue #3660 Unexpected behavior when running R...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="267156884"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233660%20Unexpected%20behavior%20when%20running%20R.../near/267156884" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233660.20Unexpected.20behavior.20when.20running.20R.2E.2E.2E.html#267156884">(Jan 07 2022 at 06:52)</a>:</h4>
<p>KernelErr labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/3660">issue #3660</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/7827003/rustpython.wasm.zip">rustpython.wasm.zip</a></p>
<p>Compiled RustPython.</p>
<h3>Steps to Reproduce</h3>
<p>Input any wrong python syntax like:</p>
<p>![image](<a href="https://user-images.githubusercontent.com/45716019/148503714-2a11531e-848b-4196-b26d-aee79a12dded.png">https://user-images.githubusercontent.com/45716019/148503714-2a11531e-848b-4196-b26d-aee79a12dded.png</a>)</p>
<h3>Expected Results</h3>
<p>There should be a Python error pointing out a syntax error.</p>
<h3>Actual Results</h3>
<p>Syntax errors could not be printed out in time.</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 0.33.0</p>
<p>Operating system: Linux</p>
<p>Architecture: amd64</p>
<h3>Extra Info</h3>
<p>On other runtimes, there could be current output.</p>
<p>![image](<a href="https://user-images.githubusercontent.com/45716019/148503910-48c4cfc3-3df2-4d60-a028-9527a3ee8d4f.png">https://user-images.githubusercontent.com/45716019/148503910-48c4cfc3-3df2-4d60-a028-9527a3ee8d4f.png</a>)</p>
</blockquote>



<a name="267156885"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233660%20Unexpected%20behavior%20when%20running%20R.../near/267156885" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233660.20Unexpected.20behavior.20when.20running.20R.2E.2E.2E.html#267156885">(Jan 07 2022 at 06:52)</a>:</h4>
<p>KernelErr opened <a href="https://github.com/bytecodealliance/wasmtime/issues/3660">issue #3660</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/7827003/rustpython.wasm.zip">rustpython.wasm.zip</a></p>
<p>Compiled RustPython.</p>
<h3>Steps to Reproduce</h3>
<p>Input any wrong python syntax like:</p>
<p>![image](<a href="https://user-images.githubusercontent.com/45716019/148503714-2a11531e-848b-4196-b26d-aee79a12dded.png">https://user-images.githubusercontent.com/45716019/148503714-2a11531e-848b-4196-b26d-aee79a12dded.png</a>)</p>
<h3>Expected Results</h3>
<p>There should be a Python error pointing out a syntax error.</p>
<h3>Actual Results</h3>
<p>Syntax errors could not be printed out in time.</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 0.33.0</p>
<p>Operating system: Linux</p>
<p>Architecture: amd64</p>
<h3>Extra Info</h3>
<p>On other runtimes, there could be current output.</p>
<p>![image](<a href="https://user-images.githubusercontent.com/45716019/148503910-48c4cfc3-3df2-4d60-a028-9527a3ee8d4f.png">https://user-images.githubusercontent.com/45716019/148503910-48c4cfc3-3df2-4d60-a028-9527a3ee8d4f.png</a>)</p>
</blockquote>



<a name="267156912"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233660%20Unexpected%20behavior%20when%20running%20R.../near/267156912" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233660.20Unexpected.20behavior.20when.20running.20R.2E.2E.2E.html#267156912">(Jan 07 2022 at 06:53)</a>:</h4>
<p>KernelErr edited <a href="https://github.com/bytecodealliance/wasmtime/issues/3660">issue #3660</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/7827003/rustpython.wasm.zip">rustpython.wasm.zip</a></p>
<p>Compiled RustPython.</p>
<h3>Steps to Reproduce</h3>
<p>Input any wrong python syntax like:</p>
<p>![image](<a href="https://user-images.githubusercontent.com/45716019/148503714-2a11531e-848b-4196-b26d-aee79a12dded.png">https://user-images.githubusercontent.com/45716019/148503714-2a11531e-848b-4196-b26d-aee79a12dded.png</a>)</p>
<h3>Expected Results</h3>
<p>There should be a syntax error right after the wrong line.</p>
<h3>Actual Results</h3>
<p>Syntax errors could not be printed out in time.</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 0.33.0</p>
<p>Operating system: Linux</p>
<p>Architecture: amd64</p>
<h3>Extra Info</h3>
<p>On other runtimes, there could be correct output.</p>
<p>![image](<a href="https://user-images.githubusercontent.com/45716019/148503910-48c4cfc3-3df2-4d60-a028-9527a3ee8d4f.png">https://user-images.githubusercontent.com/45716019/148503910-48c4cfc3-3df2-4d60-a028-9527a3ee8d4f.png</a>)</p>
</blockquote>



<a name="267203348"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233660%20Unexpected%20behavior%20when%20running%20R.../near/267203348" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233660.20Unexpected.20behavior.20when.20running.20R.2E.2E.2E.html#267203348">(Jan 07 2022 at 15:39)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/3660#issuecomment-1007505395">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3660">issue #3660</a>:</p>
<blockquote>
<p>Thanks for the report, are you able to share the source for how this module was built? Testing locally it appears that Wasmtime is doing the right thing with respect to the WASI API calls made. It may be a difference in WASI behavior between runtimes, though, causing this issue.</p>
</blockquote>



<a name="267205295"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233660%20Unexpected%20behavior%20when%20running%20R.../near/267205295" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233660.20Unexpected.20behavior.20when.20running.20R.2E.2E.2E.html#267205295">(Jan 07 2022 at 15:56)</a>:</h4>
<p>KernelErr <a href="https://github.com/bytecodealliance/wasmtime/issues/3660#issuecomment-1007520366">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3660">issue #3660</a>:</p>
<blockquote>
<p>Hi, I am using code from RustPython's pr 3514(<a href="https://github.com/RustPython/RustPython/pull/3514">https://github.com/RustPython/RustPython/pull/3514</a>). That's because I opened issue 3513 for it.</p>
<p>After cloning the RustPython repo, I used GitHub CLI to checkout the pr and ran the following command to build:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">--</span><span class="n">release</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="w"> </span><span class="o">--</span><span class="n">features</span><span class="o">=</span><span class="s">"freeze-stdlib"</span><span class="w"></span>
</code></pre></div>
<p>I built it again, and the problem still exists.</p>
<p>![image](<a href="https://user-images.githubusercontent.com/45716019/148570101-54e0332a-40a5-4e20-a8a2-157c87ff18fc.png">https://user-images.githubusercontent.com/45716019/148570101-54e0332a-40a5-4e20-a8a2-157c87ff18fc.png</a>)</p>
</blockquote>



<a name="267246396"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233660%20Unexpected%20behavior%20when%20running%20R.../near/267246396" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233660.20Unexpected.20behavior.20when.20running.20R.2E.2E.2E.html#267246396">(Jan 07 2022 at 21:43)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/3660#issuecomment-1007761307">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3660">issue #3660</a>:</p>
<blockquote>
<p>cc @sunfishcode and @pchickey, this all boils down to <code>isatty({0,1,2})</code> which is a mixture of:</p>
<ul>
<li><a href="https://github.com/WebAssembly/wasi-libc/blob/ad5133410f66b93a2381db5b542aad5e0964db96/libc-bottom-half/sources/isatty.c"><code>isatty</code> in wasi-libc</a></li>
<li><a href="https://github.com/bytecodealliance/wasmtime/blob/ab1d845ac164813a595b2820da2994968af76b32/crates/wasi-common/src/ctx.rs#L73-L83">default rights for stdio in wasi-common set to <code>::all()</code></a></li>
<li><a href="https://github.com/bytecodealliance/wasmtime/blob/ab1d845ac164813a595b2820da2994968af76b32/crates/wasi-common/cap-std-sync/src/stdio.rs#L140-L142">stdio types having an <code>Unknown</code> file type</a></li>
</ul>
<p>It looks like the <code>rustpython.wasm</code> is differing its behavior based on whether the stdin/stdout/stderr are a tty, and that basically affects buffering which means that the error being expected here is buffered to be printed later. The test for <code>isatty</code> in <code>wasi-libc</code> needs two modifications in <code>wasi-common</code> to clear checks, one being changing <code>Unknown</code> to something not-unknown, and another being removing rights from the stdio descriptors.</p>
<p>I don't really know where the bug here is. A lot of this is basically legacy I think and there's not really a crisp-and-clear definition of what everything should be. There's not really a bug in Wasmtime per-se, it's just that our stdio descriptors don't look like something that rustpython is expecting and as a result rustpython behaves oddly.</p>
</blockquote>



<a name="271326992"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233660%20Unexpected%20behavior%20when%20running%20R.../near/271326992" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233660.20Unexpected.20behavior.20when.20running.20R.2E.2E.2E.html#271326992">(Feb 09 2022 at 18:38)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/3660#issuecomment-1034075805">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3660">issue #3660</a>:</p>
<blockquote>
<p>I think this was fixed in <a href="https://github.com/bytecodealliance/wasmtime/pull/3696">https://github.com/bytecodealliance/wasmtime/pull/3696</a>, so closing.</p>
</blockquote>



<a name="271326995"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233660%20Unexpected%20behavior%20when%20running%20R.../near/271326995" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233660.20Unexpected.20behavior.20when.20running.20R.2E.2E.2E.html#271326995">(Feb 09 2022 at 18:38)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/3660">issue #3660</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/7827003/rustpython.wasm.zip">rustpython.wasm.zip</a></p>
<p>Compiled RustPython.</p>
<h3>Steps to Reproduce</h3>
<p>Input any wrong python syntax like:</p>
<p>![image](<a href="https://user-images.githubusercontent.com/45716019/148503714-2a11531e-848b-4196-b26d-aee79a12dded.png">https://user-images.githubusercontent.com/45716019/148503714-2a11531e-848b-4196-b26d-aee79a12dded.png</a>)</p>
<h3>Expected Results</h3>
<p>There should be a syntax error right after the wrong line.</p>
<h3>Actual Results</h3>
<p>Syntax errors could not be printed out in time.</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 0.33.0</p>
<p>Operating system: Linux</p>
<p>Architecture: amd64</p>
<h3>Extra Info</h3>
<p>On other runtimes, there could be correct output.</p>
<p>![image](<a href="https://user-images.githubusercontent.com/45716019/148503910-48c4cfc3-3df2-4d60-a028-9527a3ee8d4f.png">https://user-images.githubusercontent.com/45716019/148503910-48c4cfc3-3df2-4d60-a028-9527a3ee8d4f.png</a>)</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>