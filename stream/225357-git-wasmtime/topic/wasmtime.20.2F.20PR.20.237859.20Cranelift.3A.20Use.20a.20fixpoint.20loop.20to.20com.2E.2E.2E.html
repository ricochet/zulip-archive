<html>
<head><meta charset="utf-8"><title>wasmtime / PR #7859 Cranelift: Use a fixpoint loop to com... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html">wasmtime / PR #7859 Cranelift: Use a fixpoint loop to com...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="419378474"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419378474" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419378474">(Feb 02 2024 at 03:40)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/elliottt">elliottt</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7859">PR #7859</a>.</p>



<a name="419378475"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419378475" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419378475">(Feb 02 2024 at 03:40)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7859">PR #7859</a>.</p>



<a name="419378477"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419378477" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419378477">(Feb 02 2024 at 03:40)</a>:</h4>
<p>fitzgen opened <a href="https://github.com/bytecodealliance/wasmtime/pull/7859">PR #7859</a> from <code>fitzgen:egraph-cost-fix-point</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Fixes #7857</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="419378478"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419378478" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419378478">(Feb 02 2024 at 03:40)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7859">PR #7859</a>.</p>



<a name="419380328"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419380328" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419380328">(Feb 02 2024 at 04:01)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#pullrequestreview-1858220769">PR review</a>:</p>
<blockquote>
<p>This looks great!</p>
</blockquote>



<a name="419380329"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419380329" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419380329">(Feb 02 2024 at 04:01)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#pullrequestreview-1858220769">PR review</a>:</p>
<blockquote>
<p>This looks great!</p>
</blockquote>



<a name="419380330"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419380330" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419380330">(Feb 02 2024 at 04:01)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#discussion_r1475493745">PR review comment</a>:</p>
<blockquote>
<p>What do you think about making this check if the updated <code>best[value]</code> is infinity, rather than if it changed? Given the way that infinity saturates, I think we can assume that a finite result is the best we'll do here.</p>
</blockquote>



<a name="419380331"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419380331" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419380331">(Feb 02 2024 at 04:01)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#discussion_r1475489756">PR review comment</a>:</p>
<blockquote>
<p><span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> </p>
</blockquote>



<a name="419380332"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419380332" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419380332">(Feb 02 2024 at 04:01)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#discussion_r1475494766">PR review comment</a>:</p>
<blockquote>
<p>Really glad you added this one!</p>
</blockquote>



<a name="419381312"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419381312" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419381312">(Feb 02 2024 at 04:12)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#pullrequestreview-1858244038">PR review</a>.</p>



<a name="419381314"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419381314" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419381314">(Feb 02 2024 at 04:12)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#discussion_r1475500727">PR review comment</a>:</p>
<blockquote>
<p>Though the change I suggested hinges on all values definitely becoming non-infinite, so I think looking for the change in best value is better. Never mind!</p>
</blockquote>



<a name="419395393"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419395393" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419395393">(Feb 02 2024 at 07:12)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#pullrequestreview-1858524648">PR review</a>.</p>



<a name="419395394"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419395394" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419395394">(Feb 02 2024 at 07:12)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#discussion_r1475647982">PR review comment</a>:</p>
<blockquote>
<p>Sorry for the drive-by from the sidelines, just a possible clarification request here though after thinking about cost updates during a long drive today:</p>
<p>It's not immediately obvious to me why this (once finite, then final) property is the case; I'm curious what reasoning y'all have gone through on this and/or what you've observed? I think a node's cost can continue to decrease as we discover more finite costs (consider a union node: <code>min(20, infinity) == 20</code> in first pass, <code>min(20, 10) == 10</code> in second pass; then another node that uses that as an arg). Or is there an argument we can make why this shouldn't happen in practice?</p>
</blockquote>



<a name="419456142"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419456142" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419456142">(Feb 02 2024 at 13:20)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#pullrequestreview-1859234199">PR review</a>.</p>



<a name="419456143"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419456143" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419456143">(Feb 02 2024 at 13:20)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#discussion_r1476053154">PR review comment</a>:</p>
<blockquote>
<p>This is a great point Chris! When @fitzgen and I were discussing the fixpoint change yesterday, we reasoned that it was okay to skip finite values because we were assuming two things:</p>
<ul>
<li>We would remove the behavior where <code>Cost</code> addition would saturate to <code>MAX_COST</code>, not <code>infinity()</code></li>
<li>As we can't produce cycles, a fixpoint would cause everything to eventually settle out to finite cost</li>
</ul>
<p>As you pointed out, the flaw with this reasoning is that the handling of <code>Union</code> values will not behave this way, instead preferring finite values to infinite.</p>
<p>Since addition now saturates to infinity which will ensure that <code>Result</code> nodes don't appear finite until all their dependencies have been processed, what do you think about only computing the min if both arguments to a <code>Union</code> are finite? I think that change would make more concrete our use of the <code>infinity()</code> cost: it's a marker for where all the arguments have not yet been processed.</p>
</blockquote>



<a name="419485763"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419485763" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419485763">(Feb 02 2024 at 15:55)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#pullrequestreview-1859583483">PR review</a>.</p>



<a name="419485765"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419485765" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419485765">(Feb 02 2024 at 15:55)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#discussion_r1476238366">PR review comment</a>:</p>
<blockquote>
<p>In order for a <code>union(a, b)</code> to be finite but not in its final form would require one of <code>a</code> or <code>b</code> to finite and the other infinite, but the only way we can still have an infinite cost for an operand value when computing the cost of the current value is if the operand value's index is larger than the current value's index. That <em>cannot</em> happen for union values, since they are only added to the DFG after their operands.</p>
<p>This is, however, a pretty subtle argument, so I'd be fine skipping this early-<code>continue</code> optimization. I'll land this PR without it, because that is pretty obviously correct, and if we want to experiment with different approaches to optimizing the loop from there, we can open follow up PRs.</p>
</blockquote>



<a name="419486727"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419486727" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419486727">(Feb 02 2024 at 16:00)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7859">PR #7859</a>.</p>



<a name="419486996"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419486996" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419486996">(Feb 02 2024 at 16:01)</a>:</h4>
<p>fitzgen has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/7859">PR #7859</a>.</p>



<a name="419488344"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419488344" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419488344">(Feb 02 2024 at 16:08)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#pullrequestreview-1859610532">PR review</a>.</p>



<a name="419488345"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419488345" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419488345">(Feb 02 2024 at 16:08)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#discussion_r1476254284">PR review comment</a>:</p>
<blockquote>
<p>Good point Nick, sorry for muddying the waters there.</p>
</blockquote>



<a name="419494093"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419494093" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419494093">(Feb 02 2024 at 16:39)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#pullrequestreview-1859677024">PR review</a>.</p>



<a name="419494094"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419494094" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419494094">(Feb 02 2024 at 16:39)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#discussion_r1476292218">PR review comment</a>:</p>
<blockquote>
<p>Okay actually I was wrong, thanks Trevor for asking very pointed questions in private chat :-p</p>
<p>The union's operand values are always defined before the union, but if one of <em>those</em> operand values is a funky one where <em>its</em> operands are out of order, then the operand could still be infinite by the time we get to the union, and then the union's <code>min</code> would drop the infinite. That would be a finite cost that is potentially not in its final form, depending on the cost we still need to compute for the still-infinite operand.</p>
<p>So this "optimization" of early-continuing was not correct! Bullet dodged.</p>
<p>This ae-graphs code is all very subtle, and we should spend some time thinking about what we can do to make things more obviously correct, even if it is just adding additional debug asserts and comments. It shouldn't take 3.5 engineers who are all intimately familiar with Cranelift a full day to diagnose and fix this kind of bug and <em>still</em> introduce subtle flaws in the fix.</p>
</blockquote>



<a name="419494741"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419494741" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419494741">(Feb 02 2024 at 16:43)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#pullrequestreview-1859683424">PR review</a>.</p>



<a name="419494742"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419494742" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419494742">(Feb 02 2024 at 16:43)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#discussion_r1476296142">PR review comment</a>:</p>
<blockquote>
<p>And for clarity: since we are doing the "full" fixpoint now, even if we "drop" an operand's infinite cost via <code>min</code> in one iteration of the loop, we will consider that operand's value again on the next iteration of the fix point, and eventually, as the fixpoint is reached, we will have the correct costs for everything.</p>
</blockquote>



<a name="419494993"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419494993" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419494993">(Feb 02 2024 at 16:44)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#issuecomment-1924250668">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7859">PR #7859</a>:</p>
<blockquote>
<p>(Re-adding to merge queue after misunderstanding regarding <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#discussion_r1476296142">https://github.com/bytecodealliance/wasmtime/pull/7859#discussion_r1476296142</a>)</p>
</blockquote>



<a name="419536870"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419536870" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419536870">(Feb 02 2024 at 21:22)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#pullrequestreview-1860413183">PR review</a>.</p>



<a name="419536871"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419536871" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419536871">(Feb 02 2024 at 21:22)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#discussion_r1476744864">PR review comment</a>:</p>
<blockquote>
<p>Thanks @fitzgen and @elliottt (and @alexcrichton) for taking this on and sorry for not realizing this subtle case originally!</p>
<p>A further optimization (which I can take on when I'm back) that occurred to me today: we could track whether we see any "forward references" (perhaps integrate this into the fixpoint loop itself, though it won't change between iterations), and exit the loop after one iteration if none exist. This is the common case, and it would avoid doing a second (no-changes) pass. This extra cost is totally fine for now IMHO (correctness first!).</p>
<p>I agree the code is pretty subtle; to some degree I think that's inherent to the problem, and it's already pretty comment-dense in many (not all!) areas, but I can also try to add some more top-level documentation on invariants and the like when I'm back. I'd like to try to do some more semi-formal proofs too, similar to MachBuffer's comments, to convince us that we don't have any more issues lurking (and to help understanding).</p>
</blockquote>



<a name="419887509"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419887509" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419887509">(Feb 05 2024 at 17:03)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#pullrequestreview-1863342658">PR review</a>.</p>



<a name="419887511"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419887511" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419887511">(Feb 05 2024 at 17:03)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#discussion_r1478587970">PR review comment</a>:</p>
<blockquote>
<p>Agreed, and not trying to point fingers or anything, just trying to improve the situation for everyone. I think something like <a href="https://github.com/bytecodealliance/wasmtime/issues/7856">https://github.com/bytecodealliance/wasmtime/issues/7856</a> would help a lot too.</p>
</blockquote>



<a name="419889306"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419889306" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419889306">(Feb 05 2024 at 17:12)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7859">PR #7859</a>.</p>



<a name="419889421"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419889421" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419889421">(Feb 05 2024 at 17:13)</a>:</h4>
<p>fitzgen has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/7859">PR #7859</a>.</p>



<a name="419897426"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419897426" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419897426">(Feb 05 2024 at 17:57)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#issuecomment-1927628709">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7859">PR #7859</a>:</p>
<blockquote>
<p>Given that the same riscv64 failure happened twice in a row my guess is that it's probably a deterministic failure rather than a spurious failure. That may mean that a preexisting riscv64 lowering rule is buggy and this is starting to expose that. I'll note though that I haven't attempted to reproduce locally yet.</p>
</blockquote>



<a name="419899971"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419899971" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419899971">(Feb 05 2024 at 18:12)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#issuecomment-1927681041">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7859">PR #7859</a>:</p>
<blockquote>
<p>Ah yes I can reproduce locally:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">----</span><span class="w"> </span><span class="n">wasi_http_hash_all_with_override</span><span class="w"> </span><span class="n">stdout</span><span class="w"> </span><span class="o">----</span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">wasi_http_hash_all_with_override</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="o">/</span><span class="n">elaborate</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">296</span>:<span class="mi">17</span>:
<span class="nc">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="nc">best</span><span class="p">[</span><span class="n">value</span><span class="p">].</span><span class="mf">0.</span><span class="n">is_finite</span><span class="p">()</span>

<span class="o">----</span><span class="w"> </span><span class="n">wasi_http_double_echo</span><span class="w"> </span><span class="n">stdout</span><span class="w"> </span><span class="o">----</span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">wasi_http_double_echo</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="o">/</span><span class="n">elaborate</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">296</span>:<span class="mi">17</span>:
<span class="nc">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="nc">best</span><span class="p">[</span><span class="n">value</span><span class="p">].</span><span class="mf">0.</span><span class="n">is_finite</span><span class="p">()</span>

<span class="o">----</span><span class="w"> </span><span class="n">wasi_http_hash_all</span><span class="w"> </span><span class="n">stdout</span><span class="w"> </span><span class="o">----</span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">wasi_http_hash_all</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="o">/</span><span class="n">elaborate</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">296</span>:<span class="mi">17</span>:
<span class="nc">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="nc">best</span><span class="p">[</span><span class="n">value</span><span class="p">].</span><span class="mf">0.</span><span class="n">is_finite</span><span class="p">()</span>
<span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span>

<span class="o">----</span><span class="w"> </span><span class="n">wasi_http_echo</span><span class="w"> </span><span class="n">stdout</span><span class="w"> </span><span class="o">----</span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">wasi_http_echo</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="o">/</span><span class="n">elaborate</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">296</span>:<span class="mi">17</span>:
<span class="nc">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="nc">best</span><span class="p">[</span><span class="n">value</span><span class="p">].</span><span class="mf">0.</span><span class="n">is_finite</span><span class="p">()</span>
</code></pre></div>
<p>No output on CI due to <a href="https://github.com/rayon-rs/rayon/issues/1066">https://github.com/rayon-rs/rayon/issues/1066</a> I think, not that it's actually a bug in rayon but an unfortunate consequence.</p>
</blockquote>



<a name="419904936"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419904936" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419904936">(Feb 05 2024 at 18:42)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#issuecomment-1927785504">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7859">PR #7859</a>:</p>
<blockquote>
<p>I ran the <code>fuzzgen-icache</code> fuzzer to try and find a small reproducible example for the riscv bug, but it found a similar error for s390x:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">compile</span>
<span class="n">set</span><span class="w"> </span><span class="n">opt_level</span><span class="o">=</span><span class="n">speed</span>
<span class="n">target</span><span class="w"> </span><span class="n">s390x</span>

<span class="n">function</span><span class="w"> </span><span class="n">u1</span>:<span class="mi">0</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">f32x4</span><span class="w"> </span><span class="n">system_v</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">const0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000000000000000000000000000000</span>

<span class="n">block0</span>:
    <span class="nc">v27</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vconst</span><span class="p">.</span><span class="n">f32x4</span><span class="w"> </span><span class="n">const0</span>
<span class="w">    </span><span class="n">v57</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fma</span><span class="w"> </span><span class="n">v27</span><span class="p">,</span><span class="w"> </span><span class="n">v27</span><span class="p">,</span><span class="w"> </span><span class="n">v27</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v27</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">const0</span><span class="p">,</span><span class="w"> </span><span class="n">v27</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">const0</span><span class="p">,</span><span class="w"> </span><span class="n">v27</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">const0</span>
<span class="w">    </span><span class="n">v58</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vconst</span><span class="p">.</span><span class="n">i32x4</span><span class="w"> </span><span class="n">const0</span>
<span class="w">    </span><span class="n">v60</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vconst</span><span class="p">.</span><span class="n">f32x4</span><span class="w"> </span><span class="n">const0</span>
<span class="w">    </span><span class="n">v61</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitcast</span><span class="p">.</span><span class="n">f32x4</span><span class="w"> </span><span class="n">v58</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v58</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">const0</span>
<span class="w">    </span><span class="n">v28</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitselect</span><span class="w"> </span><span class="n">v61</span><span class="p">,</span><span class="w"> </span><span class="n">v60</span><span class="p">,</span><span class="w"> </span><span class="n">v57</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v60</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">const0</span>
<span class="w">    </span><span class="n">v62</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fma</span><span class="w"> </span><span class="n">v28</span><span class="p">,</span><span class="w"> </span><span class="n">v28</span><span class="p">,</span><span class="w"> </span><span class="n">v28</span>
<span class="w">    </span><span class="n">v63</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fcmp</span><span class="w"> </span><span class="n">ne</span><span class="w"> </span><span class="n">v62</span><span class="p">,</span><span class="w"> </span><span class="n">v62</span>
<span class="w">    </span><span class="n">v65</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vconst</span><span class="p">.</span><span class="n">f32x4</span><span class="w"> </span><span class="n">const0</span>
<span class="w">    </span><span class="n">v66</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitcast</span><span class="p">.</span><span class="n">f32x4</span><span class="w"> </span><span class="n">v63</span>
<span class="w">    </span><span class="n">v29</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitselect</span><span class="w"> </span><span class="n">v66</span><span class="p">,</span><span class="w"> </span><span class="n">v65</span><span class="p">,</span><span class="w"> </span><span class="n">v62</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v65</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">const0</span>
<span class="w">    </span><span class="n">v67</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fma</span><span class="w"> </span><span class="n">v29</span><span class="p">,</span><span class="w"> </span><span class="n">v29</span><span class="p">,</span><span class="w"> </span><span class="n">v29</span>
<span class="w">    </span><span class="n">v68</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fcmp</span><span class="w"> </span><span class="n">ne</span><span class="w"> </span><span class="n">v67</span><span class="p">,</span><span class="w"> </span><span class="n">v67</span>
<span class="w">    </span><span class="n">v70</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vconst</span><span class="p">.</span><span class="n">f32x4</span><span class="w"> </span><span class="n">const0</span>
<span class="w">    </span><span class="n">v71</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitcast</span><span class="p">.</span><span class="n">f32x4</span><span class="w"> </span><span class="n">v68</span>
<span class="w">    </span><span class="n">v30</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitselect</span><span class="w"> </span><span class="n">v71</span><span class="p">,</span><span class="w"> </span><span class="n">v70</span><span class="p">,</span><span class="w"> </span><span class="n">v67</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v70</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">const0</span>
<span class="w">    </span><span class="n">v72</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fma</span><span class="w"> </span><span class="n">v30</span><span class="p">,</span><span class="w"> </span><span class="n">v30</span><span class="p">,</span><span class="w"> </span><span class="n">v30</span>
<span class="w">    </span><span class="n">v73</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fcmp</span><span class="w"> </span><span class="n">ne</span><span class="w"> </span><span class="n">v72</span><span class="p">,</span><span class="w"> </span><span class="n">v72</span>
<span class="w">    </span><span class="n">v75</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vconst</span><span class="p">.</span><span class="n">f32x4</span><span class="w"> </span><span class="n">const0</span>
<span class="w">    </span><span class="n">v76</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitcast</span><span class="p">.</span><span class="n">f32x4</span><span class="w"> </span><span class="n">v73</span>
<span class="w">    </span><span class="n">v31</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitselect</span><span class="w"> </span><span class="n">v76</span><span class="p">,</span><span class="w"> </span><span class="n">v75</span><span class="p">,</span><span class="w"> </span><span class="n">v72</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v75</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">const0</span>
<span class="w">    </span><span class="n">v77</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fma</span><span class="w"> </span><span class="n">v31</span><span class="p">,</span><span class="w"> </span><span class="n">v31</span><span class="p">,</span><span class="w"> </span><span class="n">v31</span>
<span class="w">    </span><span class="n">v78</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fcmp</span><span class="w"> </span><span class="n">ne</span><span class="w"> </span><span class="n">v77</span><span class="p">,</span><span class="w"> </span><span class="n">v77</span>
<span class="w">    </span><span class="n">v80</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vconst</span><span class="p">.</span><span class="n">f32x4</span><span class="w"> </span><span class="n">const0</span>
<span class="w">    </span><span class="n">v81</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitcast</span><span class="p">.</span><span class="n">f32x4</span><span class="w"> </span><span class="n">v78</span>
<span class="w">    </span><span class="n">v32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitselect</span><span class="w"> </span><span class="n">v81</span><span class="p">,</span><span class="w"> </span><span class="n">v80</span><span class="p">,</span><span class="w"> </span><span class="n">v77</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v80</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">const0</span>
<span class="w">    </span><span class="n">v82</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fma</span><span class="w"> </span><span class="n">v32</span><span class="p">,</span><span class="w"> </span><span class="n">v32</span><span class="p">,</span><span class="w"> </span><span class="n">v32</span>
<span class="w">    </span><span class="n">v83</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fcmp</span><span class="w"> </span><span class="n">ne</span><span class="w"> </span><span class="n">v82</span><span class="p">,</span><span class="w"> </span><span class="n">v82</span>
<span class="w">    </span><span class="n">v85</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vconst</span><span class="p">.</span><span class="n">f32x4</span><span class="w"> </span><span class="n">const0</span>
<span class="w">    </span><span class="n">v86</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitcast</span><span class="p">.</span><span class="n">f32x4</span><span class="w"> </span><span class="n">v83</span>
<span class="w">    </span><span class="n">v33</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitselect</span><span class="w"> </span><span class="n">v86</span><span class="p">,</span><span class="w"> </span><span class="n">v85</span><span class="p">,</span><span class="w"> </span><span class="n">v82</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v85</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">const0</span>
<span class="w">    </span><span class="n">v87</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fma</span><span class="w"> </span><span class="n">v33</span><span class="p">,</span><span class="w"> </span><span class="n">v33</span><span class="p">,</span><span class="w"> </span><span class="n">v33</span>
<span class="w">    </span><span class="n">v88</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fcmp</span><span class="w"> </span><span class="n">ne</span><span class="w"> </span><span class="n">v87</span><span class="p">,</span><span class="w"> </span><span class="n">v87</span>
<span class="w">    </span><span class="n">v90</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vconst</span><span class="p">.</span><span class="n">f32x4</span><span class="w"> </span><span class="n">const0</span>
<span class="w">    </span><span class="n">v91</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitcast</span><span class="p">.</span><span class="n">f32x4</span><span class="w"> </span><span class="n">v88</span>
<span class="w">    </span><span class="n">v34</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitselect</span><span class="w"> </span><span class="n">v91</span><span class="p">,</span><span class="w"> </span><span class="n">v90</span><span class="p">,</span><span class="w"> </span><span class="n">v87</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v90</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">const0</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v34</span>
<span class="p">}</span>
</code></pre></div>
<p>I'm still going to try to find a smaller one before trying to figure out which rule is causing issues</p>
</blockquote>



<a name="419907751"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419907751" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419907751">(Feb 05 2024 at 18:58)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#issuecomment-1927836561">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7859">PR #7859</a>:</p>
<blockquote>
<p>Thanks Afonso!</p>
</blockquote>



<a name="419916063"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419916063" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419916063">(Feb 05 2024 at 19:47)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#issuecomment-1927946674">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7859">PR #7859</a>:</p>
<blockquote>
<p>Here's another case that it found, this one for AArch64. </p>
<p>&lt;details&gt;<br>
  &lt;summary&gt;Testcase&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">compile</span>
<span class="n">set</span><span class="w"> </span><span class="n">opt_level</span><span class="o">=</span><span class="n">speed</span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span>

<span class="n">function</span><span class="w"> </span><span class="n">u1</span>:<span class="mi">0</span><span class="p">(</span><span class="n">f64x2</span><span class="p">,</span><span class="w"> </span><span class="n">f64x2</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">f64x2</span><span class="p">,</span><span class="w"> </span><span class="n">f64x2</span><span class="w"> </span><span class="n">tail</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">sig0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">f64x2</span><span class="p">,</span><span class="w"> </span><span class="n">f64x2</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">f64x2</span><span class="p">,</span><span class="w"> </span><span class="n">f64x2</span><span class="w"> </span><span class="n">tail</span>
<span class="w">    </span><span class="n">fn0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colocated</span><span class="w"> </span><span class="n">u2</span>:<span class="mi">0</span><span class="w"> </span><span class="n">sig0</span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">f64x2</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">f64x2</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i8</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i16</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">v6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uextend</span><span class="p">.</span><span class="kt">i128</span><span class="w"> </span><span class="n">v5</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">v7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_addr</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">fn0</span>
<span class="w">    </span><span class="n">return_call_indirect</span><span class="w"> </span><span class="n">sig0</span><span class="p">,</span><span class="w"> </span><span class="n">v7</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">)</span>

<span class="n">block1</span><span class="w"> </span><span class="n">cold</span>:
    <span class="nc">v62</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f64const</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">    </span><span class="n">v63</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">splat</span><span class="p">.</span><span class="n">f64x2</span><span class="w"> </span><span class="n">v62</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v62</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">    </span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">v10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v63</span><span class="p">,</span><span class="w"> </span><span class="n">v63</span><span class="p">)</span>
<span class="w">    </span><span class="n">v11</span><span class="p">,</span><span class="w"> </span><span class="n">v12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v10</span><span class="p">,</span><span class="w"> </span><span class="n">v10</span><span class="p">)</span>
<span class="w">    </span><span class="n">v13</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v12</span><span class="p">,</span><span class="w"> </span><span class="n">v12</span><span class="p">)</span>
<span class="w">    </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v14</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span><span class="p">)</span>
<span class="w">    </span><span class="n">v17</span><span class="p">,</span><span class="w"> </span><span class="n">v18</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v16</span><span class="p">,</span><span class="w"> </span><span class="n">v16</span><span class="p">)</span>
<span class="w">    </span><span class="n">v19</span><span class="p">,</span><span class="w"> </span><span class="n">v20</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v18</span><span class="p">,</span><span class="w"> </span><span class="n">v18</span><span class="p">)</span>
<span class="w">    </span><span class="n">v21</span><span class="p">,</span><span class="w"> </span><span class="n">v22</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v20</span><span class="p">,</span><span class="w"> </span><span class="n">v20</span><span class="p">)</span>
<span class="w">    </span><span class="n">v23</span><span class="p">,</span><span class="w"> </span><span class="n">v24</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v22</span><span class="p">,</span><span class="w"> </span><span class="n">v22</span><span class="p">)</span>
<span class="w">    </span><span class="n">v25</span><span class="p">,</span><span class="w"> </span><span class="n">v26</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v24</span><span class="p">,</span><span class="w"> </span><span class="n">v24</span><span class="p">)</span>
<span class="w">    </span><span class="n">v27</span><span class="p">,</span><span class="w"> </span><span class="n">v28</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v26</span><span class="p">,</span><span class="w"> </span><span class="n">v26</span><span class="p">)</span>
<span class="w">    </span><span class="n">v29</span><span class="p">,</span><span class="w"> </span><span class="n">v30</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v28</span><span class="p">,</span><span class="w"> </span><span class="n">v28</span><span class="p">)</span>
<span class="w">    </span><span class="n">v31</span><span class="p">,</span><span class="w"> </span><span class="n">v32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v30</span><span class="p">,</span><span class="w"> </span><span class="n">v30</span><span class="p">)</span>
<span class="w">    </span><span class="n">v33</span><span class="p">,</span><span class="w"> </span><span class="n">v34</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v32</span><span class="p">,</span><span class="w"> </span><span class="n">v32</span><span class="p">)</span>
<span class="w">    </span><span class="n">v35</span><span class="p">,</span><span class="w"> </span><span class="n">v36</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v34</span><span class="p">,</span><span class="w"> </span><span class="n">v34</span><span class="p">)</span>
<span class="w">    </span><span class="n">v37</span><span class="p">,</span><span class="w"> </span><span class="n">v38</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v36</span><span class="p">,</span><span class="w"> </span><span class="n">v36</span><span class="p">)</span>
<span class="w">    </span><span class="n">v39</span><span class="p">,</span><span class="w"> </span><span class="n">v40</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v38</span><span class="p">,</span><span class="w"> </span><span class="n">v38</span><span class="p">)</span>
<span class="w">    </span><span class="n">v41</span><span class="p">,</span><span class="w"> </span><span class="n">v42</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v40</span><span class="p">,</span><span class="w"> </span><span class="n">v40</span><span class="p">)</span>
<span class="w">    </span><span class="n">v43</span><span class="p">,</span><span class="w"> </span><span class="n">v44</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v42</span><span class="p">,</span><span class="w"> </span><span class="n">v42</span><span class="p">)</span>
<span class="w">    </span><span class="n">v45</span><span class="p">,</span><span class="w"> </span><span class="n">v46</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v44</span><span class="p">,</span><span class="w"> </span><span class="n">v44</span><span class="p">)</span>
<span class="w">    </span><span class="n">v47</span><span class="p">,</span><span class="w"> </span><span class="n">v48</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v46</span><span class="p">,</span><span class="w"> </span><span class="n">v46</span><span class="p">)</span>
<span class="w">    </span><span class="n">v49</span><span class="p">,</span><span class="w"> </span><span class="n">v50</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v48</span><span class="p">,</span><span class="w"> </span><span class="n">v48</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v49</span><span class="p">,</span><span class="w"> </span><span class="n">v49</span>
<span class="p">}</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>This one is interesting to me because almost all of this is dead code, but if we minimize it, it no longer crashes <span aria-label="eyes" class="emoji emoji-1f440" role="img" title="eyes">:eyes:</span> . The trace log states the following:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">context</span><span class="w">              </span><span class="o">&gt;</span><span class="w"> </span><span class="n">About</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">optimize</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">egraph</span><span class="w"> </span><span class="n">phase</span>:
<span class="nc">function</span><span class="w"> </span><span class="n">u1</span>:<span class="mi">0</span><span class="p">(</span><span class="n">f64x2</span><span class="p">,</span><span class="w"> </span><span class="n">f64x2</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">f64x2</span><span class="p">,</span><span class="w"> </span><span class="n">f64x2</span><span class="w"> </span><span class="n">tail</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">sig0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">f64x2</span><span class="p">,</span><span class="w"> </span><span class="n">f64x2</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">f64x2</span><span class="p">,</span><span class="w"> </span><span class="n">f64x2</span><span class="w"> </span><span class="n">tail</span>
<span class="w">    </span><span class="n">fn0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colocated</span><span class="w"> </span><span class="n">u2</span>:<span class="mi">0</span><span class="w"> </span><span class="n">sig0</span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">f64x2</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">f64x2</span><span class="p">)</span>:
    <span class="nc">v7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_addr</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">fn0</span>
<span class="w">    </span><span class="n">return_call_indirect</span><span class="w"> </span><span class="n">sig0</span><span class="p">,</span><span class="w"> </span><span class="n">v7</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>So it does optimize away the deadcode internally, but then still tries to elaborate some of the previously eliminated instructions. Which doesn't make sense to me, but I haven't kept up with the inner workings of the egraphs stuff.</p>
<p>I'm not familiar enough with egraphs to be able to debug this, but if you need any help reworking one of the lowering rules let me know!</p>
</blockquote>



<a name="419937056"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419937056" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419937056">(Feb 05 2024 at 22:09)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7859">PR #7859</a>.</p>



<a name="419938042"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419938042" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419938042">(Feb 05 2024 at 22:16)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7859">PR #7859</a>.</p>



<a name="419938271"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419938271" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419938271">(Feb 05 2024 at 22:18)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#pullrequestreview-1863904841">PR review</a>:</p>
<blockquote>
<p>Looks good to me! Just one optional suggestion.</p>
</blockquote>



<a name="419938272"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419938272" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419938272">(Feb 05 2024 at 22:18)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#pullrequestreview-1863904841">PR review</a>:</p>
<blockquote>
<p>Looks good to me! Just one optional suggestion.</p>
</blockquote>



<a name="419938273"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419938273" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419938273">(Feb 05 2024 at 22:18)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#discussion_r1478967579">PR review comment</a>:</p>
<blockquote>
<p>Can I suggest adding the same assertion with the operands swapped? <code>b+a</code> should also be infinity.</p>
</blockquote>



<a name="419939124"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419939124" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419939124">(Feb 05 2024 at 22:25)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7859">PR #7859</a>.</p>



<a name="419939129"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419939129" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419939129">(Feb 05 2024 at 22:25)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#pullrequestreview-1863939985">PR review</a>.</p>



<a name="419939130"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419939130" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419939130">(Feb 05 2024 at 22:25)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/7859#discussion_r1478993537">PR review comment</a>:</p>
<blockquote>
<p>Good idea! Done.</p>
</blockquote>



<a name="419939888"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419939888" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419939888">(Feb 05 2024 at 22:31)</a>:</h4>
<p>fitzgen has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/7859">PR #7859</a>.</p>



<a name="419946474"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237859%20Cranelift%3A%20Use%20a%20fixpoint%20loop%20to%20com.../near/419946474" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237859.20Cranelift.3A.20Use.20a.20fixpoint.20loop.20to.20com.2E.2E.2E.html#419946474">(Feb 05 2024 at 23:22)</a>:</h4>
<p>fitzgen merged <a href="https://github.com/bytecodealliance/wasmtime/pull/7859">PR #7859</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>