<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #1323 Cranelift: `cranelift_frontend::Sw... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231323.20Cranelift.3A.20.60cranelift_frontend.3A.3ASw.2E.2E.2E.html">wasmtime / Issue #1323 Cranelift: `cranelift_frontend::Sw...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="190575704"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231323%20Cranelift%3A%20%60cranelift_frontend%3A%3ASw.../near/190575704" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231323.20Cranelift.3A.20.60cranelift_frontend.3A.3ASw.2E.2E.2E.html#190575704">(Mar 14 2020 at 02:44)</a>:</h4>
<p>thepowersgang opened <a href="https://github.com/bytecodealliance/wasmtime/issues/1323" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1323">Issue #1323</a>:</p>
<blockquote>
<p>Steps to reproduce:</p>
<ul>
<li>Structure code to seal blocks early (instead of sealing in bulk)</li>
<li>Use <code>cranelift_frontend::Switch</code> to generate a sparse switch such that it generates chained comparisons instead of a jump table.</li>
<li>Observe debug assertion regarding unsealed blocks.</li>
</ul>
<p>Version:</p>
<ul>
<li>As of current HEAD (832666c45ead73fd833ea86da94cacb2f30a530c), there is no reference to <code>seal_block</code> in the <code>switch</code> module. Issue originally seen with <code>v0.58</code> from <code>crates.io</code></li>
</ul>
</blockquote>



<a name="190575705"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231323%20Cranelift%3A%20%60cranelift_frontend%3A%3ASw.../near/190575705" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231323.20Cranelift.3A.20.60cranelift_frontend.3A.3ASw.2E.2E.2E.html#190575705">(Mar 14 2020 at 02:44)</a>:</h4>
<p>thepowersgang labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/1323" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1323">Issue #1323</a>:</p>
<blockquote>
<p>Steps to reproduce:</p>
<ul>
<li>Structure code to seal blocks early (instead of sealing in bulk)</li>
<li>Use <code>cranelift_frontend::Switch</code> to generate a sparse switch such that it generates chained comparisons instead of a jump table.</li>
<li>Observe debug assertion regarding unsealed blocks.</li>
</ul>
<p>Version:</p>
<ul>
<li>As of current HEAD (832666c45ead73fd833ea86da94cacb2f30a530c), there is no reference to <code>seal_block</code> in the <code>switch</code> module. Issue originally seen with <code>v0.58</code> from <code>crates.io</code></li>
</ul>
</blockquote>



<a name="190575706"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231323%20Cranelift%3A%20%60cranelift_frontend%3A%3ASw.../near/190575706" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231323.20Cranelift.3A.20.60cranelift_frontend.3A.3ASw.2E.2E.2E.html#190575706">(Mar 14 2020 at 02:44)</a>:</h4>
<p>thepowersgang labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/1323" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1323">Issue #1323</a>:</p>
<blockquote>
<p>Steps to reproduce:</p>
<ul>
<li>Structure code to seal blocks early (instead of sealing in bulk)</li>
<li>Use <code>cranelift_frontend::Switch</code> to generate a sparse switch such that it generates chained comparisons instead of a jump table.</li>
<li>Observe debug assertion regarding unsealed blocks.</li>
</ul>
<p>Version:</p>
<ul>
<li>As of current HEAD (832666c45ead73fd833ea86da94cacb2f30a530c), there is no reference to <code>seal_block</code> in the <code>switch</code> module. Issue originally seen with <code>v0.58</code> from <code>crates.io</code></li>
</ul>
</blockquote>



<a name="190807436"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231323%20Cranelift%3A%20%60cranelift_frontend%3A%3ASw.../near/190807436" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231323.20Cranelift.3A.20.60cranelift_frontend.3A.3ASw.2E.2E.2E.html#190807436">(Mar 17 2020 at 04:29)</a>:</h4>
<p>teapotd <a href="https://github.com/bytecodealliance/wasmtime/issues/1323#issuecomment-599871655" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1323#issuecomment-599871655">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1323" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1323">Issue #1323</a>:</p>
<blockquote>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Function</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder_ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionBuilderContext</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionBuilder</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">builder_ctx</span><span class="p">);</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="n">block0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">create_block</span><span class="p">();</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">block1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">create_block</span><span class="p">();</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">block2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">create_block</span><span class="p">();</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">block3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">create_block</span><span class="p">();</span><span class="w"></span>

<span class="n">builder</span><span class="p">.</span><span class="n">seal_block</span><span class="p">(</span><span class="n">block0</span><span class="p">);</span><span class="w"></span>
<span class="n">builder</span><span class="p">.</span><span class="n">switch_to_block</span><span class="p">(</span><span class="n">block0</span><span class="p">);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">iconst</span><span class="p">(</span><span class="n">types</span>::<span class="n">I32</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">switch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Switch</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="n">switch</span><span class="p">.</span><span class="n">set_entry</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">block1</span><span class="p">);</span><span class="w"></span>
<span class="n">switch</span><span class="p">.</span><span class="n">set_entry</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">block2</span><span class="p">);</span><span class="w"></span>
<span class="n">switch</span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">block3</span><span class="p">);</span><span class="w"></span>

<span class="k">for</span><span class="w"> </span><span class="o">&amp;</span><span class="n">block</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">block1</span><span class="p">,</span><span class="w"> </span><span class="n">block2</span><span class="p">,</span><span class="w"> </span><span class="n">block3</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">seal_block</span><span class="p">(</span><span class="n">block</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">switch_to_block</span><span class="p">(</span><span class="n">block</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">return_</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[]);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">builder</span><span class="p">.</span><span class="n">finalize</span><span class="p">();</span><span class="w"> </span><span class="c1">// panic: &#39;all blocks should be sealed before dropping a FunctionBuilder&#39;</span>
<span class="n">dbg</span><span class="o">!</span><span class="p">(</span><span class="n">func</span><span class="p">);</span><span class="w"></span>
</pre></div>


<p>This panics in <code>finalize</code>, because <code>Switch</code> generates additional blocks and it doesn't seal them:</p>
<div class="codehilite"><pre><span></span>function u0:0() fast {
block0:
    v0 = iconst.i32 2
    v1 = icmp_imm eq v0, 4
    brnz v1, block2
    jump block4

block4: ; this block is not sealed
    v2 = icmp_imm.i32 eq v0, 2
    brnz v2, block1
    jump block3

block1:
    return

block2:
    return

block3:
    return
}
</pre></div>


<p>An obvious way to fix this issue would be to seal generated blocks when switch is built, but it would break code that seal sections in bulk using <code>seal_all_blocks</code>:</p>
<div class="codehilite"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Function</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder_ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionBuilderContext</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionBuilder</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">builder_ctx</span><span class="p">);</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="n">block0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">create_block</span><span class="p">();</span><span class="w"></span>
<span class="n">builder</span><span class="p">.</span><span class="n">seal_block</span><span class="p">(</span><span class="n">block0</span><span class="p">);</span><span class="w"></span>
<span class="n">builder</span><span class="p">.</span><span class="n">seal_all_blocks</span><span class="p">();</span><span class="w"> </span><span class="c1">// panic: &#39;Attempting to seal block0 which is already sealed.&#39;</span>
</pre></div>


<p>We could change <code>seal_all_blocks</code> to ignore already sealed blocks instead of panicking.</p>
</blockquote>



<a name="191117572"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231323%20Cranelift%3A%20%60cranelift_frontend%3A%3ASw.../near/191117572" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231323.20Cranelift.3A.20.60cranelift_frontend.3A.3ASw.2E.2E.2E.html#191117572">(Mar 19 2020 at 14:07)</a>:</h4>
<p>thepowersgang <a href="https://github.com/bytecodealliance/wasmtime/issues/1323#issuecomment-601198811" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1323#issuecomment-601198811">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1323" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1323">Issue #1323</a>:</p>
<blockquote>
<p>I feel that having <code>Switch::emit</code> (configurably) seal created blocks is the more correct option from a "user" point of view. Needing to call <code>seal_all_blocks</code> just because you used a <code>Switch</code> prevents you from catching cases where you forgot to seal one of your own blocks.</p>
</blockquote>



<a name="195752744"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231323%20Cranelift%3A%20%60cranelift_frontend%3A%3ASw.../near/195752744" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231323.20Cranelift.3A.20.60cranelift_frontend.3A.3ASw.2E.2E.2E.html#195752744">(Apr 29 2020 at 18:42)</a>:</h4>
<p>abrown closed <a href="https://github.com/bytecodealliance/wasmtime/issues/1323" title="https://github.com/bytecodealliance/wasmtime/issues/1323">Issue #1323</a>:</p>
<blockquote>
<p>Steps to reproduce:</p>
<ul>
<li>Structure code to seal blocks early (instead of sealing in bulk)</li>
<li>Use <code>cranelift_frontend::Switch</code> to generate a sparse switch such that it generates chained comparisons instead of a jump table.</li>
<li>Observe debug assertion regarding unsealed blocks.</li>
</ul>
<p>Version:</p>
<ul>
<li>As of current HEAD (832666c45ead73fd833ea86da94cacb2f30a530c), there is no reference to <code>seal_block</code> in the <code>switch</code> module. Issue originally seen with <code>v0.58</code> from <code>crates.io</code></li>
</ul>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>