<html>
<head><meta charset="utf-8"><title>wasmtime / issue #8764 Components: Implementing traits in... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238764.20Components.3A.20Implementing.20traits.20in.2E.2E.2E.html">wasmtime / issue #8764 Components: Implementing traits in...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="443864382"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238764%20Components%3A%20Implementing%20traits%20in.../near/443864382" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238764.20Components.3A.20Implementing.20traits.20in.2E.2E.2E.html#443864382">(Jun 10 2024 at 21:06)</a>:</h4>
<p>MendyBerger opened <a href="https://github.com/bytecodealliance/wasmtime/issues/8764">issue #8764</a>:</p>
<blockquote>
<p>Currently, if you wanna implement the traits generated by <code>component::bindgen</code> in a library that other's are gonna use with custom types, you can't do it on <code>T: YourTrait</code>, you have to implement it on <code>dyn YourTrait</code>. At least that's what I gather from what <a href="https://github.com/bytecodealliance/wasmtime/blob/af59c4d568d487b7efbb49d7d31a861e7c3933a6/crates/wasi-http/src/types_impl.rs#L22">wasi-http</a> is doing.</p>
<p>I'm working on <a href="https://github.com/wasi-gfx/wasi-gfx-runtime">wasi-webgpu</a>, where we'd really like one of our methods to be generic, but generics are not object-safe. Is there any way we can do that?</p>
</blockquote>



<a name="443866582"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238764%20Components%3A%20Implementing%20traits%20in.../near/443866582" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238764.20Components.3A.20Implementing.20traits.20in.2E.2E.2E.html#443866582">(Jun 10 2024 at 21:22)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8764#issuecomment-2159306664">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8764">issue #8764</a>:</p>
<blockquote>
<p>Heh I was actually just talking with others about possibly changing some parts about wasi-http about this. </p>
<p>For your use case would something like this work?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">MyWebgpuWrapper</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="k">pub</span><span class="w"> </span><span class="n">T</span><span class="p">);</span>

<span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">MyWebgpuView</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span><span class="w"> </span><span class="nc">MyWebgpuView</span><span class="o">&gt;</span><span class="w"> </span><span class="n">bindings</span><span class="p">::</span><span class="n">wasi</span><span class="p">::</span><span class="n">webgpu</span><span class="p">::</span><span class="n">interface</span><span class="p">::</span><span class="n">Host</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyWebgpuWrapper</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">add_to_linker</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span><span class="w"> </span><span class="nc">MyWebgpuView</span><span class="o">&gt;</span><span class="p">(</span><span class="n">linker</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Linker</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* ... */</span>
<span class="p">}</span>
</code></pre></div>
<p>Basically having a newtype wrapper locally which is used internally in <code>add_to_linker</code> as a temporary value?</p>
</blockquote>



<a name="443868588"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238764%20Components%3A%20Implementing%20traits%20in.../near/443868588" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238764.20Components.3A.20Implementing.20traits.20in.2E.2E.2E.html#443868588">(Jun 10 2024 at 21:38)</a>:</h4>
<p>MendyBerger <a href="https://github.com/bytecodealliance/wasmtime/issues/8764#issuecomment-2159328041">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8764">issue #8764</a>:</p>
<blockquote>
<p>Not sure I understand how this would work. <br>
Wouldn't this require the consumer of the wasi-webgpu library to implement <code>Host</code> manually? Or do you mean that all of this would be in library code?</p>
</blockquote>



<a name="443870415"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238764%20Components%3A%20Implementing%20traits%20in.../near/443870415" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238764.20Components.3A.20Implementing.20traits.20in.2E.2E.2E.html#443870415">(Jun 10 2024 at 21:52)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8764#issuecomment-2159351722">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8764">issue #8764</a>:</p>
<blockquote>
<p>Oh the wasi-webgpu library would have impls that look like </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span><span class="w"> </span><span class="nc">MyWebgpuView</span><span class="o">&gt;</span><span class="w"> </span><span class="n">bindings</span><span class="p">::</span><span class="n">wasi</span><span class="p">::</span><span class="n">webgpu</span><span class="p">::</span><span class="n">interface</span><span class="p">::</span><span class="n">Host</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyWebgpuWrapper</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
</code></pre></div>
<p>so users wouldn't need to implement <code>Host</code> themselves. They only need to construct <code>MyWebgpuWrapper&lt;T&gt;</code> which is probably <code>MyWebgpuWrapper(&amp;mut my_stuff)</code></p>
<p>Also, to confirm, you're looking to provide a small trait of methods and then from that small trait of methods all other methods are implemented? That's what wasmtime-wasi/wasmtime-wasi-http are doing but if you're not leap frogging traits like this then most of this infrastructure isn't necessary<br>
</p>
</blockquote>



<a name="443895965"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238764%20Components%3A%20Implementing%20traits%20in.../near/443895965" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238764.20Components.3A.20Implementing.20traits.20in.2E.2E.2E.html#443895965">(Jun 11 2024 at 01:26)</a>:</h4>
<p>MendyBerger <a href="https://github.com/bytecodealliance/wasmtime/issues/8764#issuecomment-2159595343">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8764">issue #8764</a>:</p>
<blockquote>
<p>Oh! I think I see it now!<br>
<code>Host</code> is implemented for a concrete type. And the concrete implementation won't conflict with the auto generated <code>&amp;mut T</code> implementations because of the wrapper. Brilliant idea!<br>
Let me check if I can get this to work.</p>
</blockquote>



<a name="444054324"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238764%20Components%3A%20Implementing%20traits%20in.../near/444054324" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238764.20Components.3A.20Implementing.20traits.20in.2E.2E.2E.html#444054324">(Jun 11 2024 at 16:59)</a>:</h4>
<p>MendyBerger <a href="https://github.com/bytecodealliance/wasmtime/issues/8764#issuecomment-2161226934">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8764">issue #8764</a>:</p>
<blockquote>
<p>@alexcrichton I was able to get it to work, thanks for the help!</p>
<p>I modeled it like <a href="https://github.com/bytecodealliance/wasmtime/blob/b7aacfc8728b6891bd934a4c5a85d19c47ec7b6b/crates/wasi-http/src/types.rs#L159">wasi-http</a> which seems to be doing the same thing.</p>
<p>It took me a couple of hours to figure this out though. Would it be possible for <code>bindgen!</code> to generate all the plumbing, and just expose a ready to use <code>WasiFooImpl</code> and <code>add_to_linker</code>?<br>
Figuring out exactly what needs to go in the <code>add_to_linker</code> like the <code>type_annotate</code>, as well as the requirement to implement <code>WasiFooView</code> on <code>WasiFooImpl</code>, <code>&amp;mut T: WasiFooView</code>, and <code>Box&lt;T: WasiFooView&gt;</code> is a lot of work.<br>
</p>
</blockquote>



<a name="444079564"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238764%20Components%3A%20Implementing%20traits%20in.../near/444079564" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238764.20Components.3A.20Implementing.20traits.20in.2E.2E.2E.html#444079564">(Jun 11 2024 at 19:14)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8764#issuecomment-2161442929">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8764">issue #8764</a>:</p>
<blockquote>
<p>Hm unfortuantely I don't think so. The <code>WasiView</code> trait is a handwritten trait and has no means of being automatically derived. Furthermore all implementations of the <code>Host</code> traits are implemented in terms of <code>WasiView</code> and additionally can't be auto-derived. For the same reasons nothing can auto-derive the impls and such too.</p>
<p>I'll also reiterate though that none of this is ideally necessary. I'd much rather have, for example <code>Host for WasiCtx</code> for all of WASI or something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">WasiTemp</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">table</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span><span class="w"> </span><span class="nc">mut</span><span class="w"> </span><span class="n">ResourceTable</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">ctx</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span><span class="w"> </span><span class="nc">mut</span><span class="w"> </span><span class="n">WasiCtx</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">WasiTemp</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>
<p>Or put another way I'd much rather to have <code>Host</code> for concrete types. The only reason <code>WasiView</code> exists is to mirror the design of <code>WasiHttpView</code> and the only reason that exists is the various trait methods it has for customizing how a request is dispatched for example. If you can get away with it I'd recommend not using a <code>*View</code> triat entirely and instead using a configuration context of some kind and everything is implemented in terms of that context.</p>
</blockquote>



<a name="444097933"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238764%20Components%3A%20Implementing%20traits%20in.../near/444097933" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238764.20Components.3A.20Implementing.20traits.20in.2E.2E.2E.html#444097933">(Jun 11 2024 at 20:46)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/issues/8764#issuecomment-2161577010">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8764">issue #8764</a>:</p>
<blockquote>
<p>I think historically <code>WasiView</code> came before <code>WasiHttpView</code>, opposite of what your example is, but no matter. The real unfortunate necessity for all of this machinery is that all* bindings implementations on a store need to share the same <code>ResourceTable</code>, but have their own Ctx type for "everything else": WasiCtx, WasiHttpCtx, WebGpuCtx etc. The best way we came up with in wasmtime-wasi and wasmtime-wasi-http is to have a trait where you can borrow either the ctx or the table mutably, but it would work just as well with a struct like Alex describes where each of those mut borrows is a member of the struct.</p>
<ul>
<li>well, technically only bindings implementations that have resource types in common, but in practice everything of nontrivial complexity needs a pollable or stream at some point, so effectively its all bindings</li>
</ul>
</blockquote>



<a name="444141532"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238764%20Components%3A%20Implementing%20traits%20in.../near/444141532" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238764.20Components.3A.20Implementing.20traits.20in.2E.2E.2E.html#444141532">(Jun 12 2024 at 03:56)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8764#issuecomment-2162056630">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8764">issue #8764</a>:</p>
<blockquote>
<p>Ah yes true! One thing I'll also point out is that we haven't historically done something like <code>WasiTemp&lt;'a&gt;</code> because that wasn't possible until <a href="https://github.com/bytecodealliance/wasmtime/pull/8448">https://github.com/bytecodealliance/wasmtime/pull/8448</a> landed. Now with that we could in theory move all WASI bits, but the customization bits that use a trait still necessitate otherwise. </p>
<p>That being said a better yet design from what we have now, perhaps for wasi-http, would be to have <code>WasiHttpCtx&lt;T&gt;</code> where <code>T: WasiHttpImplTrait</code> where it's not the same as <code>WasiView</code> but just the customization methods. That way we could in fact use <code>WasiTemp&lt;'a&gt;</code> or something similar.</p>
</blockquote>



<a name="445216319"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238764%20Components%3A%20Implementing%20traits%20in.../near/445216319" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238764.20Components.3A.20Implementing.20traits.20in.2E.2E.2E.html#445216319">(Jun 17 2024 at 20:13)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/8764">issue #8764</a>:</p>
<blockquote>
<p>Currently, if you wanna implement the traits generated by <code>component::bindgen</code> in a library that other's are gonna use with custom types, you can't do it on <code>T: YourTrait</code>, you have to implement it on <code>dyn YourTrait</code>. At least that's what I gather from what <a href="https://github.com/bytecodealliance/wasmtime/blob/af59c4d568d487b7efbb49d7d31a861e7c3933a6/crates/wasi-http/src/types_impl.rs#L22">wasi-http</a> is doing.</p>
<p>I'm working on <a href="https://github.com/wasi-gfx/wasi-gfx-runtime">wasi-webgpu</a>, where we'd really like one of our methods to be generic, but generics are not object-safe. Is there any way we can do that?</p>
</blockquote>



<a name="445216320"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238764%20Components%3A%20Implementing%20traits%20in.../near/445216320" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238764.20Components.3A.20Implementing.20traits.20in.2E.2E.2E.html#445216320">(Jun 17 2024 at 20:13)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8764#issuecomment-2174340991">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8764">issue #8764</a>:</p>
<blockquote>
<p>I think this has been answered now so I'm going to close this, but if there are any lingering questions/clarifications feel free to comment and/or open a new issue.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>