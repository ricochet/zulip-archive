<html>
<head><meta charset="utf-8"><title>wasmtime / issue #5261 Shrink the size of SigData in Cran... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235261.20Shrink.20the.20size.20of.20SigData.20in.20Cran.2E.2E.2E.html">wasmtime / issue #5261 Shrink the size of SigData in Cran...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="309534296"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235261%20Shrink%20the%20size%20of%20SigData%20in%20Cran.../near/309534296" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235261.20Shrink.20the.20size.20of.20SigData.20in.20Cran.2E.2E.2E.html#309534296">(Nov 14 2022 at 05:33)</a>:</h4>
<p>tnachen <a href="https://github.com/bytecodealliance/wasmtime/pull/5261#issuecomment-1313121212">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5261">issue #5261</a>:</p>
<blockquote>
<p>@fitzgen </p>
</blockquote>



<a name="309910836"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235261%20Shrink%20the%20size%20of%20SigData%20in%20Cran.../near/309910836" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235261.20Shrink.20the.20size.20of.20SigData.20in.20Cran.2E.2E.2E.html#309910836">(Nov 14 2022 at 17:22)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/pull/5261#issuecomment-1314115951">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5261">issue #5261</a>:</p>
<blockquote>
<p>Glancing at this, is there a test out there that checks the size of <code>SigData</code>? I have found that kind of test helpful in other parts of this project.</p>
</blockquote>



<a name="309922787"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235261%20Shrink%20the%20size%20of%20SigData%20in%20Cran.../near/309922787" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235261.20Shrink.20the.20size.20of.20SigData.20in.20Cran.2E.2E.2E.html#309922787">(Nov 14 2022 at 18:24)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/5261#issuecomment-1314195019">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5261">issue #5261</a>:</p>
<blockquote>
<p>I don't see an existing test for the size of <code>SigData</code>, no. I'm not entirely convinced we're doing the right thing with the existing tests—the fact that the most recent rustc upgrade broke one of the tests by doing a better job of laying out one of our structs makes me think maybe that's not exactly what we should be testing. But I don't have a better idea at the moment, and it's reassuring to know that at least we'll find out if the sizes change.</p>
</blockquote>



<a name="310068841"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235261%20Shrink%20the%20size%20of%20SigData%20in%20Cran.../near/310068841" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235261.20Shrink.20the.20size.20of.20SigData.20in.20Cran.2E.2E.2E.html#310068841">(Nov 14 2022 at 19:49)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/pull/5261#issuecomment-1314289134">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5261">issue #5261</a>:</p>
<blockquote>
<blockquote>
<p>... and it's reassuring to know that at least we'll find out if the sizes change.</p>
</blockquote>
<p>Yeah, exactly. If such a test is too brittle across OSes or compiler versions for some reason then it doesn't make sense. But a general reassurance has been nice with, e.g., instruction data.</p>
</blockquote>



<a name="310134307"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235261%20Shrink%20the%20size%20of%20SigData%20in%20Cran.../near/310134307" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235261.20Shrink.20the.20size.20of.20SigData.20in.20Cran.2E.2E.2E.html#310134307">(Nov 15 2022 at 06:21)</a>:</h4>
<p>tnachen <a href="https://github.com/bytecodealliance/wasmtime/pull/5261#issuecomment-1314829861">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5261">issue #5261</a>:</p>
<blockquote>
<p>Thanks @jameysharp for the review! Updated based on comments, let me know if a test makes sense here (though as mentioned seems like the results will differ)</p>
</blockquote>



<a name="310246006"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235261%20Shrink%20the%20size%20of%20SigData%20in%20Cran.../near/310246006" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235261.20Shrink.20the.20size.20of.20SigData.20in.20Cran.2E.2E.2E.html#310246006">(Nov 15 2022 at 17:03)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/5261#issuecomment-1315611396">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5261">issue #5261</a>:</p>
<blockquote>
<p>I think it would be useful to have a test for <code>SigData</code>'s size, but at the same time, I'm not expecting you to add it unless you want to.</p>
<p>If you do want to write that test, I think we should replace the one use of <code>usize</code> (the <code>stack_ret_arg</code> field) with a type whose size doesn't depend on the target's pointer size. That way the test doesn't depend on which target we're compiling for. Then it should only change when the Rust compiler changes its ABI, which is infrequent enough that we can deal with it.</p>
<p>Given the other changes in this PR, I think giving that field the type <code>Option&lt;u16&gt;</code> ought to work fine, since it's an index into the arguments. As a bonus, that's a substantial improvement in size:</p>
<ul>
<li>On a 64-bit target, <code>Option&lt;usize&gt;</code> is 16 bytes, while <code>Option&lt;u16&gt;</code> is only 4 bytes.</li>
<li>Because <code>SigData</code> currently requires 8-byte alignment, it has 7 bytes of padding after the 1-byte <code>call_conv</code> field, so those 4 bytes can fit in the existing padding.</li>
<li>And that means this change would shrink <code>SigData</code> by 16 bytes, on top of the 8 bytes you've already cut with this PR.</li>
</ul>
<p>None of that is necessary for merging this PR. If you'd like to make these additional changes in this PR, feel free. If you want me to merge this PR as-is, let me know and I'm happy to do that (after the remaining <code>usize::from</code> change). These additional changes would make a good follow-up PR too.</p>
</blockquote>



<a name="310261281"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235261%20Shrink%20the%20size%20of%20SigData%20in%20Cran.../near/310261281" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235261.20Shrink.20the.20size.20of.20SigData.20in.20Cran.2E.2E.2E.html#310261281">(Nov 15 2022 at 18:19)</a>:</h4>
<p>tnachen <a href="https://github.com/bytecodealliance/wasmtime/pull/5261#issuecomment-1315699536">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5261">issue #5261</a>:</p>
<blockquote>
<p>@jameysharp sounds good I'll make these changes! seems like it's simple enough. In the mean time just ran the benchmark -&gt;</p>
<div class="codehilite"><pre><span></span><code> Running `target/release/sightglass-cli benchmark -e /tmp/main.so -e /tmp/smaller-sig-data.so --stop-after compilation -- benchmarks/default.suite`
</code></pre></div>

<p>compilation :: cycles :: benchmarks/spidermonkey/benchmark.wasm</p>
<p>Δ = 460930934.38 ± 351410455.73 (confidence = 99%)</p>
<p><a href="http://smaller-sig-data.so">smaller-sig-data.so</a> is 1.01x to 1.07x faster than <a href="http://main.so">main.so</a>!</p>
<p>[11432848277 12881522406.46 16050235396] <a href="http://main.so">main.so</a><br>
  [11050769166 12420591472.08 15404617502] <a href="http://smaller-sig-data.so">smaller-sig-data.so</a></p>
<p>compilation :: cycles :: benchmarks/pulldown-cmark/benchmark.wasm</p>
<p>No difference in performance.</p>
<p>[524369235 620830497.53 829897789] <a href="http://main.so">main.so</a><br>
  [492571419 606893937.78 868345984] <a href="http://smaller-sig-data.so">smaller-sig-data.so</a></p>
<p>compilation :: cycles :: benchmarks/bz2/benchmark.wasm</p>
<p>No difference in performance.</p>
<p>[324283951 399934581.50 681479969] <a href="http://main.so">main.so</a><br>
  [306842933 394721779.72 550360275] <a href="http://smaller-sig-data.so">smaller-sig-data.so</a></p>
</blockquote>



<a name="310262316"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235261%20Shrink%20the%20size%20of%20SigData%20in%20Cran.../near/310262316" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235261.20Shrink.20the.20size.20of.20SigData.20in.20Cran.2E.2E.2E.html#310262316">(Nov 15 2022 at 18:24)</a>:</h4>
<p>fitzgen edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/5261#issuecomment-1315699536">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5261">issue #5261</a>:</p>
<blockquote>
<p>@jameysharp sounds good I'll make these changes! seems like it's simple enough. In the mean time just ran the benchmark -&gt;</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">sightglass</span><span class="o">-</span><span class="n">cli</span><span class="w"> </span><span class="n">benchmark</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">smaller</span><span class="o">-</span><span class="n">sig</span><span class="o">-</span><span class="n">data</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="o">--</span><span class="n">stop</span><span class="o">-</span><span class="n">after</span><span class="w"> </span><span class="n">compilation</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">benchmarks</span><span class="o">/</span><span class="n">default</span><span class="p">.</span><span class="n">suite</span><span class="err">`</span><span class="w"></span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">460930934.38</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">351410455.73</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">smaller</span><span class="o">-</span><span class="n">sig</span><span class="o">-</span><span class="n">data</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.01</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.07</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="o">!</span><span class="w"></span>

<span class="w">  </span><span class="p">[</span><span class="mi">11432848277</span><span class="w"> </span><span class="mf">12881522406.46</span><span class="w"> </span><span class="mi">16050235396</span><span class="p">]</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">11050769166</span><span class="w"> </span><span class="mf">12420591472.08</span><span class="w"> </span><span class="mi">15404617502</span><span class="p">]</span><span class="w"> </span><span class="n">smaller</span><span class="o">-</span><span class="n">sig</span><span class="o">-</span><span class="n">data</span><span class="p">.</span><span class="n">so</span><span class="w"></span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>

<span class="w">  </span><span class="n">No</span><span class="w"> </span><span class="n">difference</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">performance</span><span class="p">.</span><span class="w"></span>

<span class="w">  </span><span class="p">[</span><span class="mi">524369235</span><span class="w"> </span><span class="mf">620830497.53</span><span class="w"> </span><span class="mi">829897789</span><span class="p">]</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">492571419</span><span class="w"> </span><span class="mf">606893937.78</span><span class="w"> </span><span class="mi">868345984</span><span class="p">]</span><span class="w"> </span><span class="n">smaller</span><span class="o">-</span><span class="n">sig</span><span class="o">-</span><span class="n">data</span><span class="p">.</span><span class="n">so</span><span class="w"></span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>

<span class="w">  </span><span class="n">No</span><span class="w"> </span><span class="n">difference</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">performance</span><span class="p">.</span><span class="w"></span>

<span class="w">  </span><span class="p">[</span><span class="mi">324283951</span><span class="w"> </span><span class="mf">399934581.50</span><span class="w"> </span><span class="mi">681479969</span><span class="p">]</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">306842933</span><span class="w"> </span><span class="mf">394721779.72</span><span class="w"> </span><span class="mi">550360275</span><span class="p">]</span><span class="w"> </span><span class="n">smaller</span><span class="o">-</span><span class="n">sig</span><span class="o">-</span><span class="n">data</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="310262581"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235261%20Shrink%20the%20size%20of%20SigData%20in%20Cran.../near/310262581" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235261.20Shrink.20the.20size.20of.20SigData.20in.20Cran.2E.2E.2E.html#310262581">(Nov 15 2022 at 18:26)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/5261#issuecomment-1315705978">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5261">issue #5261</a>:</p>
<blockquote>
<blockquote>
<p>just ran the benchmark</p>
</blockquote>
<p>Great results! 1-7% faster compilation times for <code>spidermonkey.wasm</code> is nothing to sneeze at!</p>
<p>And this is before the further shrinking with the <code>stack_ret_arg</code> field, correct?</p>
</blockquote>



<a name="310462209"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235261%20Shrink%20the%20size%20of%20SigData%20in%20Cran.../near/310462209" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235261.20Shrink.20the.20size.20of.20SigData.20in.20Cran.2E.2E.2E.html#310462209">(Nov 16 2022 at 17:36)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/5261#issuecomment-1317401944">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5261">issue #5261</a>:</p>
<blockquote>
<p>The newest commit ("Change ret arg length to u16") looks good! CI says you need to run <code>cargo fmt</code>, but this is otherwise ready to merge.</p>
<p>I think I did my math wrong before: the original version of the PR should have reduced the size of <code>SigData</code> by 4 bytes (2<em><code>u32</code>-2</em><code>u16</code>), not 8. This version replaces 2<em><code>usize</code> with 2</em><code>u16</code>, which means now we have 4 <code>u16</code>-aligned fields, so nothing fits into the 7 existing bytes of padding. Oh well.</p>
<p>If you want to add a test for this now, the following should work, assuming I did my math right this time. <code>SigData</code> is currently 56 bytes (according to <a href="https://github.com/gimli-rs/ddbug">ddbug</a>) and I believe you've reduced it to 40 bytes.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[test]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">sig_data_size</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// The size of `SigData` is performance sensitive, so make sure</span>
<span class="w">    </span><span class="c1">// we don't regress it unintentionally.</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">SigData</span><span class="o">&gt;</span><span class="p">(),</span><span class="w"> </span><span class="mi">40</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I copied this from the test for <code>InstructionData</code> in <code>cranelift/codegen/src/ir/instructions.rs</code>, but you can find many examples with <code>git grep 'assert.*size_of::'</code>.</p>
</blockquote>



<a name="310519562"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235261%20Shrink%20the%20size%20of%20SigData%20in%20Cran.../near/310519562" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235261.20Shrink.20the.20size.20of.20SigData.20in.20Cran.2E.2E.2E.html#310519562">(Nov 16 2022 at 23:20)</a>:</h4>
<p>tnachen <a href="https://github.com/bytecodealliance/wasmtime/pull/5261#issuecomment-1317807463">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5261">issue #5261</a>:</p>
<blockquote>
<p>@jameysharp oh awesome! Thanks for the example, not sure what else I should add so I just copied what you have into the test code.</p>
<p>Ran the benchmark and got this -&gt;</p>
<p>Running <code>target/release/sightglass-cli benchmark -e /tmp/main.so -e /tmp/smaller-sig-data.so --stop-after compilation -- benchmarks/default.suite</code></p>
<p>compilation :: cycles :: benchmarks/pulldown-cmark/benchmark.wasm</p>
<p>Δ = 108117568.68 ± 43286306.96 (confidence = 99%)</p>
<p><a href="http://smaller-sig-data.so">smaller-sig-data.so</a> is 1.12x to 1.27x faster than <a href="http://main.so">main.so</a>!</p>
<p>[499997365 671467058.89 1397732830] <a href="http://main.so">main.so</a><br>
  [483578441 563349490.21 708900294] <a href="http://smaller-sig-data.so">smaller-sig-data.so</a></p>
<p>compilation :: cycles :: benchmarks/bz2/benchmark.wasm</p>
<p>Δ = 44610760.31 ± 31993506.80 (confidence = 99%)</p>
<p><a href="http://smaller-sig-data.so">smaller-sig-data.so</a> is 1.03x to 1.20x faster than <a href="http://main.so">main.so</a>!</p>
<p>[304879457 426284282.91 661512654] <a href="http://main.so">main.so</a><br>
  [296608459 381673522.60 829079445] <a href="http://smaller-sig-data.so">smaller-sig-data.so</a></p>
<p>compilation :: cycles :: benchmarks/spidermonkey/benchmark.wasm</p>
<p>No difference in performance.</p>
<p>[10560613802 11918560571.18 15092693358] <a href="http://main.so">main.so</a><br>
  [9949435804 11698203046.57 14045075735] <a href="http://smaller-sig-data.so">smaller-sig-data.so</a></p>
</blockquote>



<a name="310519857"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235261%20Shrink%20the%20size%20of%20SigData%20in%20Cran.../near/310519857" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235261.20Shrink.20the.20size.20of.20SigData.20in.20Cran.2E.2E.2E.html#310519857">(Nov 16 2022 at 23:22)</a>:</h4>
<p>fitzgen edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/5261#issuecomment-1317807463">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5261">issue #5261</a>:</p>
<blockquote>
<p>@jameysharp oh awesome! Thanks for the example, not sure what else I should add so I just copied what you have into the test code.</p>
<p>Ran the benchmark and got this -&gt;</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">sightglass</span><span class="o">-</span><span class="n">cli</span><span class="w"> </span><span class="n">benchmark</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">smaller</span><span class="o">-</span><span class="n">sig</span><span class="o">-</span><span class="n">data</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="o">--</span><span class="n">stop</span><span class="o">-</span><span class="n">after</span><span class="w"> </span><span class="n">compilation</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">benchmarks</span><span class="o">/</span><span class="n">default</span><span class="p">.</span><span class="n">suite</span><span class="err">`</span><span class="w"></span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">108117568.68</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">43286306.96</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">smaller</span><span class="o">-</span><span class="n">sig</span><span class="o">-</span><span class="n">data</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.12</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.27</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="o">!</span><span class="w"></span>

<span class="w">  </span><span class="p">[</span><span class="mi">499997365</span><span class="w"> </span><span class="mf">671467058.89</span><span class="w"> </span><span class="mi">1397732830</span><span class="p">]</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">483578441</span><span class="w"> </span><span class="mf">563349490.21</span><span class="w"> </span><span class="mi">708900294</span><span class="p">]</span><span class="w"> </span><span class="n">smaller</span><span class="o">-</span><span class="n">sig</span><span class="o">-</span><span class="n">data</span><span class="p">.</span><span class="n">so</span><span class="w"></span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">44610760.31</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">31993506.80</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">smaller</span><span class="o">-</span><span class="n">sig</span><span class="o">-</span><span class="n">data</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.03</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.20</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="o">!</span><span class="w"></span>

<span class="w">  </span><span class="p">[</span><span class="mi">304879457</span><span class="w"> </span><span class="mf">426284282.91</span><span class="w"> </span><span class="mi">661512654</span><span class="p">]</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">296608459</span><span class="w"> </span><span class="mf">381673522.60</span><span class="w"> </span><span class="mi">829079445</span><span class="p">]</span><span class="w"> </span><span class="n">smaller</span><span class="o">-</span><span class="n">sig</span><span class="o">-</span><span class="n">data</span><span class="p">.</span><span class="n">so</span><span class="w"></span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>

<span class="w">  </span><span class="n">No</span><span class="w"> </span><span class="n">difference</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">performance</span><span class="p">.</span><span class="w"></span>

<span class="w">  </span><span class="p">[</span><span class="mi">10560613802</span><span class="w"> </span><span class="mf">11918560571.18</span><span class="w"> </span><span class="mi">15092693358</span><span class="p">]</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">9949435804</span><span class="w"> </span><span class="mf">11698203046.57</span><span class="w"> </span><span class="mi">14045075735</span><span class="p">]</span><span class="w"> </span><span class="n">smaller</span><span class="o">-</span><span class="n">sig</span><span class="o">-</span><span class="n">data</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>