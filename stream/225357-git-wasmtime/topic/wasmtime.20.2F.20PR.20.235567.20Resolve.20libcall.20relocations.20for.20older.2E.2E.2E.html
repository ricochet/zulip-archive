<html>
<head><meta charset="utf-8"><title>wasmtime / PR #5567 Resolve libcall relocations for older... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235567.20Resolve.20libcall.20relocations.20for.20older.2E.2E.2E.html">wasmtime / PR #5567 Resolve libcall relocations for older...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="321053429"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235567%20Resolve%20libcall%20relocations%20for%20older.../near/321053429" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235567.20Resolve.20libcall.20relocations.20for.20older.2E.2E.2E.html#321053429">(Jan 12 2023 at 23:20)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/5567">PR #5567</a> from <code>libcalls</code> to <code>main</code>:</p>
<blockquote>
<p>Long ago Wasmtime used to have logic for resolving relocations post-compilation for libcalls which I ended up removing during refactorings last year. As #5563 points out, however, it's possible to get Wasmtime to panic by disabling SSE features which forces Cranelift to use libcalls for some floating-point operations instead. Note that this also requires disabling SIMD because SIMD support has a baseline of SSE 4.2.</p>
<p>This commit pulls back the old implementations of various libcalls and reimplements logic necessary to have them work on CPUs without SSE 4.2</p>
<p>Closes #5563</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="321053438"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235567%20Resolve%20libcall%20relocations%20for%20older.../near/321053438" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235567.20Resolve.20libcall.20relocations.20for.20older.2E.2E.2E.html#321053438">(Jan 12 2023 at 23:20)</a>:</h4>
<p><strong>alexcrichton</strong> has marked <a href="https://github.com/bytecodealliance/wasmtime/pull/5567">PR #5567</a> as ready for review.</p>



<a name="321249423"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235567%20Resolve%20libcall%20relocations%20for%20older.../near/321249423" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235567.20Resolve.20libcall.20relocations.20for.20older.2E.2E.2E.html#321249423">(Jan 13 2023 at 20:18)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5567#pullrequestreview-1248360106">PR review</a>.</p>



<a name="321249424"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235567%20Resolve%20libcall%20relocations%20for%20older.../near/321249424" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235567.20Resolve.20libcall.20relocations.20for.20older.2E.2E.2E.html#321249424">(Jan 13 2023 at 20:18)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5567#pullrequestreview-1248360106">PR review</a>.</p>



<a name="321249425"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235567%20Resolve%20libcall%20relocations%20for%20older.../near/321249425" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235567.20Resolve.20libcall.20relocations.20for.20older.2E.2E.2E.html#321249425">(Jan 13 2023 at 20:18)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5567#discussion_r1069982358">PR review comment</a>:</p>
<blockquote>
<p>It'd be nice if there was a good way to share these implementations of <code>round_ties_even</code> with the ones in <code>cranelift/codegen/src/ir/immediates.rs</code>. None come to my mind off-hand since the runtime can be built in a configuration without the compiler, but it'd be nice.</p>
<p>The existing version there doesn't have the "Check for NaNs" section that this version does. I haven't thought hard enough about this to understand what that's for, but maybe you could add a comment linking to some reference for why this is the right implementation?</p>
<p>The existing version does have a link to <a href="https://github.com/rust-lang/rust/issues/96710">rust-lang/rust#96710</a> which I think is worth copying here.</p>
</blockquote>



<a name="321249426"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235567%20Resolve%20libcall%20relocations%20for%20older.../near/321249426" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235567.20Resolve.20libcall.20relocations.20for.20older.2E.2E.2E.html#321249426">(Jan 13 2023 at 20:18)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5567#discussion_r1069931106">PR review comment</a>:</p>
<blockquote>
<p>Minor typo:</p>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>            /// Returns the libcall corresponding to the provided symbol name,
</code></pre></div><br>
</p>
</blockquote>



<a name="321249427"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235567%20Resolve%20libcall%20relocations%20for%20older.../near/321249427" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235567.20Resolve.20libcall.20relocations.20for.20older.2E.2E.2E.html#321249427">(Jan 13 2023 at 20:18)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5567#discussion_r1069965120">PR review comment</a>:</p>
<blockquote>
<p>Even after reading the above comment several times I still had a hard time figuring out that these calls to <code>arbitrary()</code> can't be moved into the loop.</p>
<p>How about something like this to avoid having to keep two lists of feature names in sync, and hopefully make it less tempting to inline the variables into the loop?</p>
<div class="codehilite" data-code-language="suggestion"><pre><span></span><code>            let new_flags = ["has_sse3", "has_ssse3", "has_sse41", "has_sse42"]
                .into_iter()
                .map(|name| (name, u.arbitrary()?))
                .collect::&lt;arbitrary::Result&lt;HashMap&lt;&amp;'static str, bool&gt;&gt;()?;

            for (name, val) in flags {
                if let Some(new_value) = new_flags.get(name) {
                    *val = new_value.to_string();
                }
            }
</code></pre></div>
<p>Also, I think this is okay, but just to check: Each of these features implies the previous one (e.g. if you have SSE4.2 you also have SSE4.1). Is it okay to turn some off without turning off later ones?</p>
</blockquote>



<a name="321872534"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235567%20Resolve%20libcall%20relocations%20for%20older.../near/321872534" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235567.20Resolve.20libcall.20relocations.20for.20older.2E.2E.2E.html#321872534">(Jan 17 2023 at 16:32)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/5567#discussion_r1072436246">PR review comment</a>:</p>
<blockquote>
<blockquote>
<p>Is it okay to turn some off without turning off later ones?</p>
</blockquote>
<p>While I'm not 100% certain myself I believe that this question is up to Cranelift mostly. I believe Cranelift is mostly structured around "if this feature is active emit this instr" while it doesn't make sense to disable sse3 but leave sse4.1 enabled I don't think it will break anything since it would be a sort of "chaos mode" for cranelift stressing it.</p>
<p>If this becomes a problem for Cranelift, however, we can tweak the fuzz input to respect what the actual CPU feature hierarchy is.</p>
</blockquote>



<a name="321872535"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235567%20Resolve%20libcall%20relocations%20for%20older.../near/321872535" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235567.20Resolve.20libcall.20relocations.20for.20older.2E.2E.2E.html#321872535">(Jan 17 2023 at 16:32)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5567#pullrequestreview-1251945816">PR review</a>.</p>



<a name="321880854"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235567%20Resolve%20libcall%20relocations%20for%20older.../near/321880854" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235567.20Resolve.20libcall.20relocations.20for.20older.2E.2E.2E.html#321880854">(Jan 17 2023 at 17:08)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5567">PR #5567</a> from <code>libcalls</code> to <code>main</code>.</p>



<a name="321880944"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235567%20Resolve%20libcall%20relocations%20for%20older.../near/321880944" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235567.20Resolve.20libcall.20relocations.20for.20older.2E.2E.2E.html#321880944">(Jan 17 2023 at 17:09)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5567">PR #5567</a> from <code>libcalls</code> to <code>main</code>.</p>



<a name="321881286"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235567%20Resolve%20libcall%20relocations%20for%20older.../near/321881286" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235567.20Resolve.20libcall.20relocations.20for.20older.2E.2E.2E.html#321881286">(Jan 17 2023 at 17:10)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5567#pullrequestreview-1252058144">PR review</a>.</p>



<a name="321881288"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235567%20Resolve%20libcall%20relocations%20for%20older.../near/321881288" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235567.20Resolve.20libcall.20relocations.20for.20older.2E.2E.2E.html#321881288">(Jan 17 2023 at 17:10)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/5567#discussion_r1072494469">PR review comment</a>:</p>
<blockquote>
<p>These libcalls were removed in <a href="https://github.com/bytecodealliance/wasmtime/pull/4470">https://github.com/bytecodealliance/wasmtime/pull/4470</a> and I copied their source from just before that commit. </p>
<p>Apparently <code>nearest</code> has a slightly storied history:</p>
<ul>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/2219">https://github.com/bytecodealliance/wasmtime/pull/2219</a> fixed it for NaN cases </li>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/2171">https://github.com/bytecodealliance/wasmtime/pull/2171</a> made the implementation more efficient based on musl</li>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/34">https://github.com/bytecodealliance/wasmtime/pull/34</a> was the original implementation</li>
</ul>
<p>I ran <code>cargo run wast ./tests/spec_testsuite/f32.wast --cranelift-set has_sse41=false --wasm-features=-simd</code> and commented out the "Check for NaNs" block and the tests failed, so the block is definitely load-bearing. That may mean that Cranelift's implementation needs to be updated to account for NaN's perhaps? (I don't really understand the actual underlying code here I'm just copying bytes)</p>
</blockquote>



<a name="321935716"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235567%20Resolve%20libcall%20relocations%20for%20older.../near/321935716" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235567.20Resolve.20libcall.20relocations.20for.20older.2E.2E.2E.html#321935716">(Jan 17 2023 at 22:12)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5567#pullrequestreview-1252533402">PR review</a>.</p>



<a name="322074296"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235567%20Resolve%20libcall%20relocations%20for%20older.../near/322074296" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235567.20Resolve.20libcall.20relocations.20for.20older.2E.2E.2E.html#322074296">(Jan 18 2023 at 15:04)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/5567">PR #5567</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>