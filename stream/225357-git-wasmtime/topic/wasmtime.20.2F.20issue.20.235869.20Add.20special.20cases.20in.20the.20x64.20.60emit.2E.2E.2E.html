<html>
<head><meta charset="utf-8"><title>wasmtime / issue #5869 Add special cases in the x64 `emit... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235869.20Add.20special.20cases.20in.20the.20x64.20.60emit.2E.2E.2E.html">wasmtime / issue #5869 Add special cases in the x64 `emit...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="329798113"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235869%20Add%20special%20cases%20in%20the%20x64%20%60emit.../near/329798113" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235869.20Add.20special.20cases.20in.20the.20x64.20.60emit.2E.2E.2E.html#329798113">(Feb 23 2023 at 19:06)</a>:</h4>
<p>elliottt opened <a href="https://github.com/bytecodealliance/wasmtime/issues/5869">issue #5869</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>The x64 backend has a helper named <code>emit_cmp</code> in  <code>inst.isle</code> that is used when emitting comparisons. Currently it will always use <code>x64_cmp</code> to emit the comparison, but for cases of equality comparisons with <code>0</code>, <code>x64_test</code> would be a better choice. Additionally, the <code>select</code> lowering does not use <code>emit_cmp</code> right now, and could be refactored to do so with this change in place.</p>
<h4>Benefit</h4>
<p>This will generate better code for cases where <code>emit_cmp</code> is used to compile a use of <code>icmp</code> in the x64 backend.<br>
</p>
</blockquote>



<a name="329798115"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235869%20Add%20special%20cases%20in%20the%20x64%20%60emit.../near/329798115" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235869.20Add.20special.20cases.20in.20the.20x64.20.60emit.2E.2E.2E.html#329798115">(Feb 23 2023 at 19:06)</a>:</h4>
<p>elliottt labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/5869">issue #5869</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>The x64 backend has a helper named <code>emit_cmp</code> in  <code>inst.isle</code> that is used when emitting comparisons. Currently it will always use <code>x64_cmp</code> to emit the comparison, but for cases of equality comparisons with <code>0</code>, <code>x64_test</code> would be a better choice. Additionally, the <code>select</code> lowering does not use <code>emit_cmp</code> right now, and could be refactored to do so with this change in place.</p>
<h4>Benefit</h4>
<p>This will generate better code for cases where <code>emit_cmp</code> is used to compile a use of <code>icmp</code> in the x64 backend.<br>
</p>
</blockquote>



<a name="329798116"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235869%20Add%20special%20cases%20in%20the%20x64%20%60emit.../near/329798116" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235869.20Add.20special.20cases.20in.20the.20x64.20.60emit.2E.2E.2E.html#329798116">(Feb 23 2023 at 19:06)</a>:</h4>
<p>elliottt labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/5869">issue #5869</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>The x64 backend has a helper named <code>emit_cmp</code> in  <code>inst.isle</code> that is used when emitting comparisons. Currently it will always use <code>x64_cmp</code> to emit the comparison, but for cases of equality comparisons with <code>0</code>, <code>x64_test</code> would be a better choice. Additionally, the <code>select</code> lowering does not use <code>emit_cmp</code> right now, and could be refactored to do so with this change in place.</p>
<h4>Benefit</h4>
<p>This will generate better code for cases where <code>emit_cmp</code> is used to compile a use of <code>icmp</code> in the x64 backend.<br>
</p>
</blockquote>



<a name="329798118"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235869%20Add%20special%20cases%20in%20the%20x64%20%60emit.../near/329798118" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235869.20Add.20special.20cases.20in.20the.20x64.20.60emit.2E.2E.2E.html#329798118">(Feb 23 2023 at 19:06)</a>:</h4>
<p>elliottt labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/5869">issue #5869</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>The x64 backend has a helper named <code>emit_cmp</code> in  <code>inst.isle</code> that is used when emitting comparisons. Currently it will always use <code>x64_cmp</code> to emit the comparison, but for cases of equality comparisons with <code>0</code>, <code>x64_test</code> would be a better choice. Additionally, the <code>select</code> lowering does not use <code>emit_cmp</code> right now, and could be refactored to do so with this change in place.</p>
<h4>Benefit</h4>
<p>This will generate better code for cases where <code>emit_cmp</code> is used to compile a use of <code>icmp</code> in the x64 backend.<br>
</p>
</blockquote>



<a name="350556512"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235869%20Add%20special%20cases%20in%20the%20x64%20%60emit.../near/350556512" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235869.20Add.20special.20cases.20in.20the.20x64.20.60emit.2E.2E.2E.html#350556512">(Apr 17 2023 at 15:50)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/issues/5869#issuecomment-1511633918">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5869">issue #5869</a>:</p>
<blockquote>
<p>The first part of this issue (using <code>test</code> for comparisons with 0) was finished in #6086, but there's still work to do with simplifying the lowering for Cranelift's <code>select</code> instruction on x86.</p>
</blockquote>



<a name="397839790"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235869%20Add%20special%20cases%20in%20the%20x64%20%60emit.../near/397839790" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235869.20Add.20special.20cases.20in.20the.20x64.20.60emit.2E.2E.2E.html#397839790">(Oct 21 2023 at 11:03)</a>:</h4>
<p>Solo-steven <a href="https://github.com/bytecodealliance/wasmtime/issues/5869#issuecomment-1773756510">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5869">issue #5869</a>:</p>
<blockquote>
<p>Hi @jameysharp  I am interested in this issue, I am a beginner to both compiler backend and isle, so I would like to discuss my solution there before I open PR ~</p>
<p>I think the second part of the issue can be solved by adding a helper for lowering select inst. </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">decl</span><span class="w"> </span><span class="n">lower_select_icmp</span><span class="w"> </span><span class="p">(</span><span class="n">Type</span><span class="w"> </span><span class="n">IcmpCondResult</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="n">Value</span><span class="p">)</span><span class="w"> </span><span class="n">InstOutput</span><span class="p">)</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">lower_select_icmp</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">IcmpCondResult</span><span class="p">.</span><span class="n">Condition</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="n">cc</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">with_flags</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="p">(</span><span class="n">cmove_from_values</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">cc</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span>
</code></pre></div>
<p>I think we can change the existing rule to use the helper above, form existed code </p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/ed68661976554b8ea967d7d3ca2f2e0741323aad/cranelift/codegen/src/isa/x64/lower.isle#L2084">https://github.com/bytecodealliance/wasmtime/blob/ed68661976554b8ea967d7d3ca2f2e0741323aad/cranelift/codegen/src/isa/x64/lower.isle#L2084</a></p>
<p>to use helper above :</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">lower</span><span class="w"> </span><span class="p">(</span><span class="n">has_type</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">select</span><span class="w"> </span><span class="p">(</span><span class="n">maybe_uextend</span><span class="w"> </span><span class="p">(</span><span class="n">icmp</span><span class="w"> </span><span class="n">cc</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="p">(</span><span class="n">value_type</span><span class="w"> </span><span class="p">(</span><span class="n">fits_in_64</span><span class="w"> </span><span class="n">a_ty</span><span class="p">))</span><span class="w"> </span><span class="n">b</span><span class="p">))</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">lower_select_icmp</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">emit_cmp</span><span class="w"> </span><span class="n">cc</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
</code></pre></div>
</blockquote>



<a name="398123176"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235869%20Add%20special%20cases%20in%20the%20x64%20%60emit.../near/398123176" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235869.20Add.20special.20cases.20in.20the.20x64.20.60emit.2E.2E.2E.html#398123176">(Oct 23 2023 at 16:46)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/5869#issuecomment-1775602109">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5869">issue #5869</a>:</p>
<blockquote>
<p>@Solo-steven your refactor looks reasonable -- we'd be happy to review a PR with this. Thanks!</p>
</blockquote>



<a name="469220857"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235869%20Add%20special%20cases%20in%20the%20x64%20%60emit.../near/469220857" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235869.20Add.20special.20cases.20in.20the.20x64.20.60emit.2E.2E.2E.html#469220857">(Sep 10 2024 at 21:51)</a>:</h4>
<p>sudoHackIn <a href="https://github.com/bytecodealliance/wasmtime/issues/5869#issuecomment-2342071246">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5869">issue #5869</a>:</p>
<blockquote>
<p>Hi, @cfallin is this issue still actual or should be closed after Solo-steven's pr is merged?</p>
</blockquote>



<a name="469221403"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235869%20Add%20special%20cases%20in%20the%20x64%20%60emit.../near/469221403" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235869.20Add.20special.20cases.20in.20the.20x64.20.60emit.2E.2E.2E.html#469221403">(Sep 10 2024 at 21:55)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/5869#issuecomment-2342076048">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5869">issue #5869</a>:</p>
<blockquote>
<p>@sudoHackIn the PR above addresed the second bit (<code>select</code> using the helper) but not the first (using <code>test</code> rather than <code>cmp</code>), so this issue should remain open, I think.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>