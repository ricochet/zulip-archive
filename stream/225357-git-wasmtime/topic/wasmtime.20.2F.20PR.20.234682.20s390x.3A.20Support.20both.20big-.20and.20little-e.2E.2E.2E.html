<html>
<head><meta charset="utf-8"><title>wasmtime / PR #4682 s390x: Support both big- and little-e... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234682.20s390x.3A.20Support.20both.20big-.20and.20little-e.2E.2E.2E.html">wasmtime / PR #4682 s390x: Support both big- and little-e...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="292819805"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234682%20s390x%3A%20Support%20both%20big-%20and%20little-e.../near/292819805" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234682.20s390x.3A.20Support.20both.20big-.20and.20little-e.2E.2E.2E.html#292819805">(Aug 10 2022 at 19:35)</a>:</h4>
<p>uweigand opened <a href="https://github.com/bytecodealliance/wasmtime/pull/4682">PR #4682</a> from <code>s390x-lane-order</code> to <code>main</code>:</p>
<blockquote>
<p>This implements the s390x back-end portion of the solution for<br>
<a href="https://github.com/bytecodealliance/wasmtime/issues/4566">https://github.com/bytecodealliance/wasmtime/issues/4566</a></p>
<p>We now support both big- and little-endian vector lane order<br>
in code generation.  The order used for a function is determined<br>
by the function's ABI: if it uses a Wasmtime ABI, it will use<br>
little-endian lane order, and big-endian lane order otherwise.<br>
(This ensures that all raw_bitcast instructions generated by<br>
both wasmtime and other cranelift frontends can always be<br>
implemented as a no-op.)</p>
<p>Lane order affects the implementation of a number of operations:</p>
<ul>
<li>Vector immediates</li>
<li>Vector memory load / store (in big- and little-endian variants)</li>
<li>
<p>Operations explicitly using lane numbers<br>
  (insertlane, extractlane, shuffle, swizzle)</p>
</li>
<li>
<p>Operations implicitly using lane numbers<br>
  (iadd_pairwise, narrow/widen, promote/demote, fcvt_low, vhigh_bits)</p>
</li>
</ul>
<p>In addition, when calling a function using a different lane order,<br>
we need to lane-swap all vector values passed or returned in registers.</p>
<p>A small number of changes to common code were also needed:</p>
<ul>
<li>
<p>Ensure we always select a Wasmtime calling convention on s390x<br>
  in crates/cranelift (func_signature).</p>
</li>
<li>
<p>Fix vector immediates for filetests/runtests.  In PR #4427,<br>
  I attempted to fix this by byte-swapping the V128 value, but<br>
  with the new scheme, we'd instead need to perform a per-lane<br>
  byte swap.  Since we do not know the actual type in write_to_slice<br>
  and read_from_slice, this isn't easily possible.</p>
<p>Revert this part of PR #4427 again, and instead just mark the<br>
memory buffer as little-endian when emitting the trampoline;<br>
the back-end will then emit correct code to load the constant.</p>
</li>
<li>
<p>Change a runtest in simd-bitselect-to-vselect.clif to no longer<br>
  make little-endian lane order assumptions.</p>
</li>
<li>
<p>Remove runtests in simd-swizzle.clif that make little-endian<br>
  lane order assumptions by relying on implicit type conversion<br>
  when using a non-i16x8 swizzle result type (this feature should<br>
  probably be removed anyway).</p>
</li>
</ul>
<p>Tested with both wasmtime and cg_clif.</p>
<p>FYI - @cfallin </p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="292826402"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234682%20s390x%3A%20Support%20both%20big-%20and%20little-e.../near/292826402" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234682.20s390x.3A.20Support.20both.20big-.20and.20little-e.2E.2E.2E.html#292826402">(Aug 10 2022 at 20:19)</a>:</h4>
<p>uweigand updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4682">PR #4682</a> from <code>s390x-lane-order</code> to <code>main</code>.</p>



<a name="292839403"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234682%20s390x%3A%20Support%20both%20big-%20and%20little-e.../near/292839403" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234682.20s390x.3A.20Support.20both.20big-.20and.20little-e.2E.2E.2E.html#292839403">(Aug 10 2022 at 21:58)</a>:</h4>
<p>uweigand updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4682">PR #4682</a> from <code>s390x-lane-order</code> to <code>main</code>.</p>



<a name="292990934"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234682%20s390x%3A%20Support%20both%20big-%20and%20little-e.../near/292990934" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234682.20s390x.3A.20Support.20both.20big-.20and.20little-e.2E.2E.2E.html#292990934">(Aug 11 2022 at 19:10)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4682#pullrequestreview-1070222430">PR review</a>.</p>



<a name="292990951"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234682%20s390x%3A%20Support%20both%20big-%20and%20little-e.../near/292990951" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234682.20s390x.3A.20Support.20both.20big-.20and.20little-e.2E.2E.2E.html#292990951">(Aug 11 2022 at 19:10)</a>:</h4>
<p>cfallin merged <a href="https://github.com/bytecodealliance/wasmtime/pull/4682">PR #4682</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>