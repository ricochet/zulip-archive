<html>
<head><meta charset="utf-8"><title>wasmtime / issue #5891 test: add sample `poll_oneoff` WAT... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235891.20test.3A.20add.20sample.20.60poll_oneoff.60.20WAT.2E.2E.2E.html">wasmtime / issue #5891 test: add sample `poll_oneoff` WAT...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="338468977"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235891%20test%3A%20add%20sample%20%60poll_oneoff%60%20WAT.../near/338468977" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235891.20test.3A.20add.20sample.20.60poll_oneoff.60.20WAT.2E.2E.2E.html#338468977">(Feb 27 2023 at 23:12)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/pull/5891#issuecomment-1447258643">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5891">issue #5891</a>:</p>
<blockquote>
<p>I expect this test to fail on the first CI pass since that is what I am seeing locally. Some logs:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">RUST_LOG</span><span class="o">=</span><span class="n">trace</span><span class="w"> </span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="n">tests</span><span class="o">/</span><span class="n">all</span><span class="o">/</span><span class="n">cli_tests</span><span class="o">/</span><span class="n">poll_oneoff</span><span class="p">.</span><span class="n">wat</span>
<span class="o">..</span><span class="p">.</span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">wasi_common</span>::<span class="n">snapshots</span>::<span class="n">preview_1</span>::<span class="n">wasi_snapshot_preview1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">wiggle</span><span class="w"> </span><span class="n">abi</span><span class="p">;</span><span class="w"> </span><span class="n">module</span><span class="o">=</span><span class="s">"wasi_snapshot_preview1"</span><span class="w"> </span><span class="n">function</span><span class="o">=</span><span class="s">"poll_oneoff"</span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">tracing</span>::<span class="n">span</span>::<span class="n">active</span><span class="w">                                     </span><span class="o">&gt;</span><span class="w"> </span>-&gt; <span class="nc">wiggle</span><span class="w"> </span><span class="n">abi</span><span class="p">;</span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">wasi_common</span>::<span class="n">snapshots</span>::<span class="n">preview_1</span>::<span class="n">wasi_snapshot_preview1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">in_</span><span class="o">=*</span><span class="n">guest</span><span class="w"> </span><span class="mh">0x64</span><span class="w"> </span><span class="n">out</span><span class="o">=*</span><span class="n">guest</span><span class="w"> </span><span class="mh">0xc8</span><span class="w"> </span><span class="n">nsubscriptions</span><span class="o">=</span><span class="mi">1</span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">wasi_common</span>::<span class="n">snapshots</span>::<span class="n">preview_1</span>::<span class="n">wasi_snapshot_preview1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="o">=</span><span class="nb">Err</span><span class="p">(</span><span class="n">Error</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">inner</span>: <span class="nc">Inval</span><span class="w"> </span><span class="p">})</span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">tracing</span>::<span class="n">span</span>::<span class="n">active</span><span class="w">                                     </span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">wiggle</span><span class="w"> </span><span class="n">abi</span><span class="p">;</span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">tracing</span>::<span class="n">span</span><span class="w">                                             </span><span class="o">&gt;</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">wiggle</span><span class="w"> </span><span class="n">abi</span><span class="p">;</span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">backtrace</span><span class="w">                 </span><span class="o">&gt;</span><span class="w"> </span><span class="o">======</span><span class="w"> </span><span class="n">Capturing</span><span class="w"> </span><span class="n">Backtrace</span><span class="w"> </span><span class="o">======</span>
<span class="o">..</span><span class="p">.</span>
</code></pre></div>
<p>It seems clear that Wasmtime rejects this call as invalid, but it is difficult for me to figure what exactly is invalid about the call.</p>
</blockquote>



<a name="338537464"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235891%20test%3A%20add%20sample%20%60poll_oneoff%60%20WAT.../near/338537464" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235891.20test.3A.20add.20sample.20.60poll_oneoff.60.20WAT.2E.2E.2E.html#338537464">(Feb 28 2023 at 09:33)</a>:</h4>
<p>yamt <a href="https://github.com/bytecodealliance/wasmtime/pull/5891#issuecomment-1447854503">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5891">issue #5891</a>:</p>
<blockquote>
<blockquote>
<p>Presumably the call works in other runtimes (i.e., WAMR) since it was upstreamed by a WAMR contributor. </p>
</blockquote>
<p>i'm sure it works for wamr and toywasm.</p>
</blockquote>



<a name="338609233"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235891%20test%3A%20add%20sample%20%60poll_oneoff%60%20WAT.../near/338609233" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235891.20test.3A.20add.20sample.20.60poll_oneoff.60.20WAT.2E.2E.2E.html#338609233">(Feb 28 2023 at 14:59)</a>:</h4>
<p>sunfishcode <a href="https://github.com/bytecodealliance/wasmtime/pull/5891#issuecomment-1448333393">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5891">issue #5891</a>:</p>
<blockquote>
<p>There are two issues here.</p>
<p>One is that the <a href="https://github.com/WebAssembly/WASI/blob/main/legacy/preview1/witx/wasi_snapshot_preview1.witx#L457">return type of <code>poll_oneoff</code></a> has multiple results, which Wasmtime interprets to mean that the core-wasm function should return the errno as its return value and return the number of events via an out parameter. This what <a href="https://github.com/WebAssembly/wasi-libc/blob/main/libc-bottom-half/headers/public/wasi/api.h#L1980">wasi-libc expects</a> too. However, the test expects the number of events will be returned as the return value. I recognize that there's poor documentation. I propose Wasmtime's and wasi-libc's interpretation is preferable here, because otherwise there seems to be no way for <code>poll_oneoff</code> to indicate failure. It's been <a href="https://github.com/WebAssembly/wasi-poll/issues/9">proposed elsewhere</a> that <code>poll_oneoff</code> ideally shouldn't fail itself, and should instead report failures on individual file descriptors as events, and I agree in principle, however in the Preview1 API, it's still expected that <code>poll_oneoff</code> as a whole can fail in some situations, such as <a href="https://github.com/WebAssembly/WASI/blob/main/legacy/preview1/witx/wasi_snapshot_preview1.witx#L448">when <code>nsubscriptions</code> is 0</a>. If people agree, I'll volunteer to submit a PR to the WASI repo documenting that functions with multiple return values in witx return their first value as a return value and any other values via pointer arguments.</p>
<p>The other is that the test passes the address <code>100</code> as the subscriptions parameter, however the alignment of <code>__wasi_subscription_t</code> on wasm32-wasi is 8, so the address is not aligned, and Wasmtime is checking the alignment.</p>
<p>What should we do for misaligned addresses? I can see it both ways. On one hand, core Wasm load/store support misaligned addresses, with the caveat that they may be slow, so perhaps WASI calls should allow misaligned addresses for consistency with that. On the other, most producers do provide alignment, as evidenced by the fact that this issue hasn't been noticed until now, and requiring aligned addresses might help avoid subtle and bugs in host implementations.</p>
</blockquote>



<a name="338612507"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235891%20test%3A%20add%20sample%20%60poll_oneoff%60%20WAT.../near/338612507" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235891.20test.3A.20add.20sample.20.60poll_oneoff.60.20WAT.2E.2E.2E.html#338612507">(Feb 28 2023 at 15:12)</a>:</h4>
<p>yamt <a href="https://github.com/bytecodealliance/wasmtime/pull/5891#issuecomment-1448358197">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5891">issue #5891</a>:</p>
<blockquote>
<blockquote>
<p>There are two issues here.</p>
<p>One is that the <a href="https://github.com/WebAssembly/WASI/blob/main/legacy/preview1/witx/wasi_snapshot_preview1.witx#L457">return type of <code>poll_oneoff</code></a> has multiple results, which Wasmtime interprets to mean that the core-wasm function should return the errno as its return value and return the number of events via an out parameter.</p>
</blockquote>
<p>the original code in wasi-threads doesn't have this issue.</p>
<blockquote>
<p>The other is that the test passes the address <code>100</code> as the subscriptions parameter, however the alignment of <code>__wasi_subscription_t</code> on wasm32-wasi is 8, so the address is not aligned, and Wasmtime is checking the alignment.</p>
</blockquote>
<p>good point. i will fix it in wasi-threads tests.</p>
</blockquote>



<a name="338641148"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235891%20test%3A%20add%20sample%20%60poll_oneoff%60%20WAT.../near/338641148" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235891.20test.3A.20add.20sample.20.60poll_oneoff.60.20WAT.2E.2E.2E.html#338641148">(Feb 28 2023 at 17:01)</a>:</h4>
<p>sunfishcode <a href="https://github.com/bytecodealliance/wasmtime/pull/5891#issuecomment-1448532615">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5891">issue #5891</a>:</p>
<blockquote>
<p>I've now submitted <a href="https://github.com/WebAssembly/WASI/pull/523">https://github.com/WebAssembly/WASI/pull/523</a> to document how <code>expected</code> return types work in witx, as well as proposing a behavior for functions on misaligned pointers.</p>
</blockquote>



<a name="338707786"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235891%20test%3A%20add%20sample%20%60poll_oneoff%60%20WAT.../near/338707786" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235891.20test.3A.20add.20sample.20.60poll_oneoff.60.20WAT.2E.2E.2E.html#338707786">(Feb 28 2023 at 22:50)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/pull/5891#issuecomment-1449046907">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5891">issue #5891</a>:</p>
<blockquote>
<blockquote>
<p>One is that the <a href="https://github.com/WebAssembly/WASI/blob/main/legacy/preview1/witx/wasi_snapshot_preview1.witx#L457">return type of poll_oneoff</a> has multiple results, which Wasmtime interprets to mean that the core-wasm function should return the errno as its return value and return the number of events via an out parameter</p>
</blockquote>
<p>Sorry, this is my mistake for lifting the snippet from an entirely different context and tacking on some not-thought-through error checking. I can fix this if we want to keep this test. Do we want to keep this test (cc: @alexcrichton, @pchickey)? If you all want to include this, I will gladly fix this up. Otherwise I'll close this because the original issue &mdash; alignment &mdash; is now fixed in the testsuite.</p>
<p>Thanks @sunfishcode and @yamt for looking into this!</p>
</blockquote>



<a name="338707855"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235891%20test%3A%20add%20sample%20%60poll_oneoff%60%20WAT.../near/338707855" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235891.20test.3A.20add.20sample.20.60poll_oneoff.60.20WAT.2E.2E.2E.html#338707855">(Feb 28 2023 at 22:50)</a>:</h4>
<p>abrown edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/5891#issuecomment-1449046907">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5891">issue #5891</a>:</p>
<blockquote>
<blockquote>
<p>One is that the <a href="https://github.com/WebAssembly/WASI/blob/main/legacy/preview1/witx/wasi_snapshot_preview1.witx#L457">return type of poll_oneoff</a> has multiple results, which Wasmtime interprets to mean that the core-wasm function should return the errno as its return value and return the number of events via an out parameter</p>
</blockquote>
<p>Sorry, this is my mistake for lifting the snippet from an entirely different context and tacking on some not-thought-through error checking. I can fix this if we want to keep this test. Do we want to keep this test (cc: @alexcrichton, @pchickey)? If you all want to include this, I will gladly fix this up (along with the alignment). Otherwise I'll close this because the original issue &mdash; alignment &mdash; is now fixed in the testsuite.</p>
<p>Thanks @sunfishcode and @yamt for looking into this!</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>