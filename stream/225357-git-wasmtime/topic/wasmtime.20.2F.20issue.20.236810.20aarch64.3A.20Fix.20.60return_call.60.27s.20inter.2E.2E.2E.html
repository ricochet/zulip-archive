<html>
<head><meta charset="utf-8"><title>wasmtime / issue #6810 aarch64: Fix `return_call`&#x27;s inter... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236810.20aarch64.3A.20Fix.20.60return_call.60.27s.20inter.2E.2E.2E.html">wasmtime / issue #6810 aarch64: Fix `return_call`&#x27;s inter...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="382216590"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236810%20aarch64%3A%20Fix%20%60return_call%60%27s%20inter.../near/382216590" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236810.20aarch64.3A.20Fix.20.60return_call.60.27s.20inter.2E.2E.2E.html#382216590">(Aug 05 2023 at 19:44)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/6810#issuecomment-1666589919">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6810">issue #6810</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @cfallin, @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "cranelift:area:aarch64", "cranelift:area:machinst", "cranelift:area:x64", "isle"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>cfallin: isle</li>
<li>fitzgen: isle</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="383006787"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236810%20aarch64%3A%20Fix%20%60return_call%60%27s%20inter.../near/383006787" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236810.20aarch64.3A.20Fix.20.60return_call.60.27s.20inter.2E.2E.2E.html#383006787">(Aug 08 2023 at 15:57)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/pull/6810#issuecomment-1669885592">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6810">issue #6810</a>:</p>
<blockquote>
<p>We are going to have some issues with our test runner. We currently use <code>cranelift-native</code> to do feature detection before running a test invocation, so that we don't natively try to run a test with an extension that the host does not support. We currently only ever <a href="https://github.com/bytecodealliance/wasmtime/blob/3878a0025e8c2f44f8ed2e7064cd5188574e7d6c/cranelift/native/src/lib.rs#L132-L136">enable <code>sign_return_address</code> on MacOS</a>, otherwise that feature is never enabled by <code>cranelift-native</code>, which means that our test runner will always skip these tests even if QEMU signals support for them.</p>
<p>I'm also not sure we can enable them in cranelift native, since I think that would automatically enable return address signing for anyone who just uses all native features, and that might not be desirable.</p>
</blockquote>



<a name="383007047"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236810%20aarch64%3A%20Fix%20%60return_call%60%27s%20inter.../near/383007047" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236810.20aarch64.3A.20Fix.20.60return_call.60.27s.20inter.2E.2E.2E.html#383007047">(Aug 08 2023 at 15:58)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/6810#issuecomment-1669885592">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6810">issue #6810</a>:</p>
<blockquote>
<p>We are going to have some issues with our test runner. We currently use <code>cranelift-native</code> to do feature detection before running a test invocation, so that we don't natively try to run a test with an extension that the host does not support. </p>
<p>We currently only ever <a href="https://github.com/bytecodealliance/wasmtime/blob/3878a0025e8c2f44f8ed2e7064cd5188574e7d6c/cranelift/native/src/lib.rs#L132-L136">enable <code>sign_return_address</code> on MacOS</a>, that feature is otherwise never enabled by <code>cranelift-native</code>, which means that our test runner will always skip these tests even if QEMU signals support for them.</p>
<p>I'm also not sure we can enable them in cranelift native (i.e. alongside <code>paca</code>), since I think that would automatically enable return address signing for anyone who just uses all native features, and that might not be desirable.</p>
</blockquote>



<a name="383009372"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236810%20aarch64%3A%20Fix%20%60return_call%60%27s%20inter.../near/383009372" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236810.20aarch64.3A.20Fix.20.60return_call.60.27s.20inter.2E.2E.2E.html#383009372">(Aug 08 2023 at 16:05)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/6810#issuecomment-1669897367">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6810">issue #6810</a>:</p>
<blockquote>
<p>Heh I was just digging into this a bit more and reached the same conclusion! Apparently with QEMU 8.0.2 (what I happen to have installed locally) it will, by default, enable the necessary bits for authentication so the <code>retaa</code> instruction, for example, works with QEMU 8.0.2 out-of-the box. The same binary fails on one piece of native hardware I can run on which doesn't have support (presumably I suppose).</p>
<p>I can confirm though that if I force <code>sign_return_address</code> then the runtests as-is will crash. With this PR, however, they pass. In that sense I don't think a new runtest is necessarily needed since the wasm suite and runtests should cover everything already.</p>
<p>Otherwise though I don't feel like I know enough about aarch64 pointer authentication bits to know what to do here. Given that pointer authentication, as we're using it, is purely a function-local decision I don't know why we would ever want to disable <code>sign_return_address</code>. I'm also not sure why it matters which key (A or B) is used.</p>
<blockquote>
<p>I'm also not sure we can enable them in cranelift native (i.e. alongside paca), since I think that would automatically enable return address signing for anyone who just uses all native features, and that might not be desirable.</p>
</blockquote>
<p>Can you expand on this @afonso360? Do you know why this might be bad and/or not desirable?</p>
</blockquote>



<a name="383010639"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236810%20aarch64%3A%20Fix%20%60return_call%60%27s%20inter.../near/383010639" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236810.20aarch64.3A.20Fix.20.60return_call.60.27s.20inter.2E.2E.2E.html#383010639">(Aug 08 2023 at 16:10)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/6810#issuecomment-1669908352">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6810">issue #6810</a>:</p>
<blockquote>
<blockquote>
<p>Given that pointer authentication, as we're using it, is purely a function-local decision I don't know why we would ever want to disable sign_return_address. I'm also not sure why it matters which key (A or B) is used.</p>
</blockquote>
<p>I guess it matters for unwinding? This is why e.g. we're forced to use the feature, and the B key specifically, on macOS, at least if I understand correctly. I'd be very curious to know if aarch64 Linux lets us do signing locally though; that would be a nice defense-in-depth thing...</p>
</blockquote>



<a name="383011817"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236810%20aarch64%3A%20Fix%20%60return_call%60%27s%20inter.../near/383011817" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236810.20aarch64.3A.20Fix.20.60return_call.60.27s.20inter.2E.2E.2E.html#383011817">(Aug 08 2023 at 16:14)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/pull/6810#issuecomment-1669917113">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6810">issue #6810</a>:</p>
<blockquote>
<p>I had the idea that there were some issues back when this was originally implemented, but it looks like its unwinding related as @cfallin mentioned.</p>
<p>Here's the original discussion: <a href="https://github.com/bytecodealliance/wasmtime/pull/3606#discussion_r936966019">https://github.com/bytecodealliance/wasmtime/pull/3606#discussion_r936966019</a></p>
</blockquote>



<a name="383011865"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236810%20aarch64%3A%20Fix%20%60return_call%60%27s%20inter.../near/383011865" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236810.20aarch64.3A.20Fix.20.60return_call.60.27s.20inter.2E.2E.2E.html#383011865">(Aug 08 2023 at 16:14)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/6810#issuecomment-1669917113">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6810">issue #6810</a>:</p>
<blockquote>
<p>I got the impressions that there were some issues back when this was originally implemented, but it looks like its unwinding related as @cfallin mentioned.</p>
<p>Here's the original discussion: <a href="https://github.com/bytecodealliance/wasmtime/pull/3606#discussion_r936966019">https://github.com/bytecodealliance/wasmtime/pull/3606#discussion_r936966019</a></p>
</blockquote>



<a name="383012063"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236810%20aarch64%3A%20Fix%20%60return_call%60%27s%20inter.../near/383012063" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236810.20aarch64.3A.20Fix.20.60return_call.60.27s.20inter.2E.2E.2E.html#383012063">(Aug 08 2023 at 16:15)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/6810#issuecomment-1669917113">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6810">issue #6810</a>:</p>
<blockquote>
<blockquote>
<p>Can you expand on this @afonso360? Do you know why this might be bad and/or not desirable?</p>
</blockquote>
<p>I got the impressions that there were some issues back when this was originally implemented, but it looks like its unwinding related as @cfallin mentioned. </p>
<p>Here's the original discussion: <a href="https://github.com/bytecodealliance/wasmtime/pull/3606#discussion_r936966019">https://github.com/bytecodealliance/wasmtime/pull/3606#discussion_r936966019</a></p>
</blockquote>



<a name="383012194"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236810%20aarch64%3A%20Fix%20%60return_call%60%27s%20inter.../near/383012194" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236810.20aarch64.3A.20Fix.20.60return_call.60.27s.20inter.2E.2E.2E.html#383012194">(Aug 08 2023 at 16:15)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/6810#issuecomment-1669917113">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6810">issue #6810</a>:</p>
<blockquote>
<blockquote>
<p>Can you expand on this @afonso360? Do you know why this might be bad and/or not desirable?</p>
</blockquote>
<p>I got the impression that there were some issues back when this was originally implemented, but it looks like its unwinding related as @cfallin mentioned. </p>
<p>Here's the original discussion: <a href="https://github.com/bytecodealliance/wasmtime/pull/3606#discussion_r936966019">https://github.com/bytecodealliance/wasmtime/pull/3606#discussion_r936966019</a></p>
</blockquote>



<a name="383015704"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236810%20aarch64%3A%20Fix%20%60return_call%60%27s%20inter.../near/383015704" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236810.20aarch64.3A.20Fix.20.60return_call.60.27s.20inter.2E.2E.2E.html#383015704">(Aug 08 2023 at 16:28)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/6810#issuecomment-1669917113">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6810">issue #6810</a>:</p>
<blockquote>
<blockquote>
<p>Can you expand on this @afonso360? Do you know why this might be bad and/or not desirable?</p>
</blockquote>
<p>I got the impression that there were some issues back when this was originally implemented, but it looks like its unwinding related as @cfallin mentioned (They might no longer be relevant, that was just the impression I got). </p>
<p>Here's the original discussion: <a href="https://github.com/bytecodealliance/wasmtime/pull/3606#discussion_r936966019">https://github.com/bytecodealliance/wasmtime/pull/3606#discussion_r936966019</a></p>
</blockquote>



<a name="383035310"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236810%20aarch64%3A%20Fix%20%60return_call%60%27s%20inter.../near/383035310" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236810.20aarch64.3A.20Fix.20.60return_call.60.27s.20inter.2E.2E.2E.html#383035310">(Aug 08 2023 at 17:47)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/6810#issuecomment-1670046662">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6810">issue #6810</a>:</p>
<blockquote>
<p>Ah ok yeah that all makes sense, and this is sort of coming back to me. So I think that functionally we could enable <code>sign_return_address</code> unconditionally for normal execution and wasm backtraces should work due to the use of our own custom frame-pointer unwinder which bakes in <code>xpaclri</code> to handle encrypted return addresses. The remaining issues I think are (a) what does <code>std::backtrace::Backtrace::new()</code> do when there's wasm on the stack and (b) is it possible to get a backtrace through wasm in a debugger. In theory both of these are functions of dwarf unwinding information we emit, which in theory is correct, but that may require newer debuggers/systems to handle that libgcc bug mentioned.</p>
<p>Testing this locally looks like the B key can't be used on Linux with Wasmtime since <a href="https://github.com/bytecodealliance/wasmtime/blob/2764edc59c42d38a1e32db9e67ca320050bd54c3/cranelift/codegen/src/isa/aarch64/mod.rs#L172">we haven't implemented the dwarf stuff to indicate that</a>. If I force-enable <code>sign_return_address</code> then <code>std::backtrace::Backtrace::new()</code> segfaults with wasm on the stack. Additionally in gdb the stack trace (of that segfault) stops at the wasm on the stack. The segfault is in <code>libgcc_s.so</code> which may mean I'm running into <a href="https://github.com/bytecodealliance/wasmtime/issues/3183#issuecomment-1059176038">this</a>. I think I've then confirmed that where if I run in a recent container (<code>ubuntu:23.10</code>) then the backtrace looks correct. Running in a slightly older contains (<code>ubuntu:22.10</code>) I hit the same segfault.</p>
<p>So that's a long way of saying:</p>
<ul>
<li>Ignoring native backtraces, it seems like we can safely enable <code>sign_return_address</code> at all times. This will then enable automatic testing in CI since QEMU implements both <code>pauth</code> and the non-<code>hint</code> semantic versions of the instructions</li>
<li>We must use the A key since encoding the usage of the B key in unwind information is not yet supported.</li>
<li>Only recent builds (of libunwind?) support the dwarf we're emitting meaning we have the options of:<ul>
<li>Emit no dwarf unwind information, meaning native backtraces terminate at wasm frames (safely? unsure)</li>
<li>Emit current dwarf meaning native backtraces crash unless they have the gcc patch from #3183</li>
<li>Some other blending like emit native unwind info by default except on AArch64 Linux for a few years.</li>
</ul>
</li>
</ul>
<p>We don't use docker for tests in CI, just for release builds, so my guess is that the patched toolchain is so new that it's not available on GitHub actions by default (they're using ubuntu 22.04). This means that <code>sign_return_address</code>, if enabled, I believe would fail on GitHub actions if we acquire a native backtrace in tests (which we may not do, I forget). Given all this I'm tempted to say we shouldn't do anything else here at this time. In a few years we should be able to flip the <code>sign_return_address</code> config option by default and have everything "just work" though.</p>
</blockquote>



<a name="383373253"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236810%20aarch64%3A%20Fix%20%60return_call%60%27s%20inter.../near/383373253" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236810.20aarch64.3A.20Fix.20.60return_call.60.27s.20inter.2E.2E.2E.html#383373253">(Aug 09 2023 at 17:45)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/6810#issuecomment-1671876594">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6810">issue #6810</a>:</p>
<blockquote>
<p>The rabbit hole continues to go deep on this one.</p>
<p>I've attempted to follow-through on suggestions from today's Cranelift meeting by enabling <code>sign_return_address</code> for a single test case (or a few) throughout our runtest test suite. Turns out <code>tail-call-conv.clif</code> already does this! Turns out that not only passes in CI but additionally passes locally on my macbook. This appears to be due to:</p>
<ul>
<li>Locally on macOS this passes because it's signing with the A key not the B key (e.g. <code>sign_return_address_with_bkey</code> isn't specified). Apparently macOS is configured such that signing with the A key is a noop, so it's as-if these instructions don't exist. That means that all the tests pass if the pointer authentication is mixed up by accident.</li>
<li>On CI this is passing because cranelift-filetest is skipping the test that wants <code>sign_return_address</code>. Linux hosts (as @afonso360 pointed out) never infer this flag, and then the default logic is to reject the test if a feature is specified that the host doesn't support.</li>
</ul>
<p>On <code>main</code> if I specify <code>sign_return_address_with_bkey</code> then tests segfault as-is on macOS. That means that the test suite already has coverage of the necessary bits that's being fixed here. To help catch this in the future on CI I've added special logic to cranelift-filetest to specifically ignore the <code>sign_return_address</code> feature. This way we should now start running <code>sign_return_address</code> code, on Linux, in CI. This I can confirm segfaults qemu on main because QEMU supports <code>has_pauth</code>. </p>
<p>All-in-all I believe that this should now be run on CI.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>