<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #1918 Add config isa to c api · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231918.20Add.20config.20isa.20to.20c.20api.html">wasmtime / Issue #1918 Add config isa to c api</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="201941808"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231918%20Add%20config%20isa%20to%20c%20api/near/201941808" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231918.20Add.20config.20isa.20to.20c.20api.html#201941808">(Jun 25 2020 at 08:06)</a>:</h4>
<p>jlb6740 <a href="https://github.com/bytecodealliance/wasmtime/pull/1918#issuecomment-649345628">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1918">Issue #1918</a>:</p>
<blockquote>
<p>Hi .. I wanted to expose selecting the target isa x86 or x64 for example, to the c-api. I'm looking for confirmation this makes sense to do and to see the best way to do this. My current thinking is to just go along the lines the code is going now and try to expose the selection through the cranelift_other_flags function. Currently looks like I'd have to add some flags or do something to target the target specific flags? There is currently the use_new_backend flag that looks target specific. Any comments?</p>
</blockquote>



<a name="201941957"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231918%20Add%20config%20isa%20to%20c%20api/near/201941957" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231918.20Add.20config.20isa.20to.20c.20api.html#201941957">(Jun 25 2020 at 08:08)</a>:</h4>
<p>jlb6740 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/1918#issuecomment-649345628">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1918">Issue #1918</a>:</p>
<blockquote>
<p>Hi .. I wanted to expose selecting the target isa (x86 or x64 for example) to the c-api. I'm looking for confirmation this makes sense to do and to see the best way to do this. My current thinking is to just go along the lines the code is going now and try to expose the selection through the cranelift_other_flags function. Currently looks not sure the best way to do this sense there are no relevant flags here and maybe adding a new one would be required? There is the use_new_backend flag that looks target specific and which I need to make considerations for. Any comments?</p>
</blockquote>



<a name="201943110"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231918%20Add%20config%20isa%20to%20c%20api/near/201943110" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231918.20Add.20config.20isa.20to.20c.20api.html#201943110">(Jun 25 2020 at 08:25)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/1918#issuecomment-649364869">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1918">Issue #1918</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @bnjbvr, @peterhuene</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "cranelift:area:x64", "wasmtime:c-api"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>bnjbvr: cranelift</li>
<li>peterhuene: wasmtime:c-api</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="201948720"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231918%20Add%20config%20isa%20to%20c%20api/near/201948720" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231918.20Add.20config.20isa.20to.20c.20api.html#201948720">(Jun 25 2020 at 09:37)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/1918#issuecomment-649426228">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1918">Issue #1918</a>:</p>
<blockquote>
<blockquote>
<p>I wanted to expose selecting the target isa (x86 or x64 for example) to the c-api.</p>
</blockquote>
<p>Selecting a target isa doesn't make sense for a JIT. It must always match the host isa to prevent crashes. Even switching between the 32bit and 64bit version of an isa often isn't possible. (Linux has a way to <a href="https://stackoverflow.com/questions/24113729/switch-from-32bit-mode-to-64-bit-long-mode-on-64bit-linux/32384358#32384358">switch</a> between 64bit and 32bit x86 execution within a process, but I don't know of any other OS that supports this) If you want to switch between the old and the new x86_64 backend, then there is already the <code>experimental_x64</code> feature flag. The new x86_64 backend is not complete enough to be usable at the moment though.</p>
</blockquote>



<a name="202001007"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231918%20Add%20config%20isa%20to%20c%20api/near/202001007" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231918.20Add.20config.20isa.20to.20c.20api.html#202001007">(Jun 25 2020 at 17:43)</a>:</h4>
<p>jlb6740 <a href="https://github.com/bytecodealliance/wasmtime/pull/1918#issuecomment-649725132">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1918">Issue #1918</a>:</p>
<blockquote>
<p>Hi @bjorn3 @bnjbvr thanks for the comments. Yes, full disclosure I was experimentation in trying to use the C-API (instead of wasmtime cli) to test modules that contained newly supported wasm instructions against the new backend. At current, I did not see how to access the experimental_x64 flag and was forced to comment out code and rebuild the wasmtime lib everytime I wanted to compare results between the two backend and was thinking support could be added to the api like the second line here:</p>
<blockquote>
<p>wasm_config_t *config = wasm_config_new();<br>
wasmtime_config_arch_set(config, x64);</p>
<p>wasm_engine_t *engine = wasm_engine_new_with_config(config);<br>
assert(engine != NULL);</p>
</blockquote>
<p>Of course this wouldn't work if the arch wasn't supported by the platform but that was understood. So the goal wasn't anything like cross-compile. In general ... I was wondering if it made sense to add a way to access most of the same flags available to the cli.</p>
<p>Once enough instructions are lowered (which may be the case with @bnjbvr latest push, the experimenting that I was doing can be done with a script that calls the wasmtime cli but messing around with the C-API was helping me understand parts of the internals a little better so I went that route. I was thinking that separate engine, separate store, separate instance, etc that this was possible, but from @bjorn3 comments it sounds like it is not.</p>
</blockquote>



<a name="202001196"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231918%20Add%20config%20isa%20to%20c%20api/near/202001196" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231918.20Add.20config.20isa.20to.20c.20api.html#202001196">(Jun 25 2020 at 17:44)</a>:</h4>
<p>jlb6740 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/1918#issuecomment-649725132">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1918">Issue #1918</a>:</p>
<blockquote>
<p>Hi @bjorn3 @bnjbvr thanks for the comments. Yes, full disclosure I was experimentation in trying to use the C-API (instead of wasmtime cli) to test modules that contained newly supported wasm instructions against the new backend. At current, I did not see how to access the experimental_x64 flag and was forced to comment out code and rebuild the wasmtime lib everytime I wanted to compare results between the two backend and was thinking support could be added to the api like the second line here:</p>
<blockquote>
<p>wasm_config_t *config = wasm_config_new();<br>
wasmtime_config_arch_set(config, x64);</p>
<p>wasm_engine_t *engine = wasm_engine_new_with_config(config);<br>
assert(engine != NULL);</p>
</blockquote>
<p>Of course this wouldn't work if the arch wasn't supported by the platform but that was understood. So the goal wasn't anything like cross-compile. In general ... I was wondering if it made sense to add a way to access via the capi, most of the same flags available to the cli using the cranelift_other_flags function.</p>
<p>Once enough instructions are lowered (which may be the case with @bnjbvr latest push, the experimenting that I was doing can be done with a script that calls the wasmtime cli but messing around with the C-API was helping me understand parts of the internals a little better so I went that route. I was thinking that separate engine, separate store, separate instance, etc that this was possible, but from @bjorn3 comments it sounds like it is not.</p>
</blockquote>



<a name="202008735"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231918%20Add%20config%20isa%20to%20c%20api/near/202008735" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231918.20Add.20config.20isa.20to.20c.20api.html#202008735">(Jun 25 2020 at 18:44)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/1918#issuecomment-649753300">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1918">Issue #1918</a>:</p>
<blockquote>
<p>You have to pass <code>--features experimental_x64</code> to <code>cargo build</code>.</p>
</blockquote>



<a name="202009420"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231918%20Add%20config%20isa%20to%20c%20api/near/202009420" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231918.20Add.20config.20isa.20to.20c.20api.html#202009420">(Jun 25 2020 at 18:50)</a>:</h4>
<p>jlb6740 <a href="https://github.com/bytecodealliance/wasmtime/pull/1918#issuecomment-649756256">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1918">Issue #1918</a>:</p>
<blockquote>
<blockquote>
<p>You have to pass <code>--features experimental_x64</code> to <code>cargo build</code>.</p>
</blockquote>
<p>I do that now. It's not enough. The guard in codegen/src/isa/x86/mod.rs is what I have to comment out:</p>
<blockquote>
<div class="codehilite"><pre><span></span><code>if isa_flags.use_new_backend() {
    #[cfg(not(feature = &quot;x64&quot;))]
    panic!(&quot;new backend x86 support not included by cargo features!&quot;);

    #[cfg(feature = &quot;x64&quot;)]
    super::x64::isa_builder(triple).finish(shared_flags)
} else {
    Box::new(Isa {
        triple,
        isa_flags,
        shared_flags,
        cpumode: level1,
    })
</code></pre></div>


</blockquote>
</blockquote>



<a name="202009729"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231918%20Add%20config%20isa%20to%20c%20api/near/202009729" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231918.20Add.20config.20isa.20to.20c.20api.html#202009729">(Jun 25 2020 at 18:52)</a>:</h4>
<p>jlb6740 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/1918#issuecomment-649756256">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1918">Issue #1918</a>:</p>
<blockquote>
<p>Thanks @bjorn3</p>
<blockquote>
<p>You have to pass <code>--features experimental_x64</code> to <code>cargo build</code>.</p>
</blockquote>
<p>I do that now. It's not enough. The guard in codegen/src/isa/x86/mod.rs is what I have to comment out:</p>
<blockquote>
<div class="codehilite"><pre><span></span><code>if isa_flags.use_new_backend() {
    #[cfg(not(feature = &quot;x64&quot;))]
    panic!(&quot;new backend x86 support not included by cargo features!&quot;);

    #[cfg(feature = &quot;x64&quot;)]
    super::x64::isa_builder(triple).finish(shared_flags)
} else {
    Box::new(Isa {
        triple,
        isa_flags,
        shared_flags,
        cpumode: level1,
    })
</code></pre></div>


</blockquote>
</blockquote>



<a name="202024698"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231918%20Add%20config%20isa%20to%20c%20api/near/202024698" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231918.20Add.20config.20isa.20to.20c.20api.html#202024698">(Jun 25 2020 at 21:03)</a>:</h4>
<p>jlb6740 <a href="https://github.com/bytecodealliance/wasmtime/pull/1918#issuecomment-649816390">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1918">Issue #1918</a>:</p>
<blockquote>
<p>FYI ... it's not clear to me when --features=experimental_x64 is needed because </p>
<blockquote>
<p>[features]<br>
default = ["disas", "wasm", "cranelift-codegen/all-arch"]</p>
</blockquote>
<p>Is already set in cranelift/cargo.toml by default. Separately there is the set use_new_backend flag that can be passed to cranelift cli and I think this is the flag that I am trying to toggle (in a more generic way) with the wasmtime c-api.</p>
</blockquote>



<a name="202024773"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231918%20Add%20config%20isa%20to%20c%20api/near/202024773" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231918.20Add.20config.20isa.20to.20c.20api.html#202024773">(Jun 25 2020 at 21:04)</a>:</h4>
<p>jlb6740 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/1918#issuecomment-649816390">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1918">Issue #1918</a>:</p>
<blockquote>
<p>Also ... it's not clear to me when --features=experimental_x64 is needed because </p>
<blockquote>
<p>[features]<br>
default = ["disas", "wasm", "cranelift-codegen/all-arch"]</p>
</blockquote>
<p>Is already set in cranelift/cargo.toml by default. Separately there is the set use_new_backend flag that can be passed to cranelift cli and I think this is the flag that I am trying to toggle (in a more generic way) with the wasmtime c-api.</p>
</blockquote>



<a name="202069254"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231918%20Add%20config%20isa%20to%20c%20api/near/202069254" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231918.20Add.20config.20isa.20to.20c.20api.html#202069254">(Jun 26 2020 at 09:30)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/1918#issuecomment-650085337">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1918">Issue #1918</a>:</p>
<blockquote>
<p>I thought <code>experimental_x64</code> caused <code>use_new_backend</code> to be set by default.</p>
</blockquote>



<a name="202070142"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231918%20Add%20config%20isa%20to%20c%20api/near/202070142" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231918.20Add.20config.20isa.20to.20c.20api.html#202070142">(Jun 26 2020 at 09:41)</a>:</h4>
<p>bnjbvr <a href="https://github.com/bytecodealliance/wasmtime/pull/1918#issuecomment-650089766">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1918">Issue #1918</a>:</p>
<blockquote>
<p>Some clarification here:</p>
<ul>
<li><code>clif-util</code> compiles with support for all the architectures, and this what you see in <code>cranelift/Cargo.toml</code>, so this includes the support for building the x64 backend. Then, one needs to set the <code>use_new_backend</code> to dynamically request the new backend to be used. (This was mostly a workaround around the construction of the TargetIsas, which map 1:1 with the host target triple parsed by <code>--target</code>; we needed a way to distinguish between x86_64 in the old backend vs in the new backend)</li>
<li><code>wasmtime</code> doesn't compile with support for all the architectures by default; by using <code>--experimental_x64</code>, you enable build support for the x64 new backend. But then the <code>use_new_backend</code> flag must be passed with <code>--cranelift-other-flags</code>.</li>
</ul>
</blockquote>



<a name="212460094"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231918%20Add%20config%20isa%20to%20c%20api/near/212460094" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231918.20Add.20config.20isa.20to.20c.20api.html#212460094">(Oct 06 2020 at 17:35)</a>:</h4>
<p>jlb6740 <a href="https://github.com/bytecodealliance/wasmtime/pull/1918#issuecomment-704435428">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1918">Issue #1918</a>:</p>
<blockquote>
<p>Closing this draft PR. @bnjbvr clarified somethings for me here but beyond that I believe API updates have made what was intended here obsolete. </p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>