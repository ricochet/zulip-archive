<html>
<head><meta charset="utf-8"><title>wasmtime / issue #8624 Small difference makes suspicion p... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238624.20Small.20difference.20makes.20suspicion.20p.2E.2E.2E.html">wasmtime / issue #8624 Small difference makes suspicion p...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="438810062"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238624%20Small%20difference%20makes%20suspicion%20p.../near/438810062" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238624.20Small.20difference.20makes.20suspicion.20p.2E.2E.2E.html#438810062">(May 15 2024 at 14:03)</a>:</h4>
<p>hungryzzz opened <a href="https://github.com/bytecodealliance/wasmtime/issues/8624">issue #8624</a>:</p>
<blockquote>
<h3>Test Cases</h3>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/15321821/cases.zip">cases.zip</a></p>
<h3>Steps to Reproduce</h3>
<p>Hi, I run the attached two cases(<code>good.wasm</code>&amp;<code>bad.wasm</code>) in <code>Wasmtime</code> and WasmEdge(AOT), and collect their execution time respectively (measured by time tool).</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="c1"># command to collect execution time of wasmtime</span>
wasmtime<span class="w"> </span>compile<span class="w"> </span>bad.wasm<span class="w"> </span>-o<span class="w"> </span>bad.cwasm
<span class="nb">time</span><span class="w"> </span>wasmtime<span class="w"> </span>run<span class="w"> </span>--allow-precompiled<span class="w"> </span>bad.cwasm

<span class="c1"># command to collect execution time of wasmedge</span>
wasmedgec<span class="w"> </span>bad.wasm<span class="w"> </span>bad-wasmedge-aot.wasm
<span class="nb">time</span><span class="w"> </span>wasmedge<span class="w"> </span>bad-wasmedge-aot.wasm
</code></pre></div>
<h3>Expected Results &amp; Actual Results</h3>
<p>For <code>good.wasm</code>, the execution time in different runtimes are as follows:</p>
<ul>
<li>Wasmtime: 1.17s</li>
<li>WasmEdge: 0.59s</li>
</ul>
<p>For <code>bad.wasm</code>, the execution time in different runtimes are as follows:</p>
<ul>
<li>Wasmtime: 6.01s</li>
<li>WasmEdge: 0.59s</li>
</ul>
<p>The difference between the attached two cases is as follow, i.e., changing the operand of <code>i32.add</code> from <code>i32.const 0</code> to <code>local.get 1</code>, which can bring 5x performance decreasing on <code>Wasmtime</code> but has no effect on <code>WasmEdge</code>.</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>➜<span class="w">  </span>cases<span class="w"> </span>diff<span class="w"> </span>good.wat<span class="w"> </span>bad.wat
62c62
&lt;<span class="w">                       </span>i32.const<span class="w"> </span><span class="m">0</span>
---
&gt;<span class="w">                       </span>local.get<span class="w"> </span><span class="m">1</span>
</code></pre></div>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="err">#</span> <span class="err">good.wat</span>
<span class="nb">i32.const</span> <span class="mi">0</span>
<span class="nb">i32.const</span> <span class="mi">1</span>
<span class="nb">i32.add</span>

<span class="err">#</span> <span class="err">bad.wat</span>
<span class="nb">local.get</span> <span class="mi">1</span>
<span class="nb">i32.const</span> <span class="mi">1</span>
<span class="nb">i32.add</span>
</code></pre></div>
<p>At first I thought the performance decreasing was caused by the difference, because the <code>good</code> one uses a constant while the <code>bad</code> one uses a local variable which may need to fetch from memory. So I do a small experiment: repeatly calculate (<code>2000000000</code> times) an addition operation whose operand are a constant or a local variable and measure the execution time respectively. And I find that they are almost the same, <code>1.09s</code> vs. <code>1.1s</code>. Therefore, I think the above performance decreasing is caused by other reasons.</p>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="err">#</span> <span class="err">experiment</span> <span class="err">case</span>
<span class="p">(</span><span class="k">module</span>
  <span class="p">(</span><span class="k">type</span> <span class="cm">(;0;)</span> <span class="p">(</span><span class="k">func</span><span class="p">))</span>
  <span class="p">(</span><span class="k">type</span> <span class="cm">(;1;)</span> <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">param</span> <span class="kt">i32</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">import</span> <span class="s2">"wasi_snapshot_preview1"</span> <span class="s2">"proc_exit"</span> <span class="p">(</span><span class="k">func</span> <span class="cm">(;0;)</span> <span class="p">(</span><span class="k">type</span> <span class="mi">1</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">func</span> <span class="cm">(;1;)</span> <span class="p">(</span><span class="k">type</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">(</span><span class="k">local</span> <span class="kt">i32</span> <span class="kt">i32</span><span class="p">)</span>
    <span class="k">loop</span>
      <span class="c1">;; i32.const 0</span>
      <span class="nb">local.get</span> <span class="mi">1</span>
      <span class="nb">i32.const</span> <span class="mi">1</span>
      <span class="nb">i32.add</span>
      <span class="nb">local.get</span> <span class="mi">0</span>
      <span class="nb">i32.add</span>
      <span class="nb">local.tee</span> <span class="mi">0</span>
      <span class="nb">i32.const</span> <span class="mf">2000000000</span>
      <span class="nb">i32.ne</span>
      <span class="nb">br_if</span> <span class="mi">0</span>
    <span class="k">end</span>
    <span class="nb">i32.const</span> <span class="mi">0</span>
    <span class="nb">call</span> <span class="mi">0</span>
    <span class="nb">unreachable</span><span class="p">)</span>
  <span class="p">(</span><span class="k">memory</span> <span class="cm">(;0;)</span> <span class="mf">8192</span> <span class="mf">8192</span><span class="p">)</span>
  <span class="p">(</span><span class="k">export</span> <span class="s2">"_start"</span> <span class="p">(</span><span class="k">func</span> <span class="mi">1</span><span class="p">))</span>
  <span class="p">(</span><span class="k">export</span> <span class="s2">"memory"</span> <span class="p">(</span><span class="k">memory</span> <span class="mi">0</span><span class="p">)))</span>
</code></pre></div>
<h3>Profiling Information</h3>
<p>I use Perf tool to profile the execution time and find that the hotspot is in the loop where the small difference happens, so I think the difference change some compilation strategy which may cause the performance decreasing.</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>Samples:<span class="w"> </span>23K<span class="w"> </span>of<span class="w"> </span>event<span class="w"> </span><span class="s1">'cycles'</span>,<span class="w"> </span>Event<span class="w"> </span>count<span class="w"> </span><span class="o">(</span>approx.<span class="o">)</span>:<span class="w"> </span><span class="m">21853956752</span>
Overhead<span class="w">  </span>Command<span class="w">          </span>Shared<span class="w"> </span>Object<span class="w">      </span>Symbol
<span class="w">  </span><span class="m">99</span>.87%<span class="w">  </span>wasmtime<span class="w">         </span>jitted-93855-1.so<span class="w">  </span><span class="o">[</span>.<span class="o">]</span><span class="w"> </span>wasm<span class="o">[</span><span class="m">0</span><span class="o">]</span>::function<span class="o">[</span><span class="m">2</span><span class="o">]</span><span class="w">                                                                                           </span>▒
<span class="w">   </span><span class="m">0</span>.02%<span class="w">  </span>tokio-runtime-w<span class="w">  </span><span class="o">[</span>kernel.kallsyms<span class="o">]</span><span class="w">  </span><span class="o">[</span>k<span class="o">]</span><span class="w"> </span>__mod_memcg_lruvec_state<span class="w">                                                                                       </span>▒
<span class="w">   </span><span class="m">0</span>.02%<span class="w">  </span>wasmtime<span class="w">         </span>ld-2.31.so<span class="w">         </span><span class="o">[</span>.<span class="o">]</span><span class="w"> </span>_dl_relocate_object<span class="w">                                                                                            </span>▒
<span class="w">   </span><span class="m">0</span>.02%<span class="w">  </span>wasmtime<span class="w">         </span><span class="o">[</span>kernel.kallsyms<span class="o">]</span><span class="w">  </span><span class="o">[</span>k<span class="o">]</span><span class="w"> </span>__do_fault<span class="w">                                                                                                     </span>▒
<span class="w">   </span><span class="m">0</span>.01%<span class="w">  </span>wasmtime<span class="w">         </span><span class="o">[</span>kernel.kallsyms<span class="o">]</span><span class="w">  </span><span class="o">[</span>k<span class="o">]</span><span class="w"> </span>pmd_page_vaddr<span class="w">                                                                                                 </span>▒
</code></pre></div>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="c1"># the commands to profile</span>
perf<span class="w"> </span>record<span class="w"> </span>-k<span class="w"> </span>mono<span class="w"> </span>~/wasmtime/target/release/wasmtime<span class="w"> </span>run<span class="w"> </span>--profile<span class="w"> </span>jitdump<span class="w"> </span>--allow-precompiled<span class="w"> </span>bad.cwasm
perf<span class="w"> </span>inject<span class="w"> </span>--jit<span class="w"> </span>--input<span class="w"> </span>perf.data<span class="w"> </span>--output<span class="w"> </span>perf.jit.data
perf<span class="w"> </span>report<span class="w"> </span>--input<span class="w"> </span>perf.jit.data<span class="w"> </span>--no-children
</code></pre></div>
<h3>Versions and Environment</h3>
<ul>
<li>Wasmtime version or commit: d0cf46a098d97bab9</li>
<li>Operating system: Linux ringzzz-OptiPlex-7070 5.15.0-97-generic</li>
<li>Architecture: Intel(R) Core(TM) i5-9500T CPU @ 2.20GHz<br>
</li>
</ul>
</blockquote>



<a name="438819015"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238624%20Small%20difference%20makes%20suspicion%20p.../near/438819015" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238624.20Small.20difference.20makes.20suspicion.20p.2E.2E.2E.html#438819015">(May 15 2024 at 14:38)</a>:</h4>
<p>hungryzzz edited <a href="https://github.com/bytecodealliance/wasmtime/issues/8624">issue #8624</a>:</p>
<blockquote>
<h3>Test Cases</h3>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/15321821/cases.zip">cases.zip</a></p>
<h3>Steps to Reproduce</h3>
<p>Hi, I run the attached two cases(<code>good.wasm</code>&amp;<code>bad.wasm</code>) in <code>Wasmtime</code> and <code>WasmEdge</code>(AOT), and collect their execution time respectively (measured by time tool).</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="c1"># command to collect execution time of wasmtime</span>
wasmtime<span class="w"> </span>compile<span class="w"> </span>bad.wasm<span class="w"> </span>-o<span class="w"> </span>bad.cwasm
<span class="nb">time</span><span class="w"> </span>wasmtime<span class="w"> </span>run<span class="w"> </span>--allow-precompiled<span class="w"> </span>bad.cwasm

<span class="c1"># command to collect execution time of wasmedge</span>
wasmedgec<span class="w"> </span>bad.wasm<span class="w"> </span>bad-wasmedge-aot.wasm
<span class="nb">time</span><span class="w"> </span>wasmedge<span class="w"> </span>bad-wasmedge-aot.wasm
</code></pre></div>
<h3>Expected Results &amp; Actual Results</h3>
<p>For <code>good.wasm</code>, the execution time in different runtimes are as follows:</p>
<ul>
<li>Wasmtime: 1.17s</li>
<li>WasmEdge: 0.59s</li>
</ul>
<p>For <code>bad.wasm</code>, the execution time in different runtimes are as follows:</p>
<ul>
<li>Wasmtime: 6.01s</li>
<li>WasmEdge: 0.59s</li>
</ul>
<p>The difference between the attached two cases is as follow, i.e., changing the operand of <code>i32.add</code> from <code>i32.const 0</code> to <code>local.get 1</code>, which can bring 5x performance decreasing on <code>Wasmtime</code> but has no effect on <code>WasmEdge</code>.</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>➜<span class="w">  </span>cases<span class="w"> </span>diff<span class="w"> </span>good.wat<span class="w"> </span>bad.wat
62c62
&lt;<span class="w">                       </span>i32.const<span class="w"> </span><span class="m">0</span>
---
&gt;<span class="w">                       </span>local.get<span class="w"> </span><span class="m">1</span>
</code></pre></div>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="err">#</span> <span class="err">good.wat</span>
<span class="nb">i32.const</span> <span class="mi">0</span>
<span class="nb">i32.const</span> <span class="mi">1</span>
<span class="nb">i32.add</span>

<span class="err">#</span> <span class="err">bad.wat</span>
<span class="nb">local.get</span> <span class="mi">1</span>
<span class="nb">i32.const</span> <span class="mi">1</span>
<span class="nb">i32.add</span>
</code></pre></div>
<p>At first I thought the performance decreasing was caused by the difference, because the <code>good</code> one uses a constant while the <code>bad</code> one uses a local variable which may need to fetch from memory. So I do a small experiment: repeatly calculate (<code>2000000000</code> times) an addition operation whose operand are a constant or a local variable and measure the execution time respectively. And I find that they are almost the same, <code>1.09s</code> vs. <code>1.1s</code>. Therefore, I think the above performance decreasing is caused by other reasons.</p>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="err">#</span> <span class="err">experiment</span> <span class="err">case</span>
<span class="p">(</span><span class="k">module</span>
  <span class="p">(</span><span class="k">type</span> <span class="cm">(;0;)</span> <span class="p">(</span><span class="k">func</span><span class="p">))</span>
  <span class="p">(</span><span class="k">type</span> <span class="cm">(;1;)</span> <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">param</span> <span class="kt">i32</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">import</span> <span class="s2">"wasi_snapshot_preview1"</span> <span class="s2">"proc_exit"</span> <span class="p">(</span><span class="k">func</span> <span class="cm">(;0;)</span> <span class="p">(</span><span class="k">type</span> <span class="mi">1</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">func</span> <span class="cm">(;1;)</span> <span class="p">(</span><span class="k">type</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">(</span><span class="k">local</span> <span class="kt">i32</span> <span class="kt">i32</span><span class="p">)</span>
    <span class="k">loop</span>
      <span class="c1">;; i32.const 0</span>
      <span class="nb">local.get</span> <span class="mi">1</span>
      <span class="nb">i32.const</span> <span class="mi">1</span>
      <span class="nb">i32.add</span>
      <span class="nb">local.get</span> <span class="mi">0</span>
      <span class="nb">i32.add</span>
      <span class="nb">local.tee</span> <span class="mi">0</span>
      <span class="nb">i32.const</span> <span class="mf">2000000000</span>
      <span class="nb">i32.ne</span>
      <span class="nb">br_if</span> <span class="mi">0</span>
    <span class="k">end</span>
    <span class="nb">i32.const</span> <span class="mi">0</span>
    <span class="nb">call</span> <span class="mi">0</span>
    <span class="nb">unreachable</span><span class="p">)</span>
  <span class="p">(</span><span class="k">memory</span> <span class="cm">(;0;)</span> <span class="mf">8192</span> <span class="mf">8192</span><span class="p">)</span>
  <span class="p">(</span><span class="k">export</span> <span class="s2">"_start"</span> <span class="p">(</span><span class="k">func</span> <span class="mi">1</span><span class="p">))</span>
  <span class="p">(</span><span class="k">export</span> <span class="s2">"memory"</span> <span class="p">(</span><span class="k">memory</span> <span class="mi">0</span><span class="p">)))</span>
</code></pre></div>
<h3>Profiling Information</h3>
<p>I use Perf tool to profile the execution time and find that the hotspot is in the loop where the small difference happens, so I think the difference change some compilation strategy which may cause the performance decreasing.</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>Samples:<span class="w"> </span>23K<span class="w"> </span>of<span class="w"> </span>event<span class="w"> </span><span class="s1">'cycles'</span>,<span class="w"> </span>Event<span class="w"> </span>count<span class="w"> </span><span class="o">(</span>approx.<span class="o">)</span>:<span class="w"> </span><span class="m">21853956752</span>
Overhead<span class="w">  </span>Command<span class="w">          </span>Shared<span class="w"> </span>Object<span class="w">      </span>Symbol
<span class="w">  </span><span class="m">99</span>.87%<span class="w">  </span>wasmtime<span class="w">         </span>jitted-93855-1.so<span class="w">  </span><span class="o">[</span>.<span class="o">]</span><span class="w"> </span>wasm<span class="o">[</span><span class="m">0</span><span class="o">]</span>::function<span class="o">[</span><span class="m">2</span><span class="o">]</span><span class="w">                                                                                           </span>▒
<span class="w">   </span><span class="m">0</span>.02%<span class="w">  </span>tokio-runtime-w<span class="w">  </span><span class="o">[</span>kernel.kallsyms<span class="o">]</span><span class="w">  </span><span class="o">[</span>k<span class="o">]</span><span class="w"> </span>__mod_memcg_lruvec_state<span class="w">                                                                                       </span>▒
<span class="w">   </span><span class="m">0</span>.02%<span class="w">  </span>wasmtime<span class="w">         </span>ld-2.31.so<span class="w">         </span><span class="o">[</span>.<span class="o">]</span><span class="w"> </span>_dl_relocate_object<span class="w">                                                                                            </span>▒
<span class="w">   </span><span class="m">0</span>.02%<span class="w">  </span>wasmtime<span class="w">         </span><span class="o">[</span>kernel.kallsyms<span class="o">]</span><span class="w">  </span><span class="o">[</span>k<span class="o">]</span><span class="w"> </span>__do_fault<span class="w">                                                                                                     </span>▒
<span class="w">   </span><span class="m">0</span>.01%<span class="w">  </span>wasmtime<span class="w">         </span><span class="o">[</span>kernel.kallsyms<span class="o">]</span><span class="w">  </span><span class="o">[</span>k<span class="o">]</span><span class="w"> </span>pmd_page_vaddr<span class="w">                                                                                                 </span>▒
</code></pre></div>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="c1"># the commands to profile</span>
perf<span class="w"> </span>record<span class="w"> </span>-k<span class="w"> </span>mono<span class="w"> </span>~/wasmtime/target/release/wasmtime<span class="w"> </span>run<span class="w"> </span>--profile<span class="w"> </span>jitdump<span class="w"> </span>--allow-precompiled<span class="w"> </span>bad.cwasm
perf<span class="w"> </span>inject<span class="w"> </span>--jit<span class="w"> </span>--input<span class="w"> </span>perf.data<span class="w"> </span>--output<span class="w"> </span>perf.jit.data
perf<span class="w"> </span>report<span class="w"> </span>--input<span class="w"> </span>perf.jit.data<span class="w"> </span>--no-children
</code></pre></div>
<h3>Versions and Environment</h3>
<ul>
<li>Wasmtime version or commit: d0cf46a098d97bab9</li>
<li>Operating system: Linux ringzzz-OptiPlex-7070 5.15.0-97-generic</li>
<li>Architecture: Intel(R) Core(TM) i5-9500T CPU @ 2.20GHz<br>
</li>
</ul>
</blockquote>



<a name="438826201"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238624%20Small%20difference%20makes%20suspicion%20p.../near/438826201" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238624.20Small.20difference.20makes.20suspicion.20p.2E.2E.2E.html#438826201">(May 15 2024 at 15:08)</a>:</h4>
<p>hungryzzz edited <a href="https://github.com/bytecodealliance/wasmtime/issues/8624">issue #8624</a>:</p>
<blockquote>
<h3>Test Cases</h3>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/15321821/cases.zip">cases.zip</a></p>
<h3>Steps to Reproduce</h3>
<p>Hi, I run the attached two cases(<code>good.wasm</code>&amp;<code>bad.wasm</code>) in <code>Wasmtime</code> and <code>WasmEdge</code>(AOT), and collect their execution time respectively (measured by time tool).</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="c1"># command to collect execution time of wasmtime</span>
wasmtime<span class="w"> </span>compile<span class="w"> </span>bad.wasm<span class="w"> </span>-o<span class="w"> </span>bad.cwasm
<span class="nb">time</span><span class="w"> </span>wasmtime<span class="w"> </span>run<span class="w"> </span>--allow-precompiled<span class="w"> </span>bad.cwasm

<span class="c1"># command to collect execution time of wasmedge</span>
wasmedgec<span class="w"> </span>bad.wasm<span class="w"> </span>bad-wasmedge-aot.wasm
<span class="nb">time</span><span class="w"> </span>wasmedge<span class="w"> </span>bad-wasmedge-aot.wasm
</code></pre></div>
<h3>Expected Results &amp; Actual Results</h3>
<p>For <code>good.wasm</code>, the execution time in different runtimes are as follows:</p>
<ul>
<li>Wasmtime: 1.17s</li>
<li>WasmEdge: 0.59s</li>
</ul>
<p>For <code>bad.wasm</code>, the execution time in different runtimes are as follows:</p>
<ul>
<li>Wasmtime: 6.01s</li>
<li>WasmEdge: 0.59s</li>
</ul>
<p>The difference between the attached two cases is as follow, i.e., changing the operand of <code>i32.add</code> from <code>i32.const 0</code> to <code>local.get 1</code>, which can bring 5x performance decreasing on <code>Wasmtime</code> but has no effect on <code>WasmEdge</code>.</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>➜<span class="w">  </span>cases<span class="w"> </span>diff<span class="w"> </span>good.wat<span class="w"> </span>bad.wat
62c62
&lt;<span class="w">                       </span>i32.const<span class="w"> </span><span class="m">0</span>
---
&gt;<span class="w">                       </span>local.get<span class="w"> </span><span class="m">1</span>
</code></pre></div>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="c1">;; good.wat</span>
<span class="nb">i32.const</span> <span class="mi">0</span>
<span class="nb">i32.const</span> <span class="mi">1</span>
<span class="nb">i32.add</span>

<span class="c1">;; bad.wat</span>
<span class="nb">local.get</span> <span class="mi">1</span>
<span class="nb">i32.const</span> <span class="mi">1</span>
<span class="nb">i32.add</span>
</code></pre></div>
<p>At first I thought the performance decreasing was caused by the difference, because the <code>good</code> one uses a constant while the <code>bad</code> one uses a local variable which may need to fetch from memory. So I do a small experiment: repeatly calculate (<code>2000000000</code> times) an addition operation whose operand are a constant or a local variable and measure the execution time respectively. And I find that they are almost the same, <code>1.09s</code> vs. <code>1.1s</code>. Therefore, I think the above performance decreasing is caused by other reasons.</p>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="c1">;; experiment case</span>
<span class="p">(</span><span class="k">module</span>
  <span class="p">(</span><span class="k">type</span> <span class="cm">(;0;)</span> <span class="p">(</span><span class="k">func</span><span class="p">))</span>
  <span class="p">(</span><span class="k">type</span> <span class="cm">(;1;)</span> <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">param</span> <span class="kt">i32</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">import</span> <span class="s2">"wasi_snapshot_preview1"</span> <span class="s2">"proc_exit"</span> <span class="p">(</span><span class="k">func</span> <span class="cm">(;0;)</span> <span class="p">(</span><span class="k">type</span> <span class="mi">1</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">func</span> <span class="cm">(;1;)</span> <span class="p">(</span><span class="k">type</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">(</span><span class="k">local</span> <span class="kt">i32</span> <span class="kt">i32</span><span class="p">)</span>
    <span class="k">loop</span>
      <span class="c1">;; i32.const 0</span>
      <span class="nb">local.get</span> <span class="mi">1</span>
      <span class="nb">i32.const</span> <span class="mi">1</span>
      <span class="nb">i32.add</span>
      <span class="nb">local.get</span> <span class="mi">0</span>
      <span class="nb">i32.add</span>
      <span class="nb">local.tee</span> <span class="mi">0</span>
      <span class="nb">i32.const</span> <span class="mf">2000000000</span>
      <span class="nb">i32.ne</span>
      <span class="nb">br_if</span> <span class="mi">0</span>
    <span class="k">end</span>
    <span class="nb">i32.const</span> <span class="mi">0</span>
    <span class="nb">call</span> <span class="mi">0</span>
    <span class="nb">unreachable</span><span class="p">)</span>
  <span class="p">(</span><span class="k">memory</span> <span class="cm">(;0;)</span> <span class="mf">8192</span> <span class="mf">8192</span><span class="p">)</span>
  <span class="p">(</span><span class="k">export</span> <span class="s2">"_start"</span> <span class="p">(</span><span class="k">func</span> <span class="mi">1</span><span class="p">))</span>
  <span class="p">(</span><span class="k">export</span> <span class="s2">"memory"</span> <span class="p">(</span><span class="k">memory</span> <span class="mi">0</span><span class="p">)))</span>
</code></pre></div>
<h3>Profiling Information</h3>
<p>I use Perf tool to profile the execution time and find that the hotspot is in the loop where the small difference happens, so I think the difference change some compilation strategy which may cause the performance decreasing.</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>Samples:<span class="w"> </span>23K<span class="w"> </span>of<span class="w"> </span>event<span class="w"> </span><span class="s1">'cycles'</span>,<span class="w"> </span>Event<span class="w"> </span>count<span class="w"> </span><span class="o">(</span>approx.<span class="o">)</span>:<span class="w"> </span><span class="m">21853956752</span>
Overhead<span class="w">  </span>Command<span class="w">          </span>Shared<span class="w"> </span>Object<span class="w">      </span>Symbol
<span class="w">  </span><span class="m">99</span>.87%<span class="w">  </span>wasmtime<span class="w">         </span>jitted-93855-1.so<span class="w">  </span><span class="o">[</span>.<span class="o">]</span><span class="w"> </span>wasm<span class="o">[</span><span class="m">0</span><span class="o">]</span>::function<span class="o">[</span><span class="m">2</span><span class="o">]</span><span class="w">                                                                                           </span>▒
<span class="w">   </span><span class="m">0</span>.02%<span class="w">  </span>tokio-runtime-w<span class="w">  </span><span class="o">[</span>kernel.kallsyms<span class="o">]</span><span class="w">  </span><span class="o">[</span>k<span class="o">]</span><span class="w"> </span>__mod_memcg_lruvec_state<span class="w">                                                                                       </span>▒
<span class="w">   </span><span class="m">0</span>.02%<span class="w">  </span>wasmtime<span class="w">         </span>ld-2.31.so<span class="w">         </span><span class="o">[</span>.<span class="o">]</span><span class="w"> </span>_dl_relocate_object<span class="w">                                                                                            </span>▒
<span class="w">   </span><span class="m">0</span>.02%<span class="w">  </span>wasmtime<span class="w">         </span><span class="o">[</span>kernel.kallsyms<span class="o">]</span><span class="w">  </span><span class="o">[</span>k<span class="o">]</span><span class="w"> </span>__do_fault<span class="w">                                                                                                     </span>▒
<span class="w">   </span><span class="m">0</span>.01%<span class="w">  </span>wasmtime<span class="w">         </span><span class="o">[</span>kernel.kallsyms<span class="o">]</span><span class="w">  </span><span class="o">[</span>k<span class="o">]</span><span class="w"> </span>pmd_page_vaddr<span class="w">                                                                                                 </span>▒
</code></pre></div>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="c1"># the commands to profile</span>
perf<span class="w"> </span>record<span class="w"> </span>-k<span class="w"> </span>mono<span class="w"> </span>~/wasmtime/target/release/wasmtime<span class="w"> </span>run<span class="w"> </span>--profile<span class="w"> </span>jitdump<span class="w"> </span>--allow-precompiled<span class="w"> </span>bad.cwasm
perf<span class="w"> </span>inject<span class="w"> </span>--jit<span class="w"> </span>--input<span class="w"> </span>perf.data<span class="w"> </span>--output<span class="w"> </span>perf.jit.data
perf<span class="w"> </span>report<span class="w"> </span>--input<span class="w"> </span>perf.jit.data<span class="w"> </span>--no-children
</code></pre></div>
<h3>Versions and Environment</h3>
<ul>
<li>Wasmtime version or commit: d0cf46a098d97bab9</li>
<li>Operating system: Linux ringzzz-OptiPlex-7070 5.15.0-97-generic</li>
<li>Architecture: Intel(R) Core(TM) i5-9500T CPU @ 2.20GHz<br>
</li>
</ul>
</blockquote>



<a name="438835371"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238624%20Small%20difference%20makes%20suspicion%20p.../near/438835371" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238624.20Small.20difference.20makes.20suspicion.20p.2E.2E.2E.html#438835371">(May 15 2024 at 15:52)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8624#issuecomment-2112911340">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8624">issue #8624</a>:</p>
<blockquote>
<p>Locally on Intel(R) Core(TM) i9-14900K I get 0.9s on bad.wasm and 0.74s on good.wasm</p>
<p>Profiling good.wasm the hot loop is, according to <code>perf</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">       </span><span class="err">│</span><span class="w"> </span><span class="n">d5</span>:<span class="err">┌─→</span><span class="n">mov</span><span class="w">    </span><span class="p">(</span><span class="o">%</span><span class="n">rbx</span><span class="p">),</span><span class="o">%</span><span class="n">r10d</span><span class="w">                                                                                                                                                                                                                                                                                             </span><span class="err">▒</span>
<span class="w">       </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">  </span><span class="n">add</span><span class="w">    </span><span class="cp">$</span><span class="mh">0x1</span><span class="p">,</span><span class="o">%</span><span class="n">r13d</span><span class="w">                                                                                                                                                                                                                                                                                               </span><span class="err">▒</span>
<span class="w">       </span><span class="err">│</span><span class="w">    </span><span class="err">├──</span><span class="n">test</span><span class="w">   </span><span class="o">%</span><span class="n">r13d</span><span class="p">,</span><span class="o">%</span><span class="n">r13d</span><span class="w">                                                                                                                                                                                                                                                                                              </span><span class="err">▒</span>
<span class="mf">100.00</span><span class="w"> </span><span class="err">│</span><span class="w">    </span><span class="err">└──</span><span class="n">jne</span><span class="w">    </span><span class="n">d5</span><span class="w">                                                                                                                                                                                                                                                                                                       </span><span class="err">▒</span>
</code></pre></div>
<p>For <code>bad.wasm</code> it's</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">       </span><span class="err">│</span><span class="w"> </span><span class="n">c5</span>:<span class="err">┌─→</span><span class="n">mov</span><span class="w">    </span><span class="p">(</span><span class="o">%</span><span class="n">rbx</span><span class="p">),</span><span class="o">%</span><span class="n">r10d</span><span class="w">                                                                                                                                                                                                                                                                                             </span><span class="err">▒</span>
<span class="w">       </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">  </span><span class="n">mov</span><span class="w">    </span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="o">%</span><span class="n">rcx</span><span class="w">                                                                                                                                                                                                                                                                                              </span><span class="err">▒</span>
<span class="w">  </span><span class="mf">0.09</span><span class="w"> </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">  </span><span class="n">lea</span><span class="w">    </span><span class="mh">0x1</span><span class="p">(</span><span class="o">%</span><span class="n">rcx</span><span class="p">),</span><span class="o">%</span><span class="n">r10d</span><span class="w">                                                                                                                                                                                                                                                                                          </span><span class="err">▒</span>
<span class="w"> </span><span class="mf">55.32</span><span class="w"> </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">  </span><span class="n">test</span><span class="w">   </span><span class="o">%</span><span class="n">r10d</span><span class="p">,</span><span class="o">%</span><span class="n">r10d</span><span class="w">                                                                                                                                                                                                                                                                                              </span><span class="err">▒</span>
<span class="w">       </span><span class="err">│</span><span class="w">    </span><span class="err">│↓</span><span class="w"> </span><span class="n">je</span><span class="w">     </span><span class="n">e5</span><span class="w">                                                                                                                                                                                                                                                                                                       </span><span class="err">▒</span>
<span class="w">  </span><span class="mf">0.06</span><span class="w"> </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">  </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">r10</span><span class="p">,</span><span class="o">%</span><span class="n">rcx</span><span class="w">                                                                                                                                                                                                                                                                                                </span><span class="err">▒</span>
<span class="w">  </span><span class="mf">0.03</span><span class="w"> </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">  </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rcx</span><span class="p">,(</span><span class="o">%</span><span class="n">rsp</span><span class="p">)</span><span class="w">                                                                                                                                                                                                                                                                                              </span><span class="err">▒</span>
<span class="w"> </span><span class="mf">44.51</span><span class="w"> </span><span class="err">│</span><span class="w">    </span><span class="err">└──</span><span class="n">jmp</span><span class="w">    </span><span class="n">c5</span><span class="w">                                                                                                                                                                                                                                                                                                       </span><span class="err">▒</span>
<span class="w">       </span><span class="err">│</span><span class="w"> </span><span class="n">e5</span>:   <span class="nc">xor</span><span class="w">    </span><span class="o">%</span><span class="n">edi</span><span class="p">,</span><span class="o">%</span><span class="n">edi</span><span class="w">                                                                                                                                                                                                                                                                                                </span><span class="err">▒</span>
</code></pre></div>
<p>I believe WasmEdge is an LLVM-based backend so it probably unrolls this loop or something similar. </p>
</blockquote>



<a name="439040047"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238624%20Small%20difference%20makes%20suspicion%20p.../near/439040047" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238624.20Small.20difference.20makes.20suspicion.20p.2E.2E.2E.html#439040047">(May 16 2024 at 14:56)</a>:</h4>
<p>hungryzzz <a href="https://github.com/bytecodealliance/wasmtime/issues/8624#issuecomment-2115478225">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8624">issue #8624</a>:</p>
<blockquote>
<p>I find that there is not difference between the binary generated by <code>WasmEdge</code> before and after changes, so I think maybe the block which contains the small changes is optimized (eliminated) during code generation in LLVM.</p>
</blockquote>



<a name="439041058"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238624%20Small%20difference%20makes%20suspicion%20p.../near/439041058" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238624.20Small.20difference.20makes.20suspicion.20p.2E.2E.2E.html#439041058">(May 16 2024 at 15:00)</a>:</h4>
<p>hungryzzz edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8624#issuecomment-2115478225">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8624">issue #8624</a>:</p>
<blockquote>
<p>I find that there is not difference between the binary generated by <code>WasmEdge</code> before and after changes, so I think maybe the block which contains the small changes is optimized (eliminated) during code generation in LLVM.</p>
<p>So maybe the performance decreasing in <code>Wasmtime</code> is caused by the newly generated instructions in loop, but I am still surprised that only the small changes in machine code can make more than 5 times performance impact...</p>
</blockquote>



<a name="439068080"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238624%20Small%20difference%20makes%20suspicion%20p.../near/439068080" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238624.20Small.20difference.20makes.20suspicion.20p.2E.2E.2E.html#439068080">(May 16 2024 at 17:26)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8624#issuecomment-2115819169">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8624">issue #8624</a>:</p>
<blockquote>
<p>My guess is you're hitting micro-architectural limits or things like that. Basically various cliffs in the CPU in terms of performance where once you fall off the happy path it's both difficult to explain why and difficult to understand the effects. That's just my best guess though.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>