<html>
<head><meta charset="utf-8"><title>wasmtime / issue #9515 Panic when calling host function i... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239515.20Panic.20when.20calling.20host.20function.20i.2E.2E.2E.html">wasmtime / issue #9515 Panic when calling host function i...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="479312612"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239515%20Panic%20when%20calling%20host%20function%20i.../near/479312612" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239515.20Panic.20when.20calling.20host.20function.20i.2E.2E.2E.html#479312612">(Oct 28 2024 at 16:15)</a>:</h4>
<p><a href="https://github.com/TheQuantumPhysicist">TheQuantumPhysicist</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/9515">Issue #9515</a>.</p>



<a name="479312619"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239515%20Panic%20when%20calling%20host%20function%20i.../near/479312619" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239515.20Panic.20when.20calling.20host.20function.20i.2E.2E.2E.html#479312619">(Oct 28 2024 at 16:15)</a>:</h4>
<p>TheQuantumPhysicist opened <a href="https://github.com/bytecodealliance/wasmtime/issues/9515">issue #9515</a>:</p>
<blockquote>
<h3>Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">future</span><span class="p">::</span><span class="n">Future</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">Config</span><span class="p">;</span>

<span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::{</span><span class="n">Engine</span><span class="p">,</span><span class="w"> </span><span class="n">Linker</span><span class="p">,</span><span class="w"> </span><span class="n">Module</span><span class="p">,</span><span class="w"> </span><span class="n">Store</span><span class="p">};</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">wasmtime_wasi</span><span class="p">::{</span>
<span class="w">        </span><span class="n">preview1</span><span class="p">::{</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">WasiP1Ctx</span><span class="p">},</span>
<span class="w">        </span><span class="n">WasiCtxBuilder</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">::</span><span class="n">default</span><span class="p">();</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">async_support</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasm_file_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_wasm_filename</span><span class="p">();</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Opening wasm file: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">wasm_file_path</span><span class="p">.</span><span class="n">display</span><span class="p">());</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasm_bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">fs</span><span class="p">::</span><span class="n">read</span><span class="p">(</span><span class="n">wasm_file_path</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">wasm_bytes</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">:</span><span class="w"> </span><span class="nc">Linker</span><span class="o">&lt;</span><span class="n">WasiP1Ctx</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// // Link, Sync, panics</span>
<span class="w">    </span><span class="c1">// linker</span>
<span class="w">    </span><span class="c1">//     .func_wrap("SomeNamespace", "call_host_function_example", || {</span>
<span class="w">    </span><span class="c1">//         println!("I'm in host!")</span>
<span class="w">    </span><span class="c1">//     })</span>
<span class="w">    </span><span class="c1">//     .unwrap();</span>

<span class="w">    </span><span class="c1">// Link, Async, also panics</span>
<span class="w">    </span><span class="n">linker</span>
<span class="w">        </span><span class="p">.</span><span class="n">func_wrap_async</span><span class="p">(</span>
<span class="w">            </span><span class="s">"SomeNamespace"</span><span class="p">,</span>
<span class="w">            </span><span class="s">"call_host_function_example"</span><span class="p">,</span>
<span class="w">            </span><span class="o">|</span><span class="k">mut</span><span class="w"> </span><span class="n">_caller</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">Caller</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="n">WasiP1Ctx</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">             </span><span class="p">()</span><span class="o">|</span>
<span class="w">             </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nb">Box</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">"I'm in host!"</span><span class="p">)</span><span class="w"> </span><span class="p">})</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Link wasi functions</span>
<span class="w">    </span><span class="n">preview1</span><span class="p">::</span><span class="n">add_to_linker_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">t</span><span class="o">|</span><span class="w"> </span><span class="n">t</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">pre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linker</span><span class="p">.</span><span class="n">instantiate_pre</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasi_ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasiCtxBuilder</span><span class="p">::</span><span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">inherit_stdout</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">inherit_env</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">args</span><span class="p">(</span><span class="o">&amp;</span><span class="nb">Vec</span><span class="p">::</span><span class="o">&lt;&amp;</span><span class="kt">str</span><span class="o">&gt;</span><span class="p">::</span><span class="n">new</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">build_p1</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">wasi_ctx</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pre</span><span class="p">.</span><span class="n">instantiate_async</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// This function calls the guest, which in turn calls a function in the host</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">function_call_in_host_from_guest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span>
<span class="w">        </span><span class="p">.</span><span class="n">get_typed_func</span><span class="p">::</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"call_external_function"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Call the function in the wasm file that will call the linked function in the host</span>
<span class="w">    </span><span class="n">function_call_in_host_from_guest</span>
<span class="w">        </span><span class="p">.</span><span class="n">call_async</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="k">await</span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"</span><span class="se">\n\n</span><span class="s">Program reached its end successfully. Exiting.</span><span class="se">\n\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">get_wasm_filename</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">std</span><span class="p">::</span><span class="n">path</span><span class="p">::</span><span class="n">PathBuf</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasm_build_path</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">std</span><span class="p">::</span><span class="n">path</span><span class="p">::</span><span class="n">PathBuf</span><span class="p">::</span><span class="n">from</span><span class="p">(</span><span class="s">"wasm-test-file/target/wasm32-wasip1/release/wasm-test-file.wasm"</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">wasm_build_path</span><span class="p">.</span><span class="n">exists</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wasm_build_path</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s">"wasm-test-file.wasm"</span><span class="p">.</span><span class="n">into</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Github wouldn't allow me to upload my wasm file here, it says type isn't supported. So here's the source code that produced it:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="p">::</span><span class="n">panic</span><span class="p">::</span><span class="n">set_hook</span><span class="p">(</span><span class="nb">Box</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">|</span><span class="n">info</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Panic fired: {info}"</span><span class="p">);</span>
<span class="w">        </span><span class="fm">unreachable!</span><span class="p">()</span>
<span class="w">    </span><span class="p">}));</span>
<span class="p">}</span>

<span class="cp">#[link(wasm_import_module = </span><span class="s">"SomeNamespace"</span><span class="cp">)]</span>
<span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">call_host_function_example</span><span class="p">();</span>
<span class="p">}</span>

<span class="cp">#[no_mangle]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">call_external_function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Calling host function"</span><span class="p">);</span>
<span class="w">        </span><span class="n">call_host_function_example</span><span class="p">();</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Done calling host function"</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ol>
<li>Create the wasm file</li>
<li>Run the given code</li>
<li>You'll get the panic: </li>
</ol>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">wasi</span><span class="o">-</span><span class="mf">26.0.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">108</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span>
<span class="nc">Cannot</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">runtime</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">runtime</span><span class="p">.</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">happens</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="p">(</span><span class="n">like</span><span class="w"> </span><span class="err">`</span><span class="n">block_on</span><span class="err">`</span><span class="p">)</span><span class="w"> </span><span class="n">attempted</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">being</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">drive</span><span class="w"> </span><span class="n">asynchronous</span><span class="w"> </span><span class="n">tasks</span><span class="p">.</span>
</code></pre></div>
<h3>Expected Results</h3>
<p>The function to be called without panics. Note that this application works fine when async is stripped away.</p>
<h3>Actual Results</h3>
<p>Panic.</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 0.26.0</p>
<p>Operating system: MacOS</p>
<p>Architecture: Arm (Mac M1)</p>
<h3>Extra Info</h3>
<p>Anything else you'd like to add?</p>
<p>The program works fine without async. Once async is enabled, it enforces that everything is async (including using call_async instead of call), which then is followed by this issue happening.<br>
</p>
</blockquote>



<a name="479340728"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239515%20Panic%20when%20calling%20host%20function%20i.../near/479340728" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239515.20Panic.20when.20calling.20host.20function.20i.2E.2E.2E.html#479340728">(Oct 28 2024 at 18:52)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/issues/9515#issuecomment-2442376571">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9515">issue #9515</a>:</p>
<blockquote>
<p>The wasm you are executing has nothing to do with this bug, it will appear when any guest calls a wasi import.</p>
<p>Wasmtime-wasi uses tokio under the hood. It implements its synchronous interface, for use in Rust programs that aren't already running tokio, by starting its own tokio runtime privately. Tokio does not permit this when already inside a runtime.</p>
<p>Switch to using <code>preview1::add_to_linker_async</code> and it will not create this private runtime, and instead use the runtime you are already in.<br>
</p>
</blockquote>



<a name="479408188"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239515%20Panic%20when%20calling%20host%20function%20i.../near/479408188" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239515.20Panic.20when.20calling.20host.20function.20i.2E.2E.2E.html#479408188">(Oct 29 2024 at 06:18)</a>:</h4>
<p>TheQuantumPhysicist closed <a href="https://github.com/bytecodealliance/wasmtime/issues/9515">issue #9515</a>:</p>
<blockquote>
<h3>Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">future</span><span class="p">::</span><span class="n">Future</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">Config</span><span class="p">;</span>

<span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::{</span><span class="n">Engine</span><span class="p">,</span><span class="w"> </span><span class="n">Linker</span><span class="p">,</span><span class="w"> </span><span class="n">Module</span><span class="p">,</span><span class="w"> </span><span class="n">Store</span><span class="p">};</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">wasmtime_wasi</span><span class="p">::{</span>
<span class="w">        </span><span class="n">preview1</span><span class="p">::{</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">WasiP1Ctx</span><span class="p">},</span>
<span class="w">        </span><span class="n">WasiCtxBuilder</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">::</span><span class="n">default</span><span class="p">();</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">async_support</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasm_file_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_wasm_filename</span><span class="p">();</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Opening wasm file: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">wasm_file_path</span><span class="p">.</span><span class="n">display</span><span class="p">());</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasm_bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">fs</span><span class="p">::</span><span class="n">read</span><span class="p">(</span><span class="n">wasm_file_path</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">wasm_bytes</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">:</span><span class="w"> </span><span class="nc">Linker</span><span class="o">&lt;</span><span class="n">WasiP1Ctx</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// // Link, Sync, panics</span>
<span class="w">    </span><span class="c1">// linker</span>
<span class="w">    </span><span class="c1">//     .func_wrap("SomeNamespace", "call_host_function_example", || {</span>
<span class="w">    </span><span class="c1">//         println!("I'm in host!")</span>
<span class="w">    </span><span class="c1">//     })</span>
<span class="w">    </span><span class="c1">//     .unwrap();</span>

<span class="w">    </span><span class="c1">// Link, Async, also panics</span>
<span class="w">    </span><span class="n">linker</span>
<span class="w">        </span><span class="p">.</span><span class="n">func_wrap_async</span><span class="p">(</span>
<span class="w">            </span><span class="s">"SomeNamespace"</span><span class="p">,</span>
<span class="w">            </span><span class="s">"call_host_function_example"</span><span class="p">,</span>
<span class="w">            </span><span class="o">|</span><span class="k">mut</span><span class="w"> </span><span class="n">_caller</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">Caller</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="n">WasiP1Ctx</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">             </span><span class="p">()</span><span class="o">|</span>
<span class="w">             </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nb">Box</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">"I'm in host!"</span><span class="p">)</span><span class="w"> </span><span class="p">})</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Link wasi functions</span>
<span class="w">    </span><span class="n">preview1</span><span class="p">::</span><span class="n">add_to_linker_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">t</span><span class="o">|</span><span class="w"> </span><span class="n">t</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">pre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linker</span><span class="p">.</span><span class="n">instantiate_pre</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasi_ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasiCtxBuilder</span><span class="p">::</span><span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">inherit_stdout</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">inherit_env</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">args</span><span class="p">(</span><span class="o">&amp;</span><span class="nb">Vec</span><span class="p">::</span><span class="o">&lt;&amp;</span><span class="kt">str</span><span class="o">&gt;</span><span class="p">::</span><span class="n">new</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">build_p1</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">wasi_ctx</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pre</span><span class="p">.</span><span class="n">instantiate_async</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// This function calls the guest, which in turn calls a function in the host</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">function_call_in_host_from_guest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span>
<span class="w">        </span><span class="p">.</span><span class="n">get_typed_func</span><span class="p">::</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"call_external_function"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Call the function in the wasm file that will call the linked function in the host</span>
<span class="w">    </span><span class="n">function_call_in_host_from_guest</span>
<span class="w">        </span><span class="p">.</span><span class="n">call_async</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="k">await</span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"</span><span class="se">\n\n</span><span class="s">Program reached its end successfully. Exiting.</span><span class="se">\n\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">get_wasm_filename</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">std</span><span class="p">::</span><span class="n">path</span><span class="p">::</span><span class="n">PathBuf</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasm_build_path</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">std</span><span class="p">::</span><span class="n">path</span><span class="p">::</span><span class="n">PathBuf</span><span class="p">::</span><span class="n">from</span><span class="p">(</span><span class="s">"wasm-test-file/target/wasm32-wasip1/release/wasm-test-file.wasm"</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">wasm_build_path</span><span class="p">.</span><span class="n">exists</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wasm_build_path</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s">"wasm-test-file.wasm"</span><span class="p">.</span><span class="n">into</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Github wouldn't allow me to upload my wasm file here, it says type isn't supported. So here's the source code that produced it:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="p">::</span><span class="n">panic</span><span class="p">::</span><span class="n">set_hook</span><span class="p">(</span><span class="nb">Box</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">|</span><span class="n">info</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Panic fired: {info}"</span><span class="p">);</span>
<span class="w">        </span><span class="fm">unreachable!</span><span class="p">()</span>
<span class="w">    </span><span class="p">}));</span>
<span class="p">}</span>

<span class="cp">#[link(wasm_import_module = </span><span class="s">"SomeNamespace"</span><span class="cp">)]</span>
<span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">call_host_function_example</span><span class="p">();</span>
<span class="p">}</span>

<span class="cp">#[no_mangle]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">call_external_function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Calling host function"</span><span class="p">);</span>
<span class="w">        </span><span class="n">call_host_function_example</span><span class="p">();</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Done calling host function"</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ol>
<li>Create the wasm file</li>
<li>Run the given code</li>
<li>You'll get the panic: </li>
</ol>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">wasi</span><span class="o">-</span><span class="mf">26.0.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">108</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span>
<span class="nc">Cannot</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">runtime</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">runtime</span><span class="p">.</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">happens</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="p">(</span><span class="n">like</span><span class="w"> </span><span class="err">`</span><span class="n">block_on</span><span class="err">`</span><span class="p">)</span><span class="w"> </span><span class="n">attempted</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">being</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">drive</span><span class="w"> </span><span class="n">asynchronous</span><span class="w"> </span><span class="n">tasks</span><span class="p">.</span>
</code></pre></div>
<h3>Expected Results</h3>
<p>The function to be called without panics. Note that this application works fine when async is stripped away.</p>
<h3>Actual Results</h3>
<p>Panic.</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 0.26.0</p>
<p>Operating system: MacOS</p>
<p>Architecture: Arm (Mac M1)</p>
<h3>Extra Info</h3>
<p>Anything else you'd like to add?</p>
<p>The program works fine without async. Once async is enabled, it enforces that everything is async (including using call_async instead of call), which then is followed by this issue happening.<br>
</p>
</blockquote>



<a name="479408192"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239515%20Panic%20when%20calling%20host%20function%20i.../near/479408192" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239515.20Panic.20when.20calling.20host.20function.20i.2E.2E.2E.html#479408192">(Oct 29 2024 at 06:18)</a>:</h4>
<p>TheQuantumPhysicist <a href="https://github.com/bytecodealliance/wasmtime/issues/9515#issuecomment-2443307254">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9515">issue #9515</a>:</p>
<blockquote>
<p>You're right. Thank you for explaining. I'm closing this issue.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>