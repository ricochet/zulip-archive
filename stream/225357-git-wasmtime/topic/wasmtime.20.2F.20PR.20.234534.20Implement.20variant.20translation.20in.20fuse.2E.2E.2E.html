<html>
<head><meta charset="utf-8"><title>wasmtime / PR #4534 Implement variant translation in fuse... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234534.20Implement.20variant.20translation.20in.20fuse.2E.2E.2E.html">wasmtime / PR #4534 Implement variant translation in fuse...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="290937918"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234534%20Implement%20variant%20translation%20in%20fuse.../near/290937918" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234534.20Implement.20variant.20translation.20in.20fuse.2E.2E.2E.html#290937918">(Jul 26 2022 at 18:39)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/4534">PR #4534</a> from <code>translate-variant</code> to <code>main</code>:</p>
<blockquote>
<p>This commit implements the most general case of variants for fused<br>
adapter trampolines. Additionally a number of other primitive types are<br>
filled out here to assist with testing variants. The implementation<br>
internally was relatively straightforward given the shape of variants,<br>
but there's room for future optimization as necessary especially around<br>
converting locals to various types.</p>
<p>This commit also introduces a "one off" fuzzer for adapters to ensure<br>
that the generated adapter is valid. I hope to extend this fuzz<br>
generator as more types are implemented to assist in various corner<br>
cases that might arise. For now the fuzzer simply tests that the output<br>
wasm module is valid, not that it actually executes correctly. I hope to<br>
integrate with a fuzzer along the lines of #4307 one day to test the<br>
run-time-correctness of the generated adapters as well, at which point<br>
this fuzzer would become obsolete.</p>
<p>Finally this commit also fixes an issue with <code>u8</code> translation where<br>
upper bits weren't zero'd out and were passed raw across modules.<br>
Instead smaller-than-32 types now all mask out their upper bits and do<br>
sign-extension as appropriate for unsigned/signed variants.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="290937920"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234534%20Implement%20variant%20translation%20in%20fuse.../near/290937920" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234534.20Implement.20variant.20translation.20in.20fuse.2E.2E.2E.html#290937920">(Jul 26 2022 at 18:39)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/4534">PR #4534</a>.</p>



<a name="290937928"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234534%20Implement%20variant%20translation%20in%20fuse.../near/290937928" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234534.20Implement.20variant.20translation.20in.20fuse.2E.2E.2E.html#290937928">(Jul 26 2022 at 18:39)</a>:</h4>
<p><strong>alexcrichton</strong> has marked <a href="https://github.com/bytecodealliance/wasmtime/pull/4534">PR #4534</a> as ready for review.</p>



<a name="290946311"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234534%20Implement%20variant%20translation%20in%20fuse.../near/290946311" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234534.20Implement.20variant.20translation.20in.20fuse.2E.2E.2E.html#290946311">(Jul 26 2022 at 19:45)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4534">PR #4534</a> from <code>translate-variant</code> to <code>main</code>.</p>



<a name="290947471"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234534%20Implement%20variant%20translation%20in%20fuse.../near/290947471" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234534.20Implement.20variant.20translation.20in.20fuse.2E.2E.2E.html#290947471">(Jul 26 2022 at 19:55)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4534">PR #4534</a> from <code>translate-variant</code> to <code>main</code>.</p>



<a name="290955610"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234534%20Implement%20variant%20translation%20in%20fuse.../near/290955610" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234534.20Implement.20variant.20translation.20in.20fuse.2E.2E.2E.html#290955610">(Jul 26 2022 at 21:00)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4534#pullrequestreview-1051490685">PR review</a>.</p>



<a name="290955611"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234534%20Implement%20variant%20translation%20in%20fuse.../near/290955611" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234534.20Implement.20variant.20translation.20in.20fuse.2E.2E.2E.html#290955611">(Jul 26 2022 at 21:00)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4534#pullrequestreview-1051490685">PR review</a>.</p>



<a name="290955612"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234534%20Implement%20variant%20translation%20in%20fuse.../near/290955612" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234534.20Implement.20variant.20translation.20in.20fuse.2E.2E.2E.html#290955612">(Jul 26 2022 at 21:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/4534#discussion_r930329451">PR review comment</a>:</p>
<blockquote>
<p>Might not want to <code>derive(Arbitary)</code> for <code>FuncType</code> as the <code>params</code> are potentially unbounded in length here, and I assume we have an implementation limit we want to stay below, right?</p>
</blockquote>



<a name="290955613"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234534%20Implement%20variant%20translation%20in%20fuse.../near/290955613" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234534.20Implement.20variant.20translation.20in.20fuse.2E.2E.2E.html#290955613">(Jul 26 2022 at 21:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/4534#discussion_r930330393">PR review comment</a>:</p>
<blockquote>
<p>Alternatively, you could add a wrapper type for bounding <code>Vec</code> lengths similar to what you did for <code>NonZeroLenVec</code>.</p>
</blockquote>



<a name="290955614"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234534%20Implement%20variant%20translation%20in%20fuse.../near/290955614" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234534.20Implement.20variant.20translation.20in.20fuse.2E.2E.2E.html#290955614">(Jul 26 2022 at 21:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/4534#discussion_r930406603">PR review comment</a>:</p>
<blockquote>
<p>Huh. I didn't realize there wasn't an <code>i32.extend8_u</code> instruction. Strange there are signed extension instructions where there aren't corresponding unsigned variants. Yeah you can just do the masking, but also you can do the signed version via signed shifting back and forth. So why not omit or include both?</p>
<p>@sunfishcode do you happen to know the answer to the above, out of curiosity?</p>
</blockquote>



<a name="290955615"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234534%20Implement%20variant%20translation%20in%20fuse.../near/290955615" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234534.20Implement.20variant.20translation.20in.20fuse.2E.2E.2E.html#290955615">(Jul 26 2022 at 21:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/4534#discussion_r930324146">PR review comment</a>:</p>
<blockquote>
<p>Why not add this to the top level <code>wasmtime/fuzz/*</code> fuzz targets? You don't think it is worth spending oss-fuzz time on until we get the full blown value round tripping stuff working?</p>
</blockquote>



<a name="291039817"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234534%20Implement%20variant%20translation%20in%20fuse.../near/291039817" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234534.20Implement.20variant.20translation.20in.20fuse.2E.2E.2E.html#291039817">(Jul 27 2022 at 14:10)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/4534#discussion_r931113595">PR review comment</a>:</p>
<blockquote>
<p>Yeah I don't think this really all that high value of a fuzz target since it's purely "is it a valid wasm module" which is a much weaker claim than "hey it actually works". Eventually when we're actually running these I think it makes sense to run on oss-fuzz but for now this is mostly just a development aide which is intended to help suss out corner cases (worked really well for a memory64 patch I'll post after this)</p>
</blockquote>



<a name="291039820"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234534%20Implement%20variant%20translation%20in%20fuse.../near/291039820" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234534.20Implement.20variant.20translation.20in.20fuse.2E.2E.2E.html#291039820">(Jul 27 2022 at 14:10)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4534#pullrequestreview-1052580625">PR review</a>.</p>



<a name="291039952"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234534%20Implement%20variant%20translation%20in%20fuse.../near/291039952" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234534.20Implement.20variant.20translation.20in.20fuse.2E.2E.2E.html#291039952">(Jul 27 2022 at 14:11)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4534#pullrequestreview-1052582349">PR review</a>.</p>



<a name="291039954"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234534%20Implement%20variant%20translation%20in%20fuse.../near/291039954" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234534.20Implement.20variant.20translation.20in.20fuse.2E.2E.2E.html#291039954">(Jul 27 2022 at 14:11)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/4534#discussion_r931114773">PR review comment</a>:</p>
<blockquote>
<p>While we do have limits in the system they're generally elsewhere at the wasmparser validation layer or the runtime implementation layer. Here in this specific compiler there are few limits imposed and at least so far nothing has blown up. If I run into issues locally with this though running the fuzzer I'll probably do the newtype trick.</p>
</blockquote>



<a name="291040248"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234534%20Implement%20variant%20translation%20in%20fuse.../near/291040248" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234534.20Implement.20variant.20translation.20in.20fuse.2E.2E.2E.html#291040248">(Jul 27 2022 at 14:13)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4534#pullrequestreview-1052586218">PR review</a>.</p>



<a name="291040249"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234534%20Implement%20variant%20translation%20in%20fuse.../near/291040249" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234534.20Implement.20variant.20translation.20in.20fuse.2E.2E.2E.html#291040249">(Jul 27 2022 at 14:13)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/4534#discussion_r931117504">PR review comment</a>:</p>
<blockquote>
<p>Double-checking again to make sure I didn't miss something, apparently there's <code>i64.extend32_u</code> but that's the only one.</p>
</blockquote>



<a name="291040398"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234534%20Implement%20variant%20translation%20in%20fuse.../near/291040398" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234534.20Implement.20variant.20translation.20in.20fuse.2E.2E.2E.html#291040398">(Jul 27 2022 at 14:14)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/4534">PR #4534</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>