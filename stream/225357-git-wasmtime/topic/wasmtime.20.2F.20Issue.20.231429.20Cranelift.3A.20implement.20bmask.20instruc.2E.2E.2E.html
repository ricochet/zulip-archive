<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #1429 Cranelift: implement bmask instruc... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231429.20Cranelift.3A.20implement.20bmask.20instruc.2E.2E.2E.html">wasmtime / Issue #1429 Cranelift: implement bmask instruc...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="192128242"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231429%20Cranelift%3A%20implement%20bmask%20instruc.../near/192128242" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231429.20Cranelift.3A.20implement.20bmask.20instruc.2E.2E.2E.html#192128242">(Mar 28 2020 at 15:32)</a>:</h4>
<p>bjorn3 opened <a href="https://github.com/bytecodealliance/wasmtime/issues/1429" title="https://github.com/bytecodealliance/wasmtime/issues/1429">Issue #1429</a>:</p>
<blockquote>
<p>There is currently neither an encoding, nor a legalization for this instruction.</p>
</blockquote>



<a name="192128866"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231429%20Cranelift%3A%20implement%20bmask%20instruc.../near/192128866" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231429.20Cranelift.3A.20implement.20bmask.20instruc.2E.2E.2E.html#192128866">(Mar 28 2020 at 15:46)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/1429#issuecomment-605464890" title="https://github.com/bytecodealliance/wasmtime/issues/1429#issuecomment-605464890">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1429" title="https://github.com/bytecodealliance/wasmtime/issues/1429">Issue #1429</a>:</p>
<blockquote>
<p>I think it should be used by <code>translate_vector_icmp</code> and <code>translate_vector_fcmp</code> after an encoding is added.</p>
</blockquote>



<a name="192141914"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231429%20Cranelift%3A%20implement%20bmask%20instruc.../near/192141914" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231429.20Cranelift.3A.20implement.20bmask.20instruc.2E.2E.2E.html#192141914">(Mar 28 2020 at 21:15)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/issues/1429#issuecomment-605520568" title="https://github.com/bytecodealliance/wasmtime/issues/1429#issuecomment-605520568">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1429" title="https://github.com/bytecodealliance/wasmtime/issues/1429">Issue #1429</a>:</p>
<blockquote>
<p>Not sure I follow: I do plan to evenually add a SIMD bitmask using PMOVMSKB like what is described in the <a href="https://github.com/WebAssembly/simd/pull/201" title="https://github.com/WebAssembly/simd/pull/201">SIMD spec issue</a> but I don't see how that would change <code>translate_vector_icmp</code> and <code>translate_vector_fcmp</code>--it would be a separate instruction.</p>
</blockquote>



<a name="192141952"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231429%20Cranelift%3A%20implement%20bmask%20instruc.../near/192141952" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231429.20Cranelift.3A.20implement.20bmask.20instruc.2E.2E.2E.html#192141952">(Mar 28 2020 at 21:16)</a>:</h4>
<p>abrown edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/1429#issuecomment-605520568" title="https://github.com/bytecodealliance/wasmtime/issues/1429#issuecomment-605520568">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1429" title="https://github.com/bytecodealliance/wasmtime/issues/1429">Issue #1429</a>:</p>
<blockquote>
<p>Not sure I follow: I do plan to eventually add a SIMD bitmask using PMOVMSKB like what is described in the <a href="https://github.com/WebAssembly/simd/pull/201" title="https://github.com/WebAssembly/simd/pull/201">SIMD spec issue</a> but I don't see how that would change <code>translate_vector_icmp</code> and <code>translate_vector_fcmp</code>--it would be a separate instruction.</p>
</blockquote>



<a name="192142241"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231429%20Cranelift%3A%20implement%20bmask%20instruc.../near/192142241" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231429.20Cranelift.3A.20implement.20bmask.20instruc.2E.2E.2E.html#192142241">(Mar 28 2020 at 21:25)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/1429#issuecomment-605521675" title="https://github.com/bytecodealliance/wasmtime/issues/1429#issuecomment-605521675">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1429" title="https://github.com/bytecodealliance/wasmtime/issues/1429">Issue #1429</a>:</p>
<blockquote>
<p>According to the docs the instruction would for every lane return an all ones integer for a true bool and an all zeros integer for a false bool. Eg <code>bmask.i8x2</code> on <code>[false, true]</code> would return <code>[0x00, 0xff]</code>.</p>
<p><code>translate_vector_{icmp,fcmp}</code> currently assume that <code>icmp</code> and <code>fcmp</code> on vectors represent the resulting bool using all zeros / all ones. Otherwise the <code>raw_bitcast</code> would fail. This is not guaranteed anywhere and for non vectors this assumption is wrong. Using eg <code>bmask.i8x16</code> to convert a <code>b8x16</code> instead of using <code>raw_bitcast.i8x16</code> would avoid making this assumption.</p>
</blockquote>



<a name="192142967"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231429%20Cranelift%3A%20implement%20bmask%20instruc.../near/192142967" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231429.20Cranelift.3A.20implement.20bmask.20instruc.2E.2E.2E.html#192142967">(Mar 28 2020 at 21:45)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/issues/1429#issuecomment-605523723" title="https://github.com/bytecodealliance/wasmtime/issues/1429#issuecomment-605523723">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1429" title="https://github.com/bytecodealliance/wasmtime/issues/1429">Issue #1429</a>:</p>
<blockquote>
<p>As I understand it, on x86 and <a href="https://github.com/v8/v8/blob/master/src/compiler/backend/arm64/code-generator-arm64.cc#L2057-L2066" title="https://github.com/v8/v8/blob/master/src/compiler/backend/arm64/code-generator-arm64.cc#L2057-L2066">ARM</a> the output of vector <code>icmp</code> and <code>fcmp</code> is another vector with lanes of all zeroes or all ones. Are you suggesting using <code>bmask.i8x16</code> in <br>
<code>translate_vector_{icmp,fcmp}</code> to make things look more type-correct but actually encode it as a noop on those platforms?</p>
</blockquote>



<a name="192143008"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231429%20Cranelift%3A%20implement%20bmask%20instruc.../near/192143008" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231429.20Cranelift.3A.20implement.20bmask.20instruc.2E.2E.2E.html#192143008">(Mar 28 2020 at 21:46)</a>:</h4>
<p>abrown edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/1429#issuecomment-605523723" title="https://github.com/bytecodealliance/wasmtime/issues/1429#issuecomment-605523723">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1429" title="https://github.com/bytecodealliance/wasmtime/issues/1429">Issue #1429</a>:</p>
<blockquote>
<p>As I understand it, on x86 and <a href="https://github.com/v8/v8/blob/master/src/compiler/backend/arm64/code-generator-arm64.cc#L2057-L2066" title="https://github.com/v8/v8/blob/master/src/compiler/backend/arm64/code-generator-arm64.cc#L2057-L2066">ARM</a> the output of vector <code>icmp</code> and <code>fcmp</code> is another vector with lanes of all zeroes or all ones. Are you suggesting using <code>bmask.i8x16</code> in <code>translate_vector_{icmp,fcmp}</code> to make things look more type-correct but actually encode it as a noop on those platforms?</p>
</blockquote>



<a name="192143756"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231429%20Cranelift%3A%20implement%20bmask%20instruc.../near/192143756" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231429.20Cranelift.3A.20implement.20bmask.20instruc.2E.2E.2E.html#192143756">(Mar 28 2020 at 22:06)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/1429#issuecomment-605525823" title="https://github.com/bytecodealliance/wasmtime/issues/1429#issuecomment-605525823">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1429" title="https://github.com/bytecodealliance/wasmtime/issues/1429">Issue #1429</a>:</p>
<blockquote>
<p>Yes</p>
</blockquote>



<a name="192505364"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231429%20Cranelift%3A%20implement%20bmask%20instruc.../near/192505364" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231429.20Cranelift.3A.20implement.20bmask.20instruc.2E.2E.2E.html#192505364">(Apr 01 2020 at 09:57)</a>:</h4>
<p>bnjbvr labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/1429" title="https://github.com/bytecodealliance/wasmtime/issues/1429">Issue #1429</a>:</p>
<blockquote>
<p>There is currently neither an encoding, nor a legalization for this instruction.</p>
</blockquote>



<a name="192505377"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231429%20Cranelift%3A%20implement%20bmask%20instruc.../near/192505377" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231429.20Cranelift.3A.20implement.20bmask.20instruc.2E.2E.2E.html#192505377">(Apr 01 2020 at 09:57)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/issues/1429#issuecomment-607154249" title="https://github.com/bytecodealliance/wasmtime/issues/1429#issuecomment-607154249">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1429" title="https://github.com/bytecodealliance/wasmtime/issues/1429">Issue #1429</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>This issue or pull request has been labeled: "cranelift"</p>
<p>&lt;details&gt; &lt;summary&gt;Users Subscribed to "cranelift"&lt;/summary&gt;</p>
<ul>
<li>@bnjbvr</li>
</ul>
<p>&lt;/details&gt;</p>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action" title="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a></p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>