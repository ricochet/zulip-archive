<html>
<head><meta charset="utf-8"><title>wasmtime / PR #1923 wasmtime: Implement `table.get` and `... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html">wasmtime / PR #1923 wasmtime: Implement `table.get` and `...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="202008466"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202008466" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202008466">(Jun 25 2020 at 18:42)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/sunfishcode">sunfishcode</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1923">PR #1923</a>.</p>



<a name="202008467"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202008467" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202008467">(Jun 25 2020 at 18:42)</a>:</h4>
<p>fitzgen opened <a href="https://github.com/bytecodealliance/wasmtime/pull/1923">PR #1923</a> from <code>table-get-and-table-set</code> to <code>master</code>:</p>
<blockquote>
<p>These instructions have fast, inline JIT paths for the common cases, and only<br>
call out to host VM functions for the slow paths. This required some changes to<br>
<code>cranelift-wasm</code>'s <code>FuncEnvironment</code>: instead of taking a <code>FuncCursor</code> to insert<br>
an instruction sequence within the current basic block,<br>
<code>FuncEnvironment::translate_table_{get,set}</code> now take a <code>&amp;mut FunctionBuilder</code><br>
so that they can create whole new basic blocks. This is necessary for<br>
implementing GC read/write barriers that involve branching (e.g. checking for<br>
null, or whether a store buffer is at capacity).</p>
<p>Furthermore, it required that the <code>load</code>, <code>load_complex</code>, and <code>store</code><br>
instructions handle loading and storing through an <code>r{32,64}</code> rather than just<br>
<code>i{32,64}</code> addresses. This involved making <code>r{32,64}</code> types acceptable<br>
instantiations of the <code>iAddr</code> type variable, plus a few new instruction<br>
encodings.</p>
<p>Part of #929</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="202009154"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202009154" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202009154">(Jun 25 2020 at 18:48)</a>:</h4>
<p>alexcrichton edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1923">PR #1923</a> from <code>table-get-and-table-set</code> to <code>main</code>:</p>
<blockquote>
<p>These instructions have fast, inline JIT paths for the common cases, and only<br>
call out to host VM functions for the slow paths. This required some changes to<br>
<code>cranelift-wasm</code>'s <code>FuncEnvironment</code>: instead of taking a <code>FuncCursor</code> to insert<br>
an instruction sequence within the current basic block,<br>
<code>FuncEnvironment::translate_table_{get,set}</code> now take a <code>&amp;mut FunctionBuilder</code><br>
so that they can create whole new basic blocks. This is necessary for<br>
implementing GC read/write barriers that involve branching (e.g. checking for<br>
null, or whether a store buffer is at capacity).</p>
<p>Furthermore, it required that the <code>load</code>, <code>load_complex</code>, and <code>store</code><br>
instructions handle loading and storing through an <code>r{32,64}</code> rather than just<br>
<code>i{32,64}</code> addresses. This involved making <code>r{32,64}</code> types acceptable<br>
instantiations of the <code>iAddr</code> type variable, plus a few new instruction<br>
encodings.</p>
<p>Part of #929</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="202014150"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202014150" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202014150">(Jun 25 2020 at 19:29)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#pullrequestreview-437789081">PR Review</a>.</p>



<a name="202014151"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202014151" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202014151">(Jun 25 2020 at 19:29)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#pullrequestreview-437789081">PR Review</a>.</p>



<a name="202014152"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202014152" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202014152">(Jun 25 2020 at 19:29)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#discussion_r445787316">PR Review Comment</a>:</p>
<blockquote>
<p>This seems like it may not be right, we don't have a <code>*mut VMExternRef</code> here I thought but rather <code>*mut VMExternData</code>? Should this be <code>VMExternData::drop_and_dealloc</code>?</p>
</blockquote>



<a name="202014153"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202014153" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202014153">(Jun 25 2020 at 19:29)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#discussion_r445784768">PR Review Comment</a>:</p>
<blockquote>
<p>I think technically this is memory unsafe since the destructor can run arbitrary code which can poke at the table. Perhaps the third statement could be <code>let current_elem = replace(&amp;mut table[index], value)</code>, and I think that'd fix any issues here?</p>
</blockquote>



<a name="202014155"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202014155" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202014155">(Jun 25 2020 at 19:29)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#discussion_r445788626">PR Review Comment</a>:</p>
<blockquote>
<p>(also does this mean that a test should be added for this too?</p>
</blockquote>



<a name="202018969"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202018969" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202018969">(Jun 25 2020 at 20:14)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#discussion_r445812106">PR Review Comment</a>:</p>
<blockquote>
<p>This isn't a <code>*mut VMExternData</code> (which is indeed what a <code>VMExternRef</code> is represented with) but actually a pointer to a <code>VMExternRef</code>. The <code>table_addr</code> instruction evaluates to a pointer to the table element, not the table element itself, and it is the result of the <code>table_addr</code> that we pass as an argument to the call to this function.</p>
</blockquote>



<a name="202018970"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202018970" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202018970">(Jun 25 2020 at 20:14)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#pullrequestreview-437825011">PR Review</a>.</p>



<a name="202019349"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202019349" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202019349">(Jun 25 2020 at 20:17)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#pullrequestreview-437827273">PR Review</a>.</p>



<a name="202019350"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202019350" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202019350">(Jun 25 2020 at 20:17)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#discussion_r445813758">PR Review Comment</a>:</p>
<blockquote>
<blockquote>
<p>(also does this mean that a test should be added for this too?</p>
</blockquote>
<p>I am 99% sure the spec tests exercise this path, but I can double check, and it might make sense to explicitly ensure that we test this, since it requires <code>ref_count == 1</code> on the current table element that will be overridden.</p>
</blockquote>



<a name="202019567"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202019567" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202019567">(Jun 25 2020 at 20:19)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#pullrequestreview-437828450">PR Review</a>.</p>



<a name="202019568"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202019568" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202019568">(Jun 25 2020 at 20:19)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#discussion_r445814684">PR Review Comment</a>:</p>
<blockquote>
<p>Ah sorry I assuming the pseudocode a bit too literally, if that's the case then this is all good!</p>
<p>(although I think this still runs afoul of the issue where the dtor tries to touch the table, so we may not be able to implement it as this for long)</p>
</blockquote>



<a name="202019701"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202019701" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202019701">(Jun 25 2020 at 20:20)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#pullrequestreview-437829271">PR Review</a>.</p>



<a name="202019702"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202019702" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202019702">(Jun 25 2020 at 20:20)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#discussion_r445815319">PR Review Comment</a>:</p>
<blockquote>
<p>This whole thing is sort of an inline destructor, the <code>table[index] = ...</code> bit of pseudocode isn't intended to convey that we are running destructors on the old <code>table[index]</code> within this assignment.</p>
</blockquote>



<a name="202022368"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202022368" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202022368">(Jun 25 2020 at 20:43)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#pullrequestreview-437844243">PR Review</a>.</p>



<a name="202022369"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202022369" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202022369">(Jun 25 2020 at 20:43)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#discussion_r445826996">PR Review Comment</a>:</p>
<blockquote>
<blockquote>
<p>(although I think this still runs afoul of the issue where the dtor tries to touch the table, so we may not be able to implement it as this for long)</p>
</blockquote>
<p>Hm this is a good point!</p>
<p>Normally, we would be safe because the table elements are in a <code>RefCell</code>, but the JIT code doesn't set the <code>RefCell</code>'s borrow flags :-/</p>
<p>The only way I see to avoid this would be to either</p>
<ul>
<li>
<p>Make a custom version of <code>RefCell</code> where the JIT knows how to poke at the borrow flags (not great to add this extra overhead if we can avoid it, plus duplicating a bunch of <code>std</code> code)</p>
</li>
<li>
<p>Do some kind of deferred destruction, where we queue up ready-to-die references and drain them at known safe points (opens the door for even more confusing/unexpected drop times).</p>
</li>
</ul>
<p>Of the two, I think deferred destruction is probably the more promising approach.</p>
</blockquote>



<a name="202024906"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202024906" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202024906">(Jun 25 2020 at 21:05)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#pullrequestreview-437858197">PR Review</a>.</p>



<a name="202024907"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202024907" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202024907">(Jun 25 2020 at 21:05)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#discussion_r445837876">PR Review Comment</a>:</p>
<blockquote>
<p>We talked a bit on Zulip about how I think by swapping pointers we can sidestep the issue here, but this also makes me think that we should stop using <code>RefCell</code> in <code>Table</code> internals, instead switching to <code>UnsafeCell</code> because the JIT doesn't know about it.</p>
</blockquote>



<a name="202038874"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202038874" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202038874">(Jun 25 2020 at 23:50)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1923">PR #1923</a> from <code>table-get-and-table-set</code> to <code>main</code>:</p>
<blockquote>
<p>These instructions have fast, inline JIT paths for the common cases, and only<br>
call out to host VM functions for the slow paths. This required some changes to<br>
<code>cranelift-wasm</code>'s <code>FuncEnvironment</code>: instead of taking a <code>FuncCursor</code> to insert<br>
an instruction sequence within the current basic block,<br>
<code>FuncEnvironment::translate_table_{get,set}</code> now take a <code>&amp;mut FunctionBuilder</code><br>
so that they can create whole new basic blocks. This is necessary for<br>
implementing GC read/write barriers that involve branching (e.g. checking for<br>
null, or whether a store buffer is at capacity).</p>
<p>Furthermore, it required that the <code>load</code>, <code>load_complex</code>, and <code>store</code><br>
instructions handle loading and storing through an <code>r{32,64}</code> rather than just<br>
<code>i{32,64}</code> addresses. This involved making <code>r{32,64}</code> types acceptable<br>
instantiations of the <code>iAddr</code> type variable, plus a few new instruction<br>
encodings.</p>
<p>Part of #929</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="202134589"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202134589" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202134589">(Jun 26 2020 at 19:51)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1923">PR #1923</a> from <code>table-get-and-table-set</code> to <code>main</code>:</p>
<blockquote>
<p>These instructions have fast, inline JIT paths for the common cases, and only<br>
call out to host VM functions for the slow paths. This required some changes to<br>
<code>cranelift-wasm</code>'s <code>FuncEnvironment</code>: instead of taking a <code>FuncCursor</code> to insert<br>
an instruction sequence within the current basic block,<br>
<code>FuncEnvironment::translate_table_{get,set}</code> now take a <code>&amp;mut FunctionBuilder</code><br>
so that they can create whole new basic blocks. This is necessary for<br>
implementing GC read/write barriers that involve branching (e.g. checking for<br>
null, or whether a store buffer is at capacity).</p>
<p>Furthermore, it required that the <code>load</code>, <code>load_complex</code>, and <code>store</code><br>
instructions handle loading and storing through an <code>r{32,64}</code> rather than just<br>
<code>i{32,64}</code> addresses. This involved making <code>r{32,64}</code> types acceptable<br>
instantiations of the <code>iAddr</code> type variable, plus a few new instruction<br>
encodings.</p>
<p>Part of #929</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="202136246"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202136246" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202136246">(Jun 26 2020 at 20:04)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#pullrequestreview-438559660">PR Review</a>.</p>



<a name="202136248"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202136248" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202136248">(Jun 26 2020 at 20:04)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#pullrequestreview-438559660">PR Review</a>.</p>



<a name="202136249"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202136249" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202136249">(Jun 26 2020 at 20:04)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#discussion_r446382414">PR Review Comment</a>:</p>
<blockquote>
<p>Technically this comment applies to <code>let current_elem</code> above, right?</p>
</blockquote>



<a name="202136250"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202136250" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202136250">(Jun 26 2020 at 20:04)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#discussion_r446384545">PR Review Comment</a>:</p>
<blockquote>
<p>If GC/wasm happens multiple times, will this property always hold though? This seems like it'd need to both set next == end but also some sort of flag saying "always take the slow path, never reset next/end"</p>
</blockquote>



<a name="202136251"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202136251" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202136251">(Jun 26 2020 at 20:04)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#discussion_r446383581">PR Review Comment</a>:</p>
<blockquote>
<p>Oh wow nice find <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
</blockquote>



<a name="202136253"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202136253" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202136253">(Jun 26 2020 at 20:04)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#discussion_r446382970">PR Review Comment</a>:</p>
<blockquote>
<p>FITZGEN!!!</p>
</blockquote>



<a name="202137404"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202137404" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202137404">(Jun 26 2020 at 20:15)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#pullrequestreview-438569202">PR Review</a>.</p>



<a name="202137405"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202137405" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202137405">(Jun 26 2020 at 20:15)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#discussion_r446389944">PR Review Comment</a>:</p>
<blockquote>
<p>If you try to insert into the activations table, and <code>next == end</code>, then you do a gc (which will be re-entrant in this case, and exit early) and then insert into the over-approximized hash set. So, yes this relies on no one but the GC resetting next/end, but that property does hold right now.</p>
</blockquote>



<a name="202137590"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202137590" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202137590">(Jun 26 2020 at 20:17)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#pullrequestreview-438570076">PR Review</a>.</p>



<a name="202137591"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202137591" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202137591">(Jun 26 2020 at 20:17)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#discussion_r446390612">PR Review Comment</a>:</p>
<blockquote>
<p>Woops, yeah I moved things around a bit.</p>
</blockquote>



<a name="202137774"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202137774" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202137774">(Jun 26 2020 at 20:19)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1923">PR #1923</a> from <code>table-get-and-table-set</code> to <code>main</code>:</p>
<blockquote>
<p>These instructions have fast, inline JIT paths for the common cases, and only<br>
call out to host VM functions for the slow paths. This required some changes to<br>
<code>cranelift-wasm</code>'s <code>FuncEnvironment</code>: instead of taking a <code>FuncCursor</code> to insert<br>
an instruction sequence within the current basic block,<br>
<code>FuncEnvironment::translate_table_{get,set}</code> now take a <code>&amp;mut FunctionBuilder</code><br>
so that they can create whole new basic blocks. This is necessary for<br>
implementing GC read/write barriers that involve branching (e.g. checking for<br>
null, or whether a store buffer is at capacity).</p>
<p>Furthermore, it required that the <code>load</code>, <code>load_complex</code>, and <code>store</code><br>
instructions handle loading and storing through an <code>r{32,64}</code> rather than just<br>
<code>i{32,64}</code> addresses. This involved making <code>r{32,64}</code> types acceptable<br>
instantiations of the <code>iAddr</code> type variable, plus a few new instruction<br>
encodings.</p>
<p>Part of #929</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="202138169"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202138169" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202138169">(Jun 26 2020 at 20:23)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#pullrequestreview-438573211">PR Review</a>.</p>



<a name="202138170"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202138170" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202138170">(Jun 26 2020 at 20:23)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#discussion_r446393024">PR Review Comment</a>:</p>
<blockquote>
<p>Oh right sorry I thought this happened somewhere in <code>try_insert</code> or similar, but it actually happens in this function! In that case the recursive guard on <code>gc</code> should be good enough <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
</blockquote>



<a name="202154878"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202154878" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202154878">(Jun 26 2020 at 23:25)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1923">PR #1923</a> from <code>table-get-and-table-set</code> to <code>main</code>:</p>
<blockquote>
<p>These instructions have fast, inline JIT paths for the common cases, and only<br>
call out to host VM functions for the slow paths. This required some changes to<br>
<code>cranelift-wasm</code>'s <code>FuncEnvironment</code>: instead of taking a <code>FuncCursor</code> to insert<br>
an instruction sequence within the current basic block,<br>
<code>FuncEnvironment::translate_table_{get,set}</code> now take a <code>&amp;mut FunctionBuilder</code><br>
so that they can create whole new basic blocks. This is necessary for<br>
implementing GC read/write barriers that involve branching (e.g. checking for<br>
null, or whether a store buffer is at capacity).</p>
<p>Furthermore, it required that the <code>load</code>, <code>load_complex</code>, and <code>store</code><br>
instructions handle loading and storing through an <code>r{32,64}</code> rather than just<br>
<code>i{32,64}</code> addresses. This involved making <code>r{32,64}</code> types acceptable<br>
instantiations of the <code>iAddr</code> type variable, plus a few new instruction<br>
encodings.</p>
<p>Part of #929</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="202475891"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202475891" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202475891">(Jun 30 2020 at 18:25)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#pullrequestreview-440278118">PR Review</a>.</p>



<a name="202475892"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202475892" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202475892">(Jun 30 2020 at 18:25)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#pullrequestreview-440278118">PR Review</a>.</p>



<a name="202480330"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202480330" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202480330">(Jun 30 2020 at 19:02)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1923">PR #1923</a> from <code>table-get-and-table-set</code> to <code>main</code>:</p>
<blockquote>
<p>These instructions have fast, inline JIT paths for the common cases, and only<br>
call out to host VM functions for the slow paths. This required some changes to<br>
<code>cranelift-wasm</code>'s <code>FuncEnvironment</code>: instead of taking a <code>FuncCursor</code> to insert<br>
an instruction sequence within the current basic block,<br>
<code>FuncEnvironment::translate_table_{get,set}</code> now take a <code>&amp;mut FunctionBuilder</code><br>
so that they can create whole new basic blocks. This is necessary for<br>
implementing GC read/write barriers that involve branching (e.g. checking for<br>
null, or whether a store buffer is at capacity).</p>
<p>Furthermore, it required that the <code>load</code>, <code>load_complex</code>, and <code>store</code><br>
instructions handle loading and storing through an <code>r{32,64}</code> rather than just<br>
<code>i{32,64}</code> addresses. This involved making <code>r{32,64}</code> types acceptable<br>
instantiations of the <code>iAddr</code> type variable, plus a few new instruction<br>
encodings.</p>
<p>Part of #929</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="202480368"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202480368" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202480368">(Jun 30 2020 at 19:02)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#pullrequestreview-440304223">PR Review</a>.</p>



<a name="202480369"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202480369" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202480369">(Jun 30 2020 at 19:02)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1923#discussion_r447914275">PR Review Comment</a>:</p>
<blockquote>
<p>Good idea -- done!</p>
</blockquote>



<a name="202486209"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231923%20wasmtime%3A%20Implement%20%60table.get%60%20and%20%60.../near/202486209" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231923.20wasmtime.3A.20Implement.20.60table.2Eget.60.20and.20.60.2E.2E.2E.html#202486209">(Jun 30 2020 at 19:52)</a>:</h4>
<p>fitzgen merged <a href="https://github.com/bytecodealliance/wasmtime/pull/1923">PR #1923</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>