<html>
<head><meta charset="utf-8"><title>wasmtime / PR #2783 Add support for x64 packed promote low · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html">wasmtime / PR #2783 Add support for x64 packed promote low</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="232041956"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/232041956" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#232041956">(Mar 26 2021 at 22:46)</a>:</h4>
<p>jlb6740 opened <a href="https://github.com/bytecodealliance/wasmtime/pull/2783">PR #2783</a> from <code>implement_64_packed_promotelow_demote</code> to <code>main</code>:</p>
<blockquote>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="232048659"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/232048659" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#232048659">(Mar 27 2021 at 00:18)</a>:</h4>
<p>jlb6740 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2783">PR #2783</a> from <code>implement_64_packed_promotelow_demote</code> to <code>main</code>.</p>



<a name="232048710"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/232048710" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#232048710">(Mar 27 2021 at 00:19)</a>:</h4>
<p><strong>jlb6740</strong> requested <a href="https://github.com/abrown">abrown</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/2783">PR #2783</a>.</p>



<a name="232048728"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/232048728" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#232048728">(Mar 27 2021 at 00:20)</a>:</h4>
<p><strong>jlb6740</strong> requested <a href="https://github.com/cfallin">cfallin</a> and <a href="https://github.com/abrown">abrown</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/2783">PR #2783</a>.</p>



<a name="232056424"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/232056424" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#232056424">(Mar 27 2021 at 02:37)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2783#pullrequestreview-622611396">PR Review</a>.</p>



<a name="232056425"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/232056425" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#232056425">(Mar 27 2021 at 02:37)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/2783#discussion_r602657091">PR Review Comment</a>:</p>
<blockquote>
<p>For this one, I think it does make sense to keep the <code>_low</code> since it indicates which lanes get promoted, but I would drop the <code>v</code> since the <code>_low</code> already implies lanes.</p>
</blockquote>



<a name="232056426"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/232056426" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#232056426">(Mar 27 2021 at 02:37)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/2783#discussion_r602656959">PR Review Comment</a>:</p>
<blockquote>
<p>I would suggest trying to fit this under <code>fdemote</code>: the semantics are very close and we could document on <code>fdemote</code> that, when used on vector types, it's conversions are placed in the lowest lanes. E.g., when demoting lanes 0 and 1 of an <code>f64x2</code>, the results are placed in lanes 0 and 1 of the <code>f32x4</code>). We will also want to document that lanes 2 and 3 are zeroed out.</p>
</blockquote>



<a name="232056427"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/232056427" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#232056427">(Mar 27 2021 at 02:37)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2783#pullrequestreview-622611396">PR Review</a>.</p>



<a name="232056428"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/232056428" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#232056428">(Mar 27 2021 at 02:37)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/2783#discussion_r602657368">PR Review Comment</a>:</p>
<blockquote>
<p>This allows <code>fpromote.f64x2</code> and <code>fpromote_low.f64x2</code> to compile to the same x64 instruction, which I don't think is intended. Perhaps assert that the vectors have <code>op == Opcode::FpromoteLow</code> and the scalars have <code>op == Opcode::Fpromote</code>. (This comment also applies below if you don't do the "fvdemote -&gt; fdemote" renaming).</p>
</blockquote>



<a name="238676101"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/238676101" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#238676101">(May 13 2021 at 20:28)</a>:</h4>
<p>jlb6740 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2783">PR #2783</a> from <code>implement_64_packed_promotelow_demote</code> to <code>main</code>.</p>



<a name="239695844"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/239695844" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#239695844">(May 21 2021 at 04:43)</a>:</h4>
<p>jlb6740 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2783">PR #2783</a> from <code>implement_64_packed_promotelow_demote</code> to <code>main</code>.</p>



<a name="240376405"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/240376405" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#240376405">(May 26 2021 at 19:16)</a>:</h4>
<p>jlb6740 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2783">PR #2783</a> from <code>implement_64_packed_promotelow_demote</code> to <code>main</code>.</p>



<a name="240385144"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/240385144" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#240385144">(May 26 2021 at 20:18)</a>:</h4>
<p>jlb6740 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2783">PR #2783</a> from <code>implement_64_packed_promotelow_demote</code> to <code>main</code>.</p>



<a name="240387542"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/240387542" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#240387542">(May 26 2021 at 20:36)</a>:</h4>
<p>jlb6740 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2783#pullrequestreview-622692020">PR review</a>.</p>



<a name="240387543"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/240387543" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#240387543">(May 26 2021 at 20:36)</a>:</h4>
<p>jlb6740 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2783#discussion_r602776385">PR review comment</a>:</p>
<blockquote>
<p>Yes, I don't disagree about combining fdemote and fvdemote feeling like the natural thing to do. In fact I tried that first as but doing that failed due to the constraint requiring the lane sizes remain the same. Trying to support both  both f32.demote and f32x4.demote_f64x2_zero with fdemote would require us to make this instruction definition less specific. In that case comments about zeroing lanes would not apply to the general instruction here as it only applies when lowering f32x4.demote_f64x2_zero? If not combined then certainly adding that zeroing part makes sense. Even though the language is there and seemly necessary in <a href="http://instruction.rs">instruction.rs</a>, frankly I don't really see the concept of lanes with the definition of f32.demote. But that's a different subject. What do you think about the implication of making the fdemote instruction comments less specific if we are trying to cover the two different lowerings?</p>
</blockquote>



<a name="240387544"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/240387544" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#240387544">(May 26 2021 at 20:36)</a>:</h4>
<p>jlb6740 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2783#pullrequestreview-622692020">PR review</a>.</p>



<a name="240391128"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/240391128" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#240391128">(May 26 2021 at 21:02)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2783#pullrequestreview-669525921">PR review</a>.</p>



<a name="240391130"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/240391130" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#240391130">(May 26 2021 at 21:02)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/2783#discussion_r640111103">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>        Considering only the lower half of the register, the low lanes in `x` are interpreted as
        single precision floats that are then converted to double precision floats.
</code></pre></div><br>
</p>
</blockquote>



<a name="240391131"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/240391131" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#240391131">(May 26 2021 at 21:02)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2783#pullrequestreview-669525921">PR review</a>.</p>



<a name="240391132"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/240391132" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#240391132">(May 26 2021 at 21:02)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/2783#discussion_r640118700">PR review comment</a>:</p>
<blockquote>
<p>I think we still need to think about this comment...</p>
</blockquote>



<a name="240391135"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/240391135" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#240391135">(May 26 2021 at 21:02)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/2783#discussion_r640117614">PR review comment</a>:</p>
<blockquote>
<p>I also see <code>.constraints(vec![WiderOrEq(Float.clone(), FloatTo.clone())]),</code> used in a few places, which might be a more generic approach.</p>
</blockquote>



<a name="240391137"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/240391137" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#240391137">(May 26 2021 at 21:02)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/2783#discussion_r640116051">PR review comment</a>:</p>
<blockquote>
<div class="codehilite" data-code-language="suggestion"><pre><span></span><code>    let FxN = &amp;TypeVar::new(
        "FxN",
        "A vector floating point number",
        TypeSetBuilder::new()
            .floats(Interval::All)
            .simd_lanes(Interval::All)
            .includes_scalars(false)
            .build(),
    );
    let x = &amp;Operand::new("x", FxN);
    let a = &amp;Operand::new("a", FxN.merge_lanes());
</code></pre></div>
<p>I think if we want to be more precise with the types here we should use a "vector float" type (e.g. build a new <code>FxN</code>) and tell the type system using <code>.merge_lanes()</code> that the result will have the same number of bits, just half the number of lanes, like we do in the documentation.</p>
</blockquote>



<a name="241301092"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/241301092" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#241301092">(Jun 02 2021 at 18:36)</a>:</h4>
<p>jlb6740 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2783">PR #2783</a> from <code>implement_64_packed_promotelow_demote</code> to <code>main</code>.</p>



<a name="241305652"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/241305652" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#241305652">(Jun 02 2021 at 19:12)</a>:</h4>
<p>jlb6740 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2783">PR #2783</a> from <code>implement_64_packed_promotelow_demote</code> to <code>main</code>.</p>



<a name="241306106"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/241306106" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#241306106">(Jun 02 2021 at 19:16)</a>:</h4>
<p>jlb6740 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2783">PR #2783</a> from <code>implement_64_packed_promotelow_demote</code> to <code>main</code>.</p>



<a name="241312323"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/241312323" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#241312323">(Jun 02 2021 at 20:05)</a>:</h4>
<p>jlb6740 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2783#pullrequestreview-674633092">PR review</a>.</p>



<a name="241312324"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/241312324" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#241312324">(Jun 02 2021 at 20:05)</a>:</h4>
<p>jlb6740 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2783#discussion_r644283078">PR review comment</a>:</p>
<blockquote>
<p>Reverted back to having a separate lowering for fvdemote after some offline discussion with @abrown. The impact of adding a constraint was not clear. For example, I thought if adding the constraint:</p>
<p>.constraints(vec![WiderOrEq(Float.clone(), FloatTo.clone())]),</p>
<p>this meant that x needed to be wider or equal to a. When I did this the spec test passed as expected. However, when I reversed the constraint to say</p>
<p>.constraints(vec![WiderOrEq(FloatTo.clone(), Float.clone())]),</p>
<p>This also passed. For this reason I just left it out which is what the original patch submission did (as written in the notes). <br>
</p>
</blockquote>



<a name="241312619"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/241312619" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#241312619">(Jun 02 2021 at 20:07)</a>:</h4>
<p>jlb6740 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2783#pullrequestreview-674635141">PR review</a>.</p>



<a name="241312620"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/241312620" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#241312620">(Jun 02 2021 at 20:07)</a>:</h4>
<p>jlb6740 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2783#discussion_r644284581">PR review comment</a>:</p>
<blockquote>
<p>Note the original patch used fvpromote_low. This was to be consistent with fvdemote. However there was a desire to rename fvpromote_low to fpromote_low and also git rid of fvdemote (combine with fdemote). Now that fvdemote is back, the naming is inconsistent here but that may be OK. </p>
</blockquote>



<a name="241312655"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/241312655" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#241312655">(Jun 02 2021 at 20:07)</a>:</h4>
<p>jlb6740 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2783#discussion_r644284581">PR review comment</a>.</p>



<a name="241463407"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/241463407" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#241463407">(Jun 03 2021 at 22:15)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2783#pullrequestreview-675768078">PR review</a>.</p>



<a name="241463408"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/241463408" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#241463408">(Jun 03 2021 at 22:15)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2783#pullrequestreview-675768078">PR review</a>.</p>



<a name="241463409"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/241463409" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#241463409">(Jun 03 2021 at 22:15)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/2783#discussion_r645165006">PR review comment</a>:</p>
<blockquote>
<p>Same type comments apply here.</p>
</blockquote>



<a name="241463410"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/241463410" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#241463410">(Jun 03 2021 at 22:15)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/2783#discussion_r645156598">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>            "fvpromote_low",
</code></pre></div><br>
</p>
</blockquote>



<a name="241463411"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/241463411" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#241463411">(Jun 03 2021 at 22:15)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/2783#discussion_r645164687">PR review comment</a>:</p>
<blockquote>
<p>We need to make sure that we constrain this so that the following is not possible:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fconst</span><span class="p">.</span><span class="n">f64x2</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fvdemote</span><span class="p">.</span><span class="kt">f32</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
</code></pre></div>
<p>Right now this looks possible, but we shouldn't be able to demote from a vector to a scalar (doesn't make sense). If we add the <code>WiderOrEq(x, a)</code> constraint, though, the types allowed should be, e.g., <code>f64x2</code> -&gt; <code>f32x2</code>, but <code>f32x2</code> isn't really a valid type in WebAssembly (it is in CLIF).</p>
<p>I think we should use the <code>.merge_lanes()</code> approach here so that the types are  <code>f64x2</code> -&gt; <code>f32x4</code> and then in the instruction description <strong>we have to specify that the top two lanes are zeroed out</strong>. Or alternately, just explicitly put the types in.<br>
</p>
</blockquote>



<a name="241463412"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/241463412" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#241463412">(Jun 03 2021 at 22:15)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/2783#discussion_r645164431">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>                With Fvdemote there is no constraint on having the result type have the same
</code></pre></div><br>
</p>
</blockquote>



<a name="241495474"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/241495474" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#241495474">(Jun 04 2021 at 06:27)</a>:</h4>
<p>jlb6740 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2783">PR #2783</a> from <code>implement_64_packed_promotelow_demote</code> to <code>main</code>.</p>



<a name="241585566"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/241585566" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#241585566">(Jun 04 2021 at 19:56)</a>:</h4>
<p>jlb6740 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2783#pullrequestreview-676621726">PR review</a>.</p>



<a name="241585567"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/241585567" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#241585567">(Jun 04 2021 at 19:56)</a>:</h4>
<p>jlb6740 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2783#discussion_r645817225">PR review comment</a>:</p>
<blockquote>
<p>I've created new types with explicit lanes. Interesting enough after doing this I had to update the state push call in <a href="http://code_translator.rs">code_translator.rs</a>. I also could have used split_lanes here though that would have been less constrained and semantically speaking just sounds vague on what that implies. </p>
</blockquote>



<a name="241589048"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/241589048" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#241589048">(Jun 04 2021 at 20:28)</a>:</h4>
<p>jlb6740 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2783">PR #2783</a> from <code>implement_64_packed_promotelow_demote</code> to <code>main</code>.</p>



<a name="241601489"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/241601489" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#241601489">(Jun 04 2021 at 22:50)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2783#pullrequestreview-676710100">PR review</a>.</p>



<a name="241601886"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/241601886" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#241601886">(Jun 04 2021 at 22:57)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2783#pullrequestreview-676712245">PR review</a>.</p>



<a name="241601998"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232783%20Add%20support%20for%20x64%20packed%20promote%20low/near/241601998" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232783.20Add.20support.20for.20x64.20packed.20promote.20low.html#241601998">(Jun 04 2021 at 22:59)</a>:</h4>
<p>abrown merged <a href="https://github.com/bytecodealliance/wasmtime/pull/2783">PR #2783</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>