<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #1615 Legalize [su]extend.i64 to iconst/... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231615.20Legalize.20.5Bsu.5Dextend.2Ei64.20to.20iconst.2F.2E.2E.2E.html">wasmtime / Issue #1615 Legalize [su]extend.i64 to iconst/...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="195521402"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231615%20Legalize%20%5Bsu%5Dextend.i64%20to%20iconst/.../near/195521402" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231615.20Legalize.20.5Bsu.5Dextend.2Ei64.20to.20iconst.2F.2E.2E.2E.html#195521402">(Apr 28 2020 at 05:49)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/1615#issuecomment-620394992" title="https://github.com/bytecodealliance/wasmtime/pull/1615#issuecomment-620394992">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1615" title="https://github.com/bytecodealliance/wasmtime/pull/1615">Issue #1615</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @bnjbvr</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "cranelift:meta"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>bnjbvr: cranelift</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action" title="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="195553564"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231615%20Legalize%20%5Bsu%5Dextend.i64%20to%20iconst/.../near/195553564" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231615.20Legalize.20.5Bsu.5Dextend.2Ei64.20to.20iconst.2F.2E.2E.2E.html#195553564">(Apr 28 2020 at 12:09)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/pull/1615#issuecomment-620565425" title="https://github.com/bytecodealliance/wasmtime/pull/1615#issuecomment-620565425">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1615" title="https://github.com/bytecodealliance/wasmtime/pull/1615">Issue #1615</a>:</p>
<blockquote>
<p>Do I need to do something about the CI?</p>
</blockquote>



<a name="195555538"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231615%20Legalize%20%5Bsu%5Dextend.i64%20to%20iconst/.../near/195555538" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231615.20Legalize.20.5Bsu.5Dextend.2Ei64.20to.20iconst.2F.2E.2E.2E.html#195555538">(Apr 28 2020 at 12:27)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/1615#issuecomment-620573847" title="https://github.com/bytecodealliance/wasmtime/pull/1615#issuecomment-620573847">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1615" title="https://github.com/bytecodealliance/wasmtime/pull/1615">Issue #1615</a>:</p>
<blockquote>
<p>Yes, I don't know why this would change the test output though.</p>
</blockquote>



<a name="195565195"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231615%20Legalize%20%5Bsu%5Dextend.i64%20to%20iconst/.../near/195565195" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231615.20Legalize.20.5Bsu.5Dextend.2Ei64.20to.20iconst.2F.2E.2E.2E.html#195565195">(Apr 28 2020 at 13:39)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/pull/1615#issuecomment-620614659" title="https://github.com/bytecodealliance/wasmtime/pull/1615#issuecomment-620614659">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1615" title="https://github.com/bytecodealliance/wasmtime/pull/1615">Issue #1615</a>:</p>
<blockquote>
<blockquote>
<p>I don't know why this would change the test output though.</p>
</blockquote>
<p>Hm, I'm not sure either unfortunately.</p>
</blockquote>



<a name="195624504"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231615%20Legalize%20%5Bsu%5Dextend.i64%20to%20iconst/.../near/195624504" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231615.20Legalize.20.5Bsu.5Dextend.2Ei64.20to.20iconst.2F.2E.2E.2E.html#195624504">(Apr 28 2020 at 20:46)</a>:</h4>
<p>iximeow <a href="https://github.com/bytecodealliance/wasmtime/pull/1615#issuecomment-620845455" title="https://github.com/bytecodealliance/wasmtime/pull/1615#issuecomment-620845455">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1615" title="https://github.com/bytecodealliance/wasmtime/pull/1615">Issue #1615</a>:</p>
<blockquote>
<p>The test change is consistent with this patch, the <code>uextend.i64</code> in the test case legalizes differently:</p>
<div class="codehilite"><pre><span></span><code>; over in filetests/filetests/isa/riscv/legalize-abi.clif:

function %split_call_arg(i32) {
    fn1 = %foo(i64)
    fn2 = %foo(i32, i64)
block0(v0: i32):
    v1 = uextend.i64 v0
    call fn1(v1)
    ; check: $(v1l=$V), $(v1h=$V) = isplit v1
    ; check: call fn1($v1l, $v1h)
    call fn2(v0, v1)
    ; check: call fn2(v0, $V, $V)
    return
}
</code></pre></div>


<p>The check that fails is <code>$(v1l=$V), $(v1h=$V) = isplit v1</code>, looking to see that the extended <code>v1</code> is split back into two <code>i32</code> arguments. Since this legalizes into an <code>iconst.i32 0</code> the two <code>i32</code> values are passed directly instead of going through a concat/split. I'm a little surprised to see it that smart, but that looks like what's happening.</p>
<p>Since the spirit of this test looks to be that the <code>i64</code> argument of <code>fn1</code> is split into two <code>i32</code> that the platform can use, just changing the check will do:</p>
<div class="codehilite"><pre><span></span><code>function %split_call_arg(i32) {
    fn1 = %foo(i64)
    fn2 = %foo(i32, i64)
block0(v0: i32):
    v1 = uextend.i64 v0
    call fn1(v1)
    ; check: $(v1h=$V) = iconst.i32 0
    ; check: call fn1(v0, $v1h)
    call fn2(v0, v1)
    ; check: call fn2(v0, $V, $V)
    return
}
</code></pre></div>


</blockquote>



<a name="195682991"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231615%20Legalize%20%5Bsu%5Dextend.i64%20to%20iconst/.../near/195682991" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231615.20Legalize.20.5Bsu.5Dextend.2Ei64.20to.20iconst.2F.2E.2E.2E.html#195682991">(Apr 29 2020 at 09:37)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/1615#issuecomment-621094339" title="https://github.com/bytecodealliance/wasmtime/pull/1615#issuecomment-621094339">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1615" title="https://github.com/bytecodealliance/wasmtime/pull/1615">Issue #1615</a>:</p>
<blockquote>
<blockquote>
<p>I'm a little surprised to see it that smart, but that looks like what's happening.</p>
</blockquote>
<p><code>isplit</code> and <code>iconcat</code> inside legalizations are immediately applied when possible without creating an instruction and then legalizing them afterwards.</p>
</blockquote>



<a name="196033467"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231615%20Legalize%20%5Bsu%5Dextend.i64%20to%20iconst/.../near/196033467" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231615.20Legalize.20.5Bsu.5Dextend.2Ei64.20to.20iconst.2F.2E.2E.2E.html#196033467">(May 02 2020 at 04:48)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/pull/1615#issuecomment-622668642" title="https://github.com/bytecodealliance/wasmtime/pull/1615#issuecomment-622668642">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1615" title="https://github.com/bytecodealliance/wasmtime/pull/1615">Issue #1615</a>:</p>
<blockquote>
<p>Thanks @iximeow! I've fixed the test.</p>
</blockquote>



<a name="196367672"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231615%20Legalize%20%5Bsu%5Dextend.i64%20to%20iconst/.../near/196367672" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231615.20Legalize.20.5Bsu.5Dextend.2Ei64.20to.20iconst.2F.2E.2E.2E.html#196367672">(May 05 2020 at 21:05)</a>:</h4>
<p>iximeow <a href="https://github.com/bytecodealliance/wasmtime/pull/1615#issuecomment-624305949" title="https://github.com/bytecodealliance/wasmtime/pull/1615#issuecomment-624305949">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1615" title="https://github.com/bytecodealliance/wasmtime/pull/1615">Issue #1615</a>:</p>
<blockquote>
<p>I noticed on Sunday or so that macos CI for <code>2d6c977</code> failed with what looked like a transient error (downloading the rust toolchain timed out or something along those lines), and tried rerunning it then, only to forget to revisit shortly thereafter. It looks like that rerun failed, believing that commit no longer exists?</p>
<div class="codehilite"><pre><span></span><code>git checkout --progress --force 2d6c977a4b9061c7a94d324dbaa0a9a93ba383cd
##[error]fatal: reference is not a tree: 2d6c977a4b9061c7a94d324dbaa0a9a93ba383cd
##[error]Git checkout failed with exit code: 128
##[error]Exit code 1 returned from process: file name &#39;/home/runner/runners/2.169.1/bin/Runner.PluginHost&#39;, arguments &#39;action &quot;GitHub.Runner.Plugins.Repository.v1_0.CheckoutTask, Runner.Plugins&quot;&#39;.
</code></pre></div>


<p>I just reran it again to the same failure. The last time I'd seen this category of failure was last week when GitHub was having issues a week or two ago, but that doesn't seem to be the case here. I don't have the faintest clue why CI no longer believes this commit exists: <a href="https://github.com/bytecodealliance/wasmtime/commit/2d6c977a4b9061c7a94d324dbaa0a9a93ba383cd" title="https://github.com/bytecodealliance/wasmtime/commit/2d6c977a4b9061c7a94d324dbaa0a9a93ba383cd">it obviously does exist</a>.</p>
</blockquote>



<a name="196373760"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231615%20Legalize%20%5Bsu%5Dextend.i64%20to%20iconst/.../near/196373760" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231615.20Legalize.20.5Bsu.5Dextend.2Ei64.20to.20iconst.2F.2E.2E.2E.html#196373760">(May 05 2020 at 21:58)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/pull/1615#issuecomment-624328549" title="https://github.com/bytecodealliance/wasmtime/pull/1615#issuecomment-624328549">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1615" title="https://github.com/bytecodealliance/wasmtime/pull/1615">Issue #1615</a>:</p>
<blockquote>
<p>I fiddled with git some, hope this helps.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>