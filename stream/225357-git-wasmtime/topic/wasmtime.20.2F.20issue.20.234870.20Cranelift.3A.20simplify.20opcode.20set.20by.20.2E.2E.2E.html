<html>
<head><meta charset="utf-8"><title>wasmtime / issue #4870 Cranelift: simplify opcode set by ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234870.20Cranelift.3A.20simplify.20opcode.20set.20by.20.2E.2E.2E.html">wasmtime / issue #4870 Cranelift: simplify opcode set by ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="297228321"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234870%20Cranelift%3A%20simplify%20opcode%20set%20by%20.../near/297228321" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234870.20Cranelift.3A.20simplify.20opcode.20set.20by.20.2E.2E.2E.html#297228321">(Sep 05 2022 at 13:37)</a>:</h4>
<p>afonso360 opened <a href="https://github.com/bytecodealliance/wasmtime/issues/4870">issue #4870</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>Jun Ryung Ju (sorry, I don't know the github user) on <a href="#narrow/stream/206238-general/topic/asking.20help.20for.20first.20time.20contribution/near/297216851">zulip</a> discovered that bitwise operations on floats are unimplemented on AArch64. Upon further investigation they seem to be unimplemented everywhere.</p>
<p>@bjorn3 also mentions that cg_clif does not use them, it does a <code>bitcast</code> and then the operation on the integer version.</p>
<p>This makes it likely a good candidate for simplifying our opcode set.</p>
<p>Is there any benefit / optimization that we can do on these that would justify keeping them around?</p>
<p>The bitwise ops that I'm referring to are:</p>
<ul>
<li><code>band</code></li>
<li><code>bor</code></li>
<li><code>bxor</code></li>
<li><code>bnot</code></li>
<li><code>bor_not</code></li>
<li><code>bxor_not</code></li>
</ul>
<p>cc: @cfallin </p>
</blockquote>



<a name="297228504"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234870%20Cranelift%3A%20simplify%20opcode%20set%20by%20.../near/297228504" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234870.20Cranelift.3A.20simplify.20opcode.20set.20by.20.2E.2E.2E.html#297228504">(Sep 05 2022 at 13:38)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/4870">issue #4870</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>Jun Ryung Ju (sorry, I don't know the github user) on <a href="#narrow/stream/206238-general/topic/asking.20help.20for.20first.20time.20contribution/near/297216851">zulip</a> discovered that bitwise operations on floats are unimplemented on AArch64. Upon further investigation they seem to be unimplemented on all backends.</p>
<p>@bjorn3 also mentions that cg_clif does not use them, it does a <code>bitcast</code> and then the operation on the integer version.</p>
<p>This makes it likely a good candidate for simplifying our opcode set.</p>
<p>Is there any benefit / optimization that we can do on these that would justify keeping them around?</p>
<p>The bitwise ops that I'm referring to are:</p>
<ul>
<li><code>band</code></li>
<li><code>bor</code></li>
<li><code>bxor</code></li>
<li><code>bnot</code></li>
<li><code>bor_not</code></li>
<li><code>bxor_not</code></li>
</ul>
<p>cc: @cfallin </p>
</blockquote>



<a name="297329496"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234870%20Cranelift%3A%20simplify%20opcode%20set%20by%20.../near/297329496" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234870.20Cranelift.3A.20simplify.20opcode.20set.20by.20.2E.2E.2E.html#297329496">(Sep 06 2022 at 09:05)</a>:</h4>
<p>yuyang-ok <a href="https://github.com/bytecodealliance/wasmtime/issues/4870#issuecomment-1237870625">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4870">issue #4870</a>:</p>
<blockquote>
<p>+1 remove.</p>
</blockquote>



<a name="297475227"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234870%20Cranelift%3A%20simplify%20opcode%20set%20by%20.../near/297475227" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234870.20Cranelift.3A.20simplify.20opcode.20set.20by.20.2E.2E.2E.html#297475227">(Sep 06 2022 at 19:43)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/issues/4870#issuecomment-1238579109">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4870">issue #4870</a>:</p>
<blockquote>
<p>Perhaps optimizations like #4803 would do better if we keep bitwise CLIF operations on floats—we could express the optimization in the mid-end without introducing extra bitcast instructions.</p>
<p>That said, looking more closely, I think the best code sequence for that particular optimization is different enough across backends that we may not want to do it in the mid-end anyway. And it's niche enough to be a really weak argument for keeping bitwise operators on floats.</p>
<p>By contrast, I find the opposite argument compelling: they're complicated to lower on probably any architecture with a hardware floating-point unit, and nobody has wanted them yet.</p>
<p>So I'm also in favor of removing them.</p>
</blockquote>



<a name="297564185"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234870%20Cranelift%3A%20simplify%20opcode%20set%20by%20.../near/297564185" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234870.20Cranelift.3A.20simplify.20opcode.20set.20by.20.2E.2E.2E.html#297564185">(Sep 07 2022 at 10:54)</a>:</h4>
<p>akirilov-arm <a href="https://github.com/bytecodealliance/wasmtime/issues/4870#issuecomment-1239232517">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4870">issue #4870</a>:</p>
<blockquote>
<p>@afonso360 You are missing <code>band_not</code> in your list.</p>
<p>Those operations are actually straightforward to implement on AArch64, since there is a hardware floating-point unit iff SIMD is supported; only <code>bxor_not</code> is a 2-instruction sequence (instead of 1). However, I probably also lean towards removing them, given the niche use case.</p>
</blockquote>



<a name="297567941"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234870%20Cranelift%3A%20simplify%20opcode%20set%20by%20.../near/297567941" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234870.20Cranelift.3A.20simplify.20opcode.20set.20by.20.2E.2E.2E.html#297567941">(Sep 07 2022 at 11:17)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/issues/4870#issuecomment-1239255441">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4870">issue #4870</a>:</p>
<blockquote>
<p>Added, Thanks!</p>
</blockquote>



<a name="297567970"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234870%20Cranelift%3A%20simplify%20opcode%20set%20by%20.../near/297567970" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234870.20Cranelift.3A.20simplify.20opcode.20set.20by.20.2E.2E.2E.html#297567970">(Sep 07 2022 at 11:17)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/4870">issue #4870</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>Jun Ryung Ju (sorry, I don't know the github user) on <a href="#narrow/stream/206238-general/topic/asking.20help.20for.20first.20time.20contribution/near/297216851">zulip</a> discovered that bitwise operations on floats are unimplemented on AArch64. Upon further investigation they seem to be unimplemented on all backends.</p>
<p>@bjorn3 also mentions that cg_clif does not use them, it does a <code>bitcast</code> and then the operation on the integer version.</p>
<p>This makes it likely a good candidate for simplifying our opcode set.</p>
<p>Is there any benefit / optimization that we can do on these that would justify keeping them around?</p>
<p>The bitwise ops that I'm referring to are:</p>
<ul>
<li><code>band</code></li>
<li><code>bor</code></li>
<li><code>bxor</code></li>
<li><code>bnot</code></li>
<li><code>band_not</code></li>
<li><code>bor_not</code></li>
<li><code>bxor_not</code></li>
</ul>
<p>cc: @cfallin </p>
</blockquote>



<a name="297661616"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234870%20Cranelift%3A%20simplify%20opcode%20set%20by%20.../near/297661616" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234870.20Cranelift.3A.20simplify.20opcode.20set.20by.20.2E.2E.2E.html#297661616">(Sep 07 2022 at 19:45)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/4870#issuecomment-1239802035">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4870">issue #4870</a>:</p>
<blockquote>
<p>Agreed, I think we should remove them. A floating-point type imbues some meaning on the value such that it's not meant to be used (or is not typically used) as a "bucket of bits" type, as integer types are.</p>
<p>I suspect that it would be <em>possible</em> to do reasonable lowerings for these on x86-64 too (since we use XMM regs and would have the integer-vec instructions at our disposal, just as on aarch64), so that angle doesn't hold as much significance for me. However, the "only build what is needed" angle <em>does</em>: if no one actually needs these op/type combinations and they are extra lowerings to add, maintain, and test, then let's not have them IMHO.</p>
</blockquote>



<a name="297674578"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234870%20Cranelift%3A%20simplify%20opcode%20set%20by%20.../near/297674578" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234870.20Cranelift.3A.20simplify.20opcode.20set.20by.20.2E.2E.2E.html#297674578">(Sep 07 2022 at 21:14)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/issues/4870#issuecomment-1239891048">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4870">issue #4870</a>:</p>
<blockquote>
<p>It turns out that Wasmtime can actually generate SIMD bitwise ops on floating-point vectors, as in this example (from <code>tests/misc_testsuite/simd/issue_3327_bnot_lowering.wast</code> and #3327):</p>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="p">(</span><span class="k">module</span>
  <span class="p">(</span><span class="k">func</span> <span class="nv">$v128_not</span> <span class="p">(</span><span class="k">export</span> <span class="s2">"v128_not"</span><span class="p">)</span> <span class="p">(</span><span class="k">result</span> <span class="err">v</span><span class="mf">128</span><span class="p">)</span>
    <span class="err">v</span><span class="mf">128</span><span class="err">.const</span> <span class="kt">f32</span><span class="err">x</span><span class="mf">4 0</span> <span class="mf">0 0</span> <span class="mi">0</span>
    <span class="kt">f32</span><span class="err">x</span><span class="mi">4</span><span class="err">.abs</span>
    <span class="err">v</span><span class="mf">128</span><span class="err">.not</span><span class="p">)</span>
<span class="p">)</span>

<span class="p">(</span><span class="err">assert_</span><span class="nb">return</span> <span class="p">(</span><span class="err">invoke</span> <span class="s2">"v128_not"</span><span class="p">)</span> <span class="p">(</span><span class="err">v</span><span class="mf">128</span><span class="err">.const</span> <span class="kt">i32</span><span class="err">x</span><span class="mi">4</span> <span class="mi">-1</span> <span class="mi">-1</span> <span class="mi">-1</span> <span class="mi">-1</span><span class="p">))</span>
</code></pre></div>
<p>That currently compiles to this CLIF:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="n">vmctx</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">i8x16</span><span class="w"> </span><span class="n">fast</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">const0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000000000000000000000000000000</span><span class="w"></span>

<span class="w">                                </span><span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">)</span>:
<span class="o">@</span><span class="mi">0026</span><span class="w">                               </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vconst</span><span class="p">.</span><span class="n">i8x16</span><span class="w"> </span><span class="n">const0</span><span class="w"></span>
<span class="o">@</span><span class="mi">0038</span><span class="w">                               </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">raw_bitcast</span><span class="p">.</span><span class="n">f32x4</span><span class="w"> </span><span class="n">v2</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">const0</span><span class="w"></span>
<span class="o">@</span><span class="mi">0038</span><span class="w">                               </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fabs</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>
<span class="o">@</span><span class="mi">003</span><span class="n">b</span><span class="w">                               </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bnot</span><span class="w"> </span><span class="n">v4</span><span class="w"></span>
<span class="o">@</span><span class="mi">003</span><span class="n">d</span><span class="w">                               </span><span class="n">v6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">raw_bitcast</span><span class="p">.</span><span class="n">i8x16</span><span class="w"> </span><span class="n">v5</span><span class="w"></span>
<span class="o">@</span><span class="mi">003</span><span class="n">d</span><span class="w">                               </span><span class="n">jump</span><span class="w"> </span><span class="n">block1</span><span class="p">(</span><span class="n">v6</span><span class="p">)</span><span class="w"></span>

<span class="w">                                </span><span class="n">block1</span><span class="p">(</span><span class="n">v1</span>: <span class="nc">i8x16</span><span class="p">)</span>:
<span class="o">@</span><span class="mi">003</span><span class="n">d</span><span class="w">                               </span><span class="k">return</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Do we want <code>cranelift-wasm</code> to insert a bitcast in between the <code>fabs</code> and <code>bnot</code> here?</p>
</blockquote>



<a name="297686178"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234870%20Cranelift%3A%20simplify%20opcode%20set%20by%20.../near/297686178" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234870.20Cranelift.3A.20simplify.20opcode.20set.20by.20.2E.2E.2E.html#297686178">(Sep 07 2022 at 23:00)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/issues/4870#issuecomment-1239991119">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4870">issue #4870</a>:</p>
<blockquote>
<p>I would prefer fewer <code>raw_bitcasts</code> if at all possible? I'm not very fond of it...</p>
</blockquote>



<a name="297688776"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234870%20Cranelift%3A%20simplify%20opcode%20set%20by%20.../near/297688776" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234870.20Cranelift.3A.20simplify.20opcode.20set.20by.20.2E.2E.2E.html#297688776">(Sep 07 2022 at 23:29)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/4870#issuecomment-1240017433">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4870">issue #4870</a>:</p>
<blockquote>
<p>Ah, interesting! That actually does change the calculus a bit in my mind. Given the principle above (only build what is needed) as the higher-priority one, I think it's totally fine to keep this support. Then for consistency it probably makes sense to support scalar floats as well; otherwise we have support for scalar ints, and all kinds of vectors, but not scalar floats, which is an odd and surprising hole.</p>
</blockquote>



<a name="298347459"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234870%20Cranelift%3A%20simplify%20opcode%20set%20by%20.../near/298347459" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234870.20Cranelift.3A.20simplify.20opcode.20set.20by.20.2E.2E.2E.html#298347459">(Sep 12 2022 at 09:50)</a>:</h4>
<p>akirilov-arm labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/4870">issue #4870</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>Jun Ryung Ju (sorry, I don't know the github user) on <a href="#narrow/stream/206238-general/topic/asking.20help.20for.20first.20time.20contribution/near/297216851">zulip</a> discovered that bitwise operations on floats are unimplemented on AArch64. Upon further investigation they seem to be unimplemented on all backends.</p>
<p>@bjorn3 also mentions that cg_clif does not use them, it does a <code>bitcast</code> and then the operation on the integer version.</p>
<p>This makes it likely a good candidate for simplifying our opcode set.</p>
<p>Is there any benefit / optimization that we can do on these that would justify keeping them around?</p>
<p>The bitwise ops that I'm referring to are:</p>
<ul>
<li><code>band</code></li>
<li><code>bor</code></li>
<li><code>bxor</code></li>
<li><code>bnot</code></li>
<li><code>band_not</code></li>
<li><code>bor_not</code></li>
<li><code>bxor_not</code></li>
</ul>
<p>cc: @cfallin </p>
</blockquote>



<a name="298347461"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234870%20Cranelift%3A%20simplify%20opcode%20set%20by%20.../near/298347461" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234870.20Cranelift.3A.20simplify.20opcode.20set.20by.20.2E.2E.2E.html#298347461">(Sep 12 2022 at 09:50)</a>:</h4>
<p>akirilov-arm labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/4870">issue #4870</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>Jun Ryung Ju (sorry, I don't know the github user) on <a href="#narrow/stream/206238-general/topic/asking.20help.20for.20first.20time.20contribution/near/297216851">zulip</a> discovered that bitwise operations on floats are unimplemented on AArch64. Upon further investigation they seem to be unimplemented on all backends.</p>
<p>@bjorn3 also mentions that cg_clif does not use them, it does a <code>bitcast</code> and then the operation on the integer version.</p>
<p>This makes it likely a good candidate for simplifying our opcode set.</p>
<p>Is there any benefit / optimization that we can do on these that would justify keeping them around?</p>
<p>The bitwise ops that I'm referring to are:</p>
<ul>
<li><code>band</code></li>
<li><code>bor</code></li>
<li><code>bxor</code></li>
<li><code>bnot</code></li>
<li><code>band_not</code></li>
<li><code>bor_not</code></li>
<li><code>bxor_not</code></li>
</ul>
<p>cc: @cfallin </p>
</blockquote>



<a name="302691589"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234870%20Cranelift%3A%20simplify%20opcode%20set%20by%20.../near/302691589" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234870.20Cranelift.3A.20simplify.20opcode.20set.20by.20.2E.2E.2E.html#302691589">(Oct 06 2022 at 16:23)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/issues/4870#issuecomment-1270362756">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4870">issue #4870</a>:</p>
<blockquote>
<p>I'm closing this issue as we seem to have reached consensus on keeping bitwise operations on floats.</p>
</blockquote>



<a name="302691590"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234870%20Cranelift%3A%20simplify%20opcode%20set%20by%20.../near/302691590" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234870.20Cranelift.3A.20simplify.20opcode.20set.20by.20.2E.2E.2E.html#302691590">(Oct 06 2022 at 16:23)</a>:</h4>
<p>jameysharp closed <a href="https://github.com/bytecodealliance/wasmtime/issues/4870">issue #4870</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>Jun Ryung Ju (sorry, I don't know the github user) on <a href="#narrow/stream/206238-general/topic/asking.20help.20for.20first.20time.20contribution/near/297216851">zulip</a> discovered that bitwise operations on floats are unimplemented on AArch64. Upon further investigation they seem to be unimplemented on all backends.</p>
<p>@bjorn3 also mentions that cg_clif does not use them, it does a <code>bitcast</code> and then the operation on the integer version.</p>
<p>This makes it likely a good candidate for simplifying our opcode set.</p>
<p>Is there any benefit / optimization that we can do on these that would justify keeping them around?</p>
<p>The bitwise ops that I'm referring to are:</p>
<ul>
<li><code>band</code></li>
<li><code>bor</code></li>
<li><code>bxor</code></li>
<li><code>bnot</code></li>
<li><code>band_not</code></li>
<li><code>bor_not</code></li>
<li><code>bxor_not</code></li>
</ul>
<p>cc: @cfallin </p>
</blockquote>



<a name="303176452"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234870%20Cranelift%3A%20simplify%20opcode%20set%20by%20.../near/303176452" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234870.20Cranelift.3A.20simplify.20opcode.20set.20by.20.2E.2E.2E.html#303176452">(Oct 09 2022 at 22:27)</a>:</h4>
<p>ArtBlnd <a href="https://github.com/bytecodealliance/wasmtime/issues/4870#issuecomment-1272641657">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4870">issue #4870</a>:</p>
<blockquote>
<p>Ok. I am working on implementing float bitops on x86_64 currently. looks implementing bitwise operation using bitcasts results terrible.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">VCode</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">Entry</span><span class="w"> </span><span class="n">block</span>: <span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="n">v130</span><span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="n">v135</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="mi">0</span>:
    <span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="n">IR</span><span class="w"> </span><span class="n">block</span>: <span class="nc">block0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="n">range</span>: <span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">0</span>: <span class="nc">args</span><span class="w"> </span><span class="o">%</span><span class="n">v128</span><span class="o">=%</span><span class="n">xmm0</span><span class="w"> </span><span class="o">%</span><span class="n">v129</span><span class="o">=%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">1</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v128</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v132l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">2</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v129</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v133l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">3</span>: <span class="nc">andl</span><span class="w">    </span><span class="o">%</span><span class="n">v132l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v133l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v134l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">4</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v134l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v135</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">5</span>: <span class="nc">movaps</span><span class="w">  </span><span class="o">%</span><span class="n">v130</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v131</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">6</span>: <span class="nc">movaps</span><span class="w">  </span><span class="o">%</span><span class="n">v131</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">xmm0</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">7</span>: <span class="nc">ret</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I think we need to make F32 and F64 to select Gpr instead of Xmm registers.</p>
</blockquote>



<a name="303176619"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234870%20Cranelift%3A%20simplify%20opcode%20set%20by%20.../near/303176619" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234870.20Cranelift.3A.20simplify.20opcode.20set.20by.20.2E.2E.2E.html#303176619">(Oct 09 2022 at 22:31)</a>:</h4>
<p>ArtBlnd edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4870#issuecomment-1272641657">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4870">issue #4870</a>:</p>
<blockquote>
<p>Ok. I am working on implementing float bitops on x86_64 currently. looks implementing bitwise operation using bitcasts results terrible.</p>
<blockquote>
<blockquote>
<p>lowered band</p>
</blockquote>
</blockquote>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">VCode</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">Entry</span><span class="w"> </span><span class="n">block</span>: <span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="n">v130</span><span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="n">v135</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="mi">0</span>:
    <span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="n">IR</span><span class="w"> </span><span class="n">block</span>: <span class="nc">block0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="n">range</span>: <span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">0</span>: <span class="nc">args</span><span class="w"> </span><span class="o">%</span><span class="n">v128</span><span class="o">=%</span><span class="n">xmm0</span><span class="w"> </span><span class="o">%</span><span class="n">v129</span><span class="o">=%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">1</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v128</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v132l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">2</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v129</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v133l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">3</span>: <span class="nc">andl</span><span class="w">    </span><span class="o">%</span><span class="n">v132l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v133l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v134l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">4</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v134l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v135</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">5</span>: <span class="nc">movaps</span><span class="w">  </span><span class="o">%</span><span class="n">v130</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v131</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">6</span>: <span class="nc">movaps</span><span class="w">  </span><span class="o">%</span><span class="n">v131</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">xmm0</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">7</span>: <span class="nc">ret</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I think we need to make F32 and F64 to select Gpr instead of Xmm registers.</p>
</blockquote>



<a name="303176623"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234870%20Cranelift%3A%20simplify%20opcode%20set%20by%20.../near/303176623" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234870.20Cranelift.3A.20simplify.20opcode.20set.20by.20.2E.2E.2E.html#303176623">(Oct 09 2022 at 22:31)</a>:</h4>
<p>ArtBlnd edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4870#issuecomment-1272641657">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4870">issue #4870</a>:</p>
<blockquote>
<p>Ok. I am working on implementing float bitops on x86_64 currently. looks implementing bitwise operation using bitcasts results terrible.</p>
<blockquote>
<p>lowered band</p>
</blockquote>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">VCode</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">Entry</span><span class="w"> </span><span class="n">block</span>: <span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="n">v130</span><span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="n">v135</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="mi">0</span>:
    <span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="n">IR</span><span class="w"> </span><span class="n">block</span>: <span class="nc">block0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="n">range</span>: <span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">0</span>: <span class="nc">args</span><span class="w"> </span><span class="o">%</span><span class="n">v128</span><span class="o">=%</span><span class="n">xmm0</span><span class="w"> </span><span class="o">%</span><span class="n">v129</span><span class="o">=%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">1</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v128</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v132l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">2</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v129</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v133l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">3</span>: <span class="nc">andl</span><span class="w">    </span><span class="o">%</span><span class="n">v132l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v133l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v134l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">4</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v134l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v135</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">5</span>: <span class="nc">movaps</span><span class="w">  </span><span class="o">%</span><span class="n">v130</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v131</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">6</span>: <span class="nc">movaps</span><span class="w">  </span><span class="o">%</span><span class="n">v131</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">xmm0</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">7</span>: <span class="nc">ret</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I think we need to make F32 and F64 to select Gpr instead of Xmm registers.</p>
</blockquote>



<a name="303176701"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234870%20Cranelift%3A%20simplify%20opcode%20set%20by%20.../near/303176701" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234870.20Cranelift.3A.20simplify.20opcode.20set.20by.20.2E.2E.2E.html#303176701">(Oct 09 2022 at 22:32)</a>:</h4>
<p>ArtBlnd edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4870#issuecomment-1272641657">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4870">issue #4870</a>:</p>
<blockquote>
<p>Ok. I am working on implementing float bitops on x86_64 currently. looks implementing bitwise operation using bitcasts results terrible.</p>
<blockquote>
<p>lowered band</p>
</blockquote>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">VCode</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">Entry</span><span class="w"> </span><span class="n">block</span>: <span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="n">v130</span><span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="n">v135</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="mi">0</span>:
    <span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="n">IR</span><span class="w"> </span><span class="n">block</span>: <span class="nc">block0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="n">range</span>: <span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">0</span>: <span class="nc">args</span><span class="w"> </span><span class="o">%</span><span class="n">v128</span><span class="o">=%</span><span class="n">xmm0</span><span class="w"> </span><span class="o">%</span><span class="n">v129</span><span class="o">=%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">1</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v128</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v132l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">2</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v129</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v133l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">3</span>: <span class="nc">andl</span><span class="w">    </span><span class="o">%</span><span class="n">v132l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v133l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v134l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">4</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v134l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v135</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">5</span>: <span class="nc">movaps</span><span class="w">  </span><span class="o">%</span><span class="n">v130</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v131</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">6</span>: <span class="nc">movaps</span><span class="w">  </span><span class="o">%</span><span class="n">v131</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">xmm0</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">7</span>: <span class="nc">ret</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I think we need to make F32 and F64 to select Gpr instead of Xmm registers.<br>
Is this possible or should I make an optimization for scalar float memory ops?</p>
</blockquote>



<a name="303176876"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234870%20Cranelift%3A%20simplify%20opcode%20set%20by%20.../near/303176876" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234870.20Cranelift.3A.20simplify.20opcode.20set.20by.20.2E.2E.2E.html#303176876">(Oct 09 2022 at 22:37)</a>:</h4>
<p>ArtBlnd edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4870#issuecomment-1272641657">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4870">issue #4870</a>:</p>
<blockquote>
<p>Ok. I am working on implementing float bitops on x86_64 currently. looks implementing bitwise operation using bitcasts results terrible.</p>
<blockquote>
<p>lowered band</p>
</blockquote>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">VCode</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">Entry</span><span class="w"> </span><span class="n">block</span>: <span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="n">v130</span><span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="n">v135</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="mi">0</span>:
    <span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="n">IR</span><span class="w"> </span><span class="n">block</span>: <span class="nc">block0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="n">range</span>: <span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">0</span>: <span class="nc">args</span><span class="w"> </span><span class="o">%</span><span class="n">v128</span><span class="o">=%</span><span class="n">xmm0</span><span class="w"> </span><span class="o">%</span><span class="n">v129</span><span class="o">=%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">1</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v128</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v132l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">2</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v129</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v133l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">3</span>: <span class="nc">andl</span><span class="w">    </span><span class="o">%</span><span class="n">v132l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v133l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v134l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">4</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v134l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v135</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">5</span>: <span class="nc">movaps</span><span class="w">  </span><span class="o">%</span><span class="n">v130</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v131</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">6</span>: <span class="nc">movaps</span><span class="w">  </span><span class="o">%</span><span class="n">v131</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">xmm0</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">7</span>: <span class="nc">ret</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><del>I think we need to make F32 and F64 to select Gpr instead of Xmm registers.</del><br>
<del>Is this possible or should I make an optimization for scalar float memory ops?</del></p>
<p>Ok I think regalloc2 does not allocate Gpr for single F32, F64. I might need to make a custom lowering rule for bitwise ops.</p>
</blockquote>



<a name="303176878"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234870%20Cranelift%3A%20simplify%20opcode%20set%20by%20.../near/303176878" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234870.20Cranelift.3A.20simplify.20opcode.20set.20by.20.2E.2E.2E.html#303176878">(Oct 09 2022 at 22:37)</a>:</h4>
<p>ArtBlnd edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4870#issuecomment-1272641657">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4870">issue #4870</a>:</p>
<blockquote>
<p>Ok. I am working on implementing float bitops on x86_64 currently. looks implementing bitwise operation using bitcasts results terrible.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">VCode</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">Entry</span><span class="w"> </span><span class="n">block</span>: <span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="n">v130</span><span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="n">v135</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="mi">0</span>:
    <span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="n">IR</span><span class="w"> </span><span class="n">block</span>: <span class="nc">block0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="n">range</span>: <span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">0</span>: <span class="nc">args</span><span class="w"> </span><span class="o">%</span><span class="n">v128</span><span class="o">=%</span><span class="n">xmm0</span><span class="w"> </span><span class="o">%</span><span class="n">v129</span><span class="o">=%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">1</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v128</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v132l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">2</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v129</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v133l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">3</span>: <span class="nc">andl</span><span class="w">    </span><span class="o">%</span><span class="n">v132l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v133l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v134l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">4</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v134l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v135</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">5</span>: <span class="nc">movaps</span><span class="w">  </span><span class="o">%</span><span class="n">v130</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v131</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">6</span>: <span class="nc">movaps</span><span class="w">  </span><span class="o">%</span><span class="n">v131</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">xmm0</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">7</span>: <span class="nc">ret</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><del>I think we need to make F32 and F64 to select Gpr instead of Xmm registers.</del><br>
<del>Is this possible or should I make an optimization for scalar float memory ops?</del></p>
<p>Ok I think regalloc2 does not allocate Gpr for single F32, F64. I might need to make a custom lowering rule for bitwise ops.</p>
</blockquote>



<a name="303176885"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234870%20Cranelift%3A%20simplify%20opcode%20set%20by%20.../near/303176885" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234870.20Cranelift.3A.20simplify.20opcode.20set.20by.20.2E.2E.2E.html#303176885">(Oct 09 2022 at 22:37)</a>:</h4>
<p>ArtBlnd edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4870#issuecomment-1272641657">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4870">issue #4870</a>:</p>
<blockquote>
<p>Ok. I am working on implementing float bitops on x86_64 currently. looks implementing bitwise operation using bitcasts results terrible.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// function %band_f32(f32, f32) -&gt; f32 {</span>
<span class="c1">// block0(v0: f32, v1: f32):</span>
<span class="c1">//     v2 = band v0, v1</span>
<span class="c1">//     return v2</span>
<span class="c1">// }</span>
<span class="n">VCode</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">Entry</span><span class="w"> </span><span class="n">block</span>: <span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="n">v130</span><span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="n">v135</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="mi">0</span>:
    <span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="n">IR</span><span class="w"> </span><span class="n">block</span>: <span class="nc">block0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="n">range</span>: <span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">0</span>: <span class="nc">args</span><span class="w"> </span><span class="o">%</span><span class="n">v128</span><span class="o">=%</span><span class="n">xmm0</span><span class="w"> </span><span class="o">%</span><span class="n">v129</span><span class="o">=%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">1</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v128</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v132l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">2</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v129</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v133l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">3</span>: <span class="nc">andl</span><span class="w">    </span><span class="o">%</span><span class="n">v132l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v133l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v134l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">4</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v134l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v135</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">5</span>: <span class="nc">movaps</span><span class="w">  </span><span class="o">%</span><span class="n">v130</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v131</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">6</span>: <span class="nc">movaps</span><span class="w">  </span><span class="o">%</span><span class="n">v131</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">xmm0</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">7</span>: <span class="nc">ret</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><del>I think we need to make F32 and F64 to select Gpr instead of Xmm registers.</del><br>
<del>Is this possible or should I make an optimization for scalar float memory ops?</del></p>
<p>Ok I think regalloc2 does not allocate Gpr for single F32, F64. I might need to make a custom lowering rule for bitwise ops.</p>
</blockquote>



<a name="303176887"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234870%20Cranelift%3A%20simplify%20opcode%20set%20by%20.../near/303176887" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234870.20Cranelift.3A.20simplify.20opcode.20set.20by.20.2E.2E.2E.html#303176887">(Oct 09 2022 at 22:37)</a>:</h4>
<p>ArtBlnd edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4870#issuecomment-1272641657">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4870">issue #4870</a>:</p>
<blockquote>
<p>Ok. I am working on implementing float bitops on x86_64 currently. looks implementing bitwise operation using bitcasts results terrible.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// function %band_f32(f32, f32) -&gt; f32 {</span>
<span class="c1">// block0(v0: f32, v1: f32):</span>
<span class="c1">//     v2 = band v0, v1</span>
<span class="c1">//     return v2</span>
<span class="c1">// }</span>

<span class="n">VCode</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">Entry</span><span class="w"> </span><span class="n">block</span>: <span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="n">v130</span><span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="n">v135</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="mi">0</span>:
    <span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="n">IR</span><span class="w"> </span><span class="n">block</span>: <span class="nc">block0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="n">range</span>: <span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">0</span>: <span class="nc">args</span><span class="w"> </span><span class="o">%</span><span class="n">v128</span><span class="o">=%</span><span class="n">xmm0</span><span class="w"> </span><span class="o">%</span><span class="n">v129</span><span class="o">=%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">1</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v128</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v132l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">2</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v129</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v133l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">3</span>: <span class="nc">andl</span><span class="w">    </span><span class="o">%</span><span class="n">v132l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v133l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v134l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">4</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v134l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v135</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">5</span>: <span class="nc">movaps</span><span class="w">  </span><span class="o">%</span><span class="n">v130</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v131</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">6</span>: <span class="nc">movaps</span><span class="w">  </span><span class="o">%</span><span class="n">v131</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">xmm0</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">7</span>: <span class="nc">ret</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><del>I think we need to make F32 and F64 to select Gpr instead of Xmm registers.</del><br>
<del>Is this possible or should I make an optimization for scalar float memory ops?</del></p>
<p>Ok I think regalloc2 does not allocate Gpr for single F32, F64. I might need to make a custom lowering rule for bitwise ops.</p>
</blockquote>



<a name="303177048"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234870%20Cranelift%3A%20simplify%20opcode%20set%20by%20.../near/303177048" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234870.20Cranelift.3A.20simplify.20opcode.20set.20by.20.2E.2E.2E.html#303177048">(Oct 09 2022 at 22:40)</a>:</h4>
<p>ArtBlnd edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4870#issuecomment-1272641657">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4870">issue #4870</a>:</p>
<blockquote>
<p>Ok. I am working on implementing float bitops on x86_64 currently. looks implementing bitwise operation using bitcasts results terrible.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// function %band_f32(f32, f32) -&gt; f32 {</span>
<span class="c1">// block0(v0: f32, v1: f32):</span>
<span class="c1">//     v2 = band v0, v1</span>
<span class="c1">//     return v2</span>
<span class="c1">// }</span>

<span class="n">VCode</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">Entry</span><span class="w"> </span><span class="n">block</span>: <span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="n">v130</span><span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="n">v135</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="mi">0</span>:
    <span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="n">IR</span><span class="w"> </span><span class="n">block</span>: <span class="nc">block0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="n">range</span>: <span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">0</span>: <span class="nc">args</span><span class="w"> </span><span class="o">%</span><span class="n">v128</span><span class="o">=%</span><span class="n">xmm0</span><span class="w"> </span><span class="o">%</span><span class="n">v129</span><span class="o">=%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">1</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v128</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v132l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">2</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v129</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v133l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">3</span>: <span class="nc">andl</span><span class="w">    </span><span class="o">%</span><span class="n">v132l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v133l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v134l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">4</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v134l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v135</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">5</span>: <span class="nc">movaps</span><span class="w">  </span><span class="o">%</span><span class="n">v130</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v131</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">6</span>: <span class="nc">movaps</span><span class="w">  </span><span class="o">%</span><span class="n">v131</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">xmm0</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">7</span>: <span class="nc">ret</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><del>I think we need to make F32 and F64 to select Gpr instead of Xmm registers.</del><br>
<del>Is this possible or should I make an optimization for scalar float memory ops?</del></p>
<p>Ok I think regalloc2 does not allocate Gpr for single F32, F64. I might need to make a custom transform layer for float bitwise ops.</p>
</blockquote>



<a name="303177218"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234870%20Cranelift%3A%20simplify%20opcode%20set%20by%20.../near/303177218" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234870.20Cranelift.3A.20simplify.20opcode.20set.20by.20.2E.2E.2E.html#303177218">(Oct 09 2022 at 22:44)</a>:</h4>
<p>ArtBlnd edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4870#issuecomment-1272641657">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4870">issue #4870</a>:</p>
<blockquote>
<p>Ok. I am working on implementing float bitops on x86_64 currently. looks implementing bitwise operation using bitcasts results terrible.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// function %band_f32(f32, f32) -&gt; f32 {</span>
<span class="c1">// block0(v0: f32, v1: f32):</span>
<span class="c1">//     v2 = band v0, v1</span>
<span class="c1">//     return v2</span>
<span class="c1">// }</span>

<span class="n">VCode</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">Entry</span><span class="w"> </span><span class="n">block</span>: <span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="n">v130</span><span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="n">v135</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="mi">0</span>:
    <span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="n">IR</span><span class="w"> </span><span class="n">block</span>: <span class="nc">block0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="n">range</span>: <span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">0</span>: <span class="nc">args</span><span class="w"> </span><span class="o">%</span><span class="n">v128</span><span class="o">=%</span><span class="n">xmm0</span><span class="w"> </span><span class="o">%</span><span class="n">v129</span><span class="o">=%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">1</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v128</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v132l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">2</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v129</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v133l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">3</span>: <span class="nc">andl</span><span class="w">    </span><span class="o">%</span><span class="n">v132l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v133l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v134l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">4</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v134l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v135</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">5</span>: <span class="nc">movaps</span><span class="w">  </span><span class="o">%</span><span class="n">v130</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v131</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">6</span>: <span class="nc">movaps</span><span class="w">  </span><span class="o">%</span><span class="n">v131</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">xmm0</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">7</span>: <span class="nc">ret</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><del>I think we need to make F32 and F64 to select Gpr instead of Xmm registers.</del><br>
<del>Is this possible or should I make an optimization for scalar float memory ops?</del></p>
<p>Ok nvm. I think I just need lower XMM bitops on scalar bitops.</p>
</blockquote>



<a name="303178478"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234870%20Cranelift%3A%20simplify%20opcode%20set%20by%20.../near/303178478" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234870.20Cranelift.3A.20simplify.20opcode.20set.20by.20.2E.2E.2E.html#303178478">(Oct 09 2022 at 23:08)</a>:</h4>
<p>ArtBlnd edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4870#issuecomment-1272641657">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4870">issue #4870</a>:</p>
<blockquote>
<p>Ok. I am working on implementing float bitops on x86_64 currently. looks implementing bitwise operation using bitcasts results terrible.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// function %band_f32(f32, f32) -&gt; f32 {</span>
<span class="c1">// block0(v0: f32, v1: f32):</span>
<span class="c1">//     v2 = band v0, v1</span>
<span class="c1">//     return v2</span>
<span class="c1">// }</span>

<span class="n">VCode</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">Entry</span><span class="w"> </span><span class="n">block</span>: <span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="n">v130</span><span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="n">v135</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="mi">0</span>:
    <span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="n">IR</span><span class="w"> </span><span class="n">block</span>: <span class="nc">block0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="n">range</span>: <span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">0</span>: <span class="nc">args</span><span class="w"> </span><span class="o">%</span><span class="n">v128</span><span class="o">=%</span><span class="n">xmm0</span><span class="w"> </span><span class="o">%</span><span class="n">v129</span><span class="o">=%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">1</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v128</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v132l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">2</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v129</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v133l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">3</span>: <span class="nc">andl</span><span class="w">    </span><span class="o">%</span><span class="n">v132l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v133l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v134l</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">4</span>: <span class="nc">movd</span><span class="w">    </span><span class="o">%</span><span class="n">v134l</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v135</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">5</span>: <span class="nc">movaps</span><span class="w">  </span><span class="o">%</span><span class="n">v130</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v131</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">6</span>: <span class="nc">movaps</span><span class="w">  </span><span class="o">%</span><span class="n">v131</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">xmm0</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">7</span>: <span class="nc">ret</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><del>I think we need to make F32 and F64 to select Gpr instead of Xmm registers.</del><br>
<del>Is this possible or should I make an optimization for scalar float memory ops?</del></p>
<p>Ok nvm. I think I just need lower scalar bitops to XMM bitops</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>