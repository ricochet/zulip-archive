<html>
<head><meta charset="utf-8"><title>wasmtime / issue #8730 Object files can only be linked wi... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238730.20Object.20files.20can.20only.20be.20linked.20wi.2E.2E.2E.html">wasmtime / issue #8730 Object files can only be linked wi...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="441919793"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238730%20Object%20files%20can%20only%20be%20linked%20wi.../near/441919793" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238730.20Object.20files.20can.20only.20be.20linked.20wi.2E.2E.2E.html#441919793">(Jun 01 2024 at 15:25)</a>:</h4>
<p>sezna opened <a href="https://github.com/bytecodealliance/wasmtime/issues/8730">issue #8730</a>:</p>
<blockquote>
<p>Hello, thank you very much for all of the incredible software y'all are writing. I'm currently using Cranelift to generate native binaries for my project, and I'm continually impressed at the level of detail and effort that goes into these things. Not to mention the super helpful Zulip chat.</p>
<p>In the aforementioned chat, I was receiving help from @bjorn3 and @cfallin on generating executables for an Apple silicon Mac. The following code does not successfully execute on an M-series processor Mac: <a href="https://gist.github.com/sezna/e358a9167d4ef3063f6cfe4ce4c2ad37">https://gist.github.com/sezna/e358a9167d4ef3063f6cfe4ce4c2ad37</a></p>
<p>Using the legacy linker, that is, adding <code>-Wl -ld_classic</code> to the clang invocation, _does_ work. However, as the legacy linker will likely be going away someday, I'm filing this issue in the hopes that we can figure out why it doesn't work with the current linker. Note that <code>cg_clif</code> also uses <code>-Wl -ld_classic</code>, so when the legacy linker is dropped, <code>cg_clif</code> could also have issues.</p>
</blockquote>



<a name="441996496"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238730%20Object%20files%20can%20only%20be%20linked%20wi.../near/441996496" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238730.20Object.20files.20can.20only.20be.20linked.20wi.2E.2E.2E.html#441996496">(Jun 02 2024 at 02:28)</a>:</h4>
<p>philipc <a href="https://github.com/bytecodealliance/wasmtime/issues/8730#issuecomment-2143671958">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8730">issue #8730</a>:</p>
<blockquote>
<p>I've reproduced the issue with arm64. If I change to use x86_64 it works with either linker.</p>
<p>The linker error is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">0</span><span class="w">  </span><span class="mh">0x100fa2f2c</span><span class="w">  </span><span class="n">__assert_rtn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">72</span>
<span class="mi">1</span><span class="w">  </span><span class="mh">0x100ee9ec4</span><span class="w">  </span><span class="n">ld</span><span class="p">::</span><span class="n">InputFiles</span><span class="p">::</span><span class="n">SliceParser</span><span class="p">::</span><span class="n">parseObjectFile</span><span class="p">(</span><span class="n">mach_o</span><span class="p">::</span><span class="n">Header</span><span class="w"> </span><span class="k">const</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">22976</span>
<span class="mi">2</span><span class="w">  </span><span class="mh">0x100ef6404</span><span class="w">  </span><span class="n">ld</span><span class="p">::</span><span class="n">InputFiles</span><span class="p">::</span><span class="n">parseAllFiles</span><span class="p">(</span><span class="n">void</span><span class="w"> </span><span class="p">(</span><span class="n">ld</span><span class="p">::</span><span class="n">AtomFile</span><span class="w"> </span><span class="k">const</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">block_pointer</span><span class="p">)::</span><span class="cp">$_7</span><span class="p">::</span><span class="n">operator</span><span class="p">()(</span><span class="n">unsigned</span><span class="w"> </span><span class="n">long</span><span class="p">,</span><span class="w"> </span><span class="n">ld</span><span class="p">::</span><span class="n">FileInfo</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">420</span>
<span class="mi">3</span><span class="w">  </span><span class="mh">0x1975dc440</span><span class="w">  </span><span class="n">_dispatch_client_callout2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">20</span>
<span class="mi">4</span><span class="w">  </span><span class="mh">0x1975f1544</span><span class="w">  </span><span class="n">_dispatch_apply_invoke_and_wait</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">224</span>
<span class="mi">5</span><span class="w">  </span><span class="mh">0x1975f084c</span><span class="w">  </span><span class="n">_dispatch_apply_with_attr_f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1180</span>
<span class="mi">6</span><span class="w">  </span><span class="mh">0x1975f0a38</span><span class="w">  </span><span class="n">dispatch_apply</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">96</span>
<span class="mi">7</span><span class="w">  </span><span class="mh">0x100f741e0</span><span class="w">  </span><span class="n">ld</span><span class="p">::</span><span class="n">AtomFileConsolidator</span><span class="p">::</span><span class="n">parseFiles</span><span class="p">(</span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">292</span>
<span class="mi">8</span><span class="w">  </span><span class="mh">0x100f12b08</span><span class="w">  </span><span class="n">main</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">9252</span>
<span class="n">ld</span><span class="p">:</span><span class="w"> </span><span class="nc">Assertion</span><span class="w"> </span><span class="n">failed</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">pattern</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addrMode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">addr_other</span><span class="p">),</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">addFixupFromRelocations</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">Relocations</span><span class="p">.</span><span class="n">cpp</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="mf">700.</span>
<span class="n">clang</span><span class="p">:</span><span class="w"> </span><span class="nc">error</span><span class="p">:</span><span class="w"> </span><span class="nc">linker</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">exit</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="k">use</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">see</span><span class="w"> </span><span class="n">invocation</span><span class="p">)</span>
</code></pre></div>
<p>clang generates relocations like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">      </span><span class="mi">18</span><span class="p">:</span><span class="w"> </span><span class="mi">90000000</span><span class="w">      </span><span class="n">adrp</span><span class="w">    </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="w"> </span><span class="o">&lt;</span><span class="n">ltmp0</span><span class="o">+</span><span class="mh">0x18</span><span class="o">&gt;</span>
<span class="w">        </span><span class="mi">0000000000000018</span><span class="p">:</span><span class="w">  </span><span class="nc">ARM64_RELOC_PAGE21</span><span class="w">   </span><span class="n">l_</span><span class="p">.</span><span class="kt">str</span>
<span class="w">      </span><span class="mi">1</span><span class="n">c</span><span class="p">:</span><span class="w"> </span><span class="mi">91000000</span><span class="w">      </span><span class="n">add</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="p">#</span><span class="mi">0</span>
<span class="w">        </span><span class="mi">000000000000001</span><span class="n">c</span><span class="p">:</span><span class="w">  </span><span class="nc">ARM64_RELOC_PAGEOFF12</span><span class="w">    </span><span class="n">l_</span><span class="p">.</span><span class="kt">str</span>
<span class="w">      </span><span class="mi">20</span><span class="p">:</span><span class="w"> </span><span class="mi">94000000</span><span class="w">      </span><span class="n">bl</span><span class="w">  </span><span class="mh">0x20</span><span class="w"> </span><span class="o">&lt;</span><span class="n">ltmp0</span><span class="o">+</span><span class="mh">0x20</span><span class="o">&gt;</span>
<span class="w">        </span><span class="mi">0000000000000020</span><span class="p">:</span><span class="w">  </span><span class="nc">ARM64_RELOC_BRANCH26</span><span class="w"> </span><span class="n">_puts</span>
</code></pre></div>
<p>cranelift generates:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">      </span><span class="mi">1</span><span class="n">c</span><span class="p">:</span><span class="w"> </span><span class="mi">90000000</span><span class="w">      </span><span class="n">adrp</span><span class="w">    </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_main</span><span class="o">+</span><span class="mh">0xc</span><span class="o">&gt;</span>
<span class="w">        </span><span class="mi">000000000000001</span><span class="n">c</span><span class="p">:</span><span class="w">  </span><span class="nc">ARM64_RELOC_GOT_LOAD_PAGE21</span><span class="w">  </span><span class="n">_hello_world</span>
<span class="w">      </span><span class="mi">20</span><span class="p">:</span><span class="w"> </span><span class="nc">f9400000</span><span class="w">      </span><span class="n">ldr</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">x0</span><span class="p">]</span>
<span class="w">        </span><span class="mi">0000000000000020</span><span class="p">:</span><span class="w">  </span><span class="nc">ARM64_RELOC_GOT_LOAD_PAGEOFF12</span><span class="w">   </span><span class="n">_hello_world</span>
<span class="w">      </span><span class="mi">24</span><span class="p">:</span><span class="w"> </span><span class="mi">90000002</span><span class="w">      </span><span class="n">adrp</span><span class="w">    </span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_main</span><span class="o">+</span><span class="mh">0x14</span><span class="o">&gt;</span>
<span class="w">        </span><span class="mi">0000000000000024</span><span class="p">:</span><span class="w">  </span><span class="nc">ARM64_RELOC_GOT_LOAD_PAGE21</span><span class="w">  </span><span class="n">_puts</span>
<span class="w">      </span><span class="mi">28</span><span class="p">:</span><span class="w"> </span><span class="nc">f9400042</span><span class="w">      </span><span class="n">ldr</span><span class="w"> </span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">x2</span><span class="p">]</span>
<span class="w">        </span><span class="mi">0000000000000028</span><span class="p">:</span><span class="w">  </span><span class="nc">ARM64_RELOC_GOT_LOAD_PAGEOFF12</span><span class="w">   </span><span class="n">_puts</span>
<span class="w">      </span><span class="mi">2</span><span class="n">c</span><span class="p">:</span><span class="w"> </span><span class="nc">d63f0040</span><span class="w">      </span><span class="n">blr</span><span class="w"> </span><span class="n">x2</span>
</code></pre></div>
<p>If I hack cranelift to generate this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">      </span><span class="mi">1</span><span class="n">c</span><span class="p">:</span><span class="w"> </span><span class="mi">90000000</span><span class="w">      </span><span class="n">adrp</span><span class="w">    </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_main</span><span class="o">+</span><span class="mh">0xc</span><span class="o">&gt;</span>
<span class="w">        </span><span class="mi">000000000000001</span><span class="n">c</span><span class="p">:</span><span class="w">  </span><span class="nc">ARM64_RELOC_PAGE21</span><span class="w">   </span><span class="n">_hello_world</span>
<span class="w">      </span><span class="mi">20</span><span class="p">:</span><span class="w"> </span><span class="mi">91000000</span><span class="w">      </span><span class="n">add</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="p">#</span><span class="mi">0</span>
<span class="w">        </span><span class="mi">0000000000000020</span><span class="p">:</span><span class="w">  </span><span class="nc">ARM64_RELOC_PAGEOFF12</span><span class="w">    </span><span class="n">_hello_world</span>
<span class="w">      </span><span class="mi">24</span><span class="p">:</span><span class="w"> </span><span class="mi">90000002</span><span class="w">      </span><span class="n">adrp</span><span class="w">    </span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_main</span><span class="o">+</span><span class="mh">0x14</span><span class="o">&gt;</span>
<span class="w">        </span><span class="mi">0000000000000024</span><span class="p">:</span><span class="w">  </span><span class="nc">ARM64_RELOC_PAGE21</span><span class="w">   </span><span class="n">_puts</span>
<span class="w">      </span><span class="mi">28</span><span class="p">:</span><span class="w"> </span><span class="mi">91000042</span><span class="w">      </span><span class="n">add</span><span class="w"> </span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="p">#</span><span class="mi">0</span>
<span class="w">        </span><span class="mi">0000000000000028</span><span class="p">:</span><span class="w">  </span><span class="nc">ARM64_RELOC_PAGEOFF12</span><span class="w">    </span><span class="n">_puts</span>
<span class="w">      </span><span class="mi">2</span><span class="n">c</span><span class="p">:</span><span class="w"> </span><span class="nc">d63f0040</span><span class="w">      </span><span class="n">blr</span><span class="w"> </span><span class="n">x2</span>
</code></pre></div>
<p>then the linker error changes to:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">ld</span><span class="p">:</span><span class="w"> </span><span class="nc">invalid</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">ADRP</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">'</span><span class="nb">_</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="o">'</span><span class="nb">_</span><span class="na">puts</span><span class="o">'</span>
</code></pre></div>
<p>If I hack cranelift to generate this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">      </span><span class="mi">1</span><span class="n">c</span><span class="p">:</span><span class="w"> </span><span class="mi">90000000</span><span class="w">      </span><span class="n">adrp</span><span class="w">    </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_main</span><span class="o">+</span><span class="mh">0xc</span><span class="o">&gt;</span>
<span class="w">        </span><span class="mi">000000000000001</span><span class="n">c</span><span class="p">:</span><span class="w">  </span><span class="nc">ARM64_RELOC_PAGE21</span><span class="w">   </span><span class="n">_hello_world</span>
<span class="w">      </span><span class="mi">20</span><span class="p">:</span><span class="w"> </span><span class="mi">91000000</span><span class="w">      </span><span class="n">add</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="p">#</span><span class="mi">0</span>
<span class="w">        </span><span class="mi">0000000000000020</span><span class="p">:</span><span class="w">  </span><span class="nc">ARM64_RELOC_PAGEOFF12</span><span class="w">    </span><span class="n">_hello_world</span>
<span class="w">      </span><span class="mi">24</span><span class="p">:</span><span class="w"> </span><span class="mi">94000000</span><span class="w">      </span><span class="n">bl</span><span class="w">  </span><span class="mh">0x24</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_main</span><span class="o">+</span><span class="mh">0x14</span><span class="o">&gt;</span>
<span class="w">        </span><span class="mi">0000000000000024</span><span class="p">:</span><span class="w">  </span><span class="nc">ARM64_RELOC_BRANCH26</span><span class="w"> </span><span class="n">_puts</span>
</code></pre></div>
<p>then it links and runs successfully.</p>
<p>Complete hack:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/cranelift/codegen/src/isa/aarch64/abi.rs b/cranelift/codegen/src/isa/aarch64/abi.rs</span>
<span class="gh">index 922e4ebfc..ea0bc22f3 100644</span>
<span class="gd">--- a/cranelift/codegen/src/isa/aarch64/abi.rs</span>
<span class="gi">+++ b/cranelift/codegen/src/isa/aarch64/abi.rs</span>
<span class="gu">@@ -1027,7 +1027,8 @@ impl ABIMachineSpec for AArch64MachineDeps {</span>
<span class="w"> </span>    ) -&gt; SmallVec&lt;[Inst; 2]&gt; {
<span class="w"> </span>        let mut insts = SmallVec::new();
<span class="w"> </span>        match &amp;dest {
<span class="gd">-            &amp;CallDest::ExtName(ref name, RelocDistance::Near) =&gt; insts.push(Inst::Call {</span>
<span class="gi">+            //&amp;CallDest::ExtName(ref name, RelocDistance::Near) =&gt; insts.push(Inst::Call {</span>
<span class="gi">+            &amp;CallDest::ExtName(ref name, _) =&gt; insts.push(Inst::Call {</span>
<span class="w"> </span>                info: Box::new(CallInfo {
<span class="w"> </span>                    dest: name.clone(),
<span class="w"> </span>                    uses,
<span class="gu">@@ -1039,6 +1040,7 @@ impl ABIMachineSpec for AArch64MachineDeps {</span>
<span class="w"> </span>                    callee_pop_size,
<span class="w"> </span>                }),
<span class="w"> </span>            }),
<span class="gi">+/*</span>
<span class="w"> </span>            &amp;CallDest::ExtName(ref name, RelocDistance::Far) =&gt; {
<span class="w"> </span>                insts.push(Inst::LoadExtName {
<span class="w"> </span>                    rd: tmp,
<span class="gu">@@ -1058,6 +1060,7 @@ impl ABIMachineSpec for AArch64MachineDeps {</span>
<span class="w"> </span>                    }),
<span class="w"> </span>                });
<span class="w"> </span>            }
<span class="gi">+*/</span>
<span class="w"> </span>            &amp;CallDest::Reg(reg) =&gt; insts.push(Inst::CallInd {
<span class="w"> </span>                info: Box::new(CallIndInfo {
<span class="w"> </span>                    rn: *reg,
<span class="gh">diff --git a/cranelift/codegen/src/isa/aarch64/inst/emit.rs b/cranelift/codegen/src/isa/aarch64/inst/emit.rs</span>
<span class="gh">index f9df1a8d2..0f89903a4 100644</span>
<span class="gd">--- a/cranelift/codegen/src/isa/aarch64/inst/emit.rs</span>
<span class="gi">+++ b/cranelift/codegen/src/isa/aarch64/inst/emit.rs</span>
<span class="gu">@@ -3177,6 +3177,7 @@ impl MachInstEmit for Inst {</span>
<span class="w"> </span>                    let inst = Inst::Adrp { rd, off: 0 };
<span class="w"> </span>                    inst.emit(sink, emit_info, state);

<span class="gi">+/*</span>
<span class="w"> </span>                    // ldr rd, [rd, :got_lo12:X]
<span class="w"> </span>                    sink.add_reloc(Reloc::Aarch64Ld64GotLo12Nc, &amp;**name, 0);
<span class="w"> </span>                    let inst = Inst::ULoad64 {
<span class="gu">@@ -3185,6 +3186,17 @@ impl MachInstEmit for Inst {</span>
<span class="w"> </span>                        flags: MemFlags::trusted(),
<span class="w"> </span>                    };
<span class="w"> </span>                    inst.emit(sink, emit_info, state);
<span class="gi">+*/</span>
<span class="gi">+                    // add rd, rd, :lo12:X</span>
<span class="gi">+                    sink.add_reloc(Reloc::Aarch64Ld64GotLo12Nc, &amp;**name, 0);</span>
<span class="gi">+                    Inst::AluRRImm12 {</span>
<span class="gi">+                        alu_op: ALUOp::Add,</span>
<span class="gi">+                        size: OperandSize::Size64,</span>
<span class="gi">+                        rd,</span>
<span class="gi">+                        rn: rd.to_reg(),</span>
<span class="gi">+                        imm12: Imm12::maybe_from_u64(0).unwrap(),</span>
<span class="gi">+                    }</span>
<span class="gi">+                    .emit(sink, emit_info, state);</span>
<span class="w"> </span>                } else {
<span class="w"> </span>                    // With absolute offsets we set up a load from a preallocated space, and then jump
<span class="w"> </span>                    // over it.
<span class="gh">diff --git a/cranelift/object/src/backend.rs b/cranelift/object/src/backend.rs</span>
<span class="gh">index 2d48e9b61..921c5273e 100644</span>
<span class="gd">--- a/cranelift/object/src/backend.rs</span>
<span class="gi">+++ b/cranelift/object/src/backend.rs</span>
<span class="gu">@@ -764,7 +764,8 @@ impl ObjectModule {</span>
<span class="w"> </span>                    r_type: object::elf::R_AARCH64_ADR_GOT_PAGE,
<span class="w"> </span>                },
<span class="w"> </span>                object::BinaryFormat::MachO =&gt; RelocationFlags::MachO {
<span class="gd">-                    r_type: object::macho::ARM64_RELOC_GOT_LOAD_PAGE21,</span>
<span class="gi">+                    //r_type: object::macho::ARM64_RELOC_GOT_LOAD_PAGE21,</span>
<span class="gi">+                    r_type: object::macho::ARM64_RELOC_PAGE21,</span>
<span class="w"> </span>                    r_pcrel: true,
<span class="w"> </span>                    r_length: 2,
<span class="w"> </span>                },
<span class="gu">@@ -775,7 +776,8 @@ impl ObjectModule {</span>
<span class="w"> </span>                    r_type: object::elf::R_AARCH64_LD64_GOT_LO12_NC,
<span class="w"> </span>                },
<span class="w"> </span>                object::BinaryFormat::MachO =&gt; RelocationFlags::MachO {
<span class="gd">-                    r_type: object::macho::ARM64_RELOC_GOT_LOAD_PAGEOFF12,</span>
<span class="gi">+                    //r_type: object::macho::ARM64_RELOC_GOT_LOAD_PAGEOFF12,</span>
<span class="gi">+                    r_type: object::macho::ARM64_RELOC_PAGEOFF12,</span>
<span class="w"> </span>                    r_pcrel: false,
<span class="w"> </span>                    r_length: 2,
<span class="w"> </span>                },
</code></pre></div>
<p>So it appears that cranelift isn't generating the correct relocations for ARM64 on macOS. I'll let those who know more about this stuff fix it properly.</p>
</blockquote>



<a name="447470130"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238730%20Object%20files%20can%20only%20be%20linked%20wi.../near/447470130" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238730.20Object.20files.20can.20only.20be.20linked.20wi.2E.2E.2E.html#447470130">(Jun 27 2024 at 12:51)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/8730#issuecomment-2194596360">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8730">issue #8730</a>:</p>
<blockquote>
<p>A simple</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[inline(never)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">foo</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">unsafe</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;'</span><span class="nb">static</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">bar</span><span class="p">();</span><span class="w"> </span><span class="p">(</span><span class="n">bar</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">FOO</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">bar</span><span class="p">();</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">FOO</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>produces</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">rust_out</span><span class="p">.</span><span class="n">o</span><span class="p">:</span><span class="w">     </span><span class="nc">file</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">mach</span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">arm64</span>

<span class="n">Disassembly</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="n">__TEXT</span><span class="p">,</span><span class="n">__text</span><span class="p">:</span>

<span class="mi">0000000000000000</span><span class="w"> </span><span class="o">&lt;</span><span class="n">ltmp0</span><span class="o">&gt;</span><span class="p">:</span>
<span class="w">       </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="nc">a9bf7bfd</span><span class="w">      </span><span class="n">stp</span><span class="w">     </span><span class="n">x29</span><span class="p">,</span><span class="w"> </span><span class="n">x30</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="p">#</span><span class="o">-</span><span class="mi">16</span><span class="p">]</span><span class="o">!</span>
<span class="w">       </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="mi">910003</span><span class="n">fd</span><span class="w">      </span><span class="n">mov</span><span class="w">     </span><span class="n">x29</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<span class="w">       </span><span class="mi">8</span><span class="p">:</span><span class="w"> </span><span class="mi">94000000</span><span class="w">      </span><span class="n">bl</span><span class="w">      </span><span class="mh">0x8</span><span class="w"> </span><span class="o">&lt;</span><span class="n">ltmp0</span><span class="o">+</span><span class="mh">0x8</span><span class="o">&gt;</span>
<span class="w">                </span><span class="mi">0000000000000008</span><span class="p">:</span><span class="w">  </span><span class="nc">ARM64_RELOC_BRANCH26</span><span class="w"> </span><span class="n">_bar</span>
<span class="w">       </span><span class="n">c</span><span class="p">:</span><span class="w"> </span><span class="mi">90000000</span><span class="w">      </span><span class="n">adrp</span><span class="w">    </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="w"> </span><span class="o">&lt;</span><span class="n">ltmp0</span><span class="o">+</span><span class="mh">0xc</span><span class="o">&gt;</span>
<span class="w">                </span><span class="mi">000000000000000</span><span class="n">c</span><span class="p">:</span><span class="w">  </span><span class="nc">ARM64_RELOC_GOT_LOAD_PAGE21</span><span class="w">  </span><span class="n">_bar</span>
<span class="w">      </span><span class="mi">10</span><span class="p">:</span><span class="w"> </span><span class="nc">f9400000</span><span class="w">      </span><span class="n">ldr</span><span class="w">     </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">x0</span><span class="p">]</span>
<span class="w">                </span><span class="mi">0000000000000010</span><span class="p">:</span><span class="w">  </span><span class="nc">ARM64_RELOC_GOT_LOAD_PAGEOFF12</span><span class="w">       </span><span class="n">_bar</span>
<span class="w">      </span><span class="mi">14</span><span class="p">:</span><span class="w"> </span><span class="mi">90000001</span><span class="w">      </span><span class="n">adrp</span><span class="w">    </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="w"> </span><span class="o">&lt;</span><span class="n">ltmp0</span><span class="o">+</span><span class="mh">0x14</span><span class="o">&gt;</span>
<span class="w">                </span><span class="mi">0000000000000014</span><span class="p">:</span><span class="w">  </span><span class="nc">ARM64_RELOC_GOT_LOAD_PAGE21</span><span class="w">  </span><span class="n">_FOO</span>
<span class="w">      </span><span class="mi">18</span><span class="p">:</span><span class="w"> </span><span class="nc">f9400021</span><span class="w">      </span><span class="n">ldr</span><span class="w">     </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">x1</span><span class="p">]</span>
<span class="w">                </span><span class="mi">0000000000000018</span><span class="p">:</span><span class="w">  </span><span class="nc">ARM64_RELOC_GOT_LOAD_PAGEOFF12</span><span class="w">       </span><span class="n">_FOO</span>
<span class="w">      </span><span class="mi">1</span><span class="n">c</span><span class="p">:</span><span class="w"> </span><span class="nc">a8c17bfd</span><span class="w">      </span><span class="n">ldp</span><span class="w">     </span><span class="n">x29</span><span class="p">,</span><span class="w"> </span><span class="n">x30</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">sp</span><span class="p">],</span><span class="w"> </span><span class="p">#</span><span class="mi">16</span>
<span class="w">      </span><span class="mi">20</span><span class="p">:</span><span class="w"> </span><span class="nc">d65f03c0</span><span class="w">      </span><span class="n">ret</span>
</code></pre></div>
<p>with the LLVM backend. If I try to link it I get a linker error as expected:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Undefined</span><span class="w"> </span><span class="n">symbols</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">architecture</span><span class="w"> </span><span class="n">arm64</span><span class="p">:</span>
<span class="w">  </span><span class="s">"_FOO"</span><span class="p">,</span><span class="w"> </span><span class="n">referenced</span><span class="w"> </span><span class="n">from</span><span class="p">:</span>
<span class="w">      </span><span class="nc">rust_out</span><span class="p">::</span><span class="n">foo</span><span class="p">::</span><span class="n">he5a9b1ed9cb33bc0</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">rust_out</span><span class="p">.</span><span class="n">o</span>
<span class="w">  </span><span class="s">"_bar"</span><span class="p">,</span><span class="w"> </span><span class="n">referenced</span><span class="w"> </span><span class="n">from</span><span class="p">:</span>
<span class="w">      </span><span class="nc">rust_out</span><span class="p">::</span><span class="n">foo</span><span class="p">::</span><span class="n">he5a9b1ed9cb33bc0</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">rust_out</span><span class="p">.</span><span class="n">o</span>
<span class="w">      </span><span class="n">rust_out</span><span class="p">::</span><span class="n">foo</span><span class="p">::</span><span class="n">he5a9b1ed9cb33bc0</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">rust_out</span><span class="p">.</span><span class="n">o</span>
<span class="w">  </span><span class="s">"_main"</span><span class="p">,</span><span class="w"> </span><span class="n">referenced</span><span class="w"> </span><span class="n">from</span><span class="p">:</span>
<span class="w">      </span><span class="o">&lt;</span><span class="n">initial</span><span class="o">-</span><span class="n">undefines</span><span class="o">&gt;</span>
<span class="n">ld</span><span class="p">:</span><span class="w"> </span><span class="nc">symbol</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">architecture</span><span class="w"> </span><span class="n">arm64</span>
</code></pre></div>
<p>If I apply the following patch to Cranelift:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/cranelift/codegen/src/isa/aarch64/abi.rs b/cranelift/codegen/src/isa/aarch64/abi.rs</span>
<span class="gh">index 922e4ebfc..6d43c1db6 100644</span>
<span class="gd">--- a/cranelift/codegen/src/isa/aarch64/abi.rs</span>
<span class="gi">+++ b/cranelift/codegen/src/isa/aarch64/abi.rs</span>
<span class="gu">@@ -1027,7 +1027,7 @@ impl ABIMachineSpec for AArch64MachineDeps {</span>
<span class="w"> </span>    ) -&gt; SmallVec&lt;[Inst; 2]&gt; {
<span class="w"> </span>        let mut insts = SmallVec::new();
<span class="w"> </span>        match &amp;dest {
<span class="gd">-            &amp;CallDest::ExtName(ref name, RelocDistance::Near) =&gt; insts.push(Inst::Call {</span>
<span class="gi">+            &amp;CallDest::ExtName(ref name, _/*RelocDistance::Near*/) =&gt; insts.push(Inst::Call {</span>
<span class="w"> </span>                info: Box::new(CallInfo {
<span class="w"> </span>                    dest: name.clone(),
<span class="w"> </span>                    uses,
</code></pre></div>
<p>Relocations that print identical by <code>objdump -dr</code> are generated by Cranelift:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">rust_out</span><span class="p">.</span><span class="n">o</span><span class="p">:</span><span class="w">     </span><span class="nc">file</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">mach</span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">arm64</span>

<span class="n">Disassembly</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="n">__TEXT</span><span class="p">,</span><span class="n">__text</span><span class="p">:</span>

<span class="mi">0000000000000000</span><span class="w"> </span><span class="o">&lt;</span><span class="n">__ZN8rust_out3foo17he5a9b1ed9cb33bc0E</span><span class="o">&gt;</span><span class="p">:</span>
<span class="w">       </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="nc">a9bf7bfd</span><span class="w">      </span><span class="n">stp</span><span class="w">     </span><span class="n">x29</span><span class="p">,</span><span class="w"> </span><span class="n">x30</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="p">#</span><span class="o">-</span><span class="mi">16</span><span class="p">]</span><span class="o">!</span>
<span class="w">       </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="mi">910003</span><span class="n">fd</span><span class="w">      </span><span class="n">mov</span><span class="w">     </span><span class="n">x29</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<span class="w">       </span><span class="mi">8</span><span class="p">:</span><span class="w"> </span><span class="nc">d10043ff</span><span class="w">      </span><span class="n">sub</span><span class="w">     </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="p">#</span><span class="mi">16</span>
<span class="w">       </span><span class="n">c</span><span class="p">:</span><span class="w"> </span><span class="mi">94000000</span><span class="w">      </span><span class="n">bl</span><span class="w">      </span><span class="mh">0xc</span><span class="w"> </span><span class="o">&lt;</span><span class="n">__ZN8rust_out3foo17he5a9b1ed9cb33bc0E</span><span class="o">+</span><span class="mh">0xc</span><span class="o">&gt;</span>
<span class="w">                </span><span class="mi">000000000000000</span><span class="n">c</span><span class="p">:</span><span class="w">  </span><span class="nc">ARM64_RELOC_BRANCH26</span><span class="w"> </span><span class="n">_bar</span>
<span class="w">      </span><span class="mi">10</span><span class="p">:</span><span class="w"> </span><span class="mi">90000000</span><span class="w">      </span><span class="n">adrp</span><span class="w">    </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="w"> </span><span class="o">&lt;</span><span class="n">__ZN8rust_out3foo17he5a9b1ed9cb33bc0E</span><span class="o">+</span><span class="mh">0x10</span><span class="o">&gt;</span>
<span class="w">                </span><span class="mi">0000000000000010</span><span class="p">:</span><span class="w">  </span><span class="nc">ARM64_RELOC_GOT_LOAD_PAGE21</span><span class="w">  </span><span class="n">_bar</span>
<span class="w">      </span><span class="mi">14</span><span class="p">:</span><span class="w"> </span><span class="nc">f9400000</span><span class="w">      </span><span class="n">ldr</span><span class="w">     </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">x0</span><span class="p">]</span>
<span class="w">                </span><span class="mi">0000000000000014</span><span class="p">:</span><span class="w">  </span><span class="nc">ARM64_RELOC_GOT_LOAD_PAGEOFF12</span><span class="w">       </span><span class="n">_bar</span>
<span class="w">      </span><span class="mi">18</span><span class="p">:</span><span class="w"> </span><span class="mi">90000007</span><span class="w">      </span><span class="n">adrp</span><span class="w">    </span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="w"> </span><span class="o">&lt;</span><span class="n">__ZN8rust_out3foo17he5a9b1ed9cb33bc0E</span><span class="o">+</span><span class="mh">0x18</span><span class="o">&gt;</span>
<span class="w">                </span><span class="mi">0000000000000018</span><span class="p">:</span><span class="w">  </span><span class="nc">ARM64_RELOC_GOT_LOAD_PAGE21</span><span class="w">  </span><span class="n">_FOO</span>
<span class="w">      </span><span class="mi">1</span><span class="n">c</span><span class="p">:</span><span class="w"> </span><span class="nc">f94000e7</span><span class="w">      </span><span class="n">ldr</span><span class="w">     </span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">x7</span><span class="p">]</span>
<span class="w">                </span><span class="mi">000000000000001</span><span class="n">c</span><span class="p">:</span><span class="w">  </span><span class="nc">ARM64_RELOC_GOT_LOAD_PAGEOFF12</span><span class="w">       </span><span class="n">_FOO</span>
<span class="w">      </span><span class="mi">20</span><span class="p">:</span><span class="w"> </span><span class="mf">910003e8</span><span class="w">      </span><span class="n">mov</span><span class="w">     </span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<span class="w">      </span><span class="mi">24</span><span class="p">:</span><span class="w"> </span><span class="nc">f9000107</span><span class="w">      </span><span class="kt">str</span><span class="w">     </span><span class="n">x7</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">x8</span><span class="p">]</span>
<span class="w">      </span><span class="mi">28</span><span class="p">:</span><span class="w"> </span><span class="mf">910003e8</span><span class="w">      </span><span class="n">mov</span><span class="w">     </span><span class="n">x8</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<span class="w">      </span><span class="mi">2</span><span class="n">c</span><span class="p">:</span><span class="w"> </span><span class="nc">f9400101</span><span class="w">      </span><span class="n">ldr</span><span class="w">     </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">x8</span><span class="p">]</span>
<span class="w">      </span><span class="mi">30</span><span class="p">:</span><span class="w"> </span><span class="mi">910043</span><span class="n">ff</span><span class="w">      </span><span class="n">add</span><span class="w">     </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="p">#</span><span class="mi">16</span>
<span class="w">      </span><span class="mi">34</span><span class="p">:</span><span class="w"> </span><span class="nc">a8c17bfd</span><span class="w">      </span><span class="n">ldp</span><span class="w">     </span><span class="n">x29</span><span class="p">,</span><span class="w"> </span><span class="n">x30</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">sp</span><span class="p">],</span><span class="w"> </span><span class="p">#</span><span class="mi">16</span>
<span class="w">      </span><span class="mi">38</span><span class="p">:</span><span class="w"> </span><span class="nc">d65f03c0</span><span class="w">      </span><span class="n">ret</span>
</code></pre></div>
<p>Yet the object file produced by LLVM gives a regular linker error due to undefined symbols, while the one produced by Cranelift crashes the linker:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">0</span><span class="w">  </span><span class="mh">0x100e02074</span><span class="w">  </span><span class="n">__assert_rtn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">72</span>
<span class="mi">1</span><span class="w">  </span><span class="mh">0x100d3edb8</span><span class="w">  </span><span class="n">ld</span><span class="p">::</span><span class="n">InputFiles</span><span class="p">::</span><span class="n">SliceParser</span><span class="p">::</span><span class="n">parseObjectFile</span><span class="p">(</span><span class="n">mach_o</span><span class="p">::</span><span class="n">Header</span><span class="w"> </span><span class="k">const</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">22712</span>
<span class="mi">2</span><span class="w">  </span><span class="mh">0x100d4b830</span><span class="w">  </span><span class="n">ld</span><span class="p">::</span><span class="n">InputFiles</span><span class="p">::</span><span class="n">parseAllFiles</span><span class="p">(</span><span class="n">void</span><span class="w"> </span><span class="p">(</span><span class="n">ld</span><span class="p">::</span><span class="n">AtomFile</span><span class="w"> </span><span class="k">const</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">block_pointer</span><span class="p">)::</span><span class="cp">$_8</span><span class="p">::</span><span class="n">operator</span><span class="p">()(</span><span class="n">unsigned</span><span class="w"> </span><span class="n">long</span><span class="p">,</span><span class="w"> </span><span class="n">ld</span><span class="p">::</span><span class="n">FileInfo</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">440</span>
<span class="mi">3</span><span class="w">  </span><span class="mh">0x189fa6428</span><span class="w">  </span><span class="n">_dispatch_client_callout2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">20</span>
<span class="mi">4</span><span class="w">  </span><span class="mh">0x189fba850</span><span class="w">  </span><span class="n">_dispatch_apply_invoke3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">336</span>
<span class="mi">5</span><span class="w">  </span><span class="mh">0x189fa63e8</span><span class="w">  </span><span class="n">_dispatch_client_callout</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">20</span>
<span class="mi">6</span><span class="w">  </span><span class="mh">0x189fa7c68</span><span class="w">  </span><span class="n">_dispatch_once_callout</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">32</span>
<span class="mi">7</span><span class="w">  </span><span class="mh">0x189fbaeec</span><span class="w">  </span><span class="n">_dispatch_apply_invoke_and_wait</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">372</span>
<span class="mi">8</span><span class="w">  </span><span class="mh">0x189fb9e9c</span><span class="w">  </span><span class="n">_dispatch_apply_with_attr_f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1212</span>
<span class="mi">9</span><span class="w">  </span><span class="mh">0x189fba08c</span><span class="w">  </span><span class="n">dispatch_apply</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">96</span>
<span class="mi">10</span><span class="w">  </span><span class="mh">0x100dd0564</span><span class="w">  </span><span class="n">ld</span><span class="p">::</span><span class="n">AtomFileConsolidator</span><span class="p">::</span><span class="n">parseFiles</span><span class="p">(</span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">292</span>
<span class="mi">11</span><span class="w">  </span><span class="mh">0x100d6bee8</span><span class="w">  </span><span class="n">main</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">9532</span>
<span class="n">ld</span><span class="p">:</span><span class="w"> </span><span class="nc">Assertion</span><span class="w"> </span><span class="n">failed</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">pattern</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addrMode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">addr_other</span><span class="p">),</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">addFixupFromRelocations</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">Relocations</span><span class="p">.</span><span class="n">cpp</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="mf">701.</span>
</code></pre></div>
<p>This means there has to be a difference somewhere. If I run bingrep on both binaries, the relocations are shown in opposite order for both executable. For LLVM:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Relocations</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
<span class="w">  </span><span class="nc">Segment</span><span class="w">   </span><span class="n">Section</span><span class="w">   </span><span class="n">Count</span>
<span class="w">  </span><span class="n">__TEXT</span><span class="w">    </span><span class="n">__text</span><span class="w">    </span><span class="mi">5</span>
<span class="w">         </span><span class="n">Type</span><span class="w">                             </span><span class="n">Offset</span><span class="w">   </span><span class="n">Length</span><span class="w">   </span><span class="n">PIC</span><span class="w">      </span><span class="n">Extern</span><span class="w">   </span><span class="n">SymbolNum</span><span class="w">   </span><span class="n">Symbol</span>
<span class="w">         </span><span class="n">ARM64_RELOC_GOT_LOAD_PAGEOFF12</span><span class="w">   </span><span class="mh">0x18</span><span class="w">     </span><span class="mi">2</span><span class="w">        </span><span class="kc">false</span><span class="w">    </span><span class="kc">true</span><span class="w">     </span><span class="mh">0x2</span><span class="w">         </span><span class="n">_FOO</span>
<span class="w">         </span><span class="n">ARM64_RELOC_GOT_LOAD_PAGE21</span><span class="w">      </span><span class="mh">0x14</span><span class="w">     </span><span class="mi">2</span><span class="w">        </span><span class="kc">true</span><span class="w">     </span><span class="kc">true</span><span class="w">     </span><span class="mh">0x2</span><span class="w">         </span><span class="n">_FOO</span>
<span class="w">         </span><span class="n">ARM64_RELOC_GOT_LOAD_PAGEOFF12</span><span class="w">   </span><span class="mh">0x10</span><span class="w">     </span><span class="mi">2</span><span class="w">        </span><span class="kc">false</span><span class="w">    </span><span class="kc">true</span><span class="w">     </span><span class="mh">0x3</span><span class="w">         </span><span class="n">_bar</span>
<span class="w">         </span><span class="n">ARM64_RELOC_GOT_LOAD_PAGE21</span><span class="w">      </span><span class="mh">0xc</span><span class="w">      </span><span class="mi">2</span><span class="w">        </span><span class="kc">true</span><span class="w">     </span><span class="kc">true</span><span class="w">     </span><span class="mh">0x3</span><span class="w">         </span><span class="n">_bar</span>
<span class="w">         </span><span class="n">ARM64_RELOC_BRANCH26</span><span class="w">             </span><span class="mh">0x8</span><span class="w">      </span><span class="mi">2</span><span class="w">        </span><span class="kc">true</span><span class="w">     </span><span class="kc">true</span><span class="w">     </span><span class="mh">0x3</span><span class="w">         </span><span class="n">_bar</span>
</code></pre></div>
<p>and for Cranelift:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Relocations</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
<span class="w">  </span><span class="nc">Segment</span><span class="w">   </span><span class="n">Section</span><span class="w">   </span><span class="n">Count</span>
<span class="w">  </span><span class="n">__TEXT</span><span class="w">    </span><span class="n">__text</span><span class="w">    </span><span class="mi">5</span>
<span class="w">         </span><span class="n">Type</span><span class="w">                             </span><span class="n">Offset</span><span class="w">   </span><span class="n">Length</span><span class="w">   </span><span class="n">PIC</span><span class="w">      </span><span class="n">Extern</span><span class="w">   </span><span class="n">SymbolNum</span><span class="w">   </span><span class="n">Symbol</span>
<span class="w">         </span><span class="n">ARM64_RELOC_BRANCH26</span><span class="w">             </span><span class="mh">0xc</span><span class="w">      </span><span class="mi">2</span><span class="w">        </span><span class="kc">true</span><span class="w">     </span><span class="kc">true</span><span class="w">     </span><span class="mh">0x2</span><span class="w">         </span><span class="n">_bar</span>
<span class="w">         </span><span class="n">ARM64_RELOC_GOT_LOAD_PAGE21</span><span class="w">      </span><span class="mh">0x10</span><span class="w">     </span><span class="mi">2</span><span class="w">        </span><span class="kc">true</span><span class="w">     </span><span class="kc">true</span><span class="w">     </span><span class="mh">0x2</span><span class="w">         </span><span class="n">_bar</span>
<span class="w">         </span><span class="n">ARM64_RELOC_GOT_LOAD_PAGEOFF12</span><span class="w">   </span><span class="mh">0x14</span><span class="w">     </span><span class="mi">2</span><span class="w">        </span><span class="kc">false</span><span class="w">    </span><span class="kc">true</span><span class="w">     </span><span class="mh">0x2</span><span class="w">         </span><span class="n">_bar</span>
<span class="w">         </span><span class="n">ARM64_RELOC_GOT_LOAD_PAGE21</span><span class="w">      </span><span class="mh">0x18</span><span class="w">     </span><span class="mi">2</span><span class="w">        </span><span class="kc">true</span><span class="w">     </span><span class="kc">true</span><span class="w">     </span><span class="mh">0x1</span><span class="w">         </span><span class="n">_FOO</span>
<span class="w">         </span><span class="n">ARM64_RELOC_GOT_LOAD_PAGEOFF12</span><span class="w">   </span><span class="mh">0x1c</span><span class="w">     </span><span class="mi">2</span><span class="w">        </span><span class="kc">false</span><span class="w">    </span><span class="kc">true</span><span class="w">     </span><span class="mh">0x1</span><span class="w">         </span><span class="n">_FOO</span>
</code></pre></div>
<p>As hack I tried to reverse the order of relocations emitted by Cranelift too, which worked.</p>
<p><div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/cranelift/codegen/src/isa/aarch64/abi.rs b/cranelift/codegen/src/isa/aarch64/abi.rs</span>
<span class="gh">index 922e4ebfc..6d43c1db6 100644</span>
<span class="gd">--- a/cranelift/codegen/src/isa/aarch64/abi.rs</span>
<span class="gi">+++ b/cranelift/codegen/src/isa/aarch64/abi.rs</span>
<span class="gu">@@ -1027,7 +1027,7 @@ impl ABIMachineSpec for AArch64MachineDeps {</span>
<span class="w"> </span>    ) -&gt; SmallVec&lt;[Inst; 2]&gt; {
<span class="w"> </span>        let mut insts = SmallVec::new();
<span class="w"> </span>        match &amp;dest {
<span class="gd">-            &amp;CallDest::ExtName(ref name, RelocDistance::Near) =&gt; insts.push(Inst::Call {</span>
<span class="gi">+            &amp;CallDest::ExtName(ref name, _/*RelocDistance::Near*/) =&gt; insts.push(Inst::Call {</span>
<span class="w"> </span>                info: Box::new(CallInfo {
<span class="w"> </span>                    dest: name.clone(),
<span class="w"> </span>                    uses,
<span class="gh">diff --git a/cranelift/object/src/backend.rs b/cranelift/object/src/backend.rs</span>
<span class="gh">index 2d48e9b61..c5a84f14c 100644</span>
<span class="gd">--- a/cranelift/object/src/backend.rs</span>
<span class="gi">+++ b/cranelift/object/src/backend.rs</span>
<span class="gu">@@ -501,7 +501,7 @@ impl ObjectModule {</span>
<span class="w"> </span>                ref name,
<span class="w"> </span>                flags,
<span class="w"> </span>                addend,
<span class="gd">-            } in &amp;symbol.relocs</span>
<span class="gi">+            } in symbol.relocs.iter().rev()</span>
<span class="w"> </span>            {
<span class="w"> </span>                let target_symbol = self.get_symbol(name);
<span class="w"> </span>                self.object
</code></pre></div><br>
</p>
</blockquote>



<a name="447471945"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238730%20Object%20files%20can%20only%20be%20linked%20wi.../near/447471945" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238730.20Object.20files.20can.20only.20be.20linked.20wi.2E.2E.2E.html#447471945">(Jun 27 2024 at 12:58)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/8730#issuecomment-2194626549">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8730">issue #8730</a>:</p>
<blockquote>
<p>Looks like the change to cranelift/codegen/src/isa/aarch64/abi.rs isn't even necessary at all. Only the relocation order reversing is required.</p>
</blockquote>



<a name="447473791"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238730%20Object%20files%20can%20only%20be%20linked%20wi.../near/447473791" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238730.20Object.20files.20can.20only.20be.20linked.20wi.2E.2E.2E.html#447473791">(Jun 27 2024 at 13:07)</a>:</h4>
<p>philipc <a href="https://github.com/bytecodealliance/wasmtime/issues/8730#issuecomment-2194649788">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8730">issue #8730</a>:</p>
<blockquote>
<p>That sounds better. I was comparing clang output instead of looking at what rustc with llvm backend did, so you can probably ignore my results.</p>
</blockquote>



<a name="447475499"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238730%20Object%20files%20can%20only%20be%20linked%20wi.../near/447475499" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238730.20Object.20files.20can.20only.20be.20linked.20wi.2E.2E.2E.html#447475499">(Jun 27 2024 at 13:16)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/8730#issuecomment-2194669348">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8730">issue #8730</a>:</p>
<blockquote>
<p>What would be the best place to add this relocation reversing code? object or cranelift-object? On the one hand it is something that would affect other projects too, so object makes more sense, on the other hand reversing the relocation order right before writing would require anyone who wants to round trip an object file through the object crate to reverse relocation order again before the <code>add_relocation</code> calls to produce a working object file.</p>
</blockquote>



<a name="447481179"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238730%20Object%20files%20can%20only%20be%20linked%20wi.../near/447481179" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238730.20Object.20files.20can.20only.20be.20linked.20wi.2E.2E.2E.html#447481179">(Jun 27 2024 at 13:43)</a>:</h4>
<p>philipc <a href="https://github.com/bytecodealliance/wasmtime/issues/8730#issuecomment-2194725714">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8730">issue #8730</a>:</p>
<blockquote>
<p>LLVM does the reverse in its <a href="https://github.com/llvm/llvm-project/blob/9e7defccdab8c21d70d8227c356a46db489dec2a/llvm/lib/MC/MachObjectWriter.cpp#L1004">object writer</a>. I'm not certain which place is best, for the same reasons you give, but I'm inclined to fix it in <code>object</code>, since its primary use is for generating objects, not for round trips. It already does at least one other change that round trips need to account for (symbol name decorations).</p>
</blockquote>



<a name="447484788"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238730%20Object%20files%20can%20only%20be%20linked%20wi.../near/447484788" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238730.20Object.20files.20can.20only.20be.20linked.20wi.2E.2E.2E.html#447484788">(Jun 27 2024 at 13:54)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/8730#issuecomment-2194749827">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8730">issue #8730</a>:</p>
<blockquote>
<p>Opened <a href="https://github.com/gimli-rs/object/pull/702">https://github.com/gimli-rs/object/pull/702</a></p>
</blockquote>



<a name="447975655"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238730%20Object%20files%20can%20only%20be%20linked%20wi.../near/447975655" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238730.20Object.20files.20can.20only.20be.20linked.20wi.2E.2E.2E.html#447975655">(Jun 29 2024 at 13:18)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/8730#issuecomment-2198190160">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8730">issue #8730</a>:</p>
<blockquote>
<p>This has been fixed in object 0.36.1.</p>
</blockquote>



<a name="447979028"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238730%20Object%20files%20can%20only%20be%20linked%20wi.../near/447979028" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238730.20Object.20files.20can.20only.20be.20linked.20wi.2E.2E.2E.html#447979028">(Jun 29 2024 at 13:51)</a>:</h4>
<p>sezna <a href="https://github.com/bytecodealliance/wasmtime/issues/8730#issuecomment-2198201744">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8730">issue #8730</a>:</p>
<blockquote>
<p>Thank you all who helped! </p>
</blockquote>



<a name="447979079"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238730%20Object%20files%20can%20only%20be%20linked%20wi.../near/447979079" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238730.20Object.20files.20can.20only.20be.20linked.20wi.2E.2E.2E.html#447979079">(Jun 29 2024 at 13:52)</a>:</h4>
<p>sezna edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8730#issuecomment-2198201744">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8730">issue #8730</a>:</p>
<blockquote>
<p>Thank you all who looked into this! </p>
</blockquote>



<a name="447997734"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238730%20Object%20files%20can%20only%20be%20linked%20wi.../near/447997734" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238730.20Object.20files.20can.20only.20be.20linked.20wi.2E.2E.2E.html#447997734">(Jun 29 2024 at 16:29)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/8730#issuecomment-2198253590">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8730">issue #8730</a>:</p>
<blockquote>
<p>This issue can be closed now, right?</p>
</blockquote>



<a name="448007968"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238730%20Object%20files%20can%20only%20be%20linked%20wi.../near/448007968" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238730.20Object.20files.20can.20only.20be.20linked.20wi.2E.2E.2E.html#448007968">(Jun 29 2024 at 17:51)</a>:</h4>
<p>camelid <a href="https://github.com/bytecodealliance/wasmtime/issues/8730#issuecomment-2198275263">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8730">issue #8730</a>:</p>
<blockquote>
<p>I'm now getting <code>ld: warning: no platform load command found in '/path/to/cranelift/output.o', assuming: macOS</code>. This happens only with the default modern linker, but not the legacy linker. The executable still works, but it's unfortunate to get this warning. It seems like Julia encountered a similar issue and fixed it by including the macOS version number in the OS segment of the triple: <a href="https://github.com/julialang/julia/issues/51830">julialang/julia#51830</a>. I'm using <code>target_lexicon::Triple::host</code>, so it could be an issue with that crate rather than cranelift?</p>
</blockquote>



<a name="448013319"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238730%20Object%20files%20can%20only%20be%20linked%20wi.../near/448013319" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238730.20Object.20files.20can.20only.20be.20linked.20wi.2E.2E.2E.html#448013319">(Jun 29 2024 at 18:42)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/8730#issuecomment-2198293580">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8730">issue #8730</a>:</p>
<blockquote>
<p>We will need to call <a href="https://docs.rs/object/latest/object/write/struct.Object.html#method.set_macho_build_version">set_macho_build_version</a> in cranelift-object to emit the LC_BUILD_VERSION load command.</p>
</blockquote>



<a name="448076806"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238730%20Object%20files%20can%20only%20be%20linked%20wi.../near/448076806" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238730.20Object.20files.20can.20only.20be.20linked.20wi.2E.2E.2E.html#448076806">(Jun 30 2024 at 06:14)</a>:</h4>
<p>camelid <a href="https://github.com/bytecodealliance/wasmtime/issues/8730#issuecomment-2198448744">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8730">issue #8730</a>:</p>
<blockquote>
<p>It seems like rustc has implemented a fix for the same issue: <a href="https://github.com/rust-lang/rust/issues/111384">rust-lang/rust#111384</a>.</p>
</blockquote>



<a name="448186251"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238730%20Object%20files%20can%20only%20be%20linked%20wi.../near/448186251" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238730.20Object.20files.20can.20only.20be.20linked.20wi.2E.2E.2E.html#448186251">(Jun 30 2024 at 23:05)</a>:</h4>
<p>camelid <a href="https://github.com/bytecodealliance/wasmtime/issues/8730#issuecomment-2198793563">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8730">issue #8730</a>:</p>
<blockquote>
<p>It's unclear to me if cranelift-object should be exposing some function to set the macho build version or if it should handle it automatically. Do we have enough information in cranelift-object to target the exact version?</p>
</blockquote>



<a name="473352212"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238730%20Object%20files%20can%20only%20be%20linked%20wi.../near/473352212" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238730.20Object.20files.20can.20only.20be.20linked.20wi.2E.2E.2E.html#473352212">(Sep 28 2024 at 14:12)</a>:</h4>
<p>madsmtm <a href="https://github.com/bytecodealliance/wasmtime/issues/8730#issuecomment-2380653926">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8730">issue #8730</a>:</p>
<blockquote>
<p>I've looked into this recently, see <a href="https://github.com/rust-lang/rust/issues/129432">https://github.com/rust-lang/rust/issues/129432</a> for the broader issue of deployment targets and SDKs.</p>
<p>I'm pretty sure the correct behaviour for Cranelift would be to set the values on <code>MachOBuildVersion</code> as follows:</p>
<ul>
<li><code>platform</code>, depending on the target triple's <a href="https://docs.rs/target-lexicon/0.12.16/target_lexicon/enum.OperatingSystem.html"><code>OperatingSystem</code></a> and <a href="https://docs.rs/target-lexicon/0.12.16/target_lexicon/enum.Environment.html"><code>Environment</code></a>.</li>
<li><code>minos</code> (deployment target), extracted from <a href="https://docs.rs/target-lexicon/0.12.16/target_lexicon/enum.OperatingSystem.html">target_lexicon::OperatingSystem::MacOSX</a>.<ul>
<li>Will need some work in <code>target_lexicon</code> to better support iOS/tvOS/watchOS/visionOS here too.</li>
<li>I think you might need to error if the version isn't present in the given triple?<ul>
<li>The system tooling (linker, assembler, <code>otool</code> etc.) requires a version here.</li>
<li>At the very least don't emit the <code>LC_BUILD_VERSION</code> command in this case, and warn very strongly.</li>
</ul>
</li>
</ul>
</li>
<li><code>sdk</code> (SDK version) to <code>0</code>. This is also what LLVM does by default if no SDK version is given, and the tooling shows <code>n/a</code> in that case.</li>
</ul>
<p>Note that this will not support older tooling that uses <code>LC_VERSION_MIN_IPHONEOS</code>, <code>LC_VERSION_MIN_MACOSX</code> etc. (we're talking somewhere around Xcode 9 or 10), but that's probably _fine_, we still support older OS versions the linker is going to patch it up such that you can still run the binaries on older OS versions.</p>
</blockquote>



<a name="473352221"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238730%20Object%20files%20can%20only%20be%20linked%20wi.../near/473352221" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238730.20Object.20files.20can.20only.20be.20linked.20wi.2E.2E.2E.html#473352221">(Sep 28 2024 at 14:12)</a>:</h4>
<p>madsmtm edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8730#issuecomment-2380653926">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8730">issue #8730</a>:</p>
<blockquote>
<p>I've looked into this recently, see <a href="https://github.com/rust-lang/rust/issues/129432">https://github.com/rust-lang/rust/issues/129432</a> for the broader Rust issue of deployment targets and SDKs.</p>
<p>I'm pretty sure the correct behaviour for Cranelift would be to set the values on <code>MachOBuildVersion</code> as follows:</p>
<ul>
<li><code>platform</code>, depending on the target triple's <a href="https://docs.rs/target-lexicon/0.12.16/target_lexicon/enum.OperatingSystem.html"><code>OperatingSystem</code></a> and <a href="https://docs.rs/target-lexicon/0.12.16/target_lexicon/enum.Environment.html"><code>Environment</code></a>.</li>
<li><code>minos</code> (deployment target), extracted from <a href="https://docs.rs/target-lexicon/0.12.16/target_lexicon/enum.OperatingSystem.html">target_lexicon::OperatingSystem::MacOSX</a>.<ul>
<li>Will need some work in <code>target_lexicon</code> to better support iOS/tvOS/watchOS/visionOS here too.</li>
<li>I think you might need to error if the version isn't present in the given triple?<ul>
<li>The system tooling (linker, assembler, <code>otool</code> etc.) requires a version here.</li>
<li>At the very least don't emit the <code>LC_BUILD_VERSION</code> command in this case, and warn very strongly.</li>
</ul>
</li>
</ul>
</li>
<li><code>sdk</code> (SDK version) to <code>0</code>. This is also what LLVM does by default if no SDK version is given, and the tooling shows <code>n/a</code> in that case.</li>
</ul>
<p>Note that this will not support older tooling that uses <code>LC_VERSION_MIN_IPHONEOS</code>, <code>LC_VERSION_MIN_MACOSX</code> etc. (we're talking somewhere around Xcode 9 or 10), but that's probably _fine_, we still support older OS versions the linker is going to patch it up such that you can still run the binaries on older OS versions.</p>
</blockquote>



<a name="473352360"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238730%20Object%20files%20can%20only%20be%20linked%20wi.../near/473352360" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238730.20Object.20files.20can.20only.20be.20linked.20wi.2E.2E.2E.html#473352360">(Sep 28 2024 at 14:14)</a>:</h4>
<p>madsmtm <a href="https://github.com/bytecodealliance/wasmtime/issues/8730#issuecomment-2380654524">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8730">issue #8730</a>:</p>
<blockquote>
<blockquote>
<p>It's unclear to me if cranelift-object should be exposing some function to set the macho build version or if it should handle it automatically. Do we have enough information in cranelift-object to target the exact version?</p>
</blockquote>
<p>So to answer this directly, Cranelift should have enough information to set this _if_ it requires the deployment target / minimum OS version to be set in the target triple (e.g. that users pass <code>aarch64-apple-macosx12.0.0</code>, and not just <code>aarch64-apple-macosx</code>).</p>
</blockquote>



<a name="473362667"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238730%20Object%20files%20can%20only%20be%20linked%20wi.../near/473362667" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238730.20Object.20files.20can.20only.20be.20linked.20wi.2E.2E.2E.html#473362667">(Sep 28 2024 at 16:21)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/8730#issuecomment-2380725262">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8730">issue #8730</a>:</p>
<blockquote>
<p>Cranelift uses target-lexicon for target triples, which aims to math rustc. Rustc target triples do not allow passing in the OS version. Instead rustc has a default for each target and additionally allows setting the same env vars that clang reads. There is no way currently to pass this information to Cranelift.</p>
</blockquote>



<a name="473365531"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238730%20Object%20files%20can%20only%20be%20linked%20wi.../near/473365531" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238730.20Object.20files.20can.20only.20be.20linked.20wi.2E.2E.2E.html#473365531">(Sep 28 2024 at 16:59)</a>:</h4>
<p>madsmtm <a href="https://github.com/bytecodealliance/wasmtime/issues/8730#issuecomment-2380834366">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8730">issue #8730</a>:</p>
<blockquote>
<blockquote>
<p>Cranelift uses target-lexicon for target triples, which aims to math rustc. Rustc target triples do not allow passing in the OS version. Instead rustc has a default for each target and additionally allows setting the same env vars that clang reads. There is no way currently to pass this information to Cranelift.</p>
</blockquote>
<p>Hmm, isn't <code>rustc</code> passing the LLVM target to Cranelift? <a href="https://github.com/rust-lang/rust/blob/612796c42077605fdd3c6f7dda05745d8f4dc4d8/compiler/rustc_codegen_cranelift/src/lib.rs#L262">https://github.com/rust-lang/rust/blob/612796c42077605fdd3c6f7dda05745d8f4dc4d8/compiler/rustc_codegen_cranelift/src/lib.rs#L262</a></p>
</blockquote>



<a name="473381479"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238730%20Object%20files%20can%20only%20be%20linked%20wi.../near/473381479" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238730.20Object.20files.20can.20only.20be.20linked.20wi.2E.2E.2E.html#473381479">(Sep 28 2024 at 20:07)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/8730#issuecomment-2380882328">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8730">issue #8730</a>:</p>
<blockquote>
<p>Yes, but as it turns out target-lexicon is just lenient with parsing to parse most LLVM triples fine too. I'm pretty sure it would parse aarch64-apple-macosx12.0.0 as having the OS field set to macosx12.0.1, which is not an OS known to rustc or target-lexicon and thus would fail parsing.</p>
</blockquote>



<a name="473426421"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238730%20Object%20files%20can%20only%20be%20linked%20wi.../near/473426421" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238730.20Object.20files.20can.20only.20be.20linked.20wi.2E.2E.2E.html#473426421">(Sep 29 2024 at 08:24)</a>:</h4>
<p>madsmtm <a href="https://github.com/bytecodealliance/wasmtime/issues/8730#issuecomment-2381259341">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8730">issue #8730</a>:</p>
<blockquote>
<blockquote>
<p>Yes, but as it turns out target-lexicon is just lenient with parsing to parse most LLVM triples fine too. I'm pretty sure it would parse aarch64-apple-macosx12.0.0 as having the OS field set to macosx12.0.1, which is not an OS known to rustc or target-lexicon and thus would fail parsing.</p>
</blockquote>
<p>Nope, they do parse the version number, see <a href="https://github.com/bytecodealliance/target-lexicon/blob/7c80d459a9fdd121e9f23feb680c3db13c1baa39/src/targets.rs#L1393-L1421">https://github.com/bytecodealliance/target-lexicon/blob/7c80d459a9fdd121e9f23feb680c3db13c1baa39/src/targets.rs#L1393-L1421</a>.</p>
<p>In any case, I have opened <a href="https://github.com/bytecodealliance/target-lexicon/issues/111">https://github.com/bytecodealliance/target-lexicon/issues/111</a> for figuring out how to resolve the <code>rustc</code>/LLVM discrepancy in <code>target-lexicon</code>.</p>
<hr>
<p>But if it is as you say, that Cranelift wants to accept <code>rustc</code> target triples, then it needs _some_ way to specify the deployment target on Apple platforms too.</p>
<p>A simple way to do this would be to add <code>ObjectBuilder::apple_deployment_target(&amp;mut self, major: u16, minor: u8, patch: u8) -&gt; &amp;mut Self</code>, but I'd argue that it might be worthwhile to add such a setter to the <code>Triple</code> itself directly? At least, if Cranelift wants to at some point do an optimization based on the deployment target (which LLVM does all the time, though mostly for Objective-C code), then it'd be nice to have available earlier in the compilation pipeline.</p>
</blockquote>



<a name="488144520"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238730%20Object%20files%20can%20only%20be%20linked%20wi.../near/488144520" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238730.20Object.20files.20can.20only.20be.20linked.20wi.2E.2E.2E.html#488144520">(Dec 11 2024 at 16:57)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/8730#issuecomment-2536552413">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8730">issue #8730</a>:</p>
<blockquote>
<p>We are using target-lexicon 0.13 now so we should now be able to call <code>set_macho_build_version</code> in cranelift-object and update <a href="https://github.com/rust-lang/rustc_codegen_cranelift/blob/3ebaf047071afae07229ff8fb5e05527fa6d9645/src/lib.rs#L247">https://github.com/rust-lang/rustc_codegen_cranelift/blob/3ebaf047071afae07229ff8fb5e05527fa6d9645/src/lib.rs#L247</a> to fix this issue.</p>
</blockquote>



<a name="488144565"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238730%20Object%20files%20can%20only%20be%20linked%20wi.../near/488144565" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238730.20Object.20files.20can.20only.20be.20linked.20wi.2E.2E.2E.html#488144565">(Dec 11 2024 at 16:57)</a>:</h4>
<p>bjorn3 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8730#issuecomment-2536552413">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8730">issue #8730</a>:</p>
<blockquote>
<p>We are using target-lexicon 0.13 so we should now be able to call <code>set_macho_build_version</code> in cranelift-object and update <a href="https://github.com/rust-lang/rustc_codegen_cranelift/blob/3ebaf047071afae07229ff8fb5e05527fa6d9645/src/lib.rs#L247">https://github.com/rust-lang/rustc_codegen_cranelift/blob/3ebaf047071afae07229ff8fb5e05527fa6d9645/src/lib.rs#L247</a> to fix this issue.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>