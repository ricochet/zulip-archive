<html>
<head><meta charset="utf-8"><title>wasmtime / issue #5730 Remove analyze_branch and BranchInfo · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235730.20Remove.20analyze_branch.20and.20BranchInfo.html">wasmtime / issue #5730 Remove analyze_branch and BranchInfo</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="326265496"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235730%20Remove%20analyze_branch%20and%20BranchInfo/near/326265496" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235730.20Remove.20analyze_branch.20and.20BranchInfo.html#326265496">(Feb 07 2023 at 00:46)</a>:</h4>
<p>elliottt <a href="https://github.com/bytecodealliance/wasmtime/pull/5730#issuecomment-1419999048">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5730">issue #5730</a>:</p>
<blockquote>
<blockquote>
<p>I wonder how many of these former uses of <code>analyze_branch</code> could be replaced with calls to <code>visit_block_succs</code>? I'm pretty sure at least the ones in <code>dominator_tree.rs</code> and <code>flowgraph.rs</code> could be.</p>
</blockquote>
<p>That would be a nice refactoring!</p>
</blockquote>



<a name="326265976"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235730%20Remove%20analyze_branch%20and%20BranchInfo/near/326265976" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235730.20Remove.20analyze_branch.20and.20BranchInfo.html#326265976">(Feb 07 2023 at 00:52)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/5730#issuecomment-1420006481">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5730">issue #5730</a>:</p>
<blockquote>
<p>Just so we're clear: I did push the "approve" button, with or without that hypothetical refactoring. :grin: </p>
</blockquote>



<a name="326339720"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235730%20Remove%20analyze_branch%20and%20BranchInfo/near/326339720" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235730.20Remove.20analyze_branch.20and.20BranchInfo.html#326339720">(Feb 07 2023 at 11:30)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/5730#issuecomment-1420625054">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5730">issue #5730</a>:</p>
<blockquote>
<p>Exception handling may introduce a new instruction with semantics identical to br_table with respect to determining successors. analyze_branch would still be useful for that. In addition when a new kind of branch instruction is added, this PR causes there to no longer be a compile error or runtime error when a match is missed. Previously forgetting to add it to analyze_branch would trigger the !is_branch assertion and if a new BranchInfo variant was added you did get a compile error.</p>
</blockquote>



<a name="326340437"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235730%20Remove%20analyze_branch%20and%20BranchInfo/near/326340437" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235730.20Remove.20analyze_branch.20and.20BranchInfo.html#326340437">(Feb 07 2023 at 11:34)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/5730#issuecomment-1420629967">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5730">issue #5730</a>:</p>
<blockquote>
<p>Maybe the visit_block_succs refactoring could be done and the remaining cases could get the !is_branch assertion added back?</p>
</blockquote>



<a name="326404800"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235730%20Remove%20analyze_branch%20and%20BranchInfo/near/326404800" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235730.20Remove.20analyze_branch.20and.20BranchInfo.html#326404800">(Feb 07 2023 at 16:35)</a>:</h4>
<p>elliottt <a href="https://github.com/bytecodealliance/wasmtime/pull/5730#issuecomment-1421071750">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5730">issue #5730</a>:</p>
<blockquote>
<blockquote>
<p>Exception handling may introduce a new instruction with semantics identical to br_table with respect to determining successors. analyze_branch would still be useful for that.</p>
</blockquote>
<p>Would that have turned into a return value of <code>BranchInfo::Table</code> in <code>analyze_branch</code>? If so, you would still have needed to re-match the opcode to apply special behavior for your new instruction.</p>
<blockquote>
<p>In addition when a new kind of branch instruction is added, this PR causes there to no longer be a compile error or runtime error when a match is missed. Previously forgetting to add it to analyze_branch would trigger the !is_branch assertion and if a new BranchInfo variant was added you did get a compile error.</p>
</blockquote>
<p>This is true, however my hope was that we've now arrived at the necessary set of branch instructions and won't need to add any others. We have unconditional jump, conditional branch, and branch through table instructions, which feel like the right building blocks for more complicated control flow. I think the <code>switch</code> module in cranelift-frontend is a great example of this.</p>
</blockquote>



<a name="326425020"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235730%20Remove%20analyze_branch%20and%20BranchInfo/near/326425020" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235730.20Remove.20analyze_branch.20and.20BranchInfo.html#326425020">(Feb 07 2023 at 18:06)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/5730#issuecomment-1421229469">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5730">issue #5730</a>:</p>
<blockquote>
<blockquote>
<p>Would that have turned into a return value of BranchInfo::Table in analyze_branch?</p>
</blockquote>
<p>Yes</p>
<blockquote>
<p>If so, you would still have needed to re-match the opcode to apply special behavior for your new instruction.</p>
</blockquote>
<p>Yeah, in some cases that is indeed necessary. In other cases it doesn't actually care about which exact branch instruction is used. Just which successors exist.</p>
<blockquote>
<p>This is true, however my hope was that we've now arrived at the necessary set of branch instructions and won't need to add any others. We have unconditional jump, conditional branch, and branch through table instructions, which feel like the right building blocks for more complicated control flow. I think the switch module in cranelift-frontend is a great example of this.</p>
</blockquote>
<p>I see. For exceptions I am pretty sure we will need an invoke/invoke_indirect instruction to be able to define the unwinding path that a call will take. From the clif ir perspective this will be a branch instruction which branches when an exception happens. I don't think this is implementable without support from cranelift-codegen.</p>
</blockquote>



<a name="326430682"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235730%20Remove%20analyze_branch%20and%20BranchInfo/near/326430682" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235730.20Remove.20analyze_branch.20and.20BranchInfo.html#326430682">(Feb 07 2023 at 18:33)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/5730#issuecomment-1421263870">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5730">issue #5730</a>:</p>
<blockquote>
<p>+1 to <code>invoke</code>-family instructions: fundamentally we can't represent the zero-cost exception model without it, I think, because the unwinder is external and effectively jumps to a different return address.</p>
</blockquote>



<a name="326430825"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235730%20Remove%20analyze_branch%20and%20BranchInfo/near/326430825" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235730.20Remove.20analyze_branch.20and.20BranchInfo.html#326430825">(Feb 07 2023 at 18:34)</a>:</h4>
<p>cfallin edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/5730#issuecomment-1421263870">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5730">issue #5730</a>:</p>
<blockquote>
<p>+1 to <code>invoke</code>-family instructions: fundamentally we can't represent the zero-cost exception model without it (EDIT: being another kind of branch), I think, because the unwinder is external and effectively jumps to a different return address.</p>
</blockquote>



<a name="326431268"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235730%20Remove%20analyze_branch%20and%20BranchInfo/near/326431268" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235730.20Remove.20analyze_branch.20and.20BranchInfo.html#326431268">(Feb 07 2023 at 18:36)</a>:</h4>
<p>elliottt <a href="https://github.com/bytecodealliance/wasmtime/pull/5730#issuecomment-1421267193">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5730">issue #5730</a>:</p>
<blockquote>
<blockquote>
<p>I see. For exceptions I am pretty sure we will need an invoke/invoke_indirect instruction to be able to define the unwinding path that a call will take. From the clif ir perspective this will be a branch instruction which branches when an exception happens. I don't think this is implementable without support from cranelift-codegen.</p>
</blockquote>
<p>I'll make a PR that both implements @jameysharp's earlier refactoring suggestion, and add <code>assert!(!inst.is_branch())</code> to all the cases that I modified when removing <code>BranchInfo</code>. Does that seem sufficient for not making the addition of <code>invoke</code>/<code>invoke_indirect</code> not too painful?</p>
</blockquote>



<a name="326431461"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235730%20Remove%20analyze_branch%20and%20BranchInfo/near/326431461" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235730.20Remove.20analyze_branch.20and.20BranchInfo.html#326431461">(Feb 07 2023 at 18:37)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/5730#issuecomment-1421268554">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5730">issue #5730</a>:</p>
<blockquote>
<p>I think that is sufficient.</p>
</blockquote>



<a name="326431663"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235730%20Remove%20analyze_branch%20and%20BranchInfo/near/326431663" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235730.20Remove.20analyze_branch.20and.20BranchInfo.html#326431663">(Feb 07 2023 at 18:38)</a>:</h4>
<p>elliottt edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/5730#issuecomment-1421267193">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5730">issue #5730</a>:</p>
<blockquote>
<blockquote>
<p>I see. For exceptions I am pretty sure we will need an invoke/invoke_indirect instruction to be able to define the unwinding path that a call will take. From the clif ir perspective this will be a branch instruction which branches when an exception happens. I don't think this is implementable without support from cranelift-codegen.</p>
</blockquote>
<p>I'll make a PR that both implements @jameysharp's earlier refactoring suggestion, and add <code>assert!(!inst.is_branch())</code> to all the cases that I modified when removing <code>BranchInfo</code>. Does that seem sufficient for not making the addition of <code>invoke</code>/<code>invoke_indirect</code> too painful?</p>
<p>(edited to remove accidental double negative)</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>