<html>
<head><meta charset="utf-8"><title>wasmtime / PR #5909 Allow hoisting `vconst` instructions ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235909.20Allow.20hoisting.20.60vconst.60.20instructions.20.2E.2E.2E.html">wasmtime / PR #5909 Allow hoisting `vconst` instructions ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="339008167"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235909%20Allow%20hoisting%20%60vconst%60%20instructions%20.../near/339008167" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235909.20Allow.20hoisting.20.60vconst.60.20instructions.20.2E.2E.2E.html#339008167">(Mar 02 2023 at 05:42)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/5909">PR #5909</a> from <code>licm-vconst</code> to <code>main</code>:</p>
<blockquote>
<p>Staring at some SIMD code and what LLVM and v8 both generate it appears that a common technique for SIMD-loops is to hoist constants outside of loops since they're nontrivial to rematerialize unlike integer constants. This commit updates the <code>loop_hoist_level</code> calculation with egraphs to have a nonzero default for instructions that have no arguments (e.g. consts) which enables hoisting these instructions out of loops.</p>
<p>Note, though, that for now I've listed the maximum as hoisting outside of one loop, but not all of them. While theoretically vconsts could move up to the top of the function I'd be worried about their impact on register pressure and having to save/restore around calls or similar, so hopefully if the hot part of a program is a single loop then hoisting out of one loop is a reasonable-enough heuristic for now.</p>
<p>Locally on x64 with a benchmark that just encodes binary to hex this saw a 15% performance improvement taking hex encoding from ~6G/s to ~6.7G/s.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="339186274"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235909%20Allow%20hoisting%20%60vconst%60%20instructions%20.../near/339186274" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235909.20Allow.20hoisting.20.60vconst.60.20instructions.20.2E.2E.2E.html#339186274">(Mar 02 2023 at 19:16)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5909#pullrequestreview-1322469166">PR review</a>.</p>



<a name="339234420"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235909%20Allow%20hoisting%20%60vconst%60%20instructions%20.../near/339234420" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235909.20Allow.20hoisting.20.60vconst.60.20instructions.20.2E.2E.2E.html#339234420">(Mar 03 2023 at 00:56)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5909">PR #5909</a> from <code>licm-vconst</code> to <code>main</code>.</p>



<a name="339893409"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235909%20Allow%20hoisting%20%60vconst%60%20instructions%20.../near/339893409" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235909.20Allow.20hoisting.20.60vconst.60.20instructions.20.2E.2E.2E.html#339893409">(Mar 06 2023 at 15:08)</a>:</h4>
<p>alexcrichton closed without merge <a href="https://github.com/bytecodealliance/wasmtime/pull/5909">PR #5909</a>.</p>



<a name="339893421"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235909%20Allow%20hoisting%20%60vconst%60%20instructions%20.../near/339893421" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235909.20Allow.20hoisting.20.60vconst.60.20instructions.20.2E.2E.2E.html#339893421">(Mar 06 2023 at 15:08)</a>:</h4>
<p>alexcrichton reopened <a href="https://github.com/bytecodealliance/wasmtime/pull/5909">PR #5909</a> from <code>licm-vconst</code> to <code>main</code>.</p>



<a name="339893444"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235909%20Allow%20hoisting%20%60vconst%60%20instructions%20.../near/339893444" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235909.20Allow.20hoisting.20.60vconst.60.20instructions.20.2E.2E.2E.html#339893444">(Mar 06 2023 at 15:08)</a>:</h4>
<p>alexcrichton has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/5909">PR #5909</a>.</p>



<a name="339907568"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235909%20Allow%20hoisting%20%60vconst%60%20instructions%20.../near/339907568" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235909.20Allow.20hoisting.20.60vconst.60.20instructions.20.2E.2E.2E.html#339907568">(Mar 06 2023 at 16:03)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/5909">PR #5909</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>