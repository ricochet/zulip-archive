<html>
<head><meta charset="utf-8"><title>wasmtime / issue #9654 Cranelift: `fpromote.f32` seems no... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239654.20Cranelift.3A.20.60fpromote.2Ef32.60.20seems.20no.2E.2E.2E.html">wasmtime / issue #9654 Cranelift: `fpromote.f32` seems no...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="483860002"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239654%20Cranelift%3A%20%60fpromote.f32%60%20seems%20no.../near/483860002" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239654.20Cranelift.3A.20.60fpromote.2Ef32.60.20seems.20no.2E.2E.2E.html#483860002">(Nov 22 2024 at 08:35)</a>:</h4>
<p>abc767234318 opened <a href="https://github.com/bytecodealliance/wasmtime/issues/9654">issue #9654</a>:</p>
<blockquote>
<p>I constructed a clif file. <br>
<a href="https://github.com/user-attachments/files/17867284/multi_func0.zip">multi_func0.zip</a><br>
I used the following command to run it.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="n">file_tests</span><span class="o">/</span><span class="n">multi_func0</span><span class="p">.</span><span class="n">clif</span>
</code></pre></div>
<p>But I got following error:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">machinst</span><span class="o">/</span><span class="n">lower</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">685</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span>
<span class="nc">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">implemented</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ISLE</span><span class="p">:</span><span class="w"> </span><span class="nc">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">`</span><span class="n">v37</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fpromote</span><span class="p">.</span><span class="kt">f32</span><span class="w"> </span><span class="n">v19</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">`</span><span class="nb">Some</span><span class="p">(</span><span class="n">types</span><span class="p">::</span><span class="n">F32</span><span class="p">)</span><span class="err">`</span>
<span class="n">note</span><span class="p">:</span><span class="w"> </span><span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span>
</code></pre></div>
</blockquote>



<a name="483860041"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239654%20Cranelift%3A%20%60fpromote.f32%60%20seems%20no.../near/483860041" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239654.20Cranelift.3A.20.60fpromote.2Ef32.60.20seems.20no.2E.2E.2E.html#483860041">(Nov 22 2024 at 08:35)</a>:</h4>
<p>abc767234318 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/9654">issue #9654</a>:</p>
<blockquote>
<p>I constructed a clif file. <br>
<a href="https://github.com/user-attachments/files/17867284/multi_func0.zip">multi_func0.zip</a><br>
I used the following command to run it.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="n">file_tests</span><span class="o">/</span><span class="n">multi_func0</span><span class="p">.</span><span class="n">clif</span>
</code></pre></div>
<p>But I got the following error:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">machinst</span><span class="o">/</span><span class="n">lower</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">685</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span>
<span class="nc">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">implemented</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ISLE</span><span class="p">:</span><span class="w"> </span><span class="nc">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">`</span><span class="n">v37</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fpromote</span><span class="p">.</span><span class="kt">f32</span><span class="w"> </span><span class="n">v19</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">`</span><span class="nb">Some</span><span class="p">(</span><span class="n">types</span><span class="p">::</span><span class="n">F32</span><span class="p">)</span><span class="err">`</span>
<span class="n">note</span><span class="p">:</span><span class="w"> </span><span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span>
</code></pre></div>
</blockquote>



<a name="483868704"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239654%20Cranelift%3A%20%60fpromote.f32%60%20seems%20no.../near/483868704" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239654.20Cranelift.3A.20.60fpromote.2Ef32.60.20seems.20no.2E.2E.2E.html#483868704">(Nov 22 2024 at 09:23)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/9654#issuecomment-2493300518">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9654">issue #9654</a>:</p>
<blockquote>
<p><code>fpromote</code> requires a float as input, not an i16. If you run the clif ir verifier on this input file it will likely catch this issue. Also please try to use bugpoint in the future to reduce your test case: <a href="https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/src/bugpoint.rs">https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/src/bugpoint.rs</a> Something like <code>cd cranelift; cargo run -- bugpoint multi_func0.clif x86_64</code> would have worked in this particular case I think.</p>
</blockquote>



<a name="483872283"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239654%20Cranelift%3A%20%60fpromote.f32%60%20seems%20no.../near/483872283" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239654.20Cranelift.3A.20.60fpromote.2Ef32.60.20seems.20no.2E.2E.2E.html#483872283">(Nov 22 2024 at 09:43)</a>:</h4>
<p>abc767234318 <a href="https://github.com/bytecodealliance/wasmtime/issues/9654#issuecomment-2493341656">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9654">issue #9654</a>:</p>
<blockquote>
<blockquote>
<p><code>fpromote</code> requires a float as input, not an i16. If you run the clif ir verifier on this input file it will likely catch this issue. Also please try to use bugpoint in the future to reduce your test case: <a href="https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/src/bugpoint.rs">https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/src/bugpoint.rs</a> Something like <code>cd cranelift; cargo run -- bugpoint multi_func0.clif x86_64</code> would have worked in this particular case I think.</p>
</blockquote>
<p>Why the type of <code>v19</code> is <code>i16</code>? The <code>v19</code> is generated by the following two instructions.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">line</span><span class="w"> </span><span class="mi">678</span><span class="p">:</span><span class="w">  </span><span class="nc">v7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f16const</span><span class="w"> </span><span class="o">-</span><span class="mh">0x1</span><span class="p">.</span><span class="mi">774</span><span class="n">p</span><span class="o">-</span><span class="mi">9</span>
<span class="n">line</span><span class="w"> </span><span class="mi">741</span><span class="p">:</span><span class="w">  </span><span class="nc">v19</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bnot</span><span class="p">.</span><span class="n">f16</span><span class="w"> </span><span class="n">v7</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mh">0x1</span><span class="p">.</span><span class="mi">774</span><span class="n">p</span><span class="o">-</span><span class="mi">9</span>
</code></pre></div>
<p>My understanding is that the type of <code>v19</code> is <code>f16</code>, not sure what is wrong</p>
</blockquote>



<a name="483877676"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239654%20Cranelift%3A%20%60fpromote.f32%60%20seems%20no.../near/483877676" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239654.20Cranelift.3A.20.60fpromote.2Ef32.60.20seems.20no.2E.2E.2E.html#483877676">(Nov 22 2024 at 10:12)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/9654#issuecomment-2493398118">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9654">issue #9654</a>:</p>
<blockquote>
<p>I didn't notice that you had multiple functions in the clif file.</p>
<p>f16 and f128 is currently basically unsupported in Cranelift. Anything beyond passing around f16 and f128 values should be assumed to not yet be implemented.</p>
</blockquote>



<a name="484454820"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239654%20Cranelift%3A%20%60fpromote.f32%60%20seems%20no.../near/484454820" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239654.20Cranelift.3A.20.60fpromote.2Ef32.60.20seems.20no.2E.2E.2E.html#484454820">(Nov 26 2024 at 08:14)</a>:</h4>
<p>abc767234318 closed <a href="https://github.com/bytecodealliance/wasmtime/issues/9654">issue #9654</a>:</p>
<blockquote>
<p>I constructed a clif file. <br>
<a href="https://github.com/user-attachments/files/17867284/multi_func0.zip">multi_func0.zip</a><br>
I used the following command to run it.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="n">file_tests</span><span class="o">/</span><span class="n">multi_func0</span><span class="p">.</span><span class="n">clif</span>
</code></pre></div>
<p>But I got the following error:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">machinst</span><span class="o">/</span><span class="n">lower</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">685</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span>
<span class="nc">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">implemented</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ISLE</span><span class="p">:</span><span class="w"> </span><span class="nc">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">`</span><span class="n">v37</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fpromote</span><span class="p">.</span><span class="kt">f32</span><span class="w"> </span><span class="n">v19</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">`</span><span class="nb">Some</span><span class="p">(</span><span class="n">types</span><span class="p">::</span><span class="n">F32</span><span class="p">)</span><span class="err">`</span>
<span class="n">note</span><span class="p">:</span><span class="w"> </span><span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span>
</code></pre></div>
</blockquote>



<a name="484454825"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239654%20Cranelift%3A%20%60fpromote.f32%60%20seems%20no.../near/484454825" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239654.20Cranelift.3A.20.60fpromote.2Ef32.60.20seems.20no.2E.2E.2E.html#484454825">(Nov 26 2024 at 08:15)</a>:</h4>
<p>abc767234318 <a href="https://github.com/bytecodealliance/wasmtime/issues/9654#issuecomment-2499947050">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9654">issue #9654</a>:</p>
<blockquote>
<blockquote>
<p>I didn't notice that you had multiple functions in the clif file.</p>
<p>f16 and f128 is currently basically unsupported in Cranelift. Anything beyond passing around f16 and f128 values should be assumed to not yet be implemented.</p>
</blockquote>
<p>Thank you very much, I will close this issue.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>