<html>
<head><meta charset="utf-8"><title>wasmtime / issue #4498 Cranelift: `br_table.i128` not imp... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234498.20Cranelift.3A.20.60br_table.2Ei128.60.20not.20imp.2E.2E.2E.html">wasmtime / issue #4498 Cranelift: `br_table.i128` not imp...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="290397412"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234498%20Cranelift%3A%20%60br_table.i128%60%20not%20imp.../near/290397412" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234498.20Cranelift.3A.20.60br_table.2Ei128.60.20not.20imp.2E.2E.2E.html#290397412">(Jul 21 2022 at 16:13)</a>:</h4>
<p>afonso360 labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/4498">issue #4498</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span>  Hey,</p>
<p>Fuzzgen found this when I added i128 support.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">br</span><span class="p">(</span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="nc">system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">jt0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jump_table</span><span class="w"> </span><span class="p">[</span><span class="n">block1</span><span class="p">,</span><span class="w"> </span><span class="n">block1</span><span class="p">,</span><span class="w"> </span><span class="n">block1</span><span class="p">]</span><span class="w"></span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i128</span><span class="p">)</span>:
    <span class="nc">br_table</span><span class="w"> </span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">block1</span><span class="p">,</span><span class="w"> </span><span class="n">jt0</span><span class="w"></span>
<span class="n">block1</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li>Run <code>cargo run -- compile -D --set enable_llvm_abi_extensions  --target x86_64 .\the-above.clif</code></li>
</ul>
<h3>Expected Results</h3>
<p>The code to compile</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">C</span>:<span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">Afonso</span><span class="err">\</span><span class="n">CLionProjects</span><span class="err">\</span><span class="n">wasmtime</span><span class="err">\</span><span class="n">target</span><span class="err">\</span><span class="n">debug</span><span class="err">\</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="p">.</span><span class="n">exe</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">-</span><span class="n">D</span><span class="w"> </span><span class="o">--</span><span class="n">set</span><span class="w"> </span><span class="n">enable_llvm_abi_extensions</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"> </span><span class="p">.</span><span class="err">\</span><span class="n">test</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span><span class="w"></span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">BrTable</span><span class="w"> </span><span class="n">unimplemented</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">I128</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">cranelift</span><span class="err">\</span><span class="n">codegen</span><span class="err">\</span><span class="n">src</span><span class="err">\</span><span class="n">isa</span><span class="err">\</span><span class="n">x64</span><span class="err">\</span><span class="n">lower</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">3248</span>:<span class="mi">40</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span><span class="w"></span>
<span class="n">error</span>: <span class="nc">process</span><span class="w"> </span><span class="n">didn</span><span class="o">'</span><span class="na">t</span><span class="w"> </span><span class="n">exit</span><span class="w"> </span><span class="n">successfully</span>: <span class="err">`</span><span class="n">C</span>:<span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">Afonso</span><span class="err">\</span><span class="n">CLionProjects</span><span class="err">\</span><span class="n">wasmtime</span><span class="err">\</span><span class="n">target</span><span class="err">\</span><span class="n">debug</span><span class="err">\</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="p">.</span><span class="n">exe</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">-</span><span class="n">D</span><span class="w"> </span><span class="o">--</span><span class="n">set</span><span class="w"> </span><span class="n">enable_llvm_abi_extensions</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"> </span><span class="p">.</span><span class="err">\</span><span class="n">test</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span><span class="w"> </span><span class="p">(</span><span class="n">exit</span><span class="w"> </span><span class="n">code</span>: <span class="mi">101</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: <code>main</code><br>
Operating system: Windows<br>
Architecture: x86_64</p>
<p>cc @abrown @jlb6740</p>
</blockquote>



<a name="290397413"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234498%20Cranelift%3A%20%60br_table.i128%60%20not%20imp.../near/290397413" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234498.20Cranelift.3A.20.60br_table.2Ei128.60.20not.20imp.2E.2E.2E.html#290397413">(Jul 21 2022 at 16:13)</a>:</h4>
<p>afonso360 opened <a href="https://github.com/bytecodealliance/wasmtime/issues/4498">issue #4498</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span>  Hey,</p>
<p>Fuzzgen found this when I added i128 support.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">br</span><span class="p">(</span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="nc">system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">jt0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jump_table</span><span class="w"> </span><span class="p">[</span><span class="n">block1</span><span class="p">,</span><span class="w"> </span><span class="n">block1</span><span class="p">,</span><span class="w"> </span><span class="n">block1</span><span class="p">]</span><span class="w"></span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i128</span><span class="p">)</span>:
    <span class="nc">br_table</span><span class="w"> </span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">block1</span><span class="p">,</span><span class="w"> </span><span class="n">jt0</span><span class="w"></span>
<span class="n">block1</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li>Run <code>cargo run -- compile -D --set enable_llvm_abi_extensions  --target x86_64 .\the-above.clif</code></li>
</ul>
<h3>Expected Results</h3>
<p>The code to compile</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">C</span>:<span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">Afonso</span><span class="err">\</span><span class="n">CLionProjects</span><span class="err">\</span><span class="n">wasmtime</span><span class="err">\</span><span class="n">target</span><span class="err">\</span><span class="n">debug</span><span class="err">\</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="p">.</span><span class="n">exe</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">-</span><span class="n">D</span><span class="w"> </span><span class="o">--</span><span class="n">set</span><span class="w"> </span><span class="n">enable_llvm_abi_extensions</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"> </span><span class="p">.</span><span class="err">\</span><span class="n">test</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span><span class="w"></span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">BrTable</span><span class="w"> </span><span class="n">unimplemented</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">I128</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">cranelift</span><span class="err">\</span><span class="n">codegen</span><span class="err">\</span><span class="n">src</span><span class="err">\</span><span class="n">isa</span><span class="err">\</span><span class="n">x64</span><span class="err">\</span><span class="n">lower</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">3248</span>:<span class="mi">40</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span><span class="w"></span>
<span class="n">error</span>: <span class="nc">process</span><span class="w"> </span><span class="n">didn</span><span class="o">'</span><span class="na">t</span><span class="w"> </span><span class="n">exit</span><span class="w"> </span><span class="n">successfully</span>: <span class="err">`</span><span class="n">C</span>:<span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">Afonso</span><span class="err">\</span><span class="n">CLionProjects</span><span class="err">\</span><span class="n">wasmtime</span><span class="err">\</span><span class="n">target</span><span class="err">\</span><span class="n">debug</span><span class="err">\</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="p">.</span><span class="n">exe</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">-</span><span class="n">D</span><span class="w"> </span><span class="o">--</span><span class="n">set</span><span class="w"> </span><span class="n">enable_llvm_abi_extensions</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"> </span><span class="p">.</span><span class="err">\</span><span class="n">test</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span><span class="w"> </span><span class="p">(</span><span class="n">exit</span><span class="w"> </span><span class="n">code</span>: <span class="mi">101</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: <code>main</code><br>
Operating system: Windows<br>
Architecture: x86_64</p>
<p>cc @abrown @jlb6740</p>
</blockquote>



<a name="290397415"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234498%20Cranelift%3A%20%60br_table.i128%60%20not%20imp.../near/290397415" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234498.20Cranelift.3A.20.60br_table.2Ei128.60.20not.20imp.2E.2E.2E.html#290397415">(Jul 21 2022 at 16:13)</a>:</h4>
<p>afonso360 labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/4498">issue #4498</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span>  Hey,</p>
<p>Fuzzgen found this when I added i128 support.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">br</span><span class="p">(</span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="nc">system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">jt0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jump_table</span><span class="w"> </span><span class="p">[</span><span class="n">block1</span><span class="p">,</span><span class="w"> </span><span class="n">block1</span><span class="p">,</span><span class="w"> </span><span class="n">block1</span><span class="p">]</span><span class="w"></span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i128</span><span class="p">)</span>:
    <span class="nc">br_table</span><span class="w"> </span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">block1</span><span class="p">,</span><span class="w"> </span><span class="n">jt0</span><span class="w"></span>
<span class="n">block1</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li>Run <code>cargo run -- compile -D --set enable_llvm_abi_extensions  --target x86_64 .\the-above.clif</code></li>
</ul>
<h3>Expected Results</h3>
<p>The code to compile</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">C</span>:<span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">Afonso</span><span class="err">\</span><span class="n">CLionProjects</span><span class="err">\</span><span class="n">wasmtime</span><span class="err">\</span><span class="n">target</span><span class="err">\</span><span class="n">debug</span><span class="err">\</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="p">.</span><span class="n">exe</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">-</span><span class="n">D</span><span class="w"> </span><span class="o">--</span><span class="n">set</span><span class="w"> </span><span class="n">enable_llvm_abi_extensions</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"> </span><span class="p">.</span><span class="err">\</span><span class="n">test</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span><span class="w"></span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">BrTable</span><span class="w"> </span><span class="n">unimplemented</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">I128</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">cranelift</span><span class="err">\</span><span class="n">codegen</span><span class="err">\</span><span class="n">src</span><span class="err">\</span><span class="n">isa</span><span class="err">\</span><span class="n">x64</span><span class="err">\</span><span class="n">lower</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">3248</span>:<span class="mi">40</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span><span class="w"></span>
<span class="n">error</span>: <span class="nc">process</span><span class="w"> </span><span class="n">didn</span><span class="o">'</span><span class="na">t</span><span class="w"> </span><span class="n">exit</span><span class="w"> </span><span class="n">successfully</span>: <span class="err">`</span><span class="n">C</span>:<span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">Afonso</span><span class="err">\</span><span class="n">CLionProjects</span><span class="err">\</span><span class="n">wasmtime</span><span class="err">\</span><span class="n">target</span><span class="err">\</span><span class="n">debug</span><span class="err">\</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="p">.</span><span class="n">exe</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">-</span><span class="n">D</span><span class="w"> </span><span class="o">--</span><span class="n">set</span><span class="w"> </span><span class="n">enable_llvm_abi_extensions</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"> </span><span class="p">.</span><span class="err">\</span><span class="n">test</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span><span class="w"> </span><span class="p">(</span><span class="n">exit</span><span class="w"> </span><span class="n">code</span>: <span class="mi">101</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: <code>main</code><br>
Operating system: Windows<br>
Architecture: x86_64</p>
<p>cc @abrown @jlb6740</p>
</blockquote>



<a name="290410700"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234498%20Cranelift%3A%20%60br_table.i128%60%20not%20imp.../near/290410700" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234498.20Cranelift.3A.20.60br_table.2Ei128.60.20not.20imp.2E.2E.2E.html#290410700">(Jul 21 2022 at 17:54)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/4498#issuecomment-1191774677">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4498">issue #4498</a>:</p>
<blockquote>
<p><code>cranelift_frontend::Switch</code> has a workaround for this in place already: <a href="https://github.com/bytecodealliance/wasmtime/blob/6e05b646a32fe00c390cc2322b1d7d3571526a9a/cranelift/frontend/src/switch.rs#L267-L280">https://github.com/bytecodealliance/wasmtime/blob/6e05b646a32fe00c390cc2322b1d7d3571526a9a/cranelift/frontend/src/switch.rs#L267-L280</a></p>
</blockquote>



<a name="290413708"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234498%20Cranelift%3A%20%60br_table.i128%60%20not%20imp.../near/290413708" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234498.20Cranelift.3A.20.60br_table.2Ei128.60.20not.20imp.2E.2E.2E.html#290413708">(Jul 21 2022 at 18:18)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/issues/4498#issuecomment-1191796443">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4498">issue #4498</a>:</p>
<blockquote>
<p>That just reminded me that we had a similar issue previously #3100.</p>
<p>I tried to add a panic to that branch and it isn't being triggered, ill investigate further.</p>
</blockquote>



<a name="290414182"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234498%20Cranelift%3A%20%60br_table.i128%60%20not%20imp.../near/290414182" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234498.20Cranelift.3A.20.60br_table.2Ei128.60.20not.20imp.2E.2E.2E.html#290414182">(Jul 21 2022 at 18:22)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4498#issuecomment-1191796443">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4498">issue #4498</a>:</p>
<blockquote>
<p>That just reminded me that we had a similar issue previously #3100.</p>
<p>I tried to add a panic to that branch and it isn't being triggered, ill investigate further.</p>
<p>Edit: I suspect that patch only applies to the <code>Switch</code> interface of the frontend, and not when building jump tables manually and then inserting <code>br_tables</code><br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/6e05b646a32fe00c390cc2322b1d7d3571526a9a/cranelift/frontend/src/switch.rs#L10-L41">https://github.com/bytecodealliance/wasmtime/blob/6e05b646a32fe00c390cc2322b1d7d3571526a9a/cranelift/frontend/src/switch.rs#L10-L41</a></p>
</blockquote>



<a name="290414220"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234498%20Cranelift%3A%20%60br_table.i128%60%20not%20imp.../near/290414220" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234498.20Cranelift.3A.20.60br_table.2Ei128.60.20not.20imp.2E.2E.2E.html#290414220">(Jul 21 2022 at 18:23)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4498#issuecomment-1191796443">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4498">issue #4498</a>:</p>
<blockquote>
<p>That just reminded me that we had a similar issue previously #3100.</p>
<p>I tried to add a panic to that branch and it isn't being triggered, ill investigate further.</p>
<p>Edit: I suspect that workaround only applies to the <code>Switch</code> interface of the frontend, and not when building jump tables manually and then inserting <code>br_tables</code><br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/6e05b646a32fe00c390cc2322b1d7d3571526a9a/cranelift/frontend/src/switch.rs#L10-L41">https://github.com/bytecodealliance/wasmtime/blob/6e05b646a32fe00c390cc2322b1d7d3571526a9a/cranelift/frontend/src/switch.rs#L10-L41</a></p>
</blockquote>



<a name="290415251"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234498%20Cranelift%3A%20%60br_table.i128%60%20not%20imp.../near/290415251" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234498.20Cranelift.3A.20.60br_table.2Ei128.60.20not.20imp.2E.2E.2E.html#290415251">(Jul 21 2022 at 18:31)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/4498#issuecomment-1191806928">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4498">issue #4498</a>:</p>
<blockquote>
<blockquote>
<p>Edit: I suspect that workaround only applies to the Switch interface of the frontend, and not when building jump tables manually and then inserting br_tables</p>
</blockquote>
<p>Indeed. Should have been clearer.</p>
</blockquote>



<a name="290416180"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234498%20Cranelift%3A%20%60br_table.i128%60%20not%20imp.../near/290416180" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234498.20Cranelift.3A.20.60br_table.2Ei128.60.20not.20imp.2E.2E.2E.html#290416180">(Jul 21 2022 at 18:38)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/issues/4498#issuecomment-1191814006">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4498">issue #4498</a>:</p>
<blockquote>
<p>I guess <code>br_table</code> on an <code>i128</code> is useless, right? It's going to be a while before anyone has enough memory for a table that big. <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>
<p>For the purposes of cranelift-fuzzgen it'd be nice to have all operations support all types, but I imagine implementing this in each target backend requires extra code that isn't going to be exercised any other way. So I'm thinking it'd be better to just declare that <code>br_table</code> doesn't support <code>i128</code> (or <code>i64</code> either?) and avoid trying to generate such cases.</p>
<p>@cfallin, what's your take?</p>
</blockquote>



<a name="290417120"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234498%20Cranelift%3A%20%60br_table.i128%60%20not%20imp.../near/290417120" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234498.20Cranelift.3A.20.60br_table.2Ei128.60.20not.20imp.2E.2E.2E.html#290417120">(Jul 21 2022 at 18:45)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/issues/4498#issuecomment-1191819339">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4498">issue #4498</a>:</p>
<blockquote>
<p>Yeah, we don't even support tables larger than u32, so...</p>
<blockquote>
<p>For the purposes of cranelift-fuzzgen it'd be nice to have all operations support all types</p>
</blockquote>
<p>We special case emissions of <code>br_table</code>'s in fuzzgen, so we can disable it quite easly.</p>
<blockquote>
<p>So I'm thinking it'd be better to just declare that br_table doesn't support i128 (or i64 either?) </p>
</blockquote>
<p>I think this is probably a good idea. Or we can do what we do in the <code>Switch</code> interface (patch it down to a i32) in some place that also targets <code>br_table</code>, that way we don't get the hole in the api.</p>
</blockquote>



<a name="290417157"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234498%20Cranelift%3A%20%60br_table.i128%60%20not%20imp.../near/290417157" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234498.20Cranelift.3A.20.60br_table.2Ei128.60.20not.20imp.2E.2E.2E.html#290417157">(Jul 21 2022 at 18:45)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/4498#issuecomment-1191819550">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4498">issue #4498</a>:</p>
<blockquote>
<blockquote>
<p>I guess br_table on an i128 is useless, right? It's going to be a while before anyone has enough memory for a table that big. laughing</p>
</blockquote>
<p>Rustc allows matching on 128bit integers and enums. That is why <code>cranelift_frontend::Switch</code> has a workaround for this. I'm lowering the MIR <code>SwitchInt</code> terminator using <code>cranelift_frontend::Switch</code>.</p>
</blockquote>



<a name="290419756"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234498%20Cranelift%3A%20%60br_table.i128%60%20not%20imp.../near/290419756" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234498.20Cranelift.3A.20.60br_table.2Ei128.60.20not.20imp.2E.2E.2E.html#290419756">(Jul 21 2022 at 19:03)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/4498#issuecomment-1191833495">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4498">issue #4498</a>:</p>
<blockquote>
<blockquote>
<p>I guess <code>br_table</code> on an <code>i128</code> is useless, right? It's going to be a while before anyone has enough memory for a table that big. <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>
<p>For the purposes of cranelift-fuzzgen it'd be nice to have all operations support all types, but I imagine implementing this in each target backend requires extra code that isn't going to be exercised any other way. So I'm thinking it'd be better to just declare that <code>br_table</code> doesn't support <code>i128</code> (or <code>i64</code> either?) and avoid trying to generate such cases.</p>
<p>@cfallin, what's your take?</p>
</blockquote>
<p>In general I'm in favor of more completeness, or at least symmetry -- the more our "supported instruction/operand space" looks like a high-dimensional rectangular prism, rather than a weird shape with lots of divots, the easier for our users. But I think that impulse should also be tempered by practicalities so we don't have blowup in the backends' pattern-matching, as that can lead to issues (copy/paste typos, difficulty of maintenance) as well.</p>
<p>I might actually propose a slightly different approach: could <code>br_table</code> take <code>i32</code> <em>only</em>? My path to thinking that is that being polymorphic except for one unsupported type (<code>i128</code>) is actually leading users into a false sense of flexibility. And supporting narrow values has potential pitfalls too (I believe it works correctly now but rare cases are a risk both for new backends and during ongoing refactoring/improvements). A consistent mental model that supports this view (IMHO) is to think of the selector index as morally equivalent to a jump address, kind of. Addresses have a fixed width (64 bits on all our current platforms); so why not br_table indices (hereby declared to be 32 bits), as well?</p>
</blockquote>



<a name="290420754"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234498%20Cranelift%3A%20%60br_table.i128%60%20not%20imp.../near/290420754" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234498.20Cranelift.3A.20.60br_table.2Ei128.60.20not.20imp.2E.2E.2E.html#290420754">(Jul 21 2022 at 19:11)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/4498#issuecomment-1191840080">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4498">issue #4498</a>:</p>
<blockquote>
<p>For <code>br_table.i8</code> I think that would lead to a pessimization. For example if there are 256 entries, it wouldn't need to check if the input value is larger than 255 to jump to the default branch when using <code>br_table.i8</code>, but it would need to be for <code>br_table.i32</code>.</p>
</blockquote>



<a name="290425589"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234498%20Cranelift%3A%20%60br_table.i128%60%20not%20imp.../near/290425589" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234498.20Cranelift.3A.20.60br_table.2Ei128.60.20not.20imp.2E.2E.2E.html#290425589">(Jul 21 2022 at 19:53)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/4498#issuecomment-1191873911">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4498">issue #4498</a>:</p>
<blockquote>
<p>That's true, but we don't currently do such an optimization; and in the future, we could in a more general way by doing an integer range analysis. Such an analysis would have a rule that a uextend from an <code>i8</code> gives a result in range 0..256. I suspect that's a more general approach than a special case of range analysis based on types.</p>
</blockquote>



<a name="290578953"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234498%20Cranelift%3A%20%60br_table.i128%60%20not%20imp.../near/290578953" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234498.20Cranelift.3A.20.60br_table.2Ei128.60.20not.20imp.2E.2E.2E.html#290578953">(Jul 22 2022 at 23:32)</a>:</h4>
<p>jameysharp closed <a href="https://github.com/bytecodealliance/wasmtime/issues/4498">issue #4498</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span>  Hey,</p>
<p>Fuzzgen found this when I added i128 support.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">br</span><span class="p">(</span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="nc">system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">jt0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jump_table</span><span class="w"> </span><span class="p">[</span><span class="n">block1</span><span class="p">,</span><span class="w"> </span><span class="n">block1</span><span class="p">,</span><span class="w"> </span><span class="n">block1</span><span class="p">]</span><span class="w"></span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i128</span><span class="p">)</span>:
    <span class="nc">br_table</span><span class="w"> </span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">block1</span><span class="p">,</span><span class="w"> </span><span class="n">jt0</span><span class="w"></span>
<span class="n">block1</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li>Run <code>cargo run -- compile -D --set enable_llvm_abi_extensions  --target x86_64 .\the-above.clif</code></li>
</ul>
<h3>Expected Results</h3>
<p>The code to compile</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">C</span>:<span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">Afonso</span><span class="err">\</span><span class="n">CLionProjects</span><span class="err">\</span><span class="n">wasmtime</span><span class="err">\</span><span class="n">target</span><span class="err">\</span><span class="n">debug</span><span class="err">\</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="p">.</span><span class="n">exe</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">-</span><span class="n">D</span><span class="w"> </span><span class="o">--</span><span class="n">set</span><span class="w"> </span><span class="n">enable_llvm_abi_extensions</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"> </span><span class="p">.</span><span class="err">\</span><span class="n">test</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span><span class="w"></span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">BrTable</span><span class="w"> </span><span class="n">unimplemented</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">I128</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">cranelift</span><span class="err">\</span><span class="n">codegen</span><span class="err">\</span><span class="n">src</span><span class="err">\</span><span class="n">isa</span><span class="err">\</span><span class="n">x64</span><span class="err">\</span><span class="n">lower</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">3248</span>:<span class="mi">40</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span><span class="w"></span>
<span class="n">error</span>: <span class="nc">process</span><span class="w"> </span><span class="n">didn</span><span class="o">'</span><span class="na">t</span><span class="w"> </span><span class="n">exit</span><span class="w"> </span><span class="n">successfully</span>: <span class="err">`</span><span class="n">C</span>:<span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">Afonso</span><span class="err">\</span><span class="n">CLionProjects</span><span class="err">\</span><span class="n">wasmtime</span><span class="err">\</span><span class="n">target</span><span class="err">\</span><span class="n">debug</span><span class="err">\</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="p">.</span><span class="n">exe</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">-</span><span class="n">D</span><span class="w"> </span><span class="o">--</span><span class="n">set</span><span class="w"> </span><span class="n">enable_llvm_abi_extensions</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"> </span><span class="p">.</span><span class="err">\</span><span class="n">test</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span><span class="w"> </span><span class="p">(</span><span class="n">exit</span><span class="w"> </span><span class="n">code</span>: <span class="mi">101</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: <code>main</code><br>
Operating system: Windows<br>
Architecture: x86_64</p>
<p>cc @abrown @jlb6740</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>