<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #1539 Cranelift aarch64 backend: improve... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231539.20Cranelift.20aarch64.20backend.3A.20improve.2E.2E.2E.html">wasmtime / Issue #1539 Cranelift aarch64 backend: improve...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="194472092"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231539%20Cranelift%20aarch64%20backend%3A%20improve.../near/194472092" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231539.20Cranelift.20aarch64.20backend.3A.20improve.2E.2E.2E.html#194472092">(Apr 17 2020 at 17:13)</a>:</h4>
<p>cfallin opened <a href="https://github.com/bytecodealliance/wasmtime/issues/1539" title="https://github.com/bytecodealliance/wasmtime/issues/1539">Issue #1539</a>:</p>
<blockquote>
<p>Right now, the <code>vcode</code> filetest matches the pretty-printed assembly with the filecheck directives. To test the new aarch64 backend, we've written a bunch of filetests that match against a golden compilation. This works for now, but is somewhat brittle: if regalloc heuristics change which registers are used, the tests need to be updated. In addition, it requires us to match the whole function body to ensure that nothing else was generated, when all we really want to do is to assert that a <em>particular</em> operation was implemented by only these N instructions. We should look into porting or building an equivalent of the old backend's "assert this instruction has this encoding" functionality, and its register constraints that make tests more robust.</p>
</blockquote>



<a name="194472147"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231539%20Cranelift%20aarch64%20backend%3A%20improve.../near/194472147" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231539.20Cranelift.20aarch64.20backend.3A.20improve.2E.2E.2E.html#194472147">(Apr 17 2020 at 17:13)</a>:</h4>
<p>cfallin labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/1539" title="https://github.com/bytecodealliance/wasmtime/issues/1539">Issue #1539</a>:</p>
<blockquote>
<p>Right now, the <code>vcode</code> filetest matches the pretty-printed assembly with the filecheck directives. To test the new aarch64 backend, we've written a bunch of filetests that match against a golden compilation. This works for now, but is somewhat brittle: if regalloc heuristics change which registers are used, the tests need to be updated. In addition, it requires us to match the whole function body to ensure that nothing else was generated, when all we really want to do is to assert that a <em>particular</em> operation was implemented by only these N instructions. We should look into porting or building an equivalent of the old backend's "assert this instruction has this encoding" functionality, and its register constraints that make tests more robust.</p>
</blockquote>



<a name="194472148"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231539%20Cranelift%20aarch64%20backend%3A%20improve.../near/194472148" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231539.20Cranelift.20aarch64.20backend.3A.20improve.2E.2E.2E.html#194472148">(Apr 17 2020 at 17:13)</a>:</h4>
<p>cfallin labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/1539" title="https://github.com/bytecodealliance/wasmtime/issues/1539">Issue #1539</a>:</p>
<blockquote>
<p>Right now, the <code>vcode</code> filetest matches the pretty-printed assembly with the filecheck directives. To test the new aarch64 backend, we've written a bunch of filetests that match against a golden compilation. This works for now, but is somewhat brittle: if regalloc heuristics change which registers are used, the tests need to be updated. In addition, it requires us to match the whole function body to ensure that nothing else was generated, when all we really want to do is to assert that a <em>particular</em> operation was implemented by only these N instructions. We should look into porting or building an equivalent of the old backend's "assert this instruction has this encoding" functionality, and its register constraints that make tests more robust.</p>
</blockquote>



<a name="194474029"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231539%20Cranelift%20aarch64%20backend%3A%20improve.../near/194474029" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231539.20Cranelift.20aarch64.20backend.3A.20improve.2E.2E.2E.html#194474029">(Apr 17 2020 at 17:28)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/1539#issuecomment-615370913" title="https://github.com/bytecodealliance/wasmtime/issues/1539#issuecomment-615370913">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1539" title="https://github.com/bytecodealliance/wasmtime/issues/1539">Issue #1539</a>:</p>
<blockquote>
<p>Did you know about the regex match functionality of filetest?</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/86ff6d7aef8017da4b77b9b8d69a71c4a2b443cb/cranelift/filetests/filetests/regalloc/coalesce.clif#L5" title="https://github.com/bytecodealliance/wasmtime/blob/86ff6d7aef8017da4b77b9b8d69a71c4a2b443cb/cranelift/filetests/filetests/regalloc/coalesce.clif#L5">https://github.com/bytecodealliance/wasmtime/blob/86ff6d7aef8017da4b77b9b8d69a71c4a2b443cb/cranelift/filetests/filetests/regalloc/coalesce.clif#L5</a></p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/86ff6d7aef8017da4b77b9b8d69a71c4a2b443cb/cranelift/filetests/filetests/regalloc/coalesce.clif#L40-L41" title="https://github.com/bytecodealliance/wasmtime/blob/86ff6d7aef8017da4b77b9b8d69a71c4a2b443cb/cranelift/filetests/filetests/regalloc/coalesce.clif#L40-L41">https://github.com/bytecodealliance/wasmtime/blob/86ff6d7aef8017da4b77b9b8d69a71c4a2b443cb/cranelift/filetests/filetests/regalloc/coalesce.clif#L40-L41</a></p>
</blockquote>



<a name="194475682"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231539%20Cranelift%20aarch64%20backend%3A%20improve.../near/194475682" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231539.20Cranelift.20aarch64.20backend.3A.20improve.2E.2E.2E.html#194475682">(Apr 17 2020 at 17:42)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/1539#issuecomment-615377231" title="https://github.com/bytecodealliance/wasmtime/issues/1539#issuecomment-615377231">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1539" title="https://github.com/bytecodealliance/wasmtime/issues/1539">Issue #1539</a>:</p>
<blockquote>
<p>FWIW one technique which has worked out really well for the Rust project and others I've seen is to have exhaustive assertions about the output (like it seems you're describing is the current state today), but also having a way to auto-update the assertion. This means that at a glance you can always see the complete output of something (such as the full function in all its glory) but if you make a minor tweak to epilogue generation you can easily update the whole test suite. Reviewing is generally quite easy too because you're either looking at something entirely new in which case you can review it in detail, or you're reviewing changes to what was already there so you can easily spot things which may have accidentally changed but shouldn't have.</p>
<p>The way this typically works is there's some sort of opt-in "bless" option. With rust-lang/rust it's <code>./x.py test --bless</code> but with some projects I've worked on it's just <code>BLESS=1 cargo test</code>. My workflow is generally to write a test and then always use <code>BLESS=1</code>, reviewing the output manually to make sure it looks ok.</p>
<p>I'd be happy to help prototype this if folks think it's a good idea.</p>
</blockquote>



<a name="194515910"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231539%20Cranelift%20aarch64%20backend%3A%20improve.../near/194515910" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231539.20Cranelift.20aarch64.20backend.3A.20improve.2E.2E.2E.html#194515910">(Apr 18 2020 at 00:21)</a>:</h4>
<p>cfallin labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/1539" title="https://github.com/bytecodealliance/wasmtime/issues/1539">Issue #1539</a>:</p>
<blockquote>
<p>Right now, the <code>vcode</code> filetest matches the pretty-printed assembly with the filecheck directives. To test the new aarch64 backend, we've written a bunch of filetests that match against a golden compilation. This works for now, but is somewhat brittle: if regalloc heuristics change which registers are used, the tests need to be updated. In addition, it requires us to match the whole function body to ensure that nothing else was generated, when all we really want to do is to assert that a <em>particular</em> operation was implemented by only these N instructions. We should look into porting or building an equivalent of the old backend's "assert this instruction has this encoding" functionality, and its register constraints that make tests more robust.</p>
</blockquote>



<a name="209674121"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231539%20Cranelift%20aarch64%20backend%3A%20improve.../near/209674121" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231539.20Cranelift.20aarch64.20backend.3A.20improve.2E.2E.2E.html#209674121">(Sep 10 2020 at 16:39)</a>:</h4>
<p>akirilov-arm <a href="https://github.com/bytecodealliance/wasmtime/issues/1539#issuecomment-690475368">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1539">Issue #1539</a>:</p>
<blockquote>
<p>This issue is going to be a major headache for any attempt to fix #1148 in the AArch64 backend.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>