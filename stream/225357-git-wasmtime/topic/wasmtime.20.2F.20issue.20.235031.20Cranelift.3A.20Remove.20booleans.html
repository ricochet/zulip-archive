<html>
<head><meta charset="utf-8"><title>wasmtime / issue #5031 Cranelift: Remove booleans · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235031.20Cranelift.3A.20Remove.20booleans.html">wasmtime / issue #5031 Cranelift: Remove booleans</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="302879445"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235031%20Cranelift%3A%20Remove%20booleans/near/302879445" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235031.20Cranelift.3A.20Remove.20booleans.html#302879445">(Oct 07 2022 at 15:35)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/pull/5031#issuecomment-1271750234">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5031">issue #5031</a>:</p>
<blockquote>
<p>I'm really happy that we're finally doing this! Thank you for taking this on.</p>
<p>Some of our lowerings depend on the fact that bools can only be represented as all ones or all zeroes, and so now that we are removing that assumption we might want to revisit them.</p>
<p>The <a href="https://github.com/bytecodealliance/wasmtime/blob/e45577e097b064797def3554468cffa5fdd443d3/cranelift/codegen/src/isa/aarch64/lower.isle#L1556-L1560">AArch64 implementation for <code>bmask</code></a> is wrong if we want to accept any integer other than -1 and 0. (i.e. 2 will be false, but should be true)</p>
<p><code>bint</code> is also assuming that inputs are all ones or all zeros and is <a href="https://github.com/bytecodealliance/wasmtime/blob/e45577e097b064797def3554468cffa5fdd443d3/cranelift/codegen/src/isa/aarch64/lower.isle#L1541-L1542">implemented as <code>and_imm</code> on AArch64</a>.</p>
</blockquote>



<a name="302879627"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235031%20Cranelift%3A%20Remove%20booleans/near/302879627" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235031.20Cranelift.3A.20Remove.20booleans.html#302879627">(Oct 07 2022 at 15:36)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/5031#issuecomment-1271750234">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5031">issue #5031</a>:</p>
<blockquote>
<p>I'm really happy that we're finally doing this! Thank you for taking this on.</p>
<p>Some of our lowerings depend on the fact that bools can only be represented as all ones or all zeroes, and so now that we are removing that assumption we might want to revisit them.</p>
<p>The <a href="https://github.com/bytecodealliance/wasmtime/blob/e45577e097b064797def3554468cffa5fdd443d3/cranelift/codegen/src/isa/aarch64/lower.isle#L1556-L1560">AArch64 implementation for <code>bmask</code></a> is wrong if we want to accept any integer other than -1 and 0. </p>
<p><code>bint</code> is also assuming that inputs are all ones or all zeros and is <a href="https://github.com/bytecodealliance/wasmtime/blob/e45577e097b064797def3554468cffa5fdd443d3/cranelift/codegen/src/isa/aarch64/lower.isle#L1541-L1542">implemented as <code>and_imm</code> on AArch64</a>. (i.e. 2 will be false, but should be true)</p>
</blockquote>



<a name="302880082"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235031%20Cranelift%3A%20Remove%20booleans/near/302880082" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235031.20Cranelift.3A.20Remove.20booleans.html#302880082">(Oct 07 2022 at 15:38)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/5031#issuecomment-1271750234">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5031">issue #5031</a>:</p>
<blockquote>
<p>I'm really happy that we're finally doing this! Thank you for taking this on.</p>
<p>Some of our lowerings depend on the fact that bools can only be represented as all ones or all zeroes, and so now that we are removing that assumption we might want to revisit them.</p>
<p>The <a href="https://github.com/bytecodealliance/wasmtime/blob/e45577e097b064797def3554468cffa5fdd443d3/cranelift/codegen/src/isa/aarch64/lower.isle#L1556-L1560">AArch64 implementation for <code>bmask</code></a> is wrong if we want to accept any integer other than -1 and 0. I would expect to get -1 if I do a <code>bmask</code> on a 2, but that's not what's going to happen. (I haven't tested this, but that's my reading of the implementation).</p>
<p><code>bint</code> is also assuming that inputs are all ones or all zeros and is <a href="https://github.com/bytecodealliance/wasmtime/blob/e45577e097b064797def3554468cffa5fdd443d3/cranelift/codegen/src/isa/aarch64/lower.isle#L1541-L1542">implemented as <code>and_imm</code> on AArch64</a>. (i.e. 2 will be false, but should be true)</p>
</blockquote>



<a name="302893023"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235031%20Cranelift%3A%20Remove%20booleans/near/302893023" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235031.20Cranelift.3A.20Remove.20booleans.html#302893023">(Oct 07 2022 at 16:44)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/5031#issuecomment-1271750234">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5031">issue #5031</a>:</p>
<blockquote>
<p>I'm really happy that we're finally doing this! Thank you for taking this on.</p>
<p>Some of our lowerings depend on the fact that bools can only be represented as all ones or all zeroes, and so now that we are removing that assumption we might want to revisit them.</p>
<p>The <a href="https://github.com/bytecodealliance/wasmtime/blob/e45577e097b064797def3554468cffa5fdd443d3/cranelift/codegen/src/isa/aarch64/lower.isle#L1556-L1560">AArch64 implementation for <code>bmask</code></a> is wrong if we want to accept any integer other than -1 and 0. I would expect to get -1 if I do a <code>bmask</code> on a 2, but that's not what's going to happen. (I haven't tested this, but that's my reading of the implementation).</p>
<p><code>bint</code> is also assuming that inputs are all ones or all zeros and is <a href="https://github.com/bytecodealliance/wasmtime/blob/e45577e097b064797def3554468cffa5fdd443d3/cranelift/codegen/src/isa/aarch64/lower.isle#L1541-L1542">implemented as <code>and_imm</code> on AArch64</a>. (i.e. 2 will be false, but should be true)</p>
<p>Edit: AArch64 has instructions (<a href="https://developer.arm.com/documentation/ddi0596/2020-12/Base-Instructions/CSET--Conditional-Set--an-alias-of-CSINC-"><code>cset</code></a> and <a href="https://developer.arm.com/documentation/ddi0596/2020-12/Base-Instructions/CSETM--Conditional-Set-Mask--an-alias-of-CSINV-"><code>csetm</code></a>) that represent these two operations, so we may want to partially revert b8f6d53a6bdf861e66093a046a081c886546cdf1 to get them back</p>
</blockquote>



<a name="302949242"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235031%20Cranelift%3A%20Remove%20booleans/near/302949242" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235031.20Cranelift.3A.20Remove.20booleans.html#302949242">(Oct 07 2022 at 23:40)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/5031#issuecomment-1272162522">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5031">issue #5031</a>:</p>
<blockquote>
<p>Also, just to note it here: if at all possible, I'd prefer for us to wait to merge this until after my mid-end work in #4953 is merged, if only because they're both large and likely-to-conflict PRs and mine has been through ~three painful rebases already :-)</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>