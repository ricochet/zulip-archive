<html>
<head><meta charset="utf-8"><title>wasmtime / issue #4214 wasmtime 0.37 has much smaller cal... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234214.20wasmtime.200.2E37.20has.20much.20smaller.20cal.2E.2E.2E.html">wasmtime / issue #4214 wasmtime 0.37 has much smaller cal...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="284885177"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234214%20wasmtime%200.37%20has%20much%20smaller%20cal.../near/284885177" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234214.20wasmtime.200.2E37.20has.20much.20smaller.20cal.2E.2E.2E.html#284885177">(Jun 03 2022 at 14:20)</a>:</h4>
<p>tiran opened <a href="https://github.com/bytecodealliance/wasmtime/issues/4214">issue #4214</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/8832856/wasmtime-stack-py.zip">wasmtime-stack-py.zip</a> wasm32-wasi build of CPython main branch (3.12-dev) with part of the stdlib and a reproducer file.</p>
<h3>Steps to Reproduce</h3>
<ul>
<li>extract zipfile</li>
<li><code>cd wasmtime-stack-py</code></li>
<li>Run <code>wasmtime run --dir . python.wasm -- recursive.py 1500</code> with wasmtime 0.36 and 0.37</li>
</ul>
<h3>Expected Results</h3>
<p>wasmtime 0.36 works correctly with a Python recursion limit up to a little more than 1500.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Error</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="err">`</span><span class="n">python</span><span class="p">.</span><span class="n">wasm</span><span class="err">`</span><span class="w"></span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="mi">0</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="n">default</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">wasm</span><span class="w"> </span><span class="n">trap</span>: <span class="nc">call</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">exhausted</span><span class="w"></span>
<span class="w">       </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span>:
           <span class="mi">0</span>: <span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyEval_EvalFrameDefault</span><span class="w"></span>
<span class="w">           </span><span class="mi">1</span>: <span class="mh">0x14e399</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyEval_Vector</span><span class="w"></span>
<span class="w">           </span><span class="mi">2</span>: <span class="mh">0x57e85</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyFunction_Vectorcall</span><span class="w"></span>
<span class="w">           </span><span class="mi">3</span>: <span class="mh">0x57d9d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">PyObject_CallOneArg</span><span class="w"></span>
<span class="w">           </span><span class="mi">4</span>: <span class="mh">0xc85dd</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">slot_tp_repr</span><span class="w"></span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="w">         </span><span class="mi">3574</span>: <span class="mh">0x193776</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">run_mod</span><span class="w"></span>
<span class="w">         </span><span class="mi">3575</span>: <span class="mh">0x192e05</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyRun_SimpleFileObject</span><span class="w"></span>
<span class="w">         </span><span class="mi">3576</span>: <span class="mh">0x1924bb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyRun_AnyFileObject</span><span class="w"></span>
<span class="w">         </span><span class="mi">3577</span>: <span class="mh">0x1b23d3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">Py_RunMain</span><span class="w"></span>
<span class="w">         </span><span class="mi">3578</span>: <span class="mh">0x1b2ede</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">pymain_main</span><span class="w"></span>
<span class="w">         </span><span class="mi">3579</span>: <span class="mh">0x1b2f8d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">Py_BytesMain</span><span class="w"></span>
<span class="w">         </span><span class="mi">3580</span>: <span class="mh">0x4c52</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">main</span><span class="w"></span>
<span class="w">         </span><span class="mi">3581</span>: <span class="mh">0x31b09e</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__main_void</span><span class="w"></span>
<span class="w">         </span><span class="mi">3582</span>: <span class="mh">0x31b01d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__original_main</span><span class="w"></span>
<span class="w">         </span><span class="mi">3583</span>: <span class="mh">0x4c36</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_start</span><span class="w"></span>
<span class="w">         </span><span class="mi">3584</span>: <span class="mh">0x3343f7</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_start</span><span class="p">.</span><span class="n">command_export</span><span class="w"></span>
<span class="w">       </span><span class="n">note</span>: <span class="nc">using</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">`</span><span class="n">WASMTIME_BACKTRACE_DETAILS</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">debugging</span><span class="w"> </span><span class="n">information</span><span class="w"></span>
</code></pre></div>
<h3>Actual Results</h3>
<p>wasmtime 0.37 fails with a much lower recursion limit. It starts to run into call stack exhaustion at about 480 Python recursions and 1155 WASM call stacks. Please note that the highest WASM call stack number with wasmtime 0.36 is 3584.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Error</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="err">`</span><span class="n">python</span><span class="p">.</span><span class="n">wasm</span><span class="err">`</span><span class="w"></span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="mi">0</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="n">default</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">wasm</span><span class="w"> </span><span class="n">trap</span>: <span class="nc">call</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">exhausted</span><span class="w"></span>
<span class="w">       </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span>:
           <span class="mi">0</span>: <span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyEval_EvalFrameDefault</span><span class="w"></span>
<span class="w">           </span><span class="mi">1</span>: <span class="mh">0x14e399</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyEval_Vector</span><span class="w"></span>
<span class="w">           </span><span class="mi">2</span>: <span class="mh">0x57e85</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyFunction_Vectorcall</span><span class="w"></span>
<span class="w">           </span><span class="mi">3</span>: <span class="mh">0x57d9d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">PyObject_CallOneArg</span><span class="w"></span>
<span class="w">           </span><span class="mi">4</span>: <span class="mh">0xc85dd</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">slot_tp_repr</span><span class="w"></span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="w">         </span><span class="mi">1145</span>: <span class="mh">0x193776</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">run_mod</span><span class="w"></span>
<span class="w">         </span><span class="mi">1146</span>: <span class="mh">0x192e05</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyRun_SimpleFileObject</span><span class="w"></span>
<span class="w">         </span><span class="mi">1147</span>: <span class="mh">0x1924bb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyRun_AnyFileObject</span><span class="w"></span>
<span class="w">         </span><span class="mi">1148</span>: <span class="mh">0x1b23d3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">Py_RunMain</span><span class="w"></span>
<span class="w">         </span><span class="mi">1149</span>: <span class="mh">0x1b2ede</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">pymain_main</span><span class="w"></span>
<span class="w">         </span><span class="mi">1150</span>: <span class="mh">0x1b2f8d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">Py_BytesMain</span><span class="w"></span>
<span class="w">         </span><span class="mi">1151</span>: <span class="mh">0x4c52</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">main</span><span class="w"></span>
<span class="w">         </span><span class="mi">1152</span>: <span class="mh">0x31b09e</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__main_void</span><span class="w"></span>
<span class="w">         </span><span class="mi">1153</span>: <span class="mh">0x31b01d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__original_main</span><span class="w"></span>
<span class="w">         </span><span class="mi">1154</span>: <span class="mh">0x4c36</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_start</span><span class="w"></span>
<span class="w">         </span><span class="mi">1155</span>: <span class="mh">0x3343f7</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_start</span><span class="p">.</span><span class="n">command_export</span><span class="w"></span>
<span class="w">       </span><span class="n">note</span>: <span class="nc">using</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">`</span><span class="n">WASMTIME_BACKTRACE_DETAILS</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">debugging</span><span class="w"> </span><span class="n">information</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: wasmtime-v0.37.0-x86_64-linux</p>
<p>Operating system: Linux (Fedora 36)</p>
<p>Architecture: X84_64</p>
<p>WASI SDK: 16.0</p>
<p>Python 3.12-dev (latest commit on main as of today)</p>
<h3>Extra Info</h3>
<p>You can find build scripts and artifacts in the git repo <a href="https://github.com/ethanhs/python-wasm/">https://github.com/ethanhs/python-wasm/</a></p>
</blockquote>



<a name="284885178"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234214%20wasmtime%200.37%20has%20much%20smaller%20cal.../near/284885178" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234214.20wasmtime.200.2E37.20has.20much.20smaller.20cal.2E.2E.2E.html#284885178">(Jun 03 2022 at 14:20)</a>:</h4>
<p>tiran labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/4214">issue #4214</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/8832856/wasmtime-stack-py.zip">wasmtime-stack-py.zip</a> wasm32-wasi build of CPython main branch (3.12-dev) with part of the stdlib and a reproducer file.</p>
<h3>Steps to Reproduce</h3>
<ul>
<li>extract zipfile</li>
<li><code>cd wasmtime-stack-py</code></li>
<li>Run <code>wasmtime run --dir . python.wasm -- recursive.py 1500</code> with wasmtime 0.36 and 0.37</li>
</ul>
<h3>Expected Results</h3>
<p>wasmtime 0.36 works correctly with a Python recursion limit up to a little more than 1500.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Error</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="err">`</span><span class="n">python</span><span class="p">.</span><span class="n">wasm</span><span class="err">`</span><span class="w"></span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="mi">0</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="n">default</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">wasm</span><span class="w"> </span><span class="n">trap</span>: <span class="nc">call</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">exhausted</span><span class="w"></span>
<span class="w">       </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span>:
           <span class="mi">0</span>: <span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyEval_EvalFrameDefault</span><span class="w"></span>
<span class="w">           </span><span class="mi">1</span>: <span class="mh">0x14e399</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyEval_Vector</span><span class="w"></span>
<span class="w">           </span><span class="mi">2</span>: <span class="mh">0x57e85</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyFunction_Vectorcall</span><span class="w"></span>
<span class="w">           </span><span class="mi">3</span>: <span class="mh">0x57d9d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">PyObject_CallOneArg</span><span class="w"></span>
<span class="w">           </span><span class="mi">4</span>: <span class="mh">0xc85dd</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">slot_tp_repr</span><span class="w"></span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="w">         </span><span class="mi">3574</span>: <span class="mh">0x193776</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">run_mod</span><span class="w"></span>
<span class="w">         </span><span class="mi">3575</span>: <span class="mh">0x192e05</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyRun_SimpleFileObject</span><span class="w"></span>
<span class="w">         </span><span class="mi">3576</span>: <span class="mh">0x1924bb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyRun_AnyFileObject</span><span class="w"></span>
<span class="w">         </span><span class="mi">3577</span>: <span class="mh">0x1b23d3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">Py_RunMain</span><span class="w"></span>
<span class="w">         </span><span class="mi">3578</span>: <span class="mh">0x1b2ede</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">pymain_main</span><span class="w"></span>
<span class="w">         </span><span class="mi">3579</span>: <span class="mh">0x1b2f8d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">Py_BytesMain</span><span class="w"></span>
<span class="w">         </span><span class="mi">3580</span>: <span class="mh">0x4c52</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">main</span><span class="w"></span>
<span class="w">         </span><span class="mi">3581</span>: <span class="mh">0x31b09e</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__main_void</span><span class="w"></span>
<span class="w">         </span><span class="mi">3582</span>: <span class="mh">0x31b01d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__original_main</span><span class="w"></span>
<span class="w">         </span><span class="mi">3583</span>: <span class="mh">0x4c36</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_start</span><span class="w"></span>
<span class="w">         </span><span class="mi">3584</span>: <span class="mh">0x3343f7</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_start</span><span class="p">.</span><span class="n">command_export</span><span class="w"></span>
<span class="w">       </span><span class="n">note</span>: <span class="nc">using</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">`</span><span class="n">WASMTIME_BACKTRACE_DETAILS</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">debugging</span><span class="w"> </span><span class="n">information</span><span class="w"></span>
</code></pre></div>
<h3>Actual Results</h3>
<p>wasmtime 0.37 fails with a much lower recursion limit. It starts to run into call stack exhaustion at about 480 Python recursions and 1155 WASM call stacks. Please note that the highest WASM call stack number with wasmtime 0.36 is 3584.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Error</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="err">`</span><span class="n">python</span><span class="p">.</span><span class="n">wasm</span><span class="err">`</span><span class="w"></span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="mi">0</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="n">default</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">wasm</span><span class="w"> </span><span class="n">trap</span>: <span class="nc">call</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">exhausted</span><span class="w"></span>
<span class="w">       </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span>:
           <span class="mi">0</span>: <span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyEval_EvalFrameDefault</span><span class="w"></span>
<span class="w">           </span><span class="mi">1</span>: <span class="mh">0x14e399</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyEval_Vector</span><span class="w"></span>
<span class="w">           </span><span class="mi">2</span>: <span class="mh">0x57e85</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyFunction_Vectorcall</span><span class="w"></span>
<span class="w">           </span><span class="mi">3</span>: <span class="mh">0x57d9d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">PyObject_CallOneArg</span><span class="w"></span>
<span class="w">           </span><span class="mi">4</span>: <span class="mh">0xc85dd</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">slot_tp_repr</span><span class="w"></span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="w">         </span><span class="mi">1145</span>: <span class="mh">0x193776</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">run_mod</span><span class="w"></span>
<span class="w">         </span><span class="mi">1146</span>: <span class="mh">0x192e05</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyRun_SimpleFileObject</span><span class="w"></span>
<span class="w">         </span><span class="mi">1147</span>: <span class="mh">0x1924bb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyRun_AnyFileObject</span><span class="w"></span>
<span class="w">         </span><span class="mi">1148</span>: <span class="mh">0x1b23d3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">Py_RunMain</span><span class="w"></span>
<span class="w">         </span><span class="mi">1149</span>: <span class="mh">0x1b2ede</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">pymain_main</span><span class="w"></span>
<span class="w">         </span><span class="mi">1150</span>: <span class="mh">0x1b2f8d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">Py_BytesMain</span><span class="w"></span>
<span class="w">         </span><span class="mi">1151</span>: <span class="mh">0x4c52</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">main</span><span class="w"></span>
<span class="w">         </span><span class="mi">1152</span>: <span class="mh">0x31b09e</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__main_void</span><span class="w"></span>
<span class="w">         </span><span class="mi">1153</span>: <span class="mh">0x31b01d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__original_main</span><span class="w"></span>
<span class="w">         </span><span class="mi">1154</span>: <span class="mh">0x4c36</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_start</span><span class="w"></span>
<span class="w">         </span><span class="mi">1155</span>: <span class="mh">0x3343f7</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_start</span><span class="p">.</span><span class="n">command_export</span><span class="w"></span>
<span class="w">       </span><span class="n">note</span>: <span class="nc">using</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">`</span><span class="n">WASMTIME_BACKTRACE_DETAILS</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">debugging</span><span class="w"> </span><span class="n">information</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: wasmtime-v0.37.0-x86_64-linux</p>
<p>Operating system: Linux (Fedora 36)</p>
<p>Architecture: X84_64</p>
<p>WASI SDK: 16.0</p>
<p>Python 3.12-dev (latest commit on main as of today)</p>
<h3>Extra Info</h3>
<p>You can find build scripts and artifacts in the git repo <a href="https://github.com/ethanhs/python-wasm/">https://github.com/ethanhs/python-wasm/</a></p>
</blockquote>



<a name="284890047"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234214%20wasmtime%200.37%20has%20much%20smaller%20cal.../near/284890047" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234214.20wasmtime.200.2E37.20has.20much.20smaller.20cal.2E.2E.2E.html#284890047">(Jun 03 2022 at 14:59)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/4214#issuecomment-1146049723">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4214">issue #4214</a>:</p>
<blockquote>
<p>cc @cfallin, this is probably related to regalloc2 perhaps?</p>
</blockquote>



<a name="284899936"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234214%20wasmtime%200.37%20has%20much%20smaller%20cal.../near/284899936" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234214.20wasmtime.200.2E37.20has.20much.20smaller.20cal.2E.2E.2E.html#284899936">(Jun 03 2022 at 16:13)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/4214#issuecomment-1146143032">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4214">issue #4214</a>:</p>
<blockquote>
<p>It could be; a larger stack frame in some particular function of this program due to different spilling behavior could very well cause this. @tiran, for context, we switched to a new register allocator (regalloc2) in wasmtime 0.37, and it works in quite a different way from the old one (generally better results, enough on average to justify switching, but not always).</p>
<p>@tiran, I see your note about "artifacts and build scripts in the repo", but could you give a URL for a specific <code>.wasm</code> that I could download and compile, to compare the output before-and-after? That would greatly help diagnosing.</p>
<p>I'm definitely happy to look at this -- it's possible that some heuristic can be improved, or that something is just not working as expected.</p>
<p>We should also note though that stackframe size is a completely implementation-defined detail. One can configure the stack size of one's instances and sometimes this may be necessary for deeply recursive programs. To be clear I am absolutely wanting to dive into this and understand what happened, and we <em>shouldn't</em> have regressions of this sort if we can help it at all; but just want to set expectations at the same time :-)</p>
<p>Thanks for reporting the issue!</p>
</blockquote>



<a name="284904123"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234214%20wasmtime%200.37%20has%20much%20smaller%20cal.../near/284904123" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234214.20wasmtime.200.2E37.20has.20much.20smaller.20cal.2E.2E.2E.html#284904123">(Jun 03 2022 at 16:49)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/4214#issuecomment-1146170632">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4214">issue #4214</a>:</p>
<blockquote>
<blockquote>
<p>@tiran, I see your note about "artifacts and build scripts in the repo", but could you give a URL for a specific .wasm that I could download and compile, to compare the output before-and-after? That would greatly help diagnosing.</p>
</blockquote>
<p>Nevermind this, I fail at reading occasionally; I see your .zip at the top of the comment. Thanks!</p>
</blockquote>



<a name="284904154"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234214%20wasmtime%200.37%20has%20much%20smaller%20cal.../near/284904154" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234214.20wasmtime.200.2E37.20has.20much.20smaller.20cal.2E.2E.2E.html#284904154">(Jun 03 2022 at 16:49)</a>:</h4>
<p>cfallin edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4214#issuecomment-1146143032">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4214">issue #4214</a>:</p>
<blockquote>
<p>It could be; a larger stack frame in some particular function of this program due to different spilling behavior could very well cause this. @tiran, for context, we switched to a new register allocator (regalloc2) in wasmtime 0.37, and it works in quite a different way from the old one (generally better results, enough on average to justify switching, but not always).</p>
<p><del>@tiran, I see your note about "artifacts and build scripts in the repo", but could you give a URL for a specific <code>.wasm</code> that I could download and compile, to compare the output before-and-after? That would greatly help diagnosing.</del></p>
<p>I'm definitely happy to look at this -- it's possible that some heuristic can be improved, or that something is just not working as expected.</p>
<p>We should also note though that stackframe size is a completely implementation-defined detail. One can configure the stack size of one's instances and sometimes this may be necessary for deeply recursive programs. To be clear I am absolutely wanting to dive into this and understand what happened, and we <em>shouldn't</em> have regressions of this sort if we can help it at all; but just want to set expectations at the same time :-)</p>
<p>Thanks for reporting the issue!</p>
</blockquote>



<a name="284906818"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234214%20wasmtime%200.37%20has%20much%20smaller%20cal.../near/284906818" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234214.20wasmtime.200.2E37.20has.20much.20smaller.20cal.2E.2E.2E.html#284906818">(Jun 03 2022 at 17:10)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/4214#issuecomment-1146188574">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4214">issue #4214</a>:</p>
<blockquote>
<p>I got an odd result with bisection locally reproducing with the <code>*.zip</code> above. I'm on an aarch64 machine and the v0.37.0 release actually runs the <code>recursive.py</code> just fine. On <code>main</code>, however, I get the stack overflow as reported here. Bisection points to 0824abbae47a88e3c0fa651e61be3c49fcddc0fc as the "cause" and I can confirm that before that commit <code>recursive.py</code> runs ok but on that commit <code>recursive.py</code> runs out of stack.</p>
<p>I suspect there's probably x86_64-vs-aarch64 differences which makes it such that v0.37.0 fails for @tiran but doesn't fail for me. Otherwise though there may be something going on with the alias analysis added that accidentally increases stack sizes. (or it was really close to the limit prior and alias analysis just happened to push it over the edge or something like that)</p>
</blockquote>



<a name="284908228"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234214%20wasmtime%200.37%20has%20much%20smaller%20cal.../near/284908228" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234214.20wasmtime.200.2E37.20has.20much.20smaller.20cal.2E.2E.2E.html#284908228">(Jun 03 2022 at 17:23)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/4214#issuecomment-1146197962">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4214">issue #4214</a>:</p>
<blockquote>
<p>I did a quick analysis of compiled objects from the <code>python.wasm</code> in the zip before (0.35.2 that I happened to have lying around) and after (<code>main</code> from today). I grepped out all <code>sub $IMM, %rsp</code> instructions, which appear in prologues to allocate stack frames, then sorted and counted instances to form histograms.</p>
<p>Before:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">   </span><span class="mi">2517</span><span class="w"> </span><span class="mh">0x10</span><span class="w"></span>
<span class="w">   </span><span class="mi">1654</span><span class="w"> </span><span class="mh">0x20</span><span class="w"></span>
<span class="w">   </span><span class="mi">1069</span><span class="w"> </span><span class="mh">0x30</span><span class="w"></span>
<span class="w">   </span><span class="mi">1376</span><span class="w"> </span><span class="mh">0x40</span><span class="w"></span>
<span class="w">    </span><span class="mi">864</span><span class="w"> </span><span class="mh">0x50</span><span class="w"></span>
<span class="w">    </span><span class="mi">495</span><span class="w"> </span><span class="mh">0x60</span><span class="w"></span>
<span class="w">    </span><span class="mi">302</span><span class="w"> </span><span class="mh">0x70</span><span class="w"></span>
<span class="w">    </span><span class="mi">150</span><span class="w"> </span><span class="mh">0x80</span><span class="w"></span>
<span class="w">    </span><span class="mi">121</span><span class="w"> </span><span class="mh">0x90</span><span class="w"></span>
<span class="w">     </span><span class="mi">61</span><span class="w"> </span><span class="mh">0xa0</span><span class="w"></span>
<span class="w">     </span><span class="mi">39</span><span class="w"> </span><span class="mh">0xb0</span><span class="w"></span>
<span class="w">     </span><span class="mi">20</span><span class="w"> </span><span class="mh">0xc0</span><span class="w"></span>
<span class="w">     </span><span class="mi">15</span><span class="w"> </span><span class="mh">0xd0</span><span class="w"></span>
<span class="w">     </span><span class="mi">19</span><span class="w"> </span><span class="mh">0xe0</span><span class="w"></span>
<span class="w">      </span><span class="mi">8</span><span class="w"> </span><span class="mh">0xf0</span><span class="w"></span>
<span class="w">      </span><span class="mi">5</span><span class="w"> </span><span class="mh">0x100</span><span class="w"></span>
<span class="w">      </span><span class="mi">5</span><span class="w"> </span><span class="mh">0x110</span><span class="w"></span>
<span class="w">      </span><span class="mi">2</span><span class="w"> </span><span class="mh">0x120</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="w"> </span><span class="mh">0x130</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="w"> </span><span class="mh">0x160</span><span class="w"></span>
<span class="w">      </span><span class="mi">2</span><span class="w"> </span><span class="mh">0x170</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="w"> </span><span class="mh">0x180</span><span class="w"></span>
<span class="w">      </span><span class="mi">2</span><span class="w"> </span><span class="mh">0x190</span><span class="w"></span>
<span class="w">      </span><span class="mi">2</span><span class="w"> </span><span class="mh">0x1a0</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="w"> </span><span class="mh">0x260</span><span class="w"></span>
</code></pre></div>
<p>after:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">   </span><span class="mi">2471</span><span class="w"> </span><span class="mh">0x10</span><span class="w"></span>
<span class="w">   </span><span class="mi">1640</span><span class="w"> </span><span class="mh">0x20</span><span class="w"></span>
<span class="w">   </span><span class="mi">1212</span><span class="w"> </span><span class="mh">0x30</span><span class="w"></span>
<span class="w">   </span><span class="mi">1471</span><span class="w"> </span><span class="mh">0x40</span><span class="w"></span>
<span class="w">    </span><span class="mi">791</span><span class="w"> </span><span class="mh">0x50</span><span class="w"></span>
<span class="w">    </span><span class="mi">424</span><span class="w"> </span><span class="mh">0x60</span><span class="w"></span>
<span class="w">    </span><span class="mi">273</span><span class="w"> </span><span class="mh">0x70</span><span class="w"></span>
<span class="w">    </span><span class="mi">141</span><span class="w"> </span><span class="mh">0x80</span><span class="w"></span>
<span class="w">    </span><span class="mi">101</span><span class="w"> </span><span class="mh">0x90</span><span class="w"></span>
<span class="w">     </span><span class="mi">62</span><span class="w"> </span><span class="mh">0xa0</span><span class="w"></span>
<span class="w">     </span><span class="mi">32</span><span class="w"> </span><span class="mh">0xb0</span><span class="w"></span>
<span class="w">     </span><span class="mi">33</span><span class="w"> </span><span class="mh">0xc0</span><span class="w"></span>
<span class="w">     </span><span class="mi">26</span><span class="w"> </span><span class="mh">0xd0</span><span class="w"></span>
<span class="w">     </span><span class="mi">20</span><span class="w"> </span><span class="mh">0xe0</span><span class="w"></span>
<span class="w">     </span><span class="mi">11</span><span class="w"> </span><span class="mh">0xf0</span><span class="w"></span>
<span class="w">      </span><span class="mi">3</span><span class="w"> </span><span class="mh">0x100</span><span class="w"></span>
<span class="w">      </span><span class="mi">6</span><span class="w"> </span><span class="mh">0x110</span><span class="w"></span>
<span class="w">      </span><span class="mi">8</span><span class="w"> </span><span class="mh">0x120</span><span class="w"></span>
<span class="w">      </span><span class="mi">8</span><span class="w"> </span><span class="mh">0x130</span><span class="w"></span>
<span class="w">      </span><span class="mi">6</span><span class="w"> </span><span class="mh">0x140</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="w"> </span><span class="mh">0x150</span><span class="w"></span>
<span class="w">      </span><span class="mi">2</span><span class="w"> </span><span class="mh">0x180</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="w"> </span><span class="mh">0x190</span><span class="w"></span>
<span class="w">      </span><span class="mi">2</span><span class="w"> </span><span class="mh">0x1a0</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="w"> </span><span class="mh">0x1b0</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="w"> </span><span class="mh">0x1c0</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="w"> </span><span class="mh">0x1e0</span><span class="w"></span>
<span class="w">      </span><span class="mi">2</span><span class="w"> </span><span class="mh">0x1f0</span><span class="w"></span>
<span class="w">      </span><span class="mi">2</span><span class="w"> </span><span class="mh">0x200</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="w"> </span><span class="mh">0x310</span><span class="w"></span>
<span class="w">      </span><span class="mi">2</span><span class="w"> </span><span class="mh">0x3e0</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="w"> </span><span class="mh">0x550</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="w"> </span><span class="mh">0x620</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="w"> </span><span class="mh">0x950</span><span class="w"></span>
</code></pre></div>
<p>so we are seeing significantly larger stack frames in some cases.</p>
<p>My current hypothesis is that alias analysis is creating longer liveranges by doing what it does (finding aliases, using values from further up the function body), and so this is potentially causing more spilling. This is a pretty classic code-motion problem with the usual NP-hard flavor -- do we reuse a value, but pay for storing it, or do we recompute it (in this case reloading); the former is better if we have free registers, the latter if we don't, but compiler phasing puts this decision before we get to regalloc and know for sure.</p>
<p>The alias analysis got <em>some</em> benefits but they were middling at best (see #4163), because it actually would do better when combined with GVN and other analyses concurrently; I'm happy to keep it in-tree but turn it off by default if we think that's the more predictable path for now, and turn it back on as part of a bigger mid-end optimization effort. Thoughts?</p>
</blockquote>



<a name="284909739"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234214%20wasmtime%200.37%20has%20much%20smaller%20cal.../near/284909739" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234214.20wasmtime.200.2E37.20has.20much.20smaller.20cal.2E.2E.2E.html#284909739">(Jun 03 2022 at 17:35)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/4214#issuecomment-1146206514">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4214">issue #4214</a>:</p>
<blockquote>
<p>and with alias analysis disabled, the distribution is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">   </span><span class="mi">2473</span><span class="w"> </span><span class="mh">0x10</span><span class="w"></span>
<span class="w">   </span><span class="mi">1644</span><span class="w"> </span><span class="mh">0x20</span><span class="w"></span>
<span class="w">   </span><span class="mi">1202</span><span class="w"> </span><span class="mh">0x30</span><span class="w"></span>
<span class="w">   </span><span class="mi">1500</span><span class="w"> </span><span class="mh">0x40</span><span class="w"></span>
<span class="w">    </span><span class="mi">807</span><span class="w"> </span><span class="mh">0x50</span><span class="w"></span>
<span class="w">    </span><span class="mi">431</span><span class="w"> </span><span class="mh">0x60</span><span class="w"></span>
<span class="w">    </span><span class="mi">255</span><span class="w"> </span><span class="mh">0x70</span><span class="w"></span>
<span class="w">    </span><span class="mi">142</span><span class="w"> </span><span class="mh">0x80</span><span class="w"></span>
<span class="w">     </span><span class="mi">83</span><span class="w"> </span><span class="mh">0x90</span><span class="w"></span>
<span class="w">     </span><span class="mi">60</span><span class="w"> </span><span class="mh">0xa0</span><span class="w"></span>
<span class="w">     </span><span class="mi">32</span><span class="w"> </span><span class="mh">0xb0</span><span class="w"></span>
<span class="w">     </span><span class="mi">32</span><span class="w"> </span><span class="mh">0xc0</span><span class="w"></span>
<span class="w">     </span><span class="mi">16</span><span class="w"> </span><span class="mh">0xd0</span><span class="w"></span>
<span class="w">     </span><span class="mi">21</span><span class="w"> </span><span class="mh">0xe0</span><span class="w"></span>
<span class="w">     </span><span class="mi">14</span><span class="w"> </span><span class="mh">0xf0</span><span class="w"></span>
<span class="w">      </span><span class="mi">5</span><span class="w"> </span><span class="mh">0x100</span><span class="w"></span>
<span class="w">      </span><span class="mi">6</span><span class="w"> </span><span class="mh">0x110</span><span class="w"></span>
<span class="w">      </span><span class="mi">6</span><span class="w"> </span><span class="mh">0x120</span><span class="w"></span>
<span class="w">      </span><span class="mi">8</span><span class="w"> </span><span class="mh">0x130</span><span class="w"></span>
<span class="w">      </span><span class="mi">3</span><span class="w"> </span><span class="mh">0x140</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="w"> </span><span class="mh">0x150</span><span class="w"></span>
<span class="w">      </span><span class="mi">2</span><span class="w"> </span><span class="mh">0x180</span><span class="w"></span>
<span class="w">      </span><span class="mi">3</span><span class="w"> </span><span class="mh">0x190</span><span class="w"></span>
<span class="w">      </span><span class="mi">2</span><span class="w"> </span><span class="mh">0x1b0</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="w"> </span><span class="mh">0x1e0</span><span class="w"></span>
<span class="w">      </span><span class="mi">4</span><span class="w"> </span><span class="mh">0x1f0</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="w"> </span><span class="mh">0x360</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="w"> </span><span class="mh">0x370</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="w"> </span><span class="mh">0x3d0</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="w"> </span><span class="mh">0x560</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="w"> </span><span class="mh">0x640</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="w"> </span><span class="mh">0x930</span><span class="w"></span>
</code></pre></div>
<p>so there are still some large stack frames, but slightly fewer. On my x86-64 machine, with alias analysis disabled I still get a Wasm stack overflow trap with the repro above. I suspect the difference wrt @alexcrichton 's results on aarch64 is that aarch64 has twice as many registers so needs smaller stackframes generally.</p>
<p>So:</p>
<ul>
<li>I can take a look at stackslot merging in RA2 to see if it's doing anything clearly wrong, or easy to fix;</li>
<li>We can turn off alias analysis for now.</li>
</ul>
</blockquote>



<a name="284913057"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234214%20wasmtime%200.37%20has%20much%20smaller%20cal.../near/284913057" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234214.20wasmtime.200.2E37.20has.20much.20smaller.20cal.2E.2E.2E.html#284913057">(Jun 03 2022 at 18:04)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/4214#issuecomment-1146228265">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4214">issue #4214</a>:</p>
<blockquote>
<p>I picked the biggest stack frame in the object which was for <code>_wasm_function_3078</code> (<code>_PyEval_EvalFrameDefault</code>) and compared the sizes of it:</p>
<table>
<thead>
<tr>
<th></th>
<th>0.36.0</th>
<th>0.37.0</th>
</tr>
</thead>
<tbody>
<tr>
<td>x86_64</td>
<td>608</td>
<td>2816</td>
</tr>
<tr>
<td>aarch64</td>
<td>528</td>
<td>1168</td>
</tr>
</tbody>
</table>
<p>This function is indeed part of the recursive trace in the stack traces above, which means that inflating the stack size of this function indeed reduces the amount of recursion available.</p>
<p>Given that 0.37.0 doesn't have alias analysis while I'm sure it affects stack usage somewhat (as is evidenced from my bisection run on aarch64) this seems more worrisome. While different stack sizes are expected is it expected that ra2 generates a stack size that's 4x larger for equivalent code on x86_64? <br>
</p>
</blockquote>



<a name="284915349"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234214%20wasmtime%200.37%20has%20much%20smaller%20cal.../near/284915349" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234214.20wasmtime.200.2E37.20has.20much.20smaller.20cal.2E.2E.2E.html#284915349">(Jun 03 2022 at 18:21)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/4214#issuecomment-1146241663">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4214">issue #4214</a>:</p>
<blockquote>
<p>Indeed, that corresponds to the 0x260 (608) in the histogram above; 0x950 (2384) bytes on <code>main</code>.</p>
<p>Definitely not expected! I'm looking into the stackslot merging as mentioned above...</p>
</blockquote>



<a name="284916145"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234214%20wasmtime%200.37%20has%20much%20smaller%20cal.../near/284916145" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234214.20wasmtime.200.2E37.20has.20much.20smaller.20cal.2E.2E.2E.html#284916145">(Jun 03 2022 at 18:26)</a>:</h4>
<p>tiran <a href="https://github.com/bytecodealliance/wasmtime/issues/4214#issuecomment-1146245458">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4214">issue #4214</a>:</p>
<blockquote>
<p>Thank you for looking into the issue. I appreciate your promptly and detailed feedback.</p>
<p>I'm in the process of adding experimental support for wasm32-emscripten and wasm32-wasi to CPython upstream. Basic Emscripten support is mostly done. We now have all downstream patches from Pyodide integrated into CPython upstream and are able to run the test suite successfully under Node. WASI support is in an earlier state. I had all crashes fixed with WASI SDK 15 and wasmtime 0.36. WASI SDK 16 fixed a bug in utimensat that affected CPython. Right now I'm going through all remaining test failures and added skip markers to test cases that do not work with wasmtime (e.g. symlinks with absolute paths, tests that depend on working chmod/umask, etc.).</p>
<p>Once I have WASI builds + wasmtime figured out and stable, I plan to look into other runtime. Does WASI offer an API to introspect the call stack at runtime so we could determinate the Python recursion limit dynamically?</p>
<p>@alexcrichton The function <code>_PyEval_EvalFrameDefault</code> is the core of Python's ceval loop and executes Python byte code. It's a very long function with lots of locals. On GCC and clang it normally uses computed gotos. Since WASM target does not support computed gotos, it falls back to a long switch statement.</p>
</blockquote>



<a name="284917175"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234214%20wasmtime%200.37%20has%20much%20smaller%20cal.../near/284917175" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234214.20wasmtime.200.2E37.20has.20much.20smaller.20cal.2E.2E.2E.html#284917175">(Jun 03 2022 at 18:34)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/4214#issuecomment-1146252006">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4214">issue #4214</a>:</p>
<blockquote>
<p>Currently there is no way for a wasm module to determine its own stack limit or otherwise see how big stack frames are, so there's no way for the wasm module itself to detect what its recursion limit should be.</p>
<p>Otherwise though it definitely makes sense that <code>_PyEval_EvalFrameDefault</code> needs to be pretty optimized! @cfallin is investigating the possibility of an accidental bug being introduced when Wasmtime <a href="https://github.com/bytecodealliance/wasmtime/pull/3989">switched from one register allocator to another</a>. The new register allocator sems to produce much larger stack sizes than before for <code>_PyEval_EvalFrameDefault</code> which is believed to be an unintended result of switching register allocators.</p>
<p>The work you're doing sounds great though! If you've got specific issues with wasmtime's WASI support feel free to open issues here as well, and additionally if you've got thoughts about WASI in general I'm sure the WASI repository would be welcome to issues as well</p>
</blockquote>



<a name="284917271"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234214%20wasmtime%200.37%20has%20much%20smaller%20cal.../near/284917271" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234214.20wasmtime.200.2E37.20has.20much.20smaller.20cal.2E.2E.2E.html#284917271">(Jun 03 2022 at 18:35)</a>:</h4>
<p>alexcrichton edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4214#issuecomment-1146252006">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4214">issue #4214</a>:</p>
<blockquote>
<p>Currently there is no way for a wasm module to determine its own stack limit or otherwise see how big stack frames are, so there's no way for the wasm module itself to detect what its recursion limit should be.</p>
<p>Otherwise though it definitely makes sense that <code>_PyEval_EvalFrameDefault</code> needs to be pretty optimized! @cfallin is investigating the possibility of an accidental bug being introduced when Wasmtime <a href="https://github.com/bytecodealliance/wasmtime/pull/3989">switched from one register allocator to another</a>. The new register allocator seems to produce much larger stack sizes than before for <code>_PyEval_EvalFrameDefault</code> which is believed to be an unintended result of switching register allocators.</p>
<p>The work you're doing sounds great though! If you've got specific issues with wasmtime's WASI support feel free to open issues here as well, and additionally if you've got thoughts about WASI in general I'm sure the WASI repository would be welcome to issues as well</p>
</blockquote>



<a name="284932738"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234214%20wasmtime%200.37%20has%20much%20smaller%20cal.../near/284932738" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234214.20wasmtime.200.2E37.20has.20much.20smaller.20cal.2E.2E.2E.html#284932738">(Jun 03 2022 at 21:05)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/4214#issuecomment-1146362124">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4214">issue #4214</a>:</p>
<blockquote>
<p>Alright, I've discovered a truly boneheaded mistake of my own making in the spillslot allocation in regalloc2; PR incoming, but the histogram is now:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">   </span><span class="mi">2471</span><span class="w"> </span><span class="mh">0x10</span><span class="w"></span>
<span class="w">   </span><span class="mi">1640</span><span class="w"> </span><span class="mh">0x20</span><span class="w"></span>
<span class="w">   </span><span class="mi">1212</span><span class="w"> </span><span class="mh">0x30</span><span class="w"></span>
<span class="w">   </span><span class="mi">1471</span><span class="w"> </span><span class="mh">0x40</span><span class="w"></span>
<span class="w">    </span><span class="mi">829</span><span class="w"> </span><span class="mh">0x50</span><span class="w"></span>
<span class="w">    </span><span class="mi">432</span><span class="w"> </span><span class="mh">0x60</span><span class="w"></span>
<span class="w">    </span><span class="mi">274</span><span class="w"> </span><span class="mh">0x70</span><span class="w"></span>
<span class="w">    </span><span class="mi">151</span><span class="w"> </span><span class="mh">0x80</span><span class="w"></span>
<span class="w">     </span><span class="mi">97</span><span class="w"> </span><span class="mh">0x90</span><span class="w"></span>
<span class="w">     </span><span class="mi">57</span><span class="w"> </span><span class="mh">0xa0</span><span class="w"></span>
<span class="w">     </span><span class="mi">43</span><span class="w"> </span><span class="mh">0xb0</span><span class="w"></span>
<span class="w">     </span><span class="mi">23</span><span class="w"> </span><span class="mh">0xc0</span><span class="w"></span>
<span class="w">     </span><span class="mi">15</span><span class="w"> </span><span class="mh">0xd0</span><span class="w"></span>
<span class="w">     </span><span class="mi">11</span><span class="w"> </span><span class="mh">0xe0</span><span class="w"></span>
<span class="w">      </span><span class="mi">5</span><span class="w"> </span><span class="mh">0xf0</span><span class="w"></span>
<span class="w">      </span><span class="mi">7</span><span class="w"> </span><span class="mh">0x100</span><span class="w"></span>
<span class="w">      </span><span class="mi">5</span><span class="w"> </span><span class="mh">0x110</span><span class="w"></span>
<span class="w">      </span><span class="mi">4</span><span class="w"> </span><span class="mh">0x120</span><span class="w"></span>
<span class="w">      </span><span class="mi">3</span><span class="w"> </span><span class="mh">0x130</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="w"> </span><span class="mh">0x170</span><span class="w"></span>
<span class="w">      </span><span class="mi">3</span><span class="w"> </span><span class="mh">0x190</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="w"> </span><span class="mh">0x1b0</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="w"> </span><span class="mh">0x1e0</span><span class="w"></span>
<span class="w">      </span><span class="mi">2</span><span class="w"> </span><span class="mh">0x2f0</span><span class="w"></span>
</code></pre></div>
<p>or a maximum frame size of 752 bytes (on x86-64). The remaining delta from <a href="http://regalloc.rs">regalloc.rs</a> I believe can be explained by: (i) <a href="http://regalloc.rs">regalloc.rs</a> reuses frame space between integer and float/vec freelists, while RA2 does not, for simplicity (they are different size classes); and (ii) RA2 bounds the probing (testing for overlap of liveranges) of spillslots to 10 attempts max, to avoid quadratic behavior, while <a href="http://regalloc.rs">regalloc.rs</a> does not have such a bound, so gets more compaction sometimes at the cost of compile time.</p>
</blockquote>



<a name="284935030"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234214%20wasmtime%200.37%20has%20much%20smaller%20cal.../near/284935030" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234214.20wasmtime.200.2E37.20has.20much.20smaller.20cal.2E.2E.2E.html#284935030">(Jun 03 2022 at 21:28)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/4214#issuecomment-1146376049">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4214">issue #4214</a>:</p>
<blockquote>
<p>Changes are up in a PR; maybe if we're lucky, we can get it reviewed, version-bumped, and pulled into Cranelift today before the 0.38 branch starts its two-week freeze/fuzzing period on Jun 5 (this weekend)!</p>
</blockquote>



<a name="284946250"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234214%20wasmtime%200.37%20has%20much%20smaller%20cal.../near/284946250" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234214.20wasmtime.200.2E37.20has.20much.20smaller.20cal.2E.2E.2E.html#284946250">(Jun 04 2022 at 00:12)</a>:</h4>
<p>cfallin closed <a href="https://github.com/bytecodealliance/wasmtime/issues/4214">issue #4214</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/8832856/wasmtime-stack-py.zip">wasmtime-stack-py.zip</a> wasm32-wasi build of CPython main branch (3.12-dev) with part of the stdlib and a reproducer file.</p>
<h3>Steps to Reproduce</h3>
<ul>
<li>extract zipfile</li>
<li><code>cd wasmtime-stack-py</code></li>
<li>Run <code>wasmtime run --dir . python.wasm -- recursive.py 1500</code> with wasmtime 0.36 and 0.37</li>
</ul>
<h3>Expected Results</h3>
<p>wasmtime 0.36 works correctly with a Python recursion limit up to a little more than 1500.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Error</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="err">`</span><span class="n">python</span><span class="p">.</span><span class="n">wasm</span><span class="err">`</span><span class="w"></span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="mi">0</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="n">default</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">wasm</span><span class="w"> </span><span class="n">trap</span>: <span class="nc">call</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">exhausted</span><span class="w"></span>
<span class="w">       </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span>:
           <span class="mi">0</span>: <span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyEval_EvalFrameDefault</span><span class="w"></span>
<span class="w">           </span><span class="mi">1</span>: <span class="mh">0x14e399</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyEval_Vector</span><span class="w"></span>
<span class="w">           </span><span class="mi">2</span>: <span class="mh">0x57e85</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyFunction_Vectorcall</span><span class="w"></span>
<span class="w">           </span><span class="mi">3</span>: <span class="mh">0x57d9d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">PyObject_CallOneArg</span><span class="w"></span>
<span class="w">           </span><span class="mi">4</span>: <span class="mh">0xc85dd</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">slot_tp_repr</span><span class="w"></span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="w">         </span><span class="mi">3574</span>: <span class="mh">0x193776</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">run_mod</span><span class="w"></span>
<span class="w">         </span><span class="mi">3575</span>: <span class="mh">0x192e05</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyRun_SimpleFileObject</span><span class="w"></span>
<span class="w">         </span><span class="mi">3576</span>: <span class="mh">0x1924bb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyRun_AnyFileObject</span><span class="w"></span>
<span class="w">         </span><span class="mi">3577</span>: <span class="mh">0x1b23d3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">Py_RunMain</span><span class="w"></span>
<span class="w">         </span><span class="mi">3578</span>: <span class="mh">0x1b2ede</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">pymain_main</span><span class="w"></span>
<span class="w">         </span><span class="mi">3579</span>: <span class="mh">0x1b2f8d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">Py_BytesMain</span><span class="w"></span>
<span class="w">         </span><span class="mi">3580</span>: <span class="mh">0x4c52</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">main</span><span class="w"></span>
<span class="w">         </span><span class="mi">3581</span>: <span class="mh">0x31b09e</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__main_void</span><span class="w"></span>
<span class="w">         </span><span class="mi">3582</span>: <span class="mh">0x31b01d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__original_main</span><span class="w"></span>
<span class="w">         </span><span class="mi">3583</span>: <span class="mh">0x4c36</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_start</span><span class="w"></span>
<span class="w">         </span><span class="mi">3584</span>: <span class="mh">0x3343f7</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_start</span><span class="p">.</span><span class="n">command_export</span><span class="w"></span>
<span class="w">       </span><span class="n">note</span>: <span class="nc">using</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">`</span><span class="n">WASMTIME_BACKTRACE_DETAILS</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">debugging</span><span class="w"> </span><span class="n">information</span><span class="w"></span>
</code></pre></div>
<h3>Actual Results</h3>
<p>wasmtime 0.37 fails with a much lower recursion limit. It starts to run into call stack exhaustion at about 480 Python recursions and 1155 WASM call stacks. Please note that the highest WASM call stack number with wasmtime 0.36 is 3584.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Error</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="err">`</span><span class="n">python</span><span class="p">.</span><span class="n">wasm</span><span class="err">`</span><span class="w"></span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="mi">0</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="n">default</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">wasm</span><span class="w"> </span><span class="n">trap</span>: <span class="nc">call</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">exhausted</span><span class="w"></span>
<span class="w">       </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span>:
           <span class="mi">0</span>: <span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyEval_EvalFrameDefault</span><span class="w"></span>
<span class="w">           </span><span class="mi">1</span>: <span class="mh">0x14e399</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyEval_Vector</span><span class="w"></span>
<span class="w">           </span><span class="mi">2</span>: <span class="mh">0x57e85</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyFunction_Vectorcall</span><span class="w"></span>
<span class="w">           </span><span class="mi">3</span>: <span class="mh">0x57d9d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">PyObject_CallOneArg</span><span class="w"></span>
<span class="w">           </span><span class="mi">4</span>: <span class="mh">0xc85dd</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">slot_tp_repr</span><span class="w"></span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="w">         </span><span class="mi">1145</span>: <span class="mh">0x193776</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">run_mod</span><span class="w"></span>
<span class="w">         </span><span class="mi">1146</span>: <span class="mh">0x192e05</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyRun_SimpleFileObject</span><span class="w"></span>
<span class="w">         </span><span class="mi">1147</span>: <span class="mh">0x1924bb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_PyRun_AnyFileObject</span><span class="w"></span>
<span class="w">         </span><span class="mi">1148</span>: <span class="mh">0x1b23d3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">Py_RunMain</span><span class="w"></span>
<span class="w">         </span><span class="mi">1149</span>: <span class="mh">0x1b2ede</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">pymain_main</span><span class="w"></span>
<span class="w">         </span><span class="mi">1150</span>: <span class="mh">0x1b2f8d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">Py_BytesMain</span><span class="w"></span>
<span class="w">         </span><span class="mi">1151</span>: <span class="mh">0x4c52</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">main</span><span class="w"></span>
<span class="w">         </span><span class="mi">1152</span>: <span class="mh">0x31b09e</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__main_void</span><span class="w"></span>
<span class="w">         </span><span class="mi">1153</span>: <span class="mh">0x31b01d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__original_main</span><span class="w"></span>
<span class="w">         </span><span class="mi">1154</span>: <span class="mh">0x4c36</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_start</span><span class="w"></span>
<span class="w">         </span><span class="mi">1155</span>: <span class="mh">0x3343f7</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_start</span><span class="p">.</span><span class="n">command_export</span><span class="w"></span>
<span class="w">       </span><span class="n">note</span>: <span class="nc">using</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">`</span><span class="n">WASMTIME_BACKTRACE_DETAILS</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">debugging</span><span class="w"> </span><span class="n">information</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: wasmtime-v0.37.0-x86_64-linux</p>
<p>Operating system: Linux (Fedora 36)</p>
<p>Architecture: X84_64</p>
<p>WASI SDK: 16.0</p>
<p>Python 3.12-dev (latest commit on main as of today)</p>
<h3>Extra Info</h3>
<p>You can find build scripts and artifacts in the git repo <a href="https://github.com/ethanhs/python-wasm/">https://github.com/ethanhs/python-wasm/</a></p>
</blockquote>



<a name="284946286"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234214%20wasmtime%200.37%20has%20much%20smaller%20cal.../near/284946286" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234214.20wasmtime.200.2E37.20has.20much.20smaller.20cal.2E.2E.2E.html#284946286">(Jun 04 2022 at 00:13)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/4214#issuecomment-1146472444">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4214">issue #4214</a>:</p>
<blockquote>
<p>@tiran this just merged, and made the window for 0.38.0; assuming all goes well (i.e. we don't have to back anything out), it should be included in our release scheduled for Jun 20. Thanks again for the report!</p>
</blockquote>



<a name="284977489"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234214%20wasmtime%200.37%20has%20much%20smaller%20cal.../near/284977489" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234214.20wasmtime.200.2E37.20has.20much.20smaller.20cal.2E.2E.2E.html#284977489">(Jun 04 2022 at 12:34)</a>:</h4>
<p>tiran <a href="https://github.com/bytecodealliance/wasmtime/issues/4214#issuecomment-1146600972">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4214">issue #4214</a>:</p>
<blockquote>
<blockquote>
<p>@tiran this just merged, and made the window for 0.38.0; assuming all goes well (i.e. we don't have to back anything out), it should be included in our release scheduled for Jun 20. Thanks again for the report!</p>
</blockquote>
<p>Thank <strong>you</strong> for the quick analysis and fix. Much appreciated!</p>
<blockquote>
<p>The work you're doing sounds great though! If you've got specific issues with wasmtime's WASI support feel free to open issues here as well, and additionally if you've got thoughts about WASI in general I'm sure the WASI repository would be welcome to issues as well</p>
</blockquote>
<p>@alexcrichton Will do! :) As I mentioned before we are at a very early stage of WASI support. I'm new to WebAssembly world, too. I started with Emscripten support for CPython little more than half a year ago. I'll start to open feature requests once I have a better understanding of WASI. In the mean time you can find my notes at <a href="https://github.com/python/cpython/blob/main/Tools/wasm/README.md">https://github.com/python/cpython/blob/main/Tools/wasm/README.md</a></p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>