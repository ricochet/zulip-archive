<html>
<head><meta charset="utf-8"><title>wasmtime / PR #8939 test-programs: reorganize wasi conten... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238939.20test-programs.3A.20reorganize.20wasi.20conten.2E.2E.2E.html">wasmtime / PR #8939 test-programs: reorganize wasi conten...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="450848567"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238939%20test-programs%3A%20reorganize%20wasi%20conten.../near/450848567" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238939.20test-programs.3A.20reorganize.20wasi.20conten.2E.2E.2E.html#450848567">(Jul 12 2024 at 01:35)</a>:</h4>
<p>iawia002 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/8939">PR #8939</a>.</p>



<a name="451002501"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238939%20test-programs%3A%20reorganize%20wasi%20conten.../near/451002501" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238939.20test-programs.3A.20reorganize.20wasi.20conten.2E.2E.2E.html#451002501">(Jul 12 2024 at 15:03)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/8939#issuecomment-2225785028">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8939">PR #8939</a>:</p>
<blockquote>
<p>Could the WIT folder not be duplicated here? Since test-programs isn't published to <a href="http://crates.io">crates.io</a> it should be able to refer to the folder defined in the wasmtime-wasi or wasmtime-wasi-http crate</p>
</blockquote>



<a name="451011496"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238939%20test-programs%3A%20reorganize%20wasi%20conten.../near/451011496" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238939.20test-programs.3A.20reorganize.20wasi.20conten.2E.2E.2E.html#451011496">(Jul 12 2024 at 15:34)</a>:</h4>
<p>iawia002 <a href="https://github.com/bytecodealliance/wasmtime/pull/8939#issuecomment-2225839869">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8939">PR #8939</a>:</p>
<blockquote>
<p>Nope, it has to, as I mentioned before, this change is mainly for the upcoming addition of APIs like <code>wasi-runtime-config</code>. These APIs are not dependent on other APIs and are not depended on by other APIs, so their WIT files will not be included in the <code>wasi</code> or <code>wasi-http</code> crates. We will need the <code>test-programs</code> to include the WIT files of all APIs.</p>
</blockquote>



<a name="451012506"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238939%20test-programs%3A%20reorganize%20wasi%20conten.../near/451012506" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238939.20test-programs.3A.20reorganize.20wasi.20conten.2E.2E.2E.html#451012506">(Jul 12 2024 at 15:39)</a>:</h4>
<p>iawia002 <a href="https://github.com/bytecodealliance/wasmtime/pull/8939#issuecomment-2225849437">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8939">PR #8939</a>:</p>
<blockquote>
<p>And I plan to make some improvements to the <code>vendor-wit</code> script (pure bash script, no additional dependencies). Ultimately, each wasi API crate will only include the necessary WIT files. For example, <code>wasi-runtime-config</code> will only include one WIT dependency, and the implementation of <code>wasi-cli</code> will no longer include the WIT files for <code>wasi-http</code>.</p>
</blockquote>



<a name="451021012"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238939%20test-programs%3A%20reorganize%20wasi%20conten.../near/451021012" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238939.20test-programs.3A.20reorganize.20wasi.20conten.2E.2E.2E.html#451021012">(Jul 12 2024 at 16:16)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/8939#issuecomment-2225909824">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8939">PR #8939</a>:</p>
<blockquote>
<p>It's a bit difficult to review this as it's setting up for future changes I at least personally have not yet seen or reviewed. In that sense it's difficult to review changes when only half the motivation is apparent, so I'd ask you bear with me in my questions and review feedback here.</p>
<p>Ideally we only have one copy of all WIT files in-tree. Even today it's a bummer we have one copy in wasmtime-wasi and one copy in wasmtime-wasi-http. How we manage WIT has changed over time but we've never settled on something everyone's happy with. The current status quo is the sort of "local maximum" where it's low-overhead to maintain and the management in CI is relatively simple.</p>
<p>In-tree there's also two main "styles" of sorts (not many data points to draw from) of managing WIT. One is wasmtime-wasi/wasmtime-wasi-http which are somewhat "tied at the hip". They're managed similarly and have the same WIT files. Another is wasi-nn which, like wasi-runtime-config, has no other WIT dependencies and is managed differently. Everything has a <code>wit_bindgen::generate!</code> call in the <code>test-programs</code> crate. </p>
<p>With the eventual goal of adding wasi-runtime-config, I would recommend one of two routes:</p>
<ol>
<li>Follow the example of wasi-nn. This means that you'd add a few lines to the bash script to vendor wasi-runtime-config WIT files in a new directory. There'd be a new <code>wit_bindgen::generate!</code> call in test-programs as well. I don't think that it would require reorganizing things too much.</li>
<li>Refactor things before landing wasi-runtime-config to have a single <code>generate!</code> call in test-programs. That's sort of what this PR is doing but it's compromising on some of the initial design goals of our WIT management. I'll reiterate our WIT management is not great but we're also hoping to not make it worse (e.g. another copy of WIT in-tree).</li>
</ol>
<p>With the (1) route it should be possible to add everything today without changes. With (2) I would recommend first refactoring the <code>wit-bindgen</code> crate itself, for example it would probably be best to enable something like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">wit_bindgen</span><span class="p">::</span><span class="n">generate</span><span class="o">!</span><span class="p">({</span>
<span class="w">    </span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s">"../wasmtime-wasi/wit"</span><span class="p">,</span><span class="w"> </span><span class="s">"../wasmtime-wasi-http/wit"</span><span class="p">,</span><span class="w"> </span><span class="s">"../wasi-nn/wit"</span><span class="p">],</span>
<span class="w">    </span><span class="n">inline</span><span class="p">:</span><span class="w"> </span><span class="s">"</span>
<span class="s">        include wasi:cli/imports;</span>
<span class="s">        include wasi:http/imports;</span>
<span class="s">        include wasi:nn/imports;</span>
<span class="s">    "</span><span class="p">,</span>
<span class="p">});</span>
</code></pre></div>
<p>I don't think that's fully supported in <code>wit-bindgen</code> today but it shouldn't be too too hard to add. That would enable not needing to copy around WIT files while still enabling a single <code>generate!</code> call. There's need to be a separate <code>generate!</code> call for <code>wasi:http/proxy</code> and other worlds used by the test suite as well.</p>
</blockquote>



<a name="451030676"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238939%20test-programs%3A%20reorganize%20wasi%20conten.../near/451030676" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238939.20test-programs.3A.20reorganize.20wasi.20conten.2E.2E.2E.html#451030676">(Jul 12 2024 at 17:08)</a>:</h4>
<p>iawia002 <a href="https://github.com/bytecodealliance/wasmtime/pull/8939#issuecomment-2225985907">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8939">PR #8939</a>:</p>
<blockquote>
<p>Thanks for getting back to me, let's hold this for now.</p>
<p>My original intention for making these changes before implementing the <code>wasi-runtime-config</code> was to simplify the future PR and focus more on implementing the <code>wasi-runtime-config</code> API itself.</p>
<p>I was too fixated on getting these future tasks done beforehand. It seems I got the sequence of everything wrong. Let's go back to the beginning, after I have implemented the <code>wasi-runtime-config</code>, we can go back to those subsequent works.</p>
</blockquote>



<a name="452106004"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238939%20test-programs%3A%20reorganize%20wasi%20conten.../near/452106004" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238939.20test-programs.3A.20reorganize.20wasi.20conten.2E.2E.2E.html#452106004">(Jul 17 2024 at 15:17)</a>:</h4>
<p>alexcrichton closed without merge <a href="https://github.com/bytecodealliance/wasmtime/pull/8939">PR #8939</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>