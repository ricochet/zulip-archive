<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #1600 Allow different Handles to act as ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231600.20Allow.20different.20Handles.20to.20act.20as.20.2E.2E.2E.html">wasmtime / Issue #1600 Allow different Handles to act as ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="195299267"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231600%20Allow%20different%20Handles%20to%20act%20as%20.../near/195299267" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231600.20Allow.20different.20Handles.20to.20act.20as.20.2E.2E.2E.html#195299267">(Apr 25 2020 at 19:33)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/1600#issuecomment-619430025" title="https://github.com/bytecodealliance/wasmtime/pull/1600#issuecomment-619430025">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1600" title="https://github.com/bytecodealliance/wasmtime/pull/1600">Issue #1600</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @kubkon</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "wasi"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>kubkon: wasi</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action" title="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="195304452"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231600%20Allow%20different%20Handles%20to%20act%20as%20.../near/195304452" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231600.20Allow.20different.20Handles.20to.20act.20as.20.2E.2E.2E.html#195304452">(Apr 25 2020 at 21:50)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/1600#issuecomment-619445436" title="https://github.com/bytecodealliance/wasmtime/pull/1600#issuecomment-619445436">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1600" title="https://github.com/bytecodealliance/wasmtime/pull/1600">Issue #1600</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @peterhuene</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "wasmtime:c-api"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>peterhuene: wasmtime:c-api</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action" title="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="196902992"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231600%20Allow%20different%20Handles%20to%20act%20as%20.../near/196902992" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231600.20Allow.20different.20Handles.20to.20act.20as.20.2E.2E.2E.html#196902992">(May 08 2020 at 14:37)</a>:</h4>
<p>Ekleog <a href="https://github.com/bytecodealliance/wasmtime/pull/1600#issuecomment-625846936" title="https://github.com/bytecodealliance/wasmtime/pull/1600#issuecomment-625846936">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1600" title="https://github.com/bytecodealliance/wasmtime/pull/1600">Issue #1600</a>:</p>
<blockquote>
<p>This looks great! FWIW, I was about to open an issue asking for exactly this, for <a href="https://crates.io/crates/wasmtime-async" title="https://crates.io/crates/wasmtime-async">wasmtime-async</a>, so that it'd be possible to create a WASI context that uses async functions (potentially with blocking tasks, especially for file IO).</p>
<p>However, it looks like <code>preopened_dir</code> is not also hooked to take any <code>Handle</code>, in addition to taking <code>File</code>s. Would it be possible for it to take any <code>Handle</code>, so that it's not necessary to go through the entire directory hierarchy just to copy it into a <code>VirtualDirEntry</code> in memory?</p>
</blockquote>



<a name="198359585"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231600%20Allow%20different%20Handles%20to%20act%20as%20.../near/198359585" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231600.20Allow.20different.20Handles.20to.20act.20as.20.2E.2E.2E.html#198359585">(May 21 2020 at 18:42)</a>:</h4>
<p>kubkon <a href="https://github.com/bytecodealliance/wasmtime/pull/1600#issuecomment-632275987">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1600">Issue #1600</a>:</p>
<blockquote>
<p>@sunfishcode @pchickey Could you guys take a look and let me know if we're up for merging this change in, or would we rather wait for virtual dispatcher? Given that there a few reports from the users that this is a useful change, I'd vote for merging it in, and then redoing it when virtual dispatcher lands, but if you feel otherwise, I'm OK with it as well.</p>
</blockquote>



<a name="199943252"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231600%20Allow%20different%20Handles%20to%20act%20as%20.../near/199943252" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231600.20Allow.20different.20Handles.20to.20act.20as.20.2E.2E.2E.html#199943252">(Jun 05 2020 at 23:02)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/pull/1600#issuecomment-639882639">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1600">Issue #1600</a>:</p>
<blockquote>
<p>Bump ping @kubkon @sunfishcode @pchickey.  This blocks the <code>wasmtime-dotnet</code> CI from being green (see #1735), provided we fix my comment above.</p>
</blockquote>



<a name="200012457"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231600%20Allow%20different%20Handles%20to%20act%20as%20.../near/200012457" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231600.20Allow.20different.20Handles.20to.20act.20as.20.2E.2E.2E.html#200012457">(Jun 07 2020 at 07:39)</a>:</h4>
<p>kubkon <a href="https://github.com/bytecodealliance/wasmtime/pull/1600#issuecomment-640171692">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1600">Issue #1600</a>:</p>
<blockquote>
<p>@peterhuene this should be it. If you could double check that this indeed fixes #1735 in dotnet side that’d be great. When you confirm everything is green, I reckon we can go ahead and merge this in.</p>
</blockquote>



<a name="200135288"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231600%20Allow%20different%20Handles%20to%20act%20as%20.../near/200135288" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231600.20Allow.20different.20Handles.20to.20act.20as.20.2E.2E.2E.html#200135288">(Jun 08 2020 at 18:09)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/pull/1600#issuecomment-640787733">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1600">Issue #1600</a>:</p>
<blockquote>
<p>I'll write some docs for the newly exported types so that we can get this merged today.</p>
</blockquote>



<a name="200136230"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231600%20Allow%20different%20Handles%20to%20act%20as%20.../near/200136230" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231600.20Allow.20different.20Handles.20to.20act.20as.20.2E.2E.2E.html#200136230">(Jun 08 2020 at 18:17)</a>:</h4>
<p>kubkon <a href="https://github.com/bytecodealliance/wasmtime/pull/1600#issuecomment-640791398">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1600">Issue #1600</a>:</p>
<blockquote>
<p>Oh nice one, thanks @pchickey, and apologies I’ve not done this earlier myself!</p>
</blockquote>



<a name="200139789"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231600%20Allow%20different%20Handles%20to%20act%20as%20.../near/200139789" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231600.20Allow.20different.20Handles.20to.20act.20as.20.2E.2E.2E.html#200139789">(Jun 08 2020 at 18:44)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/pull/1600#issuecomment-640804907">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1600">Issue #1600</a>:</p>
<blockquote>
<p>I'll test this shortly with the .NET API and get back to you.</p>
</blockquote>



<a name="200144859"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231600%20Allow%20different%20Handles%20to%20act%20as%20.../near/200144859" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231600.20Allow.20different.20Handles.20to.20act.20as.20.2E.2E.2E.html#200144859">(Jun 08 2020 at 19:29)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/pull/1600#issuecomment-640833833">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1600">Issue #1600</a>:</p>
<blockquote>
<p>I can confirm this fixes #1735.</p>
</blockquote>



<a name="200155265"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231600%20Allow%20different%20Handles%20to%20act%20as%20.../near/200155265" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231600.20Allow.20different.20Handles.20to.20act.20as.20.2E.2E.2E.html#200155265">(Jun 08 2020 at 20:59)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/pull/1600#issuecomment-640883649">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1600">Issue #1600</a>:</p>
<blockquote>
<p>@kubkon It looks like for <code>OsDir</code>, <code>OsFile</code> and several of these types, the type itself has been exposed outside the crate but not any of its constructors. I don't think I understand why you'd need to write down this type but wouldnt be allowed to construct it - was this an oversight, or am I missing something?</p>
</blockquote>



<a name="200158210"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231600%20Allow%20different%20Handles%20to%20act%20as%20.../near/200158210" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231600.20Allow.20different.20Handles.20to.20act.20as.20.2E.2E.2E.html#200158210">(Jun 08 2020 at 21:27)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/pull/1600#issuecomment-640896712">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1600">Issue #1600</a>:</p>
<blockquote>
<p>The output of <code>#![warn(missing_docs)]</code> on wasi-common means we have some real work to do in both wiggle (which should be possible, since doc comments are in the witx ast!) and on <code>Handle</code> and many other places. There's also lots of snapshot 0 code that needs docs, but as legacy code we shouldn't sweat that as much for now.</p>
<div class="codehilite"><pre><span></span><code>From 6d0b0aad3da0e9b388f2b1c223c20acc2a3c5e87 Mon Sep 17 00:00:00 2001
From: Pat Hickey &lt;pat@moreproductive.org&gt;
Date: Mon, 8 Jun 2020 14:23:32 -0700
Subject: [PATCH] Add some documention to the types exposed by this PR, and a
 few others

---
 crates/wasi-common/src/sys/osfile.rs           | 3 +++
 crates/wasi-common/src/sys/osother.rs          | 2 ++
 crates/wasi-common/src/sys/unix/bsd/osdir.rs   | 7 ++++++-
 crates/wasi-common/src/sys/unix/linux/osdir.rs | 6 +++++-
 crates/wasi-common/src/virtfs.rs               | 4 ++++
 5 files changed, 20 insertions(+), 2 deletions(-)

diff --git a/crates/wasi-common/src/sys/osfile.rs b/crates/wasi-common/src/sys/osfile.rs
index e9ced03fc..d1ffd6369 100644
--- a/crates/wasi-common/src/sys/osfile.rs
+++ b/crates/wasi-common/src/sys/osfile.rs
@@ -9,6 +9,9 @@ use std::io::{self, Read, Seek, SeekFrom, Write};
 use std::ops::Deref;

 #[derive(Debug)]
+/// A file backed by the operating system&#39;s file system. Dereferences to a
+/// `RawOsHandle`.  Its impl of `Handle` uses Rust&#39;s `std` to implement all
+/// file descriptor operations.
 pub struct OsFile {
     rights: Cell&lt;HandleRights&gt;,
     handle: RawOsHandle,
diff --git a/crates/wasi-common/src/sys/osother.rs b/crates/wasi-common/src/sys/osother.rs
index 42f15c579..fcfa979ac 100644
--- a/crates/wasi-common/src/sys/osother.rs
+++ b/crates/wasi-common/src/sys/osother.rs
@@ -10,6 +10,8 @@ use std::fs::File;
 use std::io::{self, Read, Write};
 use std::ops::Deref;

+/// Extra methods for `OsOther` that are only available when configured for
+/// some operating systems.
 pub trait OsOtherExt {
     /// Create `OsOther` as `dyn Handle` from null device.
     fn from_null() -&gt; io::Result&lt;Box&lt;dyn Handle&gt;&gt;;
diff --git a/crates/wasi-common/src/sys/unix/bsd/osdir.rs b/crates/wasi-common/src/sys/unix/bsd/osdir.rs
index 7baa1939e..19d2e1f1b 100644
--- a/crates/wasi-common/src/sys/unix/bsd/osdir.rs
+++ b/crates/wasi-common/src/sys/unix/bsd/osdir.rs
@@ -6,6 +6,9 @@ use std::io;
 use yanix::dir::Dir;

 #[derive(Debug)]
+/// A directory in the operating system&#39;s file system. Its impl of `Handle` is
+/// in sys::osdir. This type is exposed to all other modules as
+/// sys::osdir::OsDir when configured.
 pub struct OsDir {
     pub(crate) rights: Cell&lt;HandleRights&gt;,
     pub(crate) handle: RawOsHandle,
@@ -39,7 +42,9 @@ impl OsDir {
             stream_ptr,
         })
     }

-    /// Returns the `Dir` stream pointer associated with this `OsDir`.
+    /// Returns the `Dir` stream pointer associated with this `OsDir`. Duck
+    /// typing: sys::unix::fd::readdir expects the configured OsDir to have
+    /// this method.
     pub(crate) fn stream_ptr(&amp;self) -&gt; Result&lt;RefMut&lt;Dir&gt;&gt; {
         Ok(self.stream_ptr.borrow_mut())
     }
diff --git a/crates/wasi-common/src/sys/unix/linux/osdir.rs b/crates/wasi-common/src/sys/unix/linux/osdir.rs
index f15d89a4c..e0747b72b 100644
--- a/crates/wasi-common/src/sys/unix/linux/osdir.rs
+++ b/crates/wasi-common/src/sys/unix/linux/osdir.rs
@@ -6,6 +6,9 @@ use std::io;
 use yanix::dir::Dir;

 #[derive(Debug)]
+/// A directory in the operating system&#39;s file system. Its impl of `Handle` is
+/// in sys::osdir. This type is exposed to all other moduleas as
+/// sys::osdir::OsDir when configured.
 pub struct OsDir {
     pub(crate) rights: Cell&lt;HandleRights&gt;,
     pub(crate) handle: RawOsHandle,
@@ -16,7 +19,8 @@ impl OsDir {
         let rights = Cell::new(rights);
         Ok(Self { rights, handle })
     }

-    /// Returns the `Dir` stream pointer associated with this `OsDir`.
+    /// Returns the `Dir` stream pointer associated with this `OsDir`. Duck typing:
+    /// sys::unix::fd::readdir expects the configured OsDir to have this method.
     pub(crate) fn stream_ptr(&amp;self) -&gt; Result&lt;Box&lt;Dir&gt;&gt; {
         // We need to duplicate the handle, because `opendir(3)`:
         //     After a successful call to fdopendir(), fd is used internally by the implementation,
diff --git a/crates/wasi-common/src/virtfs.rs b/crates/wasi-common/src/virtfs.rs
index 3d9b61b19..141a9cc69 100644
--- a/crates/wasi-common/src/virtfs.rs
+++ b/crates/wasi-common/src/virtfs.rs
@@ -11,12 +11,16 @@ use std::io::SeekFrom;
 use std::path::{Path, PathBuf};
 use std::rc::Rc;

+/// An entry in a virtual filesystem
 pub enum VirtualDirEntry {

+    /// The contents of a child directory
     Directory(HashMap&lt;String, VirtualDirEntry&gt;),

+    /// A file
     File(Box&lt;dyn FileContents&gt;),
 }

 impl VirtualDirEntry {

+    /// Construct an empty directory
     pub fn empty_directory() -&gt; Self {
         Self::Directory(HashMap::new())
     }
--
2.17.1
</code></pre></div>


</blockquote>



<a name="200158286"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231600%20Allow%20different%20Handles%20to%20act%20as%20.../near/200158286" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231600.20Allow.20different.20Handles.20to.20act.20as.20.2E.2E.2E.html#200158286">(Jun 08 2020 at 21:27)</a>:</h4>
<p>pchickey edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/1600#issuecomment-640896712">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1600">Issue #1600</a>:</p>
<blockquote>
<p>The output of <code>#![warn(missing_docs)]</code> on wasi-common means we have some real work to do in both wiggle (which should be possible, since doc comments are in the witx ast!) and on <code>Handle</code> and many other places. There's also lots of snapshot 0 code that needs docs, but as legacy code we shouldn't sweat that as much for now.</p>
<p>Apologies for posting a patch for some docs I added, I don't have any way to push to your branch since its in a different repo. (Do you not have write privs on this one? If not we should fix that)</p>
<div class="codehilite"><pre><span></span><code>From 6d0b0aad3da0e9b388f2b1c223c20acc2a3c5e87 Mon Sep 17 00:00:00 2001
From: Pat Hickey &lt;pat@moreproductive.org&gt;
Date: Mon, 8 Jun 2020 14:23:32 -0700
Subject: [PATCH] Add some documention to the types exposed by this PR, and a
 few others

---
 crates/wasi-common/src/sys/osfile.rs           | 3 +++
 crates/wasi-common/src/sys/osother.rs          | 2 ++
 crates/wasi-common/src/sys/unix/bsd/osdir.rs   | 7 ++++++-
 crates/wasi-common/src/sys/unix/linux/osdir.rs | 6 +++++-
 crates/wasi-common/src/virtfs.rs               | 4 ++++
 5 files changed, 20 insertions(+), 2 deletions(-)

diff --git a/crates/wasi-common/src/sys/osfile.rs b/crates/wasi-common/src/sys/osfile.rs
index e9ced03fc..d1ffd6369 100644
--- a/crates/wasi-common/src/sys/osfile.rs
+++ b/crates/wasi-common/src/sys/osfile.rs
@@ -9,6 +9,9 @@ use std::io::{self, Read, Seek, SeekFrom, Write};
 use std::ops::Deref;

 #[derive(Debug)]
+/// A file backed by the operating system&#39;s file system. Dereferences to a
+/// `RawOsHandle`.  Its impl of `Handle` uses Rust&#39;s `std` to implement all
+/// file descriptor operations.
 pub struct OsFile {
     rights: Cell&lt;HandleRights&gt;,
     handle: RawOsHandle,
diff --git a/crates/wasi-common/src/sys/osother.rs b/crates/wasi-common/src/sys/osother.rs
index 42f15c579..fcfa979ac 100644
--- a/crates/wasi-common/src/sys/osother.rs
+++ b/crates/wasi-common/src/sys/osother.rs
@@ -10,6 +10,8 @@ use std::fs::File;
 use std::io::{self, Read, Write};
 use std::ops::Deref;

+/// Extra methods for `OsOther` that are only available when configured for
+/// some operating systems.
 pub trait OsOtherExt {
     /// Create `OsOther` as `dyn Handle` from null device.
     fn from_null() -&gt; io::Result&lt;Box&lt;dyn Handle&gt;&gt;;
diff --git a/crates/wasi-common/src/sys/unix/bsd/osdir.rs b/crates/wasi-common/src/sys/unix/bsd/osdir.rs
index 7baa1939e..19d2e1f1b 100644
--- a/crates/wasi-common/src/sys/unix/bsd/osdir.rs
+++ b/crates/wasi-common/src/sys/unix/bsd/osdir.rs
@@ -6,6 +6,9 @@ use std::io;
 use yanix::dir::Dir;

 #[derive(Debug)]
+/// A directory in the operating system&#39;s file system. Its impl of `Handle` is
+/// in sys::osdir. This type is exposed to all other modules as
+/// sys::osdir::OsDir when configured.
 pub struct OsDir {
     pub(crate) rights: Cell&lt;HandleRights&gt;,
     pub(crate) handle: RawOsHandle,
@@ -39,7 +42,9 @@ impl OsDir {
             stream_ptr,
         })
     }

-    /// Returns the `Dir` stream pointer associated with this `OsDir`.
+    /// Returns the `Dir` stream pointer associated with this `OsDir`. Duck
+    /// typing: sys::unix::fd::readdir expects the configured OsDir to have
+    /// this method.
     pub(crate) fn stream_ptr(&amp;self) -&gt; Result&lt;RefMut&lt;Dir&gt;&gt; {
         Ok(self.stream_ptr.borrow_mut())
     }
diff --git a/crates/wasi-common/src/sys/unix/linux/osdir.rs b/crates/wasi-common/src/sys/unix/linux/osdir.rs
index f15d89a4c..e0747b72b 100644
--- a/crates/wasi-common/src/sys/unix/linux/osdir.rs
+++ b/crates/wasi-common/src/sys/unix/linux/osdir.rs
@@ -6,6 +6,9 @@ use std::io;
 use yanix::dir::Dir;

 #[derive(Debug)]
+/// A directory in the operating system&#39;s file system. Its impl of `Handle` is
+/// in sys::osdir. This type is exposed to all other moduleas as
+/// sys::osdir::OsDir when configured.
 pub struct OsDir {
     pub(crate) rights: Cell&lt;HandleRights&gt;,
     pub(crate) handle: RawOsHandle,
@@ -16,7 +19,8 @@ impl OsDir {
         let rights = Cell::new(rights);
         Ok(Self { rights, handle })
     }

-    /// Returns the `Dir` stream pointer associated with this `OsDir`.
+    /// Returns the `Dir` stream pointer associated with this `OsDir`. Duck typing:
+    /// sys::unix::fd::readdir expects the configured OsDir to have this method.
     pub(crate) fn stream_ptr(&amp;self) -&gt; Result&lt;Box&lt;Dir&gt;&gt; {
         // We need to duplicate the handle, because `opendir(3)`:
         //     After a successful call to fdopendir(), fd is used internally by the implementation,
diff --git a/crates/wasi-common/src/virtfs.rs b/crates/wasi-common/src/virtfs.rs
index 3d9b61b19..141a9cc69 100644
--- a/crates/wasi-common/src/virtfs.rs
+++ b/crates/wasi-common/src/virtfs.rs
@@ -11,12 +11,16 @@ use std::io::SeekFrom;
 use std::path::{Path, PathBuf};
 use std::rc::Rc;

+/// An entry in a virtual filesystem
 pub enum VirtualDirEntry {

+    /// The contents of a child directory
     Directory(HashMap&lt;String, VirtualDirEntry&gt;),

+    /// A file
     File(Box&lt;dyn FileContents&gt;),
 }

 impl VirtualDirEntry {

+    /// Construct an empty directory
     pub fn empty_directory() -&gt; Self {
         Self::Directory(HashMap::new())
     }
--
2.17.1
</code></pre></div>


</blockquote>



<a name="200190604"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231600%20Allow%20different%20Handles%20to%20act%20as%20.../near/200190604" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231600.20Allow.20different.20Handles.20to.20act.20as.20.2E.2E.2E.html#200190604">(Jun 09 2020 at 07:45)</a>:</h4>
<p>kubkon <a href="https://github.com/bytecodealliance/wasmtime/pull/1600#issuecomment-641098720">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1600">Issue #1600</a>:</p>
<blockquote>
<blockquote>
<p>@kubkon It looks like for <code>OsDir</code>, <code>OsFile</code> and several of these types, the type itself has been exposed outside the crate but not any of its constructors. I don't think I understand why you'd need to write down this type but wouldnt be allowed to construct it - was this an oversight, or am I missing something?</p>
</blockquote>
<p>Oh right, no, this was intentional. For the time being, the only way to create either of those is using <code>TryFrom</code>/<code>TryInto</code> trait from <code>std::fs::File</code>. This way I wanted to ensure that in case anyone ever tries to construct <code>OsFile</code> from a handle that's incompatible (such as a directory handle), then it would error out early. As an added bonus of this approach, the user doesn't have to worry about adjusting the <code>HandleRights</code> manually -- everything is done automatically when calling <code>TryFrom</code>/<code>TryInto</code>.</p>
<p>Here's an example usage I've had in mind:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">some_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OpenOptions</span>::<span class="n">new</span><span class="p">().</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;some_file&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">os_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OsFile</span>::<span class="n">try_from</span><span class="p">(</span><span class="n">some_file</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
</code></pre></div>


</blockquote>



<a name="200191224"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231600%20Allow%20different%20Handles%20to%20act%20as%20.../near/200191224" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231600.20Allow.20different.20Handles.20to.20act.20as.20.2E.2E.2E.html#200191224">(Jun 09 2020 at 07:52)</a>:</h4>
<p>kubkon edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/1600#issuecomment-641098720">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1600">Issue #1600</a>:</p>
<blockquote>
<blockquote>
<p>@kubkon It looks like for <code>OsDir</code>, <code>OsFile</code> and several of these types, the type itself has been exposed outside the crate but not any of its constructors. I don't think I understand why you'd need to write down this type but wouldnt be allowed to construct it - was this an oversight, or am I missing something?</p>
</blockquote>
<p>Oh right, no, this was intentional. For the time being, the only way to create either of those is using <code>TryFrom</code>/<code>TryInto</code> trait from <code>std::fs::File</code>. This way I wanted to ensure that in case anyone ever tries to construct <code>OsFile</code> from a handle that's incompatible (such as a directory handle), then it would error out early. As an added bonus of this approach, the user doesn't have to worry about adjusting the <code>HandleRights</code> manually -- everything is done automatically when calling <code>TryFrom</code>/<code>TryInto</code>.</p>
<p>Here's an example usage I've had in mind:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">some_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OpenOptions</span>::<span class="n">new</span><span class="p">().</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;some_file&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">os_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OsFile</span>::<span class="n">try_from</span><span class="p">(</span><span class="n">some_file</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
</code></pre></div>


<p>Having said all that, I'm happy to add an explicit constructor for this to make it more readable and usable, something like <code>OsFile::new(file)</code>.</p>
</blockquote>



<a name="200191390"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231600%20Allow%20different%20Handles%20to%20act%20as%20.../near/200191390" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231600.20Allow.20different.20Handles.20to.20act.20as.20.2E.2E.2E.html#200191390">(Jun 09 2020 at 07:54)</a>:</h4>
<p>kubkon <a href="https://github.com/bytecodealliance/wasmtime/pull/1600#issuecomment-641103967">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1600">Issue #1600</a>:</p>
<blockquote>
<blockquote>
<p>The output of <code>#![warn(missing_docs)]</code> on wasi-common means we have some real work to do in both wiggle (which should be possible, since doc comments are in the witx ast!) and on <code>Handle</code> and many other places. There's also lots of snapshot 0 code that needs docs, but as legacy code we shouldn't sweat that as much for now.</p>
<p>Apologies for posting a patch for some docs I added, I don't have any way to push to your branch since its in a different repo. (Do you not have write privs on this one? If not we should fix that)</p>
<p>```<br>
From 6d0b0aad3da0e9b388f2b1c223c20acc2a3c5e87 Mon Sep 17 00:00:00 2001<br>
From: Pat Hickey &lt;<a href="mailto:pat@moreproductive.org">pat@moreproductive.org</a>&gt;<br>
Date: Mon, 8 Jun 2020 14:23:32 -0700<br>
Subject: [PATCH] Add some documention to the types exposed by this PR, and a<br>
 few others</p>
<hr>
<p>crates/wasi-common/src/sys/osfile.rs           | 3 +++<br>
 crates/wasi-common/src/sys/osother.rs          | 2 ++<br>
 crates/wasi-common/src/sys/unix/bsd/osdir.rs   | 7 ++++++-<br>
 crates/wasi-common/src/sys/unix/linux/osdir.rs | 6 +++++-<br>
 crates/wasi-common/src/virtfs.rs               | 4 ++++<br>
 5 files changed, 20 insertions(+), 2 deletions(-)</p>
<p>diff --git a/crates/wasi-common/src/sys/osfile.rs b/crates/wasi-common/src/sys/osfile.rs<br>
index e9ced03fc..d1ffd6369 100644<br>
--- a/crates/wasi-common/src/sys/osfile.rs<br>
+++ b/crates/wasi-common/src/sys/osfile.rs<br>
@@ -9,6 +9,9 @@ use std::io::{self, Read, Seek, SeekFrom, Write};<br>
 use std::ops::Deref;</p>
<p>#[derive(Debug)]<br>
+/// A file backed by the operating system's file system. Dereferences to a<br>
+/// <code>RawOsHandle</code>.  Its impl of <code>Handle</code> uses Rust's <code>std</code> to implement all<br>
+/// file descriptor operations.<br>
 pub struct OsFile {<br>
     rights: Cell&lt;HandleRights&gt;,<br>
     handle: RawOsHandle,<br>
diff --git a/crates/wasi-common/src/sys/osother.rs b/crates/wasi-common/src/sys/osother.rs<br>
index 42f15c579..fcfa979ac 100644<br>
--- a/crates/wasi-common/src/sys/osother.rs<br>
+++ b/crates/wasi-common/src/sys/osother.rs<br>
@@ -10,6 +10,8 @@ use std::fs::File;<br>
 use std::io::{self, Read, Write};<br>
 use std::ops::Deref;</p>
<p>+/// Extra methods for <code>OsOther</code> that are only available when configured for<br>
+/// some operating systems.<br>
 pub trait OsOtherExt {<br>
     /// Create <code>OsOther</code> as <code>dyn Handle</code> from null device.<br>
     fn from_null() -&gt; io::Result&lt;Box&lt;dyn Handle&gt;&gt;;<br>
diff --git a/crates/wasi-common/src/sys/unix/bsd/osdir.rs b/crates/wasi-common/src/sys/unix/bsd/osdir.rs<br>
index 7baa1939e..19d2e1f1b 100644<br>
--- a/crates/wasi-common/src/sys/unix/bsd/osdir.rs<br>
+++ b/crates/wasi-common/src/sys/unix/bsd/osdir.rs<br>
@@ -6,6 +6,9 @@ use std::io;<br>
 use yanix::dir::Dir;</p>
<p>#[derive(Debug)]<br>
+/// A directory in the operating system's file system. Its impl of <code>Handle</code> is<br>
+/// in sys::osdir. This type is exposed to all other modules as<br>
+/// sys::osdir::OsDir when configured.<br>
 pub struct OsDir {<br>
     pub(crate) rights: Cell&lt;HandleRights&gt;,<br>
     pub(crate) handle: RawOsHandle,<br>
@@ -39,7 +42,9 @@ impl OsDir {<br>
             stream_ptr,<br>
         })<br>
     }<br>
-    /// Returns the <code>Dir</code> stream pointer associated with this <code>OsDir</code>.<br>
+    /// Returns the <code>Dir</code> stream pointer associated with this <code>OsDir</code>. Duck<br>
+    /// typing: sys::unix::fd::readdir expects the configured OsDir to have<br>
+    /// this method.<br>
     pub(crate) fn stream_ptr(&amp;self) -&gt; Result&lt;RefMut&lt;Dir&gt;&gt; {<br>
         Ok(self.stream_ptr.borrow_mut())<br>
     }<br>
diff --git a/crates/wasi-common/src/sys/unix/linux/osdir.rs b/crates/wasi-common/src/sys/unix/linux/osdir.rs<br>
index f15d89a4c..e0747b72b 100644<br>
--- a/crates/wasi-common/src/sys/unix/linux/osdir.rs<br>
+++ b/crates/wasi-common/src/sys/unix/linux/osdir.rs<br>
@@ -6,6 +6,9 @@ use std::io;<br>
 use yanix::dir::Dir;</p>
<p>#[derive(Debug)]<br>
+/// A directory in the operating system's file system. Its impl of <code>Handle</code> is<br>
+/// in sys::osdir. This type is exposed to all other moduleas as<br>
+/// sys::osdir::OsDir when configured.<br>
 pub struct OsDir {<br>
     pub(crate) rights: Cell&lt;HandleRights&gt;,<br>
     pub(crate) handle: RawOsHandle,<br>
@@ -16,7 +19,8 @@ impl OsDir {<br>
         let rights = Cell::new(rights);<br>
         Ok(Self { rights, handle })<br>
     }<br>
-    /// Returns the <code>Dir</code> stream pointer associated with this <code>OsDir</code>.<br>
+    /// Returns the <code>Dir</code> stream pointer associated with this <code>OsDir</code>. Duck typing:<br>
+    /// sys::unix::fd::readdir expects the configured OsDir to have this method.<br>
     pub(crate) fn stream_ptr(&amp;self) -&gt; Result&lt;Box&lt;Dir&gt;&gt; {<br>
         // We need to duplicate the handle, because <code>opendir(3)</code>:<br>
         //     After a successful call to fdopendir(), fd is used internally by the implementation,<br>
diff --git a/crates/wasi-common/src/virtfs.rs b/crates/wasi-common/src/virtfs.rs<br>
index 3d9b61b19..141a9cc69 100644<br>
--- a/crates/wasi-common/src/virtfs.rs<br>
+++ b/crates/wasi-common/src/virtfs.rs<br>
@@ -11,12 +11,16 @@ use std::io::SeekFrom;<br>
 use std::path::{Path, PathBuf};<br>
 use std::rc::Rc;</p>
<p>+/// An entry in a virtual filesystem<br>
 pub enum VirtualDirEntry {<br>
+    /// The contents of a child directory<br>
     Directory(HashMap&lt;String, VirtualDirEntry&gt;),<br>
+    /// A file<br>
     File(Box&lt;dyn FileContents&gt;),<br>
 }</p>
<p>impl VirtualDirEntry {<br>
+    /// Construct an empty directory<br>
     pub fn empty_directory() -&gt; Self {<br>
         Self::Directory(HashMap::new())<br>
     }<br>
-- <br>
2.17.1<br>
```</p>
</blockquote>
<p>Hmm, I thought you should be able to push directly to my branch in my fork. And yes, I do have write permissions, however, I always prefer to work out of my fork so as to shield myself from stupid mistakes such as force-pushing into <code>master</code> etc. Anyhow, that's OK, I'll add your patch into my branch myself <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span>. Lemme know what you reckon about the constructors of <code>OsFile</code>, etc. (whether you think we should add explicit ones or <code>TryFrom</code> trait is enough).</p>
</blockquote>



<a name="200216319"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231600%20Allow%20different%20Handles%20to%20act%20as%20.../near/200216319" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231600.20Allow.20different.20Handles.20to.20act.20as.20.2E.2E.2E.html#200216319">(Jun 09 2020 at 12:18)</a>:</h4>
<p>kubkon <a href="https://github.com/bytecodealliance/wasmtime/pull/1600#issuecomment-641251504">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1600">Issue #1600</a>:</p>
<blockquote>
<p>@pchickey I've applied your patch (thanks!), and extended the docs with some constructing examples. Have a look and lemme know what you reckon!</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>