<html>
<head><meta charset="utf-8"><title>wasmtime / issue #5109 More control over fuel consumption · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235109.20More.20control.20over.20fuel.20consumption.html">wasmtime / issue #5109 More control over fuel consumption</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="305904738"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235109%20More%20control%20over%20fuel%20consumption/near/305904738" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235109.20More.20control.20over.20fuel.20consumption.html#305904738">(Oct 24 2022 at 20:03)</a>:</h4>
<p>coolreader18 opened <a href="https://github.com/bytecodealliance/wasmtime/issues/5109">issue #5109</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>A set of new APIs that provide more control over fuel consumption:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[cfg(feature = </span><span class="s">"custom-fuel-cost"</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">fuel_cost</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="nc">impl</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasmparser</span>::<span class="n">Operator</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u64</span> <span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="nb">static</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="bp">Self</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">Store</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">fuel_remaining</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// Returns an error if the store is not configured for fuel consumption</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">set_fuel</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h4>Benefit</h4>
<p>Allows more direct control over fuel consumption and filling, letting users set custom fuel costs for each operand if they deem some to be more costly/intensive in their environment, as well letting them set precisely how much fuel they might allow a single function call or set of function calls.</p>
<h4>Implementation</h4>
<p>I have an implementation for the custom fuel cost configuration, and the methods on <code>Store</code> should be fairly trivial.</p>
<h4>Alternatives</h4>
<p><code>fuel_remaining</code> and <code>set_fuel</code> can be approximated by <code>consume_fuel(0)</code> and <code>if new_fuel &gt; fuel_remaining() { add_fuel(delta) } else { consume_fuel(delta) }</code> respectively. <code>fuel_cost</code> cannot be emulated, so the alternative is to just accept wasmtime's default cost function. As an alternative in designing the API, the <code>fuel_cost</code> closure could perhaps take a <code>wasmtime::Operator</code> or <code>wasmtime::OperatorCategory</code> enum, so as to avoid exposing <code>wasmparser</code> in the public API. However, both of those approaches have issues (a duplicate <code>Operator</code> is.. okay actually thinking about it, if it were to just define another <code>enum Operator</code> using <a href="https://docs.rs/wasmparser/latest/wasmparser/macro.for_each_operator.html"><code>wasmparser::for_each_operator!</code></a> that might not be too bad. That's a valid second option, if wasmparser in public API (behind a feature flag) isn't something that's desirable.</p>
</blockquote>



<a name="305905450"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235109%20More%20control%20over%20fuel%20consumption/near/305905450" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235109.20More.20control.20over.20fuel.20consumption.html#305905450">(Oct 24 2022 at 20:08)</a>:</h4>
<p>coolreader18 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/5109">issue #5109</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>A set of new APIs that provide more control over fuel consumption:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[cfg(feature = </span><span class="s">"custom-fuel-cost"</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">fuel_cost</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="nc">impl</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasmparser</span>::<span class="n">Operator</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u64</span> <span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="nb">static</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="bp">Self</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">Store</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">fuel_remaining</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// Returns an error if the store is not configured for fuel consumption</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">set_fuel</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h4>Benefit</h4>
<p>Allows more direct control over fuel consumption and filling, letting users set custom fuel costs for each operand if they deem some to be more costly/intensive in their environment, as well letting them set precisely how much fuel they might allow a single function call or set of function calls.</p>
<h4>Implementation</h4>
<p>I have an implementation for the custom fuel cost configuration, and the methods on <code>Store</code> should be fairly trivial.</p>
<h4>Alternatives</h4>
<p><code>fuel_remaining</code> and <code>set_fuel</code> can be approximated by <code>consume_fuel(0)</code> and <code>if new_fuel &gt; fuel_remaining() { add_fuel(delta) } else { consume_fuel(delta) }</code> respectively. <code>fuel_cost</code> cannot be emulated, so the alternative is to just accept wasmtime's default cost function. As an alternative in designing the API, the <code>fuel_cost</code> closure could perhaps take a <code>wasmtime::Operator</code> or <code>wasmtime::OperatorCategory</code> enum, so as to avoid exposing <code>wasmparser</code> in the public API. However, both of those approaches have issues (a duplicate <code>Operator</code> is.. okay actually thinking about it, if it were to just define another <code>enum Operator</code> using <a href="https://docs.rs/wasmparser/latest/wasmparser/macro.for_each_operator.html"><code>wasmparser::for_each_operator!</code></a> (maybe without the parameters at all, just the opcodes themselves?) that might not be too bad. That's a valid second option, if wasmparser in public API (behind a feature flag) isn't something that's desirable.</p>
</blockquote>



<a name="305905508"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235109%20More%20control%20over%20fuel%20consumption/near/305905508" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235109.20More.20control.20over.20fuel.20consumption.html#305905508">(Oct 24 2022 at 20:09)</a>:</h4>
<p>coolreader18 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/5109">issue #5109</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>A set of new APIs that provide more control over fuel consumption:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[cfg(feature = </span><span class="s">"custom-fuel-cost"</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">fuel_cost</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="nc">impl</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasmparser</span>::<span class="n">Operator</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u64</span> <span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="nb">static</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="bp">Self</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">Store</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">fuel_remaining</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// Returns an error if the store is not configured for fuel consumption</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">set_fuel</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h4>Benefit</h4>
<p>Allows more direct control over fuel consumption and filling, letting users set custom fuel costs for each operand if they deem some to be more costly/intensive in their environment, as well letting them set precisely how much fuel they might allow a single function call or set of function calls.</p>
<h4>Implementation</h4>
<p>I have an implementation for the custom fuel cost configuration, and the methods on <code>Store</code> should be fairly trivial.</p>
<h4>Alternatives</h4>
<p><code>fuel_remaining</code> and <code>set_fuel</code> can be approximated by <code>consume_fuel(0)</code> and <code>if new_fuel &gt; fuel_remaining() { add_fuel(delta) } else { consume_fuel(delta) }</code> respectively. <code>fuel_cost</code> cannot be emulated, so the alternative is to just accept wasmtime's default cost function. As an alternative in designing the API, the <code>fuel_cost</code> closure could perhaps take a <code>wasmtime::Operator</code> or <code>wasmtime::OperatorCategory</code> enum, so as to avoid exposing <code>wasmparser</code> in the public API. However, both of those approaches have issues (a duplicate <code>Operator</code> is.. okay actually thinking about it, if it were to just define another <code>enum Operator</code> using <a href="https://docs.rs/wasmparser/latest/wasmparser/macro.for_each_operator.html"><code>wasmparser::for_each_operator!</code></a> (maybe without the parameters at all, just the opcodes themselves?) that might not be too bad. That's a valid second option, if wasmparser in public API (behind a feature flag) isn't something that's desirable.<br>
Edit: actually yeah that sounds like a really good idea I'm gonna change my impl to do that.</p>
</blockquote>



<a name="305914715"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235109%20More%20control%20over%20fuel%20consumption/near/305914715" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235109.20More.20control.20over.20fuel.20consumption.html#305914715">(Oct 24 2022 at 21:13)</a>:</h4>
<p>coolreader18 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/5109">issue #5109</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>A set of new APIs that provide more control over fuel consumption:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[cfg(feature = </span><span class="s">"custom-fuel-cost"</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">fuel_cost</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="nc">impl</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasmparser</span>::<span class="n">Operator</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u64</span> <span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="nb">static</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="bp">Self</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">Store</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">fuel_remaining</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// Returns an error if the store is not configured for fuel consumption</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">set_fuel</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="cp">#[non_exhaustive]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">OutOfFuelError</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<h4>Benefit</h4>
<p>Allows more direct control over fuel consumption and filling, letting users set custom fuel costs for each operand if they deem some to be more costly/intensive in their environment, as well letting them set precisely how much fuel they might allow a single function call or set of function calls. <code>OutOfFuelError</code> being made public allows users to check when a Trap was caused by fuel running out.</p>
<h4>Implementation</h4>
<p>I have an implementation for the custom fuel cost configuration, and the methods on <code>Store</code> should be fairly trivial.</p>
<h4>Alternatives</h4>
<p><code>fuel_remaining</code> and <code>set_fuel</code> can be approximated by <code>consume_fuel(0)</code> and <code>if new_fuel &gt; fuel_remaining() { add_fuel(delta) } else { consume_fuel(delta) }</code> respectively. <code>fuel_cost</code> cannot be emulated, so the alternative is to just accept wasmtime's default cost function. As an alternative in designing the API, the <code>fuel_cost</code> closure could perhaps take a <code>wasmtime::Operator</code> or <code>wasmtime::OperatorCategory</code> enum, so as to avoid exposing <code>wasmparser</code> in the public API. However, both of those approaches have issues (a duplicate <code>Operator</code> is.. okay actually thinking about it, if it were to just define another <code>enum Operator</code> using <a href="https://docs.rs/wasmparser/latest/wasmparser/macro.for_each_operator.html"><code>wasmparser::for_each_operator!</code></a> (maybe without the parameters at all, just the opcodes themselves?) that might not be too bad. That's a valid second option, if wasmparser in public API (behind a feature flag) isn't something that's desirable.</p>
</blockquote>



<a name="305915382"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235109%20More%20control%20over%20fuel%20consumption/near/305915382" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235109.20More.20control.20over.20fuel.20consumption.html#305915382">(Oct 24 2022 at 21:18)</a>:</h4>
<p>coolreader18 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/5109">issue #5109</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>A set of new APIs that provide more control over fuel consumption:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[cfg(feature = </span><span class="s">"custom-fuel-cost"</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">fuel_cost</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="nc">impl</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasmparser</span>::<span class="n">Operator</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u64</span> <span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="nb">static</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="bp">Self</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">Store</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">fuel_remaining</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// Returns an error if the store is not configured for fuel consumption</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">set_fuel</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="cp">#[non_exhaustive]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">OutOfFuelError</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<h4>Benefit</h4>
<p>Allows more direct control over fuel consumption and filling, letting users set custom fuel costs for each operand if they deem some to be more costly/intensive in their environment, as well letting them set precisely how much fuel they might allow a single function call or set of function calls. <code>OutOfFuelError</code> being made public allows users to check when a Trap was caused by fuel running out.</p>
<h4>Implementation</h4>
<p>I have an implementation for the custom fuel cost configuration, and the methods on <code>Store</code> should be fairly trivial.</p>
<h4>Alternatives</h4>
<p><code>fuel_remaining</code> and <code>set_fuel</code> can be approximated by <code>consume_fuel(0)</code> and <code>if new_fuel &gt; fuel_remaining() { add_fuel(delta) } else { consume_fuel(delta) }</code> respectively. <code>fuel_cost</code> cannot be emulated, so the alternative is to just accept wasmtime's default cost function. As an alternative in designing the API, the <code>fuel_cost</code> closure could perhaps take a <code>wasmtime::Operator</code> or <code>wasmtime::OperatorCategory</code> enum, so as to avoid exposing <code>wasmparser</code> in the public API. However, both of those approaches have issues (a duplicate <code>Operator</code> is.. okay actually thinking about it, if it were to just define another <code>enum Operator</code> using <a href="https://docs.rs/wasmparser/latest/wasmparser/macro.for_each_operator.html"><code>wasmparser::for_each_operator!</code></a> (maybe without the parameters at all, just the opcodes themselves?) that might not be too bad. That's a valid second option, if wasmparser in public API (behind a feature flag) isn't something that's desirable.<br>
Edit: actually yeah that sounds like a really good idea I'm gonna change my impl to do that.</p>
</blockquote>



<a name="305915611"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235109%20More%20control%20over%20fuel%20consumption/near/305915611" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235109.20More.20control.20over.20fuel.20consumption.html#305915611">(Oct 24 2022 at 21:20)</a>:</h4>
<p>coolreader18 <a href="https://github.com/bytecodealliance/wasmtime/issues/5109#issuecomment-1289631300">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5109">issue #5109</a>:</p>
<blockquote>
<p>Oh, looks like wasmtime-fuzzing has a shim for <code>set_fuel</code> the same as I described:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/fuzzing/src/oracles.rs#L790-L802">https://github.com/bytecodealliance/wasmtime/blob/main/crates/fuzzing/src/oracles.rs#L790-L802</a></p>
</blockquote>



<a name="305916067"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235109%20More%20control%20over%20fuel%20consumption/near/305916067" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235109.20More.20control.20over.20fuel.20consumption.html#305916067">(Oct 24 2022 at 21:23)</a>:</h4>
<p>coolreader18 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/5109">issue #5109</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>A set of new APIs that provide more control over fuel consumption:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">fuel_cost</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="nc">impl</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="n">WasmOpcode</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u64</span> <span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="nb">static</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="bp">Self</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">enum</span> <span class="nc">WasmOpcode</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Unreachable</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Nop</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Block</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Loop</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">Store</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">fuel_remaining</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// Returns an error if the store is not configured for fuel consumption</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">set_fuel</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="cp">#[non_exhaustive]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">OutOfFuelError</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<h4>Benefit</h4>
<p>Allows more direct control over fuel consumption and filling, letting users set custom fuel costs for each operand if they deem some to be more costly/intensive in their environment, as well letting them set precisely how much fuel they might allow a single function call or set of function calls. <code>OutOfFuelError</code> being made public allows users to check when a Trap was caused by fuel running out.</p>
<h4>Implementation</h4>
<p>I have an implementation for the custom fuel cost configuration, and the methods on <code>Store</code> should be fairly trivial.</p>
<h4>Alternatives</h4>
<p><code>fuel_remaining</code> and <code>set_fuel</code> can be approximated by <code>consume_fuel(0)</code> and <code>if new_fuel &gt; fuel_remaining() { add_fuel(delta) } else { consume_fuel(delta) }</code> respectively. <code>fuel_cost</code> cannot be emulated, so the alternative is to just accept wasmtime's default cost function. As an alternative in designing the API, the <code>fuel_cost</code> closure could take a <code>&amp;wasmparser::Operator&lt;'_&gt;</code> as it did in the original version of this issue. However, that would require exposing <code>wasmparser</code> in wasmtime's public api, which is undesirable.</p>
</blockquote>



<a name="326499506"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235109%20More%20control%20over%20fuel%20consumption/near/326499506" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235109.20More.20control.20over.20fuel.20consumption.html#326499506">(Feb 08 2023 at 03:40)</a>:</h4>
<p>howjmay <a href="https://github.com/bytecodealliance/wasmtime/issues/5109#issuecomment-1421948169">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5109">issue #5109</a>:</p>
<blockquote>
<p>Hi I am curious why #5220 can help us set customized fuel for each opcode?</p>
</blockquote>



<a name="396955245"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235109%20More%20control%20over%20fuel%20consumption/near/396955245" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235109.20More.20control.20over.20fuel.20consumption.html#396955245">(Oct 16 2023 at 18:24)</a>:</h4>
<p>fitzgen closed <a href="https://github.com/bytecodealliance/wasmtime/issues/5109">issue #5109</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>A set of new APIs that provide more control over fuel consumption:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">fuel_cost</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="nc">impl</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="n">WasmOpcode</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u64</span> <span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="nb">static</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="bp">Self</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">enum</span> <span class="nc">WasmOpcode</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Unreachable</span><span class="p">,</span>
<span class="w">    </span><span class="n">Nop</span><span class="p">,</span>
<span class="w">    </span><span class="n">Block</span><span class="p">,</span>
<span class="w">    </span><span class="n">Loop</span><span class="p">,</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
<span class="k">impl</span><span class="w"> </span><span class="n">Store</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">fuel_remaining</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="sd">/// Returns an error if the store is not configured for fuel consumption</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">set_fuel</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#[non_exhaustive]</span>
<span class="k">struct</span> <span class="nc">OutOfFuelError</span><span class="p">;</span>
</code></pre></div>
<h4>Benefit</h4>
<p>Allows more direct control over fuel consumption and filling, letting users set custom fuel costs for each operand if they deem some to be more costly/intensive in their environment, as well letting them set precisely how much fuel they might allow a single function call or set of function calls. <code>OutOfFuelError</code> being made public allows users to check when a Trap was caused by fuel running out.</p>
<h4>Implementation</h4>
<p>I have an implementation for the custom fuel cost configuration, and the methods on <code>Store</code> should be fairly trivial.</p>
<h4>Alternatives</h4>
<p><code>fuel_remaining</code> and <code>set_fuel</code> can be approximated by <code>consume_fuel(0)</code> and <code>if new_fuel &gt; fuel_remaining() { add_fuel(delta) } else { consume_fuel(delta) }</code> respectively. <code>fuel_cost</code> cannot be emulated, so the alternative is to just accept wasmtime's default cost function. As an alternative in designing the API, the <code>fuel_cost</code> closure could take a <code>&amp;wasmparser::Operator&lt;'_&gt;</code> as it did in the original version of this issue. However, that would require exposing <code>wasmparser</code> in wasmtime's public api, which is undesirable.</p>
</blockquote>



<a name="396974024"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235109%20More%20control%20over%20fuel%20consumption/near/396974024" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235109.20More.20control.20over.20fuel.20consumption.html#396974024">(Oct 16 2023 at 20:38)</a>:</h4>
<p>RReverser <a href="https://github.com/bytecodealliance/wasmtime/issues/5109#issuecomment-1765234771">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5109">issue #5109</a>:</p>
<blockquote>
<p>Looks like #7240 only adds <code>reset_fuel</code>, I don't think it should've auto-closed this issue?</p>
<p>In particular,</p>
<blockquote>
<p><code>fn fuel_cost(&amp;mut self, f: impl Fn(WasmOpcode) -&gt; u64 + Send + Sync + 'static) -&gt; &amp;mut Self;</code></p>
</blockquote>
<p>this would be still desirable.</p>
</blockquote>



<a name="396987658"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235109%20More%20control%20over%20fuel%20consumption/near/396987658" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235109.20More.20control.20over.20fuel.20consumption.html#396987658">(Oct 16 2023 at 22:45)</a>:</h4>
<p>alexcrichton reopened <a href="https://github.com/bytecodealliance/wasmtime/issues/5109">issue #5109</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>A set of new APIs that provide more control over fuel consumption:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">fuel_cost</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="nc">impl</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="n">WasmOpcode</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u64</span> <span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="nb">static</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="bp">Self</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">enum</span> <span class="nc">WasmOpcode</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Unreachable</span><span class="p">,</span>
<span class="w">    </span><span class="n">Nop</span><span class="p">,</span>
<span class="w">    </span><span class="n">Block</span><span class="p">,</span>
<span class="w">    </span><span class="n">Loop</span><span class="p">,</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
<span class="k">impl</span><span class="w"> </span><span class="n">Store</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">fuel_remaining</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="sd">/// Returns an error if the store is not configured for fuel consumption</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">set_fuel</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#[non_exhaustive]</span>
<span class="k">struct</span> <span class="nc">OutOfFuelError</span><span class="p">;</span>
</code></pre></div>
<h4>Benefit</h4>
<p>Allows more direct control over fuel consumption and filling, letting users set custom fuel costs for each operand if they deem some to be more costly/intensive in their environment, as well letting them set precisely how much fuel they might allow a single function call or set of function calls. <code>OutOfFuelError</code> being made public allows users to check when a Trap was caused by fuel running out.</p>
<h4>Implementation</h4>
<p>I have an implementation for the custom fuel cost configuration, and the methods on <code>Store</code> should be fairly trivial.</p>
<h4>Alternatives</h4>
<p><code>fuel_remaining</code> and <code>set_fuel</code> can be approximated by <code>consume_fuel(0)</code> and <code>if new_fuel &gt; fuel_remaining() { add_fuel(delta) } else { consume_fuel(delta) }</code> respectively. <code>fuel_cost</code> cannot be emulated, so the alternative is to just accept wasmtime's default cost function. As an alternative in designing the API, the <code>fuel_cost</code> closure could take a <code>&amp;wasmparser::Operator&lt;'_&gt;</code> as it did in the original version of this issue. However, that would require exposing <code>wasmparser</code> in wasmtime's public api, which is undesirable.</p>
</blockquote>



<a name="397093596"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235109%20More%20control%20over%20fuel%20consumption/near/397093596" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235109.20More.20control.20over.20fuel.20consumption.html#397093596">(Oct 17 2023 at 12:02)</a>:</h4>
<p>rockwotj <a href="https://github.com/bytecodealliance/wasmtime/issues/5109#issuecomment-1766275526">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5109">issue #5109</a>:</p>
<blockquote>
<p>Apologies for this getting closed. I was picking up #5220 which also would have closed this issue. Maybe @coolreader18 could update this issue to have it be more about a custom cost function for fuel APIs?</p>
<p>Also if you have opinions on store fuel related APIs would love to hear there here <a href="https://github.com/bytecodealliance/wasmtime/issues/7255">https://github.com/bytecodealliance/wasmtime/issues/7255</a></p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>