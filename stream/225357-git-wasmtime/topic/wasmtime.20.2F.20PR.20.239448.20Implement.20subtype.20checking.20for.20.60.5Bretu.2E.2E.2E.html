<html>
<head><meta charset="utf-8"><title>wasmtime / PR #9448 Implement subtype checking for `[retu... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239448.20Implement.20subtype.20checking.20for.20.60.5Bretu.2E.2E.2E.html">wasmtime / PR #9448 Implement subtype checking for `[retu...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="476192213"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239448%20Implement%20subtype%20checking%20for%20%60%5Bretu.../near/476192213" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239448.20Implement.20subtype.20checking.20for.20.60.5Bretu.2E.2E.2E.html#476192213">(Oct 10 2024 at 18:10)</a>:</h4>
<p>fitzgen opened <a href="https://github.com/bytecodealliance/wasmtime/pull/9448">PR #9448</a> from <code>fitzgen:subtype-checking-for-call-indirect</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>When Wasm GC is enabled, the <code>[return_]call_indirect</code> instructions must do full subtyping checks, rather than simple strict equality type checks.</p>
<p>This adds an additional branch and slow path to indirect calls, so we only emit code for this check when Wasm GC is enabled, even though it would otherwise be correct to always emit it (because the <code>is_subtype</code> check would always fail for non-equal types, since there is no subtyping before Wasm GC).</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="476192214"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239448%20Implement%20subtype%20checking%20for%20%60%5Bretu.../near/476192214" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239448.20Implement.20subtype.20checking.20for.20.60.5Bretu.2E.2E.2E.html#476192214">(Oct 10 2024 at 18:10)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9448">PR #9448</a>.</p>



<a name="476192216"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239448%20Implement%20subtype%20checking%20for%20%60%5Bretu.../near/476192216" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239448.20Implement.20subtype.20checking.20for.20.60.5Bretu.2E.2E.2E.html#476192216">(Oct 10 2024 at 18:10)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9448">PR #9448</a>.</p>



<a name="476192217"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239448%20Implement%20subtype%20checking%20for%20%60%5Bretu.../near/476192217" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239448.20Implement.20subtype.20checking.20for.20.60.5Bretu.2E.2E.2E.html#476192217">(Oct 10 2024 at 18:10)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9448">PR #9448</a>.</p>



<a name="476192218"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239448%20Implement%20subtype%20checking%20for%20%60%5Bretu.../near/476192218" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239448.20Implement.20subtype.20checking.20for.20.60.5Bretu.2E.2E.2E.html#476192218">(Oct 10 2024 at 18:10)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9448">PR #9448</a>.</p>



<a name="476192428"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239448%20Implement%20subtype%20checking%20for%20%60%5Bretu.../near/476192428" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239448.20Implement.20subtype.20checking.20for.20.60.5Bretu.2E.2E.2E.html#476192428">(Oct 10 2024 at 18:11)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9448">PR #9448</a>.</p>



<a name="476198691"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239448%20Implement%20subtype%20checking%20for%20%60%5Bretu.../near/476198691" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239448.20Implement.20subtype.20checking.20for.20.60.5Bretu.2E.2E.2E.html#476198691">(Oct 10 2024 at 18:38)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9448">PR #9448</a>.</p>



<a name="476213464"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239448%20Implement%20subtype%20checking%20for%20%60%5Bretu.../near/476213464" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239448.20Implement.20subtype.20checking.20for.20.60.5Bretu.2E.2E.2E.html#476213464">(Oct 10 2024 at 19:55)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9448#pullrequestreview-2361279266">PR review</a>:</p>
<blockquote>
<p>Mind filing an issue for this performance issue as well? This to me is going to be a hard blocker for enabling GC by default because a failed subtype check will involve acquiring a global lock even for non-GC modules which may not be appropriate for all embedders.</p>
</blockquote>



<a name="476213466"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239448%20Implement%20subtype%20checking%20for%20%60%5Bretu.../near/476213466" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239448.20Implement.20subtype.20checking.20for.20.60.5Bretu.2E.2E.2E.html#476213466">(Oct 10 2024 at 19:55)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9448#discussion_r1796008513">PR review comment</a>:</p>
<blockquote>
<p>Should this be <code>features.function_references() || features.gc()</code>? Or just <code>features.function_references()</code>?</p>
</blockquote>



<a name="476213491"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239448%20Implement%20subtype%20checking%20for%20%60%5Bretu.../near/476213491" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239448.20Implement.20subtype.20checking.20for.20.60.5Bretu.2E.2E.2E.html#476213491">(Oct 10 2024 at 19:55)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9448#pullrequestreview-2361280981">PR review</a>.</p>



<a name="476231722"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239448%20Implement%20subtype%20checking%20for%20%60%5Bretu.../near/476231722" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239448.20Implement.20subtype.20checking.20for.20.60.5Bretu.2E.2E.2E.html#476231722">(Oct 10 2024 at 21:53)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9448#pullrequestreview-2361484688">PR review</a>.</p>



<a name="476231723"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239448%20Implement%20subtype%20checking%20for%20%60%5Bretu.../near/476231723" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239448.20Implement.20subtype.20checking.20for.20.60.5Bretu.2E.2E.2E.html#476231723">(Oct 10 2024 at 21:53)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/9448#discussion_r1796139938">PR review comment</a>:</p>
<blockquote>
<p>I believe just <code>gc</code></p>
</blockquote>



<a name="476232340"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239448%20Implement%20subtype%20checking%20for%20%60%5Bretu.../near/476232340" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239448.20Implement.20subtype.20checking.20for.20.60.5Bretu.2E.2E.2E.html#476232340">(Oct 10 2024 at 21:57)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/9448#issuecomment-2406110810">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9448">PR #9448</a>:</p>
<blockquote>
<blockquote>
<p>Mind filing an issue for this performance issue as well? This to me is going to be a hard blocker for enabling GC by default because a failed subtype check will involve acquiring a global lock even for non-GC modules which may not be appropriate for all embedders.</p>
</blockquote>
<p>Added an item to <a href="https://github.com/bytecodealliance/wasmtime/issues/9351">https://github.com/bytecodealliance/wasmtime/issues/9351</a></p>
<p>I think much of this is equivalent to making <code>ref.test</code> fast (i.e. expose the supertypes arrays to wasm so that we can do the O(1) subtype check inline, rather than behind a lock) but even after we address that, it is another branch to another slow path to do a full subtype check when the types don't exactly match.</p>
</blockquote>



<a name="476238402"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239448%20Implement%20subtype%20checking%20for%20%60%5Bretu.../near/476238402" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239448.20Implement.20subtype.20checking.20for.20.60.5Bretu.2E.2E.2E.html#476238402">(Oct 10 2024 at 22:42)</a>:</h4>
<p>fitzgen merged <a href="https://github.com/bytecodealliance/wasmtime/pull/9448">PR #9448</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>