<html>
<head><meta charset="utf-8"><title>wasmtime / PR #9851 winch: Gracefully handle compilation ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239851.20winch.3A.20Gracefully.20handle.20compilation.20.2E.2E.2E.html">wasmtime / PR #9851 winch: Gracefully handle compilation ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="489793189"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239851%20winch%3A%20Gracefully%20handle%20compilation%20.../near/489793189" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239851.20winch.3A.20Gracefully.20handle.20compilation.20.2E.2E.2E.html#489793189">(Dec 18 2024 at 16:14)</a>:</h4>
<p><strong>saulecabrera</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9851">PR #9851</a>.</p>



<a name="489793191"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239851%20winch%3A%20Gracefully%20handle%20compilation%20.../near/489793191" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239851.20winch.3A.20Gracefully.20handle.20compilation.20.2E.2E.2E.html#489793191">(Dec 18 2024 at 16:14)</a>:</h4>
<p>saulecabrera opened <a href="https://github.com/bytecodealliance/wasmtime/pull/9851">PR #9851</a> from <code>saulecabrera:winch-no-panics</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Closes: <a href="https://github.com/bytecodealliance/wasmtime/issues/8096">https://github.com/bytecodealliance/wasmtime/issues/8096</a></p>
<p>This commit threads <code>anyhow::Result</code>  through most of Winch's compilation process in order to gracefully handle compilation errors gracefully instead of panicking.</p>
<p>The error classification is intentionally very granular, to avoid string allocation which could impact compilation performance.</p>
<p>The errors are largely fit in two categories:</p>
<ul>
<li>Unimplemented/Unsupported</li>
<li>Internal</li>
</ul>
<p>The firs category signals partial or no support for Wasmtime features and or Wasm proposals. These errors are meant to be temporary while such features or proposals are in development.</p>
<p>The second category signals that a compilation invariant was not met. These errors are considered internal and their presence usually means a bug in the compiler.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="489793193"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239851%20winch%3A%20Gracefully%20handle%20compilation%20.../near/489793193" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239851.20winch.3A.20Gracefully.20handle.20compilation.20.2E.2E.2E.html#489793193">(Dec 18 2024 at 16:14)</a>:</h4>
<p><strong>saulecabrera</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9851">PR #9851</a>.</p>



<a name="489793194"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239851%20winch%3A%20Gracefully%20handle%20compilation%20.../near/489793194" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239851.20winch.3A.20Gracefully.20handle.20compilation.20.2E.2E.2E.html#489793194">(Dec 18 2024 at 16:14)</a>:</h4>
<p><strong>saulecabrera</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers">wasmtime-default-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9851">PR #9851</a>.</p>



<a name="489793641"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239851%20winch%3A%20Gracefully%20handle%20compilation%20.../near/489793641" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239851.20winch.3A.20Gracefully.20handle.20compilation.20.2E.2E.2E.html#489793641">(Dec 18 2024 at 16:16)</a>:</h4>
<p>saulecabrera edited <a href="https://github.com/bytecodealliance/wasmtime/pull/9851">PR #9851</a>:</p>
<blockquote>
<p>Closes: <a href="https://github.com/bytecodealliance/wasmtime/issues/8096">https://github.com/bytecodealliance/wasmtime/issues/8096</a></p>
<p>This commit threads <code>anyhow::Result</code>  through most of Winch's compilation process in order to gracefully handle compilation errors instead of panicking.</p>
<p>The error classification is intentionally very granular, to avoid string allocation which could impact compilation performance.</p>
<p>The errors are largely fit in two categories:</p>
<ul>
<li>Unimplemented/Unsupported</li>
<li>Internal</li>
</ul>
<p>The firs category signals partial or no support for Wasmtime features and or Wasm proposals. These errors are meant to be temporary while such features or proposals are in development.</p>
<p>The second category signals that a compilation invariant was not met. These errors are considered internal and their presence usually means a bug in the compiler.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="489793685"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239851%20winch%3A%20Gracefully%20handle%20compilation%20.../near/489793685" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239851.20winch.3A.20Gracefully.20handle.20compilation.20.2E.2E.2E.html#489793685">(Dec 18 2024 at 16:16)</a>:</h4>
<p>saulecabrera edited <a href="https://github.com/bytecodealliance/wasmtime/pull/9851">PR #9851</a>:</p>
<blockquote>
<p>Closes: <a href="https://github.com/bytecodealliance/wasmtime/issues/8096">https://github.com/bytecodealliance/wasmtime/issues/8096</a></p>
<p>This commit threads <code>anyhow::Result</code>  through most of Winch's compilation process in order to gracefully handle compilation errors instead of panicking.</p>
<p>The error classification is intentionally very granular, to avoid string allocation which could impact compilation performance.</p>
<p>The errors largely fit in two categories:</p>
<ul>
<li>Unimplemented/Unsupported</li>
<li>Internal</li>
</ul>
<p>The firs category signals partial or no support for Wasmtime features and or Wasm proposals. These errors are meant to be temporary while such features or proposals are in development.</p>
<p>The second category signals that a compilation invariant was not met. These errors are considered internal and their presence usually means a bug in the compiler.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="489810664"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239851%20winch%3A%20Gracefully%20handle%20compilation%20.../near/489810664" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239851.20winch.3A.20Gracefully.20handle.20compilation.20.2E.2E.2E.html#489810664">(Dec 18 2024 at 17:44)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/9851#issuecomment-2551926437">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9851">PR #9851</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @saulecabrera</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "winch"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>saulecabrera: winch</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="489837686"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239851%20winch%3A%20Gracefully%20handle%20compilation%20.../near/489837686" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239851.20winch.3A.20Gracefully.20handle.20compilation.20.2E.2E.2E.html#489837686">(Dec 18 2024 at 20:39)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/9851#issuecomment-2552227734">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9851">PR #9851</a>:</p>
<blockquote>
<blockquote>
<p>The second category signals that a compilation invariant was not met. These errors are considered internal and their presence usually means a bug in the compiler.</p>
</blockquote>
<p>This category seems like it should probably result in panics? At least, in the outer winch compilation driver code?</p>
</blockquote>



<a name="489838493"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239851%20winch%3A%20Gracefully%20handle%20compilation%20.../near/489838493" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239851.20winch.3A.20Gracefully.20handle.20compilation.20.2E.2E.2E.html#489838493">(Dec 18 2024 at 20:46)</a>:</h4>
<p>saulecabrera <a href="https://github.com/bytecodealliance/wasmtime/pull/9851#issuecomment-2552237429">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9851">PR #9851</a>:</p>
<blockquote>
<p>Ultimately it should I think: thinking through a bit more I don't think there's a case in which we want to bubble these errors up as recoverable. Given the classification done in this PR I think it'll easy to check if the contained error is internal and panic at that point. I'll add that in. </p>
</blockquote>



<a name="489838570"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239851%20winch%3A%20Gracefully%20handle%20compilation%20.../near/489838570" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239851.20winch.3A.20Gracefully.20handle.20compilation.20.2E.2E.2E.html#489838570">(Dec 18 2024 at 20:47)</a>:</h4>
<p>saulecabrera edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/9851#issuecomment-2552237429">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9851">PR #9851</a>:</p>
<blockquote>
<p>Ultimately it should I think: thinking through a bit more I don't think there's a case in which we want to bubble these errors up as recoverable. Given the classification done in this PR I think it'll be easy to check (at the top level) if the contained error is internal and panic at that point. I'll add that in. </p>
</blockquote>



<a name="489838639"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239851%20winch%3A%20Gracefully%20handle%20compilation%20.../near/489838639" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239851.20winch.3A.20Gracefully.20handle.20compilation.20.2E.2E.2E.html#489838639">(Dec 18 2024 at 20:47)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9851#pullrequestreview-2512831583">PR review</a>:</p>
<blockquote>
<p>LGTM. </p>
<p>Don't really need to address the comment about internal errors before landing this (or even at all, if there is good motivation I am missing).</p>
<p>FWIW, if you are only using custom errors, it may make sense to avoid using <code>anyhow::Result</code> and <code>anyhow::Error</code> all through winch and just define a custom <code>type Result&lt;T, E = WinchError&gt; = core::result::Result&lt;T, E&gt;;</code>.</p>
</blockquote>



<a name="491516699"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239851%20winch%3A%20Gracefully%20handle%20compilation%20.../near/491516699" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239851.20winch.3A.20Gracefully.20handle.20compilation.20.2E.2E.2E.html#491516699">(Jan 01 2025 at 17:44)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9851">PR #9851</a>.</p>



<a name="491517453"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239851%20winch%3A%20Gracefully%20handle%20compilation%20.../near/491517453" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239851.20winch.3A.20Gracefully.20handle.20compilation.20.2E.2E.2E.html#491517453">(Jan 01 2025 at 17:56)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9851">PR #9851</a>.</p>



<a name="491517734"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239851%20winch%3A%20Gracefully%20handle%20compilation%20.../near/491517734" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239851.20winch.3A.20Gracefully.20handle.20compilation.20.2E.2E.2E.html#491517734">(Jan 01 2025 at 18:01)</a>:</h4>
<p>saulecabrera <a href="https://github.com/bytecodealliance/wasmtime/pull/9851#issuecomment-2567096311">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9851">PR #9851</a>:</p>
<blockquote>
<blockquote>
<p>FWIW, if you are only using custom errors, it may make sense to avoid using anyhow::Result and anyhow::Error all through winch and just define a custom type Result&lt;T, E = WinchError&gt; = core::result::Result&lt;T, E&gt;;</p>
</blockquote>
<p>Good point, I should've mentioned the rationale for going with <code>anyhow</code>  rather than a custom <code>Result&lt;T, WinchError&gt;</code> in my commit message. That was my initial intention, however, since the code generation pass is intertwined with validation of other crates (e.g., <code>wasmparser</code>), I found it easier to handle cross-crate error definitions through anyhow, at the cost of a bit more verbosity in Winch's code base. </p>
</blockquote>



<a name="491519450"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239851%20winch%3A%20Gracefully%20handle%20compilation%20.../near/491519450" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239851.20winch.3A.20Gracefully.20handle.20compilation.20.2E.2E.2E.html#491519450">(Jan 01 2025 at 18:31)</a>:</h4>
<p>saulecabrera merged <a href="https://github.com/bytecodealliance/wasmtime/pull/9851">PR #9851</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>