<html>
<head><meta charset="utf-8"><title>wasmtime / issue #5152 Call stack exhaustion found via CP... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235152.20Call.20stack.20exhaustion.20found.20via.20CP.2E.2E.2E.html">wasmtime / issue #5152 Call stack exhaustion found via CP...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="306732993"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235152%20Call%20stack%20exhaustion%20found%20via%20CP.../near/306732993" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235152.20Call.20stack.20exhaustion.20found.20via.20CP.2E.2E.2E.html#306732993">(Oct 28 2022 at 19:25)</a>:</h4>
<p>brettcannon opened <a href="https://github.com/bytecodealliance/wasmtime/issues/5152">issue #5152</a>:</p>
<blockquote>
<p>Thanks for filing a bug report! Please fill out the TODOs below.</p>
<p><strong>Note: if you want to report a security issue, please read our <a href="https://bytecodealliance.org/security">security policy</a>!</strong></p>
<h3>Test Case</h3>
<p><code>test_marshal</code> from Python's test suite.</p>
<h3>Steps to Reproduce</h3>
<p>Easiest to just look at a GitHub Action run, e.g. <a href="https://github.com/tiran/cpython-wasm-test/actions/runs/3342891022/jobs/5535571299">https://github.com/tiran/cpython-wasm-test/actions/runs/3342891022/jobs/5535571299</a> .</p>
<h3>Expected Results</h3>
<p>The test to at least complete.</p>
<h3>Actual Results</h3>
<p>Call stack exhaustion which doesn't occur under wasmtime 1.0.1.</p>
<p><a href="https://github.com/tiran/cpython-wasm-test/actions/runs/3294946299/jobs/5432988265#step:7:408">https://github.com/tiran/cpython-wasm-test/actions/runs/3294946299/jobs/5432988265#step:7:408</a></p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: latest</p>
<p>Operating system: Linux</p>
<p>Architecture: x64</p>
<h3>Extra Info</h3>
<p>This started occurring on October 22: <a href="https://github.com/tiran/cpython-wasm-test/actions/workflows/wasi.yml">https://github.com/tiran/cpython-wasm-test/actions/workflows/wasi.yml</a> . As mentioned above, wasmtime 1.0.1 passes without issue and everything was fine until something changed between October 19th @ 22:04 and October 20th @ 22:13 for what <a href="https://wasmtime.dev/install.sh">https://wasmtime.dev/install.sh</a> installs.</p>
</blockquote>



<a name="306732995"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235152%20Call%20stack%20exhaustion%20found%20via%20CP.../near/306732995" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235152.20Call.20stack.20exhaustion.20found.20via.20CP.2E.2E.2E.html#306732995">(Oct 28 2022 at 19:25)</a>:</h4>
<p>brettcannon labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/5152">issue #5152</a>:</p>
<blockquote>
<p>Thanks for filing a bug report! Please fill out the TODOs below.</p>
<p><strong>Note: if you want to report a security issue, please read our <a href="https://bytecodealliance.org/security">security policy</a>!</strong></p>
<h3>Test Case</h3>
<p><code>test_marshal</code> from Python's test suite.</p>
<h3>Steps to Reproduce</h3>
<p>Easiest to just look at a GitHub Action run, e.g. <a href="https://github.com/tiran/cpython-wasm-test/actions/runs/3342891022/jobs/5535571299">https://github.com/tiran/cpython-wasm-test/actions/runs/3342891022/jobs/5535571299</a> .</p>
<h3>Expected Results</h3>
<p>The test to at least complete.</p>
<h3>Actual Results</h3>
<p>Call stack exhaustion which doesn't occur under wasmtime 1.0.1.</p>
<p><a href="https://github.com/tiran/cpython-wasm-test/actions/runs/3294946299/jobs/5432988265#step:7:408">https://github.com/tiran/cpython-wasm-test/actions/runs/3294946299/jobs/5432988265#step:7:408</a></p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: latest</p>
<p>Operating system: Linux</p>
<p>Architecture: x64</p>
<h3>Extra Info</h3>
<p>This started occurring on October 22: <a href="https://github.com/tiran/cpython-wasm-test/actions/workflows/wasi.yml">https://github.com/tiran/cpython-wasm-test/actions/workflows/wasi.yml</a> . As mentioned above, wasmtime 1.0.1 passes without issue and everything was fine until something changed between October 19th @ 22:04 and October 20th @ 22:13 for what <a href="https://wasmtime.dev/install.sh">https://wasmtime.dev/install.sh</a> installs.</p>
</blockquote>



<a name="306733010"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235152%20Call%20stack%20exhaustion%20found%20via%20CP.../near/306733010" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235152.20Call.20stack.20exhaustion.20found.20via.20CP.2E.2E.2E.html#306733010">(Oct 28 2022 at 19:25)</a>:</h4>
<p>brettcannon <a href="https://github.com/bytecodealliance/wasmtime/issues/5152#issuecomment-1295371691">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5152">issue #5152</a>:</p>
<blockquote>
<p>/cc @tiran</p>
</blockquote>



<a name="306734507"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235152%20Call%20stack%20exhaustion%20found%20via%20CP.../near/306734507" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235152.20Call.20stack.20exhaustion.20found.20via.20CP.2E.2E.2E.html#306734507">(Oct 28 2022 at 19:34)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/5152#issuecomment-1295379624">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5152">issue #5152</a>:</p>
<blockquote>
<p>A few bits of info that would help, if you wouldn't mind investigating further on your end:</p>
<ul>
<li>What is this test case doing? Is it supposed to recurse deeply, but "not too deeply"? In other words, is the failure because we don't support a depth of recursion that we previously did, or because something else went wrong (correctness bug etc) that is causing infinite recursion now?</li>
<li>If it's a quantitative (how much recursion) rather than qualitative (recursion at all) bug, could you try to "bisect the limit" a bit and play with the test case's recursion depth, to see how much worse it got? E.g., did the test slip in <em>just under</em> a stack limit before, and it is <em>just over</em> now? Or did we explode stack usage per frame by a large factor?</li>
</ul>
<p>Nothing major changed in regalloc or codegen between 1.0 and 2.0 that would lead to a large expansion of stackframe size, at least off the top of my head, but if the above investigation shows that we somehow have a much lower limit, we can of course dig in and see what's going on.</p>
<p>Thanks!</p>
</blockquote>



<a name="306759468"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235152%20Call%20stack%20exhaustion%20found%20via%20CP.../near/306759468" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235152.20Call.20stack.20exhaustion.20found.20via.20CP.2E.2E.2E.html#306759468">(Oct 28 2022 at 22:22)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/issues/5152#issuecomment-1295544253">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5152">issue #5152</a>:</p>
<blockquote>
<p>I haven't tried reproducing this locally, but I was curious and looked through the failing test's source code a bit. I'm guessing the specific failing test is <a href="https://github.com/python/cpython/blob/76449350b3467b85bcb565f9e2bf945bd150a66e/Lib/test/test_marshal.py#L254"><code>test_recursion_limit</code></a>.</p>
<p>That test expects to be able to recurse over a data structure nested about 2,000 levels deep, and expects <code>marshal.c</code>'s <a href="https://github.com/python/cpython/blob/6dcfd6c5e3cb46543e82dc3f7234546adf4bb04a/Python/marshal.c#L350"><code>w_object</code></a> function to raise <code>ValueError</code> if the data structure is any deeper. Since that function is mutually recursive with <code>w_complex_object</code>, this corresponds to a C stack depth of about 4,000 frames, plus a few for setting up the test. And the stack trace recorded in CI does show these two functions alternating many times, so I think this is the correct proximate cause.</p>
<p>So I guess that makes this a "quantitative" recursion bug.</p>
</blockquote>



<a name="306769363"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235152%20Call%20stack%20exhaustion%20found%20via%20CP.../near/306769363" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235152.20Call.20stack.20exhaustion.20found.20via.20CP.2E.2E.2E.html#306769363">(Oct 29 2022 at 00:08)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/5152#issuecomment-1295653936">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5152">issue #5152</a>:</p>
<blockquote>
<p>I tried to download the <a href="https://github.com/tiran/cpython-wasm-test/actions/runs/3286958701">last successful build's</a> copy of <code>python.wasm</code>, but it has unfortunately expired and I could not acquire it. Instead downloaded the 3.11 rc2 from <a href="https://github.com/tiran/cpython-wasm-test/releases">here</a> and with this file:</p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="kn">import</span> <span class="nn">marshal</span>

<span class="n">head</span> <span class="o">=</span> <span class="n">last</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">MAX_MARSHAL_STACK_DEPTH</span> <span class="o">=</span> <span class="mi">2000</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MAX_MARSHAL_STACK_DEPTH</span> <span class="o">-</span> <span class="mi">2</span><span class="p">):</span>
    <span class="n">last</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">last</span> <span class="o">=</span> <span class="n">last</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">marshal</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">head</span><span class="p">)</span>
<span class="n">new_head</span> <span class="o">=</span> <span class="n">marshal</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>
<p>this succeeded:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">release</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">dir</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">cache</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">python</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">foo</span><span class="p">.</span><span class="n">py</span><span class="w"></span>
</code></pre></div>
<p>for all of <code>main</code>, v1.0.0, v1.0.1, v2.0.0, and v2.0.1 on an x86_64 machine.</p>
<p>On an aaarch64 machine v1.0.0 and <code>main</code> both stack overflow. The <code>main</code> branch stack is 3111 wasm frames deep and the v1.0.0 overflows at 3112 frames deep, so not all that different.</p>
<p>Basically I unfortunately am unable to easily reproduce, and at least on AArch64 I can see a small difference in stack usage but nothing meaningful.</p>
<hr>
<p>I'd echo what @cfallin said and reiterate @brettcannon if you're able it would be very helpful to reduce this issue to ideally "here's a wasm file and a directory tree and a command that fails." We can probably take it from there but without that it may be unlikely much can be done here.</p>
</blockquote>



<a name="306877115"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235152%20Call%20stack%20exhaustion%20found%20via%20CP.../near/306877115" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235152.20Call.20stack.20exhaustion.20found.20via.20CP.2E.2E.2E.html#306877115">(Oct 29 2022 at 18:50)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/5152#issuecomment-1295935301">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5152">issue #5152</a>:</p>
<blockquote>
<p>Ok with some further testing and hammering I was able to get something. At 29c7de7 it takes 497712 bytes of stack to complete this test. At the next commit, 9715d91, it takes 528752 bytes of stack. The default allowed stack is 524288, which is why this is stack overflowing.</p>
<p>The stack required increased by 6%. Of the two co-recursive functions, <code>w_object</code>'s stack size did not increase from 0x50 bytes and <code>w_complex_object</code>'s stack size increased from 0x80 to 0x90 bytes. This represents a 7.7% increase in stack size for these two functions combined.</p>
<p>Overall I think that should fully explain what's going on here. A small increase in stack from <code>w_complex_object</code> happened to hit the limit. Otherwise everything appears to be normal.</p>
<p>I'll leave @jameysharp to conclude whether <a href="https://github.com/bytecodealliance/wasmtime/pull/4966">https://github.com/bytecodealliance/wasmtime/pull/4966</a> should have increased the stack size here or not. I've extracted the single function to this wasm file: <a href="https://github.com/bytecodealliance/wasmtime/files/9894367/extract.wasm.gz">extract.wasm.gz</a> where I get:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">before</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">extract</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">objdump</span><span class="w"> </span><span class="o">-</span><span class="n">S</span><span class="w"> </span><span class="n">extract</span><span class="p">.</span><span class="n">cwasm</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">rg</span><span class="w"> </span><span class="o">'</span><span class="na">sub</span><span class="p">.</span><span class="o">*</span><span class="n">rsp</span><span class="o">'</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="n">a</span>:       <span class="mi">48</span><span class="w"> </span><span class="mi">81</span><span class="w"> </span><span class="n">ec</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="n">sub</span><span class="w">    </span><span class="cp">$</span><span class="mh">0x80</span><span class="p">,</span><span class="o">%</span><span class="n">rsp</span><span class="w"></span>
<span class="cp">$</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">after</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">extract</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">objdump</span><span class="w"> </span><span class="o">-</span><span class="n">S</span><span class="w"> </span><span class="n">extract</span><span class="p">.</span><span class="n">cwasm</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">rg</span><span class="w"> </span><span class="o">'</span><span class="na">sub</span><span class="p">.</span><span class="o">*</span><span class="n">rsp</span><span class="o">'</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="n">a</span>:       <span class="mi">48</span><span class="w"> </span><span class="mi">81</span><span class="w"> </span><span class="n">ec</span><span class="w"> </span><span class="mi">90</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="n">sub</span><span class="w">    </span><span class="cp">$</span><span class="mh">0x90</span><span class="p">,</span><span class="o">%</span><span class="n">rsp</span><span class="w"></span>
</code></pre></div>
<p>locally on an x86_64 target.</p>
<hr>
<p>@brettcannon to solve this issue for you in the meantime I believe there's a few options:</p>
<ul>
<li>Pin to 1.0.1 </li>
<li>Update the test to not recurse as much on wasi</li>
<li>Wait for <a href="https://github.com/bytecodealliance/wasmtime/pull/5156">https://github.com/bytecodealliance/wasmtime/pull/5156</a> to land in 3.0.0 and pass a <code>--max-wasm-stack</code> option during testing to increase the default stack size.</li>
</ul>
<p>We could alternatively consider increasing the default stack size in a platform-specific manner. I believe the current limit is relatively restrictive due to our testing on Windows where the main thread stack was smaller by default than other platforms. Ideally though we could keep consistent platform behavior. </p>
</blockquote>



<a name="306888684"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235152%20Call%20stack%20exhaustion%20found%20via%20CP.../near/306888684" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235152.20Call.20stack.20exhaustion.20found.20via.20CP.2E.2E.2E.html#306888684">(Oct 29 2022 at 21:17)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/5152#issuecomment-1295978386">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5152">issue #5152</a>:</p>
<blockquote>
<p>Thank you @alexcrichton for bisecting this!</p>
<p>I too am curious why exactly we use 16 extra bytes in the stackframe in this function. We can look into that a bit; however I think the high-order bit here, actually much more important, is to set expectations/norms around this sort of thing, so I'm going to go ahead and give some thoughts on that. (I don't mean to pick on this particular instance of the issue @brettcannon -- this is just a useful "norm-setting opportunity", so I'll make a general point.)</p>
<p>In general, I want to make sure we don't (accidentally or otherwise) fall into a "no regressions ever" expectation. The size of a stackframe (number of spillslots) is implementation-defined, and a Wasm compiler is free to be as efficient or as inefficient as it likes. A test (such as the one linked above) that depends on the stack size fitting <em>just under</em> some implementation-defined limit, given implementation-defined stackframe sizes, is a really brittle test: it could break with any minor version update. In other words, I want to be very clear here first that Wasmtime/Cranelift are perfectly standards-compliant here, and so in a strict sense, this is not a bug. I would consider a "blow up by factor of N" regression a performance bug, but this is not that: it's one extra spillslot.</p>
<p>Of course, all else being equal, regressions are bad. Over time the compiler should improve on average, and we would never want to take a change that adds an extra 16 bytes to a stackframe with no other benefit. But that qualification is key: most things have tradeoffs. (In the case here, 4-6% faster compile times, according to the commit message.) The impact of a strict no-regressions policy is that one ends up climbing the hill to a local maximum, and one can never really change the design otherwise: the core algorithms/approach are ossified forever (or a new algorithm/approach needs to go to absolutely heroic lengths to match or exceed the old approach in every single benchmark, and is always "on call" to be "fixed" when new cases are discovered).</p>
<p>Investigations of small N% regressions like this one can be <em>useful</em> because they can uncover real problems, or opportunities to fix a case. I'll also defer to @jameysharp whether he wants to dig into this one. I wouldn't be surprised however if it ends up being something like "values processed in slightly different order and spillslot-reuse heuristic now stops searching one step too soon" -- that sort of thing can easily happen in a complex compiler.</p>
<p>I'd second @alexcrichton 's suggestion to set either the recursion depth or stack limit to widen the gap between the two a bit -- in other words the most sustainable approach here is to not live right "on the edge" of the limit.</p>
<p>I don't want to discourage filing bugs for this sort of thing, as long as they have enough detail to be helpful; but I just want to make sure we're all on the same page re: acceptable outcomes. Happy to discuss this further if anyone would like!</p>
</blockquote>



<a name="307127127"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235152%20Call%20stack%20exhaustion%20found%20via%20CP.../near/307127127" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235152.20Call.20stack.20exhaustion.20found.20via.20CP.2E.2E.2E.html#307127127">(Oct 31 2022 at 14:51)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/5152#issuecomment-1297207364">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5152">issue #5152</a>:</p>
<blockquote>
<p>I agree with everything you say, and I, too, do not wish to have a policy of zero regressions accepted. Personally I feel that this sequence of events for this issue is ok to play out, though. As an end-user you probably aren't that aware of how close to the limits you're running which means that if a release, like this one, bumps you over the limit it looks like a legitimate regression rather than a small amount more stack space. In that sense I very much want to still encourage these bugs being opened so we can investigate and figure out a conclusion.</p>
<p>On this particular but I personally see no issue in providing the <code>--max-wasm-stack</code> knob and considering it closed.</p>
</blockquote>



<a name="307179212"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235152%20Call%20stack%20exhaustion%20found%20via%20CP.../near/307179212" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235152.20Call.20stack.20exhaustion.20found.20via.20CP.2E.2E.2E.html#307179212">(Oct 31 2022 at 18:59)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/issues/5152#issuecomment-1297533817">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5152">issue #5152</a>:</p>
<blockquote>
<p>I chatted about this offline with @cfallin and others.</p>
<p>I'm a little puzzled at how #4966 could have impacted stack frame size. In particular, Chris says regalloc2 does a value-merging pre-processing step that sounds to me like it should have made the input to register allocation be the same with or without the PR. Perhaps merging values earlier is enabling other Cranelift optimizations that lead to longer live-ranges?</p>
<p>It would certainly be nice to understand the root cause here. But I think @alexcrichton's <code>--max-wasm-stack</code> option is the best solution for making this particular CPython test reliable. And since it doesn't look like this is a sign of dramatically larger stack frames, I think it'll be okay if we don't get around to identifying the root cause.</p>
<p>So I'm closing this issue as I believe it's resolved by #5156. @brettcannon, if that solution isn't sufficient for you, feel free to re-open with more details about what you need. Thank you for your report!</p>
</blockquote>



<a name="307179214"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235152%20Call%20stack%20exhaustion%20found%20via%20CP.../near/307179214" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235152.20Call.20stack.20exhaustion.20found.20via.20CP.2E.2E.2E.html#307179214">(Oct 31 2022 at 18:59)</a>:</h4>
<p>jameysharp closed <a href="https://github.com/bytecodealliance/wasmtime/issues/5152">issue #5152</a>:</p>
<blockquote>
<p>Thanks for filing a bug report! Please fill out the TODOs below.</p>
<p><strong>Note: if you want to report a security issue, please read our <a href="https://bytecodealliance.org/security">security policy</a>!</strong></p>
<h3>Test Case</h3>
<p><code>test_marshal</code> from Python's test suite.</p>
<h3>Steps to Reproduce</h3>
<p>Easiest to just look at a GitHub Action run, e.g. <a href="https://github.com/tiran/cpython-wasm-test/actions/runs/3342891022/jobs/5535571299">https://github.com/tiran/cpython-wasm-test/actions/runs/3342891022/jobs/5535571299</a> .</p>
<h3>Expected Results</h3>
<p>The test to at least complete.</p>
<h3>Actual Results</h3>
<p>Call stack exhaustion which doesn't occur under wasmtime 1.0.1.</p>
<p><a href="https://github.com/tiran/cpython-wasm-test/actions/runs/3294946299/jobs/5432988265#step:7:408">https://github.com/tiran/cpython-wasm-test/actions/runs/3294946299/jobs/5432988265#step:7:408</a></p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: latest</p>
<p>Operating system: Linux</p>
<p>Architecture: x64</p>
<h3>Extra Info</h3>
<p>This started occurring on October 22: <a href="https://github.com/tiran/cpython-wasm-test/actions/workflows/wasi.yml">https://github.com/tiran/cpython-wasm-test/actions/workflows/wasi.yml</a> . As mentioned above, wasmtime 1.0.1 passes without issue and everything was fine until something changed between October 19th @ 22:04 and October 20th @ 22:13 for what <a href="https://wasmtime.dev/install.sh">https://wasmtime.dev/install.sh</a> installs.</p>
</blockquote>



<a name="307200456"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235152%20Call%20stack%20exhaustion%20found%20via%20CP.../near/307200456" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235152.20Call.20stack.20exhaustion.20found.20via.20CP.2E.2E.2E.html#307200456">(Oct 31 2022 at 20:56)</a>:</h4>
<p>brettcannon <a href="https://github.com/bytecodealliance/wasmtime/issues/5152#issuecomment-1297675748">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5152">issue #5152</a>:</p>
<blockquote>
<p>Thanks everyone for the details and looking into this! Sorry I couldn't react faster to the request for more info as I have been a bit busy with other things. <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>
<p>As for the result, I'm totally happy with the answers. The issue was opened more to make sure we had not found a bug as CPython is somewhat notorious in doing in edge cases of platforms. <span aria-label="grinning face with smiling eyes" class="emoji emoji-1f601" role="img" title="grinning face with smiling eyes">:grinning_face_with_smiling_eyes:</span> I will lower the stack depth cap in CPython under WASI to a lower number (which is the key purpose of the test; to know when we need a lower stack depth so that we can make sure you don't overflow and we can raise an exception instead).</p>
</blockquote>



<a name="307201071"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235152%20Call%20stack%20exhaustion%20found%20via%20CP.../near/307201071" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235152.20Call.20stack.20exhaustion.20found.20via.20CP.2E.2E.2E.html#307201071">(Oct 31 2022 at 21:00)</a>:</h4>
<p>brettcannon <a href="https://github.com/bytecodealliance/wasmtime/issues/5152#issuecomment-1297679698">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5152">issue #5152</a>:</p>
<blockquote>
<p>I have opened <a href="https://github.com/python/cpython/issues/98925">https://github.com/python/cpython/issues/98925</a> to track fixing this on the CPython side.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>