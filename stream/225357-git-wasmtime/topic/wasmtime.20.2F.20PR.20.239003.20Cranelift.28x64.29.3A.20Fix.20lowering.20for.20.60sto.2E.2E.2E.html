<html>
<head><meta charset="utf-8"><title>wasmtime / PR #9003 Cranelift(x64): Fix lowering for `sto... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239003.20Cranelift.28x64.29.3A.20Fix.20lowering.20for.20.60sto.2E.2E.2E.html">wasmtime / PR #9003 Cranelift(x64): Fix lowering for `sto...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="453762182"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239003%20Cranelift%28x64%29%3A%20Fix%20lowering%20for%20%60sto.../near/453762182" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239003.20Cranelift.28x64.29.3A.20Fix.20lowering.20for.20.60sto.2E.2E.2E.html#453762182">(Jul 24 2024 at 17:57)</a>:</h4>
<p>fitzgen opened <a href="https://github.com/bytecodealliance/wasmtime/pull/9003">PR #9003</a> from <code>fitzgen:fix-rmw-and-floats-on-x64</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>x86-64 allows us to do these kinds of read-modify-write operations in one instruction in general, however we also need to ensure that the non-memory operand is in a GPR. Because Cranelift allows <code>b{and,or,xor}</code>s on floating point types, that means we might need to insert a move from an XMM to a GPR.</p>
<p>Found in <a href="https://github.com/bytecodealliance/wasmtime/pull/8941">https://github.com/bytecodealliance/wasmtime/pull/8941</a> but is actually unrelated to safepoints and stack maps, they just made this pattern more likely to occur. AFAICT, Wasm can't ever trigger this bug, and would only be something of concern for other CLIF producers.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="453762183"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239003%20Cranelift%28x64%29%3A%20Fix%20lowering%20for%20%60sto.../near/453762183" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239003.20Cranelift.28x64.29.3A.20Fix.20lowering.20for.20.60sto.2E.2E.2E.html#453762183">(Jul 24 2024 at 17:57)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9003">PR #9003</a>.</p>



<a name="453762184"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239003%20Cranelift%28x64%29%3A%20Fix%20lowering%20for%20%60sto.../near/453762184" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239003.20Cranelift.28x64.29.3A.20Fix.20lowering.20for.20.60sto.2E.2E.2E.html#453762184">(Jul 24 2024 at 17:57)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9003">PR #9003</a>.</p>



<a name="453766704"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239003%20Cranelift%28x64%29%3A%20Fix%20lowering%20for%20%60sto.../near/453766704" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239003.20Cranelift.28x64.29.3A.20Fix.20lowering.20for.20.60sto.2E.2E.2E.html#453766704">(Jul 24 2024 at 18:17)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9003#pullrequestreview-2197461829">PR review</a>.</p>



<a name="453766705"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239003%20Cranelift%28x64%29%3A%20Fix%20lowering%20for%20%60sto.../near/453766705" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239003.20Cranelift.28x64.29.3A.20Fix.20lowering.20for.20.60sto.2E.2E.2E.html#453766705">(Jul 24 2024 at 18:17)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/9003#discussion_r1690244772">PR review comment</a>:</p>
<blockquote>
<p>Should this match against <code>(RegisterClass.Gpr _)</code> instead, to avoid potentially backtracking here instead of forcing the assertion failure in <code>put_in_reg</code> like before?</p>
</blockquote>



<a name="453813067"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239003%20Cranelift%28x64%29%3A%20Fix%20lowering%20for%20%60sto.../near/453813067" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239003.20Cranelift.28x64.29.3A.20Fix.20lowering.20for.20.60sto.2E.2E.2E.html#453813067">(Jul 24 2024 at 23:11)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9003">PR #9003</a>.</p>



<a name="453813070"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239003%20Cranelift%28x64%29%3A%20Fix%20lowering%20for%20%60sto.../near/453813070" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239003.20Cranelift.28x64.29.3A.20Fix.20lowering.20for.20.60sto.2E.2E.2E.html#453813070">(Jul 24 2024 at 23:11)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9003#pullrequestreview-2197943539">PR review</a>.</p>



<a name="453813071"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239003%20Cranelift%28x64%29%3A%20Fix%20lowering%20for%20%60sto.../near/453813071" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239003.20Cranelift.28x64.29.3A.20Fix.20lowering.20for.20.60sto.2E.2E.2E.html#453813071">(Jul 24 2024 at 23:11)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/9003#discussion_r1690564259">PR review comment</a>:</p>
<blockquote>
<p>Good idea.</p>
</blockquote>



<a name="453813126"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239003%20Cranelift%28x64%29%3A%20Fix%20lowering%20for%20%60sto.../near/453813126" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239003.20Cranelift.28x64.29.3A.20Fix.20lowering.20for.20.60sto.2E.2E.2E.html#453813126">(Jul 24 2024 at 23:12)</a>:</h4>
<p>fitzgen has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/9003">PR #9003</a>.</p>



<a name="453817512"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239003%20Cranelift%28x64%29%3A%20Fix%20lowering%20for%20%60sto.../near/453817512" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239003.20Cranelift.28x64.29.3A.20Fix.20lowering.20for.20.60sto.2E.2E.2E.html#453817512">(Jul 24 2024 at 23:57)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9003#pullrequestreview-2197990777">PR review</a>.</p>



<a name="453821889"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239003%20Cranelift%28x64%29%3A%20Fix%20lowering%20for%20%60sto.../near/453821889" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239003.20Cranelift.28x64.29.3A.20Fix.20lowering.20for.20.60sto.2E.2E.2E.html#453821889">(Jul 25 2024 at 00:28)</a>:</h4>
<p>fitzgen merged <a href="https://github.com/bytecodealliance/wasmtime/pull/9003">PR #9003</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>