<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #2452 Provide filename/line number infor... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232452.20Provide.20filename.2Fline.20number.20infor.2E.2E.2E.html">wasmtime / Issue #2452 Provide filename/line number infor...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="217942863"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232452%20Provide%20filename/line%20number%20infor.../near/217942863" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232452.20Provide.20filename.2Fline.20number.20infor.2E.2E.2E.html#217942863">(Nov 25 2020 at 21:41)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/2452#issuecomment-733958731">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2452">Issue #2452</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @peterhuene</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "wasmtime:api"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>peterhuene: wasmtime:api</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="217943099"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232452%20Provide%20filename/line%20number%20infor.../near/217943099" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232452.20Provide.20filename.2Fline.20number.20infor.2E.2E.2E.html#217943099">(Nov 25 2020 at 21:44)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/2452#issuecomment-733959628">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2452">Issue #2452</a>:</p>
<blockquote>
<blockquote>
<p>Can we test on some of whitequark's yowasp stuff?</p>
</blockquote>
<p>Some instructions here: <a href="https://github.com/YosysHQ/yosys/pull/1483">https://github.com/YosysHQ/yosys/pull/1483</a></p>
</blockquote>



<a name="217944984"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232452%20Provide%20filename/line%20number%20infor.../near/217944984" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232452.20Provide.20filename.2Fline.20number.20infor.2E.2E.2E.html#217944984">(Nov 25 2020 at 22:08)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/2452#issuecomment-733967502">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2452">Issue #2452</a>:</p>
<blockquote>
<p>Currently the memory overhead is the size of the dwarf debug information itself, we copy that from the original wasm blob into a side table which is then connected to <code>CompilationArtifacts</code>. That's then copied again to have an independent version living in <code>Store</code>, but this second copy could be removed with an <code>Arc</code> pretty easily (just needs some serde-fu). This is also all pretty easy to turn off, and I currently haven't added a knob to turn it off at all (and opted to not connect it to <code>debug_info</code> just yet because that's off-by-default).</p>
<p>It looks like I'd have to compile the yosys blob from source, I'll see if I can play around with a few things here and there.</p>
</blockquote>



<a name="218316906"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232452%20Provide%20filename/line%20number%20infor.../near/218316906" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232452.20Provide.20filename.2Fline.20number.20infor.2E.2E.2E.html#218316906">(Nov 30 2020 at 17:19)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/2452#issuecomment-735923679">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2452">Issue #2452</a>:</p>
<blockquote>
<p>Ok so fiddling with yosys module compilation, looks like yosys is about a 10MB wasm file but has 270MB (ish) of debuginfo. Loading the wasm file (with debuginfo) and retaining it as expected takes about 200MB more of resident memory.  Instantiation would then take another 200 more until the module itself is dropped, freeing one of the blocks.</p>
<p>In the spirit of having knobs as necessary I went ahead and added a <code>Config</code> option to disable retaining parsed debuginfo. I left it as default-<code>true</code>, however, since I suspect that this is useful enough we'll want it most of the time.</p>
</blockquote>



<a name="218317534"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232452%20Provide%20filename/line%20number%20infor.../near/218317534" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232452.20Provide.20filename.2Fline.20number.20infor.2E.2E.2E.html#218317534">(Nov 30 2020 at 17:24)</a>:</h4>
<p>tschneidereit <a href="https://github.com/bytecodealliance/wasmtime/pull/2452#issuecomment-735926555">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2452">Issue #2452</a>:</p>
<blockquote>
<p>I'm a bit concerned about adding that much potential memory overhead by default :/ I assume it's not possible to instead use pointers into the original wasm file that we then resolve only when needed?</p>
<p>Assuming so, could we instead disable this by default, but print out instructions for how to enable it, similar to the "note: run with <code>RUST_BACKTRACE=1</code> environment variable to display a backtrace" line rustc compiled code prints?</p>
</blockquote>



<a name="218321618"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232452%20Provide%20filename/line%20number%20infor.../near/218321618" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232452.20Provide.20filename.2Fline.20number.20infor.2E.2E.2E.html#218321618">(Nov 30 2020 at 17:56)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/2452#issuecomment-735944088">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2452">Issue #2452</a>:</p>
<blockquote>
<p>I don't think it's easy to optimize this too much more (apart from the one copy from the module to the store which we could elide with more effort), because unlike with native debuginfo situations we aren't guaranteed to have a disk to store all the pesky debuginfo to read later.</p>
<p>I think that it should be possible to print out a message, but I'm not sure what it would say. Enabling debuginfo parsing is likely embedding-dependent and would have a different flag on the command line, for example, than it would if it were embedded into a different application. I also think there's some good value from newcomers coming to wasmtime and automatically seeing filenames/line numbers in backtraces without having to do anything. There's always a knob to turn it off it it becomes a pressing isssue, but having a good new-user experience I think is pretty valuable.</p>
</blockquote>



<a name="218323709"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232452%20Provide%20filename/line%20number%20infor.../near/218323709" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232452.20Provide.20filename.2Fline.20number.20infor.2E.2E.2E.html#218323709">(Nov 30 2020 at 18:13)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/2452#issuecomment-735953301">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2452">Issue #2452</a>:</p>
<blockquote>
<p>We can make <code>Module::from_file</code> remember the file path and lazily re-read the debug info (we could even remember the debug info section offsets in the file to avoid parsing the Wasm again in addition to parsing DWARF).</p>
<p>In general, using <code>from_file</code> is nice since we can mmap other things directly from the wasm file at a later date without keeping it eagerly in memory (thinking about the data segment lazy + CoW stuff, which would require creating temporary in-memory file descriptors via <code>memfd</code> if we didn't use <code>Module::from_file</code>).</p>
</blockquote>



<a name="218332313"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232452%20Provide%20filename/line%20number%20infor.../near/218332313" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232452.20Provide.20filename.2Fline.20number.20infor.2E.2E.2E.html#218332313">(Nov 30 2020 at 19:18)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/2452#issuecomment-735987838">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2452">Issue #2452</a>:</p>
<blockquote>
<p>I'm hesitant to get too fancy with the optimizations just yet without a motivating use case, but if you'd prefer I can just turn this off-by-default and do something like hook it up to the CLI flag and call it a day.</p>
</blockquote>



<a name="218451107"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232452%20Provide%20filename/line%20number%20infor.../near/218451107" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232452.20Provide.20filename.2Fline.20number.20infor.2E.2E.2E.html#218451107">(Dec 01 2020 at 17:01)</a>:</h4>
<p>tschneidereit <a href="https://github.com/bytecodealliance/wasmtime/pull/2452#issuecomment-736684777">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2452">Issue #2452</a>:</p>
<blockquote>
<blockquote>
<p>I think that it should be possible to print out a message, but I'm not sure what it would say.</p>
</blockquote>
<p>I guess I'm thinking about something along the lines of</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="mi">0</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="n">default</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">wasm</span><span class="w"> </span><span class="n">trap</span>: <span class="nc">unreachable</span><span class="w"></span>
<span class="w">       </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span><span class="w"> </span><span class="p">(</span><span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">WASM_BACKTRACE_DETAILS</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">richer</span><span class="w"> </span><span class="n">backtrace</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">frames</span><span class="p">)</span><span class="w"></span>
<span class="w">           </span><span class="mi">0</span>: <span class="mh">0x6c1c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">panic_abort</span>::<span class="n">__rust_start_panic</span>::<span class="n">abort</span>::<span class="n">h2d60298621b1ccbf</span><span class="w"></span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>
</code></pre></div>
</blockquote>



<a name="218460486"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232452%20Provide%20filename/line%20number%20infor.../near/218460486" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232452.20Provide.20filename.2Fline.20number.20infor.2E.2E.2E.html#218460486">(Dec 01 2020 at 18:14)</a>:</h4>
<p>tschneidereit <a href="https://github.com/bytecodealliance/wasmtime/pull/2452#issuecomment-736729126">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2452">Issue #2452</a>:</p>
<blockquote>
<blockquote>
<p>There's always a knob to turn it off it it becomes a pressing isssue, but having a good new-user experience I think is pretty valuable.</p>
</blockquote>
<p>I should emphasize that I very much agree with this, yes! Unfortunately this seems like a situation where we have to trade off two dimensions of exactly this. Having the default be to increase memory usage, potentially quite drastically, seems really risky to me, in a similar way to disabling perf optimizations by default. That's why I feel like giving pointers on how to improve the debugging situation would be preferable to eating the overhead by default.</p>
</blockquote>



<a name="218465497"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232452%20Provide%20filename/line%20number%20infor.../near/218465497" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232452.20Provide.20filename.2Fline.20number.20infor.2E.2E.2E.html#218465497">(Dec 01 2020 at 18:55)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/2452#issuecomment-736750388">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2452">Issue #2452</a>:</p>
<blockquote>
<p>Ok, I think using an env var seems pretty reasonable for this too. I've added a commit which makes a few changes. <code>Config</code> how has a tri-state  configuration for parsing debuginfo for wasm backtraces -- enabled, disabled, read an env var. The default is read an env var (the env var being <code>WASM_BACKTRACE_DETAILS</code> and enabling being seeing that to <code>1</code>). This means that backtrace information is disabled by default but can be enabled with an env var. Embedders can also unconditionally enable it or unconditionally disable it.</p>
<p>The <code>Display for Trap</code> will also print a hint to set the env var, but only when we're in environment variable mode <em>and</em> the original module actually had debug information. Otherwise no hint is printed because it won't do anything.</p>
</blockquote>



<a name="218467960"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232452%20Provide%20filename/line%20number%20infor.../near/218467960" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232452.20Provide.20filename.2Fline.20number.20infor.2E.2E.2E.html#218467960">(Dec 01 2020 at 19:14)</a>:</h4>
<p>tschneidereit <a href="https://github.com/bytecodealliance/wasmtime/pull/2452#issuecomment-736761180">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2452">Issue #2452</a>:</p>
<blockquote>
<p>That looks great, thank you! (Not adding a review, because I'm clearly not the right person to review the meat of this PR <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span>)</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>