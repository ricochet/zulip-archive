<html>
<head><meta charset="utf-8"><title>wasmtime / issue #1041 Inline Assembly. · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.231041.20Inline.20Assembly.2E.html">wasmtime / issue #1041 Inline Assembly.</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="323815743"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%231041%20Inline%20Assembly./near/323815743" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.231041.20Inline.20Assembly.2E.html#323815743">(Jan 26 2023 at 19:03)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/1041#issuecomment-1405468489">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1041">issue #1041</a>:</p>
<blockquote>
<p>Rustc_codegen_cranelift has solved this by wrapping inline assembly with a prologue and epilogue and the passing it to an external assembler. It can then be called as regular function from the Cranelift side.</p>
</blockquote>



<a name="396660928"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%231041%20Inline%20Assembly./near/396660928" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.231041.20Inline.20Assembly.2E.html#396660928">(Oct 14 2023 at 15:52)</a>:</h4>
<p>stevefan1999-personal <a href="https://github.com/bytecodealliance/wasmtime/issues/1041#issuecomment-1762994203">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1041">issue #1041</a>:</p>
<blockquote>
<p>I'm also very much in need for this. I'm using Cranelift as a backend for my C compiler project. The lack of an assembler is quite unfortunate, which means I have to consider hacking a bit to either bypass Cranelift on assembly/raw/naked functions, or I have to write my own codegen using dynasm.</p>
</blockquote>



<a name="396662097"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%231041%20Inline%20Assembly./near/396662097" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.231041.20Inline.20Assembly.2E.html#396662097">(Oct 14 2023 at 16:06)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/1041#issuecomment-1763011651">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1041">issue #1041</a>:</p>
<blockquote>
<p>@stevefan1999-personal you or anyone else interested is welcome to contribute! As outlined by sunfishcode above, this is a big design question, so any effort should probably start with an RFC; and then the implementation effort would probably be 3-6 months of fulltime work, I would estimate. Currently none of the core developers have the time/resources to build this, so it would likely have to come from a motivated contributor.</p>
</blockquote>



<a name="396662303"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%231041%20Inline%20Assembly./near/396662303" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.231041.20Inline.20Assembly.2E.html#396662303">(Oct 14 2023 at 16:09)</a>:</h4>
<p>stevefan1999-personal <a href="https://github.com/bytecodealliance/wasmtime/issues/1041#issuecomment-1763020730">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1041">issue #1041</a>:</p>
<blockquote>
<p>@cfallin Looks like we should better off moving this into a GH discussion...rather than an issue</p>
</blockquote>



<a name="396662648"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%231041%20Inline%20Assembly./near/396662648" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.231041.20Inline.20Assembly.2E.html#396662648">(Oct 14 2023 at 16:15)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/1041#issuecomment-1763030459">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1041">issue #1041</a>:</p>
<blockquote>
<p>@stevefan1999-personal we don't use the GitHub Discussions feature here; this issue is perfectly fine for now, I think!</p>
</blockquote>



<a name="396669791"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%231041%20Inline%20Assembly./near/396669791" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.231041.20Inline.20Assembly.2E.html#396669791">(Oct 14 2023 at 18:27)</a>:</h4>
<p>stevefan1999-personal <a href="https://github.com/bytecodealliance/wasmtime/issues/1041#issuecomment-1763113285">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1041">issue #1041</a>:</p>
<blockquote>
<blockquote>
<p>@stevefan1999-personal we don't use the GitHub Discussions feature here; this issue is perfectly fine for now, I think!</p>
</blockquote>
<p>Sure. I just read how Cland and LLVM handles inline assembly and I find it maybe useful towards the end goal:</p>
<p><a href="https://youtu.be/MeB7Dp3G2UE?si=2boJuSqM-JLH2f7o&amp;t=510">https://youtu.be/MeB7Dp3G2UE?si=2boJuSqM-JLH2f7o&amp;t=510</a></p>
<p>Basically, LLVM is also treating the inline assembly as string, replace the parameters, captures used registers and feed it to the register allocator, and then insert the output assembly at the specific point. I'm not sure if I missed something.</p>
</blockquote>



<a name="396670335"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%231041%20Inline%20Assembly./near/396670335" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.231041.20Inline.20Assembly.2E.html#396670335">(Oct 14 2023 at 18:36)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/1041#issuecomment-1763120816">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1041">issue #1041</a>:</p>
<blockquote>
<blockquote>
<p>Basically, LLVM is also treating the inline assembly as string, replace the parameters, captures used registers and feed it to the register allocator, and then insert the output assembly at the specific point. I'm not sure if I missed something.</p>
</blockquote>
<p>Indeed, it sounds kind of simple when described at a high level like that. I'd recommend reading sunfishcode's comment above (and really, this whole thread): there are a huge number of complexities here that need to be fully appreciated and handled in any robust solution.</p>
<p>As one example, we currently generate machine code directly, rather than using any existing assembler at the backend. And our machine-code representation is close but not exactly 1-to-1 with instructions, and we don't have representations for instructions we don't use. So at the very least, such a project would require (i) writing a new textual assembler that uses our emission backend, or adopting an existing assembler library in Rust to work with our backend and provide the same interface and metadata to the register allocator, and (ii) extending our instruction representation to support all known CPU instructions. That's an enormous effort.</p>
<p>To state it more explicitly: the input that is most needed here is not ideas or brainstorming or problem-solving, nor confirmation that this is a useful feature; we have plenty of ideas, and we know this is a useful feature that some people want. The input that is needed is <em>human time</em> to actually develop the feature; something like 3-6 months of fulltime engineering. Cranelift is developed by folks who use it for various applications, and we're all quite busy, and don't have the free time for that. Anyone who does, and is sufficiently motivated to need this feature, is welcome to help out!</p>
</blockquote>



<a name="396670576"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%231041%20Inline%20Assembly./near/396670576" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.231041.20Inline.20Assembly.2E.html#396670576">(Oct 14 2023 at 18:41)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/1041#issuecomment-1763121713">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1041">issue #1041</a>:</p>
<blockquote>
<p>In rustc_codegen_cranelift I have a bunch of code which wraps inline asm in a function which uses the SystemV calling convention and then pass this whole asm block to an external assembler. This may or may not work for your use case: <a href="https://github.com/bjorn3/rustc_codegen_cranelift/blob/master/src/inline_asm.rs">https://github.com/bjorn3/rustc_codegen_cranelift/blob/master/src/inline_asm.rs</a></p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>