<html>
<head><meta charset="utf-8"><title>wasmtime / issue #9210 Tracing spans in code generated by... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239210.20Tracing.20spans.20in.20code.20generated.20by.2E.2E.2E.html">wasmtime / issue #9210 Tracing spans in code generated by...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="468300646"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239210%20Tracing%20spans%20in%20code%20generated%20by.../near/468300646" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239210.20Tracing.20spans.20in.20code.20generated.20by.2E.2E.2E.html#468300646">(Sep 06 2024 at 22:19)</a>:</h4>
<p>swlynch99 opened <a href="https://github.com/bytecodealliance/wasmtime/issues/9210">issue #9210</a>:</p>
<blockquote>
<p><strong>TLDR:</strong> The generated code creates a span and enters it by calling <code>span.enter()</code>. This works fine for sync functions but for async functions it results in the span still being entered even if the inner function has yielded. The end result is that the trace span will be shown on other unrelated tokio tasks that happen to run on the same thread at the same time.</p>
<p>Now, in more detail. If we have a <code>component::bindgen!</code> call like this</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">bindgen</span><span class="o">!</span><span class="p">({</span>
<span class="w">    </span><span class="n">world</span><span class="p">:</span><span class="w"> </span><span class="s">"imports"</span><span class="p">,</span>
<span class="w">    </span><span class="n">inline</span><span class="p">:</span><span class="w"> </span><span class="s">"</span>
<span class="s">package test:example@1.0.0;</span>

<span class="s">interface test {</span>
<span class="s">  my-func: func();</span>
<span class="s">}</span>

<span class="s">world imports {</span>
<span class="s">  import test;</span>
<span class="s">}</span>
<span class="s">"</span><span class="p">,</span>

<span class="w">    </span><span class="n">tracing</span><span class="p">:</span><span class="w"> </span><span class="nc">true</span><span class="p">,</span>
<span class="w">    </span><span class="k">async</span><span class="p">:</span><span class="w"> </span><span class="nc">true</span><span class="p">,</span>
<span class="w">    </span><span class="n">include_generated_code_from_file</span><span class="p">:</span><span class="w"> </span><span class="nc">true</span>
<span class="p">});</span>
</code></pre></div>
<p>Then the generated code in <code>add_to_linker_get_host</code> will look something like this</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">inst</span><span class="p">.</span><span class="n">func_wrap_async</span><span class="p">(</span>
<span class="w">    </span><span class="s">"my-func"</span><span class="p">,</span>
<span class="w">    </span><span class="k">move</span><span class="w"> </span><span class="o">|</span><span class="k">mut</span><span class="w"> </span><span class="n">caller</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">StoreContextMut</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="p">():</span><span class="w"> </span><span class="p">()</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">__internal</span><span class="p">::</span><span class="nb">Box</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">span</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tracing</span><span class="p">::</span><span class="n">span</span><span class="o">!</span><span class="p">(</span>
<span class="w">                </span><span class="n">tracing</span><span class="p">::</span><span class="n">Level</span><span class="p">::</span><span class="n">TRACE</span><span class="p">,</span>
<span class="w">                </span><span class="s">"wit-bindgen import"</span><span class="p">,</span>
<span class="w">                </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"test"</span><span class="p">,</span>
<span class="w">                </span><span class="n">function</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"my-func"</span><span class="p">,</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">_enter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">span</span><span class="p">.</span><span class="n">enter</span><span class="p">();</span>
<span class="w">            </span><span class="n">tracing</span><span class="p">::</span><span class="n">event</span><span class="o">!</span><span class="p">(</span><span class="n">tracing</span><span class="p">::</span><span class="n">Level</span><span class="p">::</span><span class="n">TRACE</span><span class="p">,</span><span class="w"> </span><span class="s">"call"</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">host_getter</span><span class="p">(</span><span class="n">caller</span><span class="p">.</span><span class="n">data_mut</span><span class="p">());</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Host</span><span class="p">::</span><span class="n">my_func</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="k">await</span><span class="p">;</span>
<span class="w">            </span><span class="n">tracing</span><span class="p">::</span><span class="n">event</span><span class="o">!</span><span class="p">(</span>
<span class="w">                </span><span class="n">tracing</span><span class="p">::</span><span class="n">Level</span><span class="p">::</span><span class="n">TRACE</span><span class="p">,</span>
<span class="w">                </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tracing</span><span class="p">::</span><span class="n">field</span><span class="p">::</span><span class="n">debug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="p">),</span>
<span class="w">                </span><span class="s">"return"</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">)</span><span class="o">?</span><span class="p">;</span>
</code></pre></div>
<p>Note that it holds the <code>_enter</code> guard across an await point. This is wrong, since the span remains entered even when the resulting future is suspended.</p>
<p>The correct thing to do here is to use tracing's <a href="https://docs.rs/tracing/latest/tracing/trait.Instrument.html"><code>Instrument</code></a> trait, which takes care of entering/exiting the span when the future is polled.<br>
</p>
</blockquote>



<a name="468300839"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239210%20Tracing%20spans%20in%20code%20generated%20by.../near/468300839" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239210.20Tracing.20spans.20in.20code.20generated.20by.2E.2E.2E.html#468300839">(Sep 06 2024 at 22:20)</a>:</h4>
<p>swlynch99 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/9210">issue #9210</a>:</p>
<blockquote>
<p><strong>TLDR:</strong> The generated code creates a span and enters it by calling <code>span.enter()</code>. This works fine for sync functions but for async functions it results in the span still being entered even if the inner function has yielded. The end result is that the trace span will be shown on other unrelated tokio tasks that happen to run on the same thread at the same time.</p>
<p>Now, in more detail. If we have a <code>component::bindgen!</code> call like this</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">bindgen</span><span class="o">!</span><span class="p">({</span>
<span class="w">    </span><span class="n">world</span><span class="p">:</span><span class="w"> </span><span class="s">"imports"</span><span class="p">,</span>
<span class="w">    </span><span class="n">inline</span><span class="p">:</span><span class="w"> </span><span class="s">"</span>
<span class="s">package test:example@1.0.0;</span>

<span class="s">interface test {</span>
<span class="s">  my-func: func();</span>
<span class="s">}</span>

<span class="s">world imports {</span>
<span class="s">  import test;</span>
<span class="s">}</span>
<span class="s">"</span><span class="p">,</span>

<span class="w">    </span><span class="n">tracing</span><span class="p">:</span><span class="w"> </span><span class="nc">true</span><span class="p">,</span>
<span class="w">    </span><span class="k">async</span><span class="p">:</span><span class="w"> </span><span class="nc">true</span><span class="p">,</span>
<span class="w">    </span><span class="n">include_generated_code_from_file</span><span class="p">:</span><span class="w"> </span><span class="nc">true</span>
<span class="p">});</span>
</code></pre></div>
<p>Then the generated code in <code>add_to_linker_get_host</code> will look something like this</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">inst</span><span class="p">.</span><span class="n">func_wrap_async</span><span class="p">(</span>
<span class="w">    </span><span class="s">"my-func"</span><span class="p">,</span>
<span class="w">    </span><span class="k">move</span><span class="w"> </span><span class="o">|</span><span class="k">mut</span><span class="w"> </span><span class="n">caller</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">StoreContextMut</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="p">():</span><span class="w"> </span><span class="p">()</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">__internal</span><span class="p">::</span><span class="nb">Box</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">span</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tracing</span><span class="p">::</span><span class="n">span</span><span class="o">!</span><span class="p">(</span>
<span class="w">                </span><span class="n">tracing</span><span class="p">::</span><span class="n">Level</span><span class="p">::</span><span class="n">TRACE</span><span class="p">,</span>
<span class="w">                </span><span class="s">"wit-bindgen import"</span><span class="p">,</span>
<span class="w">                </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"test"</span><span class="p">,</span>
<span class="w">                </span><span class="n">function</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"my-func"</span><span class="p">,</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">_enter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">span</span><span class="p">.</span><span class="n">enter</span><span class="p">();</span>
<span class="w">            </span><span class="n">tracing</span><span class="p">::</span><span class="n">event</span><span class="o">!</span><span class="p">(</span><span class="n">tracing</span><span class="p">::</span><span class="n">Level</span><span class="p">::</span><span class="n">TRACE</span><span class="p">,</span><span class="w"> </span><span class="s">"call"</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">host_getter</span><span class="p">(</span><span class="n">caller</span><span class="p">.</span><span class="n">data_mut</span><span class="p">());</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Host</span><span class="p">::</span><span class="n">my_func</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="k">await</span><span class="p">;</span>
<span class="w">            </span><span class="n">tracing</span><span class="p">::</span><span class="n">event</span><span class="o">!</span><span class="p">(</span>
<span class="w">                </span><span class="n">tracing</span><span class="p">::</span><span class="n">Level</span><span class="p">::</span><span class="n">TRACE</span><span class="p">,</span>
<span class="w">                </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tracing</span><span class="p">::</span><span class="n">field</span><span class="p">::</span><span class="n">debug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="p">),</span>
<span class="w">                </span><span class="s">"return"</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">)</span><span class="o">?</span><span class="p">;</span>
</code></pre></div>
<p>Note that it holds the <code>_enter</code> guard across an await point. This is wrong, since the span remains entered even when the resulting future is suspended.</p>
<p>The correct thing to do here is to use tracing's <a href="https://docs.rs/tracing/latest/tracing/trait.Instrument.html"><code>Instrument</code></a> trait which takes care of entering/exiting the span when the future is polled.<br>
</p>
</blockquote>



<a name="468859299"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239210%20Tracing%20spans%20in%20code%20generated%20by.../near/468859299" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239210.20Tracing.20spans.20in.20code.20generated.20by.2E.2E.2E.html#468859299">(Sep 09 2024 at 16:49)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/issues/9210#issuecomment-2338602480">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9210">issue #9210</a>:</p>
<blockquote>
<p>Thanks for the report. This is my bad, I didn't understand that aspect of how tracing spans interact with async. Would you like to submit a fix?</p>
</blockquote>



<a name="468915275"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239210%20Tracing%20spans%20in%20code%20generated%20by.../near/468915275" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239210.20Tracing.20spans.20in.20code.20generated.20by.2E.2E.2E.html#468915275">(Sep 09 2024 at 21:00)</a>:</h4>
<p>swlynch99 <a href="https://github.com/bytecodealliance/wasmtime/issues/9210#issuecomment-2339081109">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9210">issue #9210</a>:</p>
<blockquote>
<p>I've submitted a fix over in #9217</p>
</blockquote>



<a name="468945793"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239210%20Tracing%20spans%20in%20code%20generated%20by.../near/468945793" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239210.20Tracing.20spans.20in.20code.20generated.20by.2E.2E.2E.html#468945793">(Sep 10 2024 at 00:38)</a>:</h4>
<p>pchickey closed <a href="https://github.com/bytecodealliance/wasmtime/issues/9210">issue #9210</a>:</p>
<blockquote>
<p><strong>TLDR:</strong> The generated code creates a span and enters it by calling <code>span.enter()</code>. This works fine for sync functions but for async functions it results in the span still being entered even if the inner function has yielded. The end result is that the trace span will be shown on other unrelated tokio tasks that happen to run on the same thread at the same time.</p>
<p>Now, in more detail. If we have a <code>component::bindgen!</code> call like this</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">bindgen</span><span class="o">!</span><span class="p">({</span>
<span class="w">    </span><span class="n">world</span><span class="p">:</span><span class="w"> </span><span class="s">"imports"</span><span class="p">,</span>
<span class="w">    </span><span class="n">inline</span><span class="p">:</span><span class="w"> </span><span class="s">"</span>
<span class="s">package test:example@1.0.0;</span>

<span class="s">interface test {</span>
<span class="s">  my-func: func();</span>
<span class="s">}</span>

<span class="s">world imports {</span>
<span class="s">  import test;</span>
<span class="s">}</span>
<span class="s">"</span><span class="p">,</span>

<span class="w">    </span><span class="n">tracing</span><span class="p">:</span><span class="w"> </span><span class="nc">true</span><span class="p">,</span>
<span class="w">    </span><span class="k">async</span><span class="p">:</span><span class="w"> </span><span class="nc">true</span><span class="p">,</span>
<span class="w">    </span><span class="n">include_generated_code_from_file</span><span class="p">:</span><span class="w"> </span><span class="nc">true</span>
<span class="p">});</span>
</code></pre></div>
<p>Then the generated code in <code>add_to_linker_get_host</code> will look something like this</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">inst</span><span class="p">.</span><span class="n">func_wrap_async</span><span class="p">(</span>
<span class="w">    </span><span class="s">"my-func"</span><span class="p">,</span>
<span class="w">    </span><span class="k">move</span><span class="w"> </span><span class="o">|</span><span class="k">mut</span><span class="w"> </span><span class="n">caller</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">StoreContextMut</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="p">():</span><span class="w"> </span><span class="p">()</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">__internal</span><span class="p">::</span><span class="nb">Box</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">span</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tracing</span><span class="p">::</span><span class="n">span</span><span class="o">!</span><span class="p">(</span>
<span class="w">                </span><span class="n">tracing</span><span class="p">::</span><span class="n">Level</span><span class="p">::</span><span class="n">TRACE</span><span class="p">,</span>
<span class="w">                </span><span class="s">"wit-bindgen import"</span><span class="p">,</span>
<span class="w">                </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"test"</span><span class="p">,</span>
<span class="w">                </span><span class="n">function</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"my-func"</span><span class="p">,</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">_enter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">span</span><span class="p">.</span><span class="n">enter</span><span class="p">();</span>
<span class="w">            </span><span class="n">tracing</span><span class="p">::</span><span class="n">event</span><span class="o">!</span><span class="p">(</span><span class="n">tracing</span><span class="p">::</span><span class="n">Level</span><span class="p">::</span><span class="n">TRACE</span><span class="p">,</span><span class="w"> </span><span class="s">"call"</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">host_getter</span><span class="p">(</span><span class="n">caller</span><span class="p">.</span><span class="n">data_mut</span><span class="p">());</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Host</span><span class="p">::</span><span class="n">my_func</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="k">await</span><span class="p">;</span>
<span class="w">            </span><span class="n">tracing</span><span class="p">::</span><span class="n">event</span><span class="o">!</span><span class="p">(</span>
<span class="w">                </span><span class="n">tracing</span><span class="p">::</span><span class="n">Level</span><span class="p">::</span><span class="n">TRACE</span><span class="p">,</span>
<span class="w">                </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tracing</span><span class="p">::</span><span class="n">field</span><span class="p">::</span><span class="n">debug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="p">),</span>
<span class="w">                </span><span class="s">"return"</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">)</span><span class="o">?</span><span class="p">;</span>
</code></pre></div>
<p>Note that it holds the <code>_enter</code> guard across an await point. This is wrong, since the span remains entered even when the resulting future is suspended.</p>
<p>The correct thing to do here is to use tracing's <a href="https://docs.rs/tracing/latest/tracing/trait.Instrument.html"><code>Instrument</code></a> trait which takes care of entering/exiting the span when the future is polled.<br>
</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>