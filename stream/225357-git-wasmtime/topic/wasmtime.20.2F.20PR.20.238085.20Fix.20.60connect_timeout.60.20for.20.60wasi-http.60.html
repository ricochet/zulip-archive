<html>
<head><meta charset="utf-8"><title>wasmtime / PR #8085 Fix `connect_timeout` for `wasi-http` · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238085.20Fix.20.60connect_timeout.60.20for.20.60wasi-http.60.html">wasmtime / PR #8085 Fix `connect_timeout` for `wasi-http`</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="426071600"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238085%20Fix%20%60connect_timeout%60%20for%20%60wasi-http%60/near/426071600" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238085.20Fix.20.60connect_timeout.60.20for.20.60wasi-http.60.html#426071600">(Mar 12 2024 at 08:01)</a>:</h4>
<p>rikhuijzer opened <a href="https://github.com/bytecodealliance/wasmtime/pull/8085">PR #8085</a> from <code>rikhuijzer:rh/wasi-http-timeout</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>@elliottt in <a href="https://github.com/bytecodealliance/wasmtime/issues/7356">https://github.com/bytecodealliance/wasmtime/issues/7356</a> mentions that <code>connect_timeout</code>, <code>first_byte_timeout</code>, and <code>between_bytes_timeout</code> should be tested.</p>
<p>This PR adds a test for <code>connect_timeout</code> and ensures that <code>TcpStream::connect</code> adheres to the timeout. Without this fix, setting <code>connect_timeout</code> has no effect on hosts where <code>TcpStream::connect</code> tries to connect.</p>
<p>Note that the variable <code>connect_timeout</code> is also used a bit later for the handshake:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/8dd2ae9e2c57b3fd32f91fb8f0ec1543854f4c7c/crates/wasi-http/src/types.rs#L207-L213">https://github.com/bytecodealliance/wasmtime/blob/8dd2ae9e2c57b3fd32f91fb8f0ec1543854f4c7c/crates/wasi-http/src/types.rs#L207-L213</a></p>
<p>I'm not sure whether using this variable twice is correct.<br>
</p>
</blockquote>



<a name="426071601"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238085%20Fix%20%60connect_timeout%60%20for%20%60wasi-http%60/near/426071601" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238085.20Fix.20.60connect_timeout.60.20for.20.60wasi-http.60.html#426071601">(Mar 12 2024 at 08:01)</a>:</h4>
<p><strong>rikhuijzer</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8085">PR #8085</a>.</p>



<a name="426071602"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238085%20Fix%20%60connect_timeout%60%20for%20%60wasi-http%60/near/426071602" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238085.20Fix.20.60connect_timeout.60.20for.20.60wasi-http.60.html#426071602">(Mar 12 2024 at 08:01)</a>:</h4>
<p><strong>rikhuijzer</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8085">PR #8085</a>.</p>



<a name="426071793"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238085%20Fix%20%60connect_timeout%60%20for%20%60wasi-http%60/near/426071793" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238085.20Fix.20.60connect_timeout.60.20for.20.60wasi-http.60.html#426071793">(Mar 12 2024 at 08:02)</a>:</h4>
<p>rikhuijzer updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8085">PR #8085</a>.</p>



<a name="426074981"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238085%20Fix%20%60connect_timeout%60%20for%20%60wasi-http%60/near/426074981" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238085.20Fix.20.60connect_timeout.60.20for.20.60wasi-http.60.html#426074981">(Mar 12 2024 at 08:28)</a>:</h4>
<p>rikhuijzer updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8085">PR #8085</a>.</p>



<a name="426131411"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238085%20Fix%20%60connect_timeout%60%20for%20%60wasi-http%60/near/426131411" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238085.20Fix.20.60connect_timeout.60.20for.20.60wasi-http.60.html#426131411">(Mar 12 2024 at 14:00)</a>:</h4>
<p>rikhuijzer updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8085">PR #8085</a>.</p>



<a name="426175667"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238085%20Fix%20%60connect_timeout%60%20for%20%60wasi-http%60/near/426175667" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238085.20Fix.20.60connect_timeout.60.20for.20.60wasi-http.60.html#426175667">(Mar 12 2024 at 17:13)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8085#pullrequestreview-1931723767">PR review</a>:</p>
<blockquote>
<p>This looks great, thank you!</p>
</blockquote>



<a name="426175668"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238085%20Fix%20%60connect_timeout%60%20for%20%60wasi-http%60/near/426175668" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238085.20Fix.20.60connect_timeout.60.20for.20.60wasi-http.60.html#426175668">(Mar 12 2024 at 17:13)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8085#pullrequestreview-1931723767">PR review</a>:</p>
<blockquote>
<p>This looks great, thank you!</p>
</blockquote>



<a name="426175669"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238085%20Fix%20%60connect_timeout%60%20for%20%60wasi-http%60/near/426175669" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238085.20Fix.20.60connect_timeout.60.20for.20.60wasi-http.60.html#426175669">(Mar 12 2024 at 17:13)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/8085#discussion_r1521843625">PR review comment</a>:</p>
<blockquote>
<p>Thanks for matching the timeout explicitly here!</p>
</blockquote>



<a name="426176305"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238085%20Fix%20%60connect_timeout%60%20for%20%60wasi-http%60/near/426176305" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238085.20Fix.20.60connect_timeout.60.20for.20.60wasi-http.60.html#426176305">(Mar 12 2024 at 17:16)</a>:</h4>
<p>elliottt <a href="https://github.com/bytecodealliance/wasmtime/pull/8085#issuecomment-1992166789">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8085">PR #8085</a>:</p>
<blockquote>
<blockquote>
<p>I'm not sure whether using this variable twice is correct.</p>
</blockquote>
<p>I see two uses in the <code>handler</code> function, but they're under different branches of the same conditional. Was there another use of <code>connect_timeout</code> that you were thinking of?</p>
</blockquote>



<a name="426180033"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238085%20Fix%20%60connect_timeout%60%20for%20%60wasi-http%60/near/426180033" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238085.20Fix.20.60connect_timeout.60.20for.20.60wasi-http.60.html#426180033">(Mar 12 2024 at 17:37)</a>:</h4>
<p>rikhuijzer <a href="https://github.com/bytecodealliance/wasmtime/pull/8085#issuecomment-1992204630">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8085">PR #8085</a>:</p>
<blockquote>
<blockquote>
<p>This looks great, thank you!</p>
</blockquote>
<p>Thanks for the review!</p>
<blockquote>
<blockquote>
<p>I'm not sure whether using this variable twice is correct.</p>
</blockquote>
<p>I see two uses in the <code>handler</code> function, but they're under different branches of the same conditional. Was there another use of <code>connect_timeout</code> that you were thinking of?</p>
</blockquote>
<p>There should be three (<a href="https://github.com/bytecodealliance/wasmtime/blob/eebce11eb1fdfc67ab8fc7a06cb68ba1231dd7a6/crates/wasi-http/src/types.rs">https://github.com/bytecodealliance/wasmtime/blob/eebce11eb1fdfc67ab8fc7a06cb68ba1231dd7a6/crates/wasi-http/src/types.rs</a>).</p>
<p>One is now newly added near the <code>TcpStream::connect</code> and the other two are inside the branches near <code>hyper::client::conn::http1::handshake</code>. I think these two different phases represent TCP's SYN and ACK.</p>
<p>Why I mentioned it is because it sounded a bit weird to me that the <code>connect_timeout</code> is used twice, but on second thought maybe it's fine. The SYN and ACK are both still during the "Connection establishment" phase.</p>
</blockquote>



<a name="426181676"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238085%20Fix%20%60connect_timeout%60%20for%20%60wasi-http%60/near/426181676" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238085.20Fix.20.60connect_timeout.60.20for.20.60wasi-http.60.html#426181676">(Mar 12 2024 at 17:47)</a>:</h4>
<p>elliottt <a href="https://github.com/bytecodealliance/wasmtime/pull/8085#issuecomment-1992228160">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8085">PR #8085</a>:</p>
<blockquote>
<p>Ah! Sorry for misunderstanding. I think this is fine to leave it this way, but I agree that it's a little odd. Reading through the handshake implementation, it's assuming that the connection has already been made, so if anything we might want to remove the timeout on the second two uses in the function.</p>
</blockquote>



<a name="426182771"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238085%20Fix%20%60connect_timeout%60%20for%20%60wasi-http%60/near/426182771" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238085.20Fix.20.60connect_timeout.60.20for.20.60wasi-http.60.html#426182771">(Mar 12 2024 at 17:52)</a>:</h4>
<p>elliottt <a href="https://github.com/bytecodealliance/wasmtime/pull/8085#issuecomment-1992237293">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8085">PR #8085</a>:</p>
<blockquote>
<p>I added #8104 to record the fact that we should look into removing the uses of <code>connect_timeout</code> on the handshake calls, but that issue won't be valid until this PR merges.</p>
</blockquote>



<a name="426187933"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238085%20Fix%20%60connect_timeout%60%20for%20%60wasi-http%60/near/426187933" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238085.20Fix.20.60connect_timeout.60.20for.20.60wasi-http.60.html#426187933">(Mar 12 2024 at 18:22)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8085#pullrequestreview-1931978465">PR review</a>.</p>



<a name="426187935"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238085%20Fix%20%60connect_timeout%60%20for%20%60wasi-http%60/near/426187935" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238085.20Fix.20.60connect_timeout.60.20for.20.60wasi-http.60.html#426187935">(Mar 12 2024 at 18:22)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/8085#discussion_r1521942861">PR review comment</a>:</p>
<blockquote>
<p>This check failed on the MinGW build. What do you think about removing it and adding it back in a follow-up PR? As an aside, you can add <code>prtest:mingw-x64</code> in a commit message to explicitly run that job.</p>
</blockquote>



<a name="426191124"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238085%20Fix%20%60connect_timeout%60%20for%20%60wasi-http%60/near/426191124" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238085.20Fix.20.60connect_timeout.60.20for.20.60wasi-http.60.html#426191124">(Mar 12 2024 at 18:42)</a>:</h4>
<p>rikhuijzer updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8085">PR #8085</a>.</p>



<a name="426204064"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238085%20Fix%20%60connect_timeout%60%20for%20%60wasi-http%60/near/426204064" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238085.20Fix.20.60connect_timeout.60.20for.20.60wasi-http.60.html#426204064">(Mar 12 2024 at 20:09)</a>:</h4>
<p>elliottt merged <a href="https://github.com/bytecodealliance/wasmtime/pull/8085">PR #8085</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>