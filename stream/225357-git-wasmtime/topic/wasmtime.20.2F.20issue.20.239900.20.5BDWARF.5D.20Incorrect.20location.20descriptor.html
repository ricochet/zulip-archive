<html>
<head><meta charset="utf-8"><title>wasmtime / issue #9900 [DWARF] Incorrect location descriptor · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239900.20.5BDWARF.5D.20Incorrect.20location.20descriptor.html">wasmtime / issue #9900 [DWARF] Incorrect location descriptor</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="490702007"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239900%20%5BDWARF%5D%20Incorrect%20location%20descriptor/near/490702007" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239900.20.5BDWARF.5D.20Incorrect.20location.20descriptor.html#490702007">(Dec 24 2024 at 18:18)</a>:</h4>
<p>SingleAccretion opened <a href="https://github.com/bytecodealliance/wasmtime/issues/9900">issue #9900</a>:</p>
<blockquote>
<p>Reproduction steps:<br>
1) Check out #9898.<br>
2) Modify the added test to stop passing <code>-Oopt-level=0</code> to wasmtime.<br>
3) Run the test.</p>
<p>Expected result: the test passes or fails with 'expression unavailable'.</p>
<p>Actual result:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nc">Execution</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">interrupted</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p">:</span><span class="w"> </span><span class="nc">Exception</span><span class="w"> </span><span class="mh">0xc0000005</span><span class="w"> </span><span class="n">encountered</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="mh">0x7ff6fcf15f90</span><span class="p">:</span><span class="w"> </span><span class="nc">Access</span><span class="w"> </span><span class="n">violation</span><span class="w"> </span><span class="n">reading</span><span class="w"> </span><span class="n">location</span><span class="w"> </span><span class="mh">0x1ae198763ec</span><span class="p">.</span>
<span class="n">The</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">returned</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="n">expression</span><span class="w"> </span><span class="n">evaluation</span><span class="p">.</span>


<span class="o">*</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="p">#</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">stop</span><span class="w"> </span><span class="n">reason</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">breakpoint</span><span class="w"> </span><span class="mf">1.1</span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span><span class="p">#</span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="mh">0x0000028d720c15b8</span><span class="w"> </span><span class="n">JIT</span><span class="p">(</span><span class="mh">0x28d72210080</span><span class="p">)</span><span class="err">`</span><span class="n">DerivedType</span><span class="p">::</span><span class="n">InstanceMethod</span><span class="p">(</span><span class="n">__this</span><span class="o">=</span><span class="p">(</span><span class="n">__ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="n">read</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="mh">0x28de65f5f0c</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">read</span><span class="p">)</span><span class="o">&gt;</span><span class="p">))</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">generic</span><span class="p">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">26</span><span class="p">:</span><span class="mi">5</span>
<span class="w">   </span><span class="mi">23</span><span class="w">     </span><span class="n">long</span><span class="w"> </span><span class="n">long</span><span class="w"> </span><span class="n">DerivedValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">   </span><span class="mi">24</span>
<span class="w">   </span><span class="mi">25</span><span class="w">     </span><span class="n">int</span><span class="w"> </span><span class="n">InstanceMethod</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="p">-&gt;</span><span class="w"> </span><span class="mi">26</span><span class="w">       </span><span class="n">debug_break</span><span class="p">();</span>
<span class="w">   </span><span class="mi">27</span><span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">BaseValue</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">DerivedValue</span><span class="p">;</span>
<span class="w">   </span><span class="mi">28</span><span class="w">     </span><span class="p">}</span>
<span class="w">   </span><span class="mi">29</span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span><span class="w"> </span><span class="n">v</span>
<span class="p">(</span><span class="n">WasmtimeVMContext</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">__vmctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0000028d72165f00</span>
<span class="p">(</span><span class="n">WebAssemblyPtrWrapper</span><span class="o">&lt;</span><span class="n">DerivedType</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">__this</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">__ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="n">read</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="mh">0x28de65f5f0c</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">read</span><span class="p">)</span><span class="o">&gt;</span><span class="p">)</span>
</code></pre></div>
<p>It means the location descriptor for <code>__this</code> is incorrect.<br>
</p>
</blockquote>



<a name="490711747"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239900%20%5BDWARF%5D%20Incorrect%20location%20descriptor/near/490711747" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239900.20.5BDWARF.5D.20Incorrect.20location.20descriptor.html#490711747">(Dec 24 2024 at 20:24)</a>:</h4>
<p>SingleAccretion <a href="https://github.com/bytecodealliance/wasmtime/issues/9900#issuecomment-2561386194">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9900">issue #9900</a>:</p>
<blockquote>
<p>This is an interesting one. Here's how to reproducing the failure:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">&gt;</span><span class="w"> </span><span class="n">lldb</span><span class="p">.</span><span class="n">exe</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="s">"b InstanceMethod"</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="s">"r"</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">exe</span><span class="w"> </span><span class="o">-</span><span class="n">Ccache</span><span class="o">=</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="n">Ddebug</span><span class="o">-</span><span class="n">info</span><span class="w"> </span><span class="n">generic</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">   </span><span class="mi">25</span><span class="w">     </span><span class="n">int</span><span class="w"> </span><span class="n">InstanceMethod</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="p">-&gt;</span><span class="w"> </span><span class="mi">26</span><span class="w">       </span><span class="n">debug_break</span><span class="p">();</span>
<span class="w">   </span><span class="mi">27</span><span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">BaseValue</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">DerivedValue</span><span class="p">;</span>
<span class="w">   </span><span class="mi">28</span><span class="w">     </span><span class="p">}</span>
<span class="w">   </span><span class="mi">29</span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span><span class="w"> </span><span class="n">v</span>
<span class="p">(</span><span class="n">WasmtimeVMContext</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">__vmctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x000001dc1b2b2e10</span>
<span class="p">(</span><span class="n">WebAssemblyPtrWrapper</span><span class="o">&lt;</span><span class="n">DerivedType</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">__ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="n">read</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="mh">0x1dc38812e1c</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">read</span><span class="p">)</span><span class="o">&gt;</span><span class="p">)</span>
</code></pre></div>
<p>Here's the expression for <code>this</code>/<code>__this</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Variable</span><span class="p">:</span><span class="w"> </span><span class="nc">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">0x0000048d</span><span class="p">},</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"this"</span><span class="p">,</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"WebAssemblyPtrWrapper&lt;DerivedType&gt;"</span><span class="p">,</span><span class="w"> </span><span class="n">valid</span><span class="w"> </span><span class="n">ranges</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="n">block</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">          </span><span class="n">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DW_OP_breg4</span><span class="w"> </span><span class="n">RSI</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">DW_OP_plus_uconst</span><span class="w"> </span><span class="mh">0xc</span><span class="p">,</span><span class="w"> </span><span class="n">DW_OP_breg5</span><span class="w"> </span><span class="n">RDI</span><span class="o">+</span><span class="mi">96</span><span class="p">,</span><span class="w"> </span><span class="n">DW_OP_deref</span><span class="p">,</span><span class="w"> </span><span class="n">DW_OP_swap</span><span class="p">,</span><span class="w"> </span><span class="n">DW_OP_const4u</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">,</span><span class="w"> </span><span class="n">DW_OP_and</span><span class="p">,</span><span class="w"> </span><span class="n">DW_OP_plus</span><span class="p">,</span><span class="w"> </span><span class="n">decl</span><span class="w"> </span><span class="o">=</span>
<span class="w">          </span><span class="p">{</span><span class="n">RSI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0xc</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">RDI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">96</span><span class="p">]}</span><span class="w"> </span><span class="o">==&gt;</span><span class="w"> </span><span class="p">{[</span><span class="n">RDI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">96</span><span class="p">],</span><span class="w"> </span><span class="n">RSI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0xc</span><span class="p">}</span><span class="w"> </span><span class="o">==&gt;</span><span class="w"> </span><span class="p">[</span><span class="n">RDI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">96</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">RSI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0xc</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xffffffff</span>
<span class="p">;</span><span class="w"> </span><span class="p">[</span><span class="n">RDI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">96</span><span class="p">]</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">__vmctx</span><span class="p">-&gt;</span><span class="nc">memory</span>
<span class="p">;</span><span class="w"> </span><span class="n">RSI</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">linear</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="p">(</span><span class="n">WASM</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">sans</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span>
</code></pre></div>
<p>Here's annotated disassembly:</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1520</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span><span class="w">   </span><span class="no">push</span><span class="w">   </span><span class="no">rbp</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1521</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">1</span><span class="err">&gt;</span><span class="p">:</span><span class="w">   </span><span class="no">mov</span><span class="w">    </span><span class="no">rbp</span><span class="p">,</span><span class="w"> </span><span class="no">rsp</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1524</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">4</span><span class="err">&gt;</span><span class="p">:</span><span class="w">   </span><span class="no">mov</span><span class="w">    </span><span class="no">r10</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x8</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1528</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">8</span><span class="err">&gt;</span><span class="p">:</span><span class="w">   </span><span class="no">mov</span><span class="w">    </span><span class="no">r10</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">r10</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x10</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d152c</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">12</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">add</span><span class="w">    </span><span class="no">r10</span><span class="p">,</span><span class="w"> </span><span class="mi">0x30</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1530</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">16</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">cmp</span><span class="w">    </span><span class="no">r10</span><span class="p">,</span><span class="w"> </span><span class="no">rsp</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1533</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">19</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">ja</span><span class="w">     </span><span class="mi">0x262b49d15ae</span><span class="w">  </span><span class="c1">; &lt;+142&gt; at generic.cpp:27:5</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1539</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">25</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">sub</span><span class="w">    </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">0x20</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d153d</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">29</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="p">],</span><span class="w"> </span><span class="no">rbx</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1541</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">33</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x8</span><span class="p">],</span><span class="w"> </span><span class="no">r12</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1546</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">38</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x10</span><span class="p">],</span><span class="w"> </span><span class="no">r13</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d154b</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">43</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x18</span><span class="p">],</span><span class="w"> </span><span class="no">r15</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1550</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">48</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">r15d</span><span class="p">,</span><span class="w"> </span><span class="no">dword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0xa0</span><span class="p">]</span><span class="w"> </span><span class="c1">; r15 = __vmctx-&gt;__stack_pointer</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1557</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">55</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">rsi</span><span class="p">,</span><span class="w"> </span><span class="no">r15</span><span class="w">                     </span><span class="c1">; rsi = r15 (__stack_pointer)</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d155a</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">58</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">sub</span><span class="w">    </span><span class="no">esi</span><span class="p">,</span><span class="w"> </span><span class="mi">0x10</span><span class="w">                    </span><span class="c1">; rsi -= 16</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d155d</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">61</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">dword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0xa0</span><span class="p">],</span><span class="w"> </span><span class="no">esi</span><span class="w">  </span><span class="c1">; __vmctx-&gt;__stack_pointer = rsi</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1563</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">67</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">r12</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x60</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1567</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">71</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">dword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">r12</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="no">rsi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0xc</span><span class="p">],</span><span class="w"> </span><span class="no">edx</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d156c</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">76</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">rbx</span><span class="p">,</span><span class="w"> </span><span class="no">rdi</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d156f</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">79</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">r13</span><span class="p">,</span><span class="w"> </span><span class="no">rdx</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1572</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">82</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">rsi</span><span class="p">,</span><span class="w"> </span><span class="no">rbx</span><span class="w"> </span><span class="c1">; rsi = __vmctx</span>
<span class="err">-&gt;</span><span class="w">  </span><span class="err">0</span><span class="nf">x262b49d1575</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">85</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">call</span><span class="w">   </span><span class="mi">0x262b49d1180</span><span class="w">  </span><span class="c1">; debug_break at generic.h:9:28</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d157a</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">90</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="no">r13</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d157d</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">93</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">edx</span><span class="p">,</span><span class="w"> </span><span class="no">edx</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d157f</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">95</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">ecx</span><span class="p">,</span><span class="w"> </span><span class="no">dword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">r12</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="no">rdx</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1583</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">99</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">r12</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="no">rdx</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x8</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1588</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">104</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">mov</span><span class="w">    </span><span class="no">dword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rbx</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0xa0</span><span class="p">],</span><span class="w"> </span><span class="no">r15d</span><span class="w"> </span><span class="c1">; __vmctx-&gt;__stack_pointer = r15</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d158f</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">111</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">lea</span><span class="w">    </span><span class="no">eax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">rcx</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="no">rdx</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1592</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">114</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">mov</span><span class="w">    </span><span class="no">rbx</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1596</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">118</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">mov</span><span class="w">    </span><span class="no">r12</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x8</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d159b</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">123</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">mov</span><span class="w">    </span><span class="no">r13</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x10</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d15a0</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">128</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">mov</span><span class="w">    </span><span class="no">r15</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x18</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d15a5</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">133</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">add</span><span class="w">    </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">0x20</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d15a9</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">137</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">mov</span><span class="w">    </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="no">rbp</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d15ac</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">140</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">pop</span><span class="w">    </span><span class="no">rbp</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d15ad</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">141</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">ret</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d15ae</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">142</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">ud2</span>
</code></pre></div>
<p>So the culprit here is the fact <code>rsi</code>, which initially does indeed contain the original WASM frame base (local <code>0</code>), from which everything else gets evaluated, gets overwritten just before the call we've stopped on, and this is either not reflected in the frame info, or is not accounted for correctly.</p>
<p>BTW, here we can also see why the WASM frame base is so prone to being "optimized out" even as it is always used at the end of the method. Local zero gets split into two distinct values and the original, not referenced by anything DI-related, gets allocated into <code>r15</code>.</p>
</blockquote>



<a name="490711870"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239900%20%5BDWARF%5D%20Incorrect%20location%20descriptor/near/490711870" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239900.20.5BDWARF.5D.20Incorrect.20location.20descriptor.html#490711870">(Dec 24 2024 at 20:26)</a>:</h4>
<p>SingleAccretion edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/9900#issuecomment-2561386194">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9900">issue #9900</a>:</p>
<blockquote>
<p>This is an interesting one. Here's how to reproducing the failure:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">&gt;</span><span class="w"> </span><span class="n">lldb</span><span class="p">.</span><span class="n">exe</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="s">"b InstanceMethod"</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="s">"r"</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">exe</span><span class="w"> </span><span class="o">-</span><span class="n">Ccache</span><span class="o">=</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="n">Ddebug</span><span class="o">-</span><span class="n">info</span><span class="w"> </span><span class="n">generic</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">   </span><span class="mi">25</span><span class="w">     </span><span class="n">int</span><span class="w"> </span><span class="n">InstanceMethod</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="p">-&gt;</span><span class="w"> </span><span class="mi">26</span><span class="w">       </span><span class="n">debug_break</span><span class="p">();</span>
<span class="w">   </span><span class="mi">27</span><span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">BaseValue</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">DerivedValue</span><span class="p">;</span>
<span class="w">   </span><span class="mi">28</span><span class="w">     </span><span class="p">}</span>
<span class="w">   </span><span class="mi">29</span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span><span class="w"> </span><span class="n">v</span>
<span class="p">(</span><span class="n">WasmtimeVMContext</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">__vmctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x000001dc1b2b2e10</span>
<span class="p">(</span><span class="n">WebAssemblyPtrWrapper</span><span class="o">&lt;</span><span class="n">DerivedType</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">__ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="n">read</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="mh">0x1dc38812e1c</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">read</span><span class="p">)</span><span class="o">&gt;</span><span class="p">)</span>
</code></pre></div>
<p>Here's the expression for <code>this</code>/<code>__this</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Variable</span><span class="p">:</span><span class="w"> </span><span class="nc">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">0x0000048d</span><span class="p">},</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"this"</span><span class="p">,</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"WebAssemblyPtrWrapper&lt;DerivedType&gt;"</span><span class="p">,</span><span class="w"> </span><span class="n">valid</span><span class="w"> </span><span class="n">ranges</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="n">block</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">          </span><span class="n">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DW_OP_breg4</span><span class="w"> </span><span class="n">RSI</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">DW_OP_plus_uconst</span><span class="w"> </span><span class="mh">0xc</span><span class="p">,</span><span class="w"> </span><span class="n">DW_OP_breg5</span><span class="w"> </span><span class="n">RDI</span><span class="o">+</span><span class="mi">96</span><span class="p">,</span><span class="w"> </span><span class="n">DW_OP_deref</span><span class="p">,</span><span class="w"> </span><span class="n">DW_OP_swap</span><span class="p">,</span><span class="w"> </span><span class="n">DW_OP_const4u</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">,</span><span class="w"> </span><span class="n">DW_OP_and</span><span class="p">,</span><span class="w"> </span><span class="n">DW_OP_plus</span><span class="p">,</span><span class="w"> </span><span class="n">decl</span><span class="w"> </span><span class="o">=</span>
<span class="w">          </span><span class="p">{</span><span class="n">RSI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0xc</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">RDI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">96</span><span class="p">]}</span><span class="w"> </span><span class="o">==&gt;</span><span class="w"> </span><span class="p">{[</span><span class="n">RDI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">96</span><span class="p">],</span><span class="w"> </span><span class="n">RSI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0xc</span><span class="p">}</span><span class="w"> </span><span class="o">==&gt;</span><span class="w"> </span><span class="p">[</span><span class="n">RDI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">96</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">RSI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0xc</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xffffffff</span>
<span class="p">;</span><span class="w"> </span><span class="p">[</span><span class="n">RDI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">96</span><span class="p">]</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">__vmctx</span><span class="p">-&gt;</span><span class="nc">memory</span>
<span class="p">;</span><span class="w"> </span><span class="n">RSI</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">linear</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="p">(</span><span class="n">WASM</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">sans</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span>
</code></pre></div>
<p>Here's annotated disassembly:</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1520</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span><span class="w">   </span><span class="no">push</span><span class="w">   </span><span class="no">rbp</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1521</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">1</span><span class="err">&gt;</span><span class="p">:</span><span class="w">   </span><span class="no">mov</span><span class="w">    </span><span class="no">rbp</span><span class="p">,</span><span class="w"> </span><span class="no">rsp</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1524</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">4</span><span class="err">&gt;</span><span class="p">:</span><span class="w">   </span><span class="no">mov</span><span class="w">    </span><span class="no">r10</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x8</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1528</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">8</span><span class="err">&gt;</span><span class="p">:</span><span class="w">   </span><span class="no">mov</span><span class="w">    </span><span class="no">r10</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">r10</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x10</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d152c</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">12</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">add</span><span class="w">    </span><span class="no">r10</span><span class="p">,</span><span class="w"> </span><span class="mi">0x30</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1530</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">16</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">cmp</span><span class="w">    </span><span class="no">r10</span><span class="p">,</span><span class="w"> </span><span class="no">rsp</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1533</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">19</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">ja</span><span class="w">     </span><span class="mi">0x262b49d15ae</span><span class="w">  </span><span class="c1">; &lt;+142&gt; at generic.cpp:27:5</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1539</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">25</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">sub</span><span class="w">    </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">0x20</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d153d</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">29</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="p">],</span><span class="w"> </span><span class="no">rbx</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1541</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">33</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x8</span><span class="p">],</span><span class="w"> </span><span class="no">r12</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1546</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">38</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x10</span><span class="p">],</span><span class="w"> </span><span class="no">r13</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d154b</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">43</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x18</span><span class="p">],</span><span class="w"> </span><span class="no">r15</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1550</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">48</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">r15d</span><span class="p">,</span><span class="w"> </span><span class="no">dword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0xa0</span><span class="p">]</span><span class="w"> </span><span class="c1">; r15 = __vmctx-&gt;__stack_pointer</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1557</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">55</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">rsi</span><span class="p">,</span><span class="w"> </span><span class="no">r15</span><span class="w">                     </span><span class="c1">; rsi = r15 (__stack_pointer)</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d155a</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">58</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">sub</span><span class="w">    </span><span class="no">esi</span><span class="p">,</span><span class="w"> </span><span class="mi">0x10</span><span class="w">                    </span><span class="c1">; rsi -= 16</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d155d</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">61</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">dword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0xa0</span><span class="p">],</span><span class="w"> </span><span class="no">esi</span><span class="w">  </span><span class="c1">; __vmctx-&gt;__stack_pointer = rsi</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1563</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">67</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">r12</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x60</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1567</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">71</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">dword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">r12</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="no">rsi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0xc</span><span class="p">],</span><span class="w"> </span><span class="no">edx</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d156c</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">76</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">rbx</span><span class="p">,</span><span class="w"> </span><span class="no">rdi</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d156f</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">79</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">r13</span><span class="p">,</span><span class="w"> </span><span class="no">rdx</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1572</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">82</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">rsi</span><span class="p">,</span><span class="w"> </span><span class="no">rbx</span><span class="w"> </span><span class="c1">; rsi = __vmctx</span>
<span class="err">-&gt;</span><span class="w">  </span><span class="err">0</span><span class="nf">x262b49d1575</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">85</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">call</span><span class="w">   </span><span class="mi">0x262b49d1180</span><span class="w">  </span><span class="c1">; debug_break at generic.h:9:28</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d157a</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">90</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="no">r13</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d157d</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">93</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">edx</span><span class="p">,</span><span class="w"> </span><span class="no">edx</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d157f</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">95</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">ecx</span><span class="p">,</span><span class="w"> </span><span class="no">dword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">r12</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="no">rdx</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1583</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">99</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">r12</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="no">rdx</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x8</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1588</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">104</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">mov</span><span class="w">    </span><span class="no">dword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rbx</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0xa0</span><span class="p">],</span><span class="w"> </span><span class="no">r15d</span><span class="w"> </span><span class="c1">; __vmctx-&gt;__stack_pointer = r15</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d158f</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">111</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">lea</span><span class="w">    </span><span class="no">eax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">rcx</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="no">rdx</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1592</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">114</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">mov</span><span class="w">    </span><span class="no">rbx</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1596</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">118</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">mov</span><span class="w">    </span><span class="no">r12</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x8</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d159b</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">123</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">mov</span><span class="w">    </span><span class="no">r13</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x10</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d15a0</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">128</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">mov</span><span class="w">    </span><span class="no">r15</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x18</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d15a5</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">133</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">add</span><span class="w">    </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">0x20</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d15a9</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">137</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">mov</span><span class="w">    </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="no">rbp</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d15ac</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">140</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">pop</span><span class="w">    </span><span class="no">rbp</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d15ad</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">141</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">ret</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d15ae</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">142</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">ud2</span>
</code></pre></div>
<p>So the culprit here is the fact <code>rsi</code>, which initially does indeed contain the original WASM frame base (local <code>0</code>), from which everything else gets evaluated, gets overwritten just before the call we've stopped on, and this is either not reflected in the frame info, or is not accounted for correctly.</p>
<p>BTW, here we can also see why the WASM frame base is so prone to being "optimized out" even as it is always used at the end of the method. Local zero gets split into two distinct values: one referenced in code and not referenced in DI (<code>r15</code>), the other - not referenced in code, but referenced in DI (<code>rsi</code>).</p>
</blockquote>



<a name="490781579"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239900%20%5BDWARF%5D%20Incorrect%20location%20descriptor/near/490781579" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239900.20.5BDWARF.5D.20Incorrect.20location.20descriptor.html#490781579">(Dec 25 2024 at 13:58)</a>:</h4>
<p>SingleAccretion edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/9900#issuecomment-2561386194">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9900">issue #9900</a>:</p>
<blockquote>
<p>This is an interesting one. Here's how to reproduce the failure:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">&gt;</span><span class="w"> </span><span class="n">lldb</span><span class="p">.</span><span class="n">exe</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="s">"b InstanceMethod"</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="s">"r"</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">exe</span><span class="w"> </span><span class="o">-</span><span class="n">Ccache</span><span class="o">=</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="n">Ddebug</span><span class="o">-</span><span class="n">info</span><span class="w"> </span><span class="n">generic</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">   </span><span class="mi">25</span><span class="w">     </span><span class="n">int</span><span class="w"> </span><span class="n">InstanceMethod</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="p">-&gt;</span><span class="w"> </span><span class="mi">26</span><span class="w">       </span><span class="n">debug_break</span><span class="p">();</span>
<span class="w">   </span><span class="mi">27</span><span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">BaseValue</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">DerivedValue</span><span class="p">;</span>
<span class="w">   </span><span class="mi">28</span><span class="w">     </span><span class="p">}</span>
<span class="w">   </span><span class="mi">29</span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span><span class="w"> </span><span class="n">v</span>
<span class="p">(</span><span class="n">WasmtimeVMContext</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">__vmctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x000001dc1b2b2e10</span>
<span class="p">(</span><span class="n">WebAssemblyPtrWrapper</span><span class="o">&lt;</span><span class="n">DerivedType</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">__ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="n">read</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="mh">0x1dc38812e1c</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">read</span><span class="p">)</span><span class="o">&gt;</span><span class="p">)</span>
</code></pre></div>
<p>Here's the expression for <code>this</code>/<code>__this</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Variable</span><span class="p">:</span><span class="w"> </span><span class="nc">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">0x0000048d</span><span class="p">},</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"this"</span><span class="p">,</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"WebAssemblyPtrWrapper&lt;DerivedType&gt;"</span><span class="p">,</span><span class="w"> </span><span class="n">valid</span><span class="w"> </span><span class="n">ranges</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="n">block</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">          </span><span class="n">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DW_OP_breg4</span><span class="w"> </span><span class="n">RSI</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">DW_OP_plus_uconst</span><span class="w"> </span><span class="mh">0xc</span><span class="p">,</span><span class="w"> </span><span class="n">DW_OP_breg5</span><span class="w"> </span><span class="n">RDI</span><span class="o">+</span><span class="mi">96</span><span class="p">,</span><span class="w"> </span><span class="n">DW_OP_deref</span><span class="p">,</span><span class="w"> </span><span class="n">DW_OP_swap</span><span class="p">,</span><span class="w"> </span><span class="n">DW_OP_const4u</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">,</span><span class="w"> </span><span class="n">DW_OP_and</span><span class="p">,</span><span class="w"> </span><span class="n">DW_OP_plus</span><span class="p">,</span><span class="w"> </span><span class="n">decl</span><span class="w"> </span><span class="o">=</span>
<span class="w">          </span><span class="p">{</span><span class="n">RSI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0xc</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">RDI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">96</span><span class="p">]}</span><span class="w"> </span><span class="o">==&gt;</span><span class="w"> </span><span class="p">{[</span><span class="n">RDI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">96</span><span class="p">],</span><span class="w"> </span><span class="n">RSI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0xc</span><span class="p">}</span><span class="w"> </span><span class="o">==&gt;</span><span class="w"> </span><span class="p">[</span><span class="n">RDI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">96</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">RSI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0xc</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xffffffff</span>
<span class="p">;</span><span class="w"> </span><span class="p">[</span><span class="n">RDI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">96</span><span class="p">]</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">__vmctx</span><span class="p">-&gt;</span><span class="nc">memory</span>
<span class="p">;</span><span class="w"> </span><span class="n">RSI</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">linear</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="p">(</span><span class="n">WASM</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">sans</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span>
</code></pre></div>
<p>Here's annotated disassembly:</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1520</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span><span class="w">   </span><span class="no">push</span><span class="w">   </span><span class="no">rbp</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1521</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">1</span><span class="err">&gt;</span><span class="p">:</span><span class="w">   </span><span class="no">mov</span><span class="w">    </span><span class="no">rbp</span><span class="p">,</span><span class="w"> </span><span class="no">rsp</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1524</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">4</span><span class="err">&gt;</span><span class="p">:</span><span class="w">   </span><span class="no">mov</span><span class="w">    </span><span class="no">r10</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x8</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1528</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">8</span><span class="err">&gt;</span><span class="p">:</span><span class="w">   </span><span class="no">mov</span><span class="w">    </span><span class="no">r10</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">r10</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x10</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d152c</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">12</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">add</span><span class="w">    </span><span class="no">r10</span><span class="p">,</span><span class="w"> </span><span class="mi">0x30</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1530</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">16</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">cmp</span><span class="w">    </span><span class="no">r10</span><span class="p">,</span><span class="w"> </span><span class="no">rsp</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1533</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">19</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">ja</span><span class="w">     </span><span class="mi">0x262b49d15ae</span><span class="w">  </span><span class="c1">; &lt;+142&gt; at generic.cpp:27:5</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1539</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">25</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">sub</span><span class="w">    </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">0x20</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d153d</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">29</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="p">],</span><span class="w"> </span><span class="no">rbx</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1541</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">33</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x8</span><span class="p">],</span><span class="w"> </span><span class="no">r12</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1546</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">38</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x10</span><span class="p">],</span><span class="w"> </span><span class="no">r13</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d154b</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">43</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x18</span><span class="p">],</span><span class="w"> </span><span class="no">r15</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1550</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">48</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">r15d</span><span class="p">,</span><span class="w"> </span><span class="no">dword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0xa0</span><span class="p">]</span><span class="w"> </span><span class="c1">; r15 = __vmctx-&gt;__stack_pointer</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1557</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">55</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">rsi</span><span class="p">,</span><span class="w"> </span><span class="no">r15</span><span class="w">                     </span><span class="c1">; rsi = r15 (__stack_pointer)</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d155a</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">58</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">sub</span><span class="w">    </span><span class="no">esi</span><span class="p">,</span><span class="w"> </span><span class="mi">0x10</span><span class="w">                    </span><span class="c1">; rsi -= 16</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d155d</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">61</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">dword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0xa0</span><span class="p">],</span><span class="w"> </span><span class="no">esi</span><span class="w">  </span><span class="c1">; __vmctx-&gt;__stack_pointer = rsi</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1563</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">67</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">r12</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x60</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1567</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">71</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">dword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">r12</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="no">rsi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0xc</span><span class="p">],</span><span class="w"> </span><span class="no">edx</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d156c</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">76</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">rbx</span><span class="p">,</span><span class="w"> </span><span class="no">rdi</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d156f</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">79</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">r13</span><span class="p">,</span><span class="w"> </span><span class="no">rdx</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1572</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">82</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">rsi</span><span class="p">,</span><span class="w"> </span><span class="no">rbx</span><span class="w"> </span><span class="c1">; rsi = __vmctx</span>
<span class="err">-&gt;</span><span class="w">  </span><span class="err">0</span><span class="nf">x262b49d1575</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">85</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">call</span><span class="w">   </span><span class="mi">0x262b49d1180</span><span class="w">  </span><span class="c1">; debug_break at generic.h:9:28</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d157a</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">90</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="no">r13</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d157d</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">93</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">edx</span><span class="p">,</span><span class="w"> </span><span class="no">edx</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d157f</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">95</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">ecx</span><span class="p">,</span><span class="w"> </span><span class="no">dword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">r12</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="no">rdx</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1583</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">99</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">r12</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="no">rdx</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x8</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1588</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">104</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">mov</span><span class="w">    </span><span class="no">dword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rbx</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0xa0</span><span class="p">],</span><span class="w"> </span><span class="no">r15d</span><span class="w"> </span><span class="c1">; __vmctx-&gt;__stack_pointer = r15</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d158f</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">111</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">lea</span><span class="w">    </span><span class="no">eax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">rcx</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="no">rdx</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1592</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">114</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">mov</span><span class="w">    </span><span class="no">rbx</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1596</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">118</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">mov</span><span class="w">    </span><span class="no">r12</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x8</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d159b</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">123</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">mov</span><span class="w">    </span><span class="no">r13</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x10</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d15a0</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">128</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">mov</span><span class="w">    </span><span class="no">r15</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x18</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d15a5</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">133</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">add</span><span class="w">    </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">0x20</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d15a9</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">137</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">mov</span><span class="w">    </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="no">rbp</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d15ac</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">140</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">pop</span><span class="w">    </span><span class="no">rbp</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d15ad</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">141</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">ret</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d15ae</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">142</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="no">ud2</span>
</code></pre></div>
<p>So the culprit here is the fact <code>rsi</code>, which initially does indeed contain the original WASM frame base (local <code>0</code>), from which everything else gets evaluated, gets overwritten just before the call we've stopped on, and this is either not reflected in the frame info, or is not accounted for correctly.</p>
<p>BTW, here we can also see why the WASM frame base is so prone to being "optimized out" even as it is always used at the end of the method. Local zero gets split into two distinct values: one referenced in code and not referenced in DI (<code>r15</code>), the other - not referenced in code, but referenced in DI (<code>rsi</code>).</p>
</blockquote>



<a name="490952251"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239900%20%5BDWARF%5D%20Incorrect%20location%20descriptor/near/490952251" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239900.20.5BDWARF.5D.20Incorrect.20location.20descriptor.html#490952251">(Dec 27 2024 at 05:58)</a>:</h4>
<p><a href="https://github.com/alexcrichton">alexcrichton</a> added the wasmtime:debugging label to <a href="https://github.com/bytecodealliance/wasmtime/issues/9900">Issue #9900</a>.</p>



<a name="491122386"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239900%20%5BDWARF%5D%20Incorrect%20location%20descriptor/near/491122386" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239900.20.5BDWARF.5D.20Incorrect.20location.20descriptor.html#491122386">(Dec 28 2024 at 21:42)</a>:</h4>
<p>SingleAccretion <a href="https://github.com/bytecodealliance/wasmtime/issues/9900#issuecomment-2564488263">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9900">issue #9900</a>:</p>
<blockquote>
<p>Upgrading the logging for location descriptor building, here's what we see:</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nf">Building</span><span class="w"> </span><span class="no">ranges</span><span class="w"> </span><span class="no">for</span><span class="w"> </span><span class="no">values</span><span class="p">:</span>
<span class="nf">L</span><span class="mi">#0</span><span class="w">  </span><span class="p">:</span><span class="w"> </span><span class="nv">%rdx</span><span class="err">@</span><span class="p">[</span><span class="mi">49</span><span class="no">..86</span><span class="p">)</span><span class="w"> </span><span class="nv">%r13</span><span class="err">@</span><span class="p">[</span><span class="mi">86</span><span class="no">..94</span><span class="p">)</span>
<span class="nf">L</span><span class="mi">#1</span><span class="w">  </span><span class="p">:</span><span class="w"> </span><span class="nv">%r15</span><span class="err">@</span><span class="p">[</span><span class="mi">49</span><span class="no">..105</span><span class="p">)</span>
<span class="nf">L</span><span class="mi">#3</span><span class="w">  </span><span class="p">:</span><span class="w"> </span><span class="nv">%rsi</span><span class="err">@</span><span class="p">[</span><span class="mi">59</span><span class="no">..72</span><span class="p">)</span>
<span class="nf">L</span><span class="mi">#4</span><span class="w">  </span><span class="p">:</span><span class="w"> </span><span class="nv">%rdx</span><span class="err">@</span><span class="p">[</span><span class="mi">94</span><span class="no">..100</span><span class="p">)</span>
<span class="nf">L</span><span class="mi">#5</span><span class="w">  </span><span class="p">:</span><span class="w"> </span><span class="nv">%rcx</span><span class="err">@</span><span class="p">[</span><span class="mi">96</span><span class="no">..112</span><span class="p">)</span>
<span class="nf">L</span><span class="mi">#6</span><span class="w">  </span><span class="p">:</span><span class="w"> </span><span class="nv">%rcx</span><span class="err">@</span><span class="p">[</span><span class="mi">96</span><span class="no">..112</span><span class="p">)</span>
<span class="nf">L</span><span class="mi">#8</span><span class="w">  </span><span class="p">:</span><span class="w"> </span><span class="nv">%rdx</span><span class="err">@</span><span class="p">[</span><span class="mi">100</span><span class="no">..112</span><span class="p">)</span>
<span class="nl">VMCTX:</span><span class="w"> </span><span class="err">%</span><span class="nf">rdi@</span><span class="p">[</span><span class="mi">49</span><span class="no">..86</span><span class="p">)</span><span class="w"> </span><span class="nv">%rbx</span><span class="err">@</span><span class="p">[</span><span class="mi">86</span><span class="no">..115</span><span class="p">)</span>
</code></pre></div>
<p><code>L3</code> here is our frame base (<code>DW_OP_WASM_location 0x0 0x3</code>), and it is correctly reported to live for only these three instructions:</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="w">    </span><span class="err">0</span><span class="nf">x262b49d155d</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">61</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">dword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0xa0</span><span class="p">],</span><span class="w"> </span><span class="no">esi</span><span class="w">  </span><span class="c1">; __vmctx-&gt;__stack_pointer = rsi</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1563</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">67</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">r12</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0x60</span><span class="p">]</span>
<span class="w">    </span><span class="err">0</span><span class="nf">x262b49d1567</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">71</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">mov</span><span class="w">    </span><span class="no">dword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">r12</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="no">rsi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">0xc</span><span class="p">],</span><span class="w"> </span><span class="no">edx</span>
</code></pre></div>
<p>This implies a bug in range intersection.</p>
</blockquote>



<a name="492821120"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239900%20%5BDWARF%5D%20Incorrect%20location%20descriptor/near/492821120" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239900.20.5BDWARF.5D.20Incorrect.20location.20descriptor.html#492821120">(Jan 09 2025 at 21:23)</a>:</h4>
<p>SingleAccretion <a href="https://github.com/bytecodealliance/wasmtime/issues/9900#issuecomment-2581273676">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9900">issue #9900</a>:</p>
<blockquote>
<p>The complete range info looks like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Building</span><span class="w"> </span><span class="n">ranges</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">scope</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="mi">144</span><span class="p">)</span>
<span class="n">L</span><span class="p">#</span><span class="mi">0</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="o">%</span><span class="n">rdx</span><span class="o">@</span><span class="p">[</span><span class="mi">49</span><span class="o">..</span><span class="mi">86</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="n">r13</span><span class="o">@</span><span class="p">[</span><span class="mi">86</span><span class="o">..</span><span class="mi">94</span><span class="p">)</span>
<span class="n">L</span><span class="p">#</span><span class="mi">1</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="o">%</span><span class="n">r15</span><span class="o">@</span><span class="p">[</span><span class="mi">49</span><span class="o">..</span><span class="mi">105</span><span class="p">)</span>
<span class="n">L</span><span class="p">#</span><span class="mi">3</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="o">%</span><span class="n">rsi</span><span class="o">@</span><span class="p">[</span><span class="mi">59</span><span class="o">..</span><span class="mi">72</span><span class="p">)</span>
<span class="n">L</span><span class="p">#</span><span class="mi">4</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="o">%</span><span class="n">rdx</span><span class="o">@</span><span class="p">[</span><span class="mi">94</span><span class="o">..</span><span class="mi">100</span><span class="p">)</span>
<span class="n">L</span><span class="p">#</span><span class="mi">5</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="o">%</span><span class="n">rcx</span><span class="o">@</span><span class="p">[</span><span class="mi">96</span><span class="o">..</span><span class="mi">112</span><span class="p">)</span>
<span class="n">L</span><span class="p">#</span><span class="mi">6</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="o">%</span><span class="n">rcx</span><span class="o">@</span><span class="p">[</span><span class="mi">96</span><span class="o">..</span><span class="mi">112</span><span class="p">)</span>
<span class="n">L</span><span class="p">#</span><span class="mi">8</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="o">%</span><span class="n">rdx</span><span class="o">@</span><span class="p">[</span><span class="mi">100</span><span class="o">..</span><span class="mi">112</span><span class="p">)</span>
<span class="n">VMCTX</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">%</span><span class="n">rdi</span><span class="o">@</span><span class="p">[</span><span class="mi">49</span><span class="o">..</span><span class="mi">86</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="n">rbx</span><span class="o">@</span><span class="p">[</span><span class="mi">86</span><span class="o">..</span><span class="mi">115</span><span class="p">)</span>
<span class="n">Intersecting</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">L</span><span class="p">#</span><span class="mi">3</span>
<span class="n">Intersecting</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">VMCTX</span>
<span class="n">Built</span><span class="w"> </span><span class="n">ranges</span><span class="p">:</span>
<span class="p">[</span><span class="n">VMCTX</span><span class="p">:</span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="n">L</span><span class="p">#</span><span class="mi">3</span><span class="p">:</span><span class="o">%</span><span class="n">rsi</span><span class="p">]</span><span class="o">@</span><span class="p">[</span><span class="mi">59</span><span class="o">..</span><span class="mi">72</span><span class="p">)</span>
</code></pre></div>
<p>So we end up with a correct (single) range. That leads me to believe the bug is here:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/0fff9c10809b551730ff8e9d2524b849272210cf/crates/cranelift/src/debug/transform/attr.rs#L305-L319">https://github.com/bytecodealliance/wasmtime/blob/0fff9c10809b551730ff8e9d2524b849272210cf/crates/cranelift/src/debug/transform/attr.rs#L305-L319</a></p>
<p>We can only optimize to a single expression when the range covers the entire scope, which I suspect it almost never will.</p>
</blockquote>



<a name="493657979"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239900%20%5BDWARF%5D%20Incorrect%20location%20descriptor/near/493657979" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239900.20.5BDWARF.5D.20Incorrect.20location.20descriptor.html#493657979">(Jan 14 2025 at 19:51)</a>:</h4>
<p>SingleAccretion edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/9900#issuecomment-2581273676">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9900">issue #9900</a>:</p>
<blockquote>
<p>The complete range info looks like this:</p>
<div class="codehilite" data-code-language="Scala"><pre><span></span><code><span class="nc">Building</span><span class="w"> </span><span class="n">ranges</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">scope</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">.</span><span class="mf">.144</span><span class="p">)</span>
<span class="nc">L</span><span class="n">#</span><span class="mi">0</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="o">%</span><span class="n">rdx</span><span class="o">@</span><span class="p">[</span><span class="mi">49</span><span class="p">.</span><span class="mf">.86</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="n">r13</span><span class="o">@</span><span class="p">[</span><span class="mi">86</span><span class="p">.</span><span class="mf">.94</span><span class="p">)</span>
<span class="nc">L</span><span class="n">#</span><span class="mi">1</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="o">%</span><span class="n">r15</span><span class="o">@</span><span class="p">[</span><span class="mi">49</span><span class="p">.</span><span class="mf">.105</span><span class="p">)</span>
<span class="nc">L</span><span class="n">#</span><span class="mi">3</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="o">%</span><span class="n">rsi</span><span class="o">@</span><span class="p">[</span><span class="mi">59</span><span class="p">.</span><span class="mf">.72</span><span class="p">)</span>
<span class="nc">L</span><span class="n">#</span><span class="mi">4</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="o">%</span><span class="n">rdx</span><span class="o">@</span><span class="p">[</span><span class="mi">94</span><span class="p">.</span><span class="mf">.100</span><span class="p">)</span>
<span class="nc">L</span><span class="n">#</span><span class="mi">5</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="o">%</span><span class="n">rcx</span><span class="o">@</span><span class="p">[</span><span class="mi">96</span><span class="p">.</span><span class="mf">.112</span><span class="p">)</span>
<span class="nc">L</span><span class="n">#</span><span class="mi">6</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="o">%</span><span class="n">rcx</span><span class="o">@</span><span class="p">[</span><span class="mi">96</span><span class="p">.</span><span class="mf">.112</span><span class="p">)</span>
<span class="nc">L</span><span class="n">#</span><span class="mi">8</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="o">%</span><span class="n">rdx</span><span class="o">@</span><span class="p">[</span><span class="mi">100</span><span class="p">.</span><span class="mf">.112</span><span class="p">)</span>
<span class="nc">VMCTX</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">%</span><span class="n">rdi</span><span class="o">@</span><span class="p">[</span><span class="mi">49</span><span class="p">.</span><span class="mf">.86</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="n">rbx</span><span class="o">@</span><span class="p">[</span><span class="mi">86</span><span class="p">.</span><span class="mf">.115</span><span class="p">)</span>
<span class="nc">Intersecting</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">L</span><span class="n">#</span><span class="mi">3</span>
<span class="nc">Intersecting</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">VMCTX</span>
<span class="nc">Built</span><span class="w"> </span><span class="n">ranges</span><span class="p">:</span>
<span class="p">[</span><span class="nc">VMCTX</span><span class="p">:</span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="nc">L</span><span class="n">#</span><span class="mi">3</span><span class="p">:</span><span class="o">%</span><span class="n">rsi</span><span class="p">]</span><span class="o">@</span><span class="p">[</span><span class="mi">59</span><span class="p">.</span><span class="mf">.72</span><span class="p">)</span>
</code></pre></div>
<p>So we end up with a correct (single) range. That leads me to believe the bug is here:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/0fff9c10809b551730ff8e9d2524b849272210cf/crates/cranelift/src/debug/transform/attr.rs#L305-L319">https://github.com/bytecodealliance/wasmtime/blob/0fff9c10809b551730ff8e9d2524b849272210cf/crates/cranelift/src/debug/transform/attr.rs#L305-L319</a></p>
<p>We can only optimize to a single expression when the range covers the entire scope, which I suspect it almost never will.</p>
</blockquote>



<a name="493658013"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239900%20%5BDWARF%5D%20Incorrect%20location%20descriptor/near/493658013" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239900.20.5BDWARF.5D.20Incorrect.20location.20descriptor.html#493658013">(Jan 14 2025 at 19:51)</a>:</h4>
<p>SingleAccretion edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/9900#issuecomment-2581273676">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9900">issue #9900</a>:</p>
<blockquote>
<p>The complete range info looks like this:</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nf">Building</span><span class="w"> </span><span class="no">ranges</span><span class="w"> </span><span class="no">for</span><span class="w"> </span><span class="no">values</span><span class="w"> </span><span class="no">in</span><span class="w"> </span><span class="no">scope</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="no">..144</span><span class="p">)</span>
<span class="nf">L</span><span class="mi">#0</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="nv">%rdx</span><span class="err">@</span><span class="p">[</span><span class="mi">49</span><span class="no">..86</span><span class="p">)</span><span class="w"> </span><span class="nv">%r13</span><span class="err">@</span><span class="p">[</span><span class="mi">86</span><span class="no">..94</span><span class="p">)</span>
<span class="nf">L</span><span class="mi">#1</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="nv">%r15</span><span class="err">@</span><span class="p">[</span><span class="mi">49</span><span class="no">..105</span><span class="p">)</span>
<span class="nf">L</span><span class="mi">#3</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="nv">%rsi</span><span class="err">@</span><span class="p">[</span><span class="mi">59</span><span class="no">..72</span><span class="p">)</span>
<span class="nf">L</span><span class="mi">#4</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="nv">%rdx</span><span class="err">@</span><span class="p">[</span><span class="mi">94</span><span class="no">..100</span><span class="p">)</span>
<span class="nf">L</span><span class="mi">#5</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="nv">%rcx</span><span class="err">@</span><span class="p">[</span><span class="mi">96</span><span class="no">..112</span><span class="p">)</span>
<span class="nf">L</span><span class="mi">#6</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="nv">%rcx</span><span class="err">@</span><span class="p">[</span><span class="mi">96</span><span class="no">..112</span><span class="p">)</span>
<span class="nf">L</span><span class="mi">#8</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="nv">%rdx</span><span class="err">@</span><span class="p">[</span><span class="mi">100</span><span class="no">..112</span><span class="p">)</span>
<span class="nf">VMCTX</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nv">%rdi</span><span class="err">@</span><span class="p">[</span><span class="mi">49</span><span class="no">..86</span><span class="p">)</span><span class="w"> </span><span class="nv">%rbx</span><span class="err">@</span><span class="p">[</span><span class="mi">86</span><span class="no">..115</span><span class="p">)</span>
<span class="nf">Intersecting</span><span class="w"> </span><span class="no">with</span><span class="w"> </span><span class="no">L</span><span class="mi">#3</span>
<span class="nf">Intersecting</span><span class="w"> </span><span class="no">with</span><span class="w"> </span><span class="no">VMCTX</span>
<span class="nf">Built</span><span class="w"> </span><span class="no">ranges</span><span class="p">:</span>
<span class="err">[</span><span class="nl">VMCTX:</span><span class="err">%</span><span class="nf">rdi</span><span class="p">,</span><span class="w"> </span><span class="no">L</span><span class="mi">#3</span><span class="p">:</span><span class="nv">%rsi</span><span class="p">]</span><span class="err">@</span><span class="p">[</span><span class="mi">59</span><span class="no">..72</span><span class="p">)</span>
</code></pre></div>
<p>So we end up with a correct (single) range. That leads me to believe the bug is here:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/0fff9c10809b551730ff8e9d2524b849272210cf/crates/cranelift/src/debug/transform/attr.rs#L305-L319">https://github.com/bytecodealliance/wasmtime/blob/0fff9c10809b551730ff8e9d2524b849272210cf/crates/cranelift/src/debug/transform/attr.rs#L305-L319</a></p>
<p>We can only optimize to a single expression when the range covers the entire scope, which I suspect it almost never will.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>