<html>
<head><meta charset="utf-8"><title>wasmtime / issue #5919 Codegen  fix atomic_cas with samll... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235919.20Codegen.20.20fix.20atomic_cas.20with.20samll.2E.2E.2E.html">wasmtime / issue #5919 Codegen  fix atomic_cas with samll...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="339246876"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235919%20Codegen%20%20fix%20atomic_cas%20with%20samll.../near/339246876" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235919.20Codegen.20.20fix.20atomic_cas.20with.20samll.2E.2E.2E.html#339246876">(Mar 03 2023 at 03:17)</a>:</h4>
<p>yuyang-ok <a href="https://github.com/bytecodealliance/wasmtime/pull/5919#issuecomment-1452898798">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5919">issue #5919</a>:</p>
<blockquote>
<p>The test failure indicate a <code>s930x</code> has a wrong resule too.<br>
I think target <code>interpreter</code> and <code>x86_64</code> can pass.</p>
</blockquote>



<a name="339246900"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235919%20Codegen%20%20fix%20atomic_cas%20with%20samll.../near/339246900" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235919.20Codegen.20.20fix.20atomic_cas.20with.20samll.2E.2E.2E.html#339246900">(Mar 03 2023 at 03:18)</a>:</h4>
<p>yuyang-ok edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/5919#issuecomment-1452898798">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5919">issue #5919</a>:</p>
<blockquote>
<p>The test failure indicates a <code>s930x</code> has a wrong resule too ??? <br>
I think target <code>interpreter</code> and <code>x86_64</code> can pass.</p>
</blockquote>



<a name="339250561"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235919%20Codegen%20%20fix%20atomic_cas%20with%20samll.../near/339250561" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235919.20Codegen.20.20fix.20atomic_cas.20with.20samll.2E.2E.2E.html#339250561">(Mar 03 2023 at 04:02)</a>:</h4>
<p>yuyang-ok edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/5919#issuecomment-1452898798">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5919">issue #5919</a>:</p>
<blockquote>
<p>The test failure indicates a <code>s930x</code> has a wrong result too ??? <br>
I think target <code>interpreter</code> and <code>x86_64</code> can pass.</p>
</blockquote>



<a name="339253213"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235919%20Codegen%20%20fix%20atomic_cas%20with%20samll.../near/339253213" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235919.20Codegen.20.20fix.20atomic_cas.20with.20samll.2E.2E.2E.html#339253213">(Mar 03 2023 at 04:45)</a>:</h4>
<p>yuyang-ok edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/5919#issuecomment-1452898798">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5919">issue #5919</a>:</p>
<blockquote>
<p>The test failure indicates  <code>s930x</code> has a wrong result too ??? <br>
I think target <code>interpreter</code> and <code>x86_64</code> can pass.</p>
</blockquote>



<a name="339256465"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235919%20Codegen%20%20fix%20atomic_cas%20with%20samll.../near/339256465" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235919.20Codegen.20.20fix.20atomic_cas.20with.20samll.2E.2E.2E.html#339256465">(Mar 03 2023 at 05:30)</a>:</h4>
<p>yuyang-ok edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/5919#issuecomment-1452898798">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5919">issue #5919</a>:</p>
<blockquote>
<p>The test failure indicates  <code>s390x</code> has a wrong result too ??? <br>
I think target <code>interpreter</code> and <code>x86_64</code> can pass.</p>
</blockquote>



<a name="339331809"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235919%20Codegen%20%20fix%20atomic_cas%20with%20samll.../near/339331809" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235919.20Codegen.20.20fix.20atomic_cas.20with.20samll.2E.2E.2E.html#339331809">(Mar 03 2023 at 12:32)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/pull/5919#issuecomment-1453466621">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5919">issue #5919</a>:</p>
<blockquote>
<p>Oh that's right, this test is not endianness independent! If you change the <code>store</code> to <code>store little</code> and the <code>atomic_cas</code> to <code>atomic_cas little</code> it should start passing on all arches!</p>
<p>&lt;details&gt;<br>
&lt;summary&gt;New Testcase&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">interpret</span>
<span class="n">test</span><span class="w"> </span><span class="n">run</span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span>
<span class="n">target</span><span class="w"> </span><span class="n">s390x</span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span>
<span class="n">target</span><span class="w"> </span><span class="n">riscv64</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="kt">i8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i8</span> <span class="nc">sext</span><span class="w"> </span><span class="n">system_v</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ss2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">2</span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i8</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i16</span><span class="w"> </span><span class="mh">0x00ff</span>
<span class="w">    </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_addr</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">ss2</span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">little</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span>

<span class="w">    </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_addr</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">ss2</span><span class="o">+</span><span class="mi">1</span>
<span class="w">    </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomic_cas</span><span class="w"> </span><span class="n">little</span><span class="w"> </span><span class="n">v4</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v5</span>
<span class="p">}</span>

<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
</blockquote>



<a name="339503189"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235919%20Codegen%20%20fix%20atomic_cas%20with%20samll.../near/339503189" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235919.20Codegen.20.20fix.20atomic_cas.20with.20samll.2E.2E.2E.html#339503189">(Mar 04 2023 at 07:54)</a>:</h4>
<p>yuyang-ok <a href="https://github.com/bytecodealliance/wasmtime/pull/5919#issuecomment-1454657498">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5919">issue #5919</a>:</p>
<blockquote>
<p>@afonso360 Sure.</p>
</blockquote>



<a name="339762224"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235919%20Codegen%20%20fix%20atomic_cas%20with%20samll.../near/339762224" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235919.20Codegen.20.20fix.20atomic_cas.20with.20samll.2E.2E.2E.html#339762224">(Mar 06 2023 at 01:11)</a>:</h4>
<p>yuyang-ok <a href="https://github.com/bytecodealliance/wasmtime/pull/5919#issuecomment-1455283058">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5919">issue #5919</a>:</p>
<blockquote>
<p>@afonso360  I think we are ready.</p>
</blockquote>



<a name="339841239"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235919%20Codegen%20%20fix%20atomic_cas%20with%20samll.../near/339841239" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235919.20Codegen.20.20fix.20atomic_cas.20with.20samll.2E.2E.2E.html#339841239">(Mar 06 2023 at 11:25)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/pull/5919#issuecomment-1455957278">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5919">issue #5919</a>:</p>
<blockquote>
<p>I think we are still missing the fix for the 32 bit case, now that we are no longer using <code>t0</code></p>
</blockquote>



<a name="339841353"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235919%20Codegen%20%20fix%20atomic_cas%20with%20samll.../near/339841353" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235919.20Codegen.20.20fix.20atomic_cas.20with.20samll.2E.2E.2E.html#339841353">(Mar 06 2023 at 11:26)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/5919#issuecomment-1455957278">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5919">issue #5919</a>:</p>
<blockquote>
<p>I think we are still missing the fix for the 32 bit extend, now that we are no longer using <code>t0</code></p>
</blockquote>



<a name="339843489"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235919%20Codegen%20%20fix%20atomic_cas%20with%20samll.../near/339843489" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235919.20Codegen.20.20fix.20atomic_cas.20with.20samll.2E.2E.2E.html#339843489">(Mar 06 2023 at 11:37)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/5919#issuecomment-1455957278">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5919">issue #5919</a>:</p>
<blockquote>
<p>We are still missing the fix for the 32 bit extend, now that we are no longer using <code>t0</code></p>
</blockquote>



<a name="339999509"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235919%20Codegen%20%20fix%20atomic_cas%20with%20samll.../near/339999509" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235919.20Codegen.20.20fix.20atomic_cas.20with.20samll.2E.2E.2E.html#339999509">(Mar 07 2023 at 01:10)</a>:</h4>
<p>yuyang-ok <a href="https://github.com/bytecodealliance/wasmtime/pull/5919#issuecomment-1457312822">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5919">issue #5919</a>:</p>
<blockquote>
<p>@afonso360  Sorry.</p>
</blockquote>



<a name="340088445"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235919%20Codegen%20%20fix%20atomic_cas%20with%20samll.../near/340088445" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235919.20Codegen.20.20fix.20atomic_cas.20with.20samll.2E.2E.2E.html#340088445">(Mar 07 2023 at 11:53)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/pull/5919#issuecomment-1458034289">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5919">issue #5919</a>:</p>
<blockquote>
<p>LGTM!</p>
</blockquote>



<a name="340088481"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235919%20Codegen%20%20fix%20atomic_cas%20with%20samll.../near/340088481" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235919.20Codegen.20.20fix.20atomic_cas.20with.20samll.2E.2E.2E.html#340088481">(Mar 07 2023 at 11:53)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/5919#issuecomment-1458034289">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5919">issue #5919</a>:</p>
<blockquote>
<p>LGTM! Thanks!</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>