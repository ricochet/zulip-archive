<html>
<head><meta charset="utf-8"><title>wasmtime / issue #3722 Cranelift: Sign/zero-extend docs d... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233722.20Cranelift.3A.20Sign.2Fzero-extend.20docs.20d.2E.2E.2E.html">wasmtime / issue #3722 Cranelift: Sign/zero-extend docs d...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="269202552"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233722%20Cranelift%3A%20Sign/zero-extend%20docs%20d.../near/269202552" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233722.20Cranelift.3A.20Sign.2Fzero-extend.20docs.20d.2E.2E.2E.html#269202552">(Jan 25 2022 at 02:49)</a>:</h4>
<p>Mrmaxmeier opened <a href="https://github.com/bytecodealliance/wasmtime/issues/3722">issue #3722</a>:</p>
<blockquote>
<p>The docs for <code>uextend</code> and friends mention</p>
<blockquote>
<p>If the input and output types are the same, this is a no-op.</p>
</blockquote>
<p>When called with matching types, the verifier complains though:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/5fc01bafc7185b797f71c37352cbe66aa740893c/cranelift/codegen/src/verifier/mod.rs#L1471">https://github.com/bytecodealliance/wasmtime/blob/5fc01bafc7185b797f71c37352cbe66aa740893c/cranelift/codegen/src/verifier/mod.rs#L1471</a></p>
</blockquote>



<a name="269202553"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233722%20Cranelift%3A%20Sign/zero-extend%20docs%20d.../near/269202553" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233722.20Cranelift.3A.20Sign.2Fzero-extend.20docs.20d.2E.2E.2E.html#269202553">(Jan 25 2022 at 02:49)</a>:</h4>
<p>Mrmaxmeier labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/3722">issue #3722</a>:</p>
<blockquote>
<p>The docs for <code>uextend</code> and friends mention</p>
<blockquote>
<p>If the input and output types are the same, this is a no-op.</p>
</blockquote>
<p>When called with matching types, the verifier complains though:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/5fc01bafc7185b797f71c37352cbe66aa740893c/cranelift/codegen/src/verifier/mod.rs#L1471">https://github.com/bytecodealliance/wasmtime/blob/5fc01bafc7185b797f71c37352cbe66aa740893c/cranelift/codegen/src/verifier/mod.rs#L1471</a></p>
</blockquote>



<a name="269202554"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233722%20Cranelift%3A%20Sign/zero-extend%20docs%20d.../near/269202554" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233722.20Cranelift.3A.20Sign.2Fzero-extend.20docs.20d.2E.2E.2E.html#269202554">(Jan 25 2022 at 02:49)</a>:</h4>
<p>Mrmaxmeier labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/3722">issue #3722</a>:</p>
<blockquote>
<p>The docs for <code>uextend</code> and friends mention</p>
<blockquote>
<p>If the input and output types are the same, this is a no-op.</p>
</blockquote>
<p>When called with matching types, the verifier complains though:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/5fc01bafc7185b797f71c37352cbe66aa740893c/cranelift/codegen/src/verifier/mod.rs#L1471">https://github.com/bytecodealliance/wasmtime/blob/5fc01bafc7185b797f71c37352cbe66aa740893c/cranelift/codegen/src/verifier/mod.rs#L1471</a></p>
</blockquote>



<a name="269202731"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233722%20Cranelift%3A%20Sign/zero-extend%20docs%20d.../near/269202731" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233722.20Cranelift.3A.20Sign.2Fzero-extend.20docs.20d.2E.2E.2E.html#269202731">(Jan 25 2022 at 02:52)</a>:</h4>
<p>Mrmaxmeier edited <a href="https://github.com/bytecodealliance/wasmtime/issues/3722">issue #3722</a>:</p>
<blockquote>
<p>The docs for <code>uextend</code> and friends mention</p>
<blockquote>
<p>If the input and output types are the same, this is a no-op.</p>
</blockquote>
<p>When called with matching types, the verifier complains though:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/5fc01bafc7185b797f71c37352cbe66aa740893c/cranelift/codegen/src/verifier/mod.rs#L1471">https://github.com/bytecodealliance/wasmtime/blob/5fc01bafc7185b797f71c37352cbe66aa740893c/cranelift/codegen/src/verifier/mod.rs#L1471</a></p>
<p>(Whoops, this probably shouldn't be labeled as a bug ^^)</p>
</blockquote>



<a name="269304976"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233722%20Cranelift%3A%20Sign/zero-extend%20docs%20d.../near/269304976" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233722.20Cranelift.3A.20Sign.2Fzero-extend.20docs.20d.2E.2E.2E.html#269304976">(Jan 25 2022 at 18:52)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/3722#issuecomment-1021503819">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3722">issue #3722</a>:</p>
<blockquote>
<p>Thanks for filing an issue.</p>
<p>I'd be in favor of updating the docs to match reality, rather than changing the verifier. Thoughts @cfallin?</p>
</blockquote>



<a name="269307987"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233722%20Cranelift%3A%20Sign/zero-extend%20docs%20d.../near/269307987" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233722.20Cranelift.3A.20Sign.2Fzero-extend.20docs.20d.2E.2E.2E.html#269307987">(Jan 25 2022 at 19:12)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/3722#issuecomment-1021519995">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3722">issue #3722</a>:</p>
<blockquote>
<p>@Mrmaxmeier I'm actually somewhat surprised that a uextend-T-to-T didn't work; this line</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="n">arg_type</span><span class="p">.</span><span class="n">lane_bits</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">ctrl_type</span><span class="p">.</span><span class="n">lane_bits</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</code></pre></div>
<p>seems to indicate that equal input and output widths (<code>&gt;=</code>) should be fine. I think that this is a reasonable thing to support; it simplifies the producer side not to have to special-case. Could you share the input that led to this error?</p>
</blockquote>



<a name="269315820"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233722%20Cranelift%3A%20Sign/zero-extend%20docs%20d.../near/269315820" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233722.20Cranelift.3A.20Sign.2Fzero-extend.20docs.20d.2E.2E.2E.html#269315820">(Jan 25 2022 at 20:04)</a>:</h4>
<p>Mrmaxmeier <a href="https://github.com/bytecodealliance/wasmtime/issues/3722#issuecomment-1021561306">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3722">issue #3722</a>:</p>
<blockquote>
<p>The <code>&gt;=</code> condition guards the error case. Here's a <code>.clif</code>:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">func</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">)</span>:
    <span class="nc">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uextend</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v0</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="269321882"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233722%20Cranelift%3A%20Sign/zero-extend%20docs%20d.../near/269321882" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233722.20Cranelift.3A.20Sign.2Fzero-extend.20docs.20d.2E.2E.2E.html#269321882">(Jan 25 2022 at 20:50)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/3722#issuecomment-1021596475">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3722">issue #3722</a>:</p>
<blockquote>
<p>Urgh, you're right, I didn't read closely enough; sorry!</p>
<p>I looked a bit more into whether the backends would already support this or not, and it appears that at least e.g. <a href="https://github.com/bytecodealliance/wasmtime/blob/595e3227c530a68597ea29a30283e4114f621b10/cranelift/codegen/src/isa/x64/lower.rs#L2015-L2021">here</a> in the x64 backend (maybe others too) the T-to-T case isn't handled. If you want to try your hand at doing so, I'm happy to review a PR, otherwise it's probably OK to update the docs to reflect the limitation for now. We might want to come back to this as we review opcode/type-coverage completeness, though.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>