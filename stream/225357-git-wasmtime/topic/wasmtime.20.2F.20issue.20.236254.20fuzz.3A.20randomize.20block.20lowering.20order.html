<html>
<head><meta charset="utf-8"><title>wasmtime / issue #6254 fuzz: randomize block lowering order · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236254.20fuzz.3A.20randomize.20block.20lowering.20order.html">wasmtime / issue #6254 fuzz: randomize block lowering order</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="351418873"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236254%20fuzz%3A%20randomize%20block%20lowering%20order/near/351418873" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236254.20fuzz.3A.20randomize.20block.20lowering.20order.html#351418873">(Apr 20 2023 at 20:07)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/6254#issuecomment-1516883117">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6254">issue #6254</a>:</p>
<blockquote>
<p>Would you mind pulling the <code>lb_to_bindex</code> change out to a separate PR? I'd like to review and benchmark that on its own.</p>
</blockquote>



<a name="351421890"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236254%20fuzz%3A%20randomize%20block%20lowering%20order/near/351421890" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236254.20fuzz.3A.20randomize.20block.20lowering.20order.html#351421890">(Apr 20 2023 at 20:27)</a>:</h4>
<p>remlse <a href="https://github.com/bytecodealliance/wasmtime/pull/6254#issuecomment-1516904422">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6254">issue #6254</a>:</p>
<blockquote>
<p>@jameysharp sure thing: #6255 </p>
</blockquote>



<a name="353157110"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236254%20fuzz%3A%20randomize%20block%20lowering%20order/near/353157110" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236254.20fuzz.3A.20randomize.20block.20lowering.20order.html#353157110">(Apr 27 2023 at 08:18)</a>:</h4>
<p>remlse <a href="https://github.com/bytecodealliance/wasmtime/pull/6254#issuecomment-1525084748">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6254">issue #6254</a>:</p>
<blockquote>
<p>Hi @fitzgen , I'm still getting errors from cargo vet. I merged the main branch where the wildcard audit was added. Do I need to do something else to make the audit work? I think we'd also need a wildcard audit for <code>derive_arbitrary</code>, right?</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Run</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">vet</span><span class="w"> </span><span class="o">--</span><span class="n">locked</span>
<span class="n">Vetting</span><span class="w"> </span><span class="n">Failed</span><span class="o">!</span>

<span class="mi">2</span><span class="w"> </span><span class="n">unvetted</span><span class="w"> </span><span class="n">dependencies</span>:
  <span class="nc">arbitrary</span>:<span class="mf">1.3.0</span><span class="w"> </span><span class="n">missing</span><span class="w"> </span><span class="p">[</span><span class="s">"safe-to-deploy"</span><span class="p">]</span>
<span class="w">  </span><span class="n">derive_arbitrary</span>:<span class="mf">1.3.0</span><span class="w"> </span><span class="n">missing</span><span class="w"> </span><span class="p">[</span><span class="s">"safe-to-deploy"</span><span class="p">]</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="353412712"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236254%20fuzz%3A%20randomize%20block%20lowering%20order/near/353412712" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236254.20fuzz.3A.20randomize.20block.20lowering.20order.html#353412712">(Apr 27 2023 at 17:36)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/6254#issuecomment-1526080531">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6254">issue #6254</a>:</p>
<blockquote>
<blockquote>
<p>I think we'd also need a wildcard audit for <code>derive_arbitrary</code>, right?</p>
</blockquote>
<p>Added in <a href="https://github.com/bytecodealliance/wasmtime/pull/6294">https://github.com/bytecodealliance/wasmtime/pull/6294</a></p>
</blockquote>



<a name="353765002"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236254%20fuzz%3A%20randomize%20block%20lowering%20order/near/353765002" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236254.20fuzz.3A.20randomize.20block.20lowering.20order.html#353765002">(Apr 28 2023 at 09:54)</a>:</h4>
<p>remlse <a href="https://github.com/bytecodealliance/wasmtime/pull/6254#issuecomment-1527297012">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6254">issue #6254</a>:</p>
<blockquote>
<p>Alright, I think this should be ready to review @cfallin </p>
</blockquote>



<a name="354049206"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236254%20fuzz%3A%20randomize%20block%20lowering%20order/near/354049206" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236254.20fuzz.3A.20randomize.20block.20lowering.20order.html#354049206">(Apr 28 2023 at 20:48)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/6254#issuecomment-1528076787">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6254">issue #6254</a>:</p>
<blockquote>
<p>@remlse would you mind looking into the CI failure in the merge queue?</p>
</blockquote>



<a name="354254111"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236254%20fuzz%3A%20randomize%20block%20lowering%20order/near/354254111" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236254.20fuzz.3A.20randomize.20block.20lowering.20order.html#354254111">(Apr 29 2023 at 08:30)</a>:</h4>
<p>remlse <a href="https://github.com/bytecodealliance/wasmtime/pull/6254#issuecomment-1528717622">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6254">issue #6254</a>:</p>
<blockquote>
<p>Will do. I'm having trouble reproducing locally, but I'll get there.</p>
</blockquote>



<a name="354724588"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236254%20fuzz%3A%20randomize%20block%20lowering%20order/near/354724588" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236254.20fuzz.3A.20randomize.20block.20lowering.20order.html#354724588">(Apr 30 2023 at 17:14)</a>:</h4>
<p>remlse <a href="https://github.com/bytecodealliance/wasmtime/pull/6254#issuecomment-1529083504">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6254">issue #6254</a>:</p>
<blockquote>
<p>Well, this was quite the rabbit whole.</p>
<p>I can reproduce now, compiling the fuzz target <code>component_api</code> causes some kind of infinite loop / memory leak during compilation. RAM consumption of rustc slowly crawls up to 100% (30GB), at which point my PC freezes. The trigger seems to be the update to (derive_)arbitrary 1.3.</p>
<p>With <code>git bisect</code>, I narrowed it down to the diff of this commit range in the arbitrary repo: <a href="https://github.com/rust-fuzz/arbitrary/compare/7ebc6c8...15c340e">7ebc6c8...15c340e</a>. (Given the rest of this story, I don't think the problem is in the arbitrary crate. There's nothing crazy going on in this diff.)</p>
<p>The build script of <code>wasmtime-fuzz</code> generates some code, which is included in the <code>component_api</code> target with</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="fm">include!</span><span class="p">(</span><span class="fm">concat!</span><span class="p">(</span><span class="fm">env!</span><span class="p">(</span><span class="s">"OUT_DIR"</span><span class="p">),</span><span class="w"> </span><span class="s">"/static_component_api.rs"</span><span class="p">));</span>
</code></pre></div>
<p>Compiling these 15 MB of generated code no longer terminates with higher versions of arbitrary. I reduced the number of generated test cases from 100 to 1 to make it easier to inspect the generated code. That actually fixed the problem, though, building the fuzz targets now succeeded.</p>
<p>So I started bisecting the number of test cases. But I soon noticed that not even compiling 2 test cases works. At least with 2 test cases, my memory was enough to get me to a compiler crash.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span>: <span class="nc">the</span><span class="w"> </span><span class="n">compiler</span><span class="w"> </span><span class="n">unexpectedly</span><span class="w"> </span><span class="n">panicked</span><span class="p">.</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">bug</span><span class="p">.</span>
</code></pre></div>
<p>Lovely. I'll attach the full output for future reference: <a href="https://github.com/bytecodealliance/wasmtime/files/11361878/rustc_panic.txt">rustc_panic.txt</a>. And I made a branch with (hopefully) all the necessary changes to reproduce <a href="https://github.com/remlse/wasmtime/tree/rustc-panic">here</a>. The command I used is</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="nv">WASMTIME_FUZZ_SEED</span><span class="o">=</span><span class="m">1234</span><span class="w"> </span>cargo<span class="w"> </span>fuzz<span class="w"> </span>build<span class="w"> </span>--no-default-features<span class="w"> </span>--dev<span class="w"> </span>-s<span class="w"> </span>none
</code></pre></div>
<p>I'll have to call it a day. I guess the next debugging step for me would be to try to understand the code generated in the build script - and how it could confuse the compiler.</p>
</blockquote>



<a name="354815046"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236254%20fuzz%3A%20randomize%20block%20lowering%20order/near/354815046" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236254.20fuzz.3A.20randomize.20block.20lowering.20order.html#354815046">(May 01 2023 at 08:18)</a>:</h4>
<p>remlse edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/6254#issuecomment-1529083504">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6254">issue #6254</a>:</p>
<blockquote>
<p>Well, this was quite the rabbit hole.</p>
<p>I can reproduce now, compiling the fuzz target <code>component_api</code> causes some kind of infinite loop / memory leak during compilation. RAM consumption of rustc slowly crawls up to 100% (30GB), at which point my PC freezes. The trigger seems to be the update to (derive_)arbitrary 1.3.</p>
<p>With <code>git bisect</code>, I narrowed it down to the diff of this commit range in the arbitrary repo: <a href="https://github.com/rust-fuzz/arbitrary/compare/7ebc6c8...15c340e">7ebc6c8...15c340e</a>. (Given the rest of this story, I don't think the problem is in the arbitrary crate. There's nothing crazy going on in this diff.)</p>
<p>The build script of <code>wasmtime-fuzz</code> generates some code, which is included in the <code>component_api</code> target with</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="fm">include!</span><span class="p">(</span><span class="fm">concat!</span><span class="p">(</span><span class="fm">env!</span><span class="p">(</span><span class="s">"OUT_DIR"</span><span class="p">),</span><span class="w"> </span><span class="s">"/static_component_api.rs"</span><span class="p">));</span>
</code></pre></div>
<p>Compiling these 15 MB of generated code no longer terminates with higher versions of arbitrary. I reduced the number of generated test cases from 100 to 1 to make it easier to inspect the generated code. That actually fixed the problem, though, building the fuzz targets now succeeded.</p>
<p>So I started bisecting the number of test cases. But I soon noticed that not even compiling 2 test cases works. At least with 2 test cases, my memory was enough to get me to a compiler crash.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span>: <span class="nc">the</span><span class="w"> </span><span class="n">compiler</span><span class="w"> </span><span class="n">unexpectedly</span><span class="w"> </span><span class="n">panicked</span><span class="p">.</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">bug</span><span class="p">.</span>
</code></pre></div>
<p>Lovely. I'll attach the full output for future reference: <a href="https://github.com/bytecodealliance/wasmtime/files/11361878/rustc_panic.txt">rustc_panic.txt</a>. And I made a branch with (hopefully) all the necessary changes to reproduce <a href="https://github.com/remlse/wasmtime/tree/rustc-panic">here</a>. The command I used is</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="nv">WASMTIME_FUZZ_SEED</span><span class="o">=</span><span class="m">1234</span><span class="w"> </span>cargo<span class="w"> </span>fuzz<span class="w"> </span>build<span class="w"> </span>--no-default-features<span class="w"> </span>--dev<span class="w"> </span>-s<span class="w"> </span>none
</code></pre></div>
<p>I'll have to call it a day. I guess the next debugging step for me would be to try to understand the code generated in the build script - and how it could confuse the compiler.</p>
</blockquote>



<a name="354886785"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236254%20fuzz%3A%20randomize%20block%20lowering%20order/near/354886785" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236254.20fuzz.3A.20randomize.20block.20lowering.20order.html#354886785">(May 01 2023 at 14:10)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/6254#issuecomment-1529754515">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6254">issue #6254</a>:</p>
<blockquote>
<p>Oh dear if that script is building a 15M source file that's way too big, let me see if the limits should be trimmed on that.</p>
</blockquote>



<a name="354901099"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236254%20fuzz%3A%20randomize%20block%20lowering%20order/near/354901099" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236254.20fuzz.3A.20randomize.20block.20lowering.20order.html#354901099">(May 01 2023 at 15:07)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/6254#issuecomment-1529814196">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6254">issue #6254</a>:</p>
<blockquote>
<p>Ok I've pushed up <a href="https://github.com/bytecodealliance/wasmtime/pull/6315">https://github.com/bytecodealliance/wasmtime/pull/6315</a> which, when testing locally, gets the size of the generated test file to be a more reasonable 200K instead of 15M</p>
</blockquote>



<a name="354919598"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236254%20fuzz%3A%20randomize%20block%20lowering%20order/near/354919598" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236254.20fuzz.3A.20randomize.20block.20lowering.20order.html#354919598">(May 01 2023 at 16:27)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/6254#issuecomment-1529920997">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6254">issue #6254</a>:</p>
<blockquote>
<p>Ok let's try again and fingers crossed on this one. Thanks again @remlse for taking the time to investigate the failure!</p>
</blockquote>



<a name="354919675"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236254%20fuzz%3A%20randomize%20block%20lowering%20order/near/354919675" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236254.20fuzz.3A.20randomize.20block.20lowering.20order.html#354919675">(May 01 2023 at 16:27)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/6254#issuecomment-1529921325">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6254">issue #6254</a>:</p>
<blockquote>
<p>Oh actually I think this'll need to be rebased, but it should be able to merge afterwards.</p>
</blockquote>



<a name="354934902"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236254%20fuzz%3A%20randomize%20block%20lowering%20order/near/354934902" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236254.20fuzz.3A.20randomize.20block.20lowering.20order.html#354934902">(May 01 2023 at 17:33)</a>:</h4>
<p>remlse <a href="https://github.com/bytecodealliance/wasmtime/pull/6254#issuecomment-1529986705">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6254">issue #6254</a>:</p>
<blockquote>
<p>@alexcrichton Thank you for the fix! <span aria-label="heart" class="emoji emoji-2764" role="img" title="heart">:heart:</span> </p>
</blockquote>



<a name="354939947"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236254%20fuzz%3A%20randomize%20block%20lowering%20order/near/354939947" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236254.20fuzz.3A.20randomize.20block.20lowering.20order.html#354939947">(May 01 2023 at 17:57)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/6254#issuecomment-1530014168">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6254">issue #6254</a>:</p>
<blockquote>
<p>@remlse we've just seen a possible issue on this while discussing in a meeting; more from @elliottt in a bit...</p>
</blockquote>



<a name="354952135"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236254%20fuzz%3A%20randomize%20block%20lowering%20order/near/354952135" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236254.20fuzz.3A.20randomize.20block.20lowering.20order.html#354952135">(May 01 2023 at 18:48)</a>:</h4>
<p>elliottt <a href="https://github.com/bytecodealliance/wasmtime/pull/6254#issuecomment-1530065441">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6254">issue #6254</a>:</p>
<blockquote>
<p>I think we're reliant on seeing uses before defs for the management of the <code>value_lowered_uses</code> field of the <code>Lower</code> struct. If we put the blocks in a random order, we may see the definition first, and as a result decide that the instruction isn't needed in the final program: <a href="https://github.com/bytecodealliance/wasmtime/blob/3b7274fa94c39b9e3984fa207994b60ec827a31b/cranelift/codegen/src/machinst/lower.rs#L708-L709">https://github.com/bytecodealliance/wasmtime/blob/3b7274fa94c39b9e3984fa207994b60ec827a31b/cranelift/codegen/src/machinst/lower.rs#L708-L709</a><br>
In the snippet above, <code>is_any_inst_result_needed</code> queries the <code>value_lowered_uses</code> vector for any result value with a number of uses that's greater than zero, and the entry in that vector is only incremented when processing uses of that value.</p>
</blockquote>



<a name="354954834"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236254%20fuzz%3A%20randomize%20block%20lowering%20order/near/354954834" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236254.20fuzz.3A.20randomize.20block.20lowering.20order.html#354954834">(May 01 2023 at 18:59)</a>:</h4>
<p>remlse <a href="https://github.com/bytecodealliance/wasmtime/pull/6254#issuecomment-1530077644">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6254">issue #6254</a>:</p>
<blockquote>
<p>I see, then we can't merge this. Is there some other order we could randomize to salvage some of the work? <span aria-label="joy" class="emoji emoji-1f602" role="img" title="joy">:joy:</span> </p>
</blockquote>



<a name="354961549"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236254%20fuzz%3A%20randomize%20block%20lowering%20order/near/354961549" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236254.20fuzz.3A.20randomize.20block.20lowering.20order.html#354961549">(May 01 2023 at 19:34)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/6254#issuecomment-1530115180">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6254">issue #6254</a>:</p>
<blockquote>
<p>Yes, sorry @remlse, I had forgotten about this ordering invariant. (I have no excuse, I wrote this code ~3 years ago!)</p>
<p>Offline Trevor suggested a nice approach to still reorder to an allowed degree,  namely: pick some permutation that still respects defs-before-uses. In particular, <a href="https://github.com/bytecodealliance/wasmtime/blob/d5d2e854f97daa3acc6820299231e73cbb0b246c/cranelift/codegen/src/machinst/blockorder.rs#L198">this loop</a> I think can iterate successors for a block in any order and still generate valid RPO.</p>
</blockquote>



<a name="355071980"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236254%20fuzz%3A%20randomize%20block%20lowering%20order/near/355071980" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236254.20fuzz.3A.20randomize.20block.20lowering.20order.html#355071980">(May 02 2023 at 08:33)</a>:</h4>
<p>remlse <a href="https://github.com/bytecodealliance/wasmtime/pull/6254#issuecomment-1531084644">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6254">issue #6254</a>:</p>
<blockquote>
<blockquote>
<p>Out of curiosity, have you fuzzed with this (and verified that no issues arise)?</p>
</blockquote>
<p>I did a short sanity check yesterday, and a longer (30min) run today without panics. Is there something else I should do to verify there aren't any issues?</p>
</blockquote>



<a name="355202305"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236254%20fuzz%3A%20randomize%20block%20lowering%20order/near/355202305" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236254.20fuzz.3A.20randomize.20block.20lowering.20order.html#355202305">(May 02 2023 at 16:20)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/6254#issuecomment-1531758253">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6254">issue #6254</a>:</p>
<blockquote>
<p>Nope, that sounds great -- let's merge, thanks!</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>