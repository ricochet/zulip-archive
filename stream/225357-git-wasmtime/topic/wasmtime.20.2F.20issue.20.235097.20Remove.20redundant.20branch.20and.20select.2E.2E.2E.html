<html>
<head><meta charset="utf-8"><title>wasmtime / issue #5097 Remove redundant branch and select... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235097.20Remove.20redundant.20branch.20and.20select.2E.2E.2E.html">wasmtime / issue #5097 Remove redundant branch and select...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="305865470"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235097%20Remove%20redundant%20branch%20and%20select.../near/305865470" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235097.20Remove.20redundant.20branch.20and.20select.2E.2E.2E.html#305865470">(Oct 24 2022 at 17:03)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/5097#issuecomment-1289332531">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5097">issue #5097</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @cfallin, @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "cranelift:area:aarch64", "cranelift:area:machinst", "cranelift:area:x64", "cranelift:meta", "isle"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>cfallin: isle</li>
<li>fitzgen: isle</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="305890402"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235097%20Remove%20redundant%20branch%20and%20select.../near/305890402" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235097.20Remove.20redundant.20branch.20and.20select.2E.2E.2E.html#305890402">(Oct 24 2022 at 18:35)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/pull/5097#issuecomment-1289436653">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5097">issue #5097</a>:</p>
<blockquote>
<p>I'm taking a look at this as well...</p>
</blockquote>



<a name="305894914"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235097%20Remove%20redundant%20branch%20and%20select.../near/305894914" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235097.20Remove.20redundant.20branch.20and.20select.2E.2E.2E.html#305894914">(Oct 24 2022 at 19:03)</a>:</h4>
<p>elliottt <a href="https://github.com/bytecodealliance/wasmtime/pull/5097#issuecomment-1289468486">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5097">issue #5097</a>:</p>
<blockquote>
<blockquote>
<p>I think overall this is a good change! I looked primarily at the x64 optimizations and I see that the lowering optimizations for <code>br*</code> and <code>*cmp</code> are already in place <a href="https://github.com/bytecodealliance/wasmtime/blob/6917ba5ae9f92850d4fe9c6699cb9f13e7af9ffc/cranelift/codegen/src/isa/x64/lower.isle#L2773-L2805">here</a>. I guess my only concern is whether the "forced duplicate comparisons" will become a performance issue — can you do a sightglass run of a few benchmarks and post it here? (I wonder, and feel free to say "no," whether it might be helpful to add an x64 ISA test to show (and lock in) that <code>br</code> using an <code>icmp</code> will in fact result in only two instructions and not materialize the comparison result?).</p>
</blockquote>
<p>I'll run sightglass benchmarks for this branch, and also add the test to verify that we're not materializing the comparison result. Thanks!</p>
</blockquote>



<a name="305909958"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235097%20Remove%20redundant%20branch%20and%20select.../near/305909958" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235097.20Remove.20redundant.20branch.20and.20select.2E.2E.2E.html#305909958">(Oct 24 2022 at 20:37)</a>:</h4>
<p>elliottt <a href="https://github.com/bytecodealliance/wasmtime/pull/5097#issuecomment-1289584889">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5097">issue #5097</a>:</p>
<blockquote>
<p>@abrown I ran sightglass benchmarks on a dedicated machine, and  detected no change between this branch and main. At the time I ran this benchmark, 85f864d95e2836dbf0fbfc339a0bd1d2f96e883e was the head of this branch.</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">sightglass</span><span class="o">-</span><span class="n">cli</span><span class="w"> </span><span class="n">benchmark</span><span class="w"> </span><span class="n">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="err">\</span><span class="w"></span>
<span class="w">  </span><span class="o">--</span><span class="n">engine</span><span class="w"> </span><span class="o">../</span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="err">\</span><span class="w"></span>
<span class="w">  </span><span class="o">--</span><span class="n">engine</span><span class="w"> </span><span class="o">../</span><span class="mi">85</span><span class="n">f864d95e2836dbf0fbfc339a0bd1d2f96e883e</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="err">\</span><span class="w"></span>
<span class="w">  </span><span class="o">--</span><span class="n">iterations</span><span class="o">-</span><span class="n">per</span><span class="o">-</span><span class="n">process</span><span class="o">=</span><span class="mi">100</span><span class="w"> </span><span class="err">\</span><span class="w"></span>
<span class="w">  </span><span class="o">--</span><span class="n">processes</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>

<span class="n">instantiation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>

<span class="w">  </span><span class="n">No</span><span class="w"> </span><span class="n">difference</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">performance</span><span class="p">.</span><span class="w"></span>

<span class="w">  </span><span class="p">[</span><span class="mi">120656</span><span class="w"> </span><span class="mf">189764.02</span><span class="w"> </span><span class="mi">320940</span><span class="p">]</span><span class="w"> </span><span class="mi">85</span><span class="n">f864d95e2836dbf0fbfc339a0bd1d2f96e883e</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">123442</span><span class="w"> </span><span class="mf">198471.42</span><span class="w"> </span><span class="mi">317082</span><span class="p">]</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="w"></span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>

<span class="w">  </span><span class="n">No</span><span class="w"> </span><span class="n">difference</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">performance</span><span class="p">.</span><span class="w"></span>

<span class="w">  </span><span class="p">[</span><span class="mi">223741976</span><span class="w"> </span><span class="mf">367702912.90</span><span class="w"> </span><span class="mi">592279790</span><span class="p">]</span><span class="w"> </span><span class="mi">85</span><span class="n">f864d95e2836dbf0fbfc339a0bd1d2f96e883e</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">220267650</span><span class="w"> </span><span class="mf">361527444.68</span><span class="w"> </span><span class="mi">508238136</span><span class="p">]</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="w"></span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>

<span class="w">  </span><span class="n">No</span><span class="w"> </span><span class="n">difference</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">performance</span><span class="p">.</span><span class="w"></span>

<span class="w">  </span><span class="p">[</span><span class="mi">130806336</span><span class="w"> </span><span class="mf">193406633.08</span><span class="w"> </span><span class="mi">232802798</span><span class="p">]</span><span class="w"> </span><span class="mi">85</span><span class="n">f864d95e2836dbf0fbfc339a0bd1d2f96e883e</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">130420804</span><span class="w"> </span><span class="mf">192605053.70</span><span class="w"> </span><span class="mi">231372888</span><span class="p">]</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="w"></span>


<span class="cp">$</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">sightglass</span><span class="o">-</span><span class="n">cli</span><span class="w"> </span><span class="n">benchmark</span><span class="w"> </span><span class="n">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="err">\</span><span class="w"></span>
<span class="w">  </span><span class="o">--</span><span class="n">engine</span><span class="w"> </span><span class="o">../</span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="err">\</span><span class="w"></span>
<span class="w">  </span><span class="o">--</span><span class="n">engine</span><span class="w"> </span><span class="o">../</span><span class="mi">85</span><span class="n">f864d95e2836dbf0fbfc339a0bd1d2f96e883e</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="err">\</span><span class="w"></span>
<span class="w">  </span><span class="o">--</span><span class="n">iterations</span><span class="o">-</span><span class="n">per</span><span class="o">-</span><span class="n">process</span><span class="o">=</span><span class="mi">10</span><span class="w"> </span><span class="err">\</span><span class="w"></span>
<span class="w">  </span><span class="o">--</span><span class="n">processes</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>

<span class="w">  </span><span class="n">No</span><span class="w"> </span><span class="n">difference</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">performance</span><span class="p">.</span><span class="w"></span>

<span class="w">  </span><span class="p">[</span><span class="mi">1410446964</span><span class="w"> </span><span class="mf">2020809040.60</span><span class="w"> </span><span class="mi">2306033394</span><span class="p">]</span><span class="w"> </span><span class="mi">85</span><span class="n">f864d95e2836dbf0fbfc339a0bd1d2f96e883e</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">1359735690</span><span class="w"> </span><span class="mf">2191588531.20</span><span class="w"> </span><span class="mi">2308222376</span><span class="p">]</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="w"></span>

<span class="n">instantiation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>

<span class="w">  </span><span class="n">No</span><span class="w"> </span><span class="n">difference</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">performance</span><span class="p">.</span><span class="w"></span>

<span class="w">  </span><span class="p">[</span><span class="mi">611792</span><span class="w"> </span><span class="mf">859291.40</span><span class="w"> </span><span class="mi">951768</span><span class="p">]</span><span class="w"> </span><span class="mi">85</span><span class="n">f864d95e2836dbf0fbfc339a0bd1d2f96e883e</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">597436</span><span class="w"> </span><span class="mf">820546.20</span><span class="w"> </span><span class="mi">932754</span><span class="p">]</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="w"></span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>

<span class="w">  </span><span class="n">No</span><span class="w"> </span><span class="n">difference</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">performance</span><span class="p">.</span><span class="w"></span>

<span class="w">  </span><span class="p">[</span><span class="mi">9393256300</span><span class="w"> </span><span class="mf">9918239033.80</span><span class="w"> </span><span class="mi">10205566518</span><span class="p">]</span><span class="w"> </span><span class="mi">85</span><span class="n">f864d95e2836dbf0fbfc339a0bd1d2f96e883e</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">8561503454</span><span class="w"> </span><span class="mf">9716444659.00</span><span class="w"> </span><span class="mi">10357871886</span><span class="p">]</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>