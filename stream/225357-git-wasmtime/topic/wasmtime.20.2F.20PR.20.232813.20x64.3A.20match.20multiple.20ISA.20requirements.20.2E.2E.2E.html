<html>
<head><meta charset="utf-8"><title>wasmtime / PR #2813 x64: match multiple ISA requirements ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232813.20x64.3A.20match.20multiple.20ISA.20requirements.20.2E.2E.2E.html">wasmtime / PR #2813 x64: match multiple ISA requirements ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="233576934"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232813%20x64%3A%20match%20multiple%20ISA%20requirements%20.../near/233576934" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232813.20x64.3A.20match.20multiple.20ISA.20requirements.20.2E.2E.2E.html#233576934">(Apr 07 2021 at 23:06)</a>:</h4>
<p>abrown opened <a href="https://github.com/bytecodealliance/wasmtime/pull/2813">PR #2813</a> from <code>inst-format-2</code> to <code>main</code>:</p>
<blockquote>
<p>Because there are instructions that are present in more than one ISA feature set, we need to see if any of them match before emitting. This change includes the <code>VPABSQ</code> instruction as an example, which is present in both <code>AVX512F</code> and <code>AVX512VL</code>.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="233576979"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232813%20x64%3A%20match%20multiple%20ISA%20requirements%20.../near/233576979" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232813.20x64.3A.20match.20multiple.20ISA.20requirements.20.2E.2E.2E.html#233576979">(Apr 07 2021 at 23:06)</a>:</h4>
<p><strong>abrown</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/2813">PR #2813</a>.</p>



<a name="233576981"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232813%20x64%3A%20match%20multiple%20ISA%20requirements%20.../near/233576981" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232813.20x64.3A.20match.20multiple.20ISA.20requirements.20.2E.2E.2E.html#233576981">(Apr 07 2021 at 23:06)</a>:</h4>
<p><strong>abrown</strong> requested <a href="https://github.com/cfallin">cfallin</a> and <a href="https://github.com/bnjbvr">bnjbvr</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/2813">PR #2813</a>.</p>



<a name="233577075"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232813%20x64%3A%20match%20multiple%20ISA%20requirements%20.../near/233577075" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232813.20x64.3A.20match.20multiple.20ISA.20requirements.20.2E.2E.2E.html#233577075">(Apr 07 2021 at 23:07)</a>:</h4>
<p>abrown edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2813">PR #2813</a> from <code>inst-format-2</code> to <code>main</code>:</p>
<blockquote>
<p>Because there are instructions that are present in more than one ISA feature set, we need to see if any of the ISA requirements match before emitting. This change includes the <code>VPABSQ</code> instruction as an example, which is present in both <code>AVX512F</code> and <code>AVX512VL</code>.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="233577234"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232813%20x64%3A%20match%20multiple%20ISA%20requirements%20.../near/233577234" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232813.20x64.3A.20match.20multiple.20ISA.20requirements.20.2E.2E.2E.html#233577234">(Apr 07 2021 at 23:09)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2813">PR #2813</a> from <code>inst-format-2</code> to <code>main</code>.</p>



<a name="233578968"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232813%20x64%3A%20match%20multiple%20ISA%20requirements%20.../near/233578968" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232813.20x64.3A.20match.20multiple.20ISA.20requirements.20.2E.2E.2E.html#233578968">(Apr 07 2021 at 23:29)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2813#pullrequestreview-630807112">PR Review</a>.</p>



<a name="233578969"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232813%20x64%3A%20match%20multiple%20ISA%20requirements%20.../near/233578969" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232813.20x64.3A.20match.20multiple.20ISA.20requirements.20.2E.2E.2E.html#233578969">(Apr 07 2021 at 23:29)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2813#pullrequestreview-630807112">PR Review</a>.</p>



<a name="233578970"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232813%20x64%3A%20match%20multiple%20ISA%20requirements%20.../near/233578970" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232813.20x64.3A.20match.20multiple.20ISA.20requirements.20.2E.2E.2E.html#233578970">(Apr 07 2021 at 23:29)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2813#discussion_r609138258">PR Review Comment</a>:</p>
<blockquote>
<p>Perhaps we could rename this to something like <code>present_in_isas()</code>? The <code>OR</code> semantics weren't immediately clear to me from the name until I read the code around the callsite above; otherwise I would have expected <code>AND</code>.</p>
</blockquote>



<a name="233615074"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232813%20x64%3A%20match%20multiple%20ISA%20requirements%20.../near/233615074" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232813.20x64.3A.20match.20multiple.20ISA.20requirements.20.2E.2E.2E.html#233615074">(Apr 08 2021 at 07:49)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2813#pullrequestreview-631060618">PR Review</a>.</p>



<a name="233615075"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232813%20x64%3A%20match%20multiple%20ISA%20requirements%20.../near/233615075" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232813.20x64.3A.20match.20multiple.20ISA.20requirements.20.2E.2E.2E.html#233615075">(Apr 08 2021 at 07:49)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2813#discussion_r609393300">PR Review Comment</a>:</p>
<blockquote>
<p>uber nit: do you mind writing it in the final reduced form, <code>if !isa.is_empty() &amp;&amp; !isa.iter().any(matches_isa_flags)</code>?</p>
</blockquote>



<a name="233615076"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232813%20x64%3A%20match%20multiple%20ISA%20requirements%20.../near/233615076" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232813.20x64.3A.20match.20multiple.20ISA.20requirements.20.2E.2E.2E.html#233615076">(Apr 08 2021 at 07:49)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2813#pullrequestreview-631060618">PR Review</a>.</p>



<a name="233615077"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232813%20x64%3A%20match%20multiple%20ISA%20requirements%20.../near/233615077" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232813.20x64.3A.20match.20multiple.20ISA.20requirements.20.2E.2E.2E.html#233615077">(Apr 08 2021 at 07:49)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2813#discussion_r609413477">PR Review Comment</a>:</p>
<blockquote>
<p>Or how about <code>present_in_any_isa()</code>? (or <code>available_in_any_isa()</code>?) The "any" in the name makes the <code>OR</code> semantics crystal clear in my opinion.</p>
<p>Also nit: considering a <code>SmallVec&lt;[T; 1]&gt;</code> will cause a heap allocation for the second element, and we only have the cases for 1 and 2 elements, could this return <code>SmallVec&lt;[T; 2]&gt;</code> (or 4; an initial <code>Vec</code> push will reserve capacity for 4 elements)?</p>
</blockquote>



<a name="233679321"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232813%20x64%3A%20match%20multiple%20ISA%20requirements%20.../near/233679321" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232813.20x64.3A.20match.20multiple.20ISA.20requirements.20.2E.2E.2E.html#233679321">(Apr 08 2021 at 15:56)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2813">PR #2813</a> from <code>inst-format-2</code> to <code>main</code>.</p>



<a name="233679404"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232813%20x64%3A%20match%20multiple%20ISA%20requirements%20.../near/233679404" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232813.20x64.3A.20match.20multiple.20ISA.20requirements.20.2E.2E.2E.html#233679404">(Apr 08 2021 at 15:57)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2813">PR #2813</a> from <code>inst-format-2</code> to <code>main</code>.</p>



<a name="233679707"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232813%20x64%3A%20match%20multiple%20ISA%20requirements%20.../near/233679707" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232813.20x64.3A.20match.20multiple.20ISA.20requirements.20.2E.2E.2E.html#233679707">(Apr 08 2021 at 15:59)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2813#pullrequestreview-631574430">PR Review</a>.</p>



<a name="233679708"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232813%20x64%3A%20match%20multiple%20ISA%20requirements%20.../near/233679708" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232813.20x64.3A.20match.20multiple.20ISA.20requirements.20.2E.2E.2E.html#233679708">(Apr 08 2021 at 15:59)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/2813#discussion_r609854130">PR Review Comment</a>:</p>
<blockquote>
<p>Went with <code>available_in_any_isa</code>, added some documentation to that function, and updated to use <code>SmallVec&lt;[T; 2]&gt;</code>.</p>
</blockquote>



<a name="233694940"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232813%20x64%3A%20match%20multiple%20ISA%20requirements%20.../near/233694940" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232813.20x64.3A.20match.20multiple.20ISA.20requirements.20.2E.2E.2E.html#233694940">(Apr 08 2021 at 17:30)</a>:</h4>
<p>abrown merged <a href="https://github.com/bytecodealliance/wasmtime/pull/2813">PR #2813</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>