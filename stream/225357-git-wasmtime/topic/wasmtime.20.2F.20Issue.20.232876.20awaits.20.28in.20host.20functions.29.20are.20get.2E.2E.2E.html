<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #2876 awaits (in host functions) are get... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232876.20awaits.20.28in.20host.20functions.29.20are.20get.2E.2E.2E.html">wasmtime / Issue #2876 awaits (in host functions) are get...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="237558639"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232876%20awaits%20%28in%20host%20functions%29%20are%20get.../near/237558639" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232876.20awaits.20.28in.20host.20functions.29.20are.20get.2E.2E.2E.html#237558639">(May 05 2021 at 20:17)</a>:</h4>
<p>venugopv labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/2876">Issue #2876</a>:</p>
<blockquote>
<p>In async wasmtime (using tokio runtime)+block_on usage:  awaits from host functions are getting stuck.  First instances of await are working fine. After few instances, await is getting stuck without returning any thing.</p>
<p>In the following test case, the first 128 awaits are returned properly, and the next await got stuck infinitely. </p>
<p>We are using block_on to complete futures for instantiate_async and call_async. Without block_on, all awaits are getting executed normal. </p>
<h3>Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">anyhow</span>::<span class="nb">Result</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">futures</span>::<span class="n">executor</span>::<span class="n">block_on</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">future</span>::<span class="n">Future</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">time</span>::<span class="p">{</span><span class="n">sleep</span><span class="p">,</span><span class="w"> </span><span class="n">Duration</span><span class="p">};</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>

<span class="k">type</span> <span class="nc">AsyncWasmResult</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Trap</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="cp">#[tokio::main]</span><span class="w"></span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">conf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">conf</span><span class="p">.</span><span class="n">async_support</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">conf</span><span class="p">.</span><span class="n">wrap1_host_func_async</span><span class="p">(</span><span class="s">"test"</span><span class="p">,</span><span class="w"> </span><span class="s">"host_hello"</span><span class="p">,</span><span class="w"> </span><span class="n">host_hello</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">Engine</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// All wasm objects operate within the context of a "store"</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Modules can be compiled through either the text or binary format</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="err">#</span><span class="s">"</span>
<span class="s">        (module</span>
<span class="s">            (import "</span><span class="n">test</span><span class="s">" "</span><span class="n">host_hello</span><span class="s">" (func $host_hello (param i32)))</span>

<span class="s">            (func (export "</span><span class="n">hello</span><span class="s">")</span>
<span class="s">                i32.const 3</span>
<span class="s">                call $host_hello)</span>
<span class="s">        )</span>
<span class="s">    "</span><span class="err">#</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">wat</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Host functions can be defined which take/return wasm values and</span>
<span class="w">    </span><span class="c1">// execute arbitrary code on the host.</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">host_hello</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_caller</span>: <span class="nc">Caller</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">param</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">AsyncWasmResult</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">..</span><span class="mi">1000</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_millis</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="k">await</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="fm">println!</span><span class="p">(</span><span class="s">"100 ms have elapsed -- {}"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Got {} from WebAssembly"</span><span class="p">,</span><span class="w"> </span><span class="n">param</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"></span>
<span class="w">        </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">block_on</span><span class="p">(</span><span class="n">linker</span><span class="p">.</span><span class="n">instantiate_async</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">block_on</span><span class="p">(</span><span class="n">instance</span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="s">"hello"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">().</span><span class="n">call_async</span><span class="p">(</span><span class="o">&amp;</span><span class="fm">vec!</span><span class="p">[]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="fm">println!</span><span class="p">(</span><span class="s">"success"</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">err_string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">to_string</span><span class="p">();</span><span class="w"></span>
<span class="w">                </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">err_string</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">err_string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">to_string</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">err_string</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p>run the above code. Host function get stuck after sleep instances, waiting infinity on await.<br>
We have used cargo to run i.e 'cargo run'</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">[</span><span class="n">package</span><span class="p">]</span><span class="w"></span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"wasmtime-test"</span><span class="w"></span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="w"></span>
<span class="n">authors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"wsamtimetest"</span><span class="p">]</span><span class="w"></span>
<span class="n">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"2018"</span><span class="w"></span>

<span class="p">[</span><span class="n">dependencies</span><span class="p">]</span><span class="w"></span>
<span class="n">wasmtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"0.26.0"</span><span class="w"></span>
<span class="n">tokio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"1"</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"full"</span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="n">anyhow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"1.0.39"</span><span class="w"></span>
<span class="n">futures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"0.3.13"</span><span class="w"> </span><span class="err">`</span><span class="w"></span>
</code></pre></div>
<h3>Expected Results</h3>
<p>Even with block_on usage, awaits should work normally.</p>
<h3>Actual Results</h3>
<p>Awaits are getting stuck with block_on usage.</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 0.26<br>
Operating system: Mac<br>
Architecture: x86_64</p>
<h3>Extra Info</h3>
</blockquote>



<a name="237558640"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232876%20awaits%20%28in%20host%20functions%29%20are%20get.../near/237558640" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232876.20awaits.20.28in.20host.20functions.29.20are.20get.2E.2E.2E.html#237558640">(May 05 2021 at 20:17)</a>:</h4>
<p>venugopv opened <a href="https://github.com/bytecodealliance/wasmtime/issues/2876">Issue #2876</a>:</p>
<blockquote>
<p>In async wasmtime (using tokio runtime)+block_on usage:  awaits from host functions are getting stuck.  First instances of await are working fine. After few instances, await is getting stuck without returning any thing.</p>
<p>In the following test case, the first 128 awaits are returned properly, and the next await got stuck infinitely. </p>
<p>We are using block_on to complete futures for instantiate_async and call_async. Without block_on, all awaits are getting executed normal. </p>
<h3>Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">anyhow</span>::<span class="nb">Result</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">futures</span>::<span class="n">executor</span>::<span class="n">block_on</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">future</span>::<span class="n">Future</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">time</span>::<span class="p">{</span><span class="n">sleep</span><span class="p">,</span><span class="w"> </span><span class="n">Duration</span><span class="p">};</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>

<span class="k">type</span> <span class="nc">AsyncWasmResult</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Trap</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="cp">#[tokio::main]</span><span class="w"></span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">conf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">conf</span><span class="p">.</span><span class="n">async_support</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">conf</span><span class="p">.</span><span class="n">wrap1_host_func_async</span><span class="p">(</span><span class="s">"test"</span><span class="p">,</span><span class="w"> </span><span class="s">"host_hello"</span><span class="p">,</span><span class="w"> </span><span class="n">host_hello</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">Engine</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// All wasm objects operate within the context of a "store"</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Modules can be compiled through either the text or binary format</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="err">#</span><span class="s">"</span>
<span class="s">        (module</span>
<span class="s">            (import "</span><span class="n">test</span><span class="s">" "</span><span class="n">host_hello</span><span class="s">" (func $host_hello (param i32)))</span>

<span class="s">            (func (export "</span><span class="n">hello</span><span class="s">")</span>
<span class="s">                i32.const 3</span>
<span class="s">                call $host_hello)</span>
<span class="s">        )</span>
<span class="s">    "</span><span class="err">#</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">wat</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Host functions can be defined which take/return wasm values and</span>
<span class="w">    </span><span class="c1">// execute arbitrary code on the host.</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">host_hello</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_caller</span>: <span class="nc">Caller</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">param</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">AsyncWasmResult</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">..</span><span class="mi">1000</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_millis</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="k">await</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="fm">println!</span><span class="p">(</span><span class="s">"100 ms have elapsed -- {}"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Got {} from WebAssembly"</span><span class="p">,</span><span class="w"> </span><span class="n">param</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"></span>
<span class="w">        </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">block_on</span><span class="p">(</span><span class="n">linker</span><span class="p">.</span><span class="n">instantiate_async</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">block_on</span><span class="p">(</span><span class="n">instance</span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="s">"hello"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">().</span><span class="n">call_async</span><span class="p">(</span><span class="o">&amp;</span><span class="fm">vec!</span><span class="p">[]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="fm">println!</span><span class="p">(</span><span class="s">"success"</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">err_string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">to_string</span><span class="p">();</span><span class="w"></span>
<span class="w">                </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">err_string</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">err_string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">to_string</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">err_string</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p>run the above code. Host function get stuck after sleep instances, waiting infinity on await.<br>
We have used cargo to run i.e 'cargo run'</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">[</span><span class="n">package</span><span class="p">]</span><span class="w"></span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"wasmtime-test"</span><span class="w"></span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="w"></span>
<span class="n">authors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"wsamtimetest"</span><span class="p">]</span><span class="w"></span>
<span class="n">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"2018"</span><span class="w"></span>

<span class="p">[</span><span class="n">dependencies</span><span class="p">]</span><span class="w"></span>
<span class="n">wasmtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"0.26.0"</span><span class="w"></span>
<span class="n">tokio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"1"</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"full"</span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="n">anyhow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"1.0.39"</span><span class="w"></span>
<span class="n">futures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"0.3.13"</span><span class="w"> </span><span class="err">`</span><span class="w"></span>
</code></pre></div>
<h3>Expected Results</h3>
<p>Even with block_on usage, awaits should work normally.</p>
<h3>Actual Results</h3>
<p>Awaits are getting stuck with block_on usage.</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 0.26<br>
Operating system: Mac<br>
Architecture: x86_64</p>
<h3>Extra Info</h3>
</blockquote>



<a name="237561219"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232876%20awaits%20%28in%20host%20functions%29%20are%20get.../near/237561219" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232876.20awaits.20.28in.20host.20functions.29.20are.20get.2E.2E.2E.html#237561219">(May 05 2021 at 20:37)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/2876#issuecomment-832990547">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2876">Issue #2876</a>:</p>
<blockquote>
<p>You are using a tokio timer, but futures exector (block_on). This is not allowed. Tokio requires you to use tokio's executor. As you are using <code>#[tokio::main]</code> using <code>.await</code> instead of <code>block_on</code> inside <code>main</code> should work.</p>
</blockquote>



<a name="237561819"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232876%20awaits%20%28in%20host%20functions%29%20are%20get.../near/237561819" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232876.20awaits.20.28in.20host.20functions.29.20are.20get.2E.2E.2E.html#237561819">(May 05 2021 at 20:41)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/2876#issuecomment-832992957">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2876">Issue #2876</a>:</p>
<blockquote>
<p>@venugopv I believe @bjorn3 is correct regarding the need to use tokio's executor in your repro (<code>tokio::main</code> is wrapping your main function in a <code>block_on</code> anyway, so just <code>.await</code> inside it).</p>
<p>As such I'm closing this issue.  Please reopen if you think there's something Wasmtime needs to fix or if @bjorn3's suggestion doesn't help you.  Thank you!</p>
</blockquote>



<a name="237561821"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232876%20awaits%20%28in%20host%20functions%29%20are%20get.../near/237561821" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232876.20awaits.20.28in.20host.20functions.29.20are.20get.2E.2E.2E.html#237561821">(May 05 2021 at 20:41)</a>:</h4>
<p>peterhuene closed <a href="https://github.com/bytecodealliance/wasmtime/issues/2876">Issue #2876</a>:</p>
<blockquote>
<p>In async wasmtime (using tokio runtime)+block_on usage:  awaits from host functions are getting stuck.  First instances of await are working fine. After few instances, await is getting stuck without returning any thing.</p>
<p>In the following test case, the first 128 awaits are returned properly, and the next await got stuck infinitely. </p>
<p>We are using block_on to complete futures for instantiate_async and call_async. Without block_on, all awaits are getting executed normal. </p>
<h3>Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">anyhow</span>::<span class="nb">Result</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">futures</span>::<span class="n">executor</span>::<span class="n">block_on</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">future</span>::<span class="n">Future</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">time</span>::<span class="p">{</span><span class="n">sleep</span><span class="p">,</span><span class="w"> </span><span class="n">Duration</span><span class="p">};</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>

<span class="k">type</span> <span class="nc">AsyncWasmResult</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Trap</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="cp">#[tokio::main]</span><span class="w"></span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">conf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">conf</span><span class="p">.</span><span class="n">async_support</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">conf</span><span class="p">.</span><span class="n">wrap1_host_func_async</span><span class="p">(</span><span class="s">"test"</span><span class="p">,</span><span class="w"> </span><span class="s">"host_hello"</span><span class="p">,</span><span class="w"> </span><span class="n">host_hello</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">Engine</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// All wasm objects operate within the context of a "store"</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Modules can be compiled through either the text or binary format</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="err">#</span><span class="s">"</span>
<span class="s">        (module</span>
<span class="s">            (import "</span><span class="n">test</span><span class="s">" "</span><span class="n">host_hello</span><span class="s">" (func $host_hello (param i32)))</span>

<span class="s">            (func (export "</span><span class="n">hello</span><span class="s">")</span>
<span class="s">                i32.const 3</span>
<span class="s">                call $host_hello)</span>
<span class="s">        )</span>
<span class="s">    "</span><span class="err">#</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">wat</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Host functions can be defined which take/return wasm values and</span>
<span class="w">    </span><span class="c1">// execute arbitrary code on the host.</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">host_hello</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_caller</span>: <span class="nc">Caller</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">param</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">AsyncWasmResult</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">..</span><span class="mi">1000</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_millis</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="k">await</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="fm">println!</span><span class="p">(</span><span class="s">"100 ms have elapsed -- {}"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Got {} from WebAssembly"</span><span class="p">,</span><span class="w"> </span><span class="n">param</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"></span>
<span class="w">        </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">block_on</span><span class="p">(</span><span class="n">linker</span><span class="p">.</span><span class="n">instantiate_async</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">block_on</span><span class="p">(</span><span class="n">instance</span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="s">"hello"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">().</span><span class="n">call_async</span><span class="p">(</span><span class="o">&amp;</span><span class="fm">vec!</span><span class="p">[]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="fm">println!</span><span class="p">(</span><span class="s">"success"</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">err_string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">to_string</span><span class="p">();</span><span class="w"></span>
<span class="w">                </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">err_string</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">err_string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">to_string</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">err_string</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p>run the above code. Host function get stuck after sleep instances, waiting infinity on await.<br>
We have used cargo to run i.e 'cargo run'</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">[</span><span class="n">package</span><span class="p">]</span><span class="w"></span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"wasmtime-test"</span><span class="w"></span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="w"></span>
<span class="n">authors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"wsamtimetest"</span><span class="p">]</span><span class="w"></span>
<span class="n">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"2018"</span><span class="w"></span>

<span class="p">[</span><span class="n">dependencies</span><span class="p">]</span><span class="w"></span>
<span class="n">wasmtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"0.26.0"</span><span class="w"></span>
<span class="n">tokio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"1"</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"full"</span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="n">anyhow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"1.0.39"</span><span class="w"></span>
<span class="n">futures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"0.3.13"</span><span class="w"> </span><span class="err">`</span><span class="w"></span>
</code></pre></div>
<h3>Expected Results</h3>
<p>Even with block_on usage, awaits should work normally.</p>
<h3>Actual Results</h3>
<p>Awaits are getting stuck with block_on usage.</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 0.26<br>
Operating system: Mac<br>
Architecture: x86_64</p>
<h3>Extra Info</h3>
</blockquote>



<a name="237562064"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232876%20awaits%20%28in%20host%20functions%29%20are%20get.../near/237562064" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232876.20awaits.20.28in.20host.20functions.29.20are.20get.2E.2E.2E.html#237562064">(May 05 2021 at 20:43)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/2876#issuecomment-832992957">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2876">Issue #2876</a>:</p>
<blockquote>
<p>@venugopv I believe @bjorn3 is correct regarding the need to use tokio's executor in your repro (<code>tokio::main</code> is wrapping your main function in a <code>block_on</code> for tokio's executor anyway, so just <code>.await</code> inside it).</p>
<p>As such I'm closing this issue.  Please reopen if you think there's something Wasmtime needs to fix or if @bjorn3's suggestion doesn't help you.  Thank you!</p>
</blockquote>



<a name="237574360"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232876%20awaits%20%28in%20host%20functions%29%20are%20get.../near/237574360" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232876.20awaits.20.28in.20host.20functions.29.20are.20get.2E.2E.2E.html#237574360">(May 05 2021 at 21:56)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/issues/2876#issuecomment-833058644">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2876">Issue #2876</a>:</p>
<blockquote>
<p>see also: #2832, which includes an example of using wasmtime on tokio.</p>
</blockquote>



<a name="237711958"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232876%20awaits%20%28in%20host%20functions%29%20are%20get.../near/237711958" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232876.20awaits.20.28in.20host.20functions.29.20are.20get.2E.2E.2E.html#237711958">(May 06 2021 at 19:02)</a>:</h4>
<p>venugopv <a href="https://github.com/bytecodealliance/wasmtime/issues/2876#issuecomment-833784458">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2876">Issue #2876</a>:</p>
<blockquote>
<p>@bjorn3 @peterhuene Thanks for your quick response. We are trying to refactor our code to remove block_on and model based on tokio example #2832. <br>
However I am curious to know the limit of 128 awaits for block_on i.e when wasmtime async function(i.e call_async) is called with block_on, exactly 128 awaits are working in host async functions. Subsequent await is getting stuck. It would be great to know from where this 128 limit is coming from.<br>
</p>
</blockquote>



<a name="237713066"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232876%20awaits%20%28in%20host%20functions%29%20are%20get.../near/237713066" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232876.20awaits.20.28in.20host.20functions.29.20are.20get.2E.2E.2E.html#237713066">(May 06 2021 at 19:09)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/2876#issuecomment-833789199">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2876">Issue #2876</a>:</p>
<blockquote>
<p>I searched for 128 in the tokio source. I found the following thing that could be the origin: <a href="https://github.com/tokio-rs/tokio/blob/b42f21ec3e212ace25331d0c13889a45769e6006/tokio/src/coop.rs#L55">https://github.com/tokio-rs/tokio/blob/b42f21ec3e212ace25331d0c13889a45769e6006/tokio/src/coop.rs#L55</a></p>
</blockquote>



<a name="237713227"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232876%20awaits%20%28in%20host%20functions%29%20are%20get.../near/237713227" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232876.20awaits.20.28in.20host.20functions.29.20are.20get.2E.2E.2E.html#237713227">(May 06 2021 at 19:10)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/2876#issuecomment-833789721">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2876">Issue #2876</a>:</p>
<blockquote>
<p>There's also some additional context in <a href="https://github.com/rust-lang/futures-rs/issues/2157">https://github.com/rust-lang/futures-rs/issues/2157</a> that seems related to hitting this coop limit when using a tokio timer without yielding back to the tokio executor.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>