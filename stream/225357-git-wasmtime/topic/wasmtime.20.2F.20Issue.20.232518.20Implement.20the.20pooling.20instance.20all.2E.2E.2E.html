<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #2518 Implement the pooling instance all... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232518.20Implement.20the.20pooling.20instance.20all.2E.2E.2E.html">wasmtime / Issue #2518 Implement the pooling instance all...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="220214620"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232518%20Implement%20the%20pooling%20instance%20all.../near/220214620" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232518.20Implement.20the.20pooling.20instance.20all.2E.2E.2E.html#220214620">(Dec 17 2020 at 07:45)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/pull/2518#issuecomment-747272359">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2518">Issue #2518</a>:</p>
<blockquote>
<p>Hmm, <code>MADV_DONTNEED</code> may not be implemented for <code>aarch64</code>.  I'll look into this soon.</p>
</blockquote>



<a name="220214667"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232518%20Implement%20the%20pooling%20instance%20all.../near/220214667" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232518.20Implement.20the.20pooling.20instance.20all.2E.2E.2E.html#220214667">(Dec 17 2020 at 07:46)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/2518#issuecomment-747272359">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2518">Issue #2518</a>:</p>
<blockquote>
<p>Hmm, <code>MADV_DONTNEED</code> may not be implemented for <code>aarch64</code>.  I'll look into the test failure soon.</p>
</blockquote>



<a name="220214684"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232518%20Implement%20the%20pooling%20instance%20all.../near/220214684" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232518.20Implement.20the.20pooling.20instance.20all.2E.2E.2E.html#220214684">(Dec 17 2020 at 07:46)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/2518#issuecomment-747272359">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2518">Issue #2518</a>:</p>
<blockquote>
<p>Hmm, <code>MADV_DONTNEED</code> may not be implemented for <code>aarch64-linux</code>.  I'll look into the test failure soon.</p>
</blockquote>



<a name="220214698"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232518%20Implement%20the%20pooling%20instance%20all.../near/220214698" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232518.20Implement.20the.20pooling.20instance.20all.2E.2E.2E.html#220214698">(Dec 17 2020 at 07:47)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/2518#issuecomment-747272839">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2518">Issue #2518</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @peterhuene</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "cranelift:wasm", "wasmtime:api"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>peterhuene: wasmtime:api</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="220215678"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232518%20Implement%20the%20pooling%20instance%20all.../near/220215678" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232518.20Implement.20the.20pooling.20instance.20all.2E.2E.2E.html#220215678">(Dec 17 2020 at 08:04)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/2518#issuecomment-747280133">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2518">Issue #2518</a>:</p>
<blockquote>
<blockquote>
<p>Hmm, <code>MADV_DONTNEED</code> may not be implemented for <code>aarch64-linux</code>. I'll look into the test failure soon.</p>
</blockquote>
<p>The aarch64 tests run on qemu, which has this lovely bit of implementation in its syscall implementation (<a href="https://github.com/qemu/qemu/blob/af3f37319cb1e1ca0c42842ecdbd1bcfc64a4b6f/linux-user/syscall.c#L11773-L11779">link</a>):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="n">case</span><span class="w"> </span><span class="n">TARGET_NR_madvise</span>:
        <span class="cm">/* A straight passthrough may not be safe because qemu sometimes</span>
<span class="cm">           turns private file-backed mappings into anonymous mappings.</span>
<span class="cm">           This will break MADV_DONTNEED.</span>
<span class="cm">           This is a hint, so ignoring and returning success is ok.  */</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>At some point we'd ideally run our tests on real hardware, but for now I suspect the best option would just be to disable the unit test and anything that depends on the zeroing semantics. (Or maybe a feature flag to eplicitly memset/bzero instead? That's bad if it was only sparsely committed though...)</p>
</blockquote>



<a name="220215689"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232518%20Implement%20the%20pooling%20instance%20all.../near/220215689" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232518.20Implement.20the.20pooling.20instance.20all.2E.2E.2E.html#220215689">(Dec 17 2020 at 08:04)</a>:</h4>
<p>cfallin edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/2518#issuecomment-747280133">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2518">Issue #2518</a>:</p>
<blockquote>
<blockquote>
<p>Hmm, <code>MADV_DONTNEED</code> may not be implemented for <code>aarch64-linux</code>. I'll look into the test failure soon.</p>
</blockquote>
<p>The aarch64 tests run on qemu, which has this lovely bit of implementation in its syscall handling (<a href="https://github.com/qemu/qemu/blob/af3f37319cb1e1ca0c42842ecdbd1bcfc64a4b6f/linux-user/syscall.c#L11773-L11779">link</a>):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="n">case</span><span class="w"> </span><span class="n">TARGET_NR_madvise</span>:
        <span class="cm">/* A straight passthrough may not be safe because qemu sometimes</span>
<span class="cm">           turns private file-backed mappings into anonymous mappings.</span>
<span class="cm">           This will break MADV_DONTNEED.</span>
<span class="cm">           This is a hint, so ignoring and returning success is ok.  */</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>At some point we'd ideally run our tests on real hardware, but for now I suspect the best option would just be to disable the unit test and anything that depends on the zeroing semantics. (Or maybe a feature flag to eplicitly memset/bzero instead? That's bad if it was only sparsely committed though...)</p>
</blockquote>



<a name="220392726"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232518%20Implement%20the%20pooling%20instance%20all.../near/220392726" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232518.20Implement.20the.20pooling.20instance.20all.2E.2E.2E.html#220392726">(Dec 18 2020 at 16:20)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/2518#issuecomment-748185024">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2518">Issue #2518</a>:</p>
<blockquote>
<p>We already <a href="https://github.com/bytecodealliance/wasmtime/blob/4bee07d6f9651a5069463cce05f5036a3c99e468/.github/workflows/main.yml#L426-L428">have a different flag for running in qemu</a> to reduce virtual memory usage overhead since QEMU behaves differently than native processes in that respect, so perhaps that could also be where we configure "hey wasmtime madvise doesn't work as expected"</p>
</blockquote>



<a name="225372412"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232518%20Implement%20the%20pooling%20instance%20all.../near/225372412" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232518.20Implement.20the.20pooling.20instance.20all.2E.2E.2E.html#225372412">(Feb 05 2021 at 23:39)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/2518#issuecomment-774346242">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2518">Issue #2518</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @peterhuene</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "wasmtime:c-api"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>peterhuene: wasmtime:c-api</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="229074155"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232518%20Implement%20the%20pooling%20instance%20all.../near/229074155" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232518.20Implement.20the.20pooling.20instance.20all.2E.2E.2E.html#229074155">(Mar 06 2021 at 07:08)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/pull/2518#issuecomment-791887459">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2518">Issue #2518</a>:</p>
<blockquote>
<p>@alexcrichton I think all of the feedback has now been addressed.  FYI: the commit you stopped your review at was "fix bad merge".</p>
<p>This is also running the wast tests with the pooling allocator (+uffd on linux).</p>
<p>My TODO list following this PR:</p>
<ul>
<li>Investigate fuzzing the pooling allocator</li>
<li>Move the fiber creation into the allocators (#2708)</li>
</ul>
</blockquote>



<a name="229345784"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232518%20Implement%20the%20pooling%20instance%20all.../near/229345784" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232518.20Implement.20the.20pooling.20instance.20all.2E.2E.2E.html#229345784">(Mar 08 2021 at 18:04)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/pull/2518#issuecomment-792956929">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2518">Issue #2518</a>:</p>
<blockquote>
<p>Regarding the page alignment for instances and tables: we don't need it for instances for the pooling allocator, but we do need it for tables because the pooling allocator "decommits" table memory by page and you don't want any page to have elements from multiple tables.</p>
<p>The reason instances are paged-aligned is that this is an artifact from when the pooling allocator had one giant mmap'd region and the memories/tables of the instance came next, so they needed page-alignment back then.</p>
<p>I'll fix the instance pool to not page-align the instances and instead align to <code>Instance</code>'s alignment requirements in a follow-up PR.</p>
<p>Regarding malloc/free for instances and tables, I think there's no inherent reason why they can't be used, but part of the intention of this design was to preallocate both (a desirable thing to do for a service) and as <code>Instance</code> is a magical DST, managing one's own memory mapping is probably the easiest way to accomplish that.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>