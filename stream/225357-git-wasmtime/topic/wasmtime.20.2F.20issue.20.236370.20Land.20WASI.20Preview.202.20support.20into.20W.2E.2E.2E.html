<html>
<head><meta charset="utf-8"><title>wasmtime / issue #6370 Land WASI Preview 2 support into W... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236370.20Land.20WASI.20Preview.202.20support.20into.20W.2E.2E.2E.html">wasmtime / issue #6370 Land WASI Preview 2 support into W...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="357427335"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236370%20Land%20WASI%20Preview%202%20support%20into%20W.../near/357427335" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236370.20Land.20WASI.20Preview.202.20support.20into.20W.2E.2E.2E.html#357427335">(May 11 2023 at 00:33)</a>:</h4>
<p>pchickey opened <a href="https://github.com/bytecodealliance/wasmtime/issues/6370">issue #6370</a>:</p>
<blockquote>
<p>We have been working on a prototype of what WASI Preview 2 support will look like in Wasmtime for 7 months now! <a href="https://github.com/bytecodealliance/preview2-prototyping/">https://github.com/bytecodealliance/preview2-prototyping/</a></p>
<p>The work is not yet totally complete, but I believe that it is mature enough that we should start landing it into this repository, and keep iterating on it here. It was included in the <a href="https://bytecodealliance.org/articles/component-model-tooling-compatibility">March 28 tooling compatibility matrix</a>, but it turns out we skipped compatibility with the wasmtime 8.0 release due to some bindgen changes we needed. I'd like to get everything landed and part of the regular Wasmtime release cycle for 10.0, which will cut at the beginning of June.</p>
<p>Here is my rough plan for how we will land changes. These plans are open to changes so please leave your feedback!</p>
<ol>
<li>[ ] Move the adapter (found at the root of the p2p repo) to <code>crates/wasi-preview1-component-adapter</code>. We will bring its child proc-macro crate <code>byte-array</code>, and the test harness <code>validate</code>, in as well underneath that directory. Add building, validating, and publishing the adapter binary (for both commands and reactors) to the wasmtime repository's CI. Runtime (integration) tests will be added in the subsequent steps.</li>
<li>[ ] Restructure the <code>test-programs</code> crate to support building both modules and components (using the adapter from step 1). Keep all the existing tests of wasi-common (which covers both the cap-std-sync and tokio backends) intact, but refactor like we did in p2p to make the structure of how tests are run driven by hand-written code, rather than packing a ton of magic into the macros. The components will be built, but not actually executed yet.</li>
<li>[ ] Land the contents of preview2-prototyping's <code>wasi-common</code> crate under <code>wasmtime-wasi</code> in the <code>pub mod preview2</code> space, and behind the (enabled by default) <code>preview2</code> cargo feature. Leave this crate's <code>wasi-common</code>, <code>wasi-cap-std-sync</code>, and <code>wasi-tokio</code> crates untouched. They will continue to provide all preview 1 functionality for the moment. The preview 2 functionality will be passing all tests that it does in p2p through the <code>test-programs</code> (at the moment this means poll-oneoff and some trailing slashes behavior is broken), and this PR will port in the other tests from the p2p repo as well.</li>
</ol>
<p>At this point we can say the wasmtime project has preview 2 support! It is, however, behind a different WasiCtx api (with some changes to the builder, and the way to add it to a linker), and is totally separate from the preview 1 support.</p>
<p>The next steps are:</p>
<ol>
<li>[ ] Finish the development work I have planned to straighten out the poll-oneoff / streams / async vs sync embedding design in preview 2, which is currently not passing all its tests. At this point, we can just ignore some trailing slash behavior in the test suite, but the stuff everyone really cares about ought to be done.</li>
<li>[ ] Land @rvolosatovs 's work on a host-side preview 2 wit-bindgen to preview 1 wiggle adapter. Hook this up to the test suite, passing all the same tests as the legacy implementation, without using the <code>wasi-preview1-component-adapter</code> or any component-model features in wasmtime.</li>
<li>[ ] Land preview2-prototyping's <code>wasmtime-wasi-sockets</code> crate into this repository. This crate is separate from, but depends upon, what will land in <code>wasmtime-wasi::preview2</code>. It need to be integrated with the poll oneoff design fixes, and it needs a test suite, in order to land.</li>
<li>[ ] Port the <code>wasmtime-wasi-http</code> crate to use the poll-oneoff fixes above, making it compatible with components instead of just modules</li>
</ol>
<p>Once the poll design changes and host-side adapter are landed, we can start working on transitioning the legacy implementation out of wasmtime:</p>
<ol>
<li>[ ] Move all of <code>wasmtime-wasi</code>'s existing preview 1 support behind <code>pub mod preview1_legacy</code> and the off-by-default <code>preview1_legacy</code> cargo feature. Move the <code>preview2</code> module out to the root. The new host-side adapter interface to provides preview 1 support to all users, except those who have regressions and need to use the legacy support for a limited time.</li>
<li>[ ] The known regressions for preview 2 support include some trailing slash filesystem behaviors, and the support for preview 1's late-added <code>sock_*</code> functions. Presently, the sock functions have no tests in the tree, or anywhere else I can find, so I don't have a way to port those to preview 2 without taking a wild guess at what semantics they need. The only known user of these functions was Enarx, who are no longer in business. If any other users need these sock functions to keep working in either the host or wasm adapter for preview 1, we'll need them to contribute to that support- all of the Bytecode Alliance contributors I have spoke to so far don't have a business case for supporting preview 1's sockets, and instead are all in on preview 2 sockets.</li>
<li>[ ] After 2 releases in off-by-default legacy mode, we will delete the legacy preview 1 code from the repository.</li>
</ol>
</blockquote>



<a name="358592682"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236370%20Land%20WASI%20Preview%202%20support%20into%20W.../near/358592682" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236370.20Land.20WASI.20Preview.202.20support.20into.20W.2E.2E.2E.html#358592682">(May 16 2023 at 00:05)</a>:</h4>
<p>pchickey edited <a href="https://github.com/bytecodealliance/wasmtime/issues/6370">issue #6370</a>:</p>
<blockquote>
<p>We have been working on a prototype of what WASI Preview 2 support will look like in Wasmtime for 7 months now! <a href="https://github.com/bytecodealliance/preview2-prototyping/">https://github.com/bytecodealliance/preview2-prototyping/</a></p>
<p>The work is not yet totally complete, but I believe that it is mature enough that we should start landing it into this repository, and keep iterating on it here. It was included in the <a href="https://bytecodealliance.org/articles/component-model-tooling-compatibility">March 28 tooling compatibility matrix</a>, but it turns out we skipped compatibility with the wasmtime 8.0 release due to some bindgen changes we needed. I'd like to get everything landed and part of the regular Wasmtime release cycle for 10.0, which will cut at the beginning of June.</p>
<p>Here is my rough plan for how we will land changes. These plans are open to changes so please leave your feedback!</p>
<ol>
<li>[x] Move the adapter (found at the root of the p2p repo) to <code>crates/wasi-preview1-component-adapter</code>. We will bring its child proc-macro crate <code>byte-array</code>, and the test harness <code>validate</code>, in as well underneath that directory. Add building, validating, and publishing the adapter binary (for both commands and reactors) to the wasmtime repository's CI. Runtime (integration) tests will be added in the subsequent steps.</li>
<li>[ ] Restructure the <code>test-programs</code> crate to support building both modules and components (using the adapter from step 1). Keep all the existing tests of wasi-common (which covers both the cap-std-sync and tokio backends) intact, but refactor like we did in p2p to make the structure of how tests are run driven by hand-written code, rather than packing a ton of magic into the macros. The components will be built, but not actually executed yet.</li>
<li>[ ] Land the contents of preview2-prototyping's <code>wasi-common</code> crate under <code>wasmtime-wasi</code> in the <code>pub mod preview2</code> space, and behind the (enabled by default) <code>preview2</code> cargo feature. Leave this crate's <code>wasi-common</code>, <code>wasi-cap-std-sync</code>, and <code>wasi-tokio</code> crates untouched. They will continue to provide all preview 1 functionality for the moment. The preview 2 functionality will be passing all tests that it does in p2p through the <code>test-programs</code> (at the moment this means poll-oneoff and some trailing slashes behavior is broken), and this PR will port in the other tests from the p2p repo as well.</li>
</ol>
<p>At this point we can say the wasmtime project has preview 2 support! It is, however, behind a different WasiCtx api (with some changes to the builder, and the way to add it to a linker), and is totally separate from the preview 1 support.</p>
<p>The next steps are:</p>
<ol>
<li>[ ] Finish the development work I have planned to straighten out the poll-oneoff / streams / async vs sync embedding design in preview 2, which is currently not passing all its tests. At this point, we can just ignore some trailing slash behavior in the test suite, but the stuff everyone really cares about ought to be done.</li>
<li>[ ] Land @rvolosatovs 's work on a host-side preview 2 wit-bindgen to preview 1 wiggle adapter. Hook this up to the test suite, passing all the same tests as the legacy implementation, without using the <code>wasi-preview1-component-adapter</code> or any component-model features in wasmtime.</li>
<li>[ ] Land preview2-prototyping's <code>wasmtime-wasi-sockets</code> crate into this repository. This crate is separate from, but depends upon, what will land in <code>wasmtime-wasi::preview2</code>. It need to be integrated with the poll oneoff design fixes, and it needs a test suite, in order to land.</li>
<li>[ ] Port the <code>wasmtime-wasi-http</code> crate to use the poll-oneoff fixes above, making it compatible with components instead of just modules</li>
</ol>
<p>Once the poll design changes and host-side adapter are landed, we can start working on transitioning the legacy implementation out of wasmtime:</p>
<ol>
<li>[ ] Move all of <code>wasmtime-wasi</code>'s existing preview 1 support behind <code>pub mod preview1_legacy</code> and the off-by-default <code>preview1_legacy</code> cargo feature. Move the <code>preview2</code> module out to the root. The new host-side adapter interface to provides preview 1 support to all users, except those who have regressions and need to use the legacy support for a limited time.</li>
<li>[ ] The known regressions for preview 2 support include some trailing slash filesystem behaviors, and the support for preview 1's late-added <code>sock_*</code> functions. Presently, the sock functions have no tests in the tree, or anywhere else I can find, so I don't have a way to port those to preview 2 without taking a wild guess at what semantics they need. The only known user of these functions was Enarx, who are no longer in business. If any other users need these sock functions to keep working in either the host or wasm adapter for preview 1, we'll need them to contribute to that support- all of the Bytecode Alliance contributors I have spoke to so far don't have a business case for supporting preview 1's sockets, and instead are all in on preview 2 sockets.</li>
<li>[ ] After 2 releases in off-by-default legacy mode, we will delete the legacy preview 1 code from the repository.</li>
</ol>
</blockquote>



<a name="359075413"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236370%20Land%20WASI%20Preview%202%20support%20into%20W.../near/359075413" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236370.20Land.20WASI.20Preview.202.20support.20into.20W.2E.2E.2E.html#359075413">(May 17 2023 at 20:24)</a>:</h4>
<p>pchickey edited <a href="https://github.com/bytecodealliance/wasmtime/issues/6370">issue #6370</a>:</p>
<blockquote>
<p>We have been working on a prototype of what WASI Preview 2 support will look like in Wasmtime for 7 months now! <a href="https://github.com/bytecodealliance/preview2-prototyping/">https://github.com/bytecodealliance/preview2-prototyping/</a></p>
<p>The work is not yet totally complete, but I believe that it is mature enough that we should start landing it into this repository, and keep iterating on it here. It was included in the <a href="https://bytecodealliance.org/articles/component-model-tooling-compatibility">March 28 tooling compatibility matrix</a>, but it turns out we skipped compatibility with the wasmtime 8.0 release due to some bindgen changes we needed. I'd like to get everything landed and part of the regular Wasmtime release cycle for 10.0, which will cut at the beginning of June.</p>
<p>Here is my rough plan for how we will land changes. These plans are open to changes so please leave your feedback!</p>
<ol>
<li>[x] Move the adapter (found at the root of the p2p repo) to <code>crates/wasi-preview1-component-adapter</code>. We will bring its child proc-macro crate <code>byte-array</code>, and the test harness <code>validate</code>, in as well underneath that directory. Add building, validating, and publishing the adapter binary (for both commands and reactors) to the wasmtime repository's CI. Runtime (integration) tests will be added in the subsequent steps.</li>
<li>[x] Restructure the <code>test-programs</code> crate to support building both modules and components (using the adapter from step 1). Keep all the existing tests of wasi-common (which covers both the cap-std-sync and tokio backends) intact, but refactor like we did in p2p to make the structure of how tests are run driven by hand-written code, rather than packing a ton of magic into the macros. The components will be built, but not actually executed yet.</li>
<li>[ ] Land the contents of preview2-prototyping's <code>wasi-common</code> crate under <code>wasmtime-wasi</code> in the <code>pub mod preview2</code> space, and behind the (enabled by default) <code>preview2</code> cargo feature. Leave this crate's <code>wasi-common</code>, <code>wasi-cap-std-sync</code>, and <code>wasi-tokio</code> crates untouched. They will continue to provide all preview 1 functionality for the moment. The preview 2 functionality will be passing all tests that it does in p2p through the <code>test-programs</code> (at the moment this means poll-oneoff and some trailing slashes behavior is broken), and this PR will port in the other tests from the p2p repo as well.</li>
</ol>
<p>At this point we can say the wasmtime project has preview 2 support! It is, however, behind a different WasiCtx api (with some changes to the builder, and the way to add it to a linker), and is totally separate from the preview 1 support.</p>
<p>The next steps are:</p>
<ol>
<li>[ ] Finish the development work I have planned to straighten out the poll-oneoff / streams / async vs sync embedding design in preview 2, which is currently not passing all its tests. At this point, we can just ignore some trailing slash behavior in the test suite, but the stuff everyone really cares about ought to be done.</li>
<li>[ ] Land @rvolosatovs 's work on a host-side preview 2 wit-bindgen to preview 1 wiggle adapter. Hook this up to the test suite, passing all the same tests as the legacy implementation, without using the <code>wasi-preview1-component-adapter</code> or any component-model features in wasmtime.</li>
<li>[ ] Land preview2-prototyping's <code>wasmtime-wasi-sockets</code> crate into this repository. This crate is separate from, but depends upon, what will land in <code>wasmtime-wasi::preview2</code>. It need to be integrated with the poll oneoff design fixes, and it needs a test suite, in order to land.</li>
<li>[ ] Port the <code>wasmtime-wasi-http</code> crate to use the poll-oneoff fixes above, making it compatible with components instead of just modules</li>
</ol>
<p>Once the poll design changes and host-side adapter are landed, we can start working on transitioning the legacy implementation out of wasmtime:</p>
<ol>
<li>[ ] Move all of <code>wasmtime-wasi</code>'s existing preview 1 support behind <code>pub mod preview1_legacy</code> and the off-by-default <code>preview1_legacy</code> cargo feature. Move the <code>preview2</code> module out to the root. The new host-side adapter interface to provides preview 1 support to all users, except those who have regressions and need to use the legacy support for a limited time.</li>
<li>[ ] The known regressions for preview 2 support include some trailing slash filesystem behaviors, and the support for preview 1's late-added <code>sock_*</code> functions. Presently, the sock functions have no tests in the tree, or anywhere else I can find, so I don't have a way to port those to preview 2 without taking a wild guess at what semantics they need. The only known user of these functions was Enarx, who are no longer in business. If any other users need these sock functions to keep working in either the host or wasm adapter for preview 1, we'll need them to contribute to that support- all of the Bytecode Alliance contributors I have spoke to so far don't have a business case for supporting preview 1's sockets, and instead are all in on preview 2 sockets.</li>
<li>[ ] After 2 releases in off-by-default legacy mode, we will delete the legacy preview 1 code from the repository.</li>
</ol>
</blockquote>



<a name="359470918"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236370%20Land%20WASI%20Preview%202%20support%20into%20W.../near/359470918" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236370.20Land.20WASI.20Preview.202.20support.20into.20W.2E.2E.2E.html#359470918">(May 18 2023 at 18:37)</a>:</h4>
<p>pchickey edited <a href="https://github.com/bytecodealliance/wasmtime/issues/6370">issue #6370</a>:</p>
<blockquote>
<p>We have been working on a prototype of what WASI Preview 2 support will look like in Wasmtime for 7 months now! <a href="https://github.com/bytecodealliance/preview2-prototyping/">https://github.com/bytecodealliance/preview2-prototyping/</a></p>
<p>The work is not yet totally complete, but I believe that it is mature enough that we should start landing it into this repository, and keep iterating on it here. It was included in the <a href="https://bytecodealliance.org/articles/component-model-tooling-compatibility">March 28 tooling compatibility matrix</a>, but it turns out we skipped compatibility with the wasmtime 8.0 release due to some bindgen changes we needed. I'd like to get everything landed and part of the regular Wasmtime release cycle for 10.0, which will cut at the beginning of June.</p>
<p>Here is my rough plan for how we will land changes. These plans are open to changes so please leave your feedback!</p>
<ol>
<li>[x] Move the adapter (found at the root of the p2p repo) to <code>crates/wasi-preview1-component-adapter</code>. We will bring its child proc-macro crate <code>byte-array</code>, and the test harness <code>validate</code>, in as well underneath that directory. Add building, validating, and publishing the adapter binary (for both commands and reactors) to the wasmtime repository's CI. Runtime (integration) tests will be added in the subsequent steps.</li>
<li>[x] Restructure the <code>test-programs</code> crate to support building both modules and components (using the adapter from step 1). Keep all the existing tests of wasi-common (which covers both the cap-std-sync and tokio backends) intact, but refactor like we did in p2p to make the structure of how tests are run driven by hand-written code, rather than packing a ton of magic into the macros. The components will be built, but not actually executed yet.</li>
<li>[ ] Land the contents of preview2-prototyping's <code>wasi-common</code> crate under <code>wasmtime-wasi</code> in the <code>pub mod preview2</code> space, and behind the (enabled by default) <code>preview2</code> cargo feature. Leave this repository's <code>wasi-common</code>, <code>wasi-cap-std-sync</code>, and <code>wasi-tokio</code> crates untouched. They will continue to provide all preview 1 functionality for the moment. The preview 2 functionality will be passing all tests that it does in p2p through the <code>test-programs</code> (at the moment this means poll-oneoff and some trailing slashes behavior is broken), and this PR will port in the other tests from the p2p repo as well.</li>
</ol>
<p>At this point we can say the wasmtime project has preview 2 support! It is, however, behind a different WasiCtx api (with some changes to the builder, and the way to add it to a linker), and is totally separate from the preview 1 support.</p>
<p>The next steps are:</p>
<ol>
<li>[ ] Finish the development work I have planned to straighten out the poll-oneoff / streams / async vs sync embedding design in preview 2, which is currently not passing all its tests. At this point, we can just ignore some trailing slash behavior in the test suite, but the stuff everyone really cares about ought to be done.</li>
<li>[ ] Land @rvolosatovs 's work on a host-side preview 2 wit-bindgen to preview 1 wiggle adapter. Hook this up to the test suite, passing all the same tests as the legacy implementation, without using the <code>wasi-preview1-component-adapter</code> or any component-model features in wasmtime.</li>
<li>[ ] Land preview2-prototyping's <code>wasmtime-wasi-sockets</code> crate into this repository. This crate is separate from, but depends upon, what will land in <code>wasmtime-wasi::preview2</code>. It need to be integrated with the poll oneoff design fixes, and it needs a test suite, in order to land.</li>
<li>[ ] Port the <code>wasmtime-wasi-http</code> crate to use the poll-oneoff fixes above, making it compatible with components instead of just modules</li>
</ol>
<p>Once the poll design changes and host-side adapter are landed, we can start working on transitioning the legacy implementation out of wasmtime:</p>
<ol>
<li>[ ] Move all of <code>wasmtime-wasi</code>'s existing preview 1 support behind <code>pub mod preview1_legacy</code> and the off-by-default <code>preview1_legacy</code> cargo feature. Move the <code>preview2</code> module out to the root. The new host-side adapter interface to provides preview 1 support to all users, except those who have regressions and need to use the legacy support for a limited time.</li>
<li>[ ] The known regressions for preview 2 support include some trailing slash filesystem behaviors, and the support for preview 1's late-added <code>sock_*</code> functions. Presently, the sock functions have no tests in the tree, or anywhere else I can find, so I don't have a way to port those to preview 2 without taking a wild guess at what semantics they need. The only known user of these functions was Enarx, who are no longer in business. If any other users need these sock functions to keep working in either the host or wasm adapter for preview 1, we'll need them to contribute to that support- all of the Bytecode Alliance contributors I have spoke to so far don't have a business case for supporting preview 1's sockets, and instead are all in on preview 2 sockets.</li>
<li>[ ] After 2 releases in off-by-default legacy mode, we will delete the legacy preview 1 code from the repository. This means retiring the <code>wasi-common</code>, <code>wasi-cap-std-sync</code>, and <code>wasi-tokio</code> crates. We could publish a final empty version indicating they wont get any more updates and have been replaced with wasmtime-wasi.</li>
</ol>
</blockquote>



<a name="359527861"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236370%20Land%20WASI%20Preview%202%20support%20into%20W.../near/359527861" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236370.20Land.20WASI.20Preview.202.20support.20into.20W.2E.2E.2E.html#359527861">(May 19 2023 at 01:50)</a>:</h4>
<p>pchickey edited <a href="https://github.com/bytecodealliance/wasmtime/issues/6370">issue #6370</a>:</p>
<blockquote>
<p>We have been working on a prototype of what WASI Preview 2 support will look like in Wasmtime for 7 months now! <a href="https://github.com/bytecodealliance/preview2-prototyping/">https://github.com/bytecodealliance/preview2-prototyping/</a></p>
<p>The work is not yet totally complete, but I believe that it is mature enough that we should start landing it into this repository, and keep iterating on it here. It was included in the <a href="https://bytecodealliance.org/articles/component-model-tooling-compatibility">March 28 tooling compatibility matrix</a>, but it turns out we skipped compatibility with the wasmtime 8.0 release due to some bindgen changes we needed. I'd like to get everything landed and part of the regular Wasmtime release cycle for 10.0, which will cut at the beginning of June.</p>
<p>Here is my rough plan for how we will land changes. These plans are open to changes so please leave your feedback!</p>
<ol>
<li>[x] Move the adapter (found at the root of the p2p repo) to <code>crates/wasi-preview1-component-adapter</code>. We will bring its child proc-macro crate <code>byte-array</code>, and the test harness <code>validate</code>, in as well underneath that directory. Add building, validating, and publishing the adapter binary (for both commands and reactors) to the wasmtime repository's CI. Runtime (integration) tests will be added in the subsequent steps.</li>
<li>[x] Restructure the <code>test-programs</code> crate to support building both modules and components (using the adapter from step 1). Keep all the existing tests of wasi-common (which covers both the cap-std-sync and tokio backends) intact, but refactor like we did in p2p to make the structure of how tests are run driven by hand-written code, rather than packing a ton of magic into the macros. The components will be built, but not actually executed yet.</li>
<li>[x] Land the contents of preview2-prototyping's <code>wasi-common</code> crate under <code>wasmtime-wasi</code> in the <code>pub mod preview2</code> space, and behind the (enabled by default) <code>preview2</code> cargo feature. Leave this repository's <code>wasi-common</code>, <code>wasi-cap-std-sync</code>, and <code>wasi-tokio</code> crates untouched. They will continue to provide all preview 1 functionality for the moment. The preview 2 functionality will be passing all tests that it does in p2p through the <code>test-programs</code> (at the moment this means poll-oneoff and some trailing slashes behavior is broken), and this PR will port in the other tests from the p2p repo as well.</li>
</ol>
<p>At this point we can say the wasmtime project has preview 2 support! It is, however, behind a different WasiCtx api (with some changes to the builder, and the way to add it to a linker), and is totally separate from the preview 1 support.</p>
<p>The next steps are:</p>
<ol>
<li>[ ] Finish the development work I have planned to straighten out the poll-oneoff / streams / async vs sync embedding design in preview 2, which is currently not passing all its tests. At this point, we can just ignore some trailing slash behavior in the test suite, but the stuff everyone really cares about ought to be done.</li>
<li>[ ] Land @rvolosatovs 's work on a host-side preview 2 wit-bindgen to preview 1 wiggle adapter. Hook this up to the test suite, passing all the same tests as the legacy implementation, without using the <code>wasi-preview1-component-adapter</code> or any component-model features in wasmtime.</li>
<li>[ ] Land preview2-prototyping's <code>wasmtime-wasi-sockets</code> crate into this repository. This crate is separate from, but depends upon, what will land in <code>wasmtime-wasi::preview2</code>. It need to be integrated with the poll oneoff design fixes, and it needs a test suite, in order to land.</li>
<li>[ ] Port the <code>wasmtime-wasi-http</code> crate to use the poll-oneoff fixes above, making it compatible with components instead of just modules</li>
</ol>
<p>Once the poll design changes and host-side adapter are landed, we can start working on transitioning the legacy implementation out of wasmtime:</p>
<ol>
<li>[ ] Move all of <code>wasmtime-wasi</code>'s existing preview 1 support behind <code>pub mod preview1_legacy</code> and the off-by-default <code>preview1_legacy</code> cargo feature. Move the <code>preview2</code> module out to the root. The new host-side adapter interface to provides preview 1 support to all users, except those who have regressions and need to use the legacy support for a limited time.</li>
<li>[ ] The known regressions for preview 2 support include some trailing slash filesystem behaviors, and the support for preview 1's late-added <code>sock_*</code> functions. Presently, the sock functions have no tests in the tree, or anywhere else I can find, so I don't have a way to port those to preview 2 without taking a wild guess at what semantics they need. The only known user of these functions was Enarx, who are no longer in business. If any other users need these sock functions to keep working in either the host or wasm adapter for preview 1, we'll need them to contribute to that support- all of the Bytecode Alliance contributors I have spoke to so far don't have a business case for supporting preview 1's sockets, and instead are all in on preview 2 sockets.</li>
<li>[ ] After 2 releases in off-by-default legacy mode, we will delete the legacy preview 1 code from the repository. This means retiring the <code>wasi-common</code>, <code>wasi-cap-std-sync</code>, and <code>wasi-tokio</code> crates. We could publish a final empty version indicating they wont get any more updates and have been replaced with wasmtime-wasi.</li>
</ol>
</blockquote>



<a name="359528181"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236370%20Land%20WASI%20Preview%202%20support%20into%20W.../near/359528181" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236370.20Land.20WASI.20Preview.202.20support.20into.20W.2E.2E.2E.html#359528181">(May 19 2023 at 01:54)</a>:</h4>
<p>pchickey edited <a href="https://github.com/bytecodealliance/wasmtime/issues/6370">issue #6370</a>:</p>
<blockquote>
<p>We have been working on a prototype of what WASI Preview 2 support will look like in Wasmtime for 7 months now! <a href="https://github.com/bytecodealliance/preview2-prototyping/">https://github.com/bytecodealliance/preview2-prototyping/</a></p>
<p>The work is not yet totally complete, but I believe that it is mature enough that we should start landing it into this repository, and keep iterating on it here. It was included in the <a href="https://bytecodealliance.org/articles/component-model-tooling-compatibility">March 28 tooling compatibility matrix</a>, but it turns out we skipped compatibility with the wasmtime 8.0 release due to some bindgen changes we needed. I'd like to get everything landed and part of the regular Wasmtime release cycle for 10.0, which will cut at the beginning of June.</p>
<p>Here is my rough plan for how we will land changes. These plans are open to changes so please leave your feedback!</p>
<ol>
<li>[x] Move the adapter (found at the root of the p2p repo) to <code>crates/wasi-preview1-component-adapter</code>. We will bring its child proc-macro crate <code>byte-array</code>, and the test harness <code>validate</code>, in as well underneath that directory. Add building, validating, and publishing the adapter binary (for both commands and reactors) to the wasmtime repository's CI. Runtime (integration) tests will be added in the subsequent steps.</li>
<li>[x] Restructure the <code>test-programs</code> crate to support building both modules and components (using the adapter from step 1). Keep all the existing tests of wasi-common (which covers both the cap-std-sync and tokio backends) intact, but refactor like we did in p2p to make the structure of how tests are run driven by hand-written code, rather than packing a ton of magic into the macros. The components will be built, but not actually executed yet.</li>
<li>[x] Land the contents of preview2-prototyping's <code>wasi-common</code> crate under <code>wasmtime-wasi</code> in the <code>pub mod preview2</code> space, and behind the (enabled by default) <code>preview2</code> cargo feature. Leave this repository's <code>wasi-common</code>, <code>wasi-cap-std-sync</code>, and <code>wasi-tokio</code> crates untouched. They will continue to provide all preview 1 functionality for the moment. The preview 2 functionality will be passing all tests that it does in p2p through the <code>test-programs</code> (at the moment this means poll-oneoff and some trailing slashes behavior is broken), and this PR will port in the other tests from the p2p repo as well.</li>
</ol>
<p>At this point we can say the wasmtime project has preview 2 support! It is, however, behind a different WasiCtx api (with some changes to the builder, and the way to add it to a linker), and is totally separate from the preview 1 support.</p>
<p>The next steps are:</p>
<ol>
<li>[ ] Finish the development work I have planned to straighten out the poll-oneoff / streams / async vs sync embedding design in preview 2, which is currently not passing all its tests. At this point, we can just ignore some trailing slash behavior in the test suite, but the stuff everyone really cares about ought to be done.</li>
<li>[ ] Land @rvolosatovs 's work on a host-side preview 2 wit-bindgen to preview 1 wiggle adapter. Hook this up to the test suite, passing all the same tests as the legacy implementation, without using the <code>wasi-preview1-component-adapter</code> or any component-model features in wasmtime.</li>
<li>[ ] Land preview2-prototyping's <code>wasmtime-wasi-sockets</code> crate into this repository. This crate is separate from, but depends upon, what will land in <code>wasmtime-wasi::preview2</code>. It need to be integrated with the poll oneoff design fixes, and it needs a test suite, in order to land.</li>
<li>[ ] Port the <code>wasmtime-wasi-http</code> crate to use the poll-oneoff fixes above, making it compatible with components instead of just modules]</li>
<li>[ ] Bring <code>wasmtime-wasi::preview2</code>'s docs up to Wasmtime project standards. </li>
</ol>
<p>Once the poll design changes and host-side adapter are landed, we can start working on transitioning the legacy implementation out of wasmtime:</p>
<ol>
<li>[ ] Move all of <code>wasmtime-wasi</code>'s existing preview 1 support behind <code>pub mod preview1_legacy</code> and the off-by-default <code>preview1_legacy</code> cargo feature. Move the <code>preview2</code> module out to the root. The new host-side adapter interface to provides preview 1 support to all users, except those who have regressions and need to use the legacy support for a limited time.</li>
<li>[ ] The known regressions for preview 2 support include some trailing slash filesystem behaviors, and the support for preview 1's late-added <code>sock_*</code> functions. Presently, the sock functions have no tests in the tree, or anywhere else I can find, so I don't have a way to port those to preview 2 without taking a wild guess at what semantics they need. The only known user of these functions was Enarx, who are no longer in business. If any other users need these sock functions to keep working in either the host or wasm adapter for preview 1, we'll need them to contribute to that support- all of the Bytecode Alliance contributors I have spoke to so far don't have a business case for supporting preview 1's sockets, and instead are all in on preview 2 sockets.</li>
<li>[ ] After 2 releases in off-by-default legacy mode, we will delete the legacy preview 1 code from the repository. This means retiring the <code>wasi-common</code>, <code>wasi-cap-std-sync</code>, and <code>wasi-tokio</code> crates. We could publish a final empty version indicating they wont get any more updates and have been replaced with wasmtime-wasi.</li>
</ol>
</blockquote>



<a name="362266020"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236370%20Land%20WASI%20Preview%202%20support%20into%20W.../near/362266020" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236370.20Land.20WASI.20Preview.202.20support.20into.20W.2E.2E.2E.html#362266020">(May 30 2023 at 18:17)</a>:</h4>
<p>pchickey edited <a href="https://github.com/bytecodealliance/wasmtime/issues/6370">issue #6370</a>:</p>
<blockquote>
<p>We have been working on a prototype of what WASI Preview 2 support will look like in Wasmtime for 7 months now! <a href="https://github.com/bytecodealliance/preview2-prototyping/">https://github.com/bytecodealliance/preview2-prototyping/</a></p>
<p>The work is not yet totally complete, but I believe that it is mature enough that we should start landing it into this repository, and keep iterating on it here. It was included in the <a href="https://bytecodealliance.org/articles/component-model-tooling-compatibility">March 28 tooling compatibility matrix</a>, but it turns out we skipped compatibility with the wasmtime 8.0 release due to some bindgen changes we needed. I'd like to get everything landed and part of the regular Wasmtime release cycle for 10.0, which will cut at the beginning of June.</p>
<p>Here is my rough plan for how we will land changes. These plans are open to changes so please leave your feedback!</p>
<ol>
<li>[x] Move the adapter (found at the root of the p2p repo) to <code>crates/wasi-preview1-component-adapter</code>. We will bring its child proc-macro crate <code>byte-array</code>, and the test harness <code>validate</code>, in as well underneath that directory. Add building, validating, and publishing the adapter binary (for both commands and reactors) to the wasmtime repository's CI. Runtime (integration) tests will be added in the subsequent steps.</li>
<li>[x] Restructure the <code>test-programs</code> crate to support building both modules and components (using the adapter from step 1). Keep all the existing tests of wasi-common (which covers both the cap-std-sync and tokio backends) intact, but refactor like we did in p2p to make the structure of how tests are run driven by hand-written code, rather than packing a ton of magic into the macros. The components will be built, but not actually executed yet.</li>
<li>[x] Land the contents of preview2-prototyping's <code>wasi-common</code> crate under <code>wasmtime-wasi</code> in the <code>pub mod preview2</code> space, and behind the (enabled by default) <code>preview2</code> cargo feature. Leave this repository's <code>wasi-common</code>, <code>wasi-cap-std-sync</code>, and <code>wasi-tokio</code> crates untouched. They will continue to provide all preview 1 functionality for the moment. The preview 2 functionality will be passing all tests that it does in p2p through the <code>test-programs</code> (at the moment this means poll-oneoff and some trailing slashes behavior is broken), and this PR will port in the other tests from the p2p repo as well.</li>
</ol>
<p>At this point we can say the wasmtime project has preview 2 support! It is, however, behind a different WasiCtx api (with some changes to the builder, and the way to add it to a linker), and is totally separate from the preview 1 support.</p>
<p>The next steps are:</p>
<ol>
<li>[ ] Finish the development work I have planned to straighten out the poll-oneoff / streams / async vs sync embedding design in preview 2, which is currently not passing all its tests. At this point, we can just ignore some trailing slash behavior in the test suite, but the stuff everyone really cares about ought to be done.</li>
<li>[x] Land @rvolosatovs 's work on a host-side preview 2 wit-bindgen to preview 1 wiggle adapter. Hook this up to the test suite, passing all the same tests as the legacy implementation, without using the <code>wasi-preview1-component-adapter</code> or any component-model features in wasmtime.</li>
<li>[ ] Land preview2-prototyping's <code>wasmtime-wasi-sockets</code> crate into this repository. This crate is separate from, but depends upon, what will land in <code>wasmtime-wasi::preview2</code>. It need to be integrated with the poll oneoff design fixes, and it needs a test suite, in order to land.</li>
<li>[ ] Port the <code>wasmtime-wasi-http</code> crate to use the poll-oneoff fixes above, making it compatible with components instead of just modules]</li>
<li>[ ] Bring <code>wasmtime-wasi::preview2</code>'s docs up to Wasmtime project standards. </li>
</ol>
<p>Once the poll design changes and host-side adapter are landed, we can start working on transitioning the legacy implementation out of wasmtime:</p>
<ol>
<li>[ ] Move all of <code>wasmtime-wasi</code>'s existing preview 1 support behind <code>pub mod preview1_legacy</code> and the off-by-default <code>preview1_legacy</code> cargo feature. Move the <code>preview2</code> module out to the root. The new host-side adapter interface to provides preview 1 support to all users, except those who have regressions and need to use the legacy support for a limited time.</li>
<li>[ ] The known regressions for preview 2 support include some trailing slash filesystem behaviors, and the support for preview 1's late-added <code>sock_*</code> functions. Presently, the sock functions have no tests in the tree, or anywhere else I can find, so I don't have a way to port those to preview 2 without taking a wild guess at what semantics they need. The only known user of these functions was Enarx, who are no longer in business. If any other users need these sock functions to keep working in either the host or wasm adapter for preview 1, we'll need them to contribute to that support- all of the Bytecode Alliance contributors I have spoke to so far don't have a business case for supporting preview 1's sockets, and instead are all in on preview 2 sockets.</li>
<li>[ ] After 2 releases in off-by-default legacy mode, we will delete the legacy preview 1 code from the repository. This means retiring the <code>wasi-common</code>, <code>wasi-cap-std-sync</code>, and <code>wasi-tokio</code> crates. We could publish a final empty version indicating they wont get any more updates and have been replaced with wasmtime-wasi.</li>
</ol>
</blockquote>



<a name="378830250"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236370%20Land%20WASI%20Preview%202%20support%20into%20W.../near/378830250" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236370.20Land.20WASI.20Preview.202.20support.20into.20W.2E.2E.2E.html#378830250">(Jul 26 2023 at 14:45)</a>:</h4>
<p>pchickey edited <a href="https://github.com/bytecodealliance/wasmtime/issues/6370">issue #6370</a>:</p>
<blockquote>
<p>We have been working on a prototype of what WASI Preview 2 support will look like in Wasmtime for 7 months now! <a href="https://github.com/bytecodealliance/preview2-prototyping/">https://github.com/bytecodealliance/preview2-prototyping/</a></p>
<p>The work is not yet totally complete, but I believe that it is mature enough that we should start landing it into this repository, and keep iterating on it here. It was included in the <a href="https://bytecodealliance.org/articles/component-model-tooling-compatibility">March 28 tooling compatibility matrix</a>, but it turns out we skipped compatibility with the wasmtime 8.0 release due to some bindgen changes we needed. I'd like to get everything landed and part of the regular Wasmtime release cycle for 10.0, which will cut at the beginning of June.</p>
<p>Here is my rough plan for how we will land changes. These plans are open to changes so please leave your feedback!</p>
<ol>
<li>[x] Move the adapter (found at the root of the p2p repo) to <code>crates/wasi-preview1-component-adapter</code>. We will bring its child proc-macro crate <code>byte-array</code>, and the test harness <code>validate</code>, in as well underneath that directory. Add building, validating, and publishing the adapter binary (for both commands and reactors) to the wasmtime repository's CI. Runtime (integration) tests will be added in the subsequent steps.</li>
<li>[x] Restructure the <code>test-programs</code> crate to support building both modules and components (using the adapter from step 1). Keep all the existing tests of wasi-common (which covers both the cap-std-sync and tokio backends) intact, but refactor like we did in p2p to make the structure of how tests are run driven by hand-written code, rather than packing a ton of magic into the macros. The components will be built, but not actually executed yet.</li>
<li>[x] Land the contents of preview2-prototyping's <code>wasi-common</code> crate under <code>wasmtime-wasi</code> in the <code>pub mod preview2</code> space, and behind the (enabled by default) <code>preview2</code> cargo feature. Leave this repository's <code>wasi-common</code>, <code>wasi-cap-std-sync</code>, and <code>wasi-tokio</code> crates untouched. They will continue to provide all preview 1 functionality for the moment. The preview 2 functionality will be passing all tests that it does in p2p through the <code>test-programs</code> (at the moment this means poll-oneoff and some trailing slashes behavior is broken), and this PR will port in the other tests from the p2p repo as well.</li>
</ol>
<p>At this point we can say the wasmtime project has preview 2 support! It is, however, behind a different WasiCtx api (with some changes to the builder, and the way to add it to a linker), and is totally separate from the preview 1 support.</p>
<p>The next steps are:</p>
<ol>
<li>[x] Finish the development work I have planned to straighten out the poll-oneoff / streams / async vs sync embedding design in preview 2, which is currently not passing all its tests. At this point, we can just ignore some trailing slash behavior in the test suite, but the stuff everyone really cares about ought to be done.</li>
<li>[x] Land @rvolosatovs 's work on a host-side preview 2 wit-bindgen to preview 1 wiggle adapter. Hook this up to the test suite, passing all the same tests as the legacy implementation, without using the <code>wasi-preview1-component-adapter</code> or any component-model features in wasmtime.</li>
<li>[ ] Land preview2-prototyping's <code>wasmtime-wasi-sockets</code> crate into this repository. This crate is separate from, but depends upon, what will land in <code>wasmtime-wasi::preview2</code>. It need to be integrated with the poll oneoff design fixes, and it needs a test suite, in order to land.</li>
<li>[ ] Port the <code>wasmtime-wasi-http</code> crate to use the poll-oneoff fixes above, making it compatible with components instead of just modules]</li>
<li>[ ] Bring <code>wasmtime-wasi::preview2</code>'s docs up to Wasmtime project standards. </li>
</ol>
<p>Once the poll design changes and host-side adapter are landed, we can start working on transitioning the legacy implementation out of wasmtime:</p>
<ol>
<li>[ ] Move all of <code>wasmtime-wasi</code>'s existing preview 1 support behind <code>pub mod preview1_legacy</code> and the off-by-default <code>preview1_legacy</code> cargo feature. Move the <code>preview2</code> module out to the root. The new host-side adapter interface to provides preview 1 support to all users, except those who have regressions and need to use the legacy support for a limited time.</li>
<li>[ ] The known regressions for preview 2 support include some trailing slash filesystem behaviors, and the support for preview 1's late-added <code>sock_*</code> functions. Presently, the sock functions have no tests in the tree, or anywhere else I can find, so I don't have a way to port those to preview 2 without taking a wild guess at what semantics they need. The only known user of these functions was Enarx, who are no longer in business. If any other users need these sock functions to keep working in either the host or wasm adapter for preview 1, we'll need them to contribute to that support- all of the Bytecode Alliance contributors I have spoke to so far don't have a business case for supporting preview 1's sockets, and instead are all in on preview 2 sockets.</li>
<li>[ ] After 2 releases in off-by-default legacy mode, we will delete the legacy preview 1 code from the repository. This means retiring the <code>wasi-common</code>, <code>wasi-cap-std-sync</code>, and <code>wasi-tokio</code> crates. We could publish a final empty version indicating they wont get any more updates and have been replaced with wasmtime-wasi.</li>
</ol>
</blockquote>



<a name="393581112"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236370%20Land%20WASI%20Preview%202%20support%20into%20W.../near/393581112" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236370.20Land.20WASI.20Preview.202.20support.20into.20W.2E.2E.2E.html#393581112">(Sep 27 2023 at 22:48)</a>:</h4>
<p>pchickey edited <a href="https://github.com/bytecodealliance/wasmtime/issues/6370">issue #6370</a>:</p>
<blockquote>
<p>We have been working on a prototype of what WASI Preview 2 support will look like in Wasmtime for 7 months now! <a href="https://github.com/bytecodealliance/preview2-prototyping/">https://github.com/bytecodealliance/preview2-prototyping/</a></p>
<p>The work is not yet totally complete, but I believe that it is mature enough that we should start landing it into this repository, and keep iterating on it here. It was included in the <a href="https://bytecodealliance.org/articles/component-model-tooling-compatibility">March 28 tooling compatibility matrix</a>, but it turns out we skipped compatibility with the wasmtime 8.0 release due to some bindgen changes we needed. I'd like to get everything landed and part of the regular Wasmtime release cycle for 10.0, which will cut at the beginning of June.</p>
<p>Here is my rough plan for how we will land changes. These plans are open to changes so please leave your feedback!</p>
<ol>
<li>[x] Move the adapter (found at the root of the p2p repo) to <code>crates/wasi-preview1-component-adapter</code>. We will bring its child proc-macro crate <code>byte-array</code>, and the test harness <code>validate</code>, in as well underneath that directory. Add building, validating, and publishing the adapter binary (for both commands and reactors) to the wasmtime repository's CI. Runtime (integration) tests will be added in the subsequent steps.</li>
<li>[x] Restructure the <code>test-programs</code> crate to support building both modules and components (using the adapter from step 1). Keep all the existing tests of wasi-common (which covers both the cap-std-sync and tokio backends) intact, but refactor like we did in p2p to make the structure of how tests are run driven by hand-written code, rather than packing a ton of magic into the macros. The components will be built, but not actually executed yet.</li>
<li>[x] Land the contents of preview2-prototyping's <code>wasi-common</code> crate under <code>wasmtime-wasi</code> in the <code>pub mod preview2</code> space, and behind the (enabled by default) <code>preview2</code> cargo feature. Leave this repository's <code>wasi-common</code>, <code>wasi-cap-std-sync</code>, and <code>wasi-tokio</code> crates untouched. They will continue to provide all preview 1 functionality for the moment. The preview 2 functionality will be passing all tests that it does in p2p through the <code>test-programs</code> (at the moment this means poll-oneoff and some trailing slashes behavior is broken), and this PR will port in the other tests from the p2p repo as well.</li>
</ol>
<p>At this point we can say the wasmtime project has preview 2 support! It is, however, behind a different WasiCtx api (with some changes to the builder, and the way to add it to a linker), and is totally separate from the preview 1 support.</p>
<p>The next steps are:</p>
<ol>
<li>[x] Finish the development work I have planned to straighten out the poll-oneoff / streams / async vs sync embedding design in preview 2, which is currently not passing all its tests. At this point, we can just ignore some trailing slash behavior in the test suite, but the stuff everyone really cares about ought to be done.</li>
<li>[x] Land @rvolosatovs 's work on a host-side preview 2 wit-bindgen to preview 1 wiggle adapter. Hook this up to the test suite, passing all the same tests as the legacy implementation, without using the <code>wasi-preview1-component-adapter</code> or any component-model features in wasmtime.</li>
<li>[x] Land preview2-prototyping's <code>wasmtime-wasi-sockets</code> crate into this repository. This crate is separate from, but depends upon, what will land in <code>wasmtime-wasi::preview2</code>. It need to be integrated with the poll oneoff design fixes, and it needs a test suite, in order to land.</li>
<li>[ ] Port the <code>wasmtime-wasi-http</code> crate to use the poll-oneoff fixes above, making it compatible with components instead of just modules]</li>
<li>[ ] Bring <code>wasmtime-wasi::preview2</code>'s docs up to Wasmtime project standards. </li>
</ol>
<p>Once the poll design changes and host-side adapter are landed, we can start working on transitioning the legacy implementation out of wasmtime:</p>
<ol>
<li>[ ] Move all of <code>wasmtime-wasi</code>'s existing preview 1 support behind <code>pub mod preview1_legacy</code> and the off-by-default <code>preview1_legacy</code> cargo feature. Move the <code>preview2</code> module out to the root. The new host-side adapter interface to provides preview 1 support to all users, except those who have regressions and need to use the legacy support for a limited time.</li>
<li>[ ] The known regressions for preview 2 support include some trailing slash filesystem behaviors, and the support for preview 1's late-added <code>sock_*</code> functions. Presently, the sock functions have no tests in the tree, or anywhere else I can find, so I don't have a way to port those to preview 2 without taking a wild guess at what semantics they need. The only known user of these functions was Enarx, who are no longer in business. If any other users need these sock functions to keep working in either the host or wasm adapter for preview 1, we'll need them to contribute to that support- all of the Bytecode Alliance contributors I have spoke to so far don't have a business case for supporting preview 1's sockets, and instead are all in on preview 2 sockets.</li>
<li>[ ] After 2 releases in off-by-default legacy mode, we will delete the legacy preview 1 code from the repository. This means retiring the <code>wasi-common</code>, <code>wasi-cap-std-sync</code>, and <code>wasi-tokio</code> crates. We could publish a final empty version indicating they wont get any more updates and have been replaced with wasmtime-wasi.</li>
</ol>
</blockquote>



<a name="393581128"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236370%20Land%20WASI%20Preview%202%20support%20into%20W.../near/393581128" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236370.20Land.20WASI.20Preview.202.20support.20into.20W.2E.2E.2E.html#393581128">(Sep 27 2023 at 22:48)</a>:</h4>
<p>pchickey edited <a href="https://github.com/bytecodealliance/wasmtime/issues/6370">issue #6370</a>:</p>
<blockquote>
<p>We have been working on a prototype of what WASI Preview 2 support will look like in Wasmtime for 7 months now! <a href="https://github.com/bytecodealliance/preview2-prototyping/">https://github.com/bytecodealliance/preview2-prototyping/</a></p>
<p>The work is not yet totally complete, but I believe that it is mature enough that we should start landing it into this repository, and keep iterating on it here. It was included in the <a href="https://bytecodealliance.org/articles/component-model-tooling-compatibility">March 28 tooling compatibility matrix</a>, but it turns out we skipped compatibility with the wasmtime 8.0 release due to some bindgen changes we needed. I'd like to get everything landed and part of the regular Wasmtime release cycle for 10.0, which will cut at the beginning of June.</p>
<p>Here is my rough plan for how we will land changes. These plans are open to changes so please leave your feedback!</p>
<ol>
<li>[x] Move the adapter (found at the root of the p2p repo) to <code>crates/wasi-preview1-component-adapter</code>. We will bring its child proc-macro crate <code>byte-array</code>, and the test harness <code>validate</code>, in as well underneath that directory. Add building, validating, and publishing the adapter binary (for both commands and reactors) to the wasmtime repository's CI. Runtime (integration) tests will be added in the subsequent steps.</li>
<li>[x] Restructure the <code>test-programs</code> crate to support building both modules and components (using the adapter from step 1). Keep all the existing tests of wasi-common (which covers both the cap-std-sync and tokio backends) intact, but refactor like we did in p2p to make the structure of how tests are run driven by hand-written code, rather than packing a ton of magic into the macros. The components will be built, but not actually executed yet.</li>
<li>[x] Land the contents of preview2-prototyping's <code>wasi-common</code> crate under <code>wasmtime-wasi</code> in the <code>pub mod preview2</code> space, and behind the (enabled by default) <code>preview2</code> cargo feature. Leave this repository's <code>wasi-common</code>, <code>wasi-cap-std-sync</code>, and <code>wasi-tokio</code> crates untouched. They will continue to provide all preview 1 functionality for the moment. The preview 2 functionality will be passing all tests that it does in p2p through the <code>test-programs</code> (at the moment this means poll-oneoff and some trailing slashes behavior is broken), and this PR will port in the other tests from the p2p repo as well.</li>
</ol>
<p>At this point we can say the wasmtime project has preview 2 support! It is, however, behind a different WasiCtx api (with some changes to the builder, and the way to add it to a linker), and is totally separate from the preview 1 support.</p>
<p>The next steps are:</p>
<ol>
<li>[x] Finish the development work I have planned to straighten out the poll-oneoff / streams / async vs sync embedding design in preview 2, which is currently not passing all its tests. At this point, we can just ignore some trailing slash behavior in the test suite, but the stuff everyone really cares about ought to be done.</li>
<li>[x] Land @rvolosatovs 's work on a host-side preview 2 wit-bindgen to preview 1 wiggle adapter. Hook this up to the test suite, passing all the same tests as the legacy implementation, without using the <code>wasi-preview1-component-adapter</code> or any component-model features in wasmtime.</li>
<li>[x] Land preview2-prototyping's <code>wasmtime-wasi-sockets</code> crate into this repository. This crate is separate from, but depends upon, what will land in <code>wasmtime-wasi::preview2</code>. It need to be integrated with the poll oneoff design fixes, and it needs a test suite, in order to land.</li>
<li>[x] Port the <code>wasmtime-wasi-http</code> crate to use the poll-oneoff fixes above, making it compatible with components instead of just modules]</li>
<li>[ ] Bring <code>wasmtime-wasi::preview2</code>'s docs up to Wasmtime project standards. </li>
</ol>
<p>Once the poll design changes and host-side adapter are landed, we can start working on transitioning the legacy implementation out of wasmtime:</p>
<ol>
<li>[ ] Move all of <code>wasmtime-wasi</code>'s existing preview 1 support behind <code>pub mod preview1_legacy</code> and the off-by-default <code>preview1_legacy</code> cargo feature. Move the <code>preview2</code> module out to the root. The new host-side adapter interface to provides preview 1 support to all users, except those who have regressions and need to use the legacy support for a limited time.</li>
<li>[ ] The known regressions for preview 2 support include some trailing slash filesystem behaviors, and the support for preview 1's late-added <code>sock_*</code> functions. Presently, the sock functions have no tests in the tree, or anywhere else I can find, so I don't have a way to port those to preview 2 without taking a wild guess at what semantics they need. The only known user of these functions was Enarx, who are no longer in business. If any other users need these sock functions to keep working in either the host or wasm adapter for preview 1, we'll need them to contribute to that support- all of the Bytecode Alliance contributors I have spoke to so far don't have a business case for supporting preview 1's sockets, and instead are all in on preview 2 sockets.</li>
<li>[ ] After 2 releases in off-by-default legacy mode, we will delete the legacy preview 1 code from the repository. This means retiring the <code>wasi-common</code>, <code>wasi-cap-std-sync</code>, and <code>wasi-tokio</code> crates. We could publish a final empty version indicating they wont get any more updates and have been replaced with wasmtime-wasi.</li>
</ol>
</blockquote>



<a name="393581213"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236370%20Land%20WASI%20Preview%202%20support%20into%20W.../near/393581213" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236370.20Land.20WASI.20Preview.202.20support.20into.20W.2E.2E.2E.html#393581213">(Sep 27 2023 at 22:49)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/issues/6370#issuecomment-1738207280">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6370">issue #6370</a>:</p>
<blockquote>
<p>I think this issue has lived its useful life and we can now call it closed - the preview 2 support is still not totally complete in wasmtime-wasi but it, and the specs themselves, are maturing rapidly.</p>
</blockquote>



<a name="393581214"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236370%20Land%20WASI%20Preview%202%20support%20into%20W.../near/393581214" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236370.20Land.20WASI.20Preview.202.20support.20into.20W.2E.2E.2E.html#393581214">(Sep 27 2023 at 22:49)</a>:</h4>
<p>pchickey closed <a href="https://github.com/bytecodealliance/wasmtime/issues/6370">issue #6370</a>:</p>
<blockquote>
<p>We have been working on a prototype of what WASI Preview 2 support will look like in Wasmtime for 7 months now! <a href="https://github.com/bytecodealliance/preview2-prototyping/">https://github.com/bytecodealliance/preview2-prototyping/</a></p>
<p>The work is not yet totally complete, but I believe that it is mature enough that we should start landing it into this repository, and keep iterating on it here. It was included in the <a href="https://bytecodealliance.org/articles/component-model-tooling-compatibility">March 28 tooling compatibility matrix</a>, but it turns out we skipped compatibility with the wasmtime 8.0 release due to some bindgen changes we needed. I'd like to get everything landed and part of the regular Wasmtime release cycle for 10.0, which will cut at the beginning of June.</p>
<p>Here is my rough plan for how we will land changes. These plans are open to changes so please leave your feedback!</p>
<ol>
<li>[x] Move the adapter (found at the root of the p2p repo) to <code>crates/wasi-preview1-component-adapter</code>. We will bring its child proc-macro crate <code>byte-array</code>, and the test harness <code>validate</code>, in as well underneath that directory. Add building, validating, and publishing the adapter binary (for both commands and reactors) to the wasmtime repository's CI. Runtime (integration) tests will be added in the subsequent steps.</li>
<li>[x] Restructure the <code>test-programs</code> crate to support building both modules and components (using the adapter from step 1). Keep all the existing tests of wasi-common (which covers both the cap-std-sync and tokio backends) intact, but refactor like we did in p2p to make the structure of how tests are run driven by hand-written code, rather than packing a ton of magic into the macros. The components will be built, but not actually executed yet.</li>
<li>[x] Land the contents of preview2-prototyping's <code>wasi-common</code> crate under <code>wasmtime-wasi</code> in the <code>pub mod preview2</code> space, and behind the (enabled by default) <code>preview2</code> cargo feature. Leave this repository's <code>wasi-common</code>, <code>wasi-cap-std-sync</code>, and <code>wasi-tokio</code> crates untouched. They will continue to provide all preview 1 functionality for the moment. The preview 2 functionality will be passing all tests that it does in p2p through the <code>test-programs</code> (at the moment this means poll-oneoff and some trailing slashes behavior is broken), and this PR will port in the other tests from the p2p repo as well.</li>
</ol>
<p>At this point we can say the wasmtime project has preview 2 support! It is, however, behind a different WasiCtx api (with some changes to the builder, and the way to add it to a linker), and is totally separate from the preview 1 support.</p>
<p>The next steps are:</p>
<ol>
<li>[x] Finish the development work I have planned to straighten out the poll-oneoff / streams / async vs sync embedding design in preview 2, which is currently not passing all its tests. At this point, we can just ignore some trailing slash behavior in the test suite, but the stuff everyone really cares about ought to be done.</li>
<li>[x] Land @rvolosatovs 's work on a host-side preview 2 wit-bindgen to preview 1 wiggle adapter. Hook this up to the test suite, passing all the same tests as the legacy implementation, without using the <code>wasi-preview1-component-adapter</code> or any component-model features in wasmtime.</li>
<li>[x] Land preview2-prototyping's <code>wasmtime-wasi-sockets</code> crate into this repository. This crate is separate from, but depends upon, what will land in <code>wasmtime-wasi::preview2</code>. It need to be integrated with the poll oneoff design fixes, and it needs a test suite, in order to land.</li>
<li>[x] Port the <code>wasmtime-wasi-http</code> crate to use the poll-oneoff fixes above, making it compatible with components instead of just modules]</li>
<li>[ ] Bring <code>wasmtime-wasi::preview2</code>'s docs up to Wasmtime project standards. </li>
</ol>
<p>Once the poll design changes and host-side adapter are landed, we can start working on transitioning the legacy implementation out of wasmtime:</p>
<ol>
<li>[ ] Move all of <code>wasmtime-wasi</code>'s existing preview 1 support behind <code>pub mod preview1_legacy</code> and the off-by-default <code>preview1_legacy</code> cargo feature. Move the <code>preview2</code> module out to the root. The new host-side adapter interface to provides preview 1 support to all users, except those who have regressions and need to use the legacy support for a limited time.</li>
<li>[ ] The known regressions for preview 2 support include some trailing slash filesystem behaviors, and the support for preview 1's late-added <code>sock_*</code> functions. Presently, the sock functions have no tests in the tree, or anywhere else I can find, so I don't have a way to port those to preview 2 without taking a wild guess at what semantics they need. The only known user of these functions was Enarx, who are no longer in business. If any other users need these sock functions to keep working in either the host or wasm adapter for preview 1, we'll need them to contribute to that support- all of the Bytecode Alliance contributors I have spoke to so far don't have a business case for supporting preview 1's sockets, and instead are all in on preview 2 sockets.</li>
<li>[ ] After 2 releases in off-by-default legacy mode, we will delete the legacy preview 1 code from the repository. This means retiring the <code>wasi-common</code>, <code>wasi-cap-std-sync</code>, and <code>wasi-tokio</code> crates. We could publish a final empty version indicating they wont get any more updates and have been replaced with wasmtime-wasi.</li>
</ol>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>