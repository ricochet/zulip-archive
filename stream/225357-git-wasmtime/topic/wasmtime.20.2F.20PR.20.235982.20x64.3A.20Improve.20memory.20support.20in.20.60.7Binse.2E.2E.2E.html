<html>
<head><meta charset="utf-8"><title>wasmtime / PR #5982 x64: Improve memory support in `{inse... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235982.20x64.3A.20Improve.20memory.20support.20in.20.60.7Binse.2E.2E.2E.html">wasmtime / PR #5982 x64: Improve memory support in `{inse...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="340934614"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235982%20x64%3A%20Improve%20memory%20support%20in%20%60%7Binse.../near/340934614" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235982.20x64.3A.20Improve.20memory.20support.20in.20.60.7Binse.2E.2E.2E.html#340934614">(Mar 10 2023 at 18:22)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/5982">PR #5982</a> from <code>pextr</code> to <code>main</code>:</p>
<blockquote>
<p>This commit improves adds support to Cranelift to emit <code>pextr{b,w,d,q}</code> with a memory destination, merging a store-of-extract operation into one instruction. Additionally AVX support is added for the <code>pextr*</code> instructions.</p>
<p>I've additionally tried to ensure that codegen tests and runtests exist for all forms of these instructions too.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="340934617"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235982%20x64%3A%20Improve%20memory%20support%20in%20%60%7Binse.../near/340934617" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235982.20x64.3A.20Improve.20memory.20support.20in.20.60.7Binse.2E.2E.2E.html#340934617">(Mar 10 2023 at 18:22)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/abrown">abrown</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/5982">PR #5982</a>.</p>



<a name="340987619"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235982%20x64%3A%20Improve%20memory%20support%20in%20%60%7Binse.../near/340987619" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235982.20x64.3A.20Improve.20memory.20support.20in.20.60.7Binse.2E.2E.2E.html#340987619">(Mar 10 2023 at 23:52)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5982#pullrequestreview-1335748555">PR review</a>.</p>



<a name="340987620"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235982%20x64%3A%20Improve%20memory%20support%20in%20%60%7Binse.../near/340987620" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235982.20x64.3A.20Improve.20memory.20support.20in.20.60.7Binse.2E.2E.2E.html#340987620">(Mar 10 2023 at 23:52)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5982#pullrequestreview-1335748555">PR review</a>.</p>



<a name="340987621"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235982%20x64%3A%20Improve%20memory%20support%20in%20%60%7Binse.../near/340987621" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235982.20x64.3A.20Improve.20memory.20support.20in.20.60.7Binse.2E.2E.2E.html#340987621">(Mar 10 2023 at 23:52)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/5982#discussion_r1132973563">PR review comment</a>:</p>
<blockquote>
<p>This is <code>0b11101110</code>... is that right?</p>
</blockquote>



<a name="340987622"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235982%20x64%3A%20Improve%20memory%20support%20in%20%60%7Binse.../near/340987622" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235982.20x64.3A.20Improve.20memory.20support.20in.20.60.7Binse.2E.2E.2E.html#340987622">(Mar 10 2023 at 23:52)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/5982#discussion_r1132975931">PR review comment</a>:</p>
<blockquote>
<p>Looking at the other cases, I started to worry that one of these instructions actually zeroes bits we do not want to zero. I think it is this case; from the <code>MOVSD</code> documentation:</p>
<blockquote>
<p>Legacy version: When the source and destination operands are XMM registers, bits MAXVL:64 of the destination operand remains unchanged. When the source operand is a memory location and destination operand is an XMM registers, the quadword at bits 127:64 of the destination operand is cleared to all 0s, bits MAXVL:128 of the destination operand remains unchanged.</p>
</blockquote>
<blockquote>
<p>VEX and EVEX encoded register-register syntax: Moves a scalar double precision floating-point value from the second source operand (the third operand) to the low quadword element of the destination operand (the first operand). Bits 127:64 of the destination operand are copied from the first source operand (the second operand). Bits (MAXVL-1:128) of the corresponding destination register are zeroed</p>
</blockquote>
<p>So it is the legacy SSE case where a <code>movsd 0(%rdi) ....</code> would zero too many bits but actually in the AVX code we could merge these two <code>vmovsd</code> into one. Is there a way to do that?</p>
</blockquote>



<a name="340987623"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235982%20x64%3A%20Improve%20memory%20support%20in%20%60%7Binse.../near/340987623" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235982.20x64.3A.20Improve.20memory.20support.20in.20.60.7Binse.2E.2E.2E.html#340987623">(Mar 10 2023 at 23:52)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/5982#discussion_r1132976182">PR review comment</a>:</p>
<blockquote>
<p>Missing comma after <code>$1</code>?</p>
</blockquote>



<a name="340987624"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235982%20x64%3A%20Improve%20memory%20support%20in%20%60%7Binse.../near/340987624" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235982.20x64.3A.20Improve.20memory.20support.20in.20.60.7Binse.2E.2E.2E.html#340987624">(Mar 10 2023 at 23:52)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/5982#discussion_r1132972126">PR review comment</a>:</p>
<blockquote>
<p>I checked and <code>u8_from_uimm8</code> does not guarantee that <code>n</code> is in the right range (e.g., 0 to 15 here). Did you see any validation that would prevent wrong <code>n</code> here at the CLIF level or do we rely exclusively on the Wasm-level construction? If there is nothing and it ends up being too tricky to do here in ISLE, maybe <code>emit.rs</code> could gain some <code>assert!</code>s or something like that.</p>
</blockquote>



<a name="340987625"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235982%20x64%3A%20Improve%20memory%20support%20in%20%60%7Binse.../near/340987625" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235982.20x64.3A.20Improve.20memory.20support.20in.20.60.7Binse.2E.2E.2E.html#340987625">(Mar 10 2023 at 23:52)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/5982#discussion_r1132976366">PR review comment</a>:</p>
<blockquote>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
</blockquote>



<a name="341002635"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235982%20x64%3A%20Improve%20memory%20support%20in%20%60%7Binse.../near/341002635" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235982.20x64.3A.20Improve.20memory.20support.20in.20.60.7Binse.2E.2E.2E.html#341002635">(Mar 11 2023 at 02:21)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5982#pullrequestreview-1335798290">PR review</a>.</p>



<a name="341002636"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235982%20x64%3A%20Improve%20memory%20support%20in%20%60%7Binse.../near/341002636" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235982.20x64.3A.20Improve.20memory.20support.20in.20.60.7Binse.2E.2E.2E.html#341002636">(Mar 11 2023 at 02:21)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/5982#discussion_r1133012340">PR review comment</a>:</p>
<blockquote>
<p>I think <a href="https://github.com/bytecodealliance/wasmtime/blob/9ed441e6575685e3c795ab4a504e7f90be01ce3e/cranelift/codegen/src/verifier/mod.rs#L1663-L1687">this is the block</a> in the verifier which validates that lanes are always inbounds, so I think we should be good on that front. I can add some extra asserts though to the backend too.</p>
</blockquote>



<a name="341002727"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235982%20x64%3A%20Improve%20memory%20support%20in%20%60%7Binse.../near/341002727" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235982.20x64.3A.20Improve.20memory.20support.20in.20.60.7Binse.2E.2E.2E.html#341002727">(Mar 11 2023 at 02:22)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5982#pullrequestreview-1335798490">PR review</a>.</p>



<a name="341002728"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235982%20x64%3A%20Improve%20memory%20support%20in%20%60%7Binse.../near/341002728" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235982.20x64.3A.20Improve.20memory.20support.20in.20.60.7Binse.2E.2E.2E.html#341002728">(Mar 11 2023 at 02:22)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/5982#discussion_r1133012467">PR review comment</a>:</p>
<blockquote>
<p>Indeed!</p>
</blockquote>



<a name="341003260"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235982%20x64%3A%20Improve%20memory%20support%20in%20%60%7Binse.../near/341003260" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235982.20x64.3A.20Improve.20memory.20support.20in.20.60.7Binse.2E.2E.2E.html#341003260">(Mar 11 2023 at 02:28)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5982#pullrequestreview-1335799243">PR review</a>.</p>



<a name="341003261"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235982%20x64%3A%20Improve%20memory%20support%20in%20%60%7Binse.../near/341003261" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235982.20x64.3A.20Improve.20memory.20support.20in.20.60.7Binse.2E.2E.2E.html#341003261">(Mar 11 2023 at 02:28)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/5982#discussion_r1133013295">PR review comment</a>:</p>
<blockquote>
<p>Going by <a href="https://www.felixcloutier.com/x86/movsd">this</a> which I realize isn't official but has been what I've been using so far, my read is that <code>VEX.128.F2.0F 11 /r: VMOVSD xmm1, xmm2, xmm3</code> has different semantics than <code>VEX.128.F2.0F 10 /r: VMOVSD xmm1, m64</code> so I think that AVX and SSE match here where if you use the register-to-register form it preserves the upper bits but if you use the memory-to-register form it always zeros the upper bits, so I don't think we can fuse?</p>
<p>I'll admit though that this is all real subtle and if the official docs are different I wouldn't be too surprised.</p>
</blockquote>



<a name="341003629"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235982%20x64%3A%20Improve%20memory%20support%20in%20%60%7Binse.../near/341003629" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235982.20x64.3A.20Improve.20memory.20support.20in.20.60.7Binse.2E.2E.2E.html#341003629">(Mar 11 2023 at 02:31)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5982">PR #5982</a> from <code>pextr</code> to <code>main</code>.</p>



<a name="341511778"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235982%20x64%3A%20Improve%20memory%20support%20in%20%60%7Binse.../near/341511778" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235982.20x64.3A.20Improve.20memory.20support.20in.20.60.7Binse.2E.2E.2E.html#341511778">(Mar 13 2023 at 16:27)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5982">PR #5982</a> from <code>pextr</code> to <code>main</code>.</p>



<a name="341565925"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235982%20x64%3A%20Improve%20memory%20support%20in%20%60%7Binse.../near/341565925" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235982.20x64.3A.20Improve.20memory.20support.20in.20.60.7Binse.2E.2E.2E.html#341565925">(Mar 13 2023 at 20:21)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/5982">PR #5982</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>