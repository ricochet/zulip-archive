<html>
<head><meta charset="utf-8"><title>wasmtime / PR #8837 wasmtime: Consume fuel on all return ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238837.20wasmtime.3A.20Consume.20fuel.20on.20all.20return.20.2E.2E.2E.html">wasmtime / PR #8837 wasmtime: Consume fuel on all return ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="445483234"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238837%20wasmtime%3A%20Consume%20fuel%20on%20all%20return%20.../near/445483234" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238837.20wasmtime.3A.20Consume.20fuel.20on.20all.20return.20.2E.2E.2E.html#445483234">(Jun 19 2024 at 00:17)</a>:</h4>
<p>jameysharp opened <a href="https://github.com/bytecodealliance/wasmtime/pull/8837">PR #8837</a> from <code>jameysharp:consume-fuel-on-return</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>As far as I can tell, when functions use a <code>return</code> instruction rather than falling off the end, fuel was not being tracked correctly. The <code>fuel_function_exit</code> method was only called from<br>
<code>after_translate_function</code>, which is only called once all the instructions in the function have been translated, not at each return.</p>
<p>In this commit I switched to calling <code>fuel_function_exit</code> from <code>handle_before_return</code> instead, alongside some of the <code>wmemcheck</code> hooks. That should ensure that it happens on every function exit, regardless of what form that exit takes.</p>
<p>I think <code>after_translate_function</code> is fundamentally difficult to use correctly, and it wasn't used for anything else, so I've also removed it in this commit. And I did a minor cleanup at the site of one of the calls to <code>handle_before_return</code> while I was looking at it.</p>
</blockquote>



<a name="445483235"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238837%20wasmtime%3A%20Consume%20fuel%20on%20all%20return%20.../near/445483235" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238837.20wasmtime.3A.20Consume.20fuel.20on.20all.20return.20.2E.2E.2E.html#445483235">(Jun 19 2024 at 00:17)</a>:</h4>
<p><strong>jameysharp</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8837">PR #8837</a>.</p>



<a name="445483236"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238837%20wasmtime%3A%20Consume%20fuel%20on%20all%20return%20.../near/445483236" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238837.20wasmtime.3A.20Consume.20fuel.20on.20all.20return.20.2E.2E.2E.html#445483236">(Jun 19 2024 at 00:17)</a>:</h4>
<p><strong>jameysharp</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8837">PR #8837</a>.</p>



<a name="445483237"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238837%20wasmtime%3A%20Consume%20fuel%20on%20all%20return%20.../near/445483237" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238837.20wasmtime.3A.20Consume.20fuel.20on.20all.20return.20.2E.2E.2E.html#445483237">(Jun 19 2024 at 00:17)</a>:</h4>
<p><strong>jameysharp</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8837">PR #8837</a>.</p>



<a name="445483416"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238837%20wasmtime%3A%20Consume%20fuel%20on%20all%20return%20.../near/445483416" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238837.20wasmtime.3A.20Consume.20fuel.20on.20all.20return.20.2E.2E.2E.html#445483416">(Jun 19 2024 at 00:19)</a>:</h4>
<p><strong>jameysharp</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8837">PR #8837</a>.</p>



<a name="445483482"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238837%20wasmtime%3A%20Consume%20fuel%20on%20all%20return%20.../near/445483482" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238837.20wasmtime.3A.20Consume.20fuel.20on.20all.20return.20.2E.2E.2E.html#445483482">(Jun 19 2024 at 00:20)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/8837#issuecomment-2177292001">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8837">PR #8837</a>:</p>
<blockquote>
<p>I think Nick's out for a few days so I'm handing this off to you instead, Alex.</p>
</blockquote>



<a name="445483732"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238837%20wasmtime%3A%20Consume%20fuel%20on%20all%20return%20.../near/445483732" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238837.20wasmtime.3A.20Consume.20fuel.20on.20all.20return.20.2E.2E.2E.html#445483732">(Jun 19 2024 at 00:24)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8837#pullrequestreview-2126764872">PR review</a>:</p>
<blockquote>
<p>Good catch! Mind adding a test or two <a href="https://github.com/bytecodealliance/wasmtime/blob/main/tests/all/fuel.wast">here as well</a>?</p>
</blockquote>



<a name="445508611"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238837%20wasmtime%3A%20Consume%20fuel%20on%20all%20return%20.../near/445508611" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238837.20wasmtime.3A.20Consume.20fuel.20on.20all.20return.20.2E.2E.2E.html#445508611">(Jun 19 2024 at 05:07)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/8837#issuecomment-2177754318">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8837">PR #8837</a>:</p>
<blockquote>
<p>Thanks for pointing me to those tests because I immediately got usefully confused about why the tests passed both before and after my changes.</p>
<p>It turns out that <code>fuel_save_from_var</code> is called by way of <code>before_translate_operator</code> for any of <code>unreachable</code>, <code>return</code>, or various kinds of calls. So doing it again in <code>handle_before_return</code> is unnecessary—and calling <code>fuel_save_from_var</code> multiple times is harmless but a waste of time—except when the return is an implicit fall-through off the end of the function. And that case is currently correctly handled by <code>after_translate_function</code>.</p>
<p>So the current implementation is not actually buggy!</p>
<p>But I still think the <code>after_translate_function</code> interface is sketchy. So I want to think more about what interface actually makes sense for instrumenting wasm translation like this, maybe drawing inspiration from <a href="https://github.com/titzer/wizard-engine/blob/6e52d99b8d326d42c1ed1050c0e509a2b5741da0/src/monitors/WhammMonitor.v3#L8-L29">whamm</a>. Perhaps for instrumentation purposes we should behave as if there's a <code>return</code> instruction after the end of every function…</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>