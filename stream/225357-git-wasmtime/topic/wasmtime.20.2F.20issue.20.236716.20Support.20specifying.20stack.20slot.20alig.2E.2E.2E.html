<html>
<head><meta charset="utf-8"><title>wasmtime / issue #6716 Support specifying stack slot alig... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236716.20Support.20specifying.20stack.20slot.20alig.2E.2E.2E.html">wasmtime / issue #6716 Support specifying stack slot alig...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="374719755"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236716%20Support%20specifying%20stack%20slot%20alig.../near/374719755" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236716.20Support.20specifying.20stack.20slot.20alig.2E.2E.2E.html#374719755">(Jul 12 2023 at 19:18)</a>:</h4>
<p>bjorn3 opened <a href="https://github.com/bytecodealliance/wasmtime/issues/6716">issue #6716</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>See title.</p>
<h4>Benefit</h4>
<p>Correct alignment are necessary to avoid crashes on some architectures and code may depend on correct alignment. In addition rustc checks that the right alignment is used when dereferencing a raw pointer in debug mode. This breaks rayon which allocates a stack value with cacheline alignment and then takes a raw pointer which it later dereferences. See <a href="https://github.com/bjorn3/rustc_codegen_cranelift/issues/1381">https://github.com/bjorn3/rustc_codegen_cranelift/issues/1381</a>.</p>
<h4>Implementation</h4>
<p>Sort stackslots by alignment for better packing and then add padding as necessary and if the alignment of a stack slot exceeds the ABI stack alignment realign the stack at runtime.</p>
<h4>Alternatives</h4>
<p>Doing dynamic alignment at runtime in the cranelift ir producer. This is slower and has higher stack usage overhead.</p>
</blockquote>



<a name="374719894"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236716%20Support%20specifying%20stack%20slot%20alig.../near/374719894" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236716.20Support.20specifying.20stack.20slot.20alig.2E.2E.2E.html#374719894">(Jul 12 2023 at 19:19)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/6716#issuecomment-1633082632">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6716">issue #6716</a>:</p>
<blockquote>
<p>Also necessary to fix <a href="https://github.com/bjorn3/rustc_codegen_cranelift/issues/1258">https://github.com/bjorn3/rustc_codegen_cranelift/issues/1258</a>.</p>
</blockquote>



<a name="439064359"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236716%20Support%20specifying%20stack%20slot%20alig.../near/439064359" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236716.20Support.20specifying.20stack.20slot.20alig.2E.2E.2E.html#439064359">(May 16 2024 at 17:02)</a>:</h4>
<p>cfallin closed <a href="https://github.com/bytecodealliance/wasmtime/issues/6716">issue #6716</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>See title.</p>
<h4>Benefit</h4>
<p>Correct alignment are necessary to avoid crashes on some architectures and code may depend on correct alignment. In addition rustc checks that the right alignment is used when dereferencing a raw pointer in debug mode. This breaks rayon which allocates a stack value with cacheline alignment and then takes a raw pointer which it later dereferences. See <a href="https://github.com/bjorn3/rustc_codegen_cranelift/issues/1381">https://github.com/bjorn3/rustc_codegen_cranelift/issues/1381</a>.</p>
<h4>Implementation</h4>
<p>Sort stackslots by alignment for better packing and then add padding as necessary and if the alignment of a stack slot exceeds the ABI stack alignment realign the stack at runtime.</p>
<h4>Alternatives</h4>
<p>Doing dynamic alignment at runtime in the cranelift ir producer. This is slower and has higher stack usage overhead.</p>
</blockquote>



<a name="439090514"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236716%20Support%20specifying%20stack%20slot%20alig.../near/439090514" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236716.20Support.20specifying.20stack.20slot.20alig.2E.2E.2E.html#439090514">(May 16 2024 at 19:51)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/6716#issuecomment-2116066403">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6716">issue #6716</a>:</p>
<blockquote>
<p>Would you mind reopening this? It hasn't been fully resolved yet: <a href="https://github.com/bytecodealliance/wasmtime/pull/8635/files#r1603954465">https://github.com/bytecodealliance/wasmtime/pull/8635/files#r1603954465</a></p>
</blockquote>



<a name="439102696"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236716%20Support%20specifying%20stack%20slot%20alig.../near/439102696" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236716.20Support.20specifying.20stack.20slot.20alig.2E.2E.2E.html#439102696">(May 16 2024 at 21:15)</a>:</h4>
<p>cfallin reopened <a href="https://github.com/bytecodealliance/wasmtime/issues/6716">issue #6716</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>See title.</p>
<h4>Benefit</h4>
<p>Correct alignment are necessary to avoid crashes on some architectures and code may depend on correct alignment. In addition rustc checks that the right alignment is used when dereferencing a raw pointer in debug mode. This breaks rayon which allocates a stack value with cacheline alignment and then takes a raw pointer which it later dereferences. See <a href="https://github.com/bjorn3/rustc_codegen_cranelift/issues/1381">https://github.com/bjorn3/rustc_codegen_cranelift/issues/1381</a>.</p>
<h4>Implementation</h4>
<p>Sort stackslots by alignment for better packing and then add padding as necessary and if the alignment of a stack slot exceeds the ABI stack alignment realign the stack at runtime.</p>
<h4>Alternatives</h4>
<p>Doing dynamic alignment at runtime in the cranelift ir producer. This is slower and has higher stack usage overhead.</p>
</blockquote>



<a name="439102700"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236716%20Support%20specifying%20stack%20slot%20alig.../near/439102700" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236716.20Support.20specifying.20stack.20slot.20alig.2E.2E.2E.html#439102700">(May 16 2024 at 21:15)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/6716#issuecomment-2116198518">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6716">issue #6716</a>:</p>
<blockquote>
<p>Sure; to summarize here, the issue is that alignment is now correct with respect to the start of stack frame, but start of stack frame is only aligned as per ABI (e.g. 16 bytes on x86-64 and aarch64) so we need to dynamically align SP (it must be dynamic).</p>
</blockquote>



<a name="439102748"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236716%20Support%20specifying%20stack%20slot%20alig.../near/439102748" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236716.20Support.20specifying.20stack.20slot.20alig.2E.2E.2E.html#439102748">(May 16 2024 at 21:15)</a>:</h4>
<p>cfallin edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/6716#issuecomment-2116198518">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6716">issue #6716</a>:</p>
<blockquote>
<p>Sure; to summarize here, the issue is that alignment is now correct with respect to the start of stack frame, but start of stack frame is only aligned as per ABI (e.g. 16 bytes on x86-64 and aarch64) so we need to dynamically align SP (it must be dynamic, we can't know statically anything more than the ABI guarantee).</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>