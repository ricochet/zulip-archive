<html>
<head><meta charset="utf-8"><title>wasmtime / PR #8795 Add a compile-time feature for call h... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238795.20Add.20a.20compile-time.20feature.20for.20call.20h.2E.2E.2E.html">wasmtime / PR #8795 Add a compile-time feature for call h...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="444547219"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238795%20Add%20a%20compile-time%20feature%20for%20call%20h.../near/444547219" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238795.20Add.20a.20compile-time.20feature.20for.20call.20h.2E.2E.2E.html#444547219">(Jun 13 2024 at 19:38)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/8795">PR #8795</a> from <code>alexcrichton:gate-call-hook</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This commit moves the <code>Store::call_hook</code> API behind a Cargo feature named <code>call-hook</code>. This helps speed up the path from wasm into the host by avoiding branches at the start and the end of the execution. In a thread on [Zulip] this is locally leading to significant performance gains in this particular microbenchmark so having an option to disable it at the crate layer seems like a reasonable way to thread this needle for now. This definitely has a downside in that it requires a crate feature at all, but I'm not sure of a better solution as LLVM can't dynamically detect that <code>Store::call_hook</code> is never invoked and therefore the branch can be optimized away.</p>
<p>[Zulip]: <a href="#narrow/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65/near/444505571">https://bytecodealliance.zulipchat.com/#narrow/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65/near/444505571</a></p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="444547222"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238795%20Add%20a%20compile-time%20feature%20for%20call%20h.../near/444547222" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238795.20Add.20a.20compile-time.20feature.20for.20call.20h.2E.2E.2E.html#444547222">(Jun 13 2024 at 19:38)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8795">PR #8795</a>.</p>



<a name="444547223"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238795%20Add%20a%20compile-time%20feature%20for%20call%20h.../near/444547223" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238795.20Add.20a.20compile-time.20feature.20for.20call.20h.2E.2E.2E.html#444547223">(Jun 13 2024 at 19:38)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8795">PR #8795</a>.</p>



<a name="444547744"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238795%20Add%20a%20compile-time%20feature%20for%20call%20h.../near/444547744" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238795.20Add.20a.20compile-time.20feature.20for.20call.20h.2E.2E.2E.html#444547744">(Jun 13 2024 at 19:41)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8795#pullrequestreview-2116767550">PR review</a>.</p>



<a name="444548196"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238795%20Add%20a%20compile-time%20feature%20for%20call%20h.../near/444548196" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238795.20Add.20a.20compile-time.20feature.20for.20call.20h.2E.2E.2E.html#444548196">(Jun 13 2024 at 19:44)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8795">PR #8795</a>.</p>



<a name="444549106"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238795%20Add%20a%20compile-time%20feature%20for%20call%20h.../near/444549106" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238795.20Add.20a.20compile-time.20feature.20for.20call.20h.2E.2E.2E.html#444549106">(Jun 13 2024 at 19:50)</a>:</h4>
<p>alexcrichton has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/8795">PR #8795</a>.</p>



<a name="444551817"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238795%20Add%20a%20compile-time%20feature%20for%20call%20h.../near/444551817" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238795.20Add.20a.20compile-time.20feature.20for.20call.20h.2E.2E.2E.html#444551817">(Jun 13 2024 at 20:06)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/8795">PR #8795</a>.</p>



<a name="444567881"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238795%20Add%20a%20compile-time%20feature%20for%20call%20h.../near/444567881" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238795.20Add.20a.20compile-time.20feature.20for.20call.20h.2E.2E.2E.html#444567881">(Jun 13 2024 at 21:39)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/pull/8795#issuecomment-2166840673">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8795">PR #8795</a>:</p>
<blockquote>
<p>I think this is the correct choice - needing call hooks at all is a pretty particular need, and I'd even be fine if this feature was not enabled by default. Have we surveyed if anyone besides Fastly's embedding even makes use of it?</p>
</blockquote>



<a name="444567920"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238795%20Add%20a%20compile-time%20feature%20for%20call%20h.../near/444567920" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238795.20Add.20a.20compile-time.20feature.20for.20call.20h.2E.2E.2E.html#444567920">(Jun 13 2024 at 21:39)</a>:</h4>
<p>pchickey edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/8795#issuecomment-2166840673">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8795">PR #8795</a>:</p>
<blockquote>
<p>I think this is the correct choice - call hooks fill a pretty particular need, and I'd even be fine if this feature was not enabled by default. Have we surveyed if anyone besides Fastly's embedding even makes use of it?</p>
</blockquote>



<a name="444568261"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238795%20Add%20a%20compile-time%20feature%20for%20call%20h.../near/444568261" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238795.20Add.20a.20compile-time.20feature.20for.20call.20h.2E.2E.2E.html#444568261">(Jun 13 2024 at 21:42)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/8795#issuecomment-2166843948">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8795">PR #8795</a>:</p>
<blockquote>
<p>I haven't surveyed myself but carrying a Cargo feature for it isn't too bad. Most of our Cargo features have been relatively low overhead to maintain so far. The main question to me is that this might be an appropriate feature to be off-by-default instead of on-by-default as it can affect benchmarks, but even then it's pretty rare anyone benchmarks host-to-wasm calls or vice versa, most benchmarking is just of the wasm itself.</p>
</blockquote>



<a name="444660661"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238795%20Add%20a%20compile-time%20feature%20for%20call%20h.../near/444660661" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238795.20Add.20a.20compile-time.20feature.20for.20call.20h.2E.2E.2E.html#444660661">(Jun 14 2024 at 09:42)</a>:</h4>
<p>tschneidereit <a href="https://github.com/bytecodealliance/wasmtime/pull/8795#issuecomment-2167654638">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8795">PR #8795</a>:</p>
<blockquote>
<p>I think regardless of who might encounter this in benchmarks, as long it's not essentially always used, it makes sense to disable by default: we should keep the call overhead low wherever we can, after all, and requiring people to disable very specific features for best performance doesn't seem great to me. </p>
</blockquote>



<a name="444720274"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238795%20Add%20a%20compile-time%20feature%20for%20call%20h.../near/444720274" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238795.20Add.20a.20compile-time.20feature.20for.20call.20h.2E.2E.2E.html#444720274">(Jun 14 2024 at 15:06)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/8795#issuecomment-2168236809">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8795">PR #8795</a>:</p>
<blockquote>
<p>I can try to investigate this a bit. I believe the <code>gc</code> feature has a much larger impact than call-hooks in terms of performance. I haven't bottomed that out but disabling <code>gc</code>-by-default I think would be much more significant than disabling <code>call-hook</code> by default.</p>
</blockquote>



<a name="444724297"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238795%20Add%20a%20compile-time%20feature%20for%20call%20h.../near/444724297" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238795.20Add.20a.20compile-time.20feature.20for.20call.20h.2E.2E.2E.html#444724297">(Jun 14 2024 at 15:25)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/8795#issuecomment-2168269045">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8795">PR #8795</a>:</p>
<blockquote>
<p>Measuring locally from the benchmark from Zulip, which is very heavy in wasm-&gt;host calls and the host call itself does nothing, enabling the <code>gc</code> feature of Wasmtime yields a slowdown of 3.5x and enabling the <code>call-hook</code> feature slows down only 30%. </p>
<p>Put another way I don't think it's worth over-rotating too much on <code>call-hook</code>, <code>gc</code> is the main feature that's causing a slowdown.</p>
</blockquote>



<a name="444760346"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238795%20Add%20a%20compile-time%20feature%20for%20call%20h.../near/444760346" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238795.20Add.20a.20compile-time.20feature.20for.20call.20h.2E.2E.2E.html#444760346">(Jun 14 2024 at 18:07)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/8795#issuecomment-2168522191">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8795">PR #8795</a>:</p>
<blockquote>
<p>With <a href="https://github.com/bytecodealliance/wasmtime/pull/8807">https://github.com/bytecodealliance/wasmtime/pull/8807</a> the performance is on-par now with the <code>gc</code> feature enabled, so I'll follow that up by disabling the <code>call-hook</code> feature by default.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>