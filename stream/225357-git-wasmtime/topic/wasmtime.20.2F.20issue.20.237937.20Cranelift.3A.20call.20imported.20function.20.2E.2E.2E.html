<html>
<head><meta charset="utf-8"><title>wasmtime / issue #7937 Cranelift: call imported function ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237937.20Cranelift.3A.20call.20imported.20function.20.2E.2E.2E.html">wasmtime / issue #7937 Cranelift: call imported function ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="421444324"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237937%20Cranelift%3A%20call%20imported%20function%20.../near/421444324" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237937.20Cranelift.3A.20call.20imported.20function.20.2E.2E.2E.html#421444324">(Feb 14 2024 at 13:27)</a>:</h4>
<p>meijies opened <a href="https://github.com/bytecodealliance/wasmtime/issues/7937">issue #7937</a>:</p>
<blockquote>
<p>Hi everyone.</p>
<h3>summary</h3>
<p>This is asking for help/advices. I am trying generate a func named "call" and it will call a rust function named "add_wrapper". the signature of add_wrapper is <code>extern "C" fn add_wrapper(lhs: *mut dyn Datum, rhs: *mut dyn Datum) -&gt; *const ArrayRef</code>.  When I debug the test case, a "signal SIGSEGV" occurs <strong>at second println statement of add_wrapper function</strong>!</p>
<h3>test code.</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">arrow</span>::<span class="p">{</span>
<span class="w">    </span><span class="n">array</span>::<span class="p">{</span><span class="n">Array</span><span class="p">,</span><span class="w"> </span><span class="n">ArrayRef</span><span class="p">,</span><span class="w"> </span><span class="n">Datum</span><span class="p">,</span><span class="w"> </span><span class="n">Int32Array</span><span class="p">},</span>
<span class="w">    </span><span class="n">compute</span>::<span class="n">kernels</span>::<span class="n">numeric</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="p">{</span><span class="n">codegen</span>::<span class="n">ir</span>::<span class="n">UserFuncName</span><span class="p">,</span><span class="w"> </span><span class="n">prelude</span>::<span class="o">*</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_jit</span>::<span class="p">{</span><span class="n">JITBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">JITModule</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_module</span>::<span class="p">{</span><span class="n">DataDescription</span><span class="p">,</span><span class="w"> </span><span class="n">Linkage</span><span class="p">,</span><span class="w"> </span><span class="n">Module</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span><span class="p">;</span>

<span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="k">struct</span> <span class="nc">JIT</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">func_ctx</span>: <span class="nc">FunctionBuilderContext</span><span class="p">,</span>
<span class="w">    </span><span class="n">ctx</span>: <span class="nc">codegen</span>::<span class="n">Context</span><span class="p">,</span>
<span class="w">    </span><span class="n">data_description</span>: <span class="nc">DataDescription</span><span class="p">,</span>
<span class="w">    </span><span class="n">module</span>: <span class="nc">JITModule</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">add_wrapper</span><span class="p">(</span><span class="n">lhs</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="p">,</span><span class="w"> </span><span class="n">rhs</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">ArrayRef</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">lhs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">from_raw</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rhs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">from_raw</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">l_scalar</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lhs</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">r_scalar</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rhs</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}, {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">l</span><span class="p">.</span><span class="n">data_type</span><span class="p">(),</span><span class="w"> </span><span class="n">l_scalar</span><span class="p">);</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}, {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">data_type</span><span class="p">(),</span><span class="w"> </span><span class="n">r_scalar</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numeric</span>::<span class="n">add</span><span class="p">(</span><span class="n">lhs</span><span class="p">.</span><span class="n">as_ref</span><span class="p">(),</span><span class="w"> </span><span class="n">rhs</span><span class="p">.</span><span class="n">as_ref</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">res</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">ArrayRef</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="nb">Default</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">JIT</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">default</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">flag_builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span>::<span class="n">builder</span><span class="p">();</span>
<span class="w">        </span><span class="n">flag_builder</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="s">"use_colocated_libcalls"</span><span class="p">,</span><span class="w"> </span><span class="s">"false"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="n">flag_builder</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="s">"is_pic"</span><span class="p">,</span><span class="w"> </span><span class="s">"false"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// build isa</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">isa_builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cranelift_native</span>::<span class="n">builder</span><span class="p">().</span><span class="n">unwrap_or_else</span><span class="p">(</span><span class="o">|</span><span class="n">msg</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="fm">panic!</span><span class="p">(</span><span class="s">"host machine is not supported: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">isa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isa_builder</span>
<span class="w">            </span><span class="p">.</span><span class="n">finish</span><span class="p">(</span><span class="n">settings</span>::<span class="n">Flags</span>::<span class="n">new</span><span class="p">(</span><span class="n">flag_builder</span><span class="p">))</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// build module</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JITBuilder</span>::<span class="n">with_isa</span><span class="p">(</span><span class="n">isa</span><span class="p">,</span><span class="w"> </span><span class="n">cranelift_module</span>::<span class="n">default_libcall_names</span><span class="p">());</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">addr</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">add_wrapper</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">;</span>
<span class="w">        </span><span class="n">builder</span><span class="p">.</span><span class="n">symbol</span><span class="p">(</span><span class="s">"add"</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JITModule</span>::<span class="n">new</span><span class="p">(</span><span class="n">builder</span><span class="p">);</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">func_ctx</span>: <span class="nc">FunctionBuilderContext</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">ctx</span>: <span class="nc">module</span><span class="p">.</span><span class="n">make_context</span><span class="p">(),</span>
<span class="w">            </span><span class="n">data_description</span>: <span class="nc">DataDescription</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">module</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">JIT</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">compile</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">sig_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">make_signature</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">target_config</span><span class="p">().</span><span class="n">pointer_type</span><span class="p">();</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">sig_add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">make_signature</span><span class="p">();</span>
<span class="w">        </span><span class="n">sig_add</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="n">sig_add</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="n">sig_add</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">func_add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span>
<span class="w">            </span><span class="p">.</span><span class="n">module</span>
<span class="w">            </span><span class="p">.</span><span class="n">declare_function</span><span class="p">(</span><span class="s">"add"</span><span class="p">,</span><span class="w"> </span><span class="n">Linkage</span>::<span class="n">Import</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sig_add</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="n">sig_call</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="n">sig_call</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="n">sig_call</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">func_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span>
<span class="w">            </span><span class="p">.</span><span class="n">module</span>
<span class="w">            </span><span class="p">.</span><span class="n">declare_function</span><span class="p">(</span><span class="s">"call"</span><span class="p">,</span><span class="w"> </span><span class="n">Linkage</span>::<span class="n">Local</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sig_call</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">signature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sig_call</span><span class="p">;</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UserFuncName</span>::<span class="n">user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">func_call</span><span class="p">.</span><span class="n">as_u32</span><span class="p">());</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">func_builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionBuilder</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span><span class="p">.</span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">func_ctx</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">ebb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">create_block</span><span class="p">();</span>
<span class="w">            </span><span class="n">func_builder</span><span class="p">.</span><span class="n">switch_to_block</span><span class="p">(</span><span class="n">ebb</span><span class="p">);</span>
<span class="w">            </span><span class="n">func_builder</span><span class="p">.</span><span class="n">append_block_params_for_function_params</span><span class="p">(</span><span class="n">ebb</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">func_add_local</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span>
<span class="w">                </span><span class="p">.</span><span class="n">module</span>
<span class="w">                </span><span class="p">.</span><span class="n">declare_func_in_func</span><span class="p">(</span><span class="n">func_add</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">func</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">lhs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">block_params</span><span class="p">(</span><span class="n">ebb</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">rhs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">block_params</span><span class="p">(</span><span class="n">ebb</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">call</span><span class="p">(</span><span class="n">func_add_local</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">lhs</span><span class="p">,</span><span class="w"> </span><span class="n">rhs</span><span class="p">]);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">inst_results</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>
<span class="w">                </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">len</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">                </span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">clone</span><span class="p">()</span>
<span class="w">            </span><span class="p">};</span>
<span class="w">            </span><span class="n">func_builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">return_</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="n">value</span><span class="p">]);</span>
<span class="w">            </span><span class="n">func_builder</span><span class="p">.</span><span class="n">seal_all_blocks</span><span class="p">();</span>
<span class="w">            </span><span class="n">func_builder</span><span class="p">.</span><span class="n">finalize</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span>
<span class="w">            </span><span class="p">.</span><span class="n">define_function</span><span class="p">(</span><span class="n">func_call</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">clear_context</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span><span class="p">);</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">finalize_definitions</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">code_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">get_finalized_function</span><span class="p">(</span><span class="n">func_call</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">mem</span>::<span class="n">transmute</span>::<span class="o">&lt;</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">ArrayRef</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">                </span><span class="n">code_call</span><span class="p">,</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Int32Array</span>::<span class="n">from</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">]);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">a2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Int32Array</span>::<span class="n">from</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">]);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">a2</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="p">);</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[cfg(test)]</span>
<span class="k">mod</span> <span class="nn">tests</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span>::<span class="n">JIT</span><span class="p">;</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">test_jit</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">jit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JIT</span>::<span class="n">default</span><span class="p">();</span>
<span class="w">        </span><span class="n">jit</span><span class="p">.</span><span class="n">compile</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3>debug info.</h3>
<p>&lt;img width="1652" alt="Screenshot 2024-02-14 at 21 23 54" src="<a href="https://github.com/bytecodealliance/wasmtime/assets/13784260/9807365d-63d0-421e-b403-1825b7cf2965">https://github.com/bytecodealliance/wasmtime/assets/13784260/9807365d-63d0-421e-b403-1825b7cf2965</a>"&gt;</p>
</blockquote>



<a name="421447740"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237937%20Cranelift%3A%20call%20imported%20function%20.../near/421447740" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237937.20Cranelift.3A.20call.20imported.20function.20.2E.2E.2E.html#421447740">(Feb 14 2024 at 13:45)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/7937#issuecomment-1943800840">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7937">issue #7937</a>:</p>
<blockquote>
<p>Trait objects don't have a stable abi. Current rustc will pass it as two arguments rather than one. One fix here would be to do pass <code>*mut *mut dyn Datum</code> or <code>*mut Box&lt;dyn Datum&gt;</code> instead. (double indirection such that the outer pointer is a  thin pointer)</p>
</blockquote>



<a name="421474373"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237937%20Cranelift%3A%20call%20imported%20function%20.../near/421474373" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237937.20Cranelift.3A.20call.20imported.20function.20.2E.2E.2E.html#421474373">(Feb 14 2024 at 15:46)</a>:</h4>
<p>meijies closed <a href="https://github.com/bytecodealliance/wasmtime/issues/7937">issue #7937</a>:</p>
<blockquote>
<p>Hi everyone.</p>
<h3>summary</h3>
<p>This is asking for help/advices. I am trying generate a func named "call" and it will call a rust function named "add_wrapper". the signature of add_wrapper is <code>extern "C" fn add_wrapper(lhs: *mut dyn Datum, rhs: *mut dyn Datum) -&gt; *const ArrayRef</code>.  When I debug the test case, a "signal SIGSEGV" occurs <strong>at second println statement of add_wrapper function</strong>!</p>
<h3>test code.</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">arrow</span>::<span class="p">{</span>
<span class="w">    </span><span class="n">array</span>::<span class="p">{</span><span class="n">Array</span><span class="p">,</span><span class="w"> </span><span class="n">ArrayRef</span><span class="p">,</span><span class="w"> </span><span class="n">Datum</span><span class="p">,</span><span class="w"> </span><span class="n">Int32Array</span><span class="p">},</span>
<span class="w">    </span><span class="n">compute</span>::<span class="n">kernels</span>::<span class="n">numeric</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="p">{</span><span class="n">codegen</span>::<span class="n">ir</span>::<span class="n">UserFuncName</span><span class="p">,</span><span class="w"> </span><span class="n">prelude</span>::<span class="o">*</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_jit</span>::<span class="p">{</span><span class="n">JITBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">JITModule</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_module</span>::<span class="p">{</span><span class="n">DataDescription</span><span class="p">,</span><span class="w"> </span><span class="n">Linkage</span><span class="p">,</span><span class="w"> </span><span class="n">Module</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span><span class="p">;</span>

<span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="k">struct</span> <span class="nc">JIT</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">func_ctx</span>: <span class="nc">FunctionBuilderContext</span><span class="p">,</span>
<span class="w">    </span><span class="n">ctx</span>: <span class="nc">codegen</span>::<span class="n">Context</span><span class="p">,</span>
<span class="w">    </span><span class="n">data_description</span>: <span class="nc">DataDescription</span><span class="p">,</span>
<span class="w">    </span><span class="n">module</span>: <span class="nc">JITModule</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">add_wrapper</span><span class="p">(</span><span class="n">lhs</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="p">,</span><span class="w"> </span><span class="n">rhs</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">ArrayRef</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">lhs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">from_raw</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rhs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">from_raw</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">l_scalar</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lhs</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">r_scalar</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rhs</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}, {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">l</span><span class="p">.</span><span class="n">data_type</span><span class="p">(),</span><span class="w"> </span><span class="n">l_scalar</span><span class="p">);</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}, {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">data_type</span><span class="p">(),</span><span class="w"> </span><span class="n">r_scalar</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numeric</span>::<span class="n">add</span><span class="p">(</span><span class="n">lhs</span><span class="p">.</span><span class="n">as_ref</span><span class="p">(),</span><span class="w"> </span><span class="n">rhs</span><span class="p">.</span><span class="n">as_ref</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">res</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">ArrayRef</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="nb">Default</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">JIT</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">default</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">flag_builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span>::<span class="n">builder</span><span class="p">();</span>
<span class="w">        </span><span class="n">flag_builder</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="s">"use_colocated_libcalls"</span><span class="p">,</span><span class="w"> </span><span class="s">"false"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="n">flag_builder</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="s">"is_pic"</span><span class="p">,</span><span class="w"> </span><span class="s">"false"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// build isa</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">isa_builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cranelift_native</span>::<span class="n">builder</span><span class="p">().</span><span class="n">unwrap_or_else</span><span class="p">(</span><span class="o">|</span><span class="n">msg</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="fm">panic!</span><span class="p">(</span><span class="s">"host machine is not supported: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">isa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isa_builder</span>
<span class="w">            </span><span class="p">.</span><span class="n">finish</span><span class="p">(</span><span class="n">settings</span>::<span class="n">Flags</span>::<span class="n">new</span><span class="p">(</span><span class="n">flag_builder</span><span class="p">))</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// build module</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JITBuilder</span>::<span class="n">with_isa</span><span class="p">(</span><span class="n">isa</span><span class="p">,</span><span class="w"> </span><span class="n">cranelift_module</span>::<span class="n">default_libcall_names</span><span class="p">());</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">addr</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">add_wrapper</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">;</span>
<span class="w">        </span><span class="n">builder</span><span class="p">.</span><span class="n">symbol</span><span class="p">(</span><span class="s">"add"</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JITModule</span>::<span class="n">new</span><span class="p">(</span><span class="n">builder</span><span class="p">);</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">func_ctx</span>: <span class="nc">FunctionBuilderContext</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">ctx</span>: <span class="nc">module</span><span class="p">.</span><span class="n">make_context</span><span class="p">(),</span>
<span class="w">            </span><span class="n">data_description</span>: <span class="nc">DataDescription</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">module</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">JIT</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">compile</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">sig_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">make_signature</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">target_config</span><span class="p">().</span><span class="n">pointer_type</span><span class="p">();</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">sig_add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">make_signature</span><span class="p">();</span>
<span class="w">        </span><span class="n">sig_add</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="n">sig_add</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="n">sig_add</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">func_add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span>
<span class="w">            </span><span class="p">.</span><span class="n">module</span>
<span class="w">            </span><span class="p">.</span><span class="n">declare_function</span><span class="p">(</span><span class="s">"add"</span><span class="p">,</span><span class="w"> </span><span class="n">Linkage</span>::<span class="n">Import</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sig_add</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="n">sig_call</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="n">sig_call</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="n">sig_call</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">func_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span>
<span class="w">            </span><span class="p">.</span><span class="n">module</span>
<span class="w">            </span><span class="p">.</span><span class="n">declare_function</span><span class="p">(</span><span class="s">"call"</span><span class="p">,</span><span class="w"> </span><span class="n">Linkage</span>::<span class="n">Local</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sig_call</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">signature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sig_call</span><span class="p">;</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UserFuncName</span>::<span class="n">user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">func_call</span><span class="p">.</span><span class="n">as_u32</span><span class="p">());</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">func_builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionBuilder</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span><span class="p">.</span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">func_ctx</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">ebb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">create_block</span><span class="p">();</span>
<span class="w">            </span><span class="n">func_builder</span><span class="p">.</span><span class="n">switch_to_block</span><span class="p">(</span><span class="n">ebb</span><span class="p">);</span>
<span class="w">            </span><span class="n">func_builder</span><span class="p">.</span><span class="n">append_block_params_for_function_params</span><span class="p">(</span><span class="n">ebb</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">func_add_local</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span>
<span class="w">                </span><span class="p">.</span><span class="n">module</span>
<span class="w">                </span><span class="p">.</span><span class="n">declare_func_in_func</span><span class="p">(</span><span class="n">func_add</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">func</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">lhs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">block_params</span><span class="p">(</span><span class="n">ebb</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">rhs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">block_params</span><span class="p">(</span><span class="n">ebb</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">call</span><span class="p">(</span><span class="n">func_add_local</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">lhs</span><span class="p">,</span><span class="w"> </span><span class="n">rhs</span><span class="p">]);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">inst_results</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>
<span class="w">                </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">len</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">                </span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">clone</span><span class="p">()</span>
<span class="w">            </span><span class="p">};</span>
<span class="w">            </span><span class="n">func_builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">return_</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="n">value</span><span class="p">]);</span>
<span class="w">            </span><span class="n">func_builder</span><span class="p">.</span><span class="n">seal_all_blocks</span><span class="p">();</span>
<span class="w">            </span><span class="n">func_builder</span><span class="p">.</span><span class="n">finalize</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span>
<span class="w">            </span><span class="p">.</span><span class="n">define_function</span><span class="p">(</span><span class="n">func_call</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">clear_context</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span><span class="p">);</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">finalize_definitions</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">code_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">get_finalized_function</span><span class="p">(</span><span class="n">func_call</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">mem</span>::<span class="n">transmute</span>::<span class="o">&lt;</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">ArrayRef</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">                </span><span class="n">code_call</span><span class="p">,</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Int32Array</span>::<span class="n">from</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">]);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">a2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Int32Array</span>::<span class="n">from</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">]);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">a2</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="p">);</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[cfg(test)]</span>
<span class="k">mod</span> <span class="nn">tests</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span>::<span class="n">JIT</span><span class="p">;</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">test_jit</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">jit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JIT</span>::<span class="n">default</span><span class="p">();</span>
<span class="w">        </span><span class="n">jit</span><span class="p">.</span><span class="n">compile</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3>debug info.</h3>
<p>&lt;img width="1652" alt="Screenshot 2024-02-14 at 21 23 54" src="<a href="https://github.com/bytecodealliance/wasmtime/assets/13784260/9807365d-63d0-421e-b403-1825b7cf2965">https://github.com/bytecodealliance/wasmtime/assets/13784260/9807365d-63d0-421e-b403-1825b7cf2965</a>"&gt;</p>
</blockquote>



<a name="421494305"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237937%20Cranelift%3A%20call%20imported%20function%20.../near/421494305" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237937.20Cranelift.3A.20call.20imported.20function.20.2E.2E.2E.html#421494305">(Feb 14 2024 at 17:19)</a>:</h4>
<p>meijies <a href="https://github.com/bytecodealliance/wasmtime/issues/7937#issuecomment-1944271595">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7937">issue #7937</a>:</p>
<blockquote>
<p>@bjorn3 Thanks, but I meet another issue, the return result of jit generated func is different from add_wrapper and  it seems to point to an invalid address <code>{pointer:0x0000000000000070, vtable:(0) &amp;[]}</code>. </p>
<h3>updated code.</h3>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">arrow</span>::<span class="p">{</span>
<span class="w">    </span><span class="n">array</span>::<span class="p">{</span><span class="n">Array</span><span class="p">,</span><span class="w"> </span><span class="n">ArrayRef</span><span class="p">,</span><span class="w"> </span><span class="n">Datum</span><span class="p">,</span><span class="w"> </span><span class="n">Int32Array</span><span class="p">},</span>
<span class="w">    </span><span class="n">compute</span>::<span class="n">kernels</span>::<span class="n">numeric</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="p">{</span><span class="n">codegen</span>::<span class="n">ir</span>::<span class="n">UserFuncName</span><span class="p">,</span><span class="w"> </span><span class="n">prelude</span>::<span class="o">*</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_jit</span>::<span class="p">{</span><span class="n">JITBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">JITModule</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_module</span>::<span class="p">{</span><span class="n">DataDescription</span><span class="p">,</span><span class="w"> </span><span class="n">Linkage</span><span class="p">,</span><span class="w"> </span><span class="n">Module</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="p">{</span>
<span class="w">    </span><span class="n">mem</span>::<span class="p">{</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">forget</span><span class="p">},</span>
<span class="w">    </span><span class="n">sync</span>::<span class="n">Arc</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="k">struct</span> <span class="nc">JIT</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">func_ctx</span>: <span class="nc">FunctionBuilderContext</span><span class="p">,</span>
<span class="w">    </span><span class="n">ctx</span>: <span class="nc">codegen</span>::<span class="n">Context</span><span class="p">,</span>
<span class="w">    </span><span class="n">data_description</span>: <span class="nc">DataDescription</span><span class="p">,</span>
<span class="w">    </span><span class="n">module</span>: <span class="nc">JITModule</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">add_wrapper</span><span class="p">(</span>
<span class="w">    </span><span class="n">lhs</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">rhs</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Array</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">lhs_ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">lhs</span><span class="p">.</span><span class="n">read</span><span class="p">()</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rhs_ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">rhs</span><span class="p">.</span><span class="n">read</span><span class="p">()</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numeric</span>::<span class="n">add</span><span class="p">(</span><span class="n">lhs_ref</span><span class="p">.</span><span class="n">as_ref</span><span class="p">(),</span><span class="w"> </span><span class="n">rhs_ref</span><span class="p">.</span><span class="n">as_ref</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">.</span><span class="n">clone</span><span class="p">());</span>
<span class="w">    </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">ArrayRef</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="nb">Default</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">JIT</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">default</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">flag_builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span>::<span class="n">builder</span><span class="p">();</span>
<span class="w">        </span><span class="n">flag_builder</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="s">"use_colocated_libcalls"</span><span class="p">,</span><span class="w"> </span><span class="s">"false"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="n">flag_builder</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="s">"is_pic"</span><span class="p">,</span><span class="w"> </span><span class="s">"false"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// build isa</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">isa_builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cranelift_native</span>::<span class="n">builder</span><span class="p">().</span><span class="n">unwrap_or_else</span><span class="p">(</span><span class="o">|</span><span class="n">msg</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="fm">panic!</span><span class="p">(</span><span class="s">"host machine is not supported: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">isa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isa_builder</span>
<span class="w">            </span><span class="p">.</span><span class="n">finish</span><span class="p">(</span><span class="n">settings</span>::<span class="n">Flags</span>::<span class="n">new</span><span class="p">(</span><span class="n">flag_builder</span><span class="p">))</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// build module</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JITBuilder</span>::<span class="n">with_isa</span><span class="p">(</span><span class="n">isa</span><span class="p">,</span><span class="w"> </span><span class="n">cranelift_module</span>::<span class="n">default_libcall_names</span><span class="p">());</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">addr</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">add_wrapper</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">;</span>
<span class="w">        </span><span class="n">builder</span><span class="p">.</span><span class="n">symbol</span><span class="p">(</span><span class="s">"add"</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JITModule</span>::<span class="n">new</span><span class="p">(</span><span class="n">builder</span><span class="p">);</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">func_ctx</span>: <span class="nc">FunctionBuilderContext</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">ctx</span>: <span class="nc">module</span><span class="p">.</span><span class="n">make_context</span><span class="p">(),</span>
<span class="w">            </span><span class="n">data_description</span>: <span class="nc">DataDescription</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">module</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">JIT</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">compile</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">sig_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">make_signature</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">target_config</span><span class="p">().</span><span class="n">pointer_type</span><span class="p">();</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">sig_add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">make_signature</span><span class="p">();</span>
<span class="w">        </span><span class="n">sig_add</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="n">sig_add</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="n">sig_add</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">func_add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span>
<span class="w">            </span><span class="p">.</span><span class="n">module</span>
<span class="w">            </span><span class="p">.</span><span class="n">declare_function</span><span class="p">(</span><span class="s">"add"</span><span class="p">,</span><span class="w"> </span><span class="n">Linkage</span>::<span class="n">Import</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sig_add</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="n">sig_call</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="n">sig_call</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="n">sig_call</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">func_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span>
<span class="w">            </span><span class="p">.</span><span class="n">module</span>
<span class="w">            </span><span class="p">.</span><span class="n">declare_function</span><span class="p">(</span><span class="s">"call"</span><span class="p">,</span><span class="w"> </span><span class="n">Linkage</span>::<span class="n">Local</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sig_call</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">signature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sig_call</span><span class="p">;</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UserFuncName</span>::<span class="n">user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">func_call</span><span class="p">.</span><span class="n">as_u32</span><span class="p">());</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">func_builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionBuilder</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span><span class="p">.</span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">func_ctx</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">ebb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">create_block</span><span class="p">();</span>
<span class="w">            </span><span class="n">func_builder</span><span class="p">.</span><span class="n">switch_to_block</span><span class="p">(</span><span class="n">ebb</span><span class="p">);</span>
<span class="w">            </span><span class="n">func_builder</span><span class="p">.</span><span class="n">append_block_params_for_function_params</span><span class="p">(</span><span class="n">ebb</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">func_add_local</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span>
<span class="w">                </span><span class="p">.</span><span class="n">module</span>
<span class="w">                </span><span class="p">.</span><span class="n">declare_func_in_func</span><span class="p">(</span><span class="n">func_add</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">func</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">lhs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">block_params</span><span class="p">(</span><span class="n">ebb</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">rhs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">block_params</span><span class="p">(</span><span class="n">ebb</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">call</span><span class="p">(</span><span class="n">func_add_local</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">lhs</span><span class="p">,</span><span class="w"> </span><span class="n">rhs</span><span class="p">]);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">inst_results</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>
<span class="w">                </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">len</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">                </span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">clone</span><span class="p">()</span>
<span class="w">            </span><span class="p">};</span>
<span class="w">            </span><span class="n">func_builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">return_</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="n">value</span><span class="p">]);</span>
<span class="w">            </span><span class="n">func_builder</span><span class="p">.</span><span class="n">seal_all_blocks</span><span class="p">();</span>
<span class="w">            </span><span class="n">func_builder</span><span class="p">.</span><span class="n">finalize</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span>
<span class="w">            </span><span class="p">.</span><span class="n">define_function</span><span class="p">(</span><span class="n">func_call</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">clear_context</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span><span class="p">);</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">finalize_definitions</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">code_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">get_finalized_function</span><span class="p">(</span><span class="n">func_call</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">mem</span>::<span class="n">transmute</span>::<span class="o">&lt;</span>
<span class="w">                </span><span class="n">_</span><span class="p">,</span>
<span class="w">                </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Array</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">            </span><span class="o">&gt;</span><span class="p">(</span><span class="n">code_call</span><span class="p">)</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">a1</span>: <span class="nc">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arc</span>::<span class="n">new</span><span class="p">(</span><span class="n">Int32Array</span>::<span class="n">from</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">]));</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">a2</span>: <span class="nc">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arc</span>::<span class="n">new</span><span class="p">(</span><span class="n">Int32Array</span>::<span class="n">from</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">]));</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">(</span>
<span class="w">            </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">a1</span><span class="p">.</span><span class="n">clone</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">            </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">a2</span><span class="p">.</span><span class="n">clone</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">read</span><span class="p">()</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">clone</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[cfg(test)]</span>
<span class="k">mod</span> <span class="nn">tests</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span>::<span class="n">JIT</span><span class="p">;</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">test_jit</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">jit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JIT</span>::<span class="n">default</span><span class="p">();</span>
<span class="w">        </span><span class="n">jit</span><span class="p">.</span><span class="n">compile</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="421494534"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237937%20Cranelift%3A%20call%20imported%20function%20.../near/421494534" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237937.20Cranelift.3A.20call.20imported.20function.20.2E.2E.2E.html#421494534">(Feb 14 2024 at 17:20)</a>:</h4>
<p>meijies edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/7937#issuecomment-1944271595">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7937">issue #7937</a>:</p>
<blockquote>
<p>@bjorn3 Thanks, but I meet another issue, the return result of jit generated func is different from add_wrapper and  it seems to point to an invalid address <code>{pointer:0x0000000000000070, vtable:(0) &amp;[]}</code>.  error occurs at last line of compile function.</p>
<h3>updated code.</h3>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">arrow</span>::<span class="p">{</span>
<span class="w">    </span><span class="n">array</span>::<span class="p">{</span><span class="n">Array</span><span class="p">,</span><span class="w"> </span><span class="n">ArrayRef</span><span class="p">,</span><span class="w"> </span><span class="n">Datum</span><span class="p">,</span><span class="w"> </span><span class="n">Int32Array</span><span class="p">},</span>
<span class="w">    </span><span class="n">compute</span>::<span class="n">kernels</span>::<span class="n">numeric</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="p">{</span><span class="n">codegen</span>::<span class="n">ir</span>::<span class="n">UserFuncName</span><span class="p">,</span><span class="w"> </span><span class="n">prelude</span>::<span class="o">*</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_jit</span>::<span class="p">{</span><span class="n">JITBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">JITModule</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_module</span>::<span class="p">{</span><span class="n">DataDescription</span><span class="p">,</span><span class="w"> </span><span class="n">Linkage</span><span class="p">,</span><span class="w"> </span><span class="n">Module</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="p">{</span>
<span class="w">    </span><span class="n">mem</span>::<span class="p">{</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">forget</span><span class="p">},</span>
<span class="w">    </span><span class="n">sync</span>::<span class="n">Arc</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="k">struct</span> <span class="nc">JIT</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">func_ctx</span>: <span class="nc">FunctionBuilderContext</span><span class="p">,</span>
<span class="w">    </span><span class="n">ctx</span>: <span class="nc">codegen</span>::<span class="n">Context</span><span class="p">,</span>
<span class="w">    </span><span class="n">data_description</span>: <span class="nc">DataDescription</span><span class="p">,</span>
<span class="w">    </span><span class="n">module</span>: <span class="nc">JITModule</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">add_wrapper</span><span class="p">(</span>
<span class="w">    </span><span class="n">lhs</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">rhs</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Array</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">lhs_ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">lhs</span><span class="p">.</span><span class="n">read</span><span class="p">()</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rhs_ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">rhs</span><span class="p">.</span><span class="n">read</span><span class="p">()</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numeric</span>::<span class="n">add</span><span class="p">(</span><span class="n">lhs_ref</span><span class="p">.</span><span class="n">as_ref</span><span class="p">(),</span><span class="w"> </span><span class="n">rhs_ref</span><span class="p">.</span><span class="n">as_ref</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">.</span><span class="n">clone</span><span class="p">());</span>
<span class="w">    </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">ArrayRef</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="nb">Default</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">JIT</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">default</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">flag_builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span>::<span class="n">builder</span><span class="p">();</span>
<span class="w">        </span><span class="n">flag_builder</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="s">"use_colocated_libcalls"</span><span class="p">,</span><span class="w"> </span><span class="s">"false"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="n">flag_builder</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="s">"is_pic"</span><span class="p">,</span><span class="w"> </span><span class="s">"false"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// build isa</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">isa_builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cranelift_native</span>::<span class="n">builder</span><span class="p">().</span><span class="n">unwrap_or_else</span><span class="p">(</span><span class="o">|</span><span class="n">msg</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="fm">panic!</span><span class="p">(</span><span class="s">"host machine is not supported: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">isa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isa_builder</span>
<span class="w">            </span><span class="p">.</span><span class="n">finish</span><span class="p">(</span><span class="n">settings</span>::<span class="n">Flags</span>::<span class="n">new</span><span class="p">(</span><span class="n">flag_builder</span><span class="p">))</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// build module</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JITBuilder</span>::<span class="n">with_isa</span><span class="p">(</span><span class="n">isa</span><span class="p">,</span><span class="w"> </span><span class="n">cranelift_module</span>::<span class="n">default_libcall_names</span><span class="p">());</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">addr</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">add_wrapper</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">;</span>
<span class="w">        </span><span class="n">builder</span><span class="p">.</span><span class="n">symbol</span><span class="p">(</span><span class="s">"add"</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JITModule</span>::<span class="n">new</span><span class="p">(</span><span class="n">builder</span><span class="p">);</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">func_ctx</span>: <span class="nc">FunctionBuilderContext</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">ctx</span>: <span class="nc">module</span><span class="p">.</span><span class="n">make_context</span><span class="p">(),</span>
<span class="w">            </span><span class="n">data_description</span>: <span class="nc">DataDescription</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">module</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">JIT</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">compile</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">sig_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">make_signature</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">target_config</span><span class="p">().</span><span class="n">pointer_type</span><span class="p">();</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">sig_add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">make_signature</span><span class="p">();</span>
<span class="w">        </span><span class="n">sig_add</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="n">sig_add</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="n">sig_add</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">func_add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span>
<span class="w">            </span><span class="p">.</span><span class="n">module</span>
<span class="w">            </span><span class="p">.</span><span class="n">declare_function</span><span class="p">(</span><span class="s">"add"</span><span class="p">,</span><span class="w"> </span><span class="n">Linkage</span>::<span class="n">Import</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sig_add</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="n">sig_call</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="n">sig_call</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="n">sig_call</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">func_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span>
<span class="w">            </span><span class="p">.</span><span class="n">module</span>
<span class="w">            </span><span class="p">.</span><span class="n">declare_function</span><span class="p">(</span><span class="s">"call"</span><span class="p">,</span><span class="w"> </span><span class="n">Linkage</span>::<span class="n">Local</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sig_call</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">signature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sig_call</span><span class="p">;</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UserFuncName</span>::<span class="n">user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">func_call</span><span class="p">.</span><span class="n">as_u32</span><span class="p">());</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">func_builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionBuilder</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span><span class="p">.</span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">func_ctx</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">ebb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">create_block</span><span class="p">();</span>
<span class="w">            </span><span class="n">func_builder</span><span class="p">.</span><span class="n">switch_to_block</span><span class="p">(</span><span class="n">ebb</span><span class="p">);</span>
<span class="w">            </span><span class="n">func_builder</span><span class="p">.</span><span class="n">append_block_params_for_function_params</span><span class="p">(</span><span class="n">ebb</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">func_add_local</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span>
<span class="w">                </span><span class="p">.</span><span class="n">module</span>
<span class="w">                </span><span class="p">.</span><span class="n">declare_func_in_func</span><span class="p">(</span><span class="n">func_add</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">func</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">lhs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">block_params</span><span class="p">(</span><span class="n">ebb</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">rhs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">block_params</span><span class="p">(</span><span class="n">ebb</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">call</span><span class="p">(</span><span class="n">func_add_local</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">lhs</span><span class="p">,</span><span class="w"> </span><span class="n">rhs</span><span class="p">]);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">inst_results</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>
<span class="w">                </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">len</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">                </span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">clone</span><span class="p">()</span>
<span class="w">            </span><span class="p">};</span>
<span class="w">            </span><span class="n">func_builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">return_</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="n">value</span><span class="p">]);</span>
<span class="w">            </span><span class="n">func_builder</span><span class="p">.</span><span class="n">seal_all_blocks</span><span class="p">();</span>
<span class="w">            </span><span class="n">func_builder</span><span class="p">.</span><span class="n">finalize</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span>
<span class="w">            </span><span class="p">.</span><span class="n">define_function</span><span class="p">(</span><span class="n">func_call</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">clear_context</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span><span class="p">);</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">finalize_definitions</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">code_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">get_finalized_function</span><span class="p">(</span><span class="n">func_call</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">mem</span>::<span class="n">transmute</span>::<span class="o">&lt;</span>
<span class="w">                </span><span class="n">_</span><span class="p">,</span>
<span class="w">                </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Array</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">            </span><span class="o">&gt;</span><span class="p">(</span><span class="n">code_call</span><span class="p">)</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">a1</span>: <span class="nc">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arc</span>::<span class="n">new</span><span class="p">(</span><span class="n">Int32Array</span>::<span class="n">from</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">]));</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">a2</span>: <span class="nc">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arc</span>::<span class="n">new</span><span class="p">(</span><span class="n">Int32Array</span>::<span class="n">from</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">]));</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">(</span>
<span class="w">            </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">a1</span><span class="p">.</span><span class="n">clone</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">            </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">a2</span><span class="p">.</span><span class="n">clone</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">read</span><span class="p">()</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">clone</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[cfg(test)]</span>
<span class="k">mod</span> <span class="nn">tests</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span>::<span class="n">JIT</span><span class="p">;</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">test_jit</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">jit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JIT</span>::<span class="n">default</span><span class="p">();</span>
<span class="w">        </span><span class="n">jit</span><span class="p">.</span><span class="n">compile</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="421495093"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237937%20Cranelift%3A%20call%20imported%20function%20.../near/421495093" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237937.20Cranelift.3A.20call.20imported.20function.20.2E.2E.2E.html#421495093">(Feb 14 2024 at 17:23)</a>:</h4>
<p>meijies edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/7937#issuecomment-1944271595">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7937">issue #7937</a>:</p>
<blockquote>
<p>@bjorn3 Thanks, but I meet another issue, the return result of jit generated func is different from add_wrapper and  it seems to point to an invalid address <code>{pointer:0x0000000000000070, vtable:(0) &amp;[]}</code>.  error occurs at last line of compile function.</p>
<h3>updated code.</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">arrow</span>::<span class="p">{</span>
<span class="w">    </span><span class="n">array</span>::<span class="p">{</span><span class="n">Array</span><span class="p">,</span><span class="w"> </span><span class="n">ArrayRef</span><span class="p">,</span><span class="w"> </span><span class="n">Datum</span><span class="p">,</span><span class="w"> </span><span class="n">Int32Array</span><span class="p">},</span>
<span class="w">    </span><span class="n">compute</span>::<span class="n">kernels</span>::<span class="n">numeric</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="p">{</span><span class="n">codegen</span>::<span class="n">ir</span>::<span class="n">UserFuncName</span><span class="p">,</span><span class="w"> </span><span class="n">prelude</span>::<span class="o">*</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_jit</span>::<span class="p">{</span><span class="n">JITBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">JITModule</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_module</span>::<span class="p">{</span><span class="n">DataDescription</span><span class="p">,</span><span class="w"> </span><span class="n">Linkage</span><span class="p">,</span><span class="w"> </span><span class="n">Module</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="p">{</span>
<span class="w">    </span><span class="n">mem</span>::<span class="p">{</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">forget</span><span class="p">},</span>
<span class="w">    </span><span class="n">sync</span>::<span class="n">Arc</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="k">struct</span> <span class="nc">JIT</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">func_ctx</span>: <span class="nc">FunctionBuilderContext</span><span class="p">,</span>
<span class="w">    </span><span class="n">ctx</span>: <span class="nc">codegen</span>::<span class="n">Context</span><span class="p">,</span>
<span class="w">    </span><span class="n">data_description</span>: <span class="nc">DataDescription</span><span class="p">,</span>
<span class="w">    </span><span class="n">module</span>: <span class="nc">JITModule</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">add_wrapper</span><span class="p">(</span>
<span class="w">    </span><span class="n">lhs</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">rhs</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Array</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">lhs_ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">lhs</span><span class="p">.</span><span class="n">read</span><span class="p">()</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rhs_ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">rhs</span><span class="p">.</span><span class="n">read</span><span class="p">()</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numeric</span>::<span class="n">add</span><span class="p">(</span><span class="n">lhs_ref</span><span class="p">.</span><span class="n">as_ref</span><span class="p">(),</span><span class="w"> </span><span class="n">rhs_ref</span><span class="p">.</span><span class="n">as_ref</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">.</span><span class="n">clone</span><span class="p">());</span>
<span class="w">    </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">ArrayRef</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="nb">Default</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">JIT</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">default</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">flag_builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span>::<span class="n">builder</span><span class="p">();</span>
<span class="w">        </span><span class="n">flag_builder</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="s">"use_colocated_libcalls"</span><span class="p">,</span><span class="w"> </span><span class="s">"false"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="n">flag_builder</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="s">"is_pic"</span><span class="p">,</span><span class="w"> </span><span class="s">"false"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// build isa</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">isa_builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cranelift_native</span>::<span class="n">builder</span><span class="p">().</span><span class="n">unwrap_or_else</span><span class="p">(</span><span class="o">|</span><span class="n">msg</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="fm">panic!</span><span class="p">(</span><span class="s">"host machine is not supported: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">isa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isa_builder</span>
<span class="w">            </span><span class="p">.</span><span class="n">finish</span><span class="p">(</span><span class="n">settings</span>::<span class="n">Flags</span>::<span class="n">new</span><span class="p">(</span><span class="n">flag_builder</span><span class="p">))</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// build module</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JITBuilder</span>::<span class="n">with_isa</span><span class="p">(</span><span class="n">isa</span><span class="p">,</span><span class="w"> </span><span class="n">cranelift_module</span>::<span class="n">default_libcall_names</span><span class="p">());</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">addr</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">add_wrapper</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">;</span>
<span class="w">        </span><span class="n">builder</span><span class="p">.</span><span class="n">symbol</span><span class="p">(</span><span class="s">"add"</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JITModule</span>::<span class="n">new</span><span class="p">(</span><span class="n">builder</span><span class="p">);</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">func_ctx</span>: <span class="nc">FunctionBuilderContext</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">ctx</span>: <span class="nc">module</span><span class="p">.</span><span class="n">make_context</span><span class="p">(),</span>
<span class="w">            </span><span class="n">data_description</span>: <span class="nc">DataDescription</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">module</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">JIT</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">compile</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">sig_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">make_signature</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">target_config</span><span class="p">().</span><span class="n">pointer_type</span><span class="p">();</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">sig_add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">make_signature</span><span class="p">();</span>
<span class="w">        </span><span class="n">sig_add</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="n">sig_add</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="n">sig_add</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">func_add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span>
<span class="w">            </span><span class="p">.</span><span class="n">module</span>
<span class="w">            </span><span class="p">.</span><span class="n">declare_function</span><span class="p">(</span><span class="s">"add"</span><span class="p">,</span><span class="w"> </span><span class="n">Linkage</span>::<span class="n">Import</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sig_add</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="n">sig_call</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="n">sig_call</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="n">sig_call</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer</span><span class="p">));</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">func_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span>
<span class="w">            </span><span class="p">.</span><span class="n">module</span>
<span class="w">            </span><span class="p">.</span><span class="n">declare_function</span><span class="p">(</span><span class="s">"call"</span><span class="p">,</span><span class="w"> </span><span class="n">Linkage</span>::<span class="n">Local</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sig_call</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">signature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sig_call</span><span class="p">;</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UserFuncName</span>::<span class="n">user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">func_call</span><span class="p">.</span><span class="n">as_u32</span><span class="p">());</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">func_builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionBuilder</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span><span class="p">.</span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">func_ctx</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">ebb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">create_block</span><span class="p">();</span>
<span class="w">            </span><span class="n">func_builder</span><span class="p">.</span><span class="n">switch_to_block</span><span class="p">(</span><span class="n">ebb</span><span class="p">);</span>
<span class="w">            </span><span class="n">func_builder</span><span class="p">.</span><span class="n">append_block_params_for_function_params</span><span class="p">(</span><span class="n">ebb</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">func_add_local</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span>
<span class="w">                </span><span class="p">.</span><span class="n">module</span>
<span class="w">                </span><span class="p">.</span><span class="n">declare_func_in_func</span><span class="p">(</span><span class="n">func_add</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">func</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">lhs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">block_params</span><span class="p">(</span><span class="n">ebb</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">rhs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">block_params</span><span class="p">(</span><span class="n">ebb</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">call</span><span class="p">(</span><span class="n">func_add_local</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">lhs</span><span class="p">,</span><span class="w"> </span><span class="n">rhs</span><span class="p">]);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_builder</span><span class="p">.</span><span class="n">inst_results</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>
<span class="w">                </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">len</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">                </span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">clone</span><span class="p">()</span>
<span class="w">            </span><span class="p">};</span>
<span class="w">            </span><span class="n">func_builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">return_</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="n">value</span><span class="p">]);</span>
<span class="w">            </span><span class="n">func_builder</span><span class="p">.</span><span class="n">seal_all_blocks</span><span class="p">();</span>
<span class="w">            </span><span class="n">func_builder</span><span class="p">.</span><span class="n">finalize</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span>
<span class="w">            </span><span class="p">.</span><span class="n">define_function</span><span class="p">(</span><span class="n">func_call</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">clear_context</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span><span class="p">);</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">finalize_definitions</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">code_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">get_finalized_function</span><span class="p">(</span><span class="n">func_call</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">mem</span>::<span class="n">transmute</span>::<span class="o">&lt;</span>
<span class="w">                </span><span class="n">_</span><span class="p">,</span>
<span class="w">                </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Array</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">            </span><span class="o">&gt;</span><span class="p">(</span><span class="n">code_call</span><span class="p">)</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">a1</span>: <span class="nc">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arc</span>::<span class="n">new</span><span class="p">(</span><span class="n">Int32Array</span>::<span class="n">from</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">]));</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">a2</span>: <span class="nc">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arc</span>::<span class="n">new</span><span class="p">(</span><span class="n">Int32Array</span>::<span class="n">from</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">]));</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">(</span>
<span class="w">            </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">a1</span><span class="p">.</span><span class="n">clone</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">            </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">a2</span><span class="p">.</span><span class="n">clone</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Datum</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">read</span><span class="p">()</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">clone</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[cfg(test)]</span>
<span class="k">mod</span> <span class="nn">tests</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span>::<span class="n">JIT</span><span class="p">;</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">test_jit</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">jit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JIT</span>::<span class="n">default</span><span class="p">();</span>
<span class="w">        </span><span class="n">jit</span><span class="p">.</span><span class="n">compile</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3>debug info</h3>
<p>&lt;img width="1627" alt="Screenshot 2024-02-15 at 01 22 44" src="<a href="https://github.com/bytecodealliance/wasmtime/assets/13784260/867f3eba-efb8-4764-8591-df5eb6af2b1b">https://github.com/bytecodealliance/wasmtime/assets/13784260/867f3eba-efb8-4764-8591-df5eb6af2b1b</a>"&gt;</p>
</blockquote>



<a name="421501761"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237937%20Cranelift%3A%20call%20imported%20function%20.../near/421501761" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237937.20Cranelift.3A.20call.20imported.20function.20.2E.2E.2E.html#421501761">(Feb 14 2024 at 17:59)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/7937#issuecomment-1944330053">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7937">issue #7937</a>:</p>
<blockquote>
<p>At least one issue I see is that you are having a double free. <code>&amp;mut a1.clone() as *mut Arc&lt;dyn Datum&gt;</code> would increment the refcount in the clone and decrement it again after it gets dropped. At the same time however <code>unsafe { lhs.read() }</code> inside <code>add_wrapper</code> constructs an <code>Arc</code> without incrementing the refcount, but then decrements it at the end. Furthermore the <code>&amp;mut res as *mut ArrayRef</code> inside <code>add_wrapper</code> will drop the <code>res</code> at the end of the function and thus cause the value to be freed, but then after the call, <code>unsafe { result.read() };</code> will try to get an <code>Arc</code> again. In addition it will not even keep the <code>ArrayRef</code> value itself alive, so you are returning a dangling pointer to a dangling <code>Arc</code>. To avoid the refcount issues you could use <code>Arc::into_raw()</code> on one side and <code>Arc::from_raw()</code> on the other side. For the issue with <code>&amp;mut res as *mut ArrayRef</code>, the easiest solution is likely to change <code>add_wrapper</code> to instead take as argument the location where the <code>ArrayRef</code> (or rather <code>*mut dyn Array</code> after calling <code>Arc::into_raw()</code>) should be written and pass this into <code>call</code>.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>