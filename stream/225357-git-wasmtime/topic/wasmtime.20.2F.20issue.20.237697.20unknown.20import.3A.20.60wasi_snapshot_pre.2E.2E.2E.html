<html>
<head><meta charset="utf-8"><title>wasmtime / issue #7697 unknown import: `wasi_snapshot_pre... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237697.20unknown.20import.3A.20.60wasi_snapshot_pre.2E.2E.2E.html">wasmtime / issue #7697 unknown import: `wasi_snapshot_pre...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="408419198"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237697%20unknown%20import%3A%20%60wasi_snapshot_pre.../near/408419198" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237697.20unknown.20import.3A.20.60wasi_snapshot_pre.2E.2E.2E.html#408419198">(Dec 17 2023 at 07:44)</a>:</h4>
<p><a href="https://github.com/k82cn">k82cn</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/7697">Issue #7697</a>.</p>



<a name="408419202"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237697%20unknown%20import%3A%20%60wasi_snapshot_pre.../near/408419202" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237697.20unknown.20import.3A.20.60wasi_snapshot_pre.2E.2E.2E.html#408419202">(Dec 17 2023 at 07:44)</a>:</h4>
<p>k82cn opened <a href="https://github.com/bytecodealliance/wasmtime/issues/7697">issue #7697</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>Refer to following files for rust &amp; wasm files:</p>
<p>Local: <a href="https://github.com/xflops/flame/pull/75/files#diff-448546749b6625cbca1a43c400f6d86637db5f014968c96ece09705e07f65c7c">https://github.com/xflops/flame/pull/75/files#diff-448546749b6625cbca1a43c400f6d86637db5f014968c96ece09705e07f65c7c</a><br>
WASM: <a href="https://github.com/xflops/flame/pull/75/files#diff-cb3f76ea005ef90eb514c6baf71a09bd928befb8f267ef204ea8474036dc172b">https://github.com/xflops/flame/pull/75/files#diff-cb3f76ea005ef90eb514c6baf71a09bd928befb8f267ef204ea8474036dc172b</a></p>
<h3>Steps to Reproduce</h3>
<ul>
<li>Compile local bin by <code>cargo build -p matrix-local</code></li>
<li>Compile WASM by <code>cargo wasi build -p matrix-server</code></li>
<li>Run <code>./target/debug/matrix-local</code></li>
</ul>
<h3>Expected Results</h3>
<p>WASM can execute as normal</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">matrix</span><span class="o">-</span><span class="n">local</span>
<span class="n">Error</span>: <span class="nc">NotFound</span><span class="p">(</span><span class="s">"unknown import: `wasi_snapshot_preview1::fd_write` has not been defined"</span><span class="p">)</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 15.0.1</p>
<p>Operating system: ubuntu 22.04</p>
<p>Architecture: x86</p>
<h3>Extra Info</h3>
<p>And I'd like to pass through a string and binary data into WASM, e.g. <code>on_session_enter</code>, <code>on_session_leave</code> and <code>on_task_invoke</code>.<br>
</p>
</blockquote>



<a name="408421481"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237697%20unknown%20import%3A%20%60wasi_snapshot_pre.../near/408421481" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237697.20unknown.20import.3A.20.60wasi_snapshot_pre.2E.2E.2E.html#408421481">(Dec 17 2023 at 08:17)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/7697#issuecomment-1859069693">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7697">issue #7697</a>:</p>
<blockquote>
<p>You are missing this call to enable wasi support: <a href="https://github.com/bytecodealliance/wasmtime/blob/54d3727ac3df53e55489560656b1d68db3c0e3ba/examples/wasi/main.rs#L17">https://github.com/bytecodealliance/wasmtime/blob/54d3727ac3df53e55489560656b1d68db3c0e3ba/examples/wasi/main.rs#L17</a> Make sure to also add a WasiCtx to the Store, eg: <a href="https://github.com/bytecodealliance/wasmtime/blob/54d3727ac3df53e55489560656b1d68db3c0e3ba/examples/wasi/main.rs#L26">https://github.com/bytecodealliance/wasmtime/blob/54d3727ac3df53e55489560656b1d68db3c0e3ba/examples/wasi/main.rs#L26</a> It can also be a field of the store data, in which case you need to update the closure in the add_to_linker call to return a reference to this field.</p>
</blockquote>



<a name="408429783"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237697%20unknown%20import%3A%20%60wasi_snapshot_pre.../near/408429783" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237697.20unknown.20import.3A.20.60wasi_snapshot_pre.2E.2E.2E.html#408429783">(Dec 17 2023 at 10:09)</a>:</h4>
<p>k82cn <a href="https://github.com/bytecodealliance/wasmtime/issues/7697#issuecomment-1859111117">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7697">issue #7697</a>:</p>
<blockquote>
<p>Update PR to include them: <a href="https://github.com/xflops/flame/pull/75/commits/ac2482e06c7d29c96a0085e6af1823bc777aa182">https://github.com/xflops/flame/pull/75/commits/ac2482e06c7d29c96a0085e6af1823bc777aa182</a></p>
<p>But I got the following error when <code>instance.get_func</code> in <code>on_session_enter</code>:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">matrix</span><span class="o">-</span><span class="n">local</span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="err">`</span><span class="n">main</span><span class="err">`</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">exported</span><span class="w"> </span><span class="n">function</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">examples</span><span class="o">/</span><span class="n">matrix</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">53</span>:<span class="mi">14</span>
<span class="n">stack</span><span class="w"> </span><span class="n">backtrace</span>:
   <span class="mi">0</span>: <span class="nc">rust_begin_unwind</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">eb26296b556cef10fb713a38f3d16b9886080f26</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">593</span>:<span class="mi">5</span>
<span class="w">   </span><span class="mi">1</span>: <span class="nc">core</span>::<span class="n">panicking</span>::<span class="n">panic_fmt</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">eb26296b556cef10fb713a38f3d16b9886080f26</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">67</span>:<span class="mi">14</span>
<span class="w">   </span><span class="mi">2</span>: <span class="nc">core</span>::<span class="n">panicking</span>::<span class="n">panic_display</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">eb26296b556cef10fb713a38f3d16b9886080f26</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">150</span>:<span class="mi">5</span>
<span class="w">   </span><span class="mi">3</span>: <span class="nc">core</span>::<span class="n">panicking</span>::<span class="n">panic_str</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">eb26296b556cef10fb713a38f3d16b9886080f26</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">134</span>:<span class="mi">5</span>
<span class="w">   </span><span class="mi">4</span>: <span class="nc">core</span>::<span class="n">option</span>::<span class="n">expect_failed</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">eb26296b556cef10fb713a38f3d16b9886080f26</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">option</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1932</span>:<span class="mi">5</span>
<span class="w">   </span><span class="mi">5</span>: <span class="nc">core</span>::<span class="n">option</span>::<span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>::<span class="n">expect</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">eb26296b556cef10fb713a38f3d16b9886080f26</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">option</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">898</span>:<span class="mi">21</span>
<span class="w">   </span><span class="mi">6</span>: <span class="nc">matrix_local</span>::<span class="n">WasmShim</span>::<span class="n">on_session_enter</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">matrix</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">50</span>:<span class="mi">22</span>
<span class="w">   </span><span class="mi">7</span>: <span class="nc">matrix_local</span>::<span class="n">main</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">matrix</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">77</span>:<span class="mi">40</span>
<span class="w">   </span><span class="mi">8</span>: <span class="nc">tokio</span>::<span class="n">runtime</span>::<span class="n">park</span>::<span class="n">CachedParkThread</span>::<span class="n">block_on</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">hpc</span><span class="o">/</span><span class="n">mtr_scrap</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">klausm</span><span class="o">/</span><span class="n">cargo_home</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.35.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">park</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">282</span>:<span class="mi">63</span>
<span class="w">   </span><span class="mi">9</span>: <span class="nc">tokio</span>::<span class="n">runtime</span>::<span class="n">coop</span>::<span class="n">with_budget</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">hpc</span><span class="o">/</span><span class="n">mtr_scrap</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">klausm</span><span class="o">/</span><span class="n">cargo_home</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.35.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">coop</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">107</span>:<span class="mi">5</span>
<span class="w">  </span><span class="mi">10</span>: <span class="nc">tokio</span>::<span class="n">runtime</span>::<span class="n">coop</span>::<span class="n">budget</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">hpc</span><span class="o">/</span><span class="n">mtr_scrap</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">klausm</span><span class="o">/</span><span class="n">cargo_home</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.35.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">coop</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">73</span>:<span class="mi">5</span>
<span class="w">  </span><span class="mi">11</span>: <span class="nc">tokio</span>::<span class="n">runtime</span>::<span class="n">park</span>::<span class="n">CachedParkThread</span>::<span class="n">block_on</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">hpc</span><span class="o">/</span><span class="n">mtr_scrap</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">klausm</span><span class="o">/</span><span class="n">cargo_home</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.35.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">park</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">282</span>:<span class="mi">31</span>
<span class="w">  </span><span class="mi">12</span>: <span class="nc">tokio</span>::<span class="n">runtime</span>::<span class="n">context</span>::<span class="n">blocking</span>::<span class="n">BlockingRegionGuard</span>::<span class="n">block_on</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">hpc</span><span class="o">/</span><span class="n">mtr_scrap</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">klausm</span><span class="o">/</span><span class="n">cargo_home</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.35.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">context</span><span class="o">/</span><span class="n">blocking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">66</span>:<span class="mi">9</span>
<span class="w">  </span><span class="mi">13</span>: <span class="nc">tokio</span>::<span class="n">runtime</span>::<span class="n">scheduler</span>::<span class="n">multi_thread</span>::<span class="n">MultiThread</span>::<span class="n">block_on</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">hpc</span><span class="o">/</span><span class="n">mtr_scrap</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">klausm</span><span class="o">/</span><span class="n">cargo_home</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.35.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">scheduler</span><span class="o">/</span><span class="n">multi_thread</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">87</span>:<span class="mi">13</span>
<span class="w">  </span><span class="mi">14</span>: <span class="nc">tokio</span>::<span class="n">runtime</span>::<span class="n">context</span>::<span class="n">runtime</span>::<span class="n">enter_runtime</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">hpc</span><span class="o">/</span><span class="n">mtr_scrap</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">klausm</span><span class="o">/</span><span class="n">cargo_home</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.35.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">context</span><span class="o">/</span><span class="n">runtime</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">65</span>:<span class="mi">16</span>
<span class="w">  </span><span class="mi">15</span>: <span class="nc">tokio</span>::<span class="n">runtime</span>::<span class="n">scheduler</span>::<span class="n">multi_thread</span>::<span class="n">MultiThread</span>::<span class="n">block_on</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">hpc</span><span class="o">/</span><span class="n">mtr_scrap</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">klausm</span><span class="o">/</span><span class="n">cargo_home</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.35.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">scheduler</span><span class="o">/</span><span class="n">multi_thread</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">86</span>:<span class="mi">9</span>
<span class="w">  </span><span class="mi">16</span>: <span class="nc">tokio</span>::<span class="n">runtime</span>::<span class="n">runtime</span>::<span class="n">Runtime</span>::<span class="n">block_on</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">hpc</span><span class="o">/</span><span class="n">mtr_scrap</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">klausm</span><span class="o">/</span><span class="n">cargo_home</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.35.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">runtime</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">350</span>:<span class="mi">45</span>
<span class="w">  </span><span class="mi">17</span>: <span class="nc">matrix_local</span>::<span class="n">main</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">matrix</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">91</span>:<span class="mi">5</span>
<span class="w">  </span><span class="mi">18</span>: <span class="nc">core</span>::<span class="n">ops</span>::<span class="n">function</span>::<span class="nb">FnOnce</span>::<span class="n">call_once</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">eb26296b556cef10fb713a38f3d16b9886080f26</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ops</span><span class="o">/</span><span class="n">function</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">250</span>:<span class="mi">5</span>
<span class="n">note</span>: <span class="nb">Some</span> <span class="nc">details</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">omitted</span><span class="p">,</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="n">full</span><span class="err">`</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">verbose</span><span class="w"> </span><span class="n">backtrace</span><span class="p">.</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="408429808"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237697%20unknown%20import%3A%20%60wasi_snapshot_pre.../near/408429808" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237697.20unknown.20import.3A.20.60wasi_snapshot_pre.2E.2E.2E.html#408429808">(Dec 17 2023 at 10:09)</a>:</h4>
<p>k82cn edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/7697#issuecomment-1859111117">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7697">issue #7697</a>:</p>
<blockquote>
<p>Update PR to include them: <a href="https://github.com/xflops/flame/pull/75/commits/ac2482e06c7d29c96a0085e6af1823bc777aa182">https://github.com/xflops/flame/pull/75/commits/ac2482e06c7d29c96a0085e6af1823bc777aa182</a></p>
<p>But I got the following error when <code>instance.get_func</code> in <code>on_session_enter</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">matrix</span><span class="o">-</span><span class="n">local</span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="err">`</span><span class="n">main</span><span class="err">`</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">exported</span><span class="w"> </span><span class="n">function</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">examples</span><span class="o">/</span><span class="n">matrix</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">53</span>:<span class="mi">14</span>
<span class="n">stack</span><span class="w"> </span><span class="n">backtrace</span>:
   <span class="mi">0</span>: <span class="nc">rust_begin_unwind</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">eb26296b556cef10fb713a38f3d16b9886080f26</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">593</span>:<span class="mi">5</span>
<span class="w">   </span><span class="mi">1</span>: <span class="nc">core</span>::<span class="n">panicking</span>::<span class="n">panic_fmt</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">eb26296b556cef10fb713a38f3d16b9886080f26</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">67</span>:<span class="mi">14</span>
<span class="w">   </span><span class="mi">2</span>: <span class="nc">core</span>::<span class="n">panicking</span>::<span class="n">panic_display</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">eb26296b556cef10fb713a38f3d16b9886080f26</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">150</span>:<span class="mi">5</span>
<span class="w">   </span><span class="mi">3</span>: <span class="nc">core</span>::<span class="n">panicking</span>::<span class="n">panic_str</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">eb26296b556cef10fb713a38f3d16b9886080f26</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">134</span>:<span class="mi">5</span>
<span class="w">   </span><span class="mi">4</span>: <span class="nc">core</span>::<span class="n">option</span>::<span class="n">expect_failed</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">eb26296b556cef10fb713a38f3d16b9886080f26</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">option</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1932</span>:<span class="mi">5</span>
<span class="w">   </span><span class="mi">5</span>: <span class="nc">core</span>::<span class="n">option</span>::<span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>::<span class="n">expect</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">eb26296b556cef10fb713a38f3d16b9886080f26</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">option</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">898</span>:<span class="mi">21</span>
<span class="w">   </span><span class="mi">6</span>: <span class="nc">matrix_local</span>::<span class="n">WasmShim</span>::<span class="n">on_session_enter</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">matrix</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">50</span>:<span class="mi">22</span>
<span class="w">   </span><span class="mi">7</span>: <span class="nc">matrix_local</span>::<span class="n">main</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">matrix</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">77</span>:<span class="mi">40</span>
<span class="w">   </span><span class="mi">8</span>: <span class="nc">tokio</span>::<span class="n">runtime</span>::<span class="n">park</span>::<span class="n">CachedParkThread</span>::<span class="n">block_on</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">hpc</span><span class="o">/</span><span class="n">mtr_scrap</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">klausm</span><span class="o">/</span><span class="n">cargo_home</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.35.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">park</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">282</span>:<span class="mi">63</span>
<span class="w">   </span><span class="mi">9</span>: <span class="nc">tokio</span>::<span class="n">runtime</span>::<span class="n">coop</span>::<span class="n">with_budget</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">hpc</span><span class="o">/</span><span class="n">mtr_scrap</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">klausm</span><span class="o">/</span><span class="n">cargo_home</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.35.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">coop</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">107</span>:<span class="mi">5</span>
<span class="w">  </span><span class="mi">10</span>: <span class="nc">tokio</span>::<span class="n">runtime</span>::<span class="n">coop</span>::<span class="n">budget</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">hpc</span><span class="o">/</span><span class="n">mtr_scrap</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">klausm</span><span class="o">/</span><span class="n">cargo_home</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.35.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">coop</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">73</span>:<span class="mi">5</span>
<span class="w">  </span><span class="mi">11</span>: <span class="nc">tokio</span>::<span class="n">runtime</span>::<span class="n">park</span>::<span class="n">CachedParkThread</span>::<span class="n">block_on</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">hpc</span><span class="o">/</span><span class="n">mtr_scrap</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">klausm</span><span class="o">/</span><span class="n">cargo_home</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.35.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">park</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">282</span>:<span class="mi">31</span>
<span class="w">  </span><span class="mi">12</span>: <span class="nc">tokio</span>::<span class="n">runtime</span>::<span class="n">context</span>::<span class="n">blocking</span>::<span class="n">BlockingRegionGuard</span>::<span class="n">block_on</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">hpc</span><span class="o">/</span><span class="n">mtr_scrap</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">klausm</span><span class="o">/</span><span class="n">cargo_home</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.35.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">context</span><span class="o">/</span><span class="n">blocking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">66</span>:<span class="mi">9</span>
<span class="w">  </span><span class="mi">13</span>: <span class="nc">tokio</span>::<span class="n">runtime</span>::<span class="n">scheduler</span>::<span class="n">multi_thread</span>::<span class="n">MultiThread</span>::<span class="n">block_on</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">hpc</span><span class="o">/</span><span class="n">mtr_scrap</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">klausm</span><span class="o">/</span><span class="n">cargo_home</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.35.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">scheduler</span><span class="o">/</span><span class="n">multi_thread</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">87</span>:<span class="mi">13</span>
<span class="w">  </span><span class="mi">14</span>: <span class="nc">tokio</span>::<span class="n">runtime</span>::<span class="n">context</span>::<span class="n">runtime</span>::<span class="n">enter_runtime</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">hpc</span><span class="o">/</span><span class="n">mtr_scrap</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">klausm</span><span class="o">/</span><span class="n">cargo_home</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.35.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">context</span><span class="o">/</span><span class="n">runtime</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">65</span>:<span class="mi">16</span>
<span class="w">  </span><span class="mi">15</span>: <span class="nc">tokio</span>::<span class="n">runtime</span>::<span class="n">scheduler</span>::<span class="n">multi_thread</span>::<span class="n">MultiThread</span>::<span class="n">block_on</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">hpc</span><span class="o">/</span><span class="n">mtr_scrap</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">klausm</span><span class="o">/</span><span class="n">cargo_home</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.35.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">scheduler</span><span class="o">/</span><span class="n">multi_thread</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">86</span>:<span class="mi">9</span>
<span class="w">  </span><span class="mi">16</span>: <span class="nc">tokio</span>::<span class="n">runtime</span>::<span class="n">runtime</span>::<span class="n">Runtime</span>::<span class="n">block_on</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">hpc</span><span class="o">/</span><span class="n">mtr_scrap</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">klausm</span><span class="o">/</span><span class="n">cargo_home</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.35.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">runtime</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">350</span>:<span class="mi">45</span>
<span class="w">  </span><span class="mi">17</span>: <span class="nc">matrix_local</span>::<span class="n">main</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">matrix</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">91</span>:<span class="mi">5</span>
<span class="w">  </span><span class="mi">18</span>: <span class="nc">core</span>::<span class="n">ops</span>::<span class="n">function</span>::<span class="nb">FnOnce</span>::<span class="n">call_once</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">eb26296b556cef10fb713a38f3d16b9886080f26</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ops</span><span class="o">/</span><span class="n">function</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">250</span>:<span class="mi">5</span>
<span class="n">note</span>: <span class="nb">Some</span> <span class="nc">details</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">omitted</span><span class="p">,</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="n">full</span><span class="err">`</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">verbose</span><span class="w"> </span><span class="n">backtrace</span><span class="p">.</span>
</code></pre></div>
<p>If any suggestions, please let me know.</p>
</blockquote>



<a name="408430289"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237697%20unknown%20import%3A%20%60wasi_snapshot_pre.../near/408430289" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237697.20unknown.20import.3A.20.60wasi_snapshot_pre.2E.2E.2E.html#408430289">(Dec 17 2023 at 10:17)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/7697#issuecomment-1859121362">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7697">issue #7697</a>:</p>
<blockquote>
<p>The example uses</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">linker</span><span class="p">.</span><span class="n">module</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="n">linker</span>
<span class="w">    </span><span class="p">.</span><span class="n">get_default</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">)</span><span class="o">?</span>
<span class="w">    </span><span class="p">.</span><span class="n">typed</span>::<span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">)</span><span class="o">?</span>
<span class="w">    </span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="p">())</span><span class="o">?</span><span class="p">;</span>
</code></pre></div>
<p>If you want to keep the structure of the code unchanged I think you can use <code>self.instance.get_func(&amp;mut self.store, "_start")</code>. For wasi the actual function exported by the wasm module is <code>_start</code>. Internally this initialized libc and the rust standard library before calling the <code>main</code> function you wrote in the rust source file.</p>
</blockquote>



<a name="408431072"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237697%20unknown%20import%3A%20%60wasi_snapshot_pre.../near/408431072" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237697.20unknown.20import.3A.20.60wasi_snapshot_pre.2E.2E.2E.html#408431072">(Dec 17 2023 at 10:29)</a>:</h4>
<p>k82cn <a href="https://github.com/bytecodealliance/wasmtime/issues/7697#issuecomment-1859131430">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7697">issue #7697</a>:</p>
<blockquote>
<blockquote>
<p>self.instance.get_func(&amp;mut <a href="http://self.store">self.store</a>, "_start")</p>
</blockquote>
<p>Thanks very much! That works for the <code>main</code>. Is there anyway to also call <code>on_session_enter</code> function? Honestly, I'd like to execute three callback funcs in wasm: <code>on_session_enter</code>, <code>on_session_leave</code> and <code>on_task_invoke</code>.</p>
<p>When replace <code>_start</code> with <code>on_session_enter</code> (which is a pub fn in <code>main.rs</code>), I got following errors:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">matrix</span><span class="o">-</span><span class="n">local</span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="err">`</span><span class="n">on_session_enter</span><span class="err">`</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">exported</span><span class="w"> </span><span class="n">function</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">examples</span><span class="o">/</span><span class="n">matrix</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">53</span>:<span class="mi">14</span>
<span class="n">stack</span><span class="w"> </span><span class="n">backtrace</span>:
   <span class="mi">0</span>: <span class="nc">rust_begin_unwind</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">eb26296b556cef10fb713a38f3d16b9886080f26</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">593</span>:<span class="mi">5</span>
<span class="w">   </span><span class="mi">1</span>: <span class="nc">core</span>::<span class="n">panicking</span>::<span class="n">panic_fmt</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">eb26296b556cef10fb713a38f3d16b9886080f26</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">67</span>:<span class="mi">14</span>
<span class="w">   </span><span class="mi">2</span>: <span class="nc">core</span>::<span class="n">panicking</span>::<span class="n">panic_display</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">eb26296b556cef10fb713a38f3d16b9886080f26</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">150</span>:<span class="mi">5</span>
<span class="w">   </span><span class="mi">3</span>: <span class="nc">core</span>::<span class="n">panicking</span>::<span class="n">panic_str</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">eb26296b556cef10fb713a38f3d16b9886080f26</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">134</span>:<span class="mi">5</span>
<span class="w">   </span><span class="mi">4</span>: <span class="nc">core</span>::<span class="n">option</span>::<span class="n">expect_failed</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">eb26296b556cef10fb713a38f3d16b9886080f26</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">option</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1932</span>:<span class="mi">5</span>
<span class="w">   </span><span class="mi">5</span>: <span class="nc">core</span>::<span class="n">option</span>::<span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>::<span class="n">expect</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">eb26296b556cef10fb713a38f3d16b9886080f26</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">option</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">898</span>:<span class="mi">21</span>
<span class="w">   </span><span class="mi">6</span>: <span class="nc">matrix_local</span>::<span class="n">WasmShim</span>::<span class="n">on_session_enter</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">matrix</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">50</span>:<span class="mi">23</span>
<span class="w">   </span><span class="mi">7</span>: <span class="nc">matrix_local</span>::<span class="n">main</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">matrix</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">79</span>:<span class="mi">40</span>
<span class="w">   </span><span class="mi">8</span>: <span class="nc">tokio</span>::<span class="n">runtime</span>::<span class="n">park</span>::<span class="n">CachedParkThread</span>::<span class="n">block_on</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">hpc</span><span class="o">/</span><span class="n">mtr_scrap</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">klausm</span><span class="o">/</span><span class="n">cargo_home</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.35.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">park</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">282</span>:<span class="mi">63</span>
<span class="w">   </span><span class="mi">9</span>: <span class="nc">tokio</span>::<span class="n">runtime</span>::<span class="n">coop</span>::<span class="n">with_budget</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">hpc</span><span class="o">/</span><span class="n">mtr_scrap</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">klausm</span><span class="o">/</span><span class="n">cargo_home</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.35.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">coop</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">107</span>:<span class="mi">5</span>
<span class="w">  </span><span class="mi">10</span>: <span class="nc">tokio</span>::<span class="n">runtime</span>::<span class="n">coop</span>::<span class="n">budget</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">hpc</span><span class="o">/</span><span class="n">mtr_scrap</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">klausm</span><span class="o">/</span><span class="n">cargo_home</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.35.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">coop</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">73</span>:<span class="mi">5</span>
<span class="w">  </span><span class="mi">11</span>: <span class="nc">tokio</span>::<span class="n">runtime</span>::<span class="n">park</span>::<span class="n">CachedParkThread</span>::<span class="n">block_on</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">hpc</span><span class="o">/</span><span class="n">mtr_scrap</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">klausm</span><span class="o">/</span><span class="n">cargo_home</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.35.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">park</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">282</span>:<span class="mi">31</span>
<span class="w">  </span><span class="mi">12</span>: <span class="nc">tokio</span>::<span class="n">runtime</span>::<span class="n">context</span>::<span class="n">blocking</span>::<span class="n">BlockingRegionGuard</span>::<span class="n">block_on</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">hpc</span><span class="o">/</span><span class="n">mtr_scrap</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">klausm</span><span class="o">/</span><span class="n">cargo_home</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.35.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">context</span><span class="o">/</span><span class="n">blocking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">66</span>:<span class="mi">9</span>
<span class="w">  </span><span class="mi">13</span>: <span class="nc">tokio</span>::<span class="n">runtime</span>::<span class="n">scheduler</span>::<span class="n">multi_thread</span>::<span class="n">MultiThread</span>::<span class="n">block_on</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">hpc</span><span class="o">/</span><span class="n">mtr_scrap</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">klausm</span><span class="o">/</span><span class="n">cargo_home</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.35.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">scheduler</span><span class="o">/</span><span class="n">multi_thread</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">87</span>:<span class="mi">13</span>
<span class="w">  </span><span class="mi">14</span>: <span class="nc">tokio</span>::<span class="n">runtime</span>::<span class="n">context</span>::<span class="n">runtime</span>::<span class="n">enter_runtime</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">hpc</span><span class="o">/</span><span class="n">mtr_scrap</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">klausm</span><span class="o">/</span><span class="n">cargo_home</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.35.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">context</span><span class="o">/</span><span class="n">runtime</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">65</span>:<span class="mi">16</span>
<span class="w">  </span><span class="mi">15</span>: <span class="nc">tokio</span>::<span class="n">runtime</span>::<span class="n">scheduler</span>::<span class="n">multi_thread</span>::<span class="n">MultiThread</span>::<span class="n">block_on</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">hpc</span><span class="o">/</span><span class="n">mtr_scrap</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">klausm</span><span class="o">/</span><span class="n">cargo_home</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.35.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">scheduler</span><span class="o">/</span><span class="n">multi_thread</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">86</span>:<span class="mi">9</span>
<span class="w">  </span><span class="mi">16</span>: <span class="nc">tokio</span>::<span class="n">runtime</span>::<span class="n">runtime</span>::<span class="n">Runtime</span>::<span class="n">block_on</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">hpc</span><span class="o">/</span><span class="n">mtr_scrap</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">klausm</span><span class="o">/</span><span class="n">cargo_home</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.35.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">runtime</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">350</span>:<span class="mi">45</span>
<span class="w">  </span><span class="mi">17</span>: <span class="nc">matrix_local</span>::<span class="n">main</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">matrix</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">93</span>:<span class="mi">5</span>
<span class="w">  </span><span class="mi">18</span>: <span class="nc">core</span>::<span class="n">ops</span>::<span class="n">function</span>::<span class="nb">FnOnce</span>::<span class="n">call_once</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">eb26296b556cef10fb713a38f3d16b9886080f26</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ops</span><span class="o">/</span><span class="n">function</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">250</span>:<span class="mi">5</span>
<span class="n">note</span>: <span class="nb">Some</span> <span class="nc">details</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">omitted</span><span class="p">,</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="n">full</span><span class="err">`</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">verbose</span><span class="w"> </span><span class="n">backtrace</span><span class="p">.</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="408432860"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237697%20unknown%20import%3A%20%60wasi_snapshot_pre.../near/408432860" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237697.20unknown.20import.3A.20.60wasi_snapshot_pre.2E.2E.2E.html#408432860">(Dec 17 2023 at 10:59)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/7697#issuecomment-1859137792">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7697">issue #7697</a>:</p>
<blockquote>
<p>Have you defined these functions with <code>#[no_mangle]</code>? If not they will get a mangled name and will not be exported. Also I think you need to compile as cdylib instead of as bin if you want to export custom functions. For that you need to rename <code>src/main.rs</code> to <code>src/lib.rs</code> and in <code>Cargo.toml</code> add:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">[</span><span class="n">lib</span><span class="p">]</span>
<span class="k">crate</span><span class="o">-</span><span class="k">type</span> <span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"cdylib"</span><span class="p">]</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="408440349"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237697%20unknown%20import%3A%20%60wasi_snapshot_pre.../near/408440349" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237697.20unknown.20import.3A.20.60wasi_snapshot_pre.2E.2E.2E.html#408440349">(Dec 17 2023 at 13:00)</a>:</h4>
<p>k82cn <a href="https://github.com/bytecodealliance/wasmtime/issues/7697#issuecomment-1859165437">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7697">issue #7697</a>:</p>
<blockquote>
<p>That works to me, thanks very much!</p>
<p>In addition, do you have any suggestions on sending string, bytes array and string array? Something like that:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">SessionContext</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">session_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">common_data</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">bytes</span>::<span class="n">Bytes</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">type</span> <span class="nc">TaskInput</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bytes</span>::<span class="n">Bytes</span><span class="p">;</span>
<span class="k">pub</span><span class="w"> </span><span class="k">type</span> <span class="nc">TaskOutput</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bytes</span>::<span class="n">Bytes</span><span class="p">;</span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">TaskContext</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">session_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">task_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">FlameService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">on_session_enter</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span>: <span class="nc">SessionContext</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">FlameError</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">on_session_leave</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span>: <span class="nc">SessionContext</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">FlameError</span><span class="o">&gt;</span><span class="p">;</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">on_task_invoke</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">ctx</span>: <span class="nc">TaskContext</span><span class="p">,</span>
<span class="w">        </span><span class="n">input</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">TaskInput</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">TaskOutput</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">FlameError</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</blockquote>



<a name="408440382"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237697%20unknown%20import%3A%20%60wasi_snapshot_pre.../near/408440382" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237697.20unknown.20import.3A.20.60wasi_snapshot_pre.2E.2E.2E.html#408440382">(Dec 17 2023 at 13:00)</a>:</h4>
<p>k82cn edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/7697#issuecomment-1859165437">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7697">issue #7697</a>:</p>
<blockquote>
<p>That works to me, thanks very much!</p>
<p>In addition, do you have any suggestions on sending/receiving string, bytes array and string array? Something like that:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">SessionContext</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">session_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">common_data</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">bytes</span>::<span class="n">Bytes</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">type</span> <span class="nc">TaskInput</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bytes</span>::<span class="n">Bytes</span><span class="p">;</span>
<span class="k">pub</span><span class="w"> </span><span class="k">type</span> <span class="nc">TaskOutput</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bytes</span>::<span class="n">Bytes</span><span class="p">;</span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">TaskContext</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">session_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">task_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">FlameService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">on_session_enter</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span>: <span class="nc">SessionContext</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">FlameError</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">on_session_leave</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span>: <span class="nc">SessionContext</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">FlameError</span><span class="o">&gt;</span><span class="p">;</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">on_task_invoke</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">ctx</span>: <span class="nc">TaskContext</span><span class="p">,</span>
<span class="w">        </span><span class="n">input</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">TaskInput</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">TaskOutput</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">FlameError</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</blockquote>



<a name="408440762"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237697%20unknown%20import%3A%20%60wasi_snapshot_pre.../near/408440762" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237697.20unknown.20import.3A.20.60wasi_snapshot_pre.2E.2E.2E.html#408440762">(Dec 17 2023 at 13:05)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/7697#issuecomment-1859167105">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7697">issue #7697</a>:</p>
<blockquote>
<p>For that you may want to switch to using the component model together with wasi-preview2 (wasi-preview1 only works with core wasm, wasi-preview2 only with the component model) and then define your own interface. I have never used it myself, but I think the docs at <a href="https://docs.rs/wasmtime/latest/wasmtime/component/macro.bindgen.html">https://docs.rs/wasmtime/latest/wasmtime/component/macro.bindgen.html</a> should be clear.</p>
</blockquote>



<a name="408503655"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237697%20unknown%20import%3A%20%60wasi_snapshot_pre.../near/408503655" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237697.20unknown.20import.3A.20.60wasi_snapshot_pre.2E.2E.2E.html#408503655">(Dec 18 2023 at 01:48)</a>:</h4>
<p>k82cn closed <a href="https://github.com/bytecodealliance/wasmtime/issues/7697">issue #7697</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>Refer to following files for rust &amp; wasm files:</p>
<p>Local: <a href="https://github.com/xflops/flame/pull/75/files#diff-448546749b6625cbca1a43c400f6d86637db5f014968c96ece09705e07f65c7c">https://github.com/xflops/flame/pull/75/files#diff-448546749b6625cbca1a43c400f6d86637db5f014968c96ece09705e07f65c7c</a><br>
WASM: <a href="https://github.com/xflops/flame/pull/75/files#diff-cb3f76ea005ef90eb514c6baf71a09bd928befb8f267ef204ea8474036dc172b">https://github.com/xflops/flame/pull/75/files#diff-cb3f76ea005ef90eb514c6baf71a09bd928befb8f267ef204ea8474036dc172b</a></p>
<h3>Steps to Reproduce</h3>
<ul>
<li>Compile local bin by <code>cargo build -p matrix-local</code></li>
<li>Compile WASM by <code>cargo wasi build -p matrix-server</code></li>
<li>Run <code>./target/debug/matrix-local</code></li>
</ul>
<h3>Expected Results</h3>
<p>WASM can execute as normal</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">matrix</span><span class="o">-</span><span class="n">local</span>
<span class="n">Error</span>: <span class="nc">NotFound</span><span class="p">(</span><span class="s">"unknown import: `wasi_snapshot_preview1::fd_write` has not been defined"</span><span class="p">)</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 15.0.1</p>
<p>Operating system: ubuntu 22.04</p>
<p>Architecture: x86</p>
<h3>Extra Info</h3>
<p>And I'd like to pass through a string and binary data into WASM, e.g. <code>on_session_enter</code>, <code>on_session_leave</code> and <code>on_task_invoke</code>.<br>
</p>
</blockquote>



<a name="408503656"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237697%20unknown%20import%3A%20%60wasi_snapshot_pre.../near/408503656" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237697.20unknown.20import.3A.20.60wasi_snapshot_pre.2E.2E.2E.html#408503656">(Dec 18 2023 at 01:48)</a>:</h4>
<p>k82cn <a href="https://github.com/bytecodealliance/wasmtime/issues/7697#issuecomment-1859414870">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7697">issue #7697</a>:</p>
<blockquote>
<p>Re wasi-preview2: thanks very much, I'm going to have a try.</p>
</blockquote>



<a name="436521016"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237697%20unknown%20import%3A%20%60wasi_snapshot_pre.../near/436521016" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237697.20unknown.20import.3A.20.60wasi_snapshot_pre.2E.2E.2E.html#436521016">(May 01 2024 at 15:21)</a>:</h4>
<p>maxwellflitton <a href="https://github.com/bytecodealliance/wasmtime/issues/7697#issuecomment-2088625115">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7697">issue #7697</a>:</p>
<blockquote>
<p>@bjorn3 the links you have given no longer work. There seems to be a new <code>add_to_linker</code> function below:<br>
<a href="https://docs.rs/wasmtime-wasi/latest/wasmtime_wasi/preview1/wasi_snapshot_preview1/fn.add_to_linker.html">https://docs.rs/wasmtime-wasi/latest/wasmtime_wasi/preview1/wasi_snapshot_preview1/fn.add_to_linker.html</a><br>
but I can't see a shred of code that shows how to use this.</p>
</blockquote>



<a name="436521450"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237697%20unknown%20import%3A%20%60wasi_snapshot_pre.../near/436521450" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237697.20unknown.20import.3A.20.60wasi_snapshot_pre.2E.2E.2E.html#436521450">(May 01 2024 at 15:24)</a>:</h4>
<p>maxwellflitton deleted a <a href="https://github.com/bytecodealliance/wasmtime/issues/7697#issuecomment-2088625115">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7697">issue #7697</a>:</p>
<blockquote>
<p>@bjorn3 the links you have given no longer work. There seems to be a new <code>add_to_linker</code> function below:<br>
<a href="https://docs.rs/wasmtime-wasi/latest/wasmtime_wasi/preview1/wasi_snapshot_preview1/fn.add_to_linker.html">https://docs.rs/wasmtime-wasi/latest/wasmtime_wasi/preview1/wasi_snapshot_preview1/fn.add_to_linker.html</a><br>
but I can't see a shred of code that shows how to use this.</p>
</blockquote>



<a name="436522855"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237697%20unknown%20import%3A%20%60wasi_snapshot_pre.../near/436522855" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237697.20unknown.20import.3A.20.60wasi_snapshot_pre.2E.2E.2E.html#436522855">(May 01 2024 at 15:33)</a>:</h4>
<p>maxwellflitton <a href="https://github.com/bytecodealliance/wasmtime/issues/7697#issuecomment-2088642134">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7697">issue #7697</a>:</p>
<blockquote>
<p>@bjorn3 There's been some changes in the API, however, I'm getting the same error. My <code>Cargo.toml</code> has the following:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">wasm</span><span class="o">-</span><span class="n">bindgen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"0.2"</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"serde-serialize"</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>
<span class="n">wasm</span><span class="o">-</span><span class="n">bindgen</span><span class="o">-</span><span class="n">futures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"0.4.42"</span>
<span class="n">bincode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"1.3.3"</span>
<span class="n">tokio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"1.0"</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"full"</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>
<span class="n">wasmtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"20.0.0"</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"runtime"</span><span class="p">,</span><span class="w"> </span><span class="s">"async"</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>
<span class="n">wasmtime</span><span class="o">-</span><span class="n">wasi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"20.0.0"</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"preview1"</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>
<p>And my code consists of the following:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="o">*</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime_wasi</span>::<span class="n">WasiCtxBuilder</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime_wasi</span>::<span class="n">preview1</span>::<span class="n">wasi_snapshot_preview1</span>::<span class="n">add_to_linker</span><span class="p">;</span>

<span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">async_support</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasiCtxBuilder</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">inherit_stdio</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">inherit_args</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">build_p1</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">wasi</span><span class="p">);</span>

<span class="w">    </span><span class="n">add_to_linker</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">s</span><span class="o">|</span><span class="w"> </span><span class="n">s</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span>::<span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="s">"../wasi-server/wasi_server.wasm"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linker</span><span class="p">.</span><span class="n">instantiate_async</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>But I get the following error on the <code>let link = linker.instantiate_async(&amp;mut store, &amp;module).await.unwrap();</code>:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Result</span>::<span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="nb">Err</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>: <span class="nc">unknown</span><span class="w"> </span><span class="n">import</span>: <span class="err">`</span><span class="n">wasi_snapshot_preview1</span>::<span class="n">fd_write</span><span class="err">`</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">defined</span>
<span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="436746951"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237697%20unknown%20import%3A%20%60wasi_snapshot_pre.../near/436746951" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237697.20unknown.20import.3A.20.60wasi_snapshot_pre.2E.2E.2E.html#436746951">(May 02 2024 at 17:53)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/7697#issuecomment-2091169756">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7697">issue #7697</a>:</p>
<blockquote>
<p>@maxwellflitton you might be interested in the <a href="https://docs.rs/wasmtime-wasi/20.0.0/wasmtime_wasi/preview1/index.html">documentation</a> to get started here, namely you're missing a call to <a href="https://docs.rs/wasmtime-wasi/20.0.0/wasmtime_wasi/preview1/fn.add_to_linker_async.html"><code>add_to_linker_async</code></a></p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>