<html>
<head><meta charset="utf-8"><title>wasmtime / PR #4551 Implement an incremental compilation ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html">wasmtime / PR #4551 Implement an incremental compilation ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="291227048"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291227048" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291227048">(Jul 28 2022 at 17:38)</a>:</h4>
<p>bnjbvr opened <a href="https://github.com/bytecodealliance/wasmtime/pull/4551">PR #4551</a> from <code>wip-05-09_wasm_cache</code> to <code>main</code>:</p>
<blockquote>
<p>[Opening a draft for discussions; there are a remaining TODOs i'll need to address, and I hope to write a better PR description here.]</p>
<p>This is the implementation of <a href="https://github.com/bytecodealliance/wasmtime/issues/4155">https://github.com/bytecodealliance/wasmtime/issues/4155</a>, using the "inverted API" approach suggested by @cfallin (thanks!) in Cranelift, and trait object to provide a backend for an all-included experience in Wasmtime. </p>
<p>Thanks to both @alexcrichton and @cfallin for your very useful feedback on Zulip.</p>
<p>Fixes #4155.</p>
</blockquote>



<a name="291227097"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291227097" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291227097">(Jul 28 2022 at 17:38)</a>:</h4>
<p>bnjbvr edited <a href="https://github.com/bytecodealliance/wasmtime/pull/4551">PR #4551</a> from <code>wip-05-09_wasm_cache</code> to <code>main</code>:</p>
<blockquote>
<p>[Opening a draft for discussions; there are a remaining TODOs i'll need to address, and I hope to write a better PR description here.]</p>
<p>This is the implementation of <a href="https://github.com/bytecodealliance/wasmtime/issues/4155">https://github.com/bytecodealliance/wasmtime/issues/4155</a>, using the "inverted API" approach suggested by @cfallin (thanks!) in Cranelift, and trait object to provide a backend for an all-included experience in Wasmtime. </p>
<p>Thanks to both @alexcrichton and @cfallin for your very useful feedback on Zulip.</p>
<p>Fixes #4155.</p>
</blockquote>



<a name="291233163"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291233163" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291233163">(Jul 28 2022 at 18:30)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r932553701">PR review comment</a>:</p>
<blockquote>
<p>A 64bit hash may be too small to be safely used in adversarial cases.</p>
</blockquote>



<a name="291233164"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291233164" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291233164">(Jul 28 2022 at 18:30)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1054575571">PR review</a>.</p>



<a name="291233672"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291233672" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291233672">(Jul 28 2022 at 18:34)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1054579849">PR review</a>.</p>



<a name="291233674"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291233674" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291233674">(Jul 28 2022 at 18:34)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r932556728">PR review comment</a>:</p>
<blockquote>
<p>Won't this cause miscompilations when you at first call functions a, a, b and the next time a, b, b as there is no way to distinguish them based on the cache key?</p>
</blockquote>



<a name="291233955"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291233955" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291233955">(Jul 28 2022 at 18:36)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r932558642">PR review comment</a>:</p>
<blockquote>
<p>Shouldn't this use a cryptographically secure hash function? FxHasher is known to have hash collisions. It is a quick and dirty hash function only suitable when you can handle hash collisions, like in a hash table.</p>
</blockquote>



<a name="291233956"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291233956" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291233956">(Jul 28 2022 at 18:36)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1054582569">PR review</a>.</p>



<a name="291234018"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291234018" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291234018">(Jul 28 2022 at 18:37)</a>:</h4>
<p>bjorn3 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r932558642">PR review comment</a>.</p>



<a name="291234218"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291234218" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291234218">(Jul 28 2022 at 18:39)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r932560533">PR review comment</a>:</p>
<blockquote>
<p>I believe you can access all these through the public api's. I did prefer that over direct accesses as it is less likely to violate invariants.</p>
</blockquote>



<a name="291234219"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291234219" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291234219">(Jul 28 2022 at 18:39)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1054585243">PR review</a>.</p>



<a name="291235056"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291235056" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291235056">(Jul 28 2022 at 18:46)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1054593006">PR review</a>.</p>



<a name="291235057"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291235057" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291235057">(Jul 28 2022 at 18:46)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r932566058">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>        for _ in 0..self.param(&amp;self.config.funcrefs_per_function)? {
</code></pre></div><br>
</p>
</blockquote>



<a name="291236116"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291236116" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291236116">(Jul 28 2022 at 18:55)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1054603383">PR review</a>.</p>



<a name="291236117"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291236117" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291236117">(Jul 28 2022 at 18:55)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r932573265">PR review comment</a>:</p>
<blockquote>
<p>Can we refactor this to use <code>generate_func</code> above?</p>
</blockquote>



<a name="291239061"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291239061" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291239061">(Jul 28 2022 at 19:18)</a>:</h4>
<p>afonso360 deleted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r932573265">PR review comment</a>.</p>



<a name="291239313"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291239313" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291239313">(Jul 28 2022 at 19:21)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1054631179">PR review</a>.</p>



<a name="291239314"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291239314" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291239314">(Jul 28 2022 at 19:21)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r932592413">PR review comment</a>:</p>
<blockquote>
<p>Can we refactor this to use <code>generate_func</code> above?</p>
</blockquote>



<a name="291351948"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291351948" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291351948">(Jul 29 2022 at 16:58)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1055839596">PR review</a>.</p>



<a name="291353542"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291353542" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291353542">(Jul 29 2022 at 17:11)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1055852968">PR review</a>.</p>



<a name="291571556"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291571556" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291571556">(Aug 01 2022 at 13:05)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r934506412">PR review comment</a>:</p>
<blockquote>
<p>That's the thing: there's a perfect bijection between Func's <code>FuncRef</code> and <code>ExternalName</code>, so we don't need to record the external names, and we can just be "resilient" with them, meaning that it's fine to the actual callees change. This will end up generating different <code>MachReloc</code> later.</p>
<p>I think Chris' suggestion to split the <code>Function</code>/<code>MachCompileResult</code> into the "core" and parameters ought to make this clearer and easier to understand.</p>
</blockquote>



<a name="291571557"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291571557" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291571557">(Aug 01 2022 at 13:05)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1057264498">PR review</a>.</p>



<a name="291571605"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291571605" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291571605">(Aug 01 2022 at 13:05)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r934506771">PR review comment</a>:</p>
<blockquote>
<p>See other answer below.</p>
</blockquote>



<a name="291571606"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291571606" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291571606">(Aug 01 2022 at 13:05)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1057265080">PR review</a>.</p>



<a name="291571900"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291571900" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291571900">(Aug 01 2022 at 13:07)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1057267329">PR review</a>.</p>



<a name="291571901"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291571901" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291571901">(Aug 01 2022 at 13:07)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r934508251">PR review comment</a>:</p>
<blockquote>
<p>It doesn't have to be, because right now the incremental cache first looks up using the <code>CacheKeyHash</code>, and then compares against the <code>CacheKey</code>, exactly as <code>HashMap</code>s do first the hashing and then use the <code>PartialEq</code> to check for equality.</p>
<p>This was a very safe first way to implement this, and it's also what limits performance of reloads. An alternative way would be to use a safe, longer hash here (as you suggest in this and the other comment above), and see if we can get rid of the equality check in that case. I'd like to experiment with this, likely later.</p>
</blockquote>



<a name="291571914"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291571914" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291571914">(Aug 01 2022 at 13:07)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r934508383">PR review comment</a>:</p>
<blockquote>
<p>Good catch, thanks!</p>
</blockquote>



<a name="291571915"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291571915" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291571915">(Aug 01 2022 at 13:07)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1057267518">PR review</a>.</p>



<a name="291577707"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291577707" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291577707">(Aug 01 2022 at 13:48)</a>:</h4>
<p>bnjbvr updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4551">PR #4551</a> from <code>wip-05-09_wasm_cache</code> to <code>main</code>.</p>



<a name="291590724"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291590724" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291590724">(Aug 01 2022 at 15:27)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1057487366">PR review</a>.</p>



<a name="291590725"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291590725" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291590725">(Aug 01 2022 at 15:27)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r934656379">PR review comment</a>:</p>
<blockquote>
<blockquote>
<p>That's the thing: there's a perfect bijection between Func's FuncRef and ExternalName, so we don't need to record the external names, and we can just be "resilient" with them, meaning that it's fine to the actual callees change. This will end up generating different MachReloc later.</p>
</blockquote>
<p>I don't see how a bijection helps.</p>
</blockquote>



<a name="291591256"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291591256" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291591256">(Aug 01 2022 at 15:31)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1057493510">PR review</a>.</p>



<a name="291591261"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291591261" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291591261">(Aug 01 2022 at 15:31)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r934660672">PR review comment</a>:</p>
<blockquote>
<p>Right now, the <code>MachReloc</code>s contain some <code>ExternalName</code>s, when the <code>MachCompileResult</code> is cached. When we load from the cache, and have a function with different <code>FuncRef</code>s -&gt; <code>ExternalName</code>s, we can:</p>
<ol>
<li>first lookup what <code>FuncRef</code> in the original function caused the <code>ExternalName</code> to pop up in the <code>MachReloc</code>, since it's a bijection</li>
<li>use the <code>FuncRef</code> -&gt; <code>ExternalName</code> from the function-to-compile to rewrite the <code>MachReloc</code> on the fly</li>
</ol>
</blockquote>



<a name="291591872"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291591872" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291591872">(Aug 01 2022 at 15:35)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1057499384">PR review</a>.</p>



<a name="291591877"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291591877" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291591877">(Aug 01 2022 at 15:35)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r934664892">PR review comment</a>:</p>
<blockquote>
<p>(... so we might as well just use the <code>FuncRef</code> everywhere directly, to avoid maintaining the invariant that we want this bijection; and this is in line with what Chris suggested in his comment, so I'm doing that now.)</p>
</blockquote>



<a name="291602528"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291602528" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291602528">(Aug 01 2022 at 16:50)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1057591868">PR review</a>.</p>



<a name="291602529"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291602529" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291602529">(Aug 01 2022 at 16:50)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r934730187">PR review comment</a>:</p>
<blockquote>
<blockquote>
<p>When we load from the cache, and have a function with different FuncRefs -&gt; ExternalNames, we can:</p>
</blockquote>
<p>But what if you have a function with the same FuncRef -&gt; ExternalName, but where the body eg calls functions in a different order?</p>
</blockquote>



<a name="291602539"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291602539" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291602539">(Aug 01 2022 at 16:50)</a>:</h4>
<p>bjorn3 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r934730187">PR review comment</a>.</p>



<a name="291675134"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291675134" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291675134">(Aug 02 2022 at 07:43)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1058268290">PR review</a>.</p>



<a name="291675135"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291675135" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291675135">(Aug 02 2022 at 07:43)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r935221922">PR review comment</a>:</p>
<blockquote>
<p>Each different function call (<code>ir::Opcode::Call</code>) references the <code>FuncRef</code> it's calling, so this is entirely determined by the CLIF IR. If two functions have the same body and each call two functions, but two different functions, then two different <code>FuncRef</code> are involved, leading to different lookups in the <code>FuncRef -&gt; ExternalName</code> mapping, thus different <code>ExternalName</code>s. (Well, that's assuming that the <code>ExternalName</code>s are all different from each other, which would be important if we stayed down that path but that's not the case.)</p>
</blockquote>



<a name="291706624"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291706624" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291706624">(Aug 02 2022 at 13:12)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1058746857">PR review</a>.</p>



<a name="291706625"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291706625" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291706625">(Aug 02 2022 at 13:12)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r935577797">PR review comment</a>:</p>
<blockquote>
<p>You are normalizing away the difference between different ExternalName's away here, right? <code>CachedExternalName::User</code> doesn't have any field to distinguish one from another.</p>
</blockquote>



<a name="291706961"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291706961" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291706961">(Aug 02 2022 at 13:15)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1058751774">PR review</a>.</p>



<a name="291706962"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/291706962" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#291706962">(Aug 02 2022 at 13:15)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r935581179">PR review comment</a>:</p>
<blockquote>
<p>Indeed, because they're "spurious", at this point; only the <code>FuncRef</code> really matters, and there's a way to go from <code>ExternalName</code> back to <code>FuncRef</code> (in the _source_ function that filled the cache), and then from the <code>FuncRef</code> to <code>ExternalName</code> (in the function for which we're reusing the cache).</p>
<p>But don't get too attached to this, it's going to be simplified by Chris' suggestion below :)</p>
</blockquote>



<a name="292642475"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/292642475" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#292642475">(Aug 09 2022 at 19:24)</a>:</h4>
<p>bnjbvr updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4551">PR #4551</a> from <code>wip-05-09_wasm_cache</code> to <code>main</code>.</p>



<a name="292769915"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/292769915" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#292769915">(Aug 10 2022 at 14:51)</a>:</h4>
<p>bnjbvr updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4551">PR #4551</a> from <code>wip-05-09_wasm_cache</code> to <code>main</code>.</p>



<a name="292780892"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/292780892" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#292780892">(Aug 10 2022 at 15:48)</a>:</h4>
<p>bnjbvr updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4551">PR #4551</a> from <code>wip-05-09_wasm_cache</code> to <code>main</code>.</p>



<a name="292784826"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/292784826" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#292784826">(Aug 10 2022 at 16:04)</a>:</h4>
<p>bnjbvr edited <a href="https://github.com/bytecodealliance/wasmtime/pull/4551">PR #4551</a> from <code>wip-05-09_wasm_cache</code> to <code>main</code>:</p>
<blockquote>
<p>This is the implementation of <a href="https://github.com/bytecodealliance/wasmtime/issues/4155">https://github.com/bytecodealliance/wasmtime/issues/4155</a>, using the "inverted API" approach suggested by @cfallin (thanks!) in Cranelift, and trait object to provide a backend for an all-included experience in Wasmtime. </p>
<p>After the suggestion of Chris, <code>Function</code> has been split into mostly two parts:</p>
<ul>
<li>on the one hand, <code>FunctionStencil</code> contains all the fields required during compilation, and that act as a compilation cache key: if two function stencils are the same, then the result of their compilation (<code>CompiledCodeBase&lt;Stencil&gt;</code>) will be the same. This makes caching trivial, as the only thing to cache is the <code>FunctionStencil</code>.</li>
<li>on the other hand, <code>FunctionParameters</code> contain the... function parameters that are required to finalize the result of compilation into a <code>CompiledCode</code> (aka <code>CompiledCodeBase&lt;Final&gt;</code>) with proper final relocations etc., by applying fixups and so on.</li>
</ul>
<p>Most changes are here to accomodate those requirements, in particular that <code>FunctionStencil</code> should be <code>Hash</code>able to be used as a key in the cache:</p>
<ul>
<li>most source locations are now relative to a base source location in the function, and as such they're encoded as <code>RelSourceLoc</code> in the <code>FunctionStencil</code>. This required changes so that there's no need to explicitly mark a <code>SourceLoc</code> as the base source location, it's automatically detected instead the first time a non-default <code>SourceLoc</code> is set.</li>
<li>user-defined external names in the <code>FunctionStencil</code> (aka before this patch <code>ExternalName::User { namespace, index }</code>) are now references into an external table of <code>UserExternalNameRef -&gt; UserExternalName</code>, present in the <code>FunctionParameters</code>, and must be explicitly declared using <code>Function::declare_imported_user_function</code>.</li>
<li>some refactorings have been made for function names:<ul>
<li><code>ExternalName</code> was used as the type for a <code>Function</code>'s name; while it thus allowed <code>ExternalName::Libcall</code> in this place, this would have been quite confusing to use it there. Instead, a new enum <code>UserFuncName</code> is introduced for this name, that's either a user-defined function name (the above <code>UserExternalName</code>) or a test case name.</li>
<li>The future of <code>ExternalName</code> is likely to become a full reference into the <code>FunctionParameters</code>'s mapping, instead of being "either a handle for user-defined external names, or the thing itself for other variants". I'm running out of time to do this, and this is not trivial as it implies touching ISLE which I'm less familiar with.</li>
</ul>
</li>
</ul>
<p>The cache computes a sha256 hash of the <code>FunctionStencil</code>, and uses this as the cache key. No equality check (using <code>PartialEq</code>) is performed in addition to the hash being the same, as we hope that this is sufficient data to avoid collisions.</p>
<p>A basic fuzz target has been introduced that tries to do the bare minimum:</p>
<ul>
<li>check that a function successfully compiled and cached will be also successfully reloaded from the cache, and returns the exact same function.</li>
<li>check that a trivial modification in the external mapping of <code>UserExternalNameRef -&gt; UserExternalName</code> hits the cache, and that other modifications don't hit the cache.<ul>
<li>This last check is less efficient and less likely to happen, so probably should be rethought a bit.</li>
</ul>
</li>
</ul>
<p>Thanks to both @alexcrichton and @cfallin for your very useful feedback on Zulip.</p>
<p>Some numbers show that for a large wasm module we're using internally, this is a 20% compile-time speedup, because so many <code>FunctionStencil</code>s are the same, even within a single module. For a group of modules that have a lot of code in common, we get hit rates up to 70% when they're used together. When a single function changes in a wasm module, every other function is reloaded; that's still slower than I expect (between 10% and 50% of the overall compile time), so there's likely room for improvement. </p>
<p>Fixes #4155.</p>
</blockquote>



<a name="292786330"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/292786330" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#292786330">(Aug 10 2022 at 16:14)</a>:</h4>
<p><strong>bnjbvr</strong> has marked <a href="https://github.com/bytecodealliance/wasmtime/pull/4551">PR #4551</a> as ready for review.</p>



<a name="292786347"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/292786347" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#292786347">(Aug 10 2022 at 16:14)</a>:</h4>
<p><strong>bnjbvr</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/4551">PR #4551</a>.</p>



<a name="292792385"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/292792385" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#292792385">(Aug 10 2022 at 16:48)</a>:</h4>
<p>bnjbvr updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4551">PR #4551</a> from <code>wip-05-09_wasm_cache</code> to <code>main</code>.</p>



<a name="292793199"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/292793199" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#292793199">(Aug 10 2022 at 16:53)</a>:</h4>
<p>bnjbvr updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4551">PR #4551</a> from <code>wip-05-09_wasm_cache</code> to <code>main</code>.</p>



<a name="292970969"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/292970969" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#292970969">(Aug 11 2022 at 17:09)</a>:</h4>
<p>bnjbvr updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4551">PR #4551</a> from <code>wip-05-09_wasm_cache</code> to <code>main</code>.</p>



<a name="292972671"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/292972671" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#292972671">(Aug 11 2022 at 17:20)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1070077008">PR review</a>.</p>



<a name="292983880"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/292983880" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#292983880">(Aug 11 2022 at 18:27)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4551">PR #4551</a> from <code>wip-05-09_wasm_cache</code> to <code>main</code>.</p>



<a name="292991283"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/292991283" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#292991283">(Aug 11 2022 at 19:12)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1070224462">PR review</a>.</p>



<a name="292991284"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/292991284" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#292991284">(Aug 11 2022 at 19:12)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r943837886">PR review comment</a>:</p>
<blockquote>
<p>This error message is confusing if the consumer of cranelift is not wasmtime.</p>
</blockquote>



<a name="292991674"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/292991674" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#292991674">(Aug 11 2022 at 19:14)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1070229320">PR review</a>.</p>



<a name="292991675"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/292991675" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#292991675">(Aug 11 2022 at 19:14)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r943842368">PR review comment</a>:</p>
<blockquote>
<p>Maybe use SecondaryMap instead? BTreeMap results in a lot of code bloat (significantly more than HashMap) and is not very efficient for dense maps. It is reasonably efficient for sparse maps though.</p>
</blockquote>



<a name="292992105"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/292992105" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#292992105">(Aug 11 2022 at 19:17)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1070234695">PR review</a>.</p>



<a name="292992106"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/292992106" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#292992106">(Aug 11 2022 at 19:17)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r943846905">PR review comment</a>:</p>
<blockquote>
<p>Does using RelSourceLoc the same way as SourceLoc give correct results? In cg_clif SourceLoc is already function local. (It is backed by an IndexSet with mir::SourceLoc as entries)</p>
</blockquote>



<a name="292993130"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/292993130" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#292993130">(Aug 11 2022 at 19:23)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1070241874">PR review</a>.</p>



<a name="292993131"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/292993131" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#292993131">(Aug 11 2022 at 19:23)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r943851673">PR review comment</a>:</p>
<blockquote>
<p>What are calls to these supposed to be replaced with?</p>
</blockquote>



<a name="292993253"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/292993253" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#292993253">(Aug 11 2022 at 19:23)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1070242770">PR review</a>.</p>



<a name="292993255"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/292993255" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#292993255">(Aug 11 2022 at 19:23)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r943852328">PR review comment</a>:</p>
<blockquote>
<p>???? Why do you need a Function to define a data object?</p>
</blockquote>



<a name="292993334"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/292993334" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#292993334">(Aug 11 2022 at 19:24)</a>:</h4>
<p>bjorn3 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r943852328">PR review comment</a>.</p>



<a name="293137198"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/293137198" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#293137198">(Aug 12 2022 at 15:35)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r944585477">PR review comment</a>:</p>
<blockquote>
<p>I've ran into bad perf regressions b/o SecondaryMap auto resize behaviors, so I'm a bit dubious about this. We could reevaluate later.</p>
</blockquote>



<a name="293137199"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/293137199" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#293137199">(Aug 12 2022 at 15:35)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1071269792">PR review</a>.</p>



<a name="293137437"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/293137437" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#293137437">(Aug 12 2022 at 15:37)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1071271223">PR review</a>.</p>



<a name="293137438"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/293137438" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#293137438">(Aug 12 2022 at 15:37)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r944586393">PR review comment</a>:</p>
<blockquote>
<p>Yes, it's mostly used internally so I wouldn't even expect embedders to interact with it.</p>
</blockquote>



<a name="293138596"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/293138596" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#293138596">(Aug 12 2022 at 15:42)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1071279093">PR review</a>.</p>



<a name="293138599"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/293138599" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#293138599">(Aug 12 2022 at 15:42)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r944591666">PR review comment</a>:</p>
<blockquote>
<p>It was to process relocations (to extract the , but now I can see that <code>DataDescription</code> abuses the <code>MachReloc</code> and it should be its own type that doesn't use <code>ir::ExternalName</code> at all, now that the latter uses references into an external table for lookup. I'll try doing this quickly, but if it takes too long I'd prefer that somebody who understands this code better take a look.</p>
</blockquote>



<a name="293142727"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/293142727" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#293142727">(Aug 12 2022 at 16:02)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1071305982">PR review</a>.</p>



<a name="293142728"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/293142728" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#293142728">(Aug 12 2022 at 16:02)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r944609087">PR review comment</a>:</p>
<blockquote>
<p>I managed to put them back eventually.</p>
</blockquote>



<a name="293142874"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/293142874" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#293142874">(Aug 12 2022 at 16:03)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r944609623">PR review comment</a>:</p>
<blockquote>
<p>That wasn't too hard, eventually; there's now a <code>ModuleReloc</code> that is a <code>MachReloc</code> but using <code>ModuleExtName</code> (which embeds user-defined name) instead of <code>ir::ExternalName</code> for names.</p>
</blockquote>



<a name="293142875"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/293142875" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#293142875">(Aug 12 2022 at 16:03)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1071306750">PR review</a>.</p>



<a name="293144931"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/293144931" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#293144931">(Aug 12 2022 at 16:14)</a>:</h4>
<p>bnjbvr updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4551">PR #4551</a> from <code>wip-05-09_wasm_cache</code> to <code>main</code>.</p>



<a name="293145055"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/293145055" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#293145055">(Aug 12 2022 at 16:15)</a>:</h4>
<p>bnjbvr has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/4551">PR #4551</a>.</p>



<a name="293145074"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/293145074" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#293145074">(Aug 12 2022 at 16:15)</a>:</h4>
<p>bnjbvr has disabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/4551">PR #4551</a>.</p>



<a name="293145109"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/293145109" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#293145109">(Aug 12 2022 at 16:15)</a>:</h4>
<p>bnjbvr updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4551">PR #4551</a> from <code>wip-05-09_wasm_cache</code> to <code>main</code>.</p>



<a name="293145198"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/293145198" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#293145198">(Aug 12 2022 at 16:16)</a>:</h4>
<p>bnjbvr has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/4551">PR #4551</a>.</p>



<a name="293146430"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/293146430" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#293146430">(Aug 12 2022 at 16:22)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1071329018">PR review</a>.</p>



<a name="293146431"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/293146431" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#293146431">(Aug 12 2022 at 16:22)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r944624362">PR review comment</a>:</p>
<blockquote>
<p>These haven't yet been re-added.</p>
</blockquote>



<a name="293151204"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/293151204" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#293151204">(Aug 12 2022 at 16:47)</a>:</h4>
<p>bnjbvr merged <a href="https://github.com/bytecodealliance/wasmtime/pull/4551">PR #4551</a>.</p>



<a name="293161034"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/293161034" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#293161034">(Aug 12 2022 at 17:42)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1071425536">PR review</a>.</p>



<a name="293161035"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/293161035" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#293161035">(Aug 12 2022 at 17:42)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r944679458">PR review comment</a>:</p>
<blockquote>
<p>@bnjbvr?</p>
</blockquote>



<a name="293675091"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/293675091" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#293675091">(Aug 16 2022 at 08:37)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r946491567">PR review comment</a>:</p>
<blockquote>
<p>Ah yeah, seems I added it back in one implementation, but not in the trait. Is that something that you were using, @bjorn3? I could add it back later, if required</p>
</blockquote>



<a name="293675092"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/293675092" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#293675092">(Aug 16 2022 at 08:37)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1073715873">PR review</a>.</p>



<a name="293678721"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/293678721" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#293678721">(Aug 16 2022 at 09:07)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r946522164">PR review comment</a>:</p>
<blockquote>
<p>This change means that <code>declare_func_in_data</code> and <code>declare_data_in_data</code> are no longer forwarded to <code>FooModule</code> when you call them on a <code>&amp;mut FooModule</code>, which is incorrect if those functions have been overwritten by <code>FooModule</code>.</p>
</blockquote>



<a name="293678722"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/293678722" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#293678722">(Aug 16 2022 at 09:07)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1073758830">PR review</a>.</p>



<a name="293679444"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/293679444" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#293679444">(Aug 16 2022 at 09:13)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r946528207">PR review comment</a>:</p>
<blockquote>
<p>I see; it's likely subpar design if the default implementation is incorrect for some implementations by default, but that's a different discussion to have :) Will post a small patch for this chunk.</p>
</blockquote>



<a name="293679445"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234551%20Implement%20an%20incremental%20compilation%20.../near/293679445" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234551.20Implement.20an.20incremental.20compilation.20.2E.2E.2E.html#293679445">(Aug 16 2022 at 09:13)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1073767394">PR review</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>