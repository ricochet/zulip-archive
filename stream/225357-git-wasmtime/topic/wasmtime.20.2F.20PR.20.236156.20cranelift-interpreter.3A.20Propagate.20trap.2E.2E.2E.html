<html>
<head><meta charset="utf-8"><title>wasmtime / PR #6156 cranelift-interpreter: Propagate trap... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236156.20cranelift-interpreter.3A.20Propagate.20trap.2E.2E.2E.html">wasmtime / PR #6156 cranelift-interpreter: Propagate trap...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="347226100"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236156%20cranelift-interpreter%3A%20Propagate%20trap.../near/347226100" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236156.20cranelift-interpreter.3A.20Propagate.20trap.2E.2E.2E.html#347226100">(Apr 05 2023 at 18:23)</a>:</h4>
<p>afonso360 opened <a href="https://github.com/bytecodealliance/wasmtime/pull/6156">PR #6156</a> from <code>afonso360:interp-call-trap</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>Fuzzgen found a bug in the interpreter (#6155) where if a function called another function and the child function trapped, the interpreter was panicking instead of propagating the trap correctly.</p>
<p>This PR fixes that by propagating the trap up instead of panicking.</p>
<p>Fixes: #6155</p>
</blockquote>



<a name="347226101"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236156%20cranelift-interpreter%3A%20Propagate%20trap.../near/347226101" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236156.20cranelift-interpreter.3A.20Propagate.20trap.2E.2E.2E.html#347226101">(Apr 05 2023 at 18:23)</a>:</h4>
<p><strong>afonso360</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6156">PR #6156</a>.</p>



<a name="347226102"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236156%20cranelift-interpreter%3A%20Propagate%20trap.../near/347226102" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236156.20cranelift-interpreter.3A.20Propagate.20trap.2E.2E.2E.html#347226102">(Apr 05 2023 at 18:23)</a>:</h4>
<p><strong>afonso360</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6156">PR #6156</a>.</p>



<a name="347226374"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236156%20cranelift-interpreter%3A%20Propagate%20trap.../near/347226374" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236156.20cranelift-interpreter.3A.20Propagate.20trap.2E.2E.2E.html#347226374">(Apr 05 2023 at 18:25)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6156">PR #6156</a>.</p>



<a name="347226572"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236156%20cranelift-interpreter%3A%20Propagate%20trap.../near/347226572" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236156.20cranelift-interpreter.3A.20Propagate.20trap.2E.2E.2E.html#347226572">(Apr 05 2023 at 18:26)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/6156">PR #6156</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>Fuzzgen found a bug in the interpreter (#6155) where if a function called another function and the child function trapped, the interpreter was panicking instead of propagating the trap correctly.</p>
<p>This PR fixes that by propagating the trap up instead of panicking.</p>
<p>Fixes: #6155</p>
</blockquote>



<a name="347226784"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236156%20cranelift-interpreter%3A%20Propagate%20trap.../near/347226784" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236156.20cranelift-interpreter.3A.20Propagate.20trap.2E.2E.2E.html#347226784">(Apr 05 2023 at 18:27)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6156#pullrequestreview-1373466287">PR review</a>.</p>



<a name="347226785"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236156%20cranelift-interpreter%3A%20Propagate%20trap.../near/347226785" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236156.20cranelift-interpreter.3A.20Propagate.20trap.2E.2E.2E.html#347226785">(Apr 05 2023 at 18:27)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/6156#discussion_r1158871812">PR review comment</a>:</p>
<blockquote>
<p>Maybe remove the <code>unwrap_return</code> method to avoid this footgun for others?</p>
</blockquote>



<a name="347230574"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236156%20cranelift-interpreter%3A%20Propagate%20trap.../near/347230574" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236156.20cranelift-interpreter.3A.20Propagate.20trap.2E.2E.2E.html#347230574">(Apr 05 2023 at 18:47)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6156#pullrequestreview-1373496366">PR review</a>.</p>



<a name="347230575"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236156%20cranelift-interpreter%3A%20Propagate%20trap.../near/347230575" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236156.20cranelift-interpreter.3A.20Propagate.20trap.2E.2E.2E.html#347230575">(Apr 05 2023 at 18:47)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/6156#discussion_r1158893011">PR review comment</a>:</p>
<blockquote>
<p>We use it a lot in the rest of the tests so it still has some use. But I'll add a <code>cfg(test)</code></p>
</blockquote>



<a name="347230944"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236156%20cranelift-interpreter%3A%20Propagate%20trap.../near/347230944" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236156.20cranelift-interpreter.3A.20Propagate.20trap.2E.2E.2E.html#347230944">(Apr 05 2023 at 18:48)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6156">PR #6156</a>.</p>



<a name="347231047"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236156%20cranelift-interpreter%3A%20Propagate%20trap.../near/347231047" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236156.20cranelift-interpreter.3A.20Propagate.20trap.2E.2E.2E.html#347231047">(Apr 05 2023 at 18:49)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6156#pullrequestreview-1373499922">PR review</a>.</p>



<a name="347231051"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236156%20cranelift-interpreter%3A%20Propagate%20trap.../near/347231051" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236156.20cranelift-interpreter.3A.20Propagate.20trap.2E.2E.2E.html#347231051">(Apr 05 2023 at 18:49)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/6156#discussion_r1158895334">PR review comment</a>:</p>
<blockquote>
<p>The tests can wrap the expected return value in <code>ControlFlow::Return</code> I think if they avoid <code>unwrap_return</code>.</p>
</blockquote>



<a name="347231084"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236156%20cranelift-interpreter%3A%20Propagate%20trap.../near/347231084" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236156.20cranelift-interpreter.3A.20Propagate.20trap.2E.2E.2E.html#347231084">(Apr 05 2023 at 18:49)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/6156#discussion_r1158893011">PR review comment</a>.</p>



<a name="347231967"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236156%20cranelift-interpreter%3A%20Propagate%20trap.../near/347231967" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236156.20cranelift-interpreter.3A.20Propagate.20trap.2E.2E.2E.html#347231967">(Apr 05 2023 at 18:54)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6156#pullrequestreview-1373507050">PR review</a>.</p>



<a name="347231992"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236156%20cranelift-interpreter%3A%20Propagate%20trap.../near/347231992" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236156.20cranelift-interpreter.3A.20Propagate.20trap.2E.2E.2E.html#347231992">(Apr 05 2023 at 18:55)</a>:</h4>
<p>cfallin has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/6156">PR #6156</a>.</p>



<a name="347233945"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236156%20cranelift-interpreter%3A%20Propagate%20trap.../near/347233945" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236156.20cranelift-interpreter.3A.20Propagate.20trap.2E.2E.2E.html#347233945">(Apr 05 2023 at 19:05)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6156#pullrequestreview-1373521506">PR review</a>.</p>



<a name="347233946"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236156%20cranelift-interpreter%3A%20Propagate%20trap.../near/347233946" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236156.20cranelift-interpreter.3A.20Propagate.20trap.2E.2E.2E.html#347233946">(Apr 05 2023 at 19:05)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/6156#discussion_r1158909495">PR review comment</a>:</p>
<blockquote>
<p><code>ControlFlow</code> doesen't implement <code>PartialEq</code> so we can't just do something like <code>assert_eq!(ControlFlow::Return(vec![...]), rets)</code></p>
<p>It doesn't implement PartialEq because it has some function pointers in some of the arms.</p>
</blockquote>



<a name="347234820"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236156%20cranelift-interpreter%3A%20Propagate%20trap.../near/347234820" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236156.20cranelift-interpreter.3A.20Propagate.20trap.2E.2E.2E.html#347234820">(Apr 05 2023 at 19:09)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/6156#discussion_r1158909495">PR review comment</a>.</p>



<a name="347241392"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236156%20cranelift-interpreter%3A%20Propagate%20trap.../near/347241392" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236156.20cranelift-interpreter.3A.20Propagate.20trap.2E.2E.2E.html#347241392">(Apr 05 2023 at 19:48)</a>:</h4>
<p>cfallin merged <a href="https://github.com/bytecodealliance/wasmtime/pull/6156">PR #6156</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>