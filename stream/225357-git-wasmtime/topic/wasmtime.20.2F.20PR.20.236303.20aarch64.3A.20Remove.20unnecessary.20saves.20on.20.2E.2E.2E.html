<html>
<head><meta charset="utf-8"><title>wasmtime / PR #6303 aarch64: Remove unnecessary saves on ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236303.20aarch64.3A.20Remove.20unnecessary.20saves.20on.20.2E.2E.2E.html">wasmtime / PR #6303 aarch64: Remove unnecessary saves on ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="353550151"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236303%20aarch64%3A%20Remove%20unnecessary%20saves%20on%20.../near/353550151" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236303.20aarch64.3A.20Remove.20unnecessary.20saves.20on.20.2E.2E.2E.html#353550151">(Apr 28 2023 at 00:09)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/6303">PR #6303</a> from <code>alexcrichton:save-less</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>The AArch64 AAPCS calling convention, which all our backends use for register allocation, indicates that the low 64-bits of the v8-v15 registers are all caller-saved. Cranelift doesn't track precisely which registers are used, however, so it says the entire register is a caller-saved register. This currently interacts poorly where a call from one function to another where the ABIs differ forces the caller to save all of v8-v15 in the prologue and restore it in the epilogue.</p>
<p>Currently in all cases, however, this isn't actually necessary. The AArch64 backend also has an optimization where if both the caller and the callee are using the same ABI then the clobbers of a <code>call</code> instruction are not counted in the clobber set for the function since nothing new can be clobbered. This way if <code>v8</code> is never used, for example, it's not considered clobbered and it's not saved. This logic, however, is comparing ABIs exactly which means that different names for the same ABI, which don't differ in register allocation, force saves to happen.</p>
<p>This comes up with trampolines generated by Wasmtime where the calling convention of the trampoline is <code>WasmtimeSystemV</code>, for example, where the callee (a wasm function) is <code>Fast</code>. Because these differ it means that all trampolines are generating saves/restores of registers, despite the actual underlying calling convention being the same.</p>
<p>This commit updates the optimization that skips including a <code>call</code> instruction in the clobber set by comparing the caller and callee's ABI clobber sets. If both clobber the same registers then for the purposes of clobbers it's as-if they were the same ABI, so the <code>call</code> can be skipped.</p>
<p>Overall this removes unnecessary saves/restores in trampolines generated by Cranelift and shrinks the size of spidermonkey.wasm by 2% after #6262.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="353550159"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236303%20aarch64%3A%20Remove%20unnecessary%20saves%20on%20.../near/353550159" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236303.20aarch64.3A.20Remove.20unnecessary.20saves.20on.20.2E.2E.2E.html#353550159">(Apr 28 2023 at 00:09)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6303">PR #6303</a>.</p>



<a name="353550160"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236303%20aarch64%3A%20Remove%20unnecessary%20saves%20on%20.../near/353550160" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236303.20aarch64.3A.20Remove.20unnecessary.20saves.20on.20.2E.2E.2E.html#353550160">(Apr 28 2023 at 00:09)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6303">PR #6303</a>.</p>



<a name="353552601"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236303%20aarch64%3A%20Remove%20unnecessary%20saves%20on%20.../near/353552601" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236303.20aarch64.3A.20Remove.20unnecessary.20saves.20on.20.2E.2E.2E.html#353552601">(Apr 28 2023 at 00:17)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6303#pullrequestreview-1405066217">PR review</a>:</p>
<blockquote>
<p>Looks good, thanks!</p>
<p>Strictly speaking the check could be even looser, I think: all that's required is that the clobbers allowed by the caller's ABI <em>contain</em> the clobbers allowed by the callee's ABI. <code>PRegSet</code> is a bitset (<code>u128</code>) internally, so we could implement this with <code>caller_clobbers &amp; callee_clobbers == callee_clobbers</code> (which tests <code>callee_clobbers</code> ⊂ <code>caller_clobbers</code>). Unfortunately this is an opaque newtype wrapper and I didn't think to add <code>.into_bits()</code> at the time, and the definition is in regalloc2. If you feel super-motivated I'm happy to review a PR for that otherwise I think this is totally fine!</p>
</blockquote>



<a name="353942998"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236303%20aarch64%3A%20Remove%20unnecessary%20saves%20on%20.../near/353942998" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236303.20aarch64.3A.20Remove.20unnecessary.20saves.20on.20.2E.2E.2E.html#353942998">(Apr 28 2023 at 15:43)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6303">PR #6303</a>.</p>



<a name="354002284"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236303%20aarch64%3A%20Remove%20unnecessary%20saves%20on%20.../near/354002284" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236303.20aarch64.3A.20Remove.20unnecessary.20saves.20on.20.2E.2E.2E.html#354002284">(Apr 28 2023 at 17:45)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6303#pullrequestreview-1406361522">PR review</a>.</p>



<a name="354019399"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236303%20aarch64%3A%20Remove%20unnecessary%20saves%20on%20.../near/354019399" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236303.20aarch64.3A.20Remove.20unnecessary.20saves.20on.20.2E.2E.2E.html#354019399">(Apr 28 2023 at 18:24)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/6303">PR #6303</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>