<html>
<head><meta charset="utf-8"><title>wasmtime / issue #8556 wasi-preview1-component-adapter: A... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238556.20wasi-preview1-component-adapter.3A.20A.2E.2E.2E.html">wasmtime / issue #8556 wasi-preview1-component-adapter: A...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="437168643"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238556%20wasi-preview1-component-adapter%3A%20A.../near/437168643" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238556.20wasi-preview1-component-adapter.3A.20A.2E.2E.2E.html#437168643">(May 05 2024 at 22:40)</a>:</h4>
<p><a href="https://github.com/dfoxfranke">dfoxfranke</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/8556">Issue #8556</a>.</p>



<a name="437168644"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238556%20wasi-preview1-component-adapter%3A%20A.../near/437168644" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238556.20wasi-preview1-component-adapter.3A.20A.2E.2E.2E.html#437168644">(May 05 2024 at 22:40)</a>:</h4>
<p>dfoxfranke opened <a href="https://github.com/bytecodealliance/wasmtime/issues/8556">issue #8556</a>:</p>
<blockquote>
<p>The <a href="https://github.com/bytecodealliance/wasmtime/blob/d0cf46a098d97bab9c4cf54a2f3aeaddea7d3831/crates/wasi-preview1-component-adapter/src/lib.rs#L2510">single 64KiB page</a> available to <code>BumpArena</code> in <code>wasi-preview1-component-adapter</code> is not reliably sufficient for allocating environment variables during initialization. This problem manifested for me as a <a href="https://github.com/bytecodealliance/jco/issues/433">crash in <code>jco</code></a> when running it inside a NixOS shell with a lot of environment variables set.</p>
</blockquote>



<a name="437356707"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238556%20wasi-preview1-component-adapter%3A%20A.../near/437356707" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238556.20wasi-preview1-component-adapter.3A.20A.2E.2E.2E.html#437356707">(May 07 2024 at 00:05)</a>:</h4>
<p>pchickey assigned pchickey to <a href="https://github.com/bytecodealliance/wasmtime/issues/8556">issue #8556</a>.</p>



<a name="437356881"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238556%20wasi-preview1-component-adapter%3A%20A.../near/437356881" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238556.20wasi-preview1-component-adapter.3A.20A.2E.2E.2E.html#437356881">(May 07 2024 at 00:07)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/issues/8556#issuecomment-2097125324">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8556">issue #8556</a>:</p>
<blockquote>
<p>Thanks for the bug report. I'm not sure how easy this will be to fix, the component-adapter is a very change resistant bit of software, but I believe our original reasons for designing the long-lived BumpArena to have a capped size are no longer valid, so I'm going to see if I can change the design so that that it can grow unbounded.</p>
</blockquote>



<a name="437357113"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238556%20wasi-preview1-component-adapter%3A%20A.../near/437357113" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238556.20wasi-preview1-component-adapter.3A.20A.2E.2E.2E.html#437357113">(May 07 2024 at 00:10)</a>:</h4>
<p>dfoxfranke <a href="https://github.com/bytecodealliance/wasmtime/issues/8556#issuecomment-2097128082">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8556">issue #8556</a>:</p>
<blockquote>
<p>Could <a href="https://crates.io/crates/wee_alloc">https://crates.io/crates/wee_alloc</a> be a good fit for this?</p>
</blockquote>



<a name="437360304"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238556%20wasi-preview1-component-adapter%3A%20A.../near/437360304" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238556.20wasi-preview1-component-adapter.3A.20A.2E.2E.2E.html#437360304">(May 07 2024 at 00:57)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8556#issuecomment-2097164929">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8556">issue #8556</a>:</p>
<blockquote>
<p>@pchickey I was poking a bit at this today and wrote up a <a href="https://github.com/alexcrichton/wasmtime/commit/repro-64k-env-bug">reproduction test case</a> (ignore the commented out bits in the rest of Wasmtime). </p>
<p>Otherwise I _think_ it should be possible to call <code>cabi_realloc</code> from the adapter. The one downside of that is that a single allocation can't be larger than 64k due to <a href="https://github.com/bytecodealliance/wasm-tools/blob/1594eba3c22ed574e68fc02a6c078310132176a0/crates/wit-component/src/gc.rs#L90-L98">this constraint</a>, but we can probably lift that at the same time perhaps. Most modules export a <code>cabi_realloc</code> anyway so they should avoid that linked code there too since they'd actually use the language's normal <code>cabi_realloc</code>.</p>
</blockquote>



<a name="437382655"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238556%20wasi-preview1-component-adapter%3A%20A.../near/437382655" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238556.20wasi-preview1-component-adapter.3A.20A.2E.2E.2E.html#437382655">(May 07 2024 at 05:48)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/issues/8556#issuecomment-2097498383">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8556">issue #8556</a>:</p>
<blockquote>
<p>thanks! I made a reproducer as well today but i like yours better. i was going through trying to decode the history of why we didnt always call cabi_realloc directly and trying to figure out, when it became possible to do so, did we choose not to do it or did we just not think about it? anyway I think I'm going kayaking tomorrow but I will give it a try wednesday.</p>
</blockquote>



<a name="437675275"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238556%20wasi-preview1-component-adapter%3A%20A.../near/437675275" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238556.20wasi-preview1-component-adapter.3A.20A.2E.2E.2E.html#437675275">(May 08 2024 at 15:32)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8556#issuecomment-2100853379">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8556">issue #8556</a>:</p>
<blockquote>
<p>Originally we assumed we couldn't call cabi_realloc at all and even now the import of cabi_realloc is a bit of a lie, sometimes it's hooked up to <code>memory.grow</code>. Supporting cabi_realloc itself was added in due to other issues down the road at some point. </p>
<p>Otherwise though I think we just forgot to handle the case of &gt;=64k env/arg blocks...</p>
</blockquote>



<a name="438009693"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238556%20wasi-preview1-component-adapter%3A%20A.../near/438009693" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238556.20wasi-preview1-component-adapter.3A.20A.2E.2E.2E.html#438009693">(May 10 2024 at 16:22)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8556#issuecomment-2104887280">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8556">issue #8556</a>:</p>
<blockquote>
<p>I think I've got an idea, albeit a bit nasty in the implementation, of how to solve this so I'm going to give it a stab</p>
</blockquote>



<a name="438032473"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238556%20wasi-preview1-component-adapter%3A%20A.../near/438032473" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238556.20wasi-preview1-component-adapter.3A.20A.2E.2E.2E.html#438032473">(May 10 2024 at 18:59)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8556#issuecomment-2105123307">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8556">issue #8556</a>:</p>
<blockquote>
<p>While it's very much a hack the idea ended up <a href="https://github.com/bytecodealliance/wasmtime/pull/8594">at least mostly working out</a></p>
</blockquote>



<a name="438608876"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238556%20wasi-preview1-component-adapter%3A%20A.../near/438608876" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238556.20wasi-preview1-component-adapter.3A.20A.2E.2E.2E.html#438608876">(May 14 2024 at 16:10)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/8556">issue #8556</a>:</p>
<blockquote>
<p>The <a href="https://github.com/bytecodealliance/wasmtime/blob/d0cf46a098d97bab9c4cf54a2f3aeaddea7d3831/crates/wasi-preview1-component-adapter/src/lib.rs#L2510">single 64KiB page</a> available to <code>BumpArena</code> in <code>wasi-preview1-component-adapter</code> is not reliably sufficient for allocating environment variables during initialization. This problem manifested for me as a <a href="https://github.com/bytecodealliance/jco/issues/433">crash in <code>jco</code></a> when running it inside a NixOS shell with a lot of environment variables set.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>