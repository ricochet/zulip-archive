<html>
<head><meta charset="utf-8"><title>wasmtime / PR #8206 Make fixed-size table base-address lo... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238206.20Make.20fixed-size.20table.20base-address.20lo.2E.2E.2E.html">wasmtime / PR #8206 Make fixed-size table base-address lo...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="428157664"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238206%20Make%20fixed-size%20table%20base-address%20lo.../near/428157664" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238206.20Make.20fixed-size.20table.20base-address.20lo.2E.2E.2E.html#428157664">(Mar 21 2024 at 15:31)</a>:</h4>
<p>jameysharp opened <a href="https://github.com/bytecodealliance/wasmtime/pull/8206">PR #8206</a> from <code>jameysharp:table-base-readonly</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Fixes #8200 </p>
<p>I'd appreciate careful review of my claim that the table base-address won't change as long as the table declaration has a fixed size. If I'm wrong about that then this change isn't safe.</p>
</blockquote>



<a name="428157665"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238206%20Make%20fixed-size%20table%20base-address%20lo.../near/428157665" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238206.20Make.20fixed-size.20table.20base-address.20lo.2E.2E.2E.html#428157665">(Mar 21 2024 at 15:31)</a>:</h4>
<p><strong>jameysharp</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8206">PR #8206</a>.</p>



<a name="428157667"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238206%20Make%20fixed-size%20table%20base-address%20lo.../near/428157667" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238206.20Make.20fixed-size.20table.20base-address.20lo.2E.2E.2E.html#428157667">(Mar 21 2024 at 15:31)</a>:</h4>
<p><strong>jameysharp</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8206">PR #8206</a>.</p>



<a name="428163803"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238206%20Make%20fixed-size%20table%20base-address%20lo.../near/428163803" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238206.20Make.20fixed-size.20table.20base-address.20lo.2E.2E.2E.html#428163803">(Mar 21 2024 at 15:59)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8206#pullrequestreview-1952677211">PR review</a>:</p>
<blockquote>
<p>I believe this is correct, yes. Can you add an assertion <a href="https://github.com/bytecodealliance/wasmtime/blob/082acb4e29934af9b79e709535966fd4331d7019/crates/runtime/src/table.rs#L397-L398">here</a> with a comment indicating why it's important to preserve the base pointer? That's I believe the only possible method where a table can change its base pointer, so having a comment there referencing this optimization I think would also be good.</p>
</blockquote>



<a name="428214410"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238206%20Make%20fixed-size%20table%20base-address%20lo.../near/428214410" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238206.20Make.20fixed-size.20table.20base-address.20lo.2E.2E.2E.html#428214410">(Mar 21 2024 at 20:43)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/8206#issuecomment-2013697396">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8206">PR #8206</a>:</p>
<blockquote>
<p>Note that it is theoretically possible for the base pointer to remain constant even while supporting growth, if we are just growing within one large pre-allocated or pre-reserved virtual memory region. It may or may not be worth adding support for this subtlety to <code>cranelift-wasm</code>.</p>
</blockquote>



<a name="428214487"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238206%20Make%20fixed-size%20table%20base-address%20lo.../near/428214487" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238206.20Make.20fixed-size.20table.20base-address.20lo.2E.2E.2E.html#428214487">(Mar 21 2024 at 20:44)</a>:</h4>
<p>fitzgen edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/8206#issuecomment-2013697396">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8206">PR #8206</a>:</p>
<blockquote>
<p>Note that it is theoretically possible for the base pointer to remain constant even while supporting growth, if we are just growing within one large pre-allocated or pre-reserved memory region. It may or may not be worth adding support for this subtlety to <code>cranelift-wasm</code>.</p>
</blockquote>



<a name="428226755"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238206%20Make%20fixed-size%20table%20base-address%20lo.../near/428226755" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238206.20Make.20fixed-size.20table.20base-address.20lo.2E.2E.2E.html#428226755">(Mar 21 2024 at 22:12)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/8206#issuecomment-2013939517">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8206">PR #8206</a>:</p>
<blockquote>
<p>Yeah, Nick, when I looked at the code Alex pointed at, I noticed that it looks like the pooling allocator never resizes the backing store for tables. So maybe we can thread that information through?</p>
<p>The decision of whether to use the <code>readonly</code> flag or not is in the wasmtime-cranelift crate so it's not a big deal to rely on Wasmtime internal details in making that decision. I haven't dug into how well connected those parts are though.</p>
</blockquote>



<a name="428237454"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238206%20Make%20fixed-size%20table%20base-address%20lo.../near/428237454" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238206.20Make.20fixed-size.20table.20base-address.20lo.2E.2E.2E.html#428237454">(Mar 22 2024 at 00:00)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/8206#issuecomment-2014069871">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8206">PR #8206</a>:</p>
<blockquote>
<p>What you're describing is I believe one property of "static" vs "dynamic" memories, namely that static memories never change their base pointer but dynamic memories are allowed. There's lots of knobs for that in Wasmtime but the problem here is we'd have to be able to classify static/dynamic at compile time and then make sure it matches the settings at runtime. Currently the pooling allocator isn't consulted at compile time, only runtime, so pooling-vs-not wouldn't be suitable for this optimization.</p>
<p>We could of course, though, add more flags and more config options like memories but for tables to control this.</p>
</blockquote>



<a name="428334127"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238206%20Make%20fixed-size%20table%20base-address%20lo.../near/428334127" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238206.20Make.20fixed-size.20table.20base-address.20lo.2E.2E.2E.html#428334127">(Mar 22 2024 at 13:52)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/8206#issuecomment-2015156108">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8206">PR #8206</a>:</p>
<blockquote>
<p>Yep, I think that's something we may want to do in the long term.</p>
</blockquote>



<a name="428391653"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238206%20Make%20fixed-size%20table%20base-address%20lo.../near/428391653" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238206.20Make.20fixed-size.20table.20base-address.20lo.2E.2E.2E.html#428391653">(Mar 22 2024 at 18:51)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/8206#issuecomment-2015715974">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8206">PR #8206</a>:</p>
<blockquote>
<p>Oh right, causality goes the wrong way here. I do like the idea of eventually adding a compile-time option for "no table backing-store resizes" that lets us set the <code>readonly</code> flag even for tables which might grow, and then turning <code>table.grow</code> requests that overflow the backing store into runtime errors.</p>
<p>Until we do that, though: Alex, I'm not sure what assertion I can add at that call to <code>Vec::resize</code>. I'm happy to add comments. But in the case where this PR requires non-moving backing stores, the <code>resize</code> call is guarded immediately above by checking that the new size does not exceed <code>self.maximum()</code>. So the only way it's reachable is if this function is called with a size <code>delta</code> of zero, and I think in that case it would be better to return earlier and always succeed.</p>
<p>What would you suggest doing there?</p>
</blockquote>



<a name="428396732"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238206%20Make%20fixed-size%20table%20base-address%20lo.../near/428396732" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238206.20Make.20fixed-size.20table.20base-address.20lo.2E.2E.2E.html#428396732">(Mar 22 2024 at 19:28)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/8206#issuecomment-2015772726">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8206">PR #8206</a>:</p>
<blockquote>
<p>Hm no you're right, I was assuming we had more context there than we actually do. I was envisioning an assert along the lines of "assert the type doesn't have max == Some(min)" but that can't be done.</p>
<p>In lieu of that I think it's ok to leave a comment on the check for max and say that this is needed by the spec but also for soundness in cranelift to enable this optimization. It's a bit redundant but it does seem good to have a mention of this optimization somewhere in <code>grow</code></p>
</blockquote>



<a name="429535684"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238206%20Make%20fixed-size%20table%20base-address%20lo.../near/429535684" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238206.20Make.20fixed-size.20table.20base-address.20lo.2E.2E.2E.html#429535684">(Mar 26 2024 at 00:52)</a>:</h4>
<p>jameysharp updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8206">PR #8206</a>.</p>



<a name="429535801"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238206%20Make%20fixed-size%20table%20base-address%20lo.../near/429535801" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238206.20Make.20fixed-size.20table.20base-address.20lo.2E.2E.2E.html#429535801">(Mar 26 2024 at 00:54)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/8206#issuecomment-2019195720">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8206">PR #8206</a>:</p>
<blockquote>
<p>Okay, I've added stuff to the <code>grow</code> method in wasmtime-runtime. Would you give that part another look? I also rebased for other changes that have landed meanwhile.</p>
</blockquote>



<a name="429538593"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238206%20Make%20fixed-size%20table%20base-address%20lo.../near/429538593" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238206.20Make.20fixed-size.20table.20base-address.20lo.2E.2E.2E.html#429538593">(Mar 26 2024 at 01:30)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8206#pullrequestreview-1959122989">PR review</a>.</p>



<a name="429541026"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238206%20Make%20fixed-size%20table%20base-address%20lo.../near/429541026" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238206.20Make.20fixed-size.20table.20base-address.20lo.2E.2E.2E.html#429541026">(Mar 26 2024 at 01:57)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/8206">PR #8206</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>