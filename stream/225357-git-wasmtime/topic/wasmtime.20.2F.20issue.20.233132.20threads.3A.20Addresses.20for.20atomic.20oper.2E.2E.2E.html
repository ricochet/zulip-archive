<html>
<head><meta charset="utf-8"><title>wasmtime / issue #3132 threads: Addresses for atomic oper... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233132.20threads.3A.20Addresses.20for.20atomic.20oper.2E.2E.2E.html">wasmtime / issue #3132 threads: Addresses for atomic oper...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="247730617"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233132%20threads%3A%20Addresses%20for%20atomic%20oper.../near/247730617" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233132.20threads.3A.20Addresses.20for.20atomic.20oper.2E.2E.2E.html#247730617">(Jul 30 2021 at 16:27)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/issues/3132">issue #3132</a>:</p>
<blockquote>
<p>This module, for example:</p>
<div class="codehilite" data-code-language="wasm"><pre><span></span><code>(module
    (memory 0)

    (func
        i32.const 0xffff_fff0
        i32.atomic.load offset=16
        drop
    )
    (start 0)
)
</code></pre></div>
<p>should fail with a trap but succeeds:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">threads</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">wat</span><span class="w"></span>
</code></pre></div>
</blockquote>



<a name="247730649"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233132%20threads%3A%20Addresses%20for%20atomic%20oper.../near/247730649" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233132.20threads.3A.20Addresses.20for.20atomic.20oper.2E.2E.2E.html#247730649">(Jul 30 2021 at 16:27)</a>:</h4>
<p>alexcrichton labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/3132">issue #3132</a>:</p>
<blockquote>
<p>This module, for example:</p>
<div class="codehilite" data-code-language="wasm"><pre><span></span><code>(module
    (memory 0)

    (func
        i32.const 0xffff_fff0
        i32.atomic.load offset=16
        drop
    )
    (start 0)
)
</code></pre></div>
<p>should fail with a trap but succeeds:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">threads</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">wat</span><span class="w"></span>
</code></pre></div>
</blockquote>



<a name="247730770"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233132%20threads%3A%20Addresses%20for%20atomic%20oper.../near/247730770" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233132.20threads.3A.20Addresses.20for.20atomic.20oper.2E.2E.2E.html#247730770">(Jul 30 2021 at 16:28)</a>:</h4>
<p>alexcrichton edited <a href="https://github.com/bytecodealliance/wasmtime/issues/3132">issue #3132</a>:</p>
<blockquote>
<p>This module, for example:</p>
<div class="codehilite" data-code-language="wasm"><pre><span></span><code>(module
    (memory 1)

    (func
        i32.const 0xffff_fff0
        i32.atomic.load offset=16
        drop
    )
    (start 0)
)
</code></pre></div>
<p>should fail with a trap but succeeds:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">threads</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">wat</span><span class="w"></span>
</code></pre></div>
</blockquote>



<a name="247736458"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233132%20threads%3A%20Addresses%20for%20atomic%20oper.../near/247736458" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233132.20threads.3A.20Addresses.20for.20atomic.20oper.2E.2E.2E.html#247736458">(Jul 30 2021 at 17:12)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/3132#issuecomment-890035468">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3132">issue #3132</a>:</p>
<blockquote>
<p>It appears that atomic loads handle their offset differently than others. In #2077 we introduced a new <code>LoadNoOffset</code> instruction class, and instead, the Wasm translator inserts a bare <code>iadd_imm</code> (with no overflow check): <a href="https://github.com/bytecodealliance/wasmtime/blob/4632b6a816cf9344969a83c1a4bad2640972eab9/cranelift/wasm/src/code_translator.rs#L2357-L2359">link</a>.</p>
<p>@julian-seward1, do you recall why we didn't just take an offset on the atomic load/store ops like we do on regular ones? Was it in order to simplify the implementation or is there some other reason?</p>
<p>IMHO the right fix (assuming the above question doesn't reveal a blocking reason) is to harmonize atomic loads/stores with regular ones and use the same offset handling / overflow checking logic.</p>
</blockquote>



<a name="248408060"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233132%20threads%3A%20Addresses%20for%20atomic%20oper.../near/248408060" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233132.20threads.3A.20Addresses.20for.20atomic.20oper.2E.2E.2E.html#248408060">(Aug 04 2021 at 20:57)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/3132">issue #3132</a>:</p>
<blockquote>
<p>This module, for example:</p>
<div class="codehilite" data-code-language="wasm"><pre><span></span><code>(module
    (memory 1)

    (func
        i32.const 0xffff_fff0
        i32.atomic.load offset=16
        drop
    )
    (start 0)
)
</code></pre></div>
<p>should fail with a trap but succeeds:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">threads</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">wat</span><span class="w"></span>
</code></pre></div>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>