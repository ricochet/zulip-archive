<html>
<head><meta charset="utf-8"><title>wasmtime / issue #6978 Using wasmtime_wasi `Dir` struct c... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236978.20Using.20wasmtime_wasi.20.60Dir.60.20struct.20c.2E.2E.2E.html">wasmtime / issue #6978 Using wasmtime_wasi `Dir` struct c...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="389791043"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236978%20Using%20wasmtime_wasi%20%60Dir%60%20struct%20c.../near/389791043" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236978.20Using.20wasmtime_wasi.20.60Dir.60.20struct.20c.2E.2E.2E.html#389791043">(Sep 08 2023 at 01:51)</a>:</h4>
<p>doinkythederp opened <a href="https://github.com/bytecodealliance/wasmtime/issues/6978">issue #6978</a>:</p>
<blockquote>
<p>Thanks for filing a bug report! Please fill out the TODOs below.</p>
<p><strong>Note: if you want to report a security issue, please read our <a href="https://bytecodealliance.org/security">security policy</a>!</strong></p>
<h3>Test Case</h3>
<p>Here's the WASM code required to reproduce this bug:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">read_dir</span><span class="p">(</span><span class="s">"/"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">dir</span><span class="p">.</span><span class="n">collect</span>::<span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;&gt;</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="w"> </span><span class="o">--</span><span class="n">release</span>
</code></pre></div>
<p>Compiled in release mode with <code>debug = true</code>:<br>
<a href="https://github.com/bytecodealliance/wasmtime/files/12554668/test.wasm.tgz">test.wasm.tgz</a></p>
<p>Here's the Rust host code required, modified from the <a href="https://docs.wasmtime.dev/examples-rust-wasi.html">WASI example</a>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="o">*</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime_wasi</span>::<span class="p">{</span><span class="n">ambient_authority</span><span class="p">,</span><span class="w"> </span><span class="n">sync</span>::<span class="n">WasiCtxBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">Dir</span><span class="p">};</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Define the WASI functions globally on the `Config`.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span>::<span class="n">default</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span>::<span class="n">add_to_linker</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">s</span><span class="o">|</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasm_fs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Dir</span>::<span class="n">open_ambient_dir</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span><span class="w"> </span><span class="n">ambient_authority</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"Filesystem root should be accessible"</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Create a WASI context and put it in a Store; all instances in the store</span>
<span class="w">    </span><span class="c1">// share this context. `WasiCtxBuilder` provides a number of ways to</span>
<span class="w">    </span><span class="c1">// configure what the target program will have access to.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasiCtxBuilder</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">preopened_dir</span><span class="p">(</span><span class="n">wasm_fs</span><span class="p">,</span><span class="w"> </span><span class="s">"/"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">inherit_stdio</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">inherit_args</span><span class="p">()</span><span class="o">?</span>
<span class="w">        </span><span class="p">.</span><span class="n">build</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">wasi</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Instantiate our module with the imports we've created, and run it.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span>::<span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="s">"./test.wasm"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">linker</span><span class="p">.</span><span class="n">module</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// --&gt; Panic occurs here</span>
<span class="w">    </span><span class="n">linker</span>
<span class="w">        </span><span class="p">.</span><span class="n">get_default</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">)</span><span class="o">?</span>
<span class="w">        </span><span class="p">.</span><span class="n">typed</span>::<span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">)</span><span class="o">?</span>
<span class="w">        </span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="p">())</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li>Use <code>wasmtime_wasi::Dir</code> to allow access to the root directory</li>
<li>Attempt to read the root directory from WASM</li>
</ul>
<h3>Expected Results</h3>
<p>The program will print the files in the root directory: <code>bin</code>, <code>dev</code>, <code>usr</code>, etc.</p>
<h3>Actual Results</h3>
<p>Program panics:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Result</span>::<span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="nb">Err</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>: <span class="nc">TryFromIntError</span><span class="p">(())</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;..</span><span class="p">.</span><span class="o">&gt;/</span><span class="n">cap</span><span class="o">-</span><span class="n">primitives</span><span class="o">-</span><span class="mf">2.0.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rustix</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">metadata_ext</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">167</span>:<span class="mi">49</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: v12.0.1 </p>
<p>Operating system: macOS Ventura 13.5.1</p>
<p>Architecture: arm64 Apple Silicon</p>
<h3>Extra Info</h3>
<p>I'm not familiar with ambient authority.<br>
</p>
</blockquote>



<a name="389791044"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236978%20Using%20wasmtime_wasi%20%60Dir%60%20struct%20c.../near/389791044" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236978.20Using.20wasmtime_wasi.20.60Dir.60.20struct.20c.2E.2E.2E.html#389791044">(Sep 08 2023 at 01:51)</a>:</h4>
<p><a href="https://github.com/doinkythederp">doinkythederp</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/6978">Issue #6978</a>.</p>



<a name="389791054"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236978%20Using%20wasmtime_wasi%20%60Dir%60%20struct%20c.../near/389791054" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236978.20Using.20wasmtime_wasi.20.60Dir.60.20struct.20c.2E.2E.2E.html#389791054">(Sep 08 2023 at 01:51)</a>:</h4>
<p>doinkythederp edited <a href="https://github.com/bytecodealliance/wasmtime/issues/6978">issue #6978</a>:</p>
<blockquote>
<p>Thanks for filing a bug report! Please fill out the TODOs below.</p>
<p><strong>Note: if you want to report a security issue, please read our <a href="https://bytecodealliance.org/security">security policy</a>!</strong></p>
<h3>Test Case</h3>
<p>Here's the WASM code required to reproduce this bug:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">read_dir</span><span class="p">(</span><span class="s">"/"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">dir</span><span class="p">.</span><span class="n">collect</span>::<span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;&gt;</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="w"> </span><span class="o">--</span><span class="n">release</span>
</code></pre></div>
<p>Compiled in release mode with <code>debug = true</code>:<br>
<a href="https://github.com/bytecodealliance/wasmtime/files/12554668/test.wasm.tgz">test.wasm.tgz</a></p>
<p>Here's the Rust host code required, modified from the <a href="https://docs.wasmtime.dev/examples-rust-wasi.html">WASI example</a>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="o">*</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime_wasi</span>::<span class="p">{</span><span class="n">ambient_authority</span><span class="p">,</span><span class="w"> </span><span class="n">sync</span>::<span class="n">WasiCtxBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">Dir</span><span class="p">};</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Define the WASI functions globally on the `Config`.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span>::<span class="n">default</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span>::<span class="n">add_to_linker</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">s</span><span class="o">|</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasm_fs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Dir</span>::<span class="n">open_ambient_dir</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span><span class="w"> </span><span class="n">ambient_authority</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"Filesystem root should be accessible"</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Create a WASI context and put it in a Store; all instances in the store</span>
<span class="w">    </span><span class="c1">// share this context. `WasiCtxBuilder` provides a number of ways to</span>
<span class="w">    </span><span class="c1">// configure what the target program will have access to.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasiCtxBuilder</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">preopened_dir</span><span class="p">(</span><span class="n">wasm_fs</span><span class="p">,</span><span class="w"> </span><span class="s">"/"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">inherit_stdio</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">inherit_args</span><span class="p">()</span><span class="o">?</span>
<span class="w">        </span><span class="p">.</span><span class="n">build</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">wasi</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Instantiate our module with the imports we've created, and run it.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span>::<span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="s">"./test.wasm"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">linker</span><span class="p">.</span><span class="n">module</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// --&gt; Panic occurs here</span>
<span class="w">    </span><span class="n">linker</span>
<span class="w">        </span><span class="p">.</span><span class="n">get_default</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">)</span><span class="o">?</span>
<span class="w">        </span><span class="p">.</span><span class="n">typed</span>::<span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">)</span><span class="o">?</span>
<span class="w">        </span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="p">())</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li>Use <code>wasmtime_wasi::Dir</code> to allow access to the root directory</li>
<li>Attempt to read the root directory from WASM</li>
</ul>
<h3>Expected Results</h3>
<p>The program will print the files in the root directory: <code>bin</code>, <code>dev</code>, <code>usr</code>, etc.</p>
<h3>Actual Results</h3>
<p>Program panics:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Result</span>::<span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="nb">Err</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>: <span class="nc">TryFromIntError</span><span class="p">(())</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;..</span><span class="p">.</span><span class="o">&gt;/</span><span class="n">cap</span><span class="o">-</span><span class="n">primitives</span><span class="o">-</span><span class="mf">2.0.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rustix</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">metadata_ext</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">167</span>:<span class="mi">49</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: v12.0.1 </p>
<p>Operating system: macOS Ventura 13.5.1</p>
<p>Architecture: arm64 Apple Silicon</p>
<h3>Extra Info</h3>
<p>I'm not familiar with ambient authority.</p>
<p>```[tasklist]</p>
<h3>Tasks</h3>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">~~~</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="389791061"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236978%20Using%20wasmtime_wasi%20%60Dir%60%20struct%20c.../near/389791061" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236978.20Using.20wasmtime_wasi.20.60Dir.60.20struct.20c.2E.2E.2E.html#389791061">(Sep 08 2023 at 01:51)</a>:</h4>
<p>doinkythederp edited <a href="https://github.com/bytecodealliance/wasmtime/issues/6978">issue #6978</a>:</p>
<blockquote>
<p>Thanks for filing a bug report! Please fill out the TODOs below.</p>
<p><strong>Note: if you want to report a security issue, please read our <a href="https://bytecodealliance.org/security">security policy</a>!</strong></p>
<h3>Test Case</h3>
<p>Here's the WASM code required to reproduce this bug:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">read_dir</span><span class="p">(</span><span class="s">"/"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">dir</span><span class="p">.</span><span class="n">collect</span>::<span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;&gt;</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="w"> </span><span class="o">--</span><span class="n">release</span>
</code></pre></div>
<p>Compiled in release mode with <code>debug = true</code>:<br>
<a href="https://github.com/bytecodealliance/wasmtime/files/12554668/test.wasm.tgz">test.wasm.tgz</a></p>
<p>Here's the Rust host code required, modified from the <a href="https://docs.wasmtime.dev/examples-rust-wasi.html">WASI example</a>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="o">*</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime_wasi</span>::<span class="p">{</span><span class="n">ambient_authority</span><span class="p">,</span><span class="w"> </span><span class="n">sync</span>::<span class="n">WasiCtxBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">Dir</span><span class="p">};</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Define the WASI functions globally on the `Config`.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span>::<span class="n">default</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span>::<span class="n">add_to_linker</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">s</span><span class="o">|</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasm_fs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Dir</span>::<span class="n">open_ambient_dir</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span><span class="w"> </span><span class="n">ambient_authority</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"Filesystem root should be accessible"</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Create a WASI context and put it in a Store; all instances in the store</span>
<span class="w">    </span><span class="c1">// share this context. `WasiCtxBuilder` provides a number of ways to</span>
<span class="w">    </span><span class="c1">// configure what the target program will have access to.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasiCtxBuilder</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">preopened_dir</span><span class="p">(</span><span class="n">wasm_fs</span><span class="p">,</span><span class="w"> </span><span class="s">"/"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">inherit_stdio</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">inherit_args</span><span class="p">()</span><span class="o">?</span>
<span class="w">        </span><span class="p">.</span><span class="n">build</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">wasi</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Instantiate our module with the imports we've created, and run it.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span>::<span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="s">"./test.wasm"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">linker</span><span class="p">.</span><span class="n">module</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// --&gt; Panic occurs here</span>
<span class="w">    </span><span class="n">linker</span>
<span class="w">        </span><span class="p">.</span><span class="n">get_default</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">)</span><span class="o">?</span>
<span class="w">        </span><span class="p">.</span><span class="n">typed</span>::<span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">)</span><span class="o">?</span>
<span class="w">        </span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="p">())</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li>Use <code>wasmtime_wasi::Dir</code> to allow access to the root directory</li>
<li>Attempt to read the root directory from WASM</li>
</ul>
<h3>Expected Results</h3>
<p>The program will print the files in the root directory: <code>bin</code>, <code>dev</code>, <code>usr</code>, etc.</p>
<h3>Actual Results</h3>
<p>Program panics:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Result</span>::<span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="nb">Err</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>: <span class="nc">TryFromIntError</span><span class="p">(())</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;..</span><span class="p">.</span><span class="o">&gt;/</span><span class="n">cap</span><span class="o">-</span><span class="n">primitives</span><span class="o">-</span><span class="mf">2.0.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rustix</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">metadata_ext</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">167</span>:<span class="mi">49</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: v12.0.1 </p>
<p>Operating system: macOS Ventura 13.5.1</p>
<p>Architecture: arm64 Apple Silicon</p>
<h3>Extra Info</h3>
<p>I'm not familiar with ambient authority.</p>
</blockquote>



<a name="389953384"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236978%20Using%20wasmtime_wasi%20%60Dir%60%20struct%20c.../near/389953384" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236978.20Using.20wasmtime_wasi.20.60Dir.60.20struct.20c.2E.2E.2E.html#389953384">(Sep 08 2023 at 21:38)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/issues/6978#issuecomment-1712251171">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6978">issue #6978</a>:</p>
<blockquote>
<p>it looks like this is a <code>cap-primitives</code> crate bug, can you please report it here: <a href="https://github.com/bytecodealliance/cap-std/issues">https://github.com/bytecodealliance/cap-std/issues</a></p>
</blockquote>



<a name="389958833"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236978%20Using%20wasmtime_wasi%20%60Dir%60%20struct%20c.../near/389958833" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236978.20Using.20wasmtime_wasi.20.60Dir.60.20struct.20c.2E.2E.2E.html#389958833">(Sep 08 2023 at 22:37)</a>:</h4>
<p>doinkythederp <a href="https://github.com/bytecodealliance/wasmtime/issues/6978#issuecomment-1712302800">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6978">issue #6978</a>:</p>
<blockquote>
<p>I'm not familiar with how wasmtime_wasi uses the Dir struct and I don't know anything about cap-primitives so I'm not really sure what to put in the bug report</p>
</blockquote>



<a name="390013692"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236978%20Using%20wasmtime_wasi%20%60Dir%60%20struct%20c.../near/390013692" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236978.20Using.20wasmtime_wasi.20.60Dir.60.20struct.20c.2E.2E.2E.html#390013692">(Sep 09 2023 at 09:16)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/6978#issuecomment-1712465938">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6978">issue #6978</a>:</p>
<blockquote>
<p>It looks like <code>u64::try_from(stat.st_dev).unwrap()</code> fails. On Linux <code>dev_t</code> is a u64, but on macOS it is an i32: <a href="https://github.com/rust-lang/libc/blob/835661543db1ec42a6d9a809d69c3c5b5b978b81/src/unix/bsd/apple/mod.rs#L9">https://github.com/rust-lang/libc/blob/835661543db1ec42a6d9a809d69c3c5b5b978b81/src/unix/bsd/apple/mod.rs#L9</a> Presumably it is a negative number in this case. Could you try <code>stat /*</code> and see which dir gets which device number?</p>
</blockquote>



<a name="390092414"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236978%20Using%20wasmtime_wasi%20%60Dir%60%20struct%20c.../near/390092414" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236978.20Using.20wasmtime_wasi.20.60Dir.60.20struct.20c.2E.2E.2E.html#390092414">(Sep 10 2023 at 03:20)</a>:</h4>
<p>pchickey assigned <a href="https://github.com/bytecodealliance/wasmtime/issues/6978">issue #6978</a> to sunfishcode.</p>



<a name="390625288"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236978%20Using%20wasmtime_wasi%20%60Dir%60%20struct%20c.../near/390625288" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236978.20Using.20wasmtime_wasi.20.60Dir.60.20struct.20c.2E.2E.2E.html#390625288">(Sep 13 2023 at 01:25)</a>:</h4>
<p>doinkythederp <a href="https://github.com/bytecodealliance/wasmtime/issues/6978#issuecomment-1716796899">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6978">issue #6978</a>:</p>
<blockquote>
<p>Not sure what to make of this:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">stat</span><span class="w"> </span><span class="cm">/*</span>
<span class="cm">16777234 87498924 drwxrwxr-x 86 root admin 0 2752 "Sep 12 18:14:56 2023" "Sep 12 18:14:56 2023" "Sep 12 18:14:56 2023" "Sep  2 00:35:13 2023" 4096 0 0x100000 /Applications</span>
<span class="cm">16777234 87484854 drwxr-xr-x 72 root wheel 0 2304 "Sep  7 20:23:48 2023" "Sep  7 20:23:26 2023" "Sep  7 20:23:26 2023" "Sep  2 00:35:13 2023" 4096 0 0x100000 /Library</span>
<span class="cm">16777234 1152921500311879701 drwxr-xr-x 10 root wheel 0 320 "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" 4096 0 0x80000 /System</span>
<span class="cm">16777234 23836 drwxr-xr-x 6 root admin 0 192 "Sep  7 20:23:21 2023" "Sep  7 20:22:54 2023" "Sep  7 20:22:54 2023" "Aug 24 01:59:39 2022" 4096 0 0x100000 /Users</span>
<span class="cm">16777234 26293 drwxr-xr-x 3 root wheel 0 96 "Sep 11 19:52:22 2023" "Sep 11 19:52:22 2023" "Sep 11 19:52:22 2023" "Aug 24 01:59:39 2022" 4096 0 0x8000 /Volumes</span>
<span class="cm">16777234 1152921500312435255 drwxr-xr-x 39 root wheel 0 1248 "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" 4096 0 0x88000 /bin</span>
<span class="cm">16777234 26295 drwxr-xr-x 2 root wheel 0 64 "Sep 22 17:50:54 2022" "Aug 24 01:59:39 2022" "Sep 22 17:50:54 2022" "Aug 24 01:59:39 2022" 4096 0 0x8000 /cores</span>
<span class="cm">855137406 335 dr-xr-xr-x 4 root wheel 0 5023 "Sep 12 18:24:40 2023" "Sep  7 20:22:04 2023" "Sep  7 20:22:04 2023" "Dec 31 16:00:00 1969" 512 10 0x8000 /dev</span>
<span class="cm">16777234 1152921500312435332 lrwxr-xr-x 1 root wheel 0 11 "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" 4096 0 0x88000 /etc</span>
<span class="cm">16777234 1152921504606781440 lrwxr-xr-x 1 root wheel 0 25 "Sep  7 20:23:38 2023" "Sep  7 20:23:38 2023" "Sep  7 20:23:38 2023" "Sep  7 20:23:38 2023" 4096 0 0x8000 /home</span>
<span class="cm">16777240 2 drwxr-xr-x 5 root nixbld 0 160 "Sep  8 14:52:37 2023" "Sep  8 14:52:31 2023" "Sep  8 14:52:31 2023" "Sep  8 14:52:12 2023" 4096 0 0 /nix</span>
<span class="cm">16777234 26292 drwxr-xr-x 4 root wheel 0 128 "Mar  9 17:51:16 2023" "Mar  3 22:04:09 2023" "Mar  3 22:04:09 2023" "Aug 24 01:59:39 2022" 4096 0 0x8000 /opt</span>
<span class="cm">16777234 87497982 drwxr-xr-x 6 root wheel 0 192 "Sep  8 08:24:55 2023" "Sep  7 20:23:34 2023" "Sep  7 20:23:34 2023" "Sep  2 00:35:13 2023" 4096 0 0x108000 /private</span>
<span class="cm">16777234 1152921504606781443 lrwxr-xr-x 1 root wheel 0 15 "Sep  8 15:03:25 2023" "Sep  8 15:03:25 2023" "Sep  8 15:03:25 2023" "Sep  8 15:03:25 2023" 4096 0 0 /run</span>
<span class="cm">16777234 1152921500312435335 drwxr-xr-x 64 root wheel 0 2048 "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" 4096 0 0x88000 /sbin</span>
<span class="cm">16777234 1152921500312435438 lrwxr-xr-x 1 root wheel 0 11 "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" 4096 0 0x88000 /tmp</span>
<span class="cm">16777234 1152921500312435439 drwxr-xr-x 11 root wheel 0 352 "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" 4096 0 0x88000 /usr</span>
<span class="cm">16777234 1152921500312470639 lrwxr-xr-x 1 root wheel 0 11 "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" 4096 0 0x88000 /var</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="390625453"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236978%20Using%20wasmtime_wasi%20%60Dir%60%20struct%20c.../near/390625453" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236978.20Using.20wasmtime_wasi.20.60Dir.60.20struct.20c.2E.2E.2E.html#390625453">(Sep 13 2023 at 01:27)</a>:</h4>
<p>doinkythederp edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/6978#issuecomment-1716796899">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6978">issue #6978</a>:</p>
<blockquote>
<p>Not sure what to make of this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">stat</span><span class="w"> </span><span class="cm">/*</span>
<span class="cm">16777234 87498924 drwxrwxr-x 86 root admin 0 2752 "Sep 12 18:14:56 2023" "Sep 12 18:14:56 2023" "Sep 12 18:14:56 2023" "Sep  2 00:35:13 2023" 4096 0 0x100000 /Applications</span>
<span class="cm">16777234 87484854 drwxr-xr-x 72 root wheel 0 2304 "Sep  7 20:23:48 2023" "Sep  7 20:23:26 2023" "Sep  7 20:23:26 2023" "Sep  2 00:35:13 2023" 4096 0 0x100000 /Library</span>
<span class="cm">16777234 1152921500311879701 drwxr-xr-x 10 root wheel 0 320 "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" 4096 0 0x80000 /System</span>
<span class="cm">16777234 23836 drwxr-xr-x 6 root admin 0 192 "Sep  7 20:23:21 2023" "Sep  7 20:22:54 2023" "Sep  7 20:22:54 2023" "Aug 24 01:59:39 2022" 4096 0 0x100000 /Users</span>
<span class="cm">16777234 26293 drwxr-xr-x 3 root wheel 0 96 "Sep 11 19:52:22 2023" "Sep 11 19:52:22 2023" "Sep 11 19:52:22 2023" "Aug 24 01:59:39 2022" 4096 0 0x8000 /Volumes</span>
<span class="cm">16777234 1152921500312435255 drwxr-xr-x 39 root wheel 0 1248 "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" 4096 0 0x88000 /bin</span>
<span class="cm">16777234 26295 drwxr-xr-x 2 root wheel 0 64 "Sep 22 17:50:54 2022" "Aug 24 01:59:39 2022" "Sep 22 17:50:54 2022" "Aug 24 01:59:39 2022" 4096 0 0x8000 /cores</span>
<span class="cm">855137406 335 dr-xr-xr-x 4 root wheel 0 5023 "Sep 12 18:24:40 2023" "Sep  7 20:22:04 2023" "Sep  7 20:22:04 2023" "Dec 31 16:00:00 1969" 512 10 0x8000 /dev</span>
<span class="cm">16777234 1152921500312435332 lrwxr-xr-x 1 root wheel 0 11 "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" 4096 0 0x88000 /etc</span>
<span class="cm">16777234 1152921504606781440 lrwxr-xr-x 1 root wheel 0 25 "Sep  7 20:23:38 2023" "Sep  7 20:23:38 2023" "Sep  7 20:23:38 2023" "Sep  7 20:23:38 2023" 4096 0 0x8000 /home</span>
<span class="cm">16777240 2 drwxr-xr-x 5 root nixbld 0 160 "Sep  8 14:52:37 2023" "Sep  8 14:52:31 2023" "Sep  8 14:52:31 2023" "Sep  8 14:52:12 2023" 4096 0 0 /nix</span>
<span class="cm">16777234 26292 drwxr-xr-x 4 root wheel 0 128 "Mar  9 17:51:16 2023" "Mar  3 22:04:09 2023" "Mar  3 22:04:09 2023" "Aug 24 01:59:39 2022" 4096 0 0x8000 /opt</span>
<span class="cm">16777234 87497982 drwxr-xr-x 6 root wheel 0 192 "Sep  8 08:24:55 2023" "Sep  7 20:23:34 2023" "Sep  7 20:23:34 2023" "Sep  2 00:35:13 2023" 4096 0 0x108000 /private</span>
<span class="cm">16777234 1152921504606781443 lrwxr-xr-x 1 root wheel 0 15 "Sep  8 15:03:25 2023" "Sep  8 15:03:25 2023" "Sep  8 15:03:25 2023" "Sep  8 15:03:25 2023" 4096 0 0 /run</span>
<span class="cm">16777234 1152921500312435335 drwxr-xr-x 64 root wheel 0 2048 "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" 4096 0 0x88000 /sbin</span>
<span class="cm">16777234 1152921500312435438 lrwxr-xr-x 1 root wheel 0 11 "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" 4096 0 0x88000 /tmp</span>
<span class="cm">16777234 1152921500312435439 drwxr-xr-x 11 root wheel 0 352 "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" 4096 0 0x88000 /usr</span>
<span class="cm">16777234 1152921500312470639 lrwxr-xr-x 1 root wheel 0 11 "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" "Sep  2 00:35:13 2023" 4096 0 0x88000 /var</span>
</code></pre></div>
<p>"The default format displays the st_dev, st_ino, st_mode, st_nlink, st_uid, st_gid, st_rdev, st_size, st_atime, st_mtime, st_ctime, st_birthtime, st_blksize, st_blocks, and st_flags fields, in that order."</p>
</blockquote>



<a name="390693788"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236978%20Using%20wasmtime_wasi%20%60Dir%60%20struct%20c.../near/390693788" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236978.20Using.20wasmtime_wasi.20.60Dir.60.20struct.20c.2E.2E.2E.html#390693788">(Sep 13 2023 at 10:37)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/6978#issuecomment-1717378972">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6978">issue #6978</a>:</p>
<blockquote>
<p>All these dev numbers are positive. Could you also try <code>stat /</code>? Maybe it is the root directory itself for which the dev number is negative?</p>
</blockquote>



<a name="390771074"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236978%20Using%20wasmtime_wasi%20%60Dir%60%20struct%20c.../near/390771074" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236978.20Using.20wasmtime_wasi.20.60Dir.60.20struct.20c.2E.2E.2E.html#390771074">(Sep 13 2023 at 17:38)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/6978#issuecomment-1718049728">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6978">issue #6978</a>:</p>
<blockquote>
<p>Thanks for helping to track this down @bjorn3, I've posted a hypothetical fix at <a href="https://github.com/bytecodealliance/cap-std/pull/329">https://github.com/bytecodealliance/cap-std/pull/329</a>, although I don't understand enough here to know if <code>st_dev</code> being negative is a bad thing or not. Once that's released I can help update it here in Wasmtime to get tested by @doinkythederp </p>
</blockquote>



<a name="390785180"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236978%20Using%20wasmtime_wasi%20%60Dir%60%20struct%20c.../near/390785180" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236978.20Using.20wasmtime_wasi.20.60Dir.60.20struct.20c.2E.2E.2E.html#390785180">(Sep 13 2023 at 19:05)</a>:</h4>
<p>doinkythederp <a href="https://github.com/bytecodealliance/wasmtime/issues/6978#issuecomment-1718167504">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6978">issue #6978</a>:</p>
<blockquote>
<p>Hi again! Looks like the number changed after a restart or something and the error isn't happening anymore. I haven't changed anything in my code. This might make it harder for me to help with debugging.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>