<html>
<head><meta charset="utf-8"><title>wasmtime / issue #911 Small wasm modules taking excessive... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23911.20Small.20wasm.20modules.20taking.20excessive.2E.2E.2E.html">wasmtime / issue #911 Small wasm modules taking excessive...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="267593167"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23911%20Small%20wasm%20modules%20taking%20excessive.../near/267593167" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23911.20Small.20wasm.20modules.20taking.20excessive.2E.2E.2E.html#267593167">(Jan 11 2022 at 14:59)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/911#issuecomment-1010047222">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/911">issue #911</a>:</p>
<blockquote>
<p>Another fuzz bug today - <a href="https://github.com/bytecodealliance/wasmtime/files/7847535/testcase0.wasm.gz">testcase0.wasm.gz</a><br>
</p>
</blockquote>



<a name="267593395"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23911%20Small%20wasm%20modules%20taking%20excessive.../near/267593395" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23911.20Small.20wasm.20modules.20taking.20excessive.2E.2E.2E.html#267593395">(Jan 11 2022 at 15:00)</a>:</h4>
<p>alexcrichton labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/911">issue #911</a>:</p>
<blockquote>
<p>In reviewing some fuzz bugs we've got a good number of test cases that end up timing out unfortunately. I believe that cranelift has a number of known issues about the speed of its compilation, particularly around register allocation. I figure it'd be good to collect a few concrete wasm files (discovered from fuzzing) which take an abnormally long amount of time to compile compared to the size of the input.</p>
<p>It's worth noting that the timeout on the fuzzers is relatively high, I think something like 30 or 60 seconds. When fuzzing though <a href="https://github.com/rust-fuzz/cargo-fuzz/issues/216">binaries can be up to 50x slower</a> which means our time budget for passing the fuzzers is pretty small, generally less than 3 seconds I think (ish). It's also worth noting that fuzzers are compiled with debug assertions enabled, which enables, well, debug assertions, but also the cranelift verifier pass. I've seen the verifier pass be quite expensive on some of these modules below, but in general the modules without the verifier pass still take an abnormally long amount of time to compile.</p>
<p>For the files below I'm testing with:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">--</span><span class="n">release</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">cache</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">foo2</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
</code></pre></div>
<p>most of them fail to instantiate or run, but it's the compilation which largely matters here which all happens as part of <code>time</code>. Which is to say you can ignore the errors of the CLI generally</p>
<ul>
<li><a href="https://github.com/bytecodealliance/wasmtime/files/4166418/file1.wasm.1.gz">file1.wasm[1].gz</a> - takes 1s locally. Profiling shows lots of time in the register allocator.</li>
<li><a href="https://github.com/bytecodealliance/wasmtime/files/4166471/file2.wasm.1.gz">file2.wasm[1].gz</a> - this takes 300ms locally, but with the verifier and debug assertions enabled takes about 1s. The time looks to be largely in the verifier/register allocator like before.</li>
<li><a href="https://github.com/bytecodealliance/wasmtime/files/4166505/file3.wasm.1.gz">file3.wasm[1].gz</a> - same as previous</li>
<li><a href="https://github.com/bytecodealliance/wasmtime/files/4166506/file4.wasm.1.gz">file4.wasm[1].gz</a> - same as previous</li>
</ul>
<p>I'm assuming that there's generally not a huge amount we can do about this. When cranelift is looking to benchmark new register allocator implementations, however, we can perhaps use the files here as test beds to see how things are improving?</p>
<p>In any case I figure it's good to start tracking files as we come across them if we can.<br>
</p>
</blockquote>



<a name="267593396"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23911%20Small%20wasm%20modules%20taking%20excessive.../near/267593396" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23911.20Small.20wasm.20modules.20taking.20excessive.2E.2E.2E.html#267593396">(Jan 11 2022 at 15:00)</a>:</h4>
<p>alexcrichton labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/911">issue #911</a>:</p>
<blockquote>
<p>In reviewing some fuzz bugs we've got a good number of test cases that end up timing out unfortunately. I believe that cranelift has a number of known issues about the speed of its compilation, particularly around register allocation. I figure it'd be good to collect a few concrete wasm files (discovered from fuzzing) which take an abnormally long amount of time to compile compared to the size of the input.</p>
<p>It's worth noting that the timeout on the fuzzers is relatively high, I think something like 30 or 60 seconds. When fuzzing though <a href="https://github.com/rust-fuzz/cargo-fuzz/issues/216">binaries can be up to 50x slower</a> which means our time budget for passing the fuzzers is pretty small, generally less than 3 seconds I think (ish). It's also worth noting that fuzzers are compiled with debug assertions enabled, which enables, well, debug assertions, but also the cranelift verifier pass. I've seen the verifier pass be quite expensive on some of these modules below, but in general the modules without the verifier pass still take an abnormally long amount of time to compile.</p>
<p>For the files below I'm testing with:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">--</span><span class="n">release</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">cache</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">foo2</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
</code></pre></div>
<p>most of them fail to instantiate or run, but it's the compilation which largely matters here which all happens as part of <code>time</code>. Which is to say you can ignore the errors of the CLI generally</p>
<ul>
<li><a href="https://github.com/bytecodealliance/wasmtime/files/4166418/file1.wasm.1.gz">file1.wasm[1].gz</a> - takes 1s locally. Profiling shows lots of time in the register allocator.</li>
<li><a href="https://github.com/bytecodealliance/wasmtime/files/4166471/file2.wasm.1.gz">file2.wasm[1].gz</a> - this takes 300ms locally, but with the verifier and debug assertions enabled takes about 1s. The time looks to be largely in the verifier/register allocator like before.</li>
<li><a href="https://github.com/bytecodealliance/wasmtime/files/4166505/file3.wasm.1.gz">file3.wasm[1].gz</a> - same as previous</li>
<li><a href="https://github.com/bytecodealliance/wasmtime/files/4166506/file4.wasm.1.gz">file4.wasm[1].gz</a> - same as previous</li>
</ul>
<p>I'm assuming that there's generally not a huge amount we can do about this. When cranelift is looking to benchmark new register allocator implementations, however, we can perhaps use the files here as test beds to see how things are improving?</p>
<p>In any case I figure it's good to start tracking files as we come across them if we can.<br>
</p>
</blockquote>



<a name="270066208"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23911%20Small%20wasm%20modules%20taking%20excessive.../near/270066208" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23911.20Small.20wasm.20modules.20taking.20excessive.2E.2E.2E.html#270066208">(Jan 31 2022 at 17:03)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/911#issuecomment-1026000988">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/911">issue #911</a>:</p>
<blockquote>
<p>Some more fuzz bugs:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/7972693/slow1.wasm.gz">slow1.wasm.gz</a></p>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/7972694/slow2.wasm.gz">slow2.wasm.gz</a></p>
</blockquote>



<a name="274407206"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23911%20Small%20wasm%20modules%20taking%20excessive.../near/274407206" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23911.20Small.20wasm.20modules.20taking.20excessive.2E.2E.2E.html#274407206">(Mar 07 2022 at 15:27)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/911#issuecomment-1060810811">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/911">issue #911</a>:</p>
<blockquote>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/8198784/testcase70.wasm.gz">testcase70.wasm.gz</a></p>
<p>Here's another test case:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">RAYON_NUM_THREADS</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">release</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">--</span><span class="n">wasm</span><span class="o">-</span><span class="n">features</span><span class="w"> </span><span class="n">multi</span><span class="o">-</span><span class="n">memory</span><span class="p">,</span><span class="n">memory64</span><span class="w"> </span><span class="n">testcase70</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">--</span><span class="n">fuel</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">--</span><span class="n">epoch</span><span class="o">-</span><span class="n">interruption</span><span class="w"> </span><span class="o">--</span><span class="n">interruptable</span><span class="w"></span>
<span class="n">RAYON_NUM_THREADS</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">release</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">--</span><span class="n">wasm</span><span class="o">-</span><span class="n">features</span><span class="w">   </span><span class="o">--</span><span class="n">fuel</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="mf">3.45</span><span class="n">s</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="mf">0.10</span><span class="n">s</span><span class="w"> </span><span class="n">system</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="w"> </span><span class="n">cpu</span><span class="w"> </span><span class="mf">3.553</span><span class="w"> </span><span class="n">total</span><span class="w"></span>
</code></pre></div>
<p>This one is a fuzz bug where lots of instrumentation was enabled (three separate ways of interrupting a module), which blows up compile time by quite a lot. Simply adding fuel is enough to make the compile time somewhat excessive at 2 seconds, though, so there may be other cranelift things here. <code>perf</code> still shows everything in register allocation right now</p>
</blockquote>



<a name="274409100"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23911%20Small%20wasm%20modules%20taking%20excessive.../near/274409100" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23911.20Small.20wasm.20modules.20taking.20excessive.2E.2E.2E.html#274409100">(Mar 07 2022 at 15:41)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/911#issuecomment-1060824895">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/911">issue #911</a>:</p>
<blockquote>
<p>Another fuzz bug <a href="https://github.com/bytecodealliance/wasmtime/files/8198900/foo.wasm.gz">foo.wasm.gz</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">RAYON_NUM_THREADS</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">perf</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">--</span><span class="n">wasm</span><span class="o">-</span><span class="n">features</span><span class="w"> </span><span class="n">memory64</span><span class="p">,</span><span class="n">multi</span><span class="o">-</span><span class="n">memory</span><span class="w"></span>
<span class="n">RAYON_NUM_THREADS</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">perf</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">wasm</span><span class="w">    </span><span class="mf">2.05</span><span class="n">s</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="mf">0.15</span><span class="n">s</span><span class="w"> </span><span class="n">system</span><span class="w"> </span><span class="mi">70</span><span class="o">%</span><span class="w"> </span><span class="n">cpu</span><span class="w"> </span><span class="mf">3.121</span><span class="w"> </span><span class="n">total</span><span class="w"></span>
</code></pre></div>
<p>(all in regalloc again)</p>
</blockquote>



<a name="274715685"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23911%20Small%20wasm%20modules%20taking%20excessive.../near/274715685" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23911.20Small.20wasm.20modules.20taking.20excessive.2E.2E.2E.html#274715685">(Mar 09 2022 at 16:47)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/911#issuecomment-1063131352">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/911">issue #911</a>:</p>
<blockquote>
<p>Another fuzz bug: <a href="https://github.com/bytecodealliance/wasmtime/files/8216545/testcase0.wasm.gz">testcase0.wasm.gz</a></p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">RAYON_NUM_THREADS</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">--</span><span class="n">wasm</span><span class="o">-</span><span class="n">features</span><span class="w"> </span><span class="n">multi</span><span class="o">-</span><span class="n">memory</span><span class="p">,</span><span class="n">memory64</span><span class="w"> </span><span class="n">testcase0</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="n">RAYON_NUM_THREADS</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">--</span><span class="n">wasm</span><span class="o">-</span><span class="n">features</span><span class="w">    </span><span class="mf">0.63</span><span class="n">s</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="mf">0.00</span><span class="n">s</span><span class="w"> </span><span class="n">system</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="w"> </span><span class="n">cpu</span><span class="w"> </span><span class="mf">0.634</span><span class="w"> </span><span class="n">total</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="274715961"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23911%20Small%20wasm%20modules%20taking%20excessive.../near/274715961" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23911.20Small.20wasm.20modules.20taking.20excessive.2E.2E.2E.html#274715961">(Mar 09 2022 at 16:49)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/911#issuecomment-1063133311">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/911">issue #911</a>:</p>
<blockquote>
<p>Another: <a href="https://github.com/bytecodealliance/wasmtime/files/8216572/testcase0.wasm.gz">testcase0.wasm.gz</a></p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">RAYON_NUM_THREADS</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">testcase0</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="n">RAYON_NUM_THREADS</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">testcase0</span><span class="p">.</span><span class="n">wasm</span><span class="w">  </span><span class="mf">1.91</span><span class="n">s</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="mf">0.00</span><span class="n">s</span><span class="w"> </span><span class="n">system</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="w"> </span><span class="n">cpu</span><span class="w"> </span><span class="mf">1.911</span><span class="w"> </span><span class="n">total</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="274870232"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23911%20Small%20wasm%20modules%20taking%20excessive.../near/274870232" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23911.20Small.20wasm.20modules.20taking.20excessive.2E.2E.2E.html#274870232">(Mar 10 2022 at 17:44)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/911#issuecomment-1064329259">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/911">issue #911</a>:</p>
<blockquote>
<p>Another: <a href="https://github.com/bytecodealliance/wasmtime/files/8225781/testcase3.wasm.gz">testcase3.wasm.gz</a></p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">testcase3</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">testcase3</span><span class="p">.</span><span class="n">wasm</span><span class="w">  </span><span class="mf">3.21</span><span class="n">s</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="mf">0.02</span><span class="n">s</span><span class="w"> </span><span class="n">system</span><span class="w"> </span><span class="mi">100</span><span class="o">%</span><span class="w"> </span><span class="n">cpu</span><span class="w"> </span><span class="mf">3.207</span><span class="w"> </span><span class="n">total</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="275256592"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23911%20Small%20wasm%20modules%20taking%20excessive.../near/275256592" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23911.20Small.20wasm.20modules.20taking.20excessive.2E.2E.2E.html#275256592">(Mar 14 2022 at 15:57)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/911#issuecomment-1066989641">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/911">issue #911</a>:</p>
<blockquote>
<p>Another: <a href="https://github.com/bytecodealliance/wasmtime/files/8246482/testcase0.wasm.gz">testcase0.wasm.gz</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">RAYON_NUM_THREADS</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">testcase0</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">--</span><span class="n">wasm</span><span class="o">-</span><span class="n">features</span><span class="w"> </span><span class="n">multi</span><span class="o">-</span><span class="n">memory</span><span class="p">,</span><span class="n">memory64</span><span class="w"></span>
<span class="n">RAYON_NUM_THREADS</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">testcase0</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">--</span><span class="n">wasm</span><span class="o">-</span><span class="n">features</span><span class="w">   </span><span class="mf">5.13</span><span class="n">s</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="mf">0.22</span><span class="n">s</span><span class="w"> </span><span class="n">system</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="w"> </span><span class="n">cpu</span><span class="w"> </span><span class="mf">5.355</span><span class="w"> </span><span class="n">total</span><span class="w"></span>
</code></pre></div>
</blockquote>



<a name="275536742"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23911%20Small%20wasm%20modules%20taking%20excessive.../near/275536742" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23911.20Small.20wasm.20modules.20taking.20excessive.2E.2E.2E.html#275536742">(Mar 16 2022 at 16:20)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/911#issuecomment-1069293470">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/911">issue #911</a>:</p>
<blockquote>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/8264977/foo.wasm.gz">foo.wasm.gz</a></p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">RAYON_NUM_THREADS</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="o">--</span><span class="n">release</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="n">RAYON_NUM_THREADS</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="o">--</span><span class="n">release</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">wasm</span><span class="w">  </span><span class="mf">1.58</span><span class="n">s</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="mf">0.04</span><span class="n">s</span><span class="w"> </span><span class="n">system</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="w"> </span><span class="n">cpu</span><span class="w"> </span><span class="mf">1.629</span><span class="w"> </span><span class="n">total</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="275536826"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23911%20Small%20wasm%20modules%20taking%20excessive.../near/275536826" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23911.20Small.20wasm.20modules.20taking.20excessive.2E.2E.2E.html#275536826">(Mar 16 2022 at 16:21)</a>:</h4>
<p>alexcrichton edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/911#issuecomment-1069293470">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/911">issue #911</a>:</p>
<blockquote>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/8264977/foo.wasm.gz">foo.wasm.gz</a></p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">RAYON_NUM_THREADS</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="o">--</span><span class="n">release</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="n">RAYON_NUM_THREADS</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="o">--</span><span class="n">release</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">wasm</span><span class="w">  </span><span class="mf">1.58</span><span class="n">s</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="mf">0.04</span><span class="n">s</span><span class="w"> </span><span class="n">system</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="w"> </span><span class="n">cpu</span><span class="w"> </span><span class="mf">1.629</span><span class="w"> </span><span class="n">total</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="276217886"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23911%20Small%20wasm%20modules%20taking%20excessive.../near/276217886" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23911.20Small.20wasm.20modules.20taking.20excessive.2E.2E.2E.html#276217886">(Mar 22 2022 at 16:39)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/911#issuecomment-1075370444">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/911">issue #911</a>:</p>
<blockquote>
<p><span aria-label="warning" class="emoji emoji-26a0" role="img" title="warning">:warning:</span>️<span aria-label="warning" class="emoji emoji-26a0" role="img" title="warning">:warning:</span>️<span aria-label="warning" class="emoji emoji-26a0" role="img" title="warning">:warning:</span>️<span aria-label="warning" class="emoji emoji-26a0" role="img" title="warning">:warning:</span>️<span aria-label="warning" class="emoji emoji-26a0" role="img" title="warning">:warning:</span>️ </p>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/8326206/testcase0.wasm.gz">testcase0.wasm.gz</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">testcase0</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="n">wasmtime</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">testcase0</span><span class="p">.</span><span class="n">wasm</span><span class="w">  </span><span class="mf">100.89</span><span class="n">s</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="mf">0.02</span><span class="n">s</span><span class="w"> </span><span class="n">system</span><span class="w"> </span><span class="mi">100</span><span class="o">%</span><span class="w"> </span><span class="n">cpu</span><span class="w"> </span><span class="mi">1</span>:<span class="mf">40.89</span><span class="w"> </span><span class="n">total</span><span class="w"></span>
</code></pre></div>
</blockquote>



<a name="277166792"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23911%20Small%20wasm%20modules%20taking%20excessive.../near/277166792" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23911.20Small.20wasm.20modules.20taking.20excessive.2E.2E.2E.html#277166792">(Mar 30 2022 at 16:02)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/911#issuecomment-1083328453">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/911">issue #911</a>:</p>
<blockquote>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/8382110/testcase0.wasm.gz">testcase0.wasm.gz</a></p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">testcase0</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="n">wasmtime</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">testcase0</span><span class="p">.</span><span class="n">wasm</span><span class="w">  </span><span class="mf">4.84</span><span class="n">s</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="mf">0.00</span><span class="n">s</span><span class="w"> </span><span class="n">system</span><span class="w"> </span><span class="mi">100</span><span class="o">%</span><span class="w"> </span><span class="n">cpu</span><span class="w"> </span><span class="mf">4.829</span><span class="w"> </span><span class="n">total</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="280222954"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23911%20Small%20wasm%20modules%20taking%20excessive.../near/280222954" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23911.20Small.20wasm.20modules.20taking.20excessive.2E.2E.2E.html#280222954">(Apr 26 2022 at 15:00)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/911#issuecomment-1109906389">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/911">issue #911</a>:</p>
<blockquote>
<p>I'm going to close this given the discussion on <a href="https://github.com/bytecodealliance/wasmtime/issues/4060">https://github.com/bytecodealliance/wasmtime/issues/4060</a>, these sorts of outliers are expected and eventually we'll want to tweak fuzzers to not generate these patterns of code.</p>
</blockquote>



<a name="280222956"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23911%20Small%20wasm%20modules%20taking%20excessive.../near/280222956" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23911.20Small.20wasm.20modules.20taking.20excessive.2E.2E.2E.html#280222956">(Apr 26 2022 at 15:00)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/911">issue #911</a>:</p>
<blockquote>
<p>In reviewing some fuzz bugs we've got a good number of test cases that end up timing out unfortunately. I believe that cranelift has a number of known issues about the speed of its compilation, particularly around register allocation. I figure it'd be good to collect a few concrete wasm files (discovered from fuzzing) which take an abnormally long amount of time to compile compared to the size of the input.</p>
<p>It's worth noting that the timeout on the fuzzers is relatively high, I think something like 30 or 60 seconds. When fuzzing though <a href="https://github.com/rust-fuzz/cargo-fuzz/issues/216">binaries can be up to 50x slower</a> which means our time budget for passing the fuzzers is pretty small, generally less than 3 seconds I think (ish). It's also worth noting that fuzzers are compiled with debug assertions enabled, which enables, well, debug assertions, but also the cranelift verifier pass. I've seen the verifier pass be quite expensive on some of these modules below, but in general the modules without the verifier pass still take an abnormally long amount of time to compile.</p>
<p>For the files below I'm testing with:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">--</span><span class="n">release</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">cache</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">foo2</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
</code></pre></div>
<p>most of them fail to instantiate or run, but it's the compilation which largely matters here which all happens as part of <code>time</code>. Which is to say you can ignore the errors of the CLI generally</p>
<ul>
<li><a href="https://github.com/bytecodealliance/wasmtime/files/4166418/file1.wasm.1.gz">file1.wasm[1].gz</a> - takes 1s locally. Profiling shows lots of time in the register allocator.</li>
<li><a href="https://github.com/bytecodealliance/wasmtime/files/4166471/file2.wasm.1.gz">file2.wasm[1].gz</a> - this takes 300ms locally, but with the verifier and debug assertions enabled takes about 1s. The time looks to be largely in the verifier/register allocator like before.</li>
<li><a href="https://github.com/bytecodealliance/wasmtime/files/4166505/file3.wasm.1.gz">file3.wasm[1].gz</a> - same as previous</li>
<li><a href="https://github.com/bytecodealliance/wasmtime/files/4166506/file4.wasm.1.gz">file4.wasm[1].gz</a> - same as previous</li>
</ul>
<p>I'm assuming that there's generally not a huge amount we can do about this. When cranelift is looking to benchmark new register allocator implementations, however, we can perhaps use the files here as test beds to see how things are improving?</p>
<p>In any case I figure it's good to start tracking files as we come across them if we can.<br>
</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>