<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #2211 Linker does not properly define im... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232211.20Linker.20does.20not.20properly.20define.20im.2E.2E.2E.html">wasmtime / Issue #2211 Linker does not properly define im...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="210654243"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232211%20Linker%20does%20not%20properly%20define%20im.../near/210654243" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232211.20Linker.20does.20not.20properly.20define.20im.2E.2E.2E.html#210654243">(Sep 20 2020 at 07:35)</a>:</h4>
<p>7Hazard labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/2211">Issue #2211</a>:</p>
<blockquote>
<p>Using the C API, defining imports with the Linker do not work properly. When attempting to instantiate the module in question, it errors with the following:<br>
<code>unknown import: `env::Test` has not been defined</code></p>
<p>This is how the module is attempted to be instantiated:</p>
<div class="codehilite"><pre><span></span><code><span class="n">wasm_trap_t</span><span class="o">*</span> <span class="n">trap</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="n">wasm_instance_t</span><span class="o">*</span> <span class="n">instance</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>

<span class="n">wasm_engine_t</span><span class="o">*</span> <span class="n">engine</span> <span class="o">=</span> <span class="n">wasm_engine_new</span><span class="p">();</span>
<span class="n">wasm_store_t</span><span class="o">*</span> <span class="n">store</span> <span class="o">=</span> <span class="n">wasm_store_new</span><span class="p">(</span><span class="n">engine</span><span class="p">);</span>
<span class="n">wasmtime_linker_t</span><span class="o">*</span> <span class="n">linker</span> <span class="o">=</span> <span class="n">wasmtime_linker_new</span><span class="p">(</span><span class="n">store</span><span class="p">);</span>

<span class="c1">// Read wasm file</span>
<span class="n">wasm_byte_vec_t</span> <span class="n">wasm</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">ifstream</span> <span class="n">file</span><span class="p">(</span><span class="s">&quot;wasmtest.wasm&quot;</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">binary</span> <span class="o">|</span> <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">ate</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">.</span><span class="n">good</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;File wasmtest.wasm bad&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">auto</span> <span class="n">filesize</span> <span class="o">=</span> <span class="n">file</span><span class="p">.</span><span class="n">tellg</span><span class="p">();</span>
<span class="n">file</span><span class="p">.</span><span class="n">seekg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">beg</span><span class="p">);</span>
<span class="n">wasm_byte_vec_new_uninitialized</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasm</span><span class="p">,</span> <span class="n">filesize</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">wasm</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">filesize</span><span class="p">))</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Could not read file&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Compile module</span>
<span class="n">wasm_module_t</span><span class="o">*</span> <span class="k">module</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">wasmtime_module_new</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wasm</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">module</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">logWasmError</span><span class="p">(</span><span class="s">&quot;Failed to compile module&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">wasm_byte_vec_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasm</span><span class="p">);</span>

<span class="c1">// MAKE IMPORTS</span>
<span class="p">{</span>
    <span class="k">auto</span> <span class="k">import</span> <span class="o">=</span> <span class="p">[](</span><span class="k">const</span> <span class="n">wasm_val_t</span> <span class="n">args</span><span class="p">[],</span> <span class="n">wasm_val_t</span> <span class="n">results</span><span class="p">[])</span><span class="o">-&gt;</span><span class="n">wasm_trap_t</span><span class="o">*</span><span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello world&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="n">wasm_valtype_vec_t</span> <span class="n">types</span><span class="p">;</span>
    <span class="n">wasm_valtype_vec_new_uninitialized</span><span class="p">(</span><span class="o">&amp;</span><span class="n">types</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">wasm_functype_t</span> <span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">wasm_functype_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">types</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">types</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">function</span> <span class="o">=</span> <span class="n">wasm_func_new</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="k">import</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">extern_</span> <span class="o">=</span> <span class="n">wasm_func_as_extern</span><span class="p">(</span><span class="n">function</span><span class="p">);</span>

    <span class="n">wasm_name_t</span> <span class="k">module</span><span class="p">;</span>
    <span class="n">wasm_name_new_from_string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">module</span><span class="p">,</span> <span class="s">&quot;env&quot;</span><span class="p">);</span>
    <span class="n">wasm_name_t</span> <span class="n">func</span><span class="p">;</span>
    <span class="n">wasm_name_new_from_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func</span><span class="p">,</span> <span class="s">&quot;Test&quot;</span><span class="p">);</span>
    <span class="n">wasmtime_linker_define</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">module</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func</span><span class="p">,</span> <span class="n">extern_</span><span class="p">);</span>
    <span class="n">wasm_name_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// INSTANTIATE MODULE</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">wasmtime_linker_instantiate</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="k">module</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">instance</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trap</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">||</span> <span class="n">trap</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">logWasmError</span><span class="p">(</span><span class="s">&quot;Failed to instantiate module&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">trap</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<p>This is the module that is being attempted to be loaded (compiled with clang):</p>
<div class="codehilite"><pre><span></span><code><span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="kt">void</span> <span class="n">Test</span><span class="p">();</span>

<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Test</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>


<p>The imports in the wat looks like this:</p>
<div class="codehilite"><pre><span></span><code>(type $t0 (func))
(type $t1 (func (param i32) (result i32)))
(import &quot;env&quot; &quot;Test&quot; (func $Test (type $t0)))
</code></pre></div>


<p>This was tested on Windows 10, using the C API build from <a href="https://github.com/bytecodealliance/wasmtime/releases/tag/v0.19.0">https://github.com/bytecodealliance/wasmtime/releases/tag/v0.19.0</a>.</p>
</blockquote>



<a name="210654244"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232211%20Linker%20does%20not%20properly%20define%20im.../near/210654244" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232211.20Linker.20does.20not.20properly.20define.20im.2E.2E.2E.html#210654244">(Sep 20 2020 at 07:35)</a>:</h4>
<p>7Hazard opened <a href="https://github.com/bytecodealliance/wasmtime/issues/2211">Issue #2211</a>:</p>
<blockquote>
<p>Using the C API, defining imports with the Linker do not work properly. When attempting to instantiate the module in question, it errors with the following:<br>
<code>unknown import: `env::Test` has not been defined</code></p>
<p>This is how the module is attempted to be instantiated:</p>
<div class="codehilite"><pre><span></span><code><span class="n">wasm_trap_t</span><span class="o">*</span> <span class="n">trap</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="n">wasm_instance_t</span><span class="o">*</span> <span class="n">instance</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>

<span class="n">wasm_engine_t</span><span class="o">*</span> <span class="n">engine</span> <span class="o">=</span> <span class="n">wasm_engine_new</span><span class="p">();</span>
<span class="n">wasm_store_t</span><span class="o">*</span> <span class="n">store</span> <span class="o">=</span> <span class="n">wasm_store_new</span><span class="p">(</span><span class="n">engine</span><span class="p">);</span>
<span class="n">wasmtime_linker_t</span><span class="o">*</span> <span class="n">linker</span> <span class="o">=</span> <span class="n">wasmtime_linker_new</span><span class="p">(</span><span class="n">store</span><span class="p">);</span>

<span class="c1">// Read wasm file</span>
<span class="n">wasm_byte_vec_t</span> <span class="n">wasm</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">ifstream</span> <span class="n">file</span><span class="p">(</span><span class="s">&quot;wasmtest.wasm&quot;</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">binary</span> <span class="o">|</span> <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">ate</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">.</span><span class="n">good</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;File wasmtest.wasm bad&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">auto</span> <span class="n">filesize</span> <span class="o">=</span> <span class="n">file</span><span class="p">.</span><span class="n">tellg</span><span class="p">();</span>
<span class="n">file</span><span class="p">.</span><span class="n">seekg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">beg</span><span class="p">);</span>
<span class="n">wasm_byte_vec_new_uninitialized</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasm</span><span class="p">,</span> <span class="n">filesize</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">wasm</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">filesize</span><span class="p">))</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Could not read file&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Compile module</span>
<span class="n">wasm_module_t</span><span class="o">*</span> <span class="k">module</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">wasmtime_module_new</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wasm</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">module</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">logWasmError</span><span class="p">(</span><span class="s">&quot;Failed to compile module&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">wasm_byte_vec_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasm</span><span class="p">);</span>

<span class="c1">// MAKE IMPORTS</span>
<span class="p">{</span>
    <span class="k">auto</span> <span class="k">import</span> <span class="o">=</span> <span class="p">[](</span><span class="k">const</span> <span class="n">wasm_val_t</span> <span class="n">args</span><span class="p">[],</span> <span class="n">wasm_val_t</span> <span class="n">results</span><span class="p">[])</span><span class="o">-&gt;</span><span class="n">wasm_trap_t</span><span class="o">*</span><span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello world&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="n">wasm_valtype_vec_t</span> <span class="n">types</span><span class="p">;</span>
    <span class="n">wasm_valtype_vec_new_uninitialized</span><span class="p">(</span><span class="o">&amp;</span><span class="n">types</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">wasm_functype_t</span> <span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">wasm_functype_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">types</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">types</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">function</span> <span class="o">=</span> <span class="n">wasm_func_new</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="k">import</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">extern_</span> <span class="o">=</span> <span class="n">wasm_func_as_extern</span><span class="p">(</span><span class="n">function</span><span class="p">);</span>

    <span class="n">wasm_name_t</span> <span class="k">module</span><span class="p">;</span>
    <span class="n">wasm_name_new_from_string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">module</span><span class="p">,</span> <span class="s">&quot;env&quot;</span><span class="p">);</span>
    <span class="n">wasm_name_t</span> <span class="n">func</span><span class="p">;</span>
    <span class="n">wasm_name_new_from_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func</span><span class="p">,</span> <span class="s">&quot;Test&quot;</span><span class="p">);</span>
    <span class="n">wasmtime_linker_define</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">module</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func</span><span class="p">,</span> <span class="n">extern_</span><span class="p">);</span>
    <span class="n">wasm_name_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// INSTANTIATE MODULE</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">wasmtime_linker_instantiate</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="k">module</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">instance</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trap</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">||</span> <span class="n">trap</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">logWasmError</span><span class="p">(</span><span class="s">&quot;Failed to instantiate module&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">trap</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<p>This is the module that is being attempted to be loaded (compiled with clang):</p>
<div class="codehilite"><pre><span></span><code><span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="kt">void</span> <span class="n">Test</span><span class="p">();</span>

<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Test</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>


<p>The imports in the wat looks like this:</p>
<div class="codehilite"><pre><span></span><code>(type $t0 (func))
(type $t1 (func (param i32) (result i32)))
(import &quot;env&quot; &quot;Test&quot; (func $Test (type $t0)))
</code></pre></div>


<p>This was tested on Windows 10, using the C API build from <a href="https://github.com/bytecodealliance/wasmtime/releases/tag/v0.19.0">https://github.com/bytecodealliance/wasmtime/releases/tag/v0.19.0</a>.</p>
</blockquote>



<a name="210654250"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232211%20Linker%20does%20not%20properly%20define%20im.../near/210654250" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232211.20Linker.20does.20not.20properly.20define.20im.2E.2E.2E.html#210654250">(Sep 20 2020 at 07:35)</a>:</h4>
<p>7Hazard edited <a href="https://github.com/bytecodealliance/wasmtime/issues/2211">Issue #2211</a>:</p>
<blockquote>
<p>Using the C API, defining imports with the Linker do not work properly. When attempting to instantiate the module in question, it errors with the following:<br>
<code>unknown import: `env::Test` has not been defined</code></p>
<p>This is how the module is attempted to be instantiated:</p>
<div class="codehilite"><pre><span></span><code><span class="n">wasm_trap_t</span><span class="o">*</span> <span class="n">trap</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="n">wasm_instance_t</span><span class="o">*</span> <span class="n">instance</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>

<span class="n">wasm_engine_t</span><span class="o">*</span> <span class="n">engine</span> <span class="o">=</span> <span class="n">wasm_engine_new</span><span class="p">();</span>
<span class="n">wasm_store_t</span><span class="o">*</span> <span class="n">store</span> <span class="o">=</span> <span class="n">wasm_store_new</span><span class="p">(</span><span class="n">engine</span><span class="p">);</span>
<span class="n">wasmtime_linker_t</span><span class="o">*</span> <span class="n">linker</span> <span class="o">=</span> <span class="n">wasmtime_linker_new</span><span class="p">(</span><span class="n">store</span><span class="p">);</span>

<span class="c1">// Read wasm file</span>
<span class="n">wasm_byte_vec_t</span> <span class="n">wasm</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">ifstream</span> <span class="n">file</span><span class="p">(</span><span class="s">&quot;wasmtest.wasm&quot;</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">binary</span> <span class="o">|</span> <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">ate</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">.</span><span class="n">good</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;File wasmtest.wasm bad&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">auto</span> <span class="n">filesize</span> <span class="o">=</span> <span class="n">file</span><span class="p">.</span><span class="n">tellg</span><span class="p">();</span>
<span class="n">file</span><span class="p">.</span><span class="n">seekg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">beg</span><span class="p">);</span>
<span class="n">wasm_byte_vec_new_uninitialized</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasm</span><span class="p">,</span> <span class="n">filesize</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">wasm</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">filesize</span><span class="p">))</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Could not read file&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Compile module</span>
<span class="n">wasm_module_t</span><span class="o">*</span> <span class="k">module</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">wasmtime_module_new</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wasm</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">module</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">logWasmError</span><span class="p">(</span><span class="s">&quot;Failed to compile module&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">wasm_byte_vec_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasm</span><span class="p">);</span>

<span class="c1">// MAKE IMPORTS</span>
<span class="p">{</span>
    <span class="k">auto</span> <span class="k">import</span> <span class="o">=</span> <span class="p">[](</span><span class="k">const</span> <span class="n">wasm_val_t</span> <span class="n">args</span><span class="p">[],</span> <span class="n">wasm_val_t</span> <span class="n">results</span><span class="p">[])</span><span class="o">-&gt;</span><span class="n">wasm_trap_t</span><span class="o">*</span><span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello world&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="n">wasm_valtype_vec_t</span> <span class="n">types</span><span class="p">;</span>
    <span class="n">wasm_valtype_vec_new_uninitialized</span><span class="p">(</span><span class="o">&amp;</span><span class="n">types</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">wasm_functype_t</span> <span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">wasm_functype_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">types</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">types</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">function</span> <span class="o">=</span> <span class="n">wasm_func_new</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="k">import</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">extern_</span> <span class="o">=</span> <span class="n">wasm_func_as_extern</span><span class="p">(</span><span class="n">function</span><span class="p">);</span>

    <span class="n">wasm_name_t</span> <span class="k">module</span><span class="p">;</span>
    <span class="n">wasm_name_new_from_string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">module</span><span class="p">,</span> <span class="s">&quot;env&quot;</span><span class="p">);</span>
    <span class="n">wasm_name_t</span> <span class="n">func</span><span class="p">;</span>
    <span class="n">wasm_name_new_from_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func</span><span class="p">,</span> <span class="s">&quot;Test&quot;</span><span class="p">);</span>
    <span class="n">wasmtime_linker_define</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">module</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func</span><span class="p">,</span> <span class="n">extern_</span><span class="p">);</span>
    <span class="n">wasm_name_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// INSTANTIATE MODULE</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">wasmtime_linker_instantiate</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="k">module</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">instance</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trap</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">||</span> <span class="n">trap</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">logWasmError</span><span class="p">(</span><span class="s">&quot;Failed to instantiate module&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">trap</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<p>This is the module that is being attempted to be loaded (compiled with clang):</p>
<div class="codehilite"><pre><span></span><code><span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="kt">void</span> <span class="n">Test</span><span class="p">();</span>

<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Test</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>


<p>The imports in the wat looks like this:</p>
<div class="codehilite"><pre><span></span><code>(type $t0 (func))
(import &quot;env&quot; &quot;Test&quot; (func $Test (type $t0)))
</code></pre></div>


<p>This was tested on Windows 10, using the C API build from <a href="https://github.com/bytecodealliance/wasmtime/releases/tag/v0.19.0">https://github.com/bytecodealliance/wasmtime/releases/tag/v0.19.0</a>.</p>
</blockquote>



<a name="210904620"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232211%20Linker%20does%20not%20properly%20define%20im.../near/210904620" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232211.20Linker.20does.20not.20properly.20define.20im.2E.2E.2E.html#210904620">(Sep 22 2020 at 17:31)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/2211#issuecomment-696868194">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2211">Issue #2211</a>:</p>
<blockquote>
<p>Thanks for the report! The issue here is somewhat subtle and unfortunate. The <code>wasm_name_new_from_string</code> function will have the length of the name including the terminating nul character, but the <code>wasmtime_linker_define</code> API does not expect the nul character to be included, so the name you're defining is actually <code>("env\u{0}", "Test\u{0}")</code>, which isn't what you want here.</p>
</blockquote>



<a name="210933954"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232211%20Linker%20does%20not%20properly%20define%20im.../near/210933954" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232211.20Linker.20does.20not.20properly.20define.20im.2E.2E.2E.html#210933954">(Sep 22 2020 at 21:33)</a>:</h4>
<p>7Hazard <a href="https://github.com/bytecodealliance/wasmtime/issues/2211#issuecomment-696994156">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2211">Issue #2211</a>:</p>
<blockquote>
<p>I see, indeed it was very subtle. However wouldn't this be a defect for <code>wasm_name_new_from_string</code> as an API function? I'm not sure if there are other purposes for <code>wasm_name_new_from_string</code> and <code>wasm_name_t</code>.</p>
</blockquote>



<a name="211206249"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232211%20Linker%20does%20not%20properly%20define%20im.../near/211206249" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232211.20Linker.20does.20not.20properly.20define.20im.2E.2E.2E.html#211206249">(Sep 25 2020 at 00:29)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/2211#issuecomment-698655340">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2211">Issue #2211</a>:</p>
<blockquote>
<p>I believe the upstream API was adjusted in <a href="https://github.com/WebAssembly/wasm-c-api/pull/151">https://github.com/WebAssembly/wasm-c-api/pull/151</a>, and we haven't pulled in that update yet.</p>
</blockquote>



<a name="222483917"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232211%20Linker%20does%20not%20properly%20define%20im.../near/222483917" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232211.20Linker.20does.20not.20properly.20define.20im.2E.2E.2E.html#222483917">(Jan 12 2021 at 19:42)</a>:</h4>
<p>Dakror <a href="https://github.com/bytecodealliance/wasmtime/issues/2211#issuecomment-758891406">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2211">Issue #2211</a>:</p>
<blockquote>
<p>Could this be addressed? The fix of pulling upstream should be trivial, no?</p>
</blockquote>



<a name="222530670"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232211%20Linker%20does%20not%20properly%20define%20im.../near/222530670" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232211.20Linker.20does.20not.20properly.20define.20im.2E.2E.2E.html#222530670">(Jan 13 2021 at 04:06)</a>:</h4>
<p>peterhuene assigned <a href="https://github.com/bytecodealliance/wasmtime/issues/2211">Issue #2211</a>:</p>
<blockquote>
<p>Using the C API, defining imports with the Linker do not work properly. When attempting to instantiate the module in question, it errors with the following:<br>
<code>unknown import: `env::Test` has not been defined</code></p>
<p>This is how the module is attempted to be instantiated:</p>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="n">wasm_trap_t</span><span class="o">*</span> <span class="n">trap</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="n">wasm_instance_t</span><span class="o">*</span> <span class="n">instance</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>

<span class="n">wasm_engine_t</span><span class="o">*</span> <span class="n">engine</span> <span class="o">=</span> <span class="n">wasm_engine_new</span><span class="p">();</span>
<span class="n">wasm_store_t</span><span class="o">*</span> <span class="n">store</span> <span class="o">=</span> <span class="n">wasm_store_new</span><span class="p">(</span><span class="n">engine</span><span class="p">);</span>
<span class="n">wasmtime_linker_t</span><span class="o">*</span> <span class="n">linker</span> <span class="o">=</span> <span class="n">wasmtime_linker_new</span><span class="p">(</span><span class="n">store</span><span class="p">);</span>

<span class="c1">// Read wasm file</span>
<span class="n">wasm_byte_vec_t</span> <span class="n">wasm</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">ifstream</span> <span class="n">file</span><span class="p">(</span><span class="s">"wasmtest.wasm"</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">binary</span> <span class="o">|</span> <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">ate</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">.</span><span class="n">good</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"File wasmtest.wasm bad"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">auto</span> <span class="n">filesize</span> <span class="o">=</span> <span class="n">file</span><span class="p">.</span><span class="n">tellg</span><span class="p">();</span>
<span class="n">file</span><span class="p">.</span><span class="n">seekg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">beg</span><span class="p">);</span>
<span class="n">wasm_byte_vec_new_uninitialized</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasm</span><span class="p">,</span> <span class="n">filesize</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">wasm</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">filesize</span><span class="p">))</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Could not read file"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Compile module</span>
<span class="n">wasm_module_t</span><span class="o">*</span> <span class="k">module</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">wasmtime_module_new</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wasm</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">module</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">logWasmError</span><span class="p">(</span><span class="s">"Failed to compile module"</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">wasm_byte_vec_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasm</span><span class="p">);</span>

<span class="c1">// MAKE IMPORTS</span>
<span class="p">{</span>
    <span class="k">auto</span> <span class="k">import</span> <span class="o">=</span> <span class="p">[](</span><span class="k">const</span> <span class="n">wasm_val_t</span> <span class="n">args</span><span class="p">[],</span> <span class="n">wasm_val_t</span> <span class="n">results</span><span class="p">[])</span><span class="o">-&gt;</span><span class="n">wasm_trap_t</span><span class="o">*</span><span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Hello world"</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="n">wasm_valtype_vec_t</span> <span class="n">types</span><span class="p">;</span>
    <span class="n">wasm_valtype_vec_new_uninitialized</span><span class="p">(</span><span class="o">&amp;</span><span class="n">types</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">wasm_functype_t</span> <span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">wasm_functype_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">types</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">types</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">function</span> <span class="o">=</span> <span class="n">wasm_func_new</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="k">import</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">extern_</span> <span class="o">=</span> <span class="n">wasm_func_as_extern</span><span class="p">(</span><span class="n">function</span><span class="p">);</span>

    <span class="n">wasm_name_t</span> <span class="k">module</span><span class="p">;</span>
    <span class="n">wasm_name_new_from_string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">module</span><span class="p">,</span> <span class="s">"env"</span><span class="p">);</span>
    <span class="n">wasm_name_t</span> <span class="n">func</span><span class="p">;</span>
    <span class="n">wasm_name_new_from_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func</span><span class="p">,</span> <span class="s">"Test"</span><span class="p">);</span>
    <span class="n">wasmtime_linker_define</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">module</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func</span><span class="p">,</span> <span class="n">extern_</span><span class="p">);</span>
    <span class="n">wasm_name_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// INSTANTIATE MODULE</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">wasmtime_linker_instantiate</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="k">module</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">instance</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trap</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">||</span> <span class="n">trap</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">logWasmError</span><span class="p">(</span><span class="s">"Failed to instantiate module"</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">trap</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>This is the module that is being attempted to be loaded (compiled with clang):</p>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="k">extern</span> <span class="s">"C"</span> <span class="kt">void</span> <span class="n">Test</span><span class="p">();</span>

<span class="k">extern</span> <span class="s">"C"</span> <span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Test</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>The imports in the wat looks like this:</p>
<div class="codehilite" data-code-language="wat"><pre><span></span><code>(type $t0 (func))
(import "env" "Test" (func $Test (type $t0)))
</code></pre></div>
<p>This was tested on Windows 10, using the C API build from <a href="https://github.com/bytecodealliance/wasmtime/releases/tag/v0.19.0">https://github.com/bytecodealliance/wasmtime/releases/tag/v0.19.0</a>.</p>
</blockquote>



<a name="222530730"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232211%20Linker%20does%20not%20properly%20define%20im.../near/222530730" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232211.20Linker.20does.20not.20properly.20define.20im.2E.2E.2E.html#222530730">(Jan 13 2021 at 04:07)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/2211#issuecomment-759191583">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2211">Issue #2211</a>:</p>
<blockquote>
<p>We should be able to update the Wasmtime C API to fix this now.  I'll try to get a fix up tomorrow.</p>
<p>You should be able to work around the issue using <code>wasm_name_new</code> with the current implementation, if needed.</p>
</blockquote>



<a name="222733860"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232211%20Linker%20does%20not%20properly%20define%20im.../near/222733860" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232211.20Linker.20does.20not.20properly.20define.20im.2E.2E.2E.html#222733860">(Jan 14 2021 at 15:36)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/2211">Issue #2211</a> (assigned to peterhuene):</p>
<blockquote>
<p>Using the C API, defining imports with the Linker do not work properly. When attempting to instantiate the module in question, it errors with the following:<br>
<code>unknown import: `env::Test` has not been defined</code></p>
<p>This is how the module is attempted to be instantiated:</p>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="n">wasm_trap_t</span><span class="o">*</span> <span class="n">trap</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="n">wasm_instance_t</span><span class="o">*</span> <span class="n">instance</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>

<span class="n">wasm_engine_t</span><span class="o">*</span> <span class="n">engine</span> <span class="o">=</span> <span class="n">wasm_engine_new</span><span class="p">();</span>
<span class="n">wasm_store_t</span><span class="o">*</span> <span class="n">store</span> <span class="o">=</span> <span class="n">wasm_store_new</span><span class="p">(</span><span class="n">engine</span><span class="p">);</span>
<span class="n">wasmtime_linker_t</span><span class="o">*</span> <span class="n">linker</span> <span class="o">=</span> <span class="n">wasmtime_linker_new</span><span class="p">(</span><span class="n">store</span><span class="p">);</span>

<span class="c1">// Read wasm file</span>
<span class="n">wasm_byte_vec_t</span> <span class="n">wasm</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">ifstream</span> <span class="n">file</span><span class="p">(</span><span class="s">"wasmtest.wasm"</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">binary</span> <span class="o">|</span> <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">ate</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">.</span><span class="n">good</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"File wasmtest.wasm bad"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">auto</span> <span class="n">filesize</span> <span class="o">=</span> <span class="n">file</span><span class="p">.</span><span class="n">tellg</span><span class="p">();</span>
<span class="n">file</span><span class="p">.</span><span class="n">seekg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">beg</span><span class="p">);</span>
<span class="n">wasm_byte_vec_new_uninitialized</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasm</span><span class="p">,</span> <span class="n">filesize</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">wasm</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">filesize</span><span class="p">))</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Could not read file"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Compile module</span>
<span class="n">wasm_module_t</span><span class="o">*</span> <span class="k">module</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">wasmtime_module_new</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wasm</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">module</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">logWasmError</span><span class="p">(</span><span class="s">"Failed to compile module"</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">wasm_byte_vec_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasm</span><span class="p">);</span>

<span class="c1">// MAKE IMPORTS</span>
<span class="p">{</span>
    <span class="k">auto</span> <span class="k">import</span> <span class="o">=</span> <span class="p">[](</span><span class="k">const</span> <span class="n">wasm_val_t</span> <span class="n">args</span><span class="p">[],</span> <span class="n">wasm_val_t</span> <span class="n">results</span><span class="p">[])</span><span class="o">-&gt;</span><span class="n">wasm_trap_t</span><span class="o">*</span><span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Hello world"</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="n">wasm_valtype_vec_t</span> <span class="n">types</span><span class="p">;</span>
    <span class="n">wasm_valtype_vec_new_uninitialized</span><span class="p">(</span><span class="o">&amp;</span><span class="n">types</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">wasm_functype_t</span> <span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">wasm_functype_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">types</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">types</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">function</span> <span class="o">=</span> <span class="n">wasm_func_new</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="k">import</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">extern_</span> <span class="o">=</span> <span class="n">wasm_func_as_extern</span><span class="p">(</span><span class="n">function</span><span class="p">);</span>

    <span class="n">wasm_name_t</span> <span class="k">module</span><span class="p">;</span>
    <span class="n">wasm_name_new_from_string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">module</span><span class="p">,</span> <span class="s">"env"</span><span class="p">);</span>
    <span class="n">wasm_name_t</span> <span class="n">func</span><span class="p">;</span>
    <span class="n">wasm_name_new_from_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func</span><span class="p">,</span> <span class="s">"Test"</span><span class="p">);</span>
    <span class="n">wasmtime_linker_define</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">module</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func</span><span class="p">,</span> <span class="n">extern_</span><span class="p">);</span>
    <span class="n">wasm_name_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// INSTANTIATE MODULE</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">wasmtime_linker_instantiate</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="k">module</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">instance</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trap</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">||</span> <span class="n">trap</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">logWasmError</span><span class="p">(</span><span class="s">"Failed to instantiate module"</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">trap</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>This is the module that is being attempted to be loaded (compiled with clang):</p>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="k">extern</span> <span class="s">"C"</span> <span class="kt">void</span> <span class="n">Test</span><span class="p">();</span>

<span class="k">extern</span> <span class="s">"C"</span> <span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Test</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>The imports in the wat looks like this:</p>
<div class="codehilite" data-code-language="wat"><pre><span></span><code>(type $t0 (func))
(import "env" "Test" (func $Test (type $t0)))
</code></pre></div>
<p>This was tested on Windows 10, using the C API build from <a href="https://github.com/bytecodealliance/wasmtime/releases/tag/v0.19.0">https://github.com/bytecodealliance/wasmtime/releases/tag/v0.19.0</a>.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>