<html>
<head><meta charset="utf-8"><title>wasmtime / issue #4327 Implement lowered-then-lifted func... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234327.20Implement.20lowered-then-lifted.20func.2E.2E.2E.html">wasmtime / issue #4327 Implement lowered-then-lifted func...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="287596011"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234327%20Implement%20lowered-then-lifted%20func.../near/287596011" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234327.20Implement.20lowered-then-lifted.20func.2E.2E.2E.html#287596011">(Jun 27 2022 at 15:41)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/4327#issuecomment-1167513247">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4327">issue #4327</a>:</p>
<blockquote>
<p>I was originally going to include lifted-then-lowered functions in the same component here as well, but that has snowballed quite a lot so I opted to split this out and get this in first.</p>
</blockquote>



<a name="287605552"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234327%20Implement%20lowered-then-lifted%20func.../near/287605552" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234327.20Implement.20lowered-then-lifted.20func.2E.2E.2E.html#287605552">(Jun 27 2022 at 16:47)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/4327#issuecomment-1167599419">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4327">issue #4327</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @peterhuene</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "wasmtime:api"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>peterhuene: wasmtime:api</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="293952402"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234327%20Implement%20lowered-then-lifted%20func.../near/293952402" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234327.20Implement.20lowered-then-lifted.20func.2E.2E.2E.html#293952402">(Aug 17 2022 at 18:28)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4327#issuecomment-1218357295">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4327">issue #4327</a>:</p>
<blockquote>
<p>@alexcrichton I'm doing some historical benchmarking to look at how various features have improved Wasmtime + Cranelift over time, and I found a regression in compile time that I've bisected to this PR.</p>
<p>In particular, compiling <code>spidermonkey.wasm</code> (with <code>wasmtime compile</code> on the command line measured using <code>hyperfine</code>, on a machine with CPU frequency locked to 2.8GHz and turbo-boost disabled):</p>
<ul>
<li>commit <code>df1502531d437b2105effb990a7caa28796aa985</code>, just prior to this PR's merge: 1.23s</li>
<li>commit <code>c1b3962f7b9fc1c193e1b9709db64c455699a295</code>, this PR's merge: 1.43s, or 16% slower</li>
</ul>
<p>Is this expected (I see a note above about compiling more trampolines)?</p>
<p>The regression persists to today, so I'm definitely interested in ways we could ameliorate this!</p>
</blockquote>



<a name="293953363"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234327%20Implement%20lowered-then-lifted%20func.../near/293953363" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234327.20Implement.20lowered-then-lifted.20func.2E.2E.2E.html#293953363">(Aug 17 2022 at 18:34)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/4327#issuecomment-1218362203">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4327">issue #4327</a>:</p>
<blockquote>
<p>Hm no this PR shouldn't have affected core wasm compilation, I will try to dig in further and see what this caused.</p>
</blockquote>



<a name="293955813"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234327%20Implement%20lowered-then-lifted%20func.../near/293955813" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234327.20Implement.20lowered-then-lifted.20func.2E.2E.2E.html#293955813">(Aug 17 2022 at 18:50)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/4327#issuecomment-1218375696">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4327">issue #4327</a>:</p>
<blockquote>
<p>Hm ok I am unable to reproduce this. I'm running:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">hyperfine</span><span class="w"> </span><span class="o">--</span><span class="n">warmup</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="s">"./before compile ./benches/instantiation/spidermonkey.wasm"</span><span class="w"> </span><span class="s">"./after compile ./benches/instantiation/spidermonkey.wasm"</span><span class="w"></span>
</code></pre></div>
<p>where that <code>spidermonkey.wasm</code> just happens to be some old copy I have locally. On an arm64 machine this reports "after" being faster by a fairly variable amount if I run the <code>hyperfine</code> command multiple times. On an x86_64 machine it's waffling between either "after" or "before" being faster.</p>
<p>The main change that this PR had  on core wasm is that core wasm trampolines are now compiled in parallel whereas they were compiled previously. Could that parallelism be affecting your measurements somehow perhaps? It may be that the parallelism here isn't a great idea for the short-lived task of compiling small trampolines.</p>
</blockquote>



<a name="293955943"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234327%20Implement%20lowered-then-lifted%20func.../near/293955943" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234327.20Implement.20lowered-then-lifted.20func.2E.2E.2E.html#293955943">(Aug 17 2022 at 18:51)</a>:</h4>
<p>alexcrichton edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4327#issuecomment-1218375696">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4327">issue #4327</a>:</p>
<blockquote>
<p>Hm ok I am unable to reproduce this. I'm running:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">hyperfine</span><span class="w"> </span><span class="o">--</span><span class="n">warmup</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="s">"./before compile ./benches/instantiation/spidermonkey.wasm"</span><span class="w"> </span><span class="s">"./after compile ./benches/instantiation/spidermonkey.wasm"</span><span class="w"></span>
</code></pre></div>
<p>where that <code>spidermonkey.wasm</code> just happens to be some old copy I have locally. On an arm64 machine this reports "after" being faster by a fairly variable amount if I run the <code>hyperfine</code> command multiple times. On an x86_64 machine it's waffling between either "after" or "before" being faster.</p>
<p>The main change that this PR had  on core wasm is that core wasm trampolines are now compiled in parallel whereas they were compiled serially previously. Could that parallelism be affecting your measurements somehow perhaps? It may be that the parallelism here isn't a great idea for the short-lived task of compiling small trampolines.</p>
</blockquote>



<a name="293957279"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234327%20Implement%20lowered-then-lifted%20func.../near/293957279" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234327.20Implement.20lowered-then-lifted.20func.2E.2E.2E.html#293957279">(Aug 17 2022 at 18:59)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4327#issuecomment-1218383586">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4327">issue #4327</a>:</p>
<blockquote>
<p>Weird -- here's what I see:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">[</span><span class="n">cfallin</span><span class="o">@</span><span class="n">xap</span><span class="p">]</span><span class="o">~/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">clean</span><span class="o">%</span><span class="w"> </span><span class="n">hyperfine</span><span class="w"> </span><span class="o">--</span><span class="n">warmup</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">'</span><span class="p">.</span><span class="o">/</span><span class="n">df15025</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">../</span><span class="n">wasm</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="sc">' '</span><span class="p">.</span><span class="o">/</span><span class="n">c1b3962</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">../</span><span class="n">wasm</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="o">'</span><span class="w"></span>
<span class="n">Benchmark</span><span class="w"> </span><span class="mi">1</span>: <span class="p">.</span><span class="o">/</span><span class="n">df15025</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">../</span><span class="n">wasm</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="w">  </span><span class="n">Time</span><span class="w"> </span><span class="p">(</span><span class="n">mean</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="err">σ</span><span class="p">)</span>:      <span class="mf">1.413</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">±</span><span class="w">  </span><span class="mf">0.050</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="p">[</span><span class="n">User</span>: <span class="mf">20.426</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">System</span>: <span class="mf">0.605</span><span class="w"> </span><span class="n">s</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="n">Range</span><span class="w"> </span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="err">…</span><span class="w"> </span><span class="n">max</span><span class="p">)</span>:    <span class="mf">1.349</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">…</span><span class="w">  </span><span class="mf">1.492</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="mi">10</span><span class="w"> </span><span class="n">runs</span><span class="w"></span>

<span class="n">Benchmark</span><span class="w"> </span><span class="mi">2</span>: <span class="p">.</span><span class="o">/</span><span class="n">c1b3962</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">../</span><span class="n">wasm</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="w">  </span><span class="n">Time</span><span class="w"> </span><span class="p">(</span><span class="n">mean</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="err">σ</span><span class="p">)</span>:      <span class="mf">1.649</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">±</span><span class="w">  </span><span class="mf">0.024</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="p">[</span><span class="n">User</span>: <span class="mf">20.312</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">System</span>: <span class="mf">0.579</span><span class="w"> </span><span class="n">s</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="n">Range</span><span class="w"> </span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="err">…</span><span class="w"> </span><span class="n">max</span><span class="p">)</span>:    <span class="mf">1.636</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">…</span><span class="w">  </span><span class="mf">1.715</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="mi">10</span><span class="w"> </span><span class="n">runs</span><span class="w"></span>

<span class="n">Summary</span><span class="w"></span>
<span class="w">  </span><span class="o">'</span><span class="p">.</span><span class="o">/</span><span class="n">df15025</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">../</span><span class="n">wasm</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="o">'</span><span class="w"> </span><span class="n">ran</span><span class="w"></span>
<span class="w">    </span><span class="mf">1.17</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">0.04</span><span class="w"> </span><span class="n">times</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="o">'</span><span class="p">.</span><span class="o">/</span><span class="n">c1b3962</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">../</span><span class="n">wasm</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="o">'</span><span class="w"></span>
</code></pre></div>
<p>Parameters: 12-core/24-thread system (Ryzen 3900X), frequency governor locked at 2.8GHz, Linux/x86-64, built with Rust 1.63.0, nothing else running on system (ssh into headless box).</p>
</blockquote>



<a name="293957764"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234327%20Implement%20lowered-then-lifted%20func.../near/293957764" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234327.20Implement.20lowered-then-lifted.20func.2E.2E.2E.html#293957764">(Aug 17 2022 at 19:02)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4327#issuecomment-1218385593">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4327">issue #4327</a>:</p>
<blockquote>
<p>Notably the user CPU time (sum of all threads' time) is ~about the same or a little better in "after" (c1b) than "before" (df1), so parallelism is perhaps the culprit here.</p>
</blockquote>



<a name="293970564"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234327%20Implement%20lowered-then-lifted%20func.../near/293970564" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234327.20Implement.20lowered-then-lifted.20func.2E.2E.2E.html#293970564">(Aug 17 2022 at 20:25)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4327#issuecomment-1218457621">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4327">issue #4327</a>:</p>
<blockquote>
<p>Doing some more experimentation on my system:</p>
<ul>
<li>with 12 cores (so, one SMT sibling on each core, removing the effects of SMT), a 26% regression:</li>
</ul>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">[</span><span class="n">cfallin</span><span class="o">@</span><span class="n">xap</span><span class="p">]</span><span class="o">~/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">clean</span><span class="o">%</span><span class="w"> </span><span class="n">hyperfine</span><span class="w"> </span><span class="o">--</span><span class="n">warmup</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">'</span><span class="na">taskset</span><span class="w"> </span><span class="mh">0xfff</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">df15025</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">../</span><span class="n">wasm</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="sc">' '</span><span class="n">taskset</span><span class="w"> </span><span class="mh">0xfff</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">c1b3962</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">../</span><span class="n">wasm</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="o">'</span><span class="w"></span>
<span class="n">Benchmark</span><span class="w"> </span><span class="mi">1</span>: <span class="nc">taskset</span><span class="w"> </span><span class="mh">0xfff</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">df15025</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">../</span><span class="n">wasm</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="w">  </span><span class="n">Time</span><span class="w"> </span><span class="p">(</span><span class="n">mean</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="err">σ</span><span class="p">)</span>:      <span class="mf">1.694</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">±</span><span class="w">  </span><span class="mf">0.012</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="p">[</span><span class="n">User</span>: <span class="mf">14.586</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">System</span>: <span class="mf">0.422</span><span class="w"> </span><span class="n">s</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="n">Range</span><span class="w"> </span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="err">…</span><span class="w"> </span><span class="n">max</span><span class="p">)</span>:    <span class="mf">1.679</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">…</span><span class="w">  </span><span class="mf">1.717</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="mi">10</span><span class="w"> </span><span class="n">runs</span><span class="w"></span>

<span class="n">Benchmark</span><span class="w"> </span><span class="mi">2</span>: <span class="nc">taskset</span><span class="w"> </span><span class="mh">0xfff</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">c1b3962</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">../</span><span class="n">wasm</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="w">  </span><span class="n">Time</span><span class="w"> </span><span class="p">(</span><span class="n">mean</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="err">σ</span><span class="p">)</span>:      <span class="mf">2.135</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">±</span><span class="w">  </span><span class="mf">0.020</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="p">[</span><span class="n">User</span>: <span class="mf">14.597</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">System</span>: <span class="mf">0.429</span><span class="w"> </span><span class="n">s</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="n">Range</span><span class="w"> </span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="err">…</span><span class="w"> </span><span class="n">max</span><span class="p">)</span>:    <span class="mf">2.109</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">…</span><span class="w">  </span><span class="mf">2.175</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="mi">10</span><span class="w"> </span><span class="n">runs</span><span class="w"></span>

<span class="n">Summary</span><span class="w"></span>
<span class="w">  </span><span class="o">'</span><span class="na">taskset</span><span class="w"> </span><span class="mh">0xfff</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">df15025</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">../</span><span class="n">wasm</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="o">'</span><span class="w"> </span><span class="n">ran</span><span class="w"></span>
<span class="w">    </span><span class="mf">1.26</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">0.01</span><span class="w"> </span><span class="n">times</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="o">'</span><span class="na">taskset</span><span class="w"> </span><span class="mh">0xfff</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">c1b3962</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">../</span><span class="n">wasm</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="o">'</span><span class="w"></span>
</code></pre></div>
<ul>
<li>with the first 6 cores (one of two chiplets, eliminating any interconnect or NUMA-related issues), a 31% regression:</li>
</ul>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">[</span><span class="n">cfallin</span><span class="o">@</span><span class="n">xap</span><span class="p">]</span><span class="o">~/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">clean</span><span class="o">%</span><span class="w"> </span><span class="n">hyperfine</span><span class="w"> </span><span class="o">--</span><span class="n">warmup</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">'</span><span class="na">taskset</span><span class="w"> </span><span class="mh">0x3f</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">df15025</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">../</span><span class="n">wasm</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="sc">' '</span><span class="n">taskset</span><span class="w"> </span><span class="mh">0x3f</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">c1b3962</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">../</span><span class="n">wasm</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="o">'</span><span class="w"></span>
<span class="n">Benchmark</span><span class="w"> </span><span class="mi">1</span>: <span class="nc">taskset</span><span class="w"> </span><span class="mh">0x3f</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">df15025</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">../</span><span class="n">wasm</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="w">  </span><span class="n">Time</span><span class="w"> </span><span class="p">(</span><span class="n">mean</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="err">σ</span><span class="p">)</span>:      <span class="mf">2.862</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">±</span><span class="w">  </span><span class="mf">0.018</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="p">[</span><span class="n">User</span>: <span class="mf">14.378</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">System</span>: <span class="mf">0.375</span><span class="w"> </span><span class="n">s</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="n">Range</span><span class="w"> </span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="err">…</span><span class="w"> </span><span class="n">max</span><span class="p">)</span>:    <span class="mf">2.841</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">…</span><span class="w">  </span><span class="mf">2.907</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="mi">10</span><span class="w"> </span><span class="n">runs</span><span class="w"></span>

<span class="n">Benchmark</span><span class="w"> </span><span class="mi">2</span>: <span class="nc">taskset</span><span class="w"> </span><span class="mh">0x3f</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">c1b3962</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">../</span><span class="n">wasm</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="w">  </span><span class="n">Time</span><span class="w"> </span><span class="p">(</span><span class="n">mean</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="err">σ</span><span class="p">)</span>:      <span class="mf">3.748</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">±</span><span class="w">  </span><span class="mf">0.018</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="p">[</span><span class="n">User</span>: <span class="mf">14.368</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">System</span>: <span class="mf">0.377</span><span class="w"> </span><span class="n">s</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="n">Range</span><span class="w"> </span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="err">…</span><span class="w"> </span><span class="n">max</span><span class="p">)</span>:    <span class="mf">3.736</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">…</span><span class="w">  </span><span class="mf">3.795</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="mi">10</span><span class="w"> </span><span class="n">runs</span><span class="w"></span>

<span class="n">Summary</span><span class="w"></span>
<span class="w">  </span><span class="o">'</span><span class="na">taskset</span><span class="w"> </span><span class="mh">0x3f</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">df15025</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">../</span><span class="n">wasm</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="o">'</span><span class="w"> </span><span class="n">ran</span><span class="w"></span>
<span class="w">    </span><span class="mf">1.31</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">0.01</span><span class="w"> </span><span class="n">times</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="o">'</span><span class="na">taskset</span><span class="w"> </span><span class="mh">0x3f</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">c1b3962</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">../</span><span class="n">wasm</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="o">'</span><span class="w"></span>
</code></pre></div>
<p>@alexcrichton , would you be OK with reverting the parallel compilation of trampolines that this PR introduced? Even if this regression appears only on some systems or in some parallelism scenarios, I think these numbers are too big to ignore and while from first principles the parallel-iter runtime <em>should</em> do the right thing, it seems to be falling flat here...</p>
</blockquote>



<a name="293979557"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234327%20Implement%20lowered-then-lifted%20func.../near/293979557" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234327.20Implement.20lowered-then-lifted.20func.2E.2E.2E.html#293979557">(Aug 17 2022 at 21:33)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/4327#issuecomment-1218511133">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4327">issue #4327</a>:</p>
<blockquote>
<p>Personally something is weird enough here that I don't think it warrants reverting this and sweeping it under the rug. I initially struggled to reproduce on an arm64 and x86_64 system so I don't think that this is a systemic issue. Testing just on the x86_64 machine I have I tried variations of <code>RAYON_NUM_THREADS=N</code> and 1,2,4,5,8,16 showed no perf difference in the before/after. Surprinsingly though 3,6,7 all showed 20%+ regressions. Given it seems like some CPU configurations are probably not great at the parallelism, but this seems like a deeper issue with our parallel strategy in general rather than specific to just the trampolines which happened to change here.</p>
</blockquote>



<a name="293979678"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234327%20Implement%20lowered-then-lifted%20func.../near/293979678" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234327.20Implement.20lowered-then-lifted.20func.2E.2E.2E.html#293979678">(Aug 17 2022 at 21:34)</a>:</h4>
<p>alexcrichton edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4327#issuecomment-1218511133">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4327">issue #4327</a>:</p>
<blockquote>
<p>Personally something is weird enough here that I don't think it warrants reverting this and sweeping it under the rug. I initially struggled to reproduce on an arm64 and x86_64 system so I don't think that this is a systemic issue. Testing just on the x86_64 machine I have I tried variations of <code>RAYON_NUM_THREADS=N</code> and 1,2,4,5,8,16 showed no perf difference in the before/after. Surprinsingly though 3,6,7 all showed 20%+ regressions. It seems like some CPU configurations are probably not great at the parallelism, but this seems like a deeper issue with our parallel strategy in general rather than specific to just the trampolines which happened to change here.</p>
</blockquote>



<a name="293981807"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234327%20Implement%20lowered-then-lifted%20func.../near/293981807" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234327.20Implement.20lowered-then-lifted.20func.2E.2E.2E.html#293981807">(Aug 17 2022 at 21:53)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/4327#issuecomment-1218524727">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4327">issue #4327</a>:</p>
<blockquote>
<p>The problem here seems to stem from <code>rayon::join</code>. If I move out compilation of the trampolines entirely from the <code>rayon::join</code> and compile all trampolines serially I still observe the slowdown locally at 6 threads. This is where one closure to <code>rayon::join</code> does a parallel compilation of all of a module's functions, and the other closure does nothing. Seems like we may need to avoid <code>rayon::join</code>, but I'll try to dig a bit more.</p>
</blockquote>



<a name="293982762"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234327%20Implement%20lowered-then-lifted%20func.../near/293982762" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234327.20Implement.20lowered-then-lifted.20func.2E.2E.2E.html#293982762">(Aug 17 2022 at 22:01)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/4327#issuecomment-1218534160">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4327">issue #4327</a>:</p>
<blockquote>
<p>I can confirm that this diff:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/crates/wasmtime/src/module.rs b/crates/wasmtime/src/module.rs</span><span class="w"></span>
<span class="gh">index 5524ebb73..1494bed18 100644</span><span class="w"></span>
<span class="gd">--- a/crates/wasmtime/src/module.rs</span><span class="w"></span>
<span class="gi">+++ b/crates/wasmtime/src/module.rs</span><span class="w"></span>
<span class="gu">@@ -372,8 +372,9 @@ impl Module {</span><span class="w"></span>
<span class="w"> </span>        let tunables = &amp;engine.config().tunables;<span class="w"></span>
<span class="w"> </span>        let functions = mem::take(&amp;mut translation.function_body_inputs);<span class="w"></span>
<span class="w"> </span>        let functions = functions.into_iter().collect::&lt;Vec&lt;_&gt;&gt;();<span class="w"></span>
<span class="gd">-        let funcs = engine</span><span class="w"></span>
<span class="gd">-            .run_maybe_parallel(functions, |(index, func)| {</span><span class="w"></span>
<span class="gi">+        let mut funcs = None;</span><span class="w"></span>
<span class="gi">+        rayon::scope(|_| {</span><span class="w"></span>
<span class="gi">+            funcs = Some(engine.run_maybe_parallel(functions, |(index, func)| {</span><span class="w"></span>
<span class="w"> </span>                let offset = func.body.range().start;<span class="w"></span>
<span class="w"> </span>                engine<span class="w"></span>
<span class="w"> </span>                    .compiler()<span class="w"></span>
<span class="gu">@@ -389,9 +390,9 @@ impl Module {</span><span class="w"></span>
<span class="w"> </span>                            "failed to compile wasm function {index}{name} at offset {offset:#x}"<span class="w"></span>
<span class="w"> </span>                        )<span class="w"></span>
<span class="w"> </span>                    })<span class="w"></span>
<span class="gd">-            })?</span><span class="w"></span>
<span class="gd">-            .into_iter()</span><span class="w"></span>
<span class="gd">-            .collect();</span><span class="w"></span>
<span class="gi">+            }));</span><span class="w"></span>
<span class="gi">+        });</span><span class="w"></span>
<span class="gi">+        let funcs = funcs.unwrap()?.into_iter().collect();</span><span class="w"></span>

<span class="w"> </span>        // Collect all the function results into a final ELF object.<span class="w"></span>
<span class="w"> </span>        let mut obj = engine.compiler().object()?;<span class="w"></span>
</code></pre></div>
<p>on df1502531d437b2105effb990a7caa28796aa985 produces the slowdown I'm seeing. Unsure what's happening within rayon...</p>
</blockquote>



<a name="293991318"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234327%20Implement%20lowered-then-lifted%20func.../near/293991318" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234327.20Implement.20lowered-then-lifted.20func.2E.2E.2E.html#293991318">(Aug 17 2022 at 22:51)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/4327#issuecomment-1218568670">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4327">issue #4327</a>:</p>
<blockquote>
<p>I don't really know what's going on here. I dug into the actual compile time of <code>SLOW=1</code> vs not with the above patch. Summing the time spent compiling each individual function shows a 2.34% difference in time which doesn't account for the 20% wall time seen for the entire command. My best guess is that something is tickling rayon in just the wrong fashion here, although I have no idea what.</p>
</blockquote>



<a name="293994396"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234327%20Implement%20lowered-then-lifted%20func.../near/293994396" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234327.20Implement.20lowered-then-lifted.20func.2E.2E.2E.html#293994396">(Aug 17 2022 at 23:28)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4327#issuecomment-1218645961">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4327">issue #4327</a>:</p>
<blockquote>
<p>Wow, this is wild: sure enough, when run with <code>RAYON_NUM_THREADS=8</code> on my system, the regression disappears (+/- 1% delta, within noise).</p>
<p>I agree this seems like a Rayon bug of some sort -- a dependence on there being a power-of-two number of worker threads (some sort of work-distribution imbalance maybe?).</p>
<p>As a very short-term solution I will benchmark with this environment variable set; but I will file a bug upstream and see what folks think.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>