<html>
<head><meta charset="utf-8"><title>wasmtime / PR #9554 winch: Sync registers and locals befo... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239554.20winch.3A.20Sync.20registers.20and.20locals.20befo.2E.2E.2E.html">wasmtime / PR #9554 winch: Sync registers and locals befo...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="480729108"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239554%20winch%3A%20Sync%20registers%20and%20locals%20befo.../near/480729108" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239554.20winch.3A.20Sync.20registers.20and.20locals.20befo.2E.2E.2E.html#480729108">(Nov 05 2024 at 14:07)</a>:</h4>
<p>saulecabrera opened <a href="https://github.com/bytecodealliance/wasmtime/pull/9554">PR #9554</a> from <code>saulecabrera:winch-unaligned-stack-fuel</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This commit fixes a fuzz bug in which the stack was misaligned when calling the out-of-fuel builtin function.</p>
<p>The misalignment was introduced by a erroneous handling of the the control flow merge introduced by the fuel check conditional. In general, prior to every branch emission, a spill to memory is needed to avoid issues at the control flow merge.</p>
<p>Note that we don't have many cases like this one in Winch's codebase (3 in total), however as a follow-up, it's probably worth considering introducing a stronger abstraction around branching to ensure that this case is handled whenever an arbitrary branch needs to be introduced. This change solely focuses on the fix and does not introduce any refactoring. I plan to follow-up with investigating a better branching strategy, since we would need to introduce a similar pattern for epoch handling.</p>
<p>I used <code>wasm-tools shink</code> to shrink the original program, which I decided to add as part of an integration test.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="480729111"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239554%20winch%3A%20Sync%20registers%20and%20locals%20befo.../near/480729111" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239554.20winch.3A.20Sync.20registers.20and.20locals.20befo.2E.2E.2E.html#480729111">(Nov 05 2024 at 14:07)</a>:</h4>
<p><strong>saulecabrera</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9554">PR #9554</a>.</p>



<a name="480729112"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239554%20winch%3A%20Sync%20registers%20and%20locals%20befo.../near/480729112" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239554.20winch.3A.20Sync.20registers.20and.20locals.20befo.2E.2E.2E.html#480729112">(Nov 05 2024 at 14:07)</a>:</h4>
<p><strong>saulecabrera</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9554">PR #9554</a>.</p>



<a name="480729119"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239554%20winch%3A%20Sync%20registers%20and%20locals%20befo.../near/480729119" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239554.20winch.3A.20Sync.20registers.20and.20locals.20befo.2E.2E.2E.html#480729119">(Nov 05 2024 at 14:07)</a>:</h4>
<p><strong>saulecabrera</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9554">PR #9554</a>.</p>



<a name="480729121"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239554%20winch%3A%20Sync%20registers%20and%20locals%20befo.../near/480729121" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239554.20winch.3A.20Sync.20registers.20and.20locals.20befo.2E.2E.2E.html#480729121">(Nov 05 2024 at 14:07)</a>:</h4>
<p><strong>saulecabrera</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9554">PR #9554</a>.</p>



<a name="480730092"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239554%20winch%3A%20Sync%20registers%20and%20locals%20befo.../near/480730092" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239554.20winch.3A.20Sync.20registers.20and.20locals.20befo.2E.2E.2E.html#480730092">(Nov 05 2024 at 14:12)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/9554#discussion_r1829424492">PR review comment</a>:</p>
<blockquote>
<p>@alexcrichton I'm not sure if you have thoughts on introducing test fixtures like this as I didn't see this pattern used for the rest of the integration tests. I tried to shrink the original program using <code>wasm-tools shrink</code> and it was able to shrink it by 30%, if you think the test programs should be as small as possible I can definitely spend a bit more time trying to reduce it further. </p>
</blockquote>



<a name="480730095"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239554%20winch%3A%20Sync%20registers%20and%20locals%20befo.../near/480730095" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239554.20winch.3A.20Sync.20registers.20and.20locals.20befo.2E.2E.2E.html#480730095">(Nov 05 2024 at 14:12)</a>:</h4>
<p>saulecabrera submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9554#pullrequestreview-2415747892">PR review</a>.</p>



<a name="480746943"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239554%20winch%3A%20Sync%20registers%20and%20locals%20befo.../near/480746943" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239554.20winch.3A.20Sync.20registers.20and.20locals.20befo.2E.2E.2E.html#480746943">(Nov 05 2024 at 15:28)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9554#pullrequestreview-2415968587">PR review</a>.</p>



<a name="480746944"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239554%20winch%3A%20Sync%20registers%20and%20locals%20befo.../near/480746944" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239554.20winch.3A.20Sync.20registers.20and.20locals.20befo.2E.2E.2E.html#480746944">(Nov 05 2024 at 15:28)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9554#discussion_r1829558506">PR review comment</a>:</p>
<blockquote>
<p>Nah I think this is fine, maybe put it in <code>tests/misc_testsuite/*.wat</code> though and include! it from there?</p>
</blockquote>



<a name="480772101"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239554%20winch%3A%20Sync%20registers%20and%20locals%20befo.../near/480772101" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239554.20winch.3A.20Sync.20registers.20and.20locals.20befo.2E.2E.2E.html#480772101">(Nov 05 2024 at 17:44)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/9554#issuecomment-2457808093">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9554">PR #9554</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @saulecabrera</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "winch"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>saulecabrera: winch</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="480772688"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239554%20winch%3A%20Sync%20registers%20and%20locals%20befo.../near/480772688" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239554.20winch.3A.20Sync.20registers.20and.20locals.20befo.2E.2E.2E.html#480772688">(Nov 05 2024 at 17:48)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9554">PR #9554</a>.</p>



<a name="480777040"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239554%20winch%3A%20Sync%20registers%20and%20locals%20befo.../near/480777040" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239554.20winch.3A.20Sync.20registers.20and.20locals.20befo.2E.2E.2E.html#480777040">(Nov 05 2024 at 18:18)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/9554#issuecomment-2457868465">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9554">PR #9554</a>:</p>
<blockquote>
<p>@saulecabrera would you be ok backporting this to the release-27 branch? If you're busy I'm happy to take that on myself</p>
</blockquote>



<a name="480777291"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239554%20winch%3A%20Sync%20registers%20and%20locals%20befo.../near/480777291" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239554.20winch.3A.20Sync.20registers.20and.20locals.20befo.2E.2E.2E.html#480777291">(Nov 05 2024 at 18:19)</a>:</h4>
<p>saulecabrera merged <a href="https://github.com/bytecodealliance/wasmtime/pull/9554">PR #9554</a>.</p>



<a name="480779875"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239554%20winch%3A%20Sync%20registers%20and%20locals%20befo.../near/480779875" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239554.20winch.3A.20Sync.20registers.20and.20locals.20befo.2E.2E.2E.html#480779875">(Nov 05 2024 at 18:39)</a>:</h4>
<p>saulecabrera <a href="https://github.com/bytecodealliance/wasmtime/pull/9554#issuecomment-2457904728">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9554">PR #9554</a>:</p>
<blockquote>
<p>@alexcrichton I've opened <a href="https://github.com/bytecodealliance/wasmtime/pull/9564">https://github.com/bytecodealliance/wasmtime/pull/9564</a>. Just to confirm, since 27 is not released yet, there's nothing to follow-up on after the backport lands, right?</p>
</blockquote>



<a name="480780297"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239554%20winch%3A%20Sync%20registers%20and%20locals%20befo.../near/480780297" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239554.20winch.3A.20Sync.20registers.20and.20locals.20befo.2E.2E.2E.html#480780297">(Nov 05 2024 at 18:41)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/9554#issuecomment-2457909952">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9554">PR #9554</a>:</p>
<blockquote>
<p>Indeed, and thanks!</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>