<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #2860 Cranelift: Panic compiling iadd_ca... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232860.20Cranelift.3A.20Panic.20compiling.20iadd_ca.2E.2E.2E.html">wasmtime / Issue #2860 Cranelift: Panic compiling iadd_ca...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="236274010"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232860%20Cranelift%3A%20Panic%20compiling%20iadd_ca.../near/236274010" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232860.20Cranelift.3A.20Panic.20compiling.20iadd_ca.2E.2E.2E.html#236274010">(Apr 27 2021 at 02:19)</a>:</h4>
<p>Hypersonic opened <a href="https://github.com/bytecodealliance/wasmtime/issues/2860">Issue #2860</a>:</p>
<blockquote>
<p>Hi! While using Cranelift as a backend for a project, I ran into a panic compiling iadd_carry instructions on x86_64. Please let me know if there is any other information I can provide that would be helpful.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="p">()</span><span class="w"> </span><span class="n">fast</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span>:
    <span class="nc">v1465</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v1467</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bconst</span><span class="p">.</span><span class="n">b1</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="w">    </span><span class="n">v1468</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v1469</span><span class="p">,</span><span class="w"> </span><span class="n">v1470</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd_carry</span><span class="w"> </span><span class="n">v1465</span><span class="p">,</span><span class="w"> </span><span class="n">v1468</span><span class="p">,</span><span class="w"> </span><span class="n">v1467</span><span class="w"></span>
<span class="w">    </span><span class="n">v1476</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bint</span><span class="p">.</span><span class="kt">i8</span><span class="w"> </span><span class="n">v1470</span><span class="w"></span>
<span class="w">    </span><span class="n">v1356</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v1391</span><span class="w"> </span>-&gt; <span class="nc">v1356</span><span class="w"></span>
<span class="w">    </span><span class="n">v1423</span><span class="w"> </span>-&gt; <span class="nc">v1356</span><span class="w"></span>
<span class="w">    </span><span class="n">v1447</span><span class="w"> </span>-&gt; <span class="nc">v1356</span><span class="w"></span>
<span class="w">    </span><span class="n">v1464</span><span class="w"> </span>-&gt; <span class="nc">v1356</span><span class="w"></span>
<span class="w">    </span><span class="n">v1494</span><span class="w"> </span>-&gt; <span class="nc">v1356</span><span class="w"></span>
<span class="w">    </span><span class="n">v1516</span><span class="w"> </span>-&gt; <span class="nc">v1356</span><span class="w"></span>
<span class="w">    </span><span class="n">v1544</span><span class="w"> </span>-&gt; <span class="nc">v1356</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v1476</span><span class="p">,</span><span class="w"> </span><span class="n">v1356</span><span class="o">+</span><span class="mi">274</span><span class="w"></span>
<span class="w">    </span><span class="n">trap</span><span class="w"> </span><span class="n">user0</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p><code>cargo run -p cranelift-tools -- compile test.clif --target x86_64</code></p>
<h3>Expected Results</h3>
<p>Code successfully generates without a panic.</p>
<h3>Actual Results</h3>
<p>Panic: <code>thread 'main' panicked at 'ALU+imm and ALU+carry ops should not appear here!', cranelift/codegen/src/isa/x64/lower.rs:5740:13</code></p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: main HEAD (4a830b at time of writing)</p>
<p>Operating system: Linux</p>
<p>Architecture: x86_64</p>
</blockquote>



<a name="236274011"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232860%20Cranelift%3A%20Panic%20compiling%20iadd_ca.../near/236274011" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232860.20Cranelift.3A.20Panic.20compiling.20iadd_ca.2E.2E.2E.html#236274011">(Apr 27 2021 at 02:19)</a>:</h4>
<p>Hypersonic labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/2860">Issue #2860</a>:</p>
<blockquote>
<p>Hi! While using Cranelift as a backend for a project, I ran into a panic compiling iadd_carry instructions on x86_64. Please let me know if there is any other information I can provide that would be helpful.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="p">()</span><span class="w"> </span><span class="n">fast</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span>:
    <span class="nc">v1465</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v1467</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bconst</span><span class="p">.</span><span class="n">b1</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="w">    </span><span class="n">v1468</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v1469</span><span class="p">,</span><span class="w"> </span><span class="n">v1470</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd_carry</span><span class="w"> </span><span class="n">v1465</span><span class="p">,</span><span class="w"> </span><span class="n">v1468</span><span class="p">,</span><span class="w"> </span><span class="n">v1467</span><span class="w"></span>
<span class="w">    </span><span class="n">v1476</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bint</span><span class="p">.</span><span class="kt">i8</span><span class="w"> </span><span class="n">v1470</span><span class="w"></span>
<span class="w">    </span><span class="n">v1356</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v1391</span><span class="w"> </span>-&gt; <span class="nc">v1356</span><span class="w"></span>
<span class="w">    </span><span class="n">v1423</span><span class="w"> </span>-&gt; <span class="nc">v1356</span><span class="w"></span>
<span class="w">    </span><span class="n">v1447</span><span class="w"> </span>-&gt; <span class="nc">v1356</span><span class="w"></span>
<span class="w">    </span><span class="n">v1464</span><span class="w"> </span>-&gt; <span class="nc">v1356</span><span class="w"></span>
<span class="w">    </span><span class="n">v1494</span><span class="w"> </span>-&gt; <span class="nc">v1356</span><span class="w"></span>
<span class="w">    </span><span class="n">v1516</span><span class="w"> </span>-&gt; <span class="nc">v1356</span><span class="w"></span>
<span class="w">    </span><span class="n">v1544</span><span class="w"> </span>-&gt; <span class="nc">v1356</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v1476</span><span class="p">,</span><span class="w"> </span><span class="n">v1356</span><span class="o">+</span><span class="mi">274</span><span class="w"></span>
<span class="w">    </span><span class="n">trap</span><span class="w"> </span><span class="n">user0</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p><code>cargo run -p cranelift-tools -- compile test.clif --target x86_64</code></p>
<h3>Expected Results</h3>
<p>Code successfully generates without a panic.</p>
<h3>Actual Results</h3>
<p>Panic: <code>thread 'main' panicked at 'ALU+imm and ALU+carry ops should not appear here!', cranelift/codegen/src/isa/x64/lower.rs:5740:13</code></p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: main HEAD (4a830b at time of writing)</p>
<p>Operating system: Linux</p>
<p>Architecture: x86_64</p>
</blockquote>



<a name="236274012"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232860%20Cranelift%3A%20Panic%20compiling%20iadd_ca.../near/236274012" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232860.20Cranelift.3A.20Panic.20compiling.20iadd_ca.2E.2E.2E.html#236274012">(Apr 27 2021 at 02:19)</a>:</h4>
<p>Hypersonic labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/2860">Issue #2860</a>:</p>
<blockquote>
<p>Hi! While using Cranelift as a backend for a project, I ran into a panic compiling iadd_carry instructions on x86_64. Please let me know if there is any other information I can provide that would be helpful.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="p">()</span><span class="w"> </span><span class="n">fast</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span>:
    <span class="nc">v1465</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v1467</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bconst</span><span class="p">.</span><span class="n">b1</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="w">    </span><span class="n">v1468</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v1469</span><span class="p">,</span><span class="w"> </span><span class="n">v1470</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd_carry</span><span class="w"> </span><span class="n">v1465</span><span class="p">,</span><span class="w"> </span><span class="n">v1468</span><span class="p">,</span><span class="w"> </span><span class="n">v1467</span><span class="w"></span>
<span class="w">    </span><span class="n">v1476</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bint</span><span class="p">.</span><span class="kt">i8</span><span class="w"> </span><span class="n">v1470</span><span class="w"></span>
<span class="w">    </span><span class="n">v1356</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v1391</span><span class="w"> </span>-&gt; <span class="nc">v1356</span><span class="w"></span>
<span class="w">    </span><span class="n">v1423</span><span class="w"> </span>-&gt; <span class="nc">v1356</span><span class="w"></span>
<span class="w">    </span><span class="n">v1447</span><span class="w"> </span>-&gt; <span class="nc">v1356</span><span class="w"></span>
<span class="w">    </span><span class="n">v1464</span><span class="w"> </span>-&gt; <span class="nc">v1356</span><span class="w"></span>
<span class="w">    </span><span class="n">v1494</span><span class="w"> </span>-&gt; <span class="nc">v1356</span><span class="w"></span>
<span class="w">    </span><span class="n">v1516</span><span class="w"> </span>-&gt; <span class="nc">v1356</span><span class="w"></span>
<span class="w">    </span><span class="n">v1544</span><span class="w"> </span>-&gt; <span class="nc">v1356</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v1476</span><span class="p">,</span><span class="w"> </span><span class="n">v1356</span><span class="o">+</span><span class="mi">274</span><span class="w"></span>
<span class="w">    </span><span class="n">trap</span><span class="w"> </span><span class="n">user0</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p><code>cargo run -p cranelift-tools -- compile test.clif --target x86_64</code></p>
<h3>Expected Results</h3>
<p>Code successfully generates without a panic.</p>
<h3>Actual Results</h3>
<p>Panic: <code>thread 'main' panicked at 'ALU+imm and ALU+carry ops should not appear here!', cranelift/codegen/src/isa/x64/lower.rs:5740:13</code></p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: main HEAD (4a830b at time of writing)</p>
<p>Operating system: Linux</p>
<p>Architecture: x86_64</p>
</blockquote>



<a name="236279082"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232860%20Cranelift%3A%20Panic%20compiling%20iadd_ca.../near/236279082" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232860.20Cranelift.3A.20Panic.20compiling.20iadd_ca.2E.2E.2E.html#236279082">(Apr 27 2021 at 03:41)</a>:</h4>
<p>iximeow <a href="https://github.com/bytecodealliance/wasmtime/issues/2860#issuecomment-827290551">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2860">Issue #2860</a>:</p>
<blockquote>
<p>using this as an excuse to (finally) familiarize myself with the MachInst backend, i'm not sure why <code>ALU+imm and ALU+carry ops should not appear here</code> should be the case - it looks like <a href="https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/codegen/src/isa/x64/lower.rs#L5740">x64/lower.rs</a> is _the_ place for lowering to happen in x64, eschewing <code>codegen/meta</code>'s lowering?</p>
<p>and if that's so, i'd expect <code>rustc_cranelift_codegen</code> to have hit this, but <a href="https://github.com/bjorn3/rustc_codegen_cranelift/blob/master/src/num.rs#L212-L214">maybe not</a>, since this is the only carry-shaped instruction i see over there.</p>
</blockquote>



<a name="236375389"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232860%20Cranelift%3A%20Panic%20compiling%20iadd_ca.../near/236375389" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232860.20Cranelift.3A.20Panic.20compiling.20iadd_ca.2E.2E.2E.html#236375389">(Apr 27 2021 at 17:15)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/2860#issuecomment-827773136">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2860">Issue #2860</a>:</p>
<blockquote>
<p>Greetings @Hypersonic and thanks for the report!</p>
<p>The plan we made when starting to design the new backend was to phase out add+carry (and sub+borrow) opcodes in the CLIF, instead directly providing the wider adds/subs that one would normally lower into carry-using ops. In the legalization-based old backend, <code>i128.add</code> became an <code>i64.add</code> and an <code>i64.add_carry</code>; now we just open-code the two-add sequence. (This was in discussions between myself, @julian-seward1 and @bnjbvr back in Jan 2020 or so.)</p>
<p>The reason for this design choice was that representing carry flags as normal values is fragile performance-wise: to get the correct (fast) machine code, which implicitly passes the bool in the carry flag, one has to pattern-match on the two instructions. The case where the <code>b1</code> is separate -- as in your example, coming from a constant -- has to be lowered separately with <code>pushf</code> or <code>setc</code> to extract the flag and <code>popf</code> or a conditional diamond with <code>clc</code>/<code>stc</code>. The latter codepaths would almost never be used and so are a correctness risk as well; and these instructions are slow, to the point that there should (hopefully!) almost always be a better way to solve the problem.</p>
<p>Given that we just recently switched the default backend and haven't started the work of removing the old one, we haven't yet cleaned up the opcode space, but we intend to do so eventually.</p>
<p>That does leave the question: what if one actually wants to generate an add-with-carry? I'm definitely open to understanding use-cases better. Are you hoping to take an arbitrary <code>b1</code> and feed it into the add? Or is this part of a lowering of some other wider arithmetic operation? If the latter, is there any other instruction that would help?</p>
</blockquote>



<a name="236375565"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232860%20Cranelift%3A%20Panic%20compiling%20iadd_ca.../near/236375565" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232860.20Cranelift.3A.20Panic.20compiling.20iadd_ca.2E.2E.2E.html#236375565">(Apr 27 2021 at 17:16)</a>:</h4>
<p>cfallin edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/2860#issuecomment-827773136">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2860">Issue #2860</a>:</p>
<blockquote>
<p>Greetings @Hypersonic and thanks for the report!</p>
<p>The plan we made when starting to design the new backend was to phase out add+carry (and sub+borrow) opcodes in the CLIF, instead directly providing the wider adds/subs that one would normally lower into carry-using ops. In the legalization-based old backend, <code>i128.add</code> became an <code>i64.add</code> and an <code>i64.add_carry</code>; now we just open-code the two-add sequence. (This was in discussions between myself, @julian-seward1 and @bnjbvr back in Jan 2020 or so.)</p>
<p>The reason for this design choice was that representing carry flags as normal values is fragile performance-wise: to get the correct (fast) machine code, which implicitly passes the bool in the carry flag, one has to pattern-match on the two instructions. The case where the <code>b1</code> is separate -- as in your example, coming from a constant -- has to be lowered separately with <code>pushf</code> or <code>setc</code> to extract the flag and <code>popf</code> or a conditional diamond with <code>clc</code>/<code>stc</code> to set it. The latter codepaths would almost never be used and so are a correctness risk as well; and these instructions are slow, to the point that there should (hopefully!) almost always be a better way to solve the problem.</p>
<p>Given that we just recently switched the default backend and haven't started the work of removing the old one, we haven't yet cleaned up the opcode space, but we intend to do so eventually.</p>
<p>That does leave the question: what if one actually wants to generate an add-with-carry? I'm definitely open to understanding use-cases better. Are you hoping to take an arbitrary <code>b1</code> and feed it into the add? Or is this part of a lowering of some other wider arithmetic operation? If the latter, is there any other instruction that would help?</p>
</blockquote>



<a name="236375584"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232860%20Cranelift%3A%20Panic%20compiling%20iadd_ca.../near/236375584" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232860.20Cranelift.3A.20Panic.20compiling.20iadd_ca.2E.2E.2E.html#236375584">(Apr 27 2021 at 17:16)</a>:</h4>
<p>cfallin edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/2860#issuecomment-827773136">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2860">Issue #2860</a>:</p>
<blockquote>
<p>Greetings @Hypersonic and thanks for the report!</p>
<p>The plan we made when starting to design the new backend was to phase out add+carry (and sub+borrow) opcodes in the CLIF, instead directly providing the wider adds/subs that one would normally lower into carry-using ops. In the legalization-based old backend, <code>i128.add</code> became an <code>i64.add</code> and an <code>i64.add_carry</code>; now we just open-code the two-add sequence. (This was in discussions between myself, @julian-seward1 and @bnjbvr back in Jan 2020 or so.)</p>
<p>The reason for this design choice was that representing carry flags as normal values is fragile performance-wise: to get the correct (fast) machine code, which implicitly passes the bool in the carry flag, one has to pattern-match on the two instructions. The case where the <code>b1</code> is separate -- as in your example, coming from a constant -- has to be lowered separately with <code>pushf</code> or <code>setc</code> to extract the flag and <code>popf</code> or a conditional diamond with <code>clc</code>/<code>stc</code> to set it. The materialized-carry-flag-value codepaths would almost never be used and so are a correctness risk as well; and these instructions are slow, to the point that there should (hopefully!) almost always be a better way to solve the problem.</p>
<p>Given that we just recently switched the default backend and haven't started the work of removing the old one, we haven't yet cleaned up the opcode space, but we intend to do so eventually.</p>
<p>That does leave the question: what if one actually wants to generate an add-with-carry? I'm definitely open to understanding use-cases better. Are you hoping to take an arbitrary <code>b1</code> and feed it into the add? Or is this part of a lowering of some other wider arithmetic operation? If the latter, is there any other instruction that would help?</p>
</blockquote>



<a name="236376273"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232860%20Cranelift%3A%20Panic%20compiling%20iadd_ca.../near/236376273" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232860.20Cranelift.3A.20Panic.20compiling.20iadd_ca.2E.2E.2E.html#236376273">(Apr 27 2021 at 17:21)</a>:</h4>
<p>cfallin edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/2860#issuecomment-827773136">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2860">Issue #2860</a>:</p>
<blockquote>
<p>Greetings @Hypersonic and thanks for the report!</p>
<p>The plan we made when starting to design the new backend was to phase out add+carry (and sub+borrow) opcodes in the CLIF, instead directly providing the wider adds/subs that one would normally lower into carry-using ops. In the legalization-based old backend, <code>i128.add</code> became an <code>i64.add_ifcout</code> and an <code>i64.add_carry</code>; now we just open-code the two-add sequence. (This was in discussions between myself, @julian-seward1 and @bnjbvr back in Jan 2020 or so.)</p>
<p>The reason for this design choice was that representing carry flags as normal values is fragile performance-wise: to get the correct (fast) machine code, which implicitly passes the bool in the carry flag, one has to pattern-match on the two instructions. The case where the <code>b1</code> is separate -- as in your example, coming from a constant -- has to be lowered separately with <code>pushf</code> or <code>setc</code> to extract the flag and <code>popf</code> or a conditional diamond with <code>clc</code>/<code>stc</code> to set it. The materialized-carry-flag-value codepaths would almost never be used and so are a correctness risk as well; and these instructions are slow, to the point that there should (hopefully!) almost always be a better way to solve the problem.</p>
<p>Given that we just recently switched the default backend and haven't started the work of removing the old one, we haven't yet cleaned up the opcode space, but we intend to do so eventually.</p>
<p>That does leave the question: what if one actually wants to generate an add-with-carry? I'm definitely open to understanding use-cases better. Are you hoping to take an arbitrary <code>b1</code> and feed it into the add? Or is this part of a lowering of some other wider arithmetic operation? If the latter, is there any other instruction that would help?</p>
</blockquote>



<a name="236376963"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232860%20Cranelift%3A%20Panic%20compiling%20iadd_ca.../near/236376963" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232860.20Cranelift.3A.20Panic.20compiling.20iadd_ca.2E.2E.2E.html#236376963">(Apr 27 2021 at 17:26)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/2860#issuecomment-827780245">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2860">Issue #2860</a>:</p>
<blockquote>
<p>One use it to check for overflow. In cg_clif I currently have to manually check if an overflow has happened even though at least on x86 the processor already provides this information in the form of a flag.</p>
</blockquote>



<a name="236377021"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232860%20Cranelift%3A%20Panic%20compiling%20iadd_ca.../near/236377021" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232860.20Cranelift.3A.20Panic.20compiling.20iadd_ca.2E.2E.2E.html#236377021">(Apr 27 2021 at 17:27)</a>:</h4>
<p>bjorn3 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/2860#issuecomment-827780245">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2860">Issue #2860</a>:</p>
<blockquote>
<p>One use it to check for overflow to crash. In cg_clif I currently have to manually check if an overflow has happened even though at least on x86 the processor already provides this information in the form of a flag.</p>
</blockquote>



<a name="236378291"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232860%20Cranelift%3A%20Panic%20compiling%20iadd_ca.../near/236378291" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232860.20Cranelift.3A.20Panic.20compiling.20iadd_ca.2E.2E.2E.html#236378291">(Apr 27 2021 at 17:36)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/2860#issuecomment-827786871">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2860">Issue #2860</a>:</p>
<blockquote>
<p>@bjorn3 there is the <code>iadd_ifcout</code> instruction which is supported on the new backends (because stack-limit checks use it too IIRC) -- that should be usable to detect overflows? If not, we can add a variant that works for your case. Getting the flag out is easier (<code>SETcc</code>); it's the reloading into carry and use by subsequent operation, or pattern-matching to avoid that, that's slow/fragile.</p>
</blockquote>



<a name="236382902"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232860%20Cranelift%3A%20Panic%20compiling%20iadd_ca.../near/236382902" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232860.20Cranelift.3A.20Panic.20compiling.20iadd_ca.2E.2E.2E.html#236382902">(Apr 27 2021 at 18:07)</a>:</h4>
<p>Hypersonic <a href="https://github.com/bytecodealliance/wasmtime/issues/2860#issuecomment-827806744">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2860">Issue #2860</a>:</p>
<blockquote>
<p>My main use case is detecting the carry-out -- I don't really have any particular need for the carry-in, but this was the instruction I found that would give me the output I needed. If there's a different instruction that can give me that, I'm more than happy to use it.</p>
</blockquote>



<a name="236392594"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232860%20Cranelift%3A%20Panic%20compiling%20iadd_ca.../near/236392594" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232860.20Cranelift.3A.20Panic.20compiling.20iadd_ca.2E.2E.2E.html#236392594">(Apr 27 2021 at 19:12)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/2860#issuecomment-827851579">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2860">Issue #2860</a>:</p>
<blockquote>
<p>@Hypersonic the <code>iadd_ifcout</code> instruction should give you just that, then, but if your case needs anything other then a trap, we'd need to add pattern-matching for e.g. <code>selectif</code> on its iflags result (right now we just match a <code>trapif</code> on its flags). We can certainly do that! I'm swamped at the moment but can get to this in a while if no one else is able to sooner.</p>
</blockquote>



<a name="236424019"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232860%20Cranelift%3A%20Panic%20compiling%20iadd_ca.../near/236424019" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232860.20Cranelift.3A.20Panic.20compiling.20iadd_ca.2E.2E.2E.html#236424019">(Apr 27 2021 at 23:05)</a>:</h4>
<p>Hypersonic <a href="https://github.com/bytecodealliance/wasmtime/issues/2860#issuecomment-828004210">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2860">Issue #2860</a>:</p>
<blockquote>
<p>I think I'm covered by <code>iadd_ifcout</code>, thanks for the info! I'm going to close this issue since I think it's resolved for me.</p>
</blockquote>



<a name="236424021"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232860%20Cranelift%3A%20Panic%20compiling%20iadd_ca.../near/236424021" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232860.20Cranelift.3A.20Panic.20compiling.20iadd_ca.2E.2E.2E.html#236424021">(Apr 27 2021 at 23:05)</a>:</h4>
<p>Hypersonic closed <a href="https://github.com/bytecodealliance/wasmtime/issues/2860">Issue #2860</a>:</p>
<blockquote>
<p>Hi! While using Cranelift as a backend for a project, I ran into a panic compiling iadd_carry instructions on x86_64. Please let me know if there is any other information I can provide that would be helpful.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="p">()</span><span class="w"> </span><span class="n">fast</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span>:
    <span class="nc">v1465</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v1467</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bconst</span><span class="p">.</span><span class="n">b1</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="w">    </span><span class="n">v1468</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v1469</span><span class="p">,</span><span class="w"> </span><span class="n">v1470</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd_carry</span><span class="w"> </span><span class="n">v1465</span><span class="p">,</span><span class="w"> </span><span class="n">v1468</span><span class="p">,</span><span class="w"> </span><span class="n">v1467</span><span class="w"></span>
<span class="w">    </span><span class="n">v1476</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bint</span><span class="p">.</span><span class="kt">i8</span><span class="w"> </span><span class="n">v1470</span><span class="w"></span>
<span class="w">    </span><span class="n">v1356</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v1391</span><span class="w"> </span>-&gt; <span class="nc">v1356</span><span class="w"></span>
<span class="w">    </span><span class="n">v1423</span><span class="w"> </span>-&gt; <span class="nc">v1356</span><span class="w"></span>
<span class="w">    </span><span class="n">v1447</span><span class="w"> </span>-&gt; <span class="nc">v1356</span><span class="w"></span>
<span class="w">    </span><span class="n">v1464</span><span class="w"> </span>-&gt; <span class="nc">v1356</span><span class="w"></span>
<span class="w">    </span><span class="n">v1494</span><span class="w"> </span>-&gt; <span class="nc">v1356</span><span class="w"></span>
<span class="w">    </span><span class="n">v1516</span><span class="w"> </span>-&gt; <span class="nc">v1356</span><span class="w"></span>
<span class="w">    </span><span class="n">v1544</span><span class="w"> </span>-&gt; <span class="nc">v1356</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v1476</span><span class="p">,</span><span class="w"> </span><span class="n">v1356</span><span class="o">+</span><span class="mi">274</span><span class="w"></span>
<span class="w">    </span><span class="n">trap</span><span class="w"> </span><span class="n">user0</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p><code>cargo run -p cranelift-tools -- compile test.clif --target x86_64</code></p>
<h3>Expected Results</h3>
<p>Code successfully generates without a panic.</p>
<h3>Actual Results</h3>
<p>Panic: <code>thread 'main' panicked at 'ALU+imm and ALU+carry ops should not appear here!', cranelift/codegen/src/isa/x64/lower.rs:5740:13</code></p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: main HEAD (4a830b at time of writing)</p>
<p>Operating system: Linux</p>
<p>Architecture: x86_64</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>