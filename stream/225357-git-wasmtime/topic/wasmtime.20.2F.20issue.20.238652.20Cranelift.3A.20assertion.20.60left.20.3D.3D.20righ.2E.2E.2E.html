<html>
<head><meta charset="utf-8"><title>wasmtime / issue #8652 Cranelift: assertion `left == righ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html">wasmtime / issue #8652 Cranelift: assertion `left == righ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="439426888"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/439426888" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#439426888">(May 19 2024 at 10:10)</a>:</h4>
<p><a href="https://github.com/whitequark">whitequark</a> added the cranelift label to <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">Issue #8652</a>.</p>



<a name="439426889"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/439426889" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#439426889">(May 19 2024 at 10:10)</a>:</h4>
<p><a href="https://github.com/whitequark">whitequark</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">Issue #8652</a>.</p>



<a name="439426891"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/439426891" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#439426891">(May 19 2024 at 10:10)</a>:</h4>
<p>whitequark opened <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">issue #8652</a>:</p>
<blockquote>
<h3>Steps to Reproduce</h3>
<p>I have a binary (<code>wasm-ld</code>, which is <code>lld</code> from the LLVM distribution) built with <code>wasi-sdk-22.0</code> for the <code>wasm32-wasi-threads</code> target, with <code>CFLAGS</code> of <code>-pthread</code> and <code>LDFLAGS</code> of <code>-Wl,--max-memory=4294967296</code>. It is too big to include here but I believe the relevant excerpt is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="p">(</span><span class="n">memory</span><span class="w"> </span><span class="p">(;</span><span class="mi">0</span><span class="p">;)</span><span class="w"> </span><span class="mi">53</span><span class="w"> </span><span class="mi">65536</span><span class="w"> </span><span class="n">shared</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"memory"</span><span class="w"> </span><span class="p">(</span><span class="n">memory</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
</code></pre></div>
<p>I run the binary with <code>RUST_BACKTRACE=full WASMTIME_BACKTRACE_DETAILS=1 time_to_wasm -D debug-info -D address-map ./llvm-build/bin/wasm-ld &lt;...arguments that cause a trap...&gt;</code>.</p>
<h3>Expected Results</h3>
<p>A backtrace with Wasm-level symbols is displayed.</p>
<h3>Actual Results</h3>
<p>&lt;details&gt;<br>
&lt;summary&gt;An assertion failure in Cranelift.&lt;/summary&gt;</p>
<p>&lt;/details&gt;</p>
<p>TODO: What actually happens? Panic? Segfault? Incorrect result?</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: TODO</p>
<p>Operating system: TODO</p>
<p>Architecture: TODO</p>
<h3>Extra Info</h3>
<p>Anything else you'd like to add?<br>
</p>
</blockquote>



<a name="439426916"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/439426916" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#439426916">(May 19 2024 at 10:11)</a>:</h4>
<p>whitequark edited <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">issue #8652</a>:</p>
<blockquote>
<h3>Steps to Reproduce</h3>
<p>I have a binary (<code>wasm-ld</code>, which is <code>lld</code> from the LLVM distribution) built with <code>wasi-sdk-22.0</code> for the <code>wasm32-wasi-threads</code> target, with <code>CFLAGS</code> of <code>-pthread</code> and <code>LDFLAGS</code> of <code>-Wl,--max-memory=4294967296</code>. It is too big to include here but I believe the relevant excerpt is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="p">(</span><span class="n">memory</span><span class="w"> </span><span class="p">(;</span><span class="mi">0</span><span class="p">;)</span><span class="w"> </span><span class="mi">53</span><span class="w"> </span><span class="mi">65536</span><span class="w"> </span><span class="n">shared</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"memory"</span><span class="w"> </span><span class="p">(</span><span class="n">memory</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
</code></pre></div>
<p>I run the binary with <code>RUST_BACKTRACE=full WASMTIME_BACKTRACE_DETAILS=1 time_to_wasm -D debug-info -D address-map ./llvm-build/bin/wasm-ld &lt;...arguments that cause a trap...&gt;</code>.</p>
<h3>Expected Results</h3>
<p>A backtrace with Wasm-level symbols is displayed.</p>
<h3>Actual Results</h3>
<p>&lt;details&gt;<br>
&lt;summary&gt;An assertion failure in Cranelift.&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">whitequark</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">cranelift</span><span class="o">-</span><span class="mf">20.0.2</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">compiler</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">559</span>:<span class="mi">13</span>:
<span class="nc">assertion</span><span class="w"> </span><span class="err">`</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="err">`</span><span class="w"> </span><span class="n">failed</span>: <span class="nc">the</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">incorrect</span><span class="w"> </span><span class="n">due</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">sharing</span><span class="w"> </span><span class="n">memory</span>
<span class="w">  </span><span class="n">left</span>: <span class="mi">1</span>
<span class="w"> </span><span class="n">right</span>: <span class="mi">0</span>
<span class="n">stack</span><span class="w"> </span><span class="n">backtrace</span>:
   <span class="mi">0</span>:     <span class="mh">0x55f64b236496</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">_print</span>::<span class="n">DisplayBacktrace</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">fmt</span>::<span class="n">Display</span><span class="o">&gt;</span>::<span class="n">fmt</span>::<span class="n">h402f02d9b4df5fe1</span>
<span class="w">   </span><span class="mi">1</span>:     <span class="mh">0x55f64b262c4c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">fmt</span>::<span class="n">write</span>::<span class="n">h8fddb4828840201f</span>
<span class="w">   </span><span class="mi">2</span>:     <span class="mh">0x55f64b23234f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span>::<span class="n">Write</span>::<span class="n">write_fmt</span>::<span class="n">h38b9b1a6a63dbb61</span>
<span class="w">   </span><span class="mi">3</span>:     <span class="mh">0x55f64b236244</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">print</span>::<span class="n">h98a1789ae7f04118</span>
<span class="w">   </span><span class="mi">4</span>:     <span class="mh">0x55f64b237a3b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">panicking</span>::<span class="n">default_hook</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">hbf9ed991ae15cec9</span>
<span class="w">   </span><span class="mi">5</span>:     <span class="mh">0x55f64b237789</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">panicking</span>::<span class="n">default_hook</span>::<span class="n">h0e9a403389616b5a</span>
<span class="w">   </span><span class="mi">6</span>:     <span class="mh">0x55f64b237edd</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">panicking</span>::<span class="n">rust_panic_with_hook</span>::<span class="n">h47d6ea0dd5408232</span>
<span class="w">   </span><span class="mi">7</span>:     <span class="mh">0x55f64b237db2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">panicking</span>::<span class="n">begin_panic_handler</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h92169a5d672aa955</span>
<span class="w">   </span><span class="mi">8</span>:     <span class="mh">0x55f64b236976</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">__rust_end_short_backtrace</span>::<span class="n">h78311f5de6c73a58</span>
<span class="w">   </span><span class="mi">9</span>:     <span class="mh">0x55f64b237ae4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rust_begin_unwind</span>
<span class="w">  </span><span class="mi">10</span>:     <span class="mh">0x55f649eb0a15</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">panicking</span>::<span class="n">panic_fmt</span>::<span class="n">h9fcc2d8bb7eb13a8</span>
<span class="w">  </span><span class="mi">11</span>:     <span class="mh">0x55f649eb0e8f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">panicking</span>::<span class="n">assert_failed_inner</span>::<span class="n">h77eb1113bacb0f31</span>
<span class="w">  </span><span class="mi">12</span>:     <span class="mh">0x55f649e588af</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">panicking</span>::<span class="n">assert_failed</span>::<span class="n">he44b2686efc08dff</span>
<span class="w">  </span><span class="mi">13</span>:     <span class="mh">0x55f64abe2d30</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wasmtime_cranelift</span>::<span class="n">compiler</span>::<span class="n">Compiler</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">wasmtime_environ</span>::<span class="n">compile</span>::<span class="n">Compiler</span><span class="o">&gt;</span>::<span class="n">append_dwarf</span>::<span class="n">h14d11c20fa9e5f82</span>
<span class="w">  </span><span class="mi">14</span>:     <span class="mh">0x55f64aafb697</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">compile</span>::<span class="n">FunctionIndices</span>::<span class="n">link_and_append_code</span>::<span class="n">hf766901eb87a60b8</span>
<span class="w">  </span><span class="mi">15</span>:     <span class="mh">0x55f64aaf4c31</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">compile</span>::<span class="n">build_artifacts</span>::<span class="n">h1809dbb6af98174d</span>
<span class="w">  </span><span class="mi">16</span>:     <span class="mh">0x55f64ab4360c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">ops</span>::<span class="n">function</span>::<span class="nb">FnOnce</span>::<span class="n">call_once</span>::<span class="n">h8f5620eee6192dd4</span>
<span class="w">  </span><span class="mi">17</span>:     <span class="mh">0x55f64ab6bdc5</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_cache</span>::<span class="n">ModuleCacheEntry</span>::<span class="n">get_data_raw</span>::<span class="n">h5918a4673179324b</span>
<span class="w">  </span><span class="mi">18</span>:     <span class="mh">0x55f64ab4f059</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">compile</span>::<span class="n">runtime</span>::<span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">compile</span>::<span class="n">code_builder</span>::<span class="n">CodeBuilder</span><span class="o">&gt;</span>::<span class="n">compile_module</span>::<span class="n">h6cfb67fd1fb024ce</span>
<span class="w">  </span><span class="mi">19</span>:     <span class="mh">0x55f649ee4dec</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_cli</span>::<span class="n">common</span>::<span class="n">RunCommon</span>::<span class="n">load_module</span>::<span class="n">h0243b5cafcaca8ef</span>
<span class="w">  </span><span class="mi">20</span>:     <span class="mh">0x55f649fd2f2a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_cli</span>::<span class="n">commands</span>::<span class="n">run</span>::<span class="n">RunCommand</span>::<span class="n">execute</span>::<span class="n">h741dadf6ee6383ad</span>
<span class="w">  </span><span class="mi">21</span>:     <span class="mh">0x55f649eb9c01</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">Wasmtime</span>::<span class="n">execute</span>::<span class="n">h9f6abe47b919fe59</span>
<span class="w">  </span><span class="mi">22</span>:     <span class="mh">0x55f649eb5088</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">old_cli</span>::<span class="n">main</span>::<span class="n">hbf2a698a610c379d</span>
<span class="w">  </span><span class="mi">23</span>:     <span class="mh">0x55f649eb69a3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">__rust_begin_short_backtrace</span>::<span class="n">h2d92647e84e7ad00</span>
<span class="w">  </span><span class="mi">24</span>:     <span class="mh">0x55f649eb69bd</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h3b525ebc181e5daf</span>
<span class="w">  </span><span class="mi">25</span>:     <span class="mh">0x55f64b228533</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start_internal</span>::<span class="n">hb867f343d27fa61e</span>
<span class="w">  </span><span class="mi">26</span>:     <span class="mh">0x55f649ebb4a5</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">main</span>
<span class="w">  </span><span class="mi">27</span>:     <span class="mh">0x7f85f8f3f24a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">__libc_start_call_main</span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">csu</span><span class="o">/../</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">nptl</span><span class="o">/</span><span class="n">libc_start_call_main</span><span class="p">.</span><span class="n">h</span>:<span class="mi">58</span>:<span class="mi">16</span>
<span class="w">  </span><span class="mi">28</span>:     <span class="mh">0x7f85f8f3f305</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">__libc_start_main_impl</span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">csu</span><span class="o">/../</span><span class="n">csu</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="n">start</span><span class="p">.</span><span class="n">c</span>:<span class="mi">360</span>:<span class="mi">3</span>
<span class="w">  </span><span class="mi">29</span>:     <span class="mh">0x55f649eb10c1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">_start</span>
<span class="w">  </span><span class="mi">30</span>:                <span class="mh">0x0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: <code>wasmtime-cranelift-20.0.2</code></p>
<p>Operating system: Linux</p>
<p>Architecture: x86_64<br>
</p>
</blockquote>



<a name="439426984"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/439426984" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#439426984">(May 19 2024 at 10:12)</a>:</h4>
<p>whitequark edited <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">issue #8652</a>:</p>
<blockquote>
<h3>Steps to Reproduce</h3>
<p>I have a binary (<code>wasm-ld</code>, which is <code>lld</code> from the LLVM distribution) built with <code>wasi-sdk-22.0</code> for the <code>wasm32-wasi-threads</code> target, with <code>CFLAGS</code> of <code>-pthread</code> and <code>LDFLAGS</code> of <code>-Wl,--max-memory=4294967296</code>. It is built with debug symbols using the normal LLVM mechanism (<code>RelWithDebInfo</code>). It is too big to include here but I believe the relevant excerpt is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="p">(</span><span class="n">memory</span><span class="w"> </span><span class="p">(;</span><span class="mi">0</span><span class="p">;)</span><span class="w"> </span><span class="mi">53</span><span class="w"> </span><span class="mi">65536</span><span class="w"> </span><span class="n">shared</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"memory"</span><span class="w"> </span><span class="p">(</span><span class="n">memory</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
</code></pre></div>
<p>I run the binary with <code>RUST_BACKTRACE=full WASMTIME_BACKTRACE_DETAILS=1 time_to_wasm -D debug-info -D address-map ./llvm-build/bin/wasm-ld &lt;...arguments that cause a trap...&gt;</code>.</p>
<h3>Expected Results</h3>
<p>A backtrace with Wasm-level symbols is displayed.</p>
<h3>Actual Results</h3>
<p>&lt;details&gt;<br>
&lt;summary&gt;An assertion failure in Cranelift.&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">whitequark</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">cranelift</span><span class="o">-</span><span class="mf">20.0.2</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">compiler</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">559</span>:<span class="mi">13</span>:
<span class="nc">assertion</span><span class="w"> </span><span class="err">`</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="err">`</span><span class="w"> </span><span class="n">failed</span>: <span class="nc">the</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">incorrect</span><span class="w"> </span><span class="n">due</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">sharing</span><span class="w"> </span><span class="n">memory</span>
<span class="w">  </span><span class="n">left</span>: <span class="mi">1</span>
<span class="w"> </span><span class="n">right</span>: <span class="mi">0</span>
<span class="n">stack</span><span class="w"> </span><span class="n">backtrace</span>:
   <span class="mi">0</span>:     <span class="mh">0x55f64b236496</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">_print</span>::<span class="n">DisplayBacktrace</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">fmt</span>::<span class="n">Display</span><span class="o">&gt;</span>::<span class="n">fmt</span>::<span class="n">h402f02d9b4df5fe1</span>
<span class="w">   </span><span class="mi">1</span>:     <span class="mh">0x55f64b262c4c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">fmt</span>::<span class="n">write</span>::<span class="n">h8fddb4828840201f</span>
<span class="w">   </span><span class="mi">2</span>:     <span class="mh">0x55f64b23234f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span>::<span class="n">Write</span>::<span class="n">write_fmt</span>::<span class="n">h38b9b1a6a63dbb61</span>
<span class="w">   </span><span class="mi">3</span>:     <span class="mh">0x55f64b236244</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">print</span>::<span class="n">h98a1789ae7f04118</span>
<span class="w">   </span><span class="mi">4</span>:     <span class="mh">0x55f64b237a3b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">panicking</span>::<span class="n">default_hook</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">hbf9ed991ae15cec9</span>
<span class="w">   </span><span class="mi">5</span>:     <span class="mh">0x55f64b237789</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">panicking</span>::<span class="n">default_hook</span>::<span class="n">h0e9a403389616b5a</span>
<span class="w">   </span><span class="mi">6</span>:     <span class="mh">0x55f64b237edd</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">panicking</span>::<span class="n">rust_panic_with_hook</span>::<span class="n">h47d6ea0dd5408232</span>
<span class="w">   </span><span class="mi">7</span>:     <span class="mh">0x55f64b237db2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">panicking</span>::<span class="n">begin_panic_handler</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h92169a5d672aa955</span>
<span class="w">   </span><span class="mi">8</span>:     <span class="mh">0x55f64b236976</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">__rust_end_short_backtrace</span>::<span class="n">h78311f5de6c73a58</span>
<span class="w">   </span><span class="mi">9</span>:     <span class="mh">0x55f64b237ae4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rust_begin_unwind</span>
<span class="w">  </span><span class="mi">10</span>:     <span class="mh">0x55f649eb0a15</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">panicking</span>::<span class="n">panic_fmt</span>::<span class="n">h9fcc2d8bb7eb13a8</span>
<span class="w">  </span><span class="mi">11</span>:     <span class="mh">0x55f649eb0e8f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">panicking</span>::<span class="n">assert_failed_inner</span>::<span class="n">h77eb1113bacb0f31</span>
<span class="w">  </span><span class="mi">12</span>:     <span class="mh">0x55f649e588af</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">panicking</span>::<span class="n">assert_failed</span>::<span class="n">he44b2686efc08dff</span>
<span class="w">  </span><span class="mi">13</span>:     <span class="mh">0x55f64abe2d30</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wasmtime_cranelift</span>::<span class="n">compiler</span>::<span class="n">Compiler</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">wasmtime_environ</span>::<span class="n">compile</span>::<span class="n">Compiler</span><span class="o">&gt;</span>::<span class="n">append_dwarf</span>::<span class="n">h14d11c20fa9e5f82</span>
<span class="w">  </span><span class="mi">14</span>:     <span class="mh">0x55f64aafb697</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">compile</span>::<span class="n">FunctionIndices</span>::<span class="n">link_and_append_code</span>::<span class="n">hf766901eb87a60b8</span>
<span class="w">  </span><span class="mi">15</span>:     <span class="mh">0x55f64aaf4c31</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">compile</span>::<span class="n">build_artifacts</span>::<span class="n">h1809dbb6af98174d</span>
<span class="w">  </span><span class="mi">16</span>:     <span class="mh">0x55f64ab4360c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">ops</span>::<span class="n">function</span>::<span class="nb">FnOnce</span>::<span class="n">call_once</span>::<span class="n">h8f5620eee6192dd4</span>
<span class="w">  </span><span class="mi">17</span>:     <span class="mh">0x55f64ab6bdc5</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_cache</span>::<span class="n">ModuleCacheEntry</span>::<span class="n">get_data_raw</span>::<span class="n">h5918a4673179324b</span>
<span class="w">  </span><span class="mi">18</span>:     <span class="mh">0x55f64ab4f059</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">compile</span>::<span class="n">runtime</span>::<span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">compile</span>::<span class="n">code_builder</span>::<span class="n">CodeBuilder</span><span class="o">&gt;</span>::<span class="n">compile_module</span>::<span class="n">h6cfb67fd1fb024ce</span>
<span class="w">  </span><span class="mi">19</span>:     <span class="mh">0x55f649ee4dec</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_cli</span>::<span class="n">common</span>::<span class="n">RunCommon</span>::<span class="n">load_module</span>::<span class="n">h0243b5cafcaca8ef</span>
<span class="w">  </span><span class="mi">20</span>:     <span class="mh">0x55f649fd2f2a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_cli</span>::<span class="n">commands</span>::<span class="n">run</span>::<span class="n">RunCommand</span>::<span class="n">execute</span>::<span class="n">h741dadf6ee6383ad</span>
<span class="w">  </span><span class="mi">21</span>:     <span class="mh">0x55f649eb9c01</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">Wasmtime</span>::<span class="n">execute</span>::<span class="n">h9f6abe47b919fe59</span>
<span class="w">  </span><span class="mi">22</span>:     <span class="mh">0x55f649eb5088</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">old_cli</span>::<span class="n">main</span>::<span class="n">hbf2a698a610c379d</span>
<span class="w">  </span><span class="mi">23</span>:     <span class="mh">0x55f649eb69a3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">__rust_begin_short_backtrace</span>::<span class="n">h2d92647e84e7ad00</span>
<span class="w">  </span><span class="mi">24</span>:     <span class="mh">0x55f649eb69bd</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h3b525ebc181e5daf</span>
<span class="w">  </span><span class="mi">25</span>:     <span class="mh">0x55f64b228533</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start_internal</span>::<span class="n">hb867f343d27fa61e</span>
<span class="w">  </span><span class="mi">26</span>:     <span class="mh">0x55f649ebb4a5</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">main</span>
<span class="w">  </span><span class="mi">27</span>:     <span class="mh">0x7f85f8f3f24a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">__libc_start_call_main</span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">csu</span><span class="o">/../</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">nptl</span><span class="o">/</span><span class="n">libc_start_call_main</span><span class="p">.</span><span class="n">h</span>:<span class="mi">58</span>:<span class="mi">16</span>
<span class="w">  </span><span class="mi">28</span>:     <span class="mh">0x7f85f8f3f305</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">__libc_start_main_impl</span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">csu</span><span class="o">/../</span><span class="n">csu</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="n">start</span><span class="p">.</span><span class="n">c</span>:<span class="mi">360</span>:<span class="mi">3</span>
<span class="w">  </span><span class="mi">29</span>:     <span class="mh">0x55f649eb10c1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">_start</span>
<span class="w">  </span><span class="mi">30</span>:                <span class="mh">0x0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: <code>wasmtime-cranelift-20.0.2</code></p>
<p>Operating system: Linux</p>
<p>Architecture: x86_64<br>
</p>
</blockquote>



<a name="439426997"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/439426997" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#439426997">(May 19 2024 at 10:12)</a>:</h4>
<p>whitequark edited <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">issue #8652</a>:</p>
<blockquote>
<h3>Steps to Reproduce</h3>
<p>I have a binary (<code>wasm-ld</code>, which is <code>lld</code> from the LLVM distribution) built with <code>wasi-sdk-22.0</code> for the <code>wasm32-wasi-threads</code> target, with <code>CFLAGS</code> of <code>-pthread</code> and <code>LDFLAGS</code> of <code>-Wl,--max-memory=4294967296</code>. It is built with debug symbols using the normal LLVM mechanism (<code>RelWithDebInfo</code>). It is too big to include here but I believe the relevant excerpt is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="p">(</span><span class="n">memory</span><span class="w"> </span><span class="p">(;</span><span class="mi">0</span><span class="p">;)</span><span class="w"> </span><span class="mi">53</span><span class="w"> </span><span class="mi">65536</span><span class="w"> </span><span class="n">shared</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"memory"</span><span class="w"> </span><span class="p">(</span><span class="n">memory</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
</code></pre></div>
<p>I run the binary with <code>RUST_BACKTRACE=full WASMTIME_BACKTRACE_DETAILS=1 wasmtime -S threads --dir . --dir /tmp -D debug-info -D address-map ./llvm-build/bin/wasm-ld &lt;...arguments that cause a trap...&gt;</code>.</p>
<h3>Expected Results</h3>
<p>A backtrace with Wasm-level symbols is displayed.</p>
<h3>Actual Results</h3>
<p>&lt;details&gt;<br>
&lt;summary&gt;An assertion failure in Cranelift.&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">whitequark</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">cranelift</span><span class="o">-</span><span class="mf">20.0.2</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">compiler</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">559</span>:<span class="mi">13</span>:
<span class="nc">assertion</span><span class="w"> </span><span class="err">`</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="err">`</span><span class="w"> </span><span class="n">failed</span>: <span class="nc">the</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">incorrect</span><span class="w"> </span><span class="n">due</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">sharing</span><span class="w"> </span><span class="n">memory</span>
<span class="w">  </span><span class="n">left</span>: <span class="mi">1</span>
<span class="w"> </span><span class="n">right</span>: <span class="mi">0</span>
<span class="n">stack</span><span class="w"> </span><span class="n">backtrace</span>:
   <span class="mi">0</span>:     <span class="mh">0x55f64b236496</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">_print</span>::<span class="n">DisplayBacktrace</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">fmt</span>::<span class="n">Display</span><span class="o">&gt;</span>::<span class="n">fmt</span>::<span class="n">h402f02d9b4df5fe1</span>
<span class="w">   </span><span class="mi">1</span>:     <span class="mh">0x55f64b262c4c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">fmt</span>::<span class="n">write</span>::<span class="n">h8fddb4828840201f</span>
<span class="w">   </span><span class="mi">2</span>:     <span class="mh">0x55f64b23234f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span>::<span class="n">Write</span>::<span class="n">write_fmt</span>::<span class="n">h38b9b1a6a63dbb61</span>
<span class="w">   </span><span class="mi">3</span>:     <span class="mh">0x55f64b236244</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">print</span>::<span class="n">h98a1789ae7f04118</span>
<span class="w">   </span><span class="mi">4</span>:     <span class="mh">0x55f64b237a3b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">panicking</span>::<span class="n">default_hook</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">hbf9ed991ae15cec9</span>
<span class="w">   </span><span class="mi">5</span>:     <span class="mh">0x55f64b237789</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">panicking</span>::<span class="n">default_hook</span>::<span class="n">h0e9a403389616b5a</span>
<span class="w">   </span><span class="mi">6</span>:     <span class="mh">0x55f64b237edd</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">panicking</span>::<span class="n">rust_panic_with_hook</span>::<span class="n">h47d6ea0dd5408232</span>
<span class="w">   </span><span class="mi">7</span>:     <span class="mh">0x55f64b237db2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">panicking</span>::<span class="n">begin_panic_handler</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h92169a5d672aa955</span>
<span class="w">   </span><span class="mi">8</span>:     <span class="mh">0x55f64b236976</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">__rust_end_short_backtrace</span>::<span class="n">h78311f5de6c73a58</span>
<span class="w">   </span><span class="mi">9</span>:     <span class="mh">0x55f64b237ae4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rust_begin_unwind</span>
<span class="w">  </span><span class="mi">10</span>:     <span class="mh">0x55f649eb0a15</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">panicking</span>::<span class="n">panic_fmt</span>::<span class="n">h9fcc2d8bb7eb13a8</span>
<span class="w">  </span><span class="mi">11</span>:     <span class="mh">0x55f649eb0e8f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">panicking</span>::<span class="n">assert_failed_inner</span>::<span class="n">h77eb1113bacb0f31</span>
<span class="w">  </span><span class="mi">12</span>:     <span class="mh">0x55f649e588af</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">panicking</span>::<span class="n">assert_failed</span>::<span class="n">he44b2686efc08dff</span>
<span class="w">  </span><span class="mi">13</span>:     <span class="mh">0x55f64abe2d30</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wasmtime_cranelift</span>::<span class="n">compiler</span>::<span class="n">Compiler</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">wasmtime_environ</span>::<span class="n">compile</span>::<span class="n">Compiler</span><span class="o">&gt;</span>::<span class="n">append_dwarf</span>::<span class="n">h14d11c20fa9e5f82</span>
<span class="w">  </span><span class="mi">14</span>:     <span class="mh">0x55f64aafb697</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">compile</span>::<span class="n">FunctionIndices</span>::<span class="n">link_and_append_code</span>::<span class="n">hf766901eb87a60b8</span>
<span class="w">  </span><span class="mi">15</span>:     <span class="mh">0x55f64aaf4c31</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">compile</span>::<span class="n">build_artifacts</span>::<span class="n">h1809dbb6af98174d</span>
<span class="w">  </span><span class="mi">16</span>:     <span class="mh">0x55f64ab4360c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">ops</span>::<span class="n">function</span>::<span class="nb">FnOnce</span>::<span class="n">call_once</span>::<span class="n">h8f5620eee6192dd4</span>
<span class="w">  </span><span class="mi">17</span>:     <span class="mh">0x55f64ab6bdc5</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_cache</span>::<span class="n">ModuleCacheEntry</span>::<span class="n">get_data_raw</span>::<span class="n">h5918a4673179324b</span>
<span class="w">  </span><span class="mi">18</span>:     <span class="mh">0x55f64ab4f059</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">compile</span>::<span class="n">runtime</span>::<span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">compile</span>::<span class="n">code_builder</span>::<span class="n">CodeBuilder</span><span class="o">&gt;</span>::<span class="n">compile_module</span>::<span class="n">h6cfb67fd1fb024ce</span>
<span class="w">  </span><span class="mi">19</span>:     <span class="mh">0x55f649ee4dec</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_cli</span>::<span class="n">common</span>::<span class="n">RunCommon</span>::<span class="n">load_module</span>::<span class="n">h0243b5cafcaca8ef</span>
<span class="w">  </span><span class="mi">20</span>:     <span class="mh">0x55f649fd2f2a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_cli</span>::<span class="n">commands</span>::<span class="n">run</span>::<span class="n">RunCommand</span>::<span class="n">execute</span>::<span class="n">h741dadf6ee6383ad</span>
<span class="w">  </span><span class="mi">21</span>:     <span class="mh">0x55f649eb9c01</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">Wasmtime</span>::<span class="n">execute</span>::<span class="n">h9f6abe47b919fe59</span>
<span class="w">  </span><span class="mi">22</span>:     <span class="mh">0x55f649eb5088</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">old_cli</span>::<span class="n">main</span>::<span class="n">hbf2a698a610c379d</span>
<span class="w">  </span><span class="mi">23</span>:     <span class="mh">0x55f649eb69a3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">__rust_begin_short_backtrace</span>::<span class="n">h2d92647e84e7ad00</span>
<span class="w">  </span><span class="mi">24</span>:     <span class="mh">0x55f649eb69bd</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h3b525ebc181e5daf</span>
<span class="w">  </span><span class="mi">25</span>:     <span class="mh">0x55f64b228533</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start_internal</span>::<span class="n">hb867f343d27fa61e</span>
<span class="w">  </span><span class="mi">26</span>:     <span class="mh">0x55f649ebb4a5</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">main</span>
<span class="w">  </span><span class="mi">27</span>:     <span class="mh">0x7f85f8f3f24a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">__libc_start_call_main</span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">csu</span><span class="o">/../</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">nptl</span><span class="o">/</span><span class="n">libc_start_call_main</span><span class="p">.</span><span class="n">h</span>:<span class="mi">58</span>:<span class="mi">16</span>
<span class="w">  </span><span class="mi">28</span>:     <span class="mh">0x7f85f8f3f305</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">__libc_start_main_impl</span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">csu</span><span class="o">/../</span><span class="n">csu</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="n">start</span><span class="p">.</span><span class="n">c</span>:<span class="mi">360</span>:<span class="mi">3</span>
<span class="w">  </span><span class="mi">29</span>:     <span class="mh">0x55f649eb10c1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">_start</span>
<span class="w">  </span><span class="mi">30</span>:                <span class="mh">0x0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: <code>wasmtime-cranelift-20.0.2</code></p>
<p>Operating system: Linux</p>
<p>Architecture: x86_64<br>
</p>
</blockquote>



<a name="439469104"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/439469104" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#439469104">(May 19 2024 at 21:45)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8652#issuecomment-2119369071">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">issue #8652</a>:</p>
<blockquote>
<p>The assertion triggered is <a href="https://github.com/bytecodealliance/wasmtime/blob/a77e87732e4e94ab6a2cee65bd5d74670bafe4ad/crates/cranelift/src/compiler.rs#L464-L473">this one</a> and is more-or-less <a href="https://github.com/bytecodealliance/wasmtime/issues/5537">this issue</a> where the quality of the current implementation could be better. It might be easy enough to fix this particular assertion, but I don't know enough about the DWARF bits to know.</p>
<p>In the meantime though dropping <code>-D debug-info</code> should get this further</p>
</blockquote>



<a name="439469355"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/439469355" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#439469355">(May 19 2024 at 21:50)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/8652#issuecomment-2119370100">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">issue #8652</a>:</p>
<blockquote>
<p>Yeah so I looked at the assertion and couldn't figure out what that meant at all, so I decided to file a bug instead.</p>
<p>In the end I had to use wabt's <code>wasm-objdump</code> and the address to manually correlate the Wasm bytecode to the C source, which was fairly unpleasant. I still have no idea why addr2line doesn't work--I had to pass <code>-O0</code> to <code>wasm-ld</code> (which, while we're at it, is an <em>incredibly</em> unintuitive flag--it took me literal years and the compiler driver source to find out that it removes the <code>wasm-opt</code> invocation; made worse by the fact that <code>wasm-opt</code> corrupts the debug info) and that gave me function names but still no line numbers.</p>
</blockquote>



<a name="439469573"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/439469573" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#439469573">(May 19 2024 at 21:54)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8652#issuecomment-2119371190">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">issue #8652</a>:</p>
<blockquote>
<p>When <code>-D debug-info</code> was omitted, <code>WASMTIME_BACKTRACE_DETAILS=1</code> was passed, and the original source had DWARF, you didn't see filenames and/or line numbers? If so that's a bug because backtrace-based filenames/line numbers are unrelated to <code>-D debug-info</code> so shouldn't be affected by this assertion.</p>
<p>If it helps I added <code>wasm-tools addr2line</code> for this sort of use case awhile back, but if it doesn't work in Wasmtime it may not work there either.</p>
</blockquote>



<a name="439469807"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/439469807" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#439469807">(May 19 2024 at 21:59)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/8652#issuecomment-2119372211">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">issue #8652</a>:</p>
<blockquote>
<p>That's correct, and I figured it's a bug. <code>wasm-tools addr2line</code> didn't work either, and neither did LLVM's addr2line that I had on my system (from LLVM 15). No idea why!</p>
</blockquote>



<a name="439489134"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/439489134" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#439489134">(May 20 2024 at 03:17)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/8652#issuecomment-2119588881">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">issue #8652</a>:</p>
<blockquote>
<blockquote>
<p>I had to pass -O0 to wasm-ld (which, while we're at it, is an incredibly unintuitive flag--it took me literal years and the compiler driver source to find out that it removes the wasm-opt invocation; made worse by the fact that wasm-opt corrupts the debug info)</p>
</blockquote>
<p>FWIW, a number of us are frustrated at the default llvm behavior here to invoke wasm-opt automagically if it's found in the path (and only if -- nondeterministic builds!). You can find a (very) long thread of folks discovering this footgun and registering new reasons for it to be removed at <a href="https://github.com/llvm/llvm-project/issues/55781">llvm/llvm-project#55781</a> (nothing would be more welcome than to fix this imho; I've been bitten by it a handful of times too). In the meantime, a workaround a number of folks have found -- and even used in quasi-official places like WASI builds of SpiderMonkey in various SDKs -- is to prepend a fake <code>wasm-opt</code> to the path that is an empty shell script (with <code>exit 0</code> or whatever). Perhaps we should document this footgun and workaround somewhere.</p>
</blockquote>



<a name="439586686"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/439586686" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#439586686">(May 20 2024 at 14:37)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8652#issuecomment-2120594332">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">issue #8652</a>:</p>
<blockquote>
<p>@whitequark would you be able to share either the wasm binary itself (perhaps not here if it's too large but via some other means) or instructions on how to build a local copy of it? It sounds like the dwarf info may be corrupted and that could range from a build process thing to an llvm bug to a tooling issue in wasmtime/wasm-tools.</p>
</blockquote>



<a name="439601197"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/439601197" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#439601197">(May 20 2024 at 15:50)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/8652#issuecomment-2120728083">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">issue #8652</a>:</p>
<blockquote>
<blockquote>
<p>would you be able to share either the wasm binary itself (perhaps not here if it's too large but via some other means) or instructions on how to build a local copy of it?</p>
</blockquote>
<p>I can do both! The binary is about half a gig but it's built with a simple script. I'm going to double-check the build to make sure you can reproduce the crash and then upload. I don't envy you looking at half a GB of DWARF though...</p>
</blockquote>



<a name="439601290"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/439601290" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#439601290">(May 20 2024 at 15:50)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/8652#issuecomment-2120728916">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">issue #8652</a>:</p>
<blockquote>
<blockquote>
<p>FWIW, a number of us are frustrated at the default llvm behavior here to invoke wasm-opt automagically if it's found in the path (and only if -- nondeterministic builds!).</p>
</blockquote>
<p>I found it baffling and frustrating, yes. I assumed that it was (uncharacteristically!) a decision driven by the Wasm folks. If it's not, should we not just fix that?</p>
</blockquote>



<a name="439616752"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/439616752" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#439616752">(May 20 2024 at 17:13)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/8652#issuecomment-2120860571">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">issue #8652</a>:</p>
<blockquote>
<p>@alexcrichton <a href="https://github.com/YoWASP/clang/compare/wasmtime-issue-8652">This branch</a> contains a reproducer--just run <code>./build.sh</code> on Linux and it should produce a binary. Here's how it fails:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">WASMTIME_BACKTRACE_DETAILS</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="o">-</span><span class="n">S</span><span class="w"> </span><span class="n">threads</span><span class="w"> </span><span class="o">--</span><span class="n">dir</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">llvm</span><span class="o">-</span><span class="n">build</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">ld</span><span class="w"> </span><span class="n">test</span><span class="p">.</span><span class="n">o</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">test</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">entry</span>
<span class="n">Error</span>: <span class="nc">error</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">executing</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span>:
    <span class="mi">0</span>: <span class="mh">0x25c5755</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lld</span><span class="o">!</span><span class="n">wasi_thread_start</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="mi">0</span>: <span class="nc">memory</span><span class="w"> </span><span class="n">fault</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="mh">0x374fc0</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">linear</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="mh">0x340000</span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">wasm</span><span class="w"> </span><span class="n">trap</span>: <span class="nc">out</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">bounds</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">access</span>
<span class="cp">$</span><span class="w"> </span><span class="n">wasm</span><span class="o">-</span><span class="n">tools</span><span class="w"> </span><span class="n">objdump</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">llvm</span><span class="o">-</span><span class="n">build</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">ld</span>
<span class="w">  </span><span class="n">types</span><span class="w">                                  </span><span class="o">|</span><span class="w">        </span><span class="mh">0xb</span><span class="w"> </span><span class="o">-</span><span class="w">      </span><span class="mh">0x9af</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">2468</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">246</span><span class="w"> </span><span class="n">count</span>
<span class="w">  </span><span class="n">imports</span><span class="w">                                </span><span class="o">|</span><span class="w">      </span><span class="mh">0x9b2</span><span class="w"> </span><span class="o">-</span><span class="w">      </span><span class="mh">0xdd9</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">1063</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="n">count</span>
<span class="w">  </span><span class="n">functions</span><span class="w">                              </span><span class="o">|</span><span class="w">      </span><span class="mh">0xddd</span><span class="w"> </span><span class="o">-</span><span class="w">    </span><span class="mh">0x10e9f</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="mi">65730</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">65506</span><span class="w"> </span><span class="n">count</span>
<span class="w">  </span><span class="n">tables</span><span class="w">                                 </span><span class="o">|</span><span class="w">    </span><span class="mh">0x10ea1</span><span class="w"> </span><span class="o">-</span><span class="w">    </span><span class="mh">0x10eaa</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="mi">9</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">count</span>
<span class="w">  </span><span class="n">memories</span><span class="w">                               </span><span class="o">|</span><span class="w">    </span><span class="mh">0x10eac</span><span class="w"> </span><span class="o">-</span><span class="w">    </span><span class="mh">0x10eb2</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="mi">6</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">count</span>
<span class="w">  </span><span class="n">globals</span><span class="w">                                </span><span class="o">|</span><span class="w">    </span><span class="mh">0x10eb4</span><span class="w"> </span><span class="o">-</span><span class="w">    </span><span class="mh">0x10ed2</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">30</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">count</span>
<span class="w">  </span><span class="n">exports</span><span class="w">                                </span><span class="o">|</span><span class="w">    </span><span class="mh">0x10ed4</span><span class="w"> </span><span class="o">-</span><span class="w">    </span><span class="mh">0x10efd</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">41</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">count</span>
<span class="w">  </span><span class="n">start</span><span class="w">                                  </span><span class="o">|</span><span class="w">    </span><span class="mh">0x10eff</span><span class="w"> </span><span class="o">-</span><span class="w">    </span><span class="mh">0x10f00</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="mi">1</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">count</span>
<span class="w">  </span><span class="n">elements</span><span class="w">                               </span><span class="o">|</span><span class="w">    </span><span class="mh">0x10f04</span><span class="w"> </span><span class="o">-</span><span class="w">    </span><span class="mh">0x1e359</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="mi">54357</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">count</span>
<span class="w">  </span><span class="n">data</span><span class="w"> </span><span class="n">count</span><span class="w">                             </span><span class="o">|</span><span class="w">    </span><span class="mh">0x1e35b</span><span class="w"> </span><span class="o">-</span><span class="w">    </span><span class="mh">0x1e35c</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="mi">1</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">count</span>
<span class="w">  </span><span class="n">code</span><span class="w">                                   </span><span class="o">|</span><span class="w">    </span><span class="mh">0x1e361</span><span class="w"> </span><span class="o">-</span><span class="w">  </span><span class="mh">0x25c6e2a</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">39488201</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">65506</span><span class="w"> </span><span class="n">count</span>
<span class="w">  </span><span class="n">data</span><span class="w">                                   </span><span class="o">|</span><span class="w">  </span><span class="mh">0x25c6e2f</span><span class="w"> </span><span class="o">-</span><span class="w">  </span><span class="mh">0x28b122c</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">3056637</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">count</span>
<span class="w">  </span><span class="n">custom</span><span class="w"> </span><span class="s">".debug_loc"</span><span class="w">                    </span><span class="o">|</span><span class="w">  </span><span class="mh">0x28b123c</span><span class="w"> </span><span class="o">-</span><span class="w">  </span><span class="mh">0x666c7a6</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">64730474</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">count</span>
<span class="w">  </span><span class="n">custom</span><span class="w"> </span><span class="s">".debug_abbrev"</span><span class="w">                 </span><span class="o">|</span><span class="w">  </span><span class="mh">0x666c7b9</span><span class="w"> </span><span class="o">-</span><span class="w">  </span><span class="mh">0x6a04a8b</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">3769042</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">count</span>
<span class="w">  </span><span class="n">custom</span><span class="w"> </span><span class="s">".debug_info"</span><span class="w">                   </span><span class="o">|</span><span class="w">  </span><span class="mh">0x6a04a9d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0x17802250</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">283105203</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">count</span>
<span class="w">  </span><span class="n">custom</span><span class="w"> </span><span class="s">".debug_ranges"</span><span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="mh">0x17802263</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0x18e53e6b</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">23403528</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">count</span>
<span class="w">  </span><span class="n">custom</span><span class="w"> </span><span class="s">".debug_str"</span><span class="w">                    </span><span class="o">|</span><span class="w"> </span><span class="mh">0x18e53e7b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0x207465b2</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">126822199</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">count</span>
<span class="w">  </span><span class="n">custom</span><span class="w"> </span><span class="s">".debug_line"</span><span class="w">                   </span><span class="o">|</span><span class="w"> </span><span class="mh">0x207465c3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0x23d9c125</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">56974178</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">count</span>
<span class="w">  </span><span class="n">custom</span><span class="w"> </span><span class="s">"name"</span><span class="w">                          </span><span class="o">|</span><span class="w"> </span><span class="mh">0x23d9c12f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0x24b19d6f</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">14146624</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">count</span>
<span class="w">  </span><span class="n">custom</span><span class="w"> </span><span class="s">"producers"</span><span class="w">                     </span><span class="o">|</span><span class="w"> </span><span class="mh">0x24b19d7c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0x24b19e07</span><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="mi">139</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">count</span>
<span class="w">  </span><span class="n">custom</span><span class="w"> </span><span class="s">"target_features"</span><span class="w">               </span><span class="o">|</span><span class="w"> </span><span class="mh">0x24b19e19</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0x24b19e4b</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">50</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">count</span>
<span class="cp">$</span><span class="w"> </span><span class="n">wasm</span><span class="o">-</span><span class="n">tools</span><span class="w"> </span><span class="n">addr2line</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">llvm</span><span class="o">-</span><span class="n">build</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">ld</span><span class="w"> </span><span class="mh">0x25c5755</span>
<span class="mh">0x25c5755</span>: <span class="nc">no</span><span class="w"> </span><span class="n">dwarf</span><span class="w"> </span><span class="n">frames</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">address</span>
</code></pre></div>
<p>Also here is <a href="https://mega.nz/file/c95hlZqC#dWuzLWRHaUzHUe7jGtSpbmgcTWsJu3LHlqzXMZ2htN0">an upload</a> if you want to skip building it.</p>
</blockquote>



<a name="439624202"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/439624202" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#439624202">(May 20 2024 at 17:57)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/8652#issuecomment-2120932125">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">issue #8652</a>:</p>
<blockquote>
<blockquote>
<p>If it's not, should we not just fix that?</p>
</blockquote>
<p>Feel free to add more data upstream! I think several folks have pushed on this (see above thread) but additional anecdotes might add some motivation or spawn new interest...</p>
</blockquote>



<a name="439625927"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/439625927" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#439625927">(May 20 2024 at 18:07)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/8652#issuecomment-2120946968">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">issue #8652</a>:</p>
<blockquote>
<p>I mean, who's the code owner for wasm-ld? Should we not submit a patch and ping them? Adding an option to disable wasm-opt seems completely uncontroversial; making it on-by-default perhaps more so, but even that would make it more in line with other targets.</p>
</blockquote>



<a name="439629709"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/439629709" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#439629709">(May 20 2024 at 18:30)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8652#issuecomment-2120984835">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">issue #8652</a>:</p>
<blockquote>
<p>Ah I think everything's actually working as intended in the dwarf bits there, albeit unfortunately. The faulting address there is in <code>wasi_thread_start</code> which is <a href="https://github.com/WebAssembly/wasi-libc/blob/a3ef1520ec5c00f375eb87903151307c90cca4f1/libc-top-half/musl/src/thread/wasm32/wasi_thread_start.s#L13">defined here</a>. The trapping instruction is <a href="https://github.com/WebAssembly/wasi-libc/blob/a3ef1520ec5c00f375eb87903151307c90cca4f1/libc-top-half/musl/src/thread/wasm32/wasi_thread_start.s#L19">this one</a>.</p>
<p>It looks like the bug here has to do with the protocol of spawning a thread as the second instruction in the thread probably shouldn't be the one faulting. </p>
<p>I tested another address by running <code>wasm-tools print -p llvm-build/bin/wasm-ld -o wasm-ld.wat</code> and then within <code>wasm-ld.wat</code> I picked a random offset and got</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">wasm</span><span class="o">-</span><span class="n">tools</span><span class="w"> </span><span class="n">addr2line</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">llvm</span><span class="o">-</span><span class="n">build</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">ld</span><span class="w"> </span><span class="mh">0x1fb0b</span>
<span class="mh">0x1fb0b</span>: <span class="nc">llvm</span>::<span class="n">raw_ostream</span>::<span class="n">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">llvm</span>::<span class="n">StringRef</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">alex</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">clang</span><span class="o">/</span><span class="n">llvm</span><span class="o">-</span><span class="n">src</span><span class="o">/</span><span class="n">llvm</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">llvm</span><span class="o">/</span><span class="n">Support</span><span class="o">/</span><span class="n">raw_ostream</span><span class="p">.</span><span class="n">h</span>:<span class="mi">216</span>:<span class="mi">25</span>
<span class="w">        </span><span class="n">llvm</span>::<span class="n">raw_ostream</span>::<span class="n">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">alex</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">clang</span><span class="o">/</span><span class="n">llvm</span><span class="o">-</span><span class="n">src</span><span class="o">/</span><span class="n">llvm</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">llvm</span><span class="o">/</span><span class="n">Support</span><span class="o">/</span><span class="n">raw_ostream</span><span class="p">.</span><span class="n">h</span>:<span class="mi">244</span>:<span class="mi">18</span>
<span class="w">        </span><span class="n">llvm</span>::<span class="n">cl</span>::<span class="n">basic_parser_impl</span>::<span class="n">printOptionInfo</span><span class="p">(</span><span class="n">llvm</span>::<span class="n">cl</span>::<span class="nb">Option</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="n">long</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">alex</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">clang</span><span class="o">/</span><span class="n">llvm</span><span class="o">-</span><span class="n">src</span><span class="o">/</span><span class="n">llvm</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">Support</span><span class="o">/</span><span class="n">CommandLine</span><span class="p">.</span><span class="n">cpp</span>:<span class="mi">1939</span>:<span class="mi">14</span>
</code></pre></div>
<p>I believe that the <code>wasi_thread_start</code> function doesn't have dwarf since it's inline asm. I also believe that wasi-libc isn't built with debug info so any symbols in libc also won't have dwarf for them. Finally you're also running into debugging limitations here where there's currently no great way to debug what spawned the thread and/or get a listing of all wasm threads.</p>
</blockquote>



<a name="439629826"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/439629826" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#439629826">(May 20 2024 at 18:31)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8652#issuecomment-2120985851">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">issue #8652</a>:</p>
<blockquote>
<blockquote>
<p>I mean, who's the code owner for wasm-ld?</p>
</blockquote>
<p>I'm personally under the impression it's <a href="https://github.com/sbc100">Sam Clegg</a> (not pinging here directly as it might be a bit out of context)</p>
</blockquote>



<a name="439630943"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/439630943" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#439630943">(May 20 2024 at 18:38)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/8652#issuecomment-2120996669">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">issue #8652</a>:</p>
<blockquote>
<blockquote>
<p>It looks like the bug here has to do with the protocol of spawning a thread as the second instruction in the thread probably shouldn't be the one faulting.</p>
</blockquote>
<p>Yeah, it's left me quite confused. Also, previously I got a fault on a similarly non-memory-accessing instruction, it was on <code>args-&gt;start_func()</code> <a href="https://github.com/WebAssembly/wasi-libc/blob/a3ef1520ec5c00f375eb87903151307c90cca4f1/libc-top-half/musl/src/thread/pthread_create.c#L318">here</a> which similarly didn't make sense (the backtrace pointed to <code>call_indirect</code>).</p>
</blockquote>



<a name="439631439"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/439631439" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#439631439">(May 20 2024 at 18:41)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8652#issuecomment-2121001668">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">issue #8652</a>:</p>
<blockquote>
<p>Ah ok yeah given that it's still in wasi-libc that makes sense that there's no filename/line number there either because you haven't made it into clang/lld yet. That being said that instruction should also not be faulting, so my hypothesis would be some sort of corruption/bug in the threads part of wasi-threads. I'm not sure how well tested the whole port is (with threads), so this isn't necessarily altogether surprising</p>
</blockquote>



<a name="439631875"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/439631875" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#439631875">(May 20 2024 at 18:44)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/8652#issuecomment-2121005027">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">issue #8652</a>:</p>
<blockquote>
<blockquote>
<p>I'm not sure how well tested the whole port is (with threads), so this isn't necessarily altogether surprising</p>
</blockquote>
<p>By port here do you mean the wasi-libc port?</p>
</blockquote>



<a name="439631917"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/439631917" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#439631917">(May 20 2024 at 18:44)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/8652#issuecomment-2121005376">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">issue #8652</a>:</p>
<blockquote>
<blockquote>
<p>Ah ok yeah given that it's still in wasi-libc that makes sense that there's no filename/line number there either because you haven't made it into clang/lld yet.</p>
</blockquote>
<p>Ah that explains it! Can we ship wasi-libc with debug symbols?</p>
</blockquote>



<a name="439657375"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/439657375" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#439657375">(May 20 2024 at 18:49)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8652#issuecomment-2121012507">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">issue #8652</a>:</p>
<blockquote>
<p>Ah sorry, but yes by port I mean the implementation in wasi-libc. The implementation of pthread-style APIs there I don't believe has seen a large amount of testing. <a href="https://github.com/WebAssembly/wasi-libc/issues/405">https://github.com/WebAssembly/wasi-libc/issues/405</a> is an example older issue where I think <a href="https://github.com/WebAssembly/wasi-libc/pull/409">https://github.com/WebAssembly/wasi-libc/pull/409</a> fixed some things but that thread mentions known open issues.</p>
</blockquote>



<a name="439657751"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/439657751" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#439657751">(May 20 2024 at 18:51)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8652#issuecomment-2121014953">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">issue #8652</a>:</p>
<blockquote>
<p>Er, I should keep reading before replaying, apologies!</p>
<blockquote>
<p>Can we ship wasi-libc with debug symbols?</p>
</blockquote>
<p>Personally I don't see any reason why not, they're easy enough to strip out and otherwise difficult to retrofit and very useful in situations like this. Changes to the builds of wasi-libc would go in <a href="https://github.com/WebAssembly/wasi-sdk/">wasi-sdk</a> around the wasi-libc build rules, probably appending to <code>CFLAGS</code> for that invocation.</p>
</blockquote>



<a name="439658223"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/439658223" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#439658223">(May 20 2024 at 18:53)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8652#issuecomment-2121017931">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">issue #8652</a>:</p>
<blockquote>
<p>Actually if you run the exact example today from <a href="https://github.com/WebAssembly/wasi-libc/issues/405">https://github.com/WebAssembly/wasi-libc/issues/405</a> it is not fixed, and might be what's happening here.</p>
</blockquote>



<a name="442397957"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/442397957" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#442397957">(Jun 03 2024 at 23:29)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8652#issuecomment-2146294333">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">issue #8652</a>:</p>
<blockquote>
<p>@whitequark btw if you hadn't seen already from <a href="https://github.com/WebAssembly/wasi-libc/issues/405">https://github.com/WebAssembly/wasi-libc/issues/405</a> this was enough for me to get the <code>wasm-ld</code> binary to run locally:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/build.sh b/build.sh</span>
<span class="gh">index f99daf8..e659a9d 100755</span>
<span class="gd">--- a/build.sh</span>
<span class="gi">+++ b/build.sh</span>
<span class="gu">@@ -14,7 +14,7 @@ WASI_LDFLAGS="-O0" # "-flto -Wl,--strip-all"</span>
<span class="w"> </span># LLVM doesn't build without &lt;mutex&gt;, etc, even with -DLLVM_ENABLE_THREADS=OFF.
<span class="w"> </span>WASI_TARGET="${WASI_TARGET}-threads"
<span class="w"> </span>WASI_CFLAGS="${WASI_CFLAGS} -pthread"
<span class="gd">-WASI_LDFLAGS="${WASI_LDFLAGS} -Wl,--max-memory=4294967296"</span>
<span class="gi">+WASI_LDFLAGS="${WASI_LDFLAGS} -Wl,--max-memory=4294967296,--import-memory,--export-memory"</span>
<span class="w"> </span># LLVM assumes the existence of mmap.
<span class="w"> </span>WASI_CFLAGS="${WASI_CFLAGS} -D_WASI_EMULATED_MMAN"
<span class="w"> </span>WASI_LDFLAGS="${WASI_LDFLAGS} -lwasi-emulated-mman"
</code></pre></div>
</blockquote>



<a name="442399501"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/442399501" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#442399501">(Jun 03 2024 at 23:40)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/8652#issuecomment-2146304258">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">issue #8652</a>:</p>
<blockquote>
<blockquote>
<p>btw if you hadn't seen already from <a href="https://github.com/WebAssembly/wasi-libc/issues/405">WebAssembly/wasi-libc#405</a> this was enough for me to get the <code>wasm-ld</code> binary to run locally:</p>
</blockquote>
<p>Ah that's interesting, I didn't realize that's the fix!</p>
</blockquote>



<a name="442911636"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/442911636" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#442911636">(Jun 05 2024 at 22:24)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8652#issuecomment-2151057539">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">issue #8652</a>:</p>
<blockquote>
<p>With <a href="https://github.com/bytecodealliance/wasmtime/pull/8750">https://github.com/bytecodealliance/wasmtime/pull/8750</a> the assert here is resolved. I'll note that our DWARF bits are pretty unoptimized so the final <code>*.cwasm</code> ends up 2G in size and takes quite some time (30+s) to compile. Once it's emitted though as-is with wasi-sdk I got:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">lldb</span><span class="p">)</span><span class="w"> </span><span class="n">r</span>
<span class="n">Process</span><span class="w"> </span><span class="mi">1611674</span><span class="w"> </span><span class="n">launched</span><span class="p">:</span><span class="w"> </span><span class="o">'/</span><span class="n">home</span><span class="o">/</span><span class="n">alex</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">'</span><span class="w"> </span><span class="p">(</span><span class="n">x86_64</span><span class="p">)</span>
<span class="n">Process</span><span class="w"> </span><span class="mi">1611674</span><span class="w"> </span><span class="n">stopped</span>

<span class="o">*</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="p">#</span><span class="mi">35</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">'</span><span class="na">wasi</span><span class="o">-</span><span class="n">thread</span><span class="o">-</span><span class="mi">1</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">stop</span><span class="w"> </span><span class="n">reason</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="n">SIGSEGV</span><span class="p">:</span><span class="w"> </span><span class="nc">invalid</span><span class="w"> </span><span class="n">permissions</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">mapped</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="p">(</span><span class="n">fault</span><span class="w"> </span><span class="n">address</span><span class="p">:</span><span class="w"> </span><span class="mh">0x7ffa1036dc70</span><span class="p">)</span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span><span class="p">#</span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="mh">0x00007fff0137f4f2</span><span class="w"> </span><span class="n">JIT</span><span class="p">(</span><span class="mh">0x7ffd90000010</span><span class="p">)</span><span class="err">`</span><span class="n">wasi_thread_start</span><span class="p">(</span><span class="n">var0</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">var1</span><span class="o">=</span><span class="mi">3595376</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">lld</span><span class="p">.</span><span class="n">wasm</span><span class="p">:</span><span class="mi">39606101</span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span><span class="w"> </span><span class="n">bt</span>

<span class="o">*</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="p">#</span><span class="mi">35</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">'</span><span class="na">wasi</span><span class="o">-</span><span class="n">thread</span><span class="o">-</span><span class="mi">1</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">stop</span><span class="w"> </span><span class="n">reason</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="n">SIGSEGV</span><span class="p">:</span><span class="w"> </span><span class="nc">invalid</span><span class="w"> </span><span class="n">permissions</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">mapped</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="p">(</span><span class="n">fault</span><span class="w"> </span><span class="n">address</span><span class="p">:</span><span class="w"> </span><span class="mh">0x7ffa1036dc70</span><span class="p">)</span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span><span class="p">#</span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="mh">0x00007fff0137f4f2</span><span class="w"> </span><span class="n">JIT</span><span class="p">(</span><span class="mh">0x7ffd90000010</span><span class="p">)</span><span class="err">`</span><span class="n">wasi_thread_start</span><span class="p">(</span><span class="n">var0</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">var1</span><span class="o">=</span><span class="mi">3595376</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">lld</span><span class="p">.</span><span class="n">wasm</span><span class="p">:</span><span class="mi">39606101</span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span><span class="p">#</span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="mh">0x00007fff0145f95e</span><span class="w"> </span><span class="n">JIT</span><span class="p">(</span><span class="mh">0x7ffd90000010</span><span class="p">)</span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span><span class="p">#</span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="mh">0x0000555556d559d5</span><span class="w"> </span><span class="n">wasmtime</span><span class="err">`</span><span class="n">wasmtime_setjmp_23_0_0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">85</span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span><span class="p">#</span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="mh">0x00005555564ebf61</span><span class="w"> </span><span class="n">wasmtime</span><span class="err">`</span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">vm</span><span class="p">::</span><span class="n">traphandlers</span><span class="p">::</span><span class="n">catch_traps</span><span class="p">::</span><span class="n">h3210ee3123e12229</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">193</span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span><span class="p">#</span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="mh">0x0000555556436cc8</span><span class="w"> </span><span class="n">wasmtime</span><span class="err">`</span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">func</span><span class="p">::</span><span class="n">invoke_wasm_and_catch_traps</span><span class="p">::</span><span class="n">h6cd1b96ad0407a69</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">216</span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span><span class="p">#</span><span class="mi">5</span><span class="p">:</span><span class="w"> </span><span class="mh">0x00005555566055e5</span><span class="w"> </span><span class="n">wasmtime</span><span class="err">`</span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">func</span><span class="p">::</span><span class="n">typed</span><span class="p">::</span><span class="n">TypedFunc</span><span class="cp">$LT$Params$C$Results$GT$</span><span class="p">::</span><span class="n">call</span><span class="p">::</span><span class="n">he7d0c04b09b99a3e</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">309</span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span><span class="p">#</span><span class="mi">6</span><span class="p">:</span><span class="w"> </span><span class="mh">0x00005555564ef78d</span><span class="w"> </span><span class="n">wasmtime</span><span class="err">`</span><span class="n">std</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="kr">try</span><span class="p">::</span><span class="n">h85af750e37223f0d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">445</span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span><span class="p">#</span><span class="mi">7</span><span class="p">:</span><span class="w"> </span><span class="mh">0x0000555556654aa5</span><span class="w"> </span><span class="n">wasmtime</span><span class="err">`</span><span class="n">std</span><span class="p">::</span><span class="n">sys_common</span><span class="p">::</span><span class="n">backtrace</span><span class="p">::</span><span class="n">__rust_begin_short_backtrace</span><span class="p">::</span><span class="n">hdf15cda4de348ee3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">117</span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span><span class="p">#</span><span class="mi">8</span><span class="p">:</span><span class="w"> </span><span class="mh">0x0000555556615720</span><span class="w"> </span><span class="n">wasmtime</span><span class="err">`</span><span class="n">core</span><span class="p">::</span><span class="n">ops</span><span class="p">::</span><span class="n">function</span><span class="p">::</span><span class="nb">FnOnce</span><span class="p">::</span><span class="n">call_once</span><span class="cp">$u7b$$u7b$vtable</span><span class="p">.</span><span class="n">shim</span><span class="cp">$u7d$$u7d$</span><span class="p">::</span><span class="n">he3448505790ef0a2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">320</span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span><span class="p">#</span><span class="mi">9</span><span class="p">:</span><span class="w"> </span><span class="mh">0x00005555574e71b5</span><span class="w"> </span><span class="n">wasmtime</span><span class="err">`</span><span class="n">std</span><span class="p">::</span><span class="n">sys</span><span class="p">::</span><span class="n">pal</span><span class="p">::</span><span class="n">unix</span><span class="p">::</span><span class="n">thread</span><span class="p">::</span><span class="n">Thread</span><span class="p">::</span><span class="n">new</span><span class="p">::</span><span class="n">thread_start</span><span class="p">::</span><span class="n">h420dad5cf01a9f35</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">37</span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span><span class="p">#</span><span class="mi">10</span><span class="p">:</span><span class="w"> </span><span class="mh">0x00007ffff7c9ca94</span><span class="w"> </span><span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">6</span><span class="err">`</span><span class="n">start_thread</span><span class="p">(</span><span class="n">arg</span><span class="o">=&lt;</span><span class="n">unavailable</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">pthread_create</span><span class="p">.</span><span class="n">c</span><span class="p">:</span><span class="mi">447</span><span class="p">:</span><span class="mi">8</span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span><span class="p">#</span><span class="mi">11</span><span class="p">:</span><span class="w"> </span><span class="mh">0x00007ffff7d29c3c</span><span class="w"> </span><span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">6</span><span class="err">`</span><span class="n">__clone3</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">clone3</span><span class="p">.</span><span class="n">S</span><span class="p">:</span><span class="mi">78</span>
</code></pre></div>
<p>also noting that it takes quite some time to also load the debug info into LLDB.</p>
<p>Using an updated wasi-sdk (from <a href="https://github.com/WebAssembly/wasi-sdk/actions/runs/9197382165">this CI build</a>) I ended up getting the same thing. I think that's because this faulting function is in assembly which either isn't built with dwarf by default or doesn't get dwarf due to it being assembly.</p>
</blockquote>



<a name="443063022"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/443063022" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#443063022">(Jun 06 2024 at 13:41)</a>:</h4>
<p>fitzgen closed <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">issue #8652</a>:</p>
<blockquote>
<h3>Steps to Reproduce</h3>
<p>I have a binary (<code>wasm-ld</code>, which is <code>lld</code> from the LLVM distribution) built with <code>wasi-sdk-22.0</code> for the <code>wasm32-wasi-threads</code> target, with <code>CFLAGS</code> of <code>-pthread</code> and <code>LDFLAGS</code> of <code>-Wl,--max-memory=4294967296</code>. It is built with debug symbols using the normal LLVM mechanism (<code>RelWithDebInfo</code>). It is too big to include here but I believe the relevant excerpt is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="p">(</span><span class="n">memory</span><span class="w"> </span><span class="p">(;</span><span class="mi">0</span><span class="p">;)</span><span class="w"> </span><span class="mi">53</span><span class="w"> </span><span class="mi">65536</span><span class="w"> </span><span class="n">shared</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"memory"</span><span class="w"> </span><span class="p">(</span><span class="n">memory</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
</code></pre></div>
<p>I run the binary with <code>RUST_BACKTRACE=full WASMTIME_BACKTRACE_DETAILS=1 wasmtime -S threads --dir . --dir /tmp -D debug-info -D address-map ./llvm-build/bin/wasm-ld &lt;...arguments that cause a trap...&gt;</code>.</p>
<h3>Expected Results</h3>
<p>A backtrace with Wasm-level symbols is displayed.</p>
<h3>Actual Results</h3>
<p>&lt;details&gt;<br>
&lt;summary&gt;An assertion failure in Cranelift.&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">whitequark</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">cranelift</span><span class="o">-</span><span class="mf">20.0.2</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">compiler</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">559</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span>
<span class="nc">assertion</span><span class="w"> </span><span class="err">`</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="err">`</span><span class="w"> </span><span class="n">failed</span><span class="p">:</span><span class="w"> </span><span class="nc">the</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">incorrect</span><span class="w"> </span><span class="n">due</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">sharing</span><span class="w"> </span><span class="n">memory</span>
<span class="w">  </span><span class="n">left</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
<span class="w"> </span><span class="n">right</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
<span class="n">stack</span><span class="w"> </span><span class="n">backtrace</span><span class="p">:</span>
<span class="w">   </span><span class="mi">0</span><span class="p">:</span><span class="w">     </span><span class="mh">0x55f64b236496</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">std</span><span class="p">::</span><span class="n">sys_common</span><span class="p">::</span><span class="n">backtrace</span><span class="p">::</span><span class="n">_print</span><span class="p">::</span><span class="n">DisplayBacktrace</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">Display</span><span class="o">&gt;</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">h402f02d9b4df5fe1</span>
<span class="w">   </span><span class="mi">1</span><span class="p">:</span><span class="w">     </span><span class="mh">0x55f64b262c4c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">write</span><span class="p">::</span><span class="n">h8fddb4828840201f</span>
<span class="w">   </span><span class="mi">2</span><span class="p">:</span><span class="w">     </span><span class="mh">0x55f64b23234f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">io</span><span class="p">::</span><span class="n">Write</span><span class="p">::</span><span class="n">write_fmt</span><span class="p">::</span><span class="n">h38b9b1a6a63dbb61</span>
<span class="w">   </span><span class="mi">3</span><span class="p">:</span><span class="w">     </span><span class="mh">0x55f64b236244</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">sys_common</span><span class="p">::</span><span class="n">backtrace</span><span class="p">::</span><span class="n">print</span><span class="p">::</span><span class="n">h98a1789ae7f04118</span>
<span class="w">   </span><span class="mi">4</span><span class="p">:</span><span class="w">     </span><span class="mh">0x55f64b237a3b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">default_hook</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}::</span><span class="n">hbf9ed991ae15cec9</span>
<span class="w">   </span><span class="mi">5</span><span class="p">:</span><span class="w">     </span><span class="mh">0x55f64b237789</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">default_hook</span><span class="p">::</span><span class="n">h0e9a403389616b5a</span>
<span class="w">   </span><span class="mi">6</span><span class="p">:</span><span class="w">     </span><span class="mh">0x55f64b237edd</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">rust_panic_with_hook</span><span class="p">::</span><span class="n">h47d6ea0dd5408232</span>
<span class="w">   </span><span class="mi">7</span><span class="p">:</span><span class="w">     </span><span class="mh">0x55f64b237db2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">begin_panic_handler</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}::</span><span class="n">h92169a5d672aa955</span>
<span class="w">   </span><span class="mi">8</span><span class="p">:</span><span class="w">     </span><span class="mh">0x55f64b236976</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">sys_common</span><span class="p">::</span><span class="n">backtrace</span><span class="p">::</span><span class="n">__rust_end_short_backtrace</span><span class="p">::</span><span class="n">h78311f5de6c73a58</span>
<span class="w">   </span><span class="mi">9</span><span class="p">:</span><span class="w">     </span><span class="mh">0x55f64b237ae4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rust_begin_unwind</span>
<span class="w">  </span><span class="mi">10</span><span class="p">:</span><span class="w">     </span><span class="mh">0x55f649eb0a15</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">panic_fmt</span><span class="p">::</span><span class="n">h9fcc2d8bb7eb13a8</span>
<span class="w">  </span><span class="mi">11</span><span class="p">:</span><span class="w">     </span><span class="mh">0x55f649eb0e8f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">assert_failed_inner</span><span class="p">::</span><span class="n">h77eb1113bacb0f31</span>
<span class="w">  </span><span class="mi">12</span><span class="p">:</span><span class="w">     </span><span class="mh">0x55f649e588af</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">assert_failed</span><span class="p">::</span><span class="n">he44b2686efc08dff</span>
<span class="w">  </span><span class="mi">13</span><span class="p">:</span><span class="w">     </span><span class="mh">0x55f64abe2d30</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wasmtime_cranelift</span><span class="p">::</span><span class="n">compiler</span><span class="p">::</span><span class="n">Compiler</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">wasmtime_environ</span><span class="p">::</span><span class="n">compile</span><span class="p">::</span><span class="n">Compiler</span><span class="o">&gt;</span><span class="p">::</span><span class="n">append_dwarf</span><span class="p">::</span><span class="n">h14d11c20fa9e5f82</span>
<span class="w">  </span><span class="mi">14</span><span class="p">:</span><span class="w">     </span><span class="mh">0x55f64aafb697</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">compile</span><span class="p">::</span><span class="n">FunctionIndices</span><span class="p">::</span><span class="n">link_and_append_code</span><span class="p">::</span><span class="n">hf766901eb87a60b8</span>
<span class="w">  </span><span class="mi">15</span><span class="p">:</span><span class="w">     </span><span class="mh">0x55f64aaf4c31</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">compile</span><span class="p">::</span><span class="n">build_artifacts</span><span class="p">::</span><span class="n">h1809dbb6af98174d</span>
<span class="w">  </span><span class="mi">16</span><span class="p">:</span><span class="w">     </span><span class="mh">0x55f64ab4360c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">ops</span><span class="p">::</span><span class="n">function</span><span class="p">::</span><span class="nb">FnOnce</span><span class="p">::</span><span class="n">call_once</span><span class="p">::</span><span class="n">h8f5620eee6192dd4</span>
<span class="w">  </span><span class="mi">17</span><span class="p">:</span><span class="w">     </span><span class="mh">0x55f64ab6bdc5</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_cache</span><span class="p">::</span><span class="n">ModuleCacheEntry</span><span class="p">::</span><span class="n">get_data_raw</span><span class="p">::</span><span class="n">h5918a4673179324b</span>
<span class="w">  </span><span class="mi">18</span><span class="p">:</span><span class="w">     </span><span class="mh">0x55f64ab4f059</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">compile</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">compile</span><span class="p">::</span><span class="n">code_builder</span><span class="p">::</span><span class="n">CodeBuilder</span><span class="o">&gt;</span><span class="p">::</span><span class="n">compile_module</span><span class="p">::</span><span class="n">h6cfb67fd1fb024ce</span>
<span class="w">  </span><span class="mi">19</span><span class="p">:</span><span class="w">     </span><span class="mh">0x55f649ee4dec</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_cli</span><span class="p">::</span><span class="n">common</span><span class="p">::</span><span class="n">RunCommon</span><span class="p">::</span><span class="n">load_module</span><span class="p">::</span><span class="n">h0243b5cafcaca8ef</span>
<span class="w">  </span><span class="mi">20</span><span class="p">:</span><span class="w">     </span><span class="mh">0x55f649fd2f2a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_cli</span><span class="p">::</span><span class="n">commands</span><span class="p">::</span><span class="n">run</span><span class="p">::</span><span class="n">RunCommand</span><span class="p">::</span><span class="n">execute</span><span class="p">::</span><span class="n">h741dadf6ee6383ad</span>
<span class="w">  </span><span class="mi">21</span><span class="p">:</span><span class="w">     </span><span class="mh">0x55f649eb9c01</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">Wasmtime</span><span class="p">::</span><span class="n">execute</span><span class="p">::</span><span class="n">h9f6abe47b919fe59</span>
<span class="w">  </span><span class="mi">22</span><span class="p">:</span><span class="w">     </span><span class="mh">0x55f649eb5088</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">old_cli</span><span class="p">::</span><span class="n">main</span><span class="p">::</span><span class="n">hbf2a698a610c379d</span>
<span class="w">  </span><span class="mi">23</span><span class="p">:</span><span class="w">     </span><span class="mh">0x55f649eb69a3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">sys_common</span><span class="p">::</span><span class="n">backtrace</span><span class="p">::</span><span class="n">__rust_begin_short_backtrace</span><span class="p">::</span><span class="n">h2d92647e84e7ad00</span>
<span class="w">  </span><span class="mi">24</span><span class="p">:</span><span class="w">     </span><span class="mh">0x55f649eb69bd</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">rt</span><span class="p">::</span><span class="n">lang_start</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}::</span><span class="n">h3b525ebc181e5daf</span>
<span class="w">  </span><span class="mi">25</span><span class="p">:</span><span class="w">     </span><span class="mh">0x55f64b228533</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">rt</span><span class="p">::</span><span class="n">lang_start_internal</span><span class="p">::</span><span class="n">hb867f343d27fa61e</span>
<span class="w">  </span><span class="mi">26</span><span class="p">:</span><span class="w">     </span><span class="mh">0x55f649ebb4a5</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">main</span>
<span class="w">  </span><span class="mi">27</span><span class="p">:</span><span class="w">     </span><span class="mh">0x7f85f8f3f24a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">__libc_start_call_main</span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">csu</span><span class="o">/../</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">nptl</span><span class="o">/</span><span class="n">libc_start_call_main</span><span class="p">.</span><span class="n">h</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">16</span>
<span class="w">  </span><span class="mi">28</span><span class="p">:</span><span class="w">     </span><span class="mh">0x7f85f8f3f305</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">__libc_start_main_impl</span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">csu</span><span class="o">/../</span><span class="n">csu</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="n">start</span><span class="p">.</span><span class="n">c</span><span class="p">:</span><span class="mi">360</span><span class="p">:</span><span class="mi">3</span>
<span class="w">  </span><span class="mi">29</span><span class="p">:</span><span class="w">     </span><span class="mh">0x55f649eb10c1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">_start</span>
<span class="w">  </span><span class="mi">30</span><span class="p">:</span><span class="w">                </span><span class="mh">0x0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: <code>wasmtime-cranelift-20.0.2</code></p>
<p>Operating system: Linux</p>
<p>Architecture: x86_64<br>
</p>
</blockquote>



<a name="443356834"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238652%20Cranelift%3A%20assertion%20%60left%20%3D%3D%20righ.../near/443356834" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238652.20Cranelift.3A.20assertion.20.60left.20.3D.3D.20righ.2E.2E.2E.html#443356834">(Jun 07 2024 at 19:14)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/8652#issuecomment-2155380405">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8652">issue #8652</a>:</p>
<blockquote>
<p>Thanks!</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>