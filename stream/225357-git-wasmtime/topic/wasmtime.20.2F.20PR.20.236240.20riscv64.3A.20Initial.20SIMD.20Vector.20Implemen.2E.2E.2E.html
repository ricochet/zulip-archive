<html>
<head><meta charset="utf-8"><title>wasmtime / PR #6240 riscv64: Initial SIMD Vector Implemen... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html">wasmtime / PR #6240 riscv64: Initial SIMD Vector Implemen...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="351027254"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351027254" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351027254">(Apr 19 2023 at 12:12)</a>:</h4>
<p>afonso360 opened <a href="https://github.com/bytecodealliance/wasmtime/pull/6240">PR #6240</a> from <code>afonso360:riscv-vector</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>This is the initial PR for implementing SIMD types with RISC-V Vectors, as described in #6118.</p>
<p>This PR implements only <code>iadd</code>,<code>load</code>,<code>store</code> for SIMD types, the minimum required to get an <code>iadd</code> runtest working.</p>
<p>We currently only support 128bit SIMD types, but It's really easy to change that to 64bit or 32bit or any other width SIMD types as long as they fit in a single register, so I'm also planning on doing that in a future PR.</p>
<p>I didn't include any calling conventions changes, so we have a non standard calling convention for now. The <a href="https://github.com/riscv-non-isa/riscv-elf-psabi-doc/blob/master/riscv-cc.adoc#vector-register-convention">RISC-V Calling Convention</a> passes everything via stack and does not use vector registers to pass arguments. We've inherited the Floating Point part of the calling convention, so we are passing arguments in vector registers. I didn't want to make the initial PR too large, so I decided to make that part of a future PR.</p>
<p>QEMU's register size is set to 256 bits to avoid accidentally depending on 128b vector registers in the future.</p>
</blockquote>



<a name="351027256"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351027256" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351027256">(Apr 19 2023 at 12:12)</a>:</h4>
<p><strong>afonso360</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6240">PR #6240</a>.</p>



<a name="351027257"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351027257" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351027257">(Apr 19 2023 at 12:12)</a>:</h4>
<p><strong>afonso360</strong> requested <a href="https://github.com/abrown">abrown</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6240">PR #6240</a>.</p>



<a name="351027258"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351027258" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351027258">(Apr 19 2023 at 12:12)</a>:</h4>
<p><strong>afonso360</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers">wasmtime-default-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6240">PR #6240</a>.</p>



<a name="351027535"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351027535" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351027535">(Apr 19 2023 at 12:13)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/6240#discussion_r1171248477">PR review comment</a>:</p>
<blockquote>
<p>This ends up generating a lot of instructions, and is far from ideal. But It's also what we do in regular loads/stores, so I figured it would be best to tackle those together in a future PR.</p>
</blockquote>



<a name="351027945"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351027945" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351027945">(Apr 19 2023 at 12:15)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/6240">PR #6240</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>This is the initial PR for implementing SIMD types with RISC-V Vectors, as described in #6118.</p>
<p>This PR implements only <code>iadd</code>,<code>load</code>,<code>store</code> for SIMD types, the minimum required to get an <code>iadd</code> runtest working.</p>
<p>We currently only support 128bit SIMD types, but It's really easy to change that to 64bit or 32bit or any other width SIMD types as long as they fit in a single register, so I'm also planning on doing that in a future PR.</p>
<p>I didn't include any calling conventions changes, so we have a non standard calling convention for now. The <a href="https://github.com/riscv-non-isa/riscv-elf-psabi-doc/blob/master/riscv-cc.adoc#vector-register-convention">RISC-V Calling Convention</a> passes everything via stack and does not use vector registers to pass arguments. We've inherited the Floating Point part of the calling convention, so we are passing arguments in vector registers. I didn't want to make the initial PR too large, so I decided to make that part of a future PR.</p>
<p>QEMU's register size is set to 256 bits to avoid accidentally depending on 128b vector registers in the future.</p>
<p>None of the vector instructions are recognized by capstone so they show up as <code>.byte</code> directives. I've been manually checking these agains <code>llvm-objdump</code>.</p>
</blockquote>



<a name="351027963"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351027963" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351027963">(Apr 19 2023 at 12:15)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/6240">PR #6240</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>This is the initial PR for implementing SIMD types with RISC-V Vectors, as described in #6118.</p>
<p>This PR implements only <code>iadd</code>,<code>load</code>,<code>store</code> for SIMD types, the minimum required to get an <code>iadd</code> runtest working.</p>
<p>We currently only support 128bit SIMD types, but It's really easy to change that to 64bit or 32bit or any other width SIMD types as long as they fit in a single register, so I'm also planning on doing that in a future PR.</p>
<p>I didn't include any calling conventions changes, so we have a non standard calling convention for now. The <a href="https://github.com/riscv-non-isa/riscv-elf-psabi-doc/blob/master/riscv-cc.adoc#vector-register-convention">RISC-V Calling Convention</a> passes everything via stack and does not use vector registers to pass arguments. We've inherited the Floating Point part of the calling convention, so we are passing arguments in vector registers. I didn't want to make the initial PR too large, so I decided to make that part of a future PR.</p>
<p>QEMU's register size is set to 256 bits to avoid accidentally depending on 128b vector registers in the future.</p>
<p>None of the vector instructions are recognized by capstone so they show up as <code>.byte</code> directives. I've been manually checking these against <code>llvm-objdump</code>.</p>
</blockquote>



<a name="351028636"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351028636" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351028636">(Apr 19 2023 at 12:18)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6240">PR #6240</a>.</p>



<a name="351030046"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351030046" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351030046">(Apr 19 2023 at 12:22)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6240">PR #6240</a>.</p>



<a name="351033888"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351033888" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351033888">(Apr 19 2023 at 12:35)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6240">PR #6240</a>.</p>



<a name="351091714"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351091714" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351091714">(Apr 19 2023 at 16:00)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6240#pullrequestreview-1392382350">PR review</a>:</p>
<blockquote>
<p>Some drive-by thoughts from me, but this great to see! Thanks for working on this!</p>
</blockquote>



<a name="351091718"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351091718" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351091718">(Apr 19 2023 at 16:00)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6240#pullrequestreview-1392382350">PR review</a>:</p>
<blockquote>
<p>Some drive-by thoughts from me, but this great to see! Thanks for working on this!</p>
</blockquote>



<a name="351091723"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351091723" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351091723">(Apr 19 2023 at 16:00)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/6240#discussion_r1171540017">PR review comment</a>:</p>
<blockquote>
<p>This might be a good candidate for a <code>(convert ...)</code> if it's going to show up a lot perhaps?</p>
</blockquote>



<a name="351091724"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351091724" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351091724">(Apr 19 2023 at 16:00)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/6240#discussion_r1171553001">PR review comment</a>:</p>
<blockquote>
<p>Food-for-thought question on this -- this is likely going to be quite common (everything gated by <code>has_v</code>), so one option would be to do what the x64 backend does today where if <code>enable_simd</code> is turned on then the code generator refuses to run unless <code>has_v</code> is enabled (or in x64's case it's SSE3, SSSE3, and SSE4.1). That being said I'm working to lowering x64's requirement to SSE2, the baseline for the architecture, at which point I was actually hoping on removing the <code>enable_simd</code> option altogether.</p>
<p>In any case though wanted to throw this out there if you thought that adding <code>has_v</code> everywhere was going to be onerous. I suppose though x64 also asserts, for each emitted instruction, that the required instruction sets are all enabled so that would probably need to be added to the risc-v backend to double-check that the <code>has_v</code> guards, while not present, still didn't lead to accidentally emitting a vector instruction.</p>
</blockquote>



<a name="351091725"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351091725" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351091725">(Apr 19 2023 at 16:00)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/6240#discussion_r1171545518">PR review comment</a>:</p>
<blockquote>
<p>The corresponding <code>VecElementWidth::from_type</code> in Rust is infallible, so should this perhaps not be <code>partial</code>? (or should the Rust version return <code>Option</code>?)</p>
<p>Sort of like above if this isn't <code>partial</code> it seems like it might be a good candidate for <code>(convert ...)</code> </p>
</blockquote>



<a name="351091726"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351091726" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351091726">(Apr 19 2023 at 16:00)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/6240#discussion_r1171538227">PR review comment</a>:</p>
<blockquote>
<p>We're on capstone 0.9 right now and it looks like the latest is 0.11, want to see if updating it would enable disassembling these instructions? If so I think it's reasonable to try to get in a <code>cargo vet</code> entry or an exemption since it's purely used during tests.</p>
</blockquote>



<a name="351098966"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351098966" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351098966">(Apr 19 2023 at 16:29)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/6240#discussion_r1171587645">PR review comment</a>:</p>
<blockquote>
<p>I tried to upgrade and rerun the tests, but It doesn't seem to have helped. I also looked in the docs for capstone to check if we needed to enable some additional feature, but I only found one for the <a href="https://docs.rs/capstone/latest/capstone/enum.ExtraMode.html#variant.RiscVC">Compressed extension</a>. So it looks like It still doesn't support it which is really unfortunate.</p>
</blockquote>



<a name="351101760"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351101760" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351101760">(Apr 19 2023 at 16:41)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/6240#discussion_r1171600494">PR review comment</a>:</p>
<blockquote>
<p>Ok now I'm a bit curious. Feel free to disregard this comment in the context of this PR as it's of course fine to have what's here and there's no need to deal with this for this PR.</p>
<p>First question though: how up-to-date is capstone in the Rust bindings? According to <a href="https://github.com/capstone-rust/capstone-rs/tree/master/capstone-sys/capstone/">this</a> the latest commit there is to update to <a href="https://github.com/capstone-engine/capstone/commit/3b2984212fe">https://github.com/capstone-engine/capstone/commit/3b2984212fe</a> which is almost a year-old at this point.</p>
<p>...</p>
<p>Ok nevermind answered my own question. I saw <code>include/riscv.h</code> in the Rust bindings but didn't see it on the <code>main</code> branch of the <code>capstone</code> repository. As the commit link above shows, though, there's a <code>next</code> branch which it looks like the Rust bindings are drawing from which does indeed have <code>include/riscv.h</code>. A quick scan of that header and I don't think there's V-related instructions, or at least I don't see a huge wad of <code>V</code>-prefixed instructions in that header, so it's likely that capstone itself doesn't have support for this yet.</p>
</blockquote>



<a name="351108542"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351108542" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351108542">(Apr 19 2023 at 17:10)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/6240#discussion_r1171631434">PR review comment</a>:</p>
<blockquote>
<p>Well, it is partial since CLIF technically supports <code>i128x{2,4,8,..}</code> vectors and we can't represent those here. But that seems like a weird edge case so I'm not sure if it's ok to ignore it.</p>
</blockquote>



<a name="351109958"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351109958" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351109958">(Apr 19 2023 at 17:15)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/6240#discussion_r1171631434">PR review comment</a>.</p>



<a name="351110048"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351110048" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351110048">(Apr 19 2023 at 17:16)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/6240#discussion_r1171631434">PR review comment</a>.</p>



<a name="351111976"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351111976" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351111976">(Apr 19 2023 at 17:25)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/6240#discussion_r1171649442">PR review comment</a>:</p>
<blockquote>
<p>From my naive point of view I'd say that i128-lanes should probably be removed rather than explicitly supported. That's just coming from my (limited) knowledge of the x64 and aarch64 backends which I think would quickly fall over if they were fed i128-lane vectors</p>
</blockquote>



<a name="351114310"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351114310" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351114310">(Apr 19 2023 at 17:35)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/6240#discussion_r1171663285">PR review comment</a>:</p>
<blockquote>
<p>Checking <code>has_v</code> everywhere is quite verbose. But I'm also in favor of deleting the <code>enable_simd</code> setting. (And <code>enable_float</code>!)</p>
<p>I was planning on adding a <code>ty_vec_fits_in_reg</code> extractor after this PR, to enable some more vector types (<code>i8x{2,4,..}</code>), I think restricting these instructions there would make some sense? i.e. if you don't have V, no vector type fits in a register.</p>
<p>Having that extension assert at emit time sounds like a good idea either way. </p>
</blockquote>



<a name="351114911"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351114911" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351114911">(Apr 19 2023 at 17:38)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/6240#discussion_r1171665967">PR review comment</a>:</p>
<blockquote>
<p>Sounds reasonable to me!</p>
</blockquote>



<a name="351114968"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351114968" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351114968">(Apr 19 2023 at 17:38)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/6240#discussion_r1171663285">PR review comment</a>.</p>



<a name="351124062"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351124062" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351124062">(Apr 19 2023 at 18:20)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6240">PR #6240</a>.</p>



<a name="351124767"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351124767" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351124767">(Apr 19 2023 at 18:24)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6240">PR #6240</a>.</p>



<a name="351125285"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351125285" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351125285">(Apr 19 2023 at 18:27)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/6240#discussion_r1171714712">PR review comment</a>:</p>
<blockquote>
<blockquote>
<p>Sort of like above if this isn't partial it seems like it might be a good candidate for (convert ...)</p>
</blockquote>
<p>I added the <code>convert</code> rule for this, but on a second thought, almost no instruction uses this. Most instructions get their element width from <code>vstate</code>. Loads and Stores are special in that they encode it in the opcode, with the reasoning being that, that would avoid unnecessarily switching states.</p>
<p>So, I'm not sure it's worth adding that. It also felt slightly weird passing <code>ty</code> into <code>vec_load</code> twice without any further description.</p>
</blockquote>



<a name="351133671"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351133671" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351133671">(Apr 19 2023 at 19:08)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/6240#discussion_r1171752250">PR review comment</a>:</p>
<blockquote>
<p>When turning on Capstone disassembly in precise-output filetests recently, we discussed that Capstone isn't particularly up to date on most targets. Its main advantage is that it supports a lot of targets. I believe consensus was that we'd be happy to switch disassemblers but nobody wants to spend time investigating alternatives. Also I think we don't know of any one disassembler that supports all our targets, although it wouldn't be awful to use a different disassembler for each target, either.</p>
</blockquote>



<a name="351341446"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351341446" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351341446">(Apr 20 2023 at 14:21)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6240#pullrequestreview-1394120699">PR review</a>:</p>
<blockquote>
<p>Out of curiosity, @afonso360 do you have a planned reviewer or set-of-reviewers for the SIMD support for RISC-V? If not I'm giving my stamp of approval here as this is well designed, comprehensively tested, and follows the design of <a href="https://github.com/bytecodealliance/wasmtime/issues/6118">https://github.com/bytecodealliance/wasmtime/issues/6118</a> as well (at least all in my own opinion). I'm happy of course though to defer to the more seasoned Cranelift developers as well too.</p>
</blockquote>



<a name="351400643"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351400643" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351400643">(Apr 20 2023 at 18:27)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6240#pullrequestreview-1394550723">PR review</a>:</p>
<blockquote>
<p>I'll add a second r+ for the <code>EmitState</code> bits to update implicit vector-machine state: they are indeed exactly how I expected them to be as well, and the infra is minimally intrusive. Thanks!</p>
</blockquote>



<a name="351400796"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351400796" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351400796">(Apr 20 2023 at 18:28)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6240#pullrequestreview-1394542093">PR review</a>:</p>
<blockquote>
<p>Oh, thanks for reminding me this is ready for review, Alex!</p>
<p>I have no concerns about the (quite minimal!) changes to the target-agnostic parts of Cranelift, and I think the implementation of the riscv-specific parts looks great too. I do have one question about the latter, but Afonso, I'll take your word for it either way. So feel free to merge if you're happy with it!</p>
</blockquote>



<a name="351400797"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351400797" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351400797">(Apr 20 2023 at 18:28)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6240#pullrequestreview-1394542093">PR review</a>:</p>
<blockquote>
<p>Oh, thanks for reminding me this is ready for review, Alex!</p>
<p>I have no concerns about the (quite minimal!) changes to the target-agnostic parts of Cranelift, and I think the implementation of the riscv-specific parts looks great too. I do have one question about the latter, but Afonso, I'll take your word for it either way. So feel free to merge if you're happy with it!</p>
</blockquote>



<a name="351400798"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351400798" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351400798">(Apr 20 2023 at 18:28)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/6240#discussion_r1172945409">PR review comment</a>:</p>
<blockquote>
<p>I'm not too familiar with how islands work, so: Does the emission of this instruction need to happen after <code>let mut start_off = sink.cur_offset();</code> below?</p>
</blockquote>



<a name="351434014"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351434014" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351434014">(Apr 20 2023 at 21:53)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/6240#discussion_r1173125562">PR review comment</a>:</p>
<blockquote>
<p>I think calling <code>emit</code> before that check is correct. Since we recurse into <code>Inst::emit</code> for the <code>vsetivli</code>, we pass through that check again before emitting the instruction, and then once that is emitted we check it again for the original instruction.</p>
</blockquote>



<a name="351434157"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351434157" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351434157">(Apr 20 2023 at 21:54)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/6240#discussion_r1173125562">PR review comment</a>.</p>



<a name="351438282"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236240%20riscv64%3A%20Initial%20SIMD%20Vector%20Implemen.../near/351438282" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236240.20riscv64.3A.20Initial.20SIMD.20Vector.20Implemen.2E.2E.2E.html#351438282">(Apr 20 2023 at 22:25)</a>:</h4>
<p>afonso360 merged <a href="https://github.com/bytecodealliance/wasmtime/pull/6240">PR #6240</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>