<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #1967 STATUS_BAD_STACK on Windows on trap · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231967.20STATUS_BAD_STACK.20on.20Windows.20on.20trap.html">wasmtime / Issue #1967 STATUS_BAD_STACK on Windows on trap</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="202705550"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231967%20STATUS_BAD_STACK%20on%20Windows%20on%20trap/near/202705550" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231967.20STATUS_BAD_STACK.20on.20Windows.20on.20trap.html#202705550">(Jul 02 2020 at 15:40)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/issues/1967">Issue #1967</a>:</p>
<blockquote>
<p>Originally reported at <a href="https://github.com/bytecodealliance/wasmtime-py/issues/36">https://github.com/bytecodealliance/wasmtime-py/issues/36</a> I'm able to reproduce this pretty easily with just <a href="https://github.com/bytecodealliance/wasmtime/files/4865263/yosys.wasm.gz">this wasm file</a>. Downloading that locally I can reproduce on Windows with:</p>
<div class="codehilite"><pre><span></span><code>$ gunzip yosys.wasm.gz
$ cargo run --release -- run yosys.wasm -- -V
...
    Finished release [optimized] target(s) in 3.84s
     Running `target\release\wasmtime.exe run yosys.wasm -- -V`
error: process didn&#39;t exit successfully: `target\release\wasmtime.exe run yosys.wasm -- -V` (exit code: 0xc0000028)
</code></pre></div>


<p>Something funny is going on here though because <code>--opt-level 0</code> does not reproduce the issue (<code>--opt-level 1</code> does though).</p>
<p>I'm trying to run this right now through <code>wasm-reduce</code> from Binaryen but so far it's only shaved off 3MB, which isn't a whole lot given the size of this binary...</p>
<p>@peterhuene I'm having trouble just opening things up in a debugger, would you be able to help look into this?</p>
</blockquote>



<a name="202705551"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231967%20STATUS_BAD_STACK%20on%20Windows%20on%20trap/near/202705551" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231967.20STATUS_BAD_STACK.20on.20Windows.20on.20trap.html#202705551">(Jul 02 2020 at 15:40)</a>:</h4>
<p>alexcrichton labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/1967">Issue #1967</a>:</p>
<blockquote>
<p>Originally reported at <a href="https://github.com/bytecodealliance/wasmtime-py/issues/36">https://github.com/bytecodealliance/wasmtime-py/issues/36</a> I'm able to reproduce this pretty easily with just <a href="https://github.com/bytecodealliance/wasmtime/files/4865263/yosys.wasm.gz">this wasm file</a>. Downloading that locally I can reproduce on Windows with:</p>
<div class="codehilite"><pre><span></span><code>$ gunzip yosys.wasm.gz
$ cargo run --release -- run yosys.wasm -- -V
...
    Finished release [optimized] target(s) in 3.84s
     Running `target\release\wasmtime.exe run yosys.wasm -- -V`
error: process didn&#39;t exit successfully: `target\release\wasmtime.exe run yosys.wasm -- -V` (exit code: 0xc0000028)
</code></pre></div>


<p>Something funny is going on here though because <code>--opt-level 0</code> does not reproduce the issue (<code>--opt-level 1</code> does though).</p>
<p>I'm trying to run this right now through <code>wasm-reduce</code> from Binaryen but so far it's only shaved off 3MB, which isn't a whole lot given the size of this binary...</p>
<p>@peterhuene I'm having trouble just opening things up in a debugger, would you be able to help look into this?</p>
</blockquote>



<a name="202705854"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231967%20STATUS_BAD_STACK%20on%20Windows%20on%20trap/near/202705854" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231967.20STATUS_BAD_STACK.20on.20Windows.20on.20trap.html#202705854">(Jul 02 2020 at 15:42)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/1967#issuecomment-653081682">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1967">Issue #1967</a>:</p>
<blockquote>
<p>I'll take a look.</p>
</blockquote>



<a name="202705890"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231967%20STATUS_BAD_STACK%20on%20Windows%20on%20trap/near/202705890" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231967.20STATUS_BAD_STACK.20on.20Windows.20on.20trap.html#202705890">(Jul 02 2020 at 15:42)</a>:</h4>
<p>peterhuene assigned <a href="https://github.com/bytecodealliance/wasmtime/issues/1967">Issue #1967</a> (assigned to peterhuene):</p>
<blockquote>
<p>Originally reported at <a href="https://github.com/bytecodealliance/wasmtime-py/issues/36">https://github.com/bytecodealliance/wasmtime-py/issues/36</a> I'm able to reproduce this pretty easily with just <a href="https://github.com/bytecodealliance/wasmtime/files/4865263/yosys.wasm.gz">this wasm file</a>. Downloading that locally I can reproduce on Windows with:</p>
<div class="codehilite"><pre><span></span><code>$ gunzip yosys.wasm.gz
$ cargo run --release -- run yosys.wasm -- -V
...
    Finished release [optimized] target(s) in 3.84s
     Running `target\release\wasmtime.exe run yosys.wasm -- -V`
error: process didn&#39;t exit successfully: `target\release\wasmtime.exe run yosys.wasm -- -V` (exit code: 0xc0000028)
</code></pre></div>


<p>Something funny is going on here though because <code>--opt-level 0</code> does not reproduce the issue (<code>--opt-level 1</code> does though).</p>
<p>I'm trying to run this right now through <code>wasm-reduce</code> from Binaryen but so far it's only shaved off 3MB, which isn't a whole lot given the size of this binary...</p>
<p>@peterhuene I'm having trouble just opening things up in a debugger, would you be able to help look into this?</p>
</blockquote>



<a name="202756994"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231967%20STATUS_BAD_STACK%20on%20Windows%20on%20trap/near/202756994" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231967.20STATUS_BAD_STACK.20on.20Windows.20on.20trap.html#202756994">(Jul 02 2020 at 23:58)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/1967#issuecomment-653265416">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1967">Issue #1967</a>:</p>
<blockquote>
<p>I've been digging into this most of today with not much to report yet.</p>
<p>The unwind information seems correct, as well as the stack aligning done in the prologues.</p>
<p>I haven't been able to form a minimal repro yet either.</p>
<p>The unwind is coming from the trap returned from WASI's proc_exit.</p>
<p>I'll keep at it.</p>
</blockquote>



<a name="202767937"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231967%20STATUS_BAD_STACK%20on%20Windows%20on%20trap/near/202767937" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231967.20STATUS_BAD_STACK.20on.20Windows.20on.20trap.html#202767937">(Jul 03 2020 at 04:30)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/1967#issuecomment-653339528">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1967">Issue #1967</a>:</p>
<blockquote>
<p>It appears the system unwinder can't get past the frame for <code>12746</code> for some yet-to-be-determined reason.</p>
<p>The Wasm frames that show up in the debugger prior to the <code>STATUS_BAD_STACK</code>:</p>
<ul>
<li>12469 (calls <code>wasi_snapshot_preview1.proc_exit</code>)</li>
<li>12504</li>
<li>12746 (JIT'd function is 96059 bytes!)</li>
</ul>
<p>The unwind stops there.</p>
<p>Prologue JIT for <code>12746</code>:</p>
<div class="codehilite"><pre><span></span><code>0000023CCCEAB200 48 8B 01             mov         rax,qword ptr [rcx]
0000023CCCEAB203 48 8B 00             mov         rax,qword ptr [rax]
0000023CCCEAB206 48 81 C0 68 06 00 00 add         rax,668h
0000023CCCEAB20D 48 39 E0             cmp         rax,rsp
0000023CCCEAB210 72 02                jb          0000023CCCEAB214
0000023CCCEAB212 0F 0B                ud2
0000023CCCEAB214 40 55                push        rbp
0000023CCCEAB216 48 89 E5             mov         rbp,rsp
0000023CCCEAB219 40 53                push        rbx
0000023CCCEAB21B 40 56                push        rsi
0000023CCCEAB21D 40 57                push        rdi
0000023CCCEAB21F 41 54                push        r12
0000023CCCEAB221 41 55                push        r13
0000023CCCEAB223 41 56                push        r14
0000023CCCEAB225 41 57                push        r15
0000023CCCEAB227 48 81 EC 68 06 00 00 sub         rsp,668h
0000023CCCEAB22E 44 0F 11 BC 24 50 06 00 00 movups      xmmword ptr [rsp+650h],xmm15
</code></pre></div>


<p>Function <code>12746</code> has the following encoded unwind information:</p>
<p>```<br>
01 37 0d 55 37 f8 00 00<br>
2e 01 cd 00 27 f0 25 e0<br>
23 d0 21 c0 1f 70 1d 60<br>
1b 30 19 03 16 50 00 00</p>
<div class="codehilite"><pre><span></span><code>Decoded:
</code></pre></div>


<p>Version: 1<br>
Prologue size: 55 bytes<br>
Unwind codes: 13<br>
Register frame: RBP<br>
Register frame offset: 80<br>
Codes:</p>
<p>- Prologue offset: 55 <br>
    Op: SaveXmm128 (note: operation is two unwind codes in length)<br>
    Reg: XMM15<br>
    Stack offset: 0</p>
<p>- Prologue offset:  46<br>
    Op: LargeStackAlloc (note: operation is two unwind codes in length)<br>
    Size: 668 bytes</p>
<p>- Prologue offset: 39<br>
    Op: PushNonvolatileRegister<br>
    Reg: R15</p>
<p>- Prologue offset: 37<br>
    Op: PushNonvolatileRegister<br>
    Reg: R14</p>
<p>- Prologue offset: 35<br>
    Op: PushNonvolatileRegister<br>
    Reg: R13</p>
<p>- Prologue offset: 33<br>
    Op: PushNonvolatileRegister<br>
    Reg: R12</p>
<p>- Prologue offset: 31<br>
    Op: PushNonvolatileRegister<br>
    Reg: RDI</p>
<p>- Prologue offset: 29<br>
    Op: PushNonvolatileRegister<br>
    Reg: RSI</p>
<p>- Prologue offset: 27<br>
    Op: PushNonvolatileRegister<br>
    Reg: RBX</p>
<p>- Prologue offset: 25<br>
    Op: SetFramePointer</p>
<p>- Prologue offset: 22<br>
    Op: PushNonvolatileRegister<br>
    Reg: RBP<br>
Alignment padding: 2 bytes</p>
<div class="codehilite"><pre><span></span><code>This is correct for the generated prologue.  I&#39;ve verified that the correct offset to the unwind information was registered with Windows for this function.

The stack allocation for the frame is correctly aligned: 1712 bytes, starting with call-pushed return address.

Note: there appears to be a bug in the stack check code as it&#39;s not taking into account the space needed for GPR saves (FPR saves are part of the stack allocation size).

Still digging.

~~~
</code></pre></div>


</blockquote>



<a name="202768009"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231967%20STATUS_BAD_STACK%20on%20Windows%20on%20trap/near/202768009" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231967.20STATUS_BAD_STACK.20on.20Windows.20on.20trap.html#202768009">(Jul 03 2020 at 04:33)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/1967#issuecomment-653339528">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1967">Issue #1967</a>:</p>
<blockquote>
<p>It appears the system unwinder can't get past the frame for <code>12746</code> for some yet-to-be-determined reason.</p>
<p>The Wasm frames that show up in the debugger prior to the <code>STATUS_BAD_STACK</code>:</p>
<ul>
<li>12469 (calls <code>wasi_snapshot_preview1.proc_exit</code>)</li>
<li>12504</li>
<li>12746 (JIT'd function is 96059 bytes!)</li>
</ul>
<p>The unwind stops there.</p>
<p>Prologue JIT for <code>12746</code>:</p>
<div class="codehilite"><pre><span></span><code>0000023CCCEAB200 48 8B 01             mov         rax,qword ptr [rcx]
0000023CCCEAB203 48 8B 00             mov         rax,qword ptr [rax]
0000023CCCEAB206 48 81 C0 68 06 00 00 add         rax,668h
0000023CCCEAB20D 48 39 E0             cmp         rax,rsp
0000023CCCEAB210 72 02                jb          0000023CCCEAB214
0000023CCCEAB212 0F 0B                ud2
0000023CCCEAB214 40 55                push        rbp
0000023CCCEAB216 48 89 E5             mov         rbp,rsp
0000023CCCEAB219 40 53                push        rbx
0000023CCCEAB21B 40 56                push        rsi
0000023CCCEAB21D 40 57                push        rdi
0000023CCCEAB21F 41 54                push        r12
0000023CCCEAB221 41 55                push        r13
0000023CCCEAB223 41 56                push        r14
0000023CCCEAB225 41 57                push        r15
0000023CCCEAB227 48 81 EC 68 06 00 00 sub         rsp,668h
0000023CCCEAB22E 44 0F 11 BC 24 50 06 00 00 movups      xmmword ptr [rsp+650h],xmm15
</code></pre></div>


<p>Function <code>12746</code> has the following encoded unwind information:</p>
<p>```<br>
01 37 0d 55 37 f8 00 00<br>
2e 01 cd 00 27 f0 25 e0<br>
23 d0 21 c0 1f 70 1d 60<br>
1b 30 19 03 16 50 00 00</p>
<div class="codehilite"><pre><span></span><code>Decoded:
</code></pre></div>


<p>Version: 1<br>
Prologue size: 55 bytes<br>
Unwind codes: 13<br>
Register frame: RBP<br>
Register frame offset: 80<br>
Codes:</p>
<p>- Prologue offset: 55 <br>
    Op: SaveXmm128 (note: operation is two unwind codes in length)<br>
    Reg: XMM15<br>
    Stack offset: 0</p>
<p>- Prologue offset:  46<br>
    Op: LargeStackAlloc (note: operation is two unwind codes in length)<br>
    Size: 668 bytes</p>
<p>- Prologue offset: 39<br>
    Op: PushNonvolatileRegister<br>
    Reg: R15</p>
<p>- Prologue offset: 37<br>
    Op: PushNonvolatileRegister<br>
    Reg: R14</p>
<p>- Prologue offset: 35<br>
    Op: PushNonvolatileRegister<br>
    Reg: R13</p>
<p>- Prologue offset: 33<br>
    Op: PushNonvolatileRegister<br>
    Reg: R12</p>
<p>- Prologue offset: 31<br>
    Op: PushNonvolatileRegister<br>
    Reg: RDI</p>
<p>- Prologue offset: 29<br>
    Op: PushNonvolatileRegister<br>
    Reg: RSI</p>
<p>- Prologue offset: 27<br>
    Op: PushNonvolatileRegister<br>
    Reg: RBX</p>
<p>- Prologue offset: 25<br>
    Op: SetFramePointer</p>
<p>- Prologue offset: 22<br>
    Op: PushNonvolatileRegister<br>
    Reg: RBP<br>
Alignment padding: 2 bytes</p>
<div class="codehilite"><pre><span></span><code>This is correct for the generated prologue.  I&#39;ve verified that the correct offset to the unwind information was registered with Windows for this function.

The stack allocation for the frame is correctly aligned: 1712 bytes, starting with call-pushed return address.

Note: there appears to be a bug in the stack check code as it&#39;s not taking into account the space needed for GPR saves (FPR saves are part of the stack allocation size).  That bug is unrelated and would only cause a missed stack overflow trap in the unlikely case that the stack allocation size would fit, but the GPR saves push it over the limit).

Still digging.

~~~
</code></pre></div>


</blockquote>



<a name="202768281"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231967%20STATUS_BAD_STACK%20on%20Windows%20on%20trap/near/202768281" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231967.20STATUS_BAD_STACK.20on.20Windows.20on.20trap.html#202768281">(Jul 03 2020 at 04:40)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/1967#issuecomment-653339528">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1967">Issue #1967</a>:</p>
<blockquote>
<p>It appears the system unwinder can't get past the frame for <code>12746</code> for some yet-to-be-determined reason.</p>
<p>The Wasm frames that show up in the debugger prior to the <code>STATUS_BAD_STACK</code>:</p>
<ul>
<li>12469 (calls <code>wasi_snapshot_preview1.proc_exit</code>)</li>
<li>12504</li>
<li>12746 (JIT'd function is 96059 bytes!)</li>
</ul>
<p>The unwind stops there.</p>
<p>Prologue JIT for <code>12746</code>:</p>
<div class="codehilite"><pre><span></span><code>0000023CCCEAB200 48 8B 01             mov         rax,qword ptr [rcx]
0000023CCCEAB203 48 8B 00             mov         rax,qword ptr [rax]
0000023CCCEAB206 48 81 C0 68 06 00 00 add         rax,668h
0000023CCCEAB20D 48 39 E0             cmp         rax,rsp
0000023CCCEAB210 72 02                jb          0000023CCCEAB214
0000023CCCEAB212 0F 0B                ud2
0000023CCCEAB214 40 55                push        rbp
0000023CCCEAB216 48 89 E5             mov         rbp,rsp
0000023CCCEAB219 40 53                push        rbx
0000023CCCEAB21B 40 56                push        rsi
0000023CCCEAB21D 40 57                push        rdi
0000023CCCEAB21F 41 54                push        r12
0000023CCCEAB221 41 55                push        r13
0000023CCCEAB223 41 56                push        r14
0000023CCCEAB225 41 57                push        r15
0000023CCCEAB227 48 81 EC 68 06 00 00 sub         rsp,668h
0000023CCCEAB22E 44 0F 11 BC 24 50 06 00 00 movups      xmmword ptr [rsp+650h],xmm15
</code></pre></div>


<p>Function <code>12746</code> has the following encoded unwind information:</p>
<p>```<br>
01 37 0d 55 37 f8 00 00<br>
2e 01 cd 00 27 f0 25 e0<br>
23 d0 21 c0 1f 70 1d 60<br>
1b 30 19 03 16 50 00 00</p>
<div class="codehilite"><pre><span></span><code>Decoded:
</code></pre></div>


<p>Version: 1<br>
Prologue size: 55 bytes<br>
Unwind codes: 13<br>
Register frame: RBP<br>
Register frame offset: 80<br>
Codes:</p>
<p>- Prologue offset: 55 <br>
    Op: SaveXmm128 (note: operation is two unwind codes in length)<br>
    Reg: XMM15<br>
    Stack offset: 0</p>
<p>- Prologue offset:  46<br>
    Op: LargeStackAlloc (note: operation is two unwind codes in length)<br>
    Size: 668 bytes</p>
<p>- Prologue offset: 39<br>
    Op: PushNonvolatileRegister<br>
    Reg: R15</p>
<p>- Prologue offset: 37<br>
    Op: PushNonvolatileRegister<br>
    Reg: R14</p>
<p>- Prologue offset: 35<br>
    Op: PushNonvolatileRegister<br>
    Reg: R13</p>
<p>- Prologue offset: 33<br>
    Op: PushNonvolatileRegister<br>
    Reg: R12</p>
<p>- Prologue offset: 31<br>
    Op: PushNonvolatileRegister<br>
    Reg: RDI</p>
<p>- Prologue offset: 29<br>
    Op: PushNonvolatileRegister<br>
    Reg: RSI</p>
<p>- Prologue offset: 27<br>
    Op: PushNonvolatileRegister<br>
    Reg: RBX</p>
<p>- Prologue offset: 25<br>
    Op: SetFramePointer</p>
<p>- Prologue offset: 22<br>
    Op: PushNonvolatileRegister<br>
    Reg: RBP<br>
Alignment padding: 2 bytes</p>
<div class="codehilite"><pre><span></span><code>This is correct for the generated prologue.  I&#39;ve verified that the correct offset to the unwind information was registered with Windows for this function.

The stack allocation for the frame is correctly aligned: 1712 bytes, starting with call-pushed return address.

Note: there appears to be a bug in the stack check code as it&#39;s not taking into account the space needed for GPR saves (FPR saves are part of the stack pointer adjustment).  That bug is unrelated and would only cause a missed stack overflow trap in the unlikely case that the stack allocation size would fit, but the GPR saves push it over the limit).

Still digging.

~~~
</code></pre></div>


</blockquote>



<a name="202774578"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231967%20STATUS_BAD_STACK%20on%20Windows%20on%20trap/near/202774578" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231967.20STATUS_BAD_STACK.20on.20Windows.20on.20trap.html#202774578">(Jul 03 2020 at 07:16)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/1967#issuecomment-653339528">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1967">Issue #1967</a>:</p>
<blockquote>
<p>It appears the system unwinder can't get past the frame for <code>12746</code> for some yet-to-be-determined reason.</p>
<p>The Wasm frames that show up in the debugger prior to the <code>STATUS_BAD_STACK</code>:</p>
<ul>
<li>12469 (calls <code>wasi_snapshot_preview1.proc_exit</code>)</li>
<li>12504</li>
<li>12746 (JIT'd function is 96059 bytes!)</li>
</ul>
<p>The unwind stops there.</p>
<p>Prologue JIT for <code>12746</code>:</p>
<div class="codehilite"><pre><span></span><code>0000023CCCEAB200 48 8B 01             mov         rax,qword ptr [rcx]
0000023CCCEAB203 48 8B 00             mov         rax,qword ptr [rax]
0000023CCCEAB206 48 81 C0 68 06 00 00 add         rax,668h
0000023CCCEAB20D 48 39 E0             cmp         rax,rsp
0000023CCCEAB210 72 02                jb          0000023CCCEAB214
0000023CCCEAB212 0F 0B                ud2
0000023CCCEAB214 40 55                push        rbp
0000023CCCEAB216 48 89 E5             mov         rbp,rsp
0000023CCCEAB219 40 53                push        rbx
0000023CCCEAB21B 40 56                push        rsi
0000023CCCEAB21D 40 57                push        rdi
0000023CCCEAB21F 41 54                push        r12
0000023CCCEAB221 41 55                push        r13
0000023CCCEAB223 41 56                push        r14
0000023CCCEAB225 41 57                push        r15
0000023CCCEAB227 48 81 EC 68 06 00 00 sub         rsp,668h
0000023CCCEAB22E 44 0F 11 BC 24 50 06 00 00 movups      xmmword ptr [rsp+650h],xmm15
</code></pre></div>


<p>Function <code>12746</code> has the following encoded unwind information:</p>
<p>```<br>
01 37 0d 55 37 f8 00 00<br>
2e 01 cd 00 27 f0 25 e0<br>
23 d0 21 c0 1f 70 1d 60<br>
1b 30 19 03 16 50 00 00</p>
<div class="codehilite"><pre><span></span><code>Decoded:
</code></pre></div>


<p>Version: 1<br>
Prologue size: 55 bytes<br>
Unwind codes: 13<br>
Frame pointer register: RBP<br>
Frame pointer offset: 80<br>
Codes:</p>
<p>- Prologue offset: 55 <br>
    Op: SaveXmm128 (note: operation is two unwind codes in length)<br>
    Reg: XMM15<br>
    Stack offset: 0</p>
<p>- Prologue offset:  46<br>
    Op: LargeStackAlloc (note: operation is two unwind codes in length)<br>
    Size: 668 bytes</p>
<p>- Prologue offset: 39<br>
    Op: PushNonvolatileRegister<br>
    Reg: R15</p>
<p>- Prologue offset: 37<br>
    Op: PushNonvolatileRegister<br>
    Reg: R14</p>
<p>- Prologue offset: 35<br>
    Op: PushNonvolatileRegister<br>
    Reg: R13</p>
<p>- Prologue offset: 33<br>
    Op: PushNonvolatileRegister<br>
    Reg: R12</p>
<p>- Prologue offset: 31<br>
    Op: PushNonvolatileRegister<br>
    Reg: RDI</p>
<p>- Prologue offset: 29<br>
    Op: PushNonvolatileRegister<br>
    Reg: RSI</p>
<p>- Prologue offset: 27<br>
    Op: PushNonvolatileRegister<br>
    Reg: RBX</p>
<p>- Prologue offset: 25<br>
    Op: SetFramePointer</p>
<p>- Prologue offset: 22<br>
    Op: PushNonvolatileRegister<br>
    Reg: RBP<br>
Alignment padding: 2 bytes</p>
<div class="codehilite"><pre><span></span><code>This is correct for the generated prologue.  I&#39;ve verified that the correct offset to the unwind information was registered with Windows for this function.

The stack allocation for the frame is correctly aligned: 1712 bytes, starting with call-pushed return address.

Note: there appears to be a bug in the stack check code as it&#39;s not taking into account the space needed for GPR saves (FPR saves are part of the stack pointer adjustment).  That bug is unrelated and would only cause a missed stack overflow trap in the unlikely case that the stack allocation size would fit, but the GPR saves push it over the limit).

Still digging.

~~~
</code></pre></div>


</blockquote>



<a name="202776542"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231967%20STATUS_BAD_STACK%20on%20Windows%20on%20trap/near/202776542" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231967.20STATUS_BAD_STACK.20on.20Windows.20on.20trap.html#202776542">(Jul 03 2020 at 07:48)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/1967#issuecomment-653405653">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1967">Issue #1967</a>:</p>
<blockquote>
<p>I've determined that the unwind information does not accurately describe the prologue after all.  As soon as I instruction step over establishing the frame pointer (e.g. <code>mov rbp,rsp</code>), stack walking fails.</p>
<p>The problem boils down to the way the unwind information is describing the frame pointer.  Wasmtime establishes a frame pointer like one would in the x86 days: it points at the push of the previous frame pointer and thus marks the start (highest stack address) of the local frame.</p>
<p>However, traditional frame pointers are rarely needed on Windows x64.  A "frame pointer" is really only established to mark a part of the frame as "statically-sized".  Positive offsets from this "frame pointer" would actually be in this static region of the local frame and <em>not</em> immediately the return address and caller's frame.  This is really important for functions that adjust the stack pointer in a way that can't be described in static unwind information (e.g. a function that calls <code>alloca</code>).</p>
<p>The bug is a result of my confusion regarding the Windows unwind information nomenclature of "frame pointer".  What the unwind information really intends to describe is the "base pointer to the static part of the local frame".</p>
<p>The fix should be to stop describing a "frame pointer" in the unwind information.  The frame pointer information in the unwind information will be changed to <code>0</code> and the <code>SetFramePointer</code> unwind code will not be emitted.  The offsets for the FPR saves will be changed to positive offsets from a post-adjusted RSP.</p>
</blockquote>



<a name="202776997"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231967%20STATUS_BAD_STACK%20on%20Windows%20on%20trap/near/202776997" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231967.20STATUS_BAD_STACK.20on.20Windows.20on.20trap.html#202776997">(Jul 03 2020 at 07:56)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/1967#issuecomment-653405653">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1967">Issue #1967</a>:</p>
<blockquote>
<p>I've determined that the unwind information does not accurately describe the prologue after all.  As soon as I instruction step over establishing the frame pointer (e.g. <code>mov rbp,rsp</code>), stack walking fails.</p>
<p>The problem boils down to the way the unwind information is describing the frame pointer.  Wasmtime establishes a frame pointer like one would in the x86 days: it points at the push of the previous frame pointer and thus marks the start (highest stack address) of the local frame.</p>
<p>However, traditional frame pointers are rarely needed on Windows x64.  A "frame pointer" is really only established to mark a part of the frame as "statically-sized".  Positive offsets from this "frame pointer" would actually be in this static region of the local frame and <em>not</em> immediately the return address and caller's frame.  This is really important for functions that adjust the stack pointer in a way that can't be described in static unwind information (e.g. a function that calls <code>alloca</code>).</p>
<p>The bug is a result of my confusion regarding the Windows unwind information nomenclature of "frame pointer".  What the unwind information really intends to describe is the "base pointer to the static part of the local frame".  As such, Windows really is expecting an actual offset from RSP when establishing the frame pointer (e.g. <code>lea rbp, [rsp-0x50]</code> in this case) which we're obviously not doing.</p>
<p>The fix should be to stop describing a "frame pointer" in the unwind information.  The frame pointer information in the unwind information will be changed to <code>0</code> and the <code>SetFramePointer</code> unwind code will not be emitted.  The offsets for the FPR saves will be changed to positive offsets from a post-adjusted RSP.</p>
</blockquote>



<a name="202777288"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231967%20STATUS_BAD_STACK%20on%20Windows%20on%20trap/near/202777288" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231967.20STATUS_BAD_STACK.20on.20Windows.20on.20trap.html#202777288">(Jul 03 2020 at 08:00)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/1967#issuecomment-653405653">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1967">Issue #1967</a>:</p>
<blockquote>
<p>I've determined that the unwind information does not accurately describe the prologue after all.  As soon as I instruction step over establishing the frame pointer (e.g. <code>mov rbp,rsp</code>), stack walking fails.</p>
<p>The problem boils down to the way the unwind information is describing the frame pointer for frames with FPR saves.  Wasmtime establishes a frame pointer like one would in the x86 days: it points at the push of the previous frame pointer and thus marks the start (highest stack address) of the local frame.</p>
<p>However, traditional frame pointers are rarely needed on Windows x64.  A "frame pointer" is really only established to mark a part of the frame as "statically-sized".  Positive offsets from this "frame pointer" would actually be in this static region of the local frame and <em>not</em> immediately the return address and caller's frame.  This is really important for functions that adjust the stack pointer in a way that can't be described in static unwind information (e.g. a function that calls <code>alloca</code>).</p>
<p>The bug is a result of my confusion regarding the Windows unwind information nomenclature of "frame pointer".  What the unwind information really intends to describe is the "base pointer to the static part of the local frame".  As such, Windows really is expecting an actual offset from RSP when establishing the frame pointer (e.g. <code>lea rbp, [rsp-0x50]</code> in this case) which we're obviously not doing.</p>
<p>The fix should be to stop describing a "frame pointer" in the unwind information.  The frame pointer information in the unwind information will be changed to <code>0</code> and the <code>SetFramePointer</code> unwind code will not be emitted.  The offsets for the FPR saves will be changed to positive offsets from a post-adjusted RSP.</p>
</blockquote>



<a name="202777656"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231967%20STATUS_BAD_STACK%20on%20Windows%20on%20trap/near/202777656" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231967.20STATUS_BAD_STACK.20on.20Windows.20on.20trap.html#202777656">(Jul 03 2020 at 08:04)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/1967#issuecomment-653405653">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1967">Issue #1967</a>:</p>
<blockquote>
<p>I've determined that the unwind information does not accurately describe the prologue after all.  As soon as I instruction step over establishing the frame pointer (e.g. <code>mov rbp,rsp</code>), stack walking fails.</p>
<p>The problem boils down to the way the unwind information is describing the frame pointer for frames with FPR saves.  Cranelift establishes a frame pointer like one would in the x86 days: it points at the push of the previous frame pointer and thus marks the start (highest stack address) of the local frame.</p>
<p>However, traditional frame pointers are rarely needed on Windows x64.  A "frame pointer" is really only established to mark a part of the frame as "statically-sized".  Positive offsets from this "frame pointer" would actually be in this static region of the local frame and <em>not</em> immediately the return address and caller's frame.  This is really important for functions that adjust the stack pointer in a way that can't be described in static unwind information (e.g. a function that calls <code>alloca</code>).</p>
<p>The bug is a result of my confusion regarding the Windows unwind information nomenclature of "frame pointer".  What the unwind information really intends to describe is the "base pointer to the static part of the local frame".  As such, Windows really is expecting an actual offset from RSP when establishing the frame pointer (e.g. <code>lea rbp, [rsp-0x50]</code> in this case) which we're obviously not doing.</p>
<p>The fix should be to stop describing a "frame pointer" in the unwind information.  The frame pointer information in the unwind information will be changed to <code>0</code> and the <code>SetFramePointer</code> unwind code will not be emitted.  The offsets for the FPR saves will be changed to positive offsets from a post-adjusted RSP.</p>
</blockquote>



<a name="202893376"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231967%20STATUS_BAD_STACK%20on%20Windows%20on%20trap/near/202893376" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231967.20STATUS_BAD_STACK.20on.20Windows.20on.20trap.html#202893376">(Jul 04 2020 at 22:05)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/1967#issuecomment-653817481">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1967">Issue #1967</a>:</p>
<blockquote>
<p>I have a fix available, but I need to add a test case where we have a trap with frames that have FPR saves so that we don't regress this.</p>
</blockquote>



<a name="203027214"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231967%20STATUS_BAD_STACK%20on%20Windows%20on%20trap/near/203027214" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231967.20STATUS_BAD_STACK.20on.20Windows.20on.20trap.html#203027214">(Jul 06 2020 at 18:55)</a>:</h4>
<p>peterhuene labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/1967">Issue #1967</a> (assigned to peterhuene):</p>
<blockquote>
<p>Originally reported at <a href="https://github.com/bytecodealliance/wasmtime-py/issues/36">https://github.com/bytecodealliance/wasmtime-py/issues/36</a> I'm able to reproduce this pretty easily with just <a href="https://github.com/bytecodealliance/wasmtime/files/4865263/yosys.wasm.gz">this wasm file</a>. Downloading that locally I can reproduce on Windows with:</p>
<div class="codehilite"><pre><span></span><code>$ gunzip yosys.wasm.gz
$ cargo run --release -- run yosys.wasm -- -V
...
    Finished release [optimized] target(s) in 3.84s
     Running `target\release\wasmtime.exe run yosys.wasm -- -V`
error: process didn&#39;t exit successfully: `target\release\wasmtime.exe run yosys.wasm -- -V` (exit code: 0xc0000028)
</code></pre></div>


<p>Something funny is going on here though because <code>--opt-level 0</code> does not reproduce the issue (<code>--opt-level 1</code> does though).</p>
<p>I'm trying to run this right now through <code>wasm-reduce</code> from Binaryen but so far it's only shaved off 3MB, which isn't a whole lot given the size of this binary...</p>
<p>@peterhuene I'm having trouble just opening things up in a debugger, would you be able to help look into this?</p>
</blockquote>



<a name="203068111"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231967%20STATUS_BAD_STACK%20on%20Windows%20on%20trap/near/203068111" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231967.20STATUS_BAD_STACK.20on.20Windows.20on.20trap.html#203068111">(Jul 07 2020 at 05:26)</a>:</h4>
<p>peterhuene closed <a href="https://github.com/bytecodealliance/wasmtime/issues/1967">Issue #1967</a> (assigned to peterhuene):</p>
<blockquote>
<p>Originally reported at <a href="https://github.com/bytecodealliance/wasmtime-py/issues/36">https://github.com/bytecodealliance/wasmtime-py/issues/36</a> I'm able to reproduce this pretty easily with just <a href="https://github.com/bytecodealliance/wasmtime/files/4865263/yosys.wasm.gz">this wasm file</a>. Downloading that locally I can reproduce on Windows with:</p>
<div class="codehilite"><pre><span></span><code>$ gunzip yosys.wasm.gz
$ cargo run --release -- run yosys.wasm -- -V
...
    Finished release [optimized] target(s) in 3.84s
     Running `target\release\wasmtime.exe run yosys.wasm -- -V`
error: process didn&#39;t exit successfully: `target\release\wasmtime.exe run yosys.wasm -- -V` (exit code: 0xc0000028)
</code></pre></div>


<p>Something funny is going on here though because <code>--opt-level 0</code> does not reproduce the issue (<code>--opt-level 1</code> does though).</p>
<p>I'm trying to run this right now through <code>wasm-reduce</code> from Binaryen but so far it's only shaved off 3MB, which isn't a whole lot given the size of this binary...</p>
<p>@peterhuene I'm having trouble just opening things up in a debugger, would you be able to help look into this?</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>