<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #2009 Opening files with O_TRUNC does no... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232009.20Opening.20files.20with.20O_TRUNC.20does.20no.2E.2E.2E.html">wasmtime / Issue #2009 Opening files with O_TRUNC does no...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="203516147"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232009%20Opening%20files%20with%20O_TRUNC%20does%20no.../near/203516147" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232009.20Opening.20files.20with.20O_TRUNC.20does.20no.2E.2E.2E.html#203516147">(Jul 10 2020 at 14:52)</a>:</h4>
<p>whitequark opened <a href="https://github.com/bytecodealliance/wasmtime/issues/2009">Issue #2009</a>:</p>
<blockquote>
<p>Consider the following program:</p>
<div class="codehilite"><pre><span></span><code>#include &lt;fstream&gt;

int main() {
    std::ofstream ff;
    ff.open(&quot;test.txt&quot;, std::ofstream::trunc);
    ff &lt;&lt; &quot;bad bad bad bad\n&quot;;
    return 0;
}
</code></pre></div>


<p>I've attached it here:  <a href="https://github.com/bytecodealliance/wasmtime/files/4903795/bad.zip">bad.zip</a></p>
<p>Open <code>test.txt</code> and put something like this there:</p>
<div class="codehilite"><pre><span></span><code>bad bad bad bad
this will remain here
</code></pre></div>


<p>Run it:</p>
<div class="codehilite"><pre><span></span><code>wasmtime run --dir . bad.wasm
</code></pre></div>


<p>The file is not truncated.</p>
</blockquote>



<a name="203516148"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232009%20Opening%20files%20with%20O_TRUNC%20does%20no.../near/203516148" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232009.20Opening.20files.20with.20O_TRUNC.20does.20no.2E.2E.2E.html#203516148">(Jul 10 2020 at 14:52)</a>:</h4>
<p>whitequark labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/2009">Issue #2009</a>:</p>
<blockquote>
<p>Consider the following program:</p>
<div class="codehilite"><pre><span></span><code>#include &lt;fstream&gt;

int main() {
    std::ofstream ff;
    ff.open(&quot;test.txt&quot;, std::ofstream::trunc);
    ff &lt;&lt; &quot;bad bad bad bad\n&quot;;
    return 0;
}
</code></pre></div>


<p>I've attached it here:  <a href="https://github.com/bytecodealliance/wasmtime/files/4903795/bad.zip">bad.zip</a></p>
<p>Open <code>test.txt</code> and put something like this there:</p>
<div class="codehilite"><pre><span></span><code>bad bad bad bad
this will remain here
</code></pre></div>


<p>Run it:</p>
<div class="codehilite"><pre><span></span><code>wasmtime run --dir . bad.wasm
</code></pre></div>


<p>The file is not truncated.</p>
</blockquote>



<a name="203516158"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232009%20Opening%20files%20with%20O_TRUNC%20does%20no.../near/203516158" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232009.20Opening.20files.20with.20O_TRUNC.20does.20no.2E.2E.2E.html#203516158">(Jul 10 2020 at 14:52)</a>:</h4>
<p>whitequark edited <a href="https://github.com/bytecodealliance/wasmtime/issues/2009">Issue #2009</a>:</p>
<blockquote>
<p>Consider the following program:</p>
<div class="codehilite"><pre><span></span><code>#include &lt;fstream&gt;

int main() {
    std::ofstream ff;
    ff.open(&quot;test.txt&quot;, std::ofstream::trunc);
    ff &lt;&lt; &quot;bad bad bad bad\n&quot;;
    return 0;
}
</code></pre></div>


<p>I've attached it here:  <a href="https://github.com/bytecodealliance/wasmtime/files/4903795/bad.zip">bad.zip</a></p>
<p>Open <code>test.txt</code> and put something like this there:</p>
<div class="codehilite"><pre><span></span><code>bad bad bad bad
this will remain here
</code></pre></div>


<p>Run it:</p>
<div class="codehilite"><pre><span></span><code>wasmtime run --dir . bad.wasm
</code></pre></div>


<p>The file is not truncated.</p>
</blockquote>



<a name="203516480"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232009%20Opening%20files%20with%20O_TRUNC%20does%20no.../near/203516480" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232009.20Opening.20files.20with.20O_TRUNC.20does.20no.2E.2E.2E.html#203516480">(Jul 10 2020 at 14:54)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/2009#issuecomment-656718441">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2009">Issue #2009</a>:</p>
<blockquote>
<p>Here's the WASI call log:</p>
<div class="codehilite"><pre><span></span><code> DEBUG wasi_common::ctx &gt; WasiCtx inserting entry PendingEntry::Thunk(0x32cde8)
 DEBUG wasi_common::ctx &gt; WasiCtx inserted at Fd(0)
 DEBUG wasi_common::ctx &gt; WasiCtx inserting entry PendingEntry::Thunk(0x32cde8)
 DEBUG wasi_common::ctx &gt; WasiCtx inserted at Fd(1)
 DEBUG wasi_common::ctx &gt; WasiCtx inserting entry PendingEntry::Thunk(0x32cde8)
 DEBUG wasi_common::ctx &gt; WasiCtx inserted at Fd(2)
 DEBUG wasi_common::ctx &gt; WasiCtx inserted at Fd(3)
 DEBUG wasi_common::old::snapshot_0::ctx &gt; WasiCtx inserting (0, Some(PendingEntry::Thunk(0x32d058)))
 DEBUG wasi_common::old::snapshot_0::ctx &gt; WasiCtx inserting (1, Some(PendingEntry::Thunk(0x32d068)))
 DEBUG wasi_common::old::snapshot_0::ctx &gt; WasiCtx inserting (2, Some(PendingEntry::Thunk(0x32d078)))
 DEBUG wasi_common::old::snapshot_0::ctx &gt; WasiCtx inserting (3, Entry { file_type: 3, descriptor: OsHandle(OsHandle(File { handle: 0x5c, path: &quot;\\\\?\\Z:\\home\\whitequark\\xxx\\build&quot; })), rights_base: 264240858, rights_inheriting: 268435455, preopen_path: Some(&quot;.&quot;) })
 DEBUG wasi_common::old::snapshot_0::ctx &gt; WasiCtx entries = {0: Entry { file_type: 2, descriptor: Stdin, rights_base: 136314954, rights_inheriting: 136314954, preopen_path: None }, 3: Entry { file_type: 3, descriptor: OsHandle(OsHandle(File { handle: 0x5c, path: &quot;\\\\?\\Z:\\home\\whitequark\\xxx\\build&quot; })), rights_base: 264240858, rights_inheriting: 268435455, preopen_path: Some(&quot;.&quot;) }, 1: Entry { file_type: 2, descriptor: Stdout, rights_base: 136314954, rights_inheriting: 136314954, preopen_path: None }, 2: Entry { file_type: 2, descriptor: Stderr, rights_base: 136314954, rights_inheriting: 136314954, preopen_path: None }}
 TRACE wasi_common::wasi::wasi_snapshot_preview1 &gt; wiggle abi; module=&quot;wasi_snapshot_preview1&quot; function=&quot;fd_prestat_get&quot;
 TRACE wasi_common::wasi::wasi_snapshot_preview1 &gt; fd=Fd(3)
 TRACE wasi_common::wasi::wasi_snapshot_preview1 &gt; buf=Dir(PrestatDir { pr_name_len: 1 })
 TRACE wasi_common::wasi::wasi_snapshot_preview1 &gt; success=No error occurred. System call completed successfully. (Errno::Success(0))
 TRACE wasi_common::wasi::wasi_snapshot_preview1 &gt; wiggle abi; module=&quot;wasi_snapshot_preview1&quot; function=&quot;fd_prestat_dir_name&quot;
 TRACE wasi_common::wasi::wasi_snapshot_preview1 &gt; fd=Fd(3) path=*guest 0x20010 path_len=1
 TRACE wasi_common::snapshots::wasi_snapshot_preview1 &gt;      | path=&#39;.&#39;
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; success=No error occurred. System call completed successfully. (Errno::Success(0))
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; wiggle abi; module=&quot;wasi_snapshot_preview1&quot; function=&quot;fd_prestat_get&quot;
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; fd=Fd(4)
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; error=Badf
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; wiggle abi; module=&quot;wasi_snapshot_preview1&quot; function=&quot;fd_fdstat_get&quot;
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; fd=Fd(3)
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; stat=Fdstat { fs_filetype: Directory, fs_flags: Fdflags(0), fs_rights_base: Rights(264240858), fs_rights_inheriting: Rights(268435455) }
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; success=No error occurred. System call completed successfully. (Errno::Success(0))
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; wiggle abi; module=&quot;wasi_snapshot_preview1&quot; function=&quot;path_open&quot;
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; fd=Fd(3) dirflags=symlink_follow (0x1) path=*guest 0x400/8 oflags=creat|trunc (0x9) fs_rights_base=fd_datasync|fd_seek|fd_fdstat_set_flags|fd_sync|fd_tell|fd_write|fd_advise|fd_allocate|path_create_directory|path_create_file|path_link_source|path_link_target|path_open|path_readlink|path_rename_source|path_rename_target|path_filestat_get|path_filestat_set_size|path_filestat_set_times|fd_filestat_get|fd_filestat_set_size|fd_filestat_set_times|path_symlink|path_remove_directory|path_unlink_file|poll_fd_readwrite (0xfffbffd) fs_rights_inherting=fd_datasync|fd_read|fd_seek|fd_fdstat_set_flags|fd_sync|fd_tell|fd_write|fd_advise|fd_allocate|path_create_directory|path_create_file|path_link_source|path_link_target|path_open|fd_readdir|path_readlink|path_rename_source|path_rename_target|path_filestat_get|path_filestat_set_size|path_filestat_set_times|fd_filestat_get|fd_filestat_set_size|fd_filestat_set_times|path_symlink|path_remove_directory|path_unlink_file|poll_fd_readwrite (0xfffffff) fdflags=empty (0x0)
 TRACE wasi_common::snapshots::wasi_snapshot_preview1 &gt;      | needed_rights=HandleRights { base: path_create_file|path_open (0x2400), inheriting: fd_datasync|fd_read|fd_seek|fd_fdstat_set_flags|fd_sync|fd_tell|fd_write|fd_advise|fd_allocate|path_create_directory|path_create_file|path_link_source|path_link_target|path_open|fd_readdir|path_readlink|path_rename_source|path_rename_target|path_filestat_get|path_filestat_set_size|path_filestat_set_times|fd_filestat_get|fd_filestat_set_size|fd_filestat_set_times|path_symlink|path_remove_directory|path_unlink_file|poll_fd_readwrite (0xfffffff) }
 TRACE wasi_common::path                              &gt;      | (path_ptr,path_len)=&#39;test.txt&#39;
 DEBUG wasi_common::path                              &gt; path_get cur_path = &quot;test.txt&quot;
 DEBUG wasi_common::path                              &gt; path_get path_stack = []
 DEBUG wasi_common::sys::windows::path                &gt; out_path=&quot;Z:\\home\\whitequark\\xxx\\build\\test.txt&quot;
 DEBUG wasi_common::sys::windows::path                &gt; readlinkat error=50
 TRACE wasi_common::snapshots::wasi_snapshot_preview1 &gt;      | calling path_open impl: read=false, write=true
 DEBUG wasi_common::sys::windows::path                &gt; out_path=&quot;Z:\\home\\whitequark\\xxx\\build\\test.txt&quot;
 DEBUG wasi_common::sys                               &gt; Created new instance of OsFile: OsFile { rights: Cell { value: HandleRights { base: Rights(148898303), inheriting: Rights(0) } }, handle: RawOsHandle(Cell { value: 0x64 }) }
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; opened_fd=Fd(4)
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; success=No error occurred. System call completed successfully. (Errno::Success(0))
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; wiggle abi; module=&quot;wasi_snapshot_preview1&quot; function=&quot;fd_fdstat_get&quot;
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; fd=Fd(4)
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; stat=Fdstat { fs_filetype: RegularFile, fs_flags: Fdflags(0), fs_rights_base: Rights(148898301), fs_rights_inheriting: Rights(0) }
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; success=No error occurred. System call completed successfully. (Errno::Success(0))
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; wiggle abi; module=&quot;wasi_snapshot_preview1&quot; function=&quot;fd_write&quot;
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; fd=Fd(4) iovs=*guest 0x150b0/2
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; nwritten=16
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; success=No error occurred. System call completed successfully. (Errno::Success(0))
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; wiggle abi; module=&quot;wasi_snapshot_preview1&quot; function=&quot;fd_close&quot;
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; fd=Fd(4)
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; success=No error occurred. System call completed successfully. (Errno::Success(0))
</code></pre></div>


</blockquote>



<a name="203516526"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232009%20Opening%20files%20with%20O_TRUNC%20does%20no.../near/203516526" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232009.20Opening.20files.20with.20O_TRUNC.20does.20no.2E.2E.2E.html#203516526">(Jul 10 2020 at 14:55)</a>:</h4>
<p>whitequark edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/2009#issuecomment-656718441">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2009">Issue #2009</a>:</p>
<blockquote>
<p>Here's the WASI call log (this is on wine, but I'm triaging a bug report from someone who hits it on Windows):</p>
<div class="codehilite"><pre><span></span><code> DEBUG wasi_common::ctx &gt; WasiCtx inserting entry PendingEntry::Thunk(0x32cde8)
 DEBUG wasi_common::ctx &gt; WasiCtx inserted at Fd(0)
 DEBUG wasi_common::ctx &gt; WasiCtx inserting entry PendingEntry::Thunk(0x32cde8)
 DEBUG wasi_common::ctx &gt; WasiCtx inserted at Fd(1)
 DEBUG wasi_common::ctx &gt; WasiCtx inserting entry PendingEntry::Thunk(0x32cde8)
 DEBUG wasi_common::ctx &gt; WasiCtx inserted at Fd(2)
 DEBUG wasi_common::ctx &gt; WasiCtx inserted at Fd(3)
 DEBUG wasi_common::old::snapshot_0::ctx &gt; WasiCtx inserting (0, Some(PendingEntry::Thunk(0x32d058)))
 DEBUG wasi_common::old::snapshot_0::ctx &gt; WasiCtx inserting (1, Some(PendingEntry::Thunk(0x32d068)))
 DEBUG wasi_common::old::snapshot_0::ctx &gt; WasiCtx inserting (2, Some(PendingEntry::Thunk(0x32d078)))
 DEBUG wasi_common::old::snapshot_0::ctx &gt; WasiCtx inserting (3, Entry { file_type: 3, descriptor: OsHandle(OsHandle(File { handle: 0x5c, path: &quot;\\\\?\\Z:\\home\\whitequark\\xxx\\build&quot; })), rights_base: 264240858, rights_inheriting: 268435455, preopen_path: Some(&quot;.&quot;) })
 DEBUG wasi_common::old::snapshot_0::ctx &gt; WasiCtx entries = {0: Entry { file_type: 2, descriptor: Stdin, rights_base: 136314954, rights_inheriting: 136314954, preopen_path: None }, 3: Entry { file_type: 3, descriptor: OsHandle(OsHandle(File { handle: 0x5c, path: &quot;\\\\?\\Z:\\home\\whitequark\\xxx\\build&quot; })), rights_base: 264240858, rights_inheriting: 268435455, preopen_path: Some(&quot;.&quot;) }, 1: Entry { file_type: 2, descriptor: Stdout, rights_base: 136314954, rights_inheriting: 136314954, preopen_path: None }, 2: Entry { file_type: 2, descriptor: Stderr, rights_base: 136314954, rights_inheriting: 136314954, preopen_path: None }}
 TRACE wasi_common::wasi::wasi_snapshot_preview1 &gt; wiggle abi; module=&quot;wasi_snapshot_preview1&quot; function=&quot;fd_prestat_get&quot;
 TRACE wasi_common::wasi::wasi_snapshot_preview1 &gt; fd=Fd(3)
 TRACE wasi_common::wasi::wasi_snapshot_preview1 &gt; buf=Dir(PrestatDir { pr_name_len: 1 })
 TRACE wasi_common::wasi::wasi_snapshot_preview1 &gt; success=No error occurred. System call completed successfully. (Errno::Success(0))
 TRACE wasi_common::wasi::wasi_snapshot_preview1 &gt; wiggle abi; module=&quot;wasi_snapshot_preview1&quot; function=&quot;fd_prestat_dir_name&quot;
 TRACE wasi_common::wasi::wasi_snapshot_preview1 &gt; fd=Fd(3) path=*guest 0x20010 path_len=1
 TRACE wasi_common::snapshots::wasi_snapshot_preview1 &gt;      | path=&#39;.&#39;
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; success=No error occurred. System call completed successfully. (Errno::Success(0))
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; wiggle abi; module=&quot;wasi_snapshot_preview1&quot; function=&quot;fd_prestat_get&quot;
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; fd=Fd(4)
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; error=Badf
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; wiggle abi; module=&quot;wasi_snapshot_preview1&quot; function=&quot;fd_fdstat_get&quot;
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; fd=Fd(3)
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; stat=Fdstat { fs_filetype: Directory, fs_flags: Fdflags(0), fs_rights_base: Rights(264240858), fs_rights_inheriting: Rights(268435455) }
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; success=No error occurred. System call completed successfully. (Errno::Success(0))
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; wiggle abi; module=&quot;wasi_snapshot_preview1&quot; function=&quot;path_open&quot;
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; fd=Fd(3) dirflags=symlink_follow (0x1) path=*guest 0x400/8 oflags=creat|trunc (0x9) fs_rights_base=fd_datasync|fd_seek|fd_fdstat_set_flags|fd_sync|fd_tell|fd_write|fd_advise|fd_allocate|path_create_directory|path_create_file|path_link_source|path_link_target|path_open|path_readlink|path_rename_source|path_rename_target|path_filestat_get|path_filestat_set_size|path_filestat_set_times|fd_filestat_get|fd_filestat_set_size|fd_filestat_set_times|path_symlink|path_remove_directory|path_unlink_file|poll_fd_readwrite (0xfffbffd) fs_rights_inherting=fd_datasync|fd_read|fd_seek|fd_fdstat_set_flags|fd_sync|fd_tell|fd_write|fd_advise|fd_allocate|path_create_directory|path_create_file|path_link_source|path_link_target|path_open|fd_readdir|path_readlink|path_rename_source|path_rename_target|path_filestat_get|path_filestat_set_size|path_filestat_set_times|fd_filestat_get|fd_filestat_set_size|fd_filestat_set_times|path_symlink|path_remove_directory|path_unlink_file|poll_fd_readwrite (0xfffffff) fdflags=empty (0x0)
 TRACE wasi_common::snapshots::wasi_snapshot_preview1 &gt;      | needed_rights=HandleRights { base: path_create_file|path_open (0x2400), inheriting: fd_datasync|fd_read|fd_seek|fd_fdstat_set_flags|fd_sync|fd_tell|fd_write|fd_advise|fd_allocate|path_create_directory|path_create_file|path_link_source|path_link_target|path_open|fd_readdir|path_readlink|path_rename_source|path_rename_target|path_filestat_get|path_filestat_set_size|path_filestat_set_times|fd_filestat_get|fd_filestat_set_size|fd_filestat_set_times|path_symlink|path_remove_directory|path_unlink_file|poll_fd_readwrite (0xfffffff) }
 TRACE wasi_common::path                              &gt;      | (path_ptr,path_len)=&#39;test.txt&#39;
 DEBUG wasi_common::path                              &gt; path_get cur_path = &quot;test.txt&quot;
 DEBUG wasi_common::path                              &gt; path_get path_stack = []
 DEBUG wasi_common::sys::windows::path                &gt; out_path=&quot;Z:\\home\\whitequark\\xxx\\build\\test.txt&quot;
 DEBUG wasi_common::sys::windows::path                &gt; readlinkat error=50
 TRACE wasi_common::snapshots::wasi_snapshot_preview1 &gt;      | calling path_open impl: read=false, write=true
 DEBUG wasi_common::sys::windows::path                &gt; out_path=&quot;Z:\\home\\whitequark\\xxx\\build\\test.txt&quot;
 DEBUG wasi_common::sys                               &gt; Created new instance of OsFile: OsFile { rights: Cell { value: HandleRights { base: Rights(148898303), inheriting: Rights(0) } }, handle: RawOsHandle(Cell { value: 0x64 }) }
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; opened_fd=Fd(4)
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; success=No error occurred. System call completed successfully. (Errno::Success(0))
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; wiggle abi; module=&quot;wasi_snapshot_preview1&quot; function=&quot;fd_fdstat_get&quot;
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; fd=Fd(4)
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; stat=Fdstat { fs_filetype: RegularFile, fs_flags: Fdflags(0), fs_rights_base: Rights(148898301), fs_rights_inheriting: Rights(0) }
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; success=No error occurred. System call completed successfully. (Errno::Success(0))
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; wiggle abi; module=&quot;wasi_snapshot_preview1&quot; function=&quot;fd_write&quot;
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; fd=Fd(4) iovs=*guest 0x150b0/2
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; nwritten=16
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; success=No error occurred. System call completed successfully. (Errno::Success(0))
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; wiggle abi; module=&quot;wasi_snapshot_preview1&quot; function=&quot;fd_close&quot;
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; fd=Fd(4)
 TRACE wasi_common::wasi::wasi_snapshot_preview1      &gt; success=No error occurred. System call completed successfully. (Errno::Success(0))
</code></pre></div>


</blockquote>



<a name="203543887"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232009%20Opening%20files%20with%20O_TRUNC%20does%20no.../near/203543887" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232009.20Opening.20files.20with.20O_TRUNC.20does.20no.2E.2E.2E.html#203543887">(Jul 10 2020 at 18:47)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/2009#issuecomment-656828530">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2009">Issue #2009</a>:</p>
<blockquote>
<p>An oflag of <code>CREAT | TRUNC</code> should result in <a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-common/src/sys/windows/mod.rs#L195">a creation disposition flag of <code>CREATE_ALWAYS</code></a>.  That would normally be truncating the file if we were using the Windows API directly.</p>
<p>However, I think the problem <a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-common/src/sys/windows/path.rs#L227">lies here</a> where we're converting the Windows disposition flag to a Rust <code>OpenOptions</code>.  That should probably have a <code>truncate(true)</code> on it.</p>
</blockquote>



<a name="203544328"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232009%20Opening%20files%20with%20O_TRUNC%20does%20no.../near/203544328" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232009.20Opening.20files.20with.20O_TRUNC.20does.20no.2E.2E.2E.html#203544328">(Jul 10 2020 at 18:50)</a>:</h4>
<p>peterhuene labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/2009">Issue #2009</a>:</p>
<blockquote>
<p>Consider the following program:</p>
<div class="codehilite"><pre><span></span><code>#include &lt;fstream&gt;

int main() {
    std::ofstream ff;
    ff.open(&quot;test.txt&quot;, std::ofstream::trunc);
    ff &lt;&lt; &quot;bad bad bad bad\n&quot;;
    return 0;
}
</code></pre></div>


<p>I've attached it here:  <a href="https://github.com/bytecodealliance/wasmtime/files/4903795/bad.zip">bad.zip</a></p>
<p>Open <code>test.txt</code> and put something like this there:</p>
<div class="codehilite"><pre><span></span><code>bad bad bad bad
this will remain here
</code></pre></div>


<p>Run it:</p>
<div class="codehilite"><pre><span></span><code>wasmtime run --dir . bad.wasm
</code></pre></div>


<p>The file is not truncated.</p>
</blockquote>



<a name="203544329"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232009%20Opening%20files%20with%20O_TRUNC%20does%20no.../near/203544329" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232009.20Opening.20files.20with.20O_TRUNC.20does.20no.2E.2E.2E.html#203544329">(Jul 10 2020 at 18:50)</a>:</h4>
<p>peterhuene labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/2009">Issue #2009</a>:</p>
<blockquote>
<p>Consider the following program:</p>
<div class="codehilite"><pre><span></span><code>#include &lt;fstream&gt;

int main() {
    std::ofstream ff;
    ff.open(&quot;test.txt&quot;, std::ofstream::trunc);
    ff &lt;&lt; &quot;bad bad bad bad\n&quot;;
    return 0;
}
</code></pre></div>


<p>I've attached it here:  <a href="https://github.com/bytecodealliance/wasmtime/files/4903795/bad.zip">bad.zip</a></p>
<p>Open <code>test.txt</code> and put something like this there:</p>
<div class="codehilite"><pre><span></span><code>bad bad bad bad
this will remain here
</code></pre></div>


<p>Run it:</p>
<div class="codehilite"><pre><span></span><code>wasmtime run --dir . bad.wasm
</code></pre></div>


<p>The file is not truncated.</p>
</blockquote>



<a name="203544365"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232009%20Opening%20files%20with%20O_TRUNC%20does%20no.../near/203544365" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232009.20Opening.20files.20with.20O_TRUNC.20does.20no.2E.2E.2E.html#203544365">(Jul 10 2020 at 18:51)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/issues/2009#issuecomment-656830056">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2009">Issue #2009</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @kubkon</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "wasi"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>kubkon: wasi</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="203547435"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232009%20Opening%20files%20with%20O_TRUNC%20does%20no.../near/203547435" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232009.20Opening.20files.20with.20O_TRUNC.20does.20no.2E.2E.2E.html#203547435">(Jul 10 2020 at 19:15)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/2009#issuecomment-656846764">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2009">Issue #2009</a>:</p>
<blockquote>
<blockquote>
<p>However, I think the problem <a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-common/src/sys/windows/path.rs#L227">lies here</a> where we're converting the Windows disposition flag to a Rust <code>OpenOptions</code>. That should probably have a <code>truncate(true)</code> on it.</p>
</blockquote>
<p>Nope, that code doesn't even run (I put a panic in it).</p>
</blockquote>



<a name="203548127"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232009%20Opening%20files%20with%20O_TRUNC%20does%20no.../near/203548127" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232009.20Opening.20files.20with.20O_TRUNC.20does.20no.2E.2E.2E.html#203548127">(Jul 10 2020 at 19:21)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/2009#issuecomment-656849352">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2009">Issue #2009</a>:</p>
<blockquote>
<p>Sorry, I forgot a <code>--dir .</code> and the application silently crashed (because <code>-fno-exceptions</code>...). I can confirm that this fixes the bug.</p>
</blockquote>



<a name="203619514"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232009%20Opening%20files%20with%20O_TRUNC%20does%20no.../near/203619514" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232009.20Opening.20files.20with.20O_TRUNC.20does.20no.2E.2E.2E.html#203619514">(Jul 12 2020 at 00:11)</a>:</h4>
<p>peterhuene closed <a href="https://github.com/bytecodealliance/wasmtime/issues/2009">Issue #2009</a>:</p>
<blockquote>
<p>Consider the following program:</p>
<div class="codehilite"><pre><span></span><code>#include &lt;fstream&gt;

int main() {
    std::ofstream ff;
    ff.open(&quot;test.txt&quot;, std::ofstream::trunc);
    ff &lt;&lt; &quot;bad bad bad bad\n&quot;;
    return 0;
}
</code></pre></div>


<p>I've attached it here:  <a href="https://github.com/bytecodealliance/wasmtime/files/4903795/bad.zip">bad.zip</a></p>
<p>Open <code>test.txt</code> and put something like this there:</p>
<div class="codehilite"><pre><span></span><code>bad bad bad bad
this will remain here
</code></pre></div>


<p>Run it:</p>
<div class="codehilite"><pre><span></span><code>wasmtime run --dir . bad.wasm
</code></pre></div>


<p>The file is not truncated.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>