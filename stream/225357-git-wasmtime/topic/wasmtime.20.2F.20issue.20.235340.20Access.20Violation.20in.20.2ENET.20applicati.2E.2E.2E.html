<html>
<head><meta charset="utf-8"><title>wasmtime / issue #5340 Access Violation in .NET applicati... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html">wasmtime / issue #5340 Access Violation in .NET applicati...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="312848565"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312848565" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312848565">(Nov 29 2022 at 13:59)</a>:</h4>
<p>kpreisser opened <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Hi,</p>
<p>we are using <code>Wasmtime</code> via <code>Wasmtime.Dotnet</code> in a .NET 6.0 application, where we load a 8 MB WASM file and execute its <code>_start</code> function. However, this causes an <strong>access violation</strong> on Windows in <code>wasmtime_func_call</code> when using Wasmtime from commit ff5abfd9938c78cd75c6c5d6a41565097128c5d3.</p>
<p>The crash started to happen toegher with issue #5328, which is why I also reported it there, but it could be that this was just a trigger and the actual root case is a different one. It could also be that once #5328 is fixed, the access violation is no longer reproducible.</p>
<p>I can reproduce the access violation with the following steps on Windows 10 x64 Build 19044, and on Windows Server 2019:</p>
<ul>
<li>
<p>Build the Wasmtime C API from commit ff5abfd9938c78cd75c6c5d6a41565097128c5d3 on Windows for the current host (<code>x86_64-pc-windows-msvc</code>) as release build: <code>cargo build --release --manifest-path crates/c-api/Cargo.toml
</code></p>
</li>
<li>
<p>Install the <a href="https://dotnet.microsoft.com/en-us/download/dotnet/thank-you/sdk-6.0.403-windows-x64-installer">.NET SDK 6.0.403 for Windows x64</a>, which includes the .NET 6.0.11 runtime.</p>
</li>
<li>Clone <a href="https://github.com/kpreisser/wasmtime-dotnet">https://github.com/kpreisser/wasmtime-dotnet</a>, and switch to branch <code>repro-wasmtime-access-violation</code>, which contains a <a href="https://github.com/kpreisser/wasmtime-dotnet/commit/befee0799769b2c020de1f20a2d113d158cf671b">commit that adds the repro project</a> on top of the current <code>wasmtime-dotnet</code> code.</li>
<li><code>cd</code> into the repo's <code>ReproWasmtimeAccessViolation</code> folder, then run <code>dotnet build ReproWasmtimeAccessViolation.csproj</code>.</li>
<li><code>cd bin\Debug\net6.0</code>, then copy <code>wasmtime.dll</code> and <code>wasmtime.pdb</code> from the build result into this directory.</li>
<li>Download the WASM file as .Zip file here (note: rename the .mov file to .zip ; I renamed it to be able to upload it here): <a href="https://user-images.githubusercontent.com/13289184/203989968-4639d6d5-15c9-4e57-bf01-c2eccd756642.mov">https://user-images.githubusercontent.com/13289184/203989968-4639d6d5-15c9-4e57-bf01-c2eccd756642.mov</a>, and copy the file <code>dotnet-codabix-wasm-build.wasm</code> also into this directory.</li>
<li>Run <code>ReproWasmtimeAccessViolation.exe</code>.</li>
</ul>
<p>After some seconds, the program will exit if the access violation occured. If it didn't occur, it will print <code>"wasmtime_func_call completed! This should not be displayed if the Access Violation occured."</code>, and you can use <code>Ctrl</code>+<code>C</code> to exit.</p>
<p>Unfortunately, the crash doesn't alway occur, it might also have something to do with the hardware on which it is running. You may have to try a few times if the crash doesn't occur.</p>
<p>When attaching Visual Studio 2022 as debugger (using "native code" mode), it will show the following:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Exception</span><span class="w"> </span><span class="n">thrown</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mh">0x000002BB0392BD19</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ReproWasmtimeAccessViolation</span><span class="p">.</span><span class="n">exe</span>: <span class="mh">0xC0000005</span>: <span class="nc">Access</span><span class="w"> </span><span class="n">violation</span><span class="w"> </span><span class="n">writing</span><span class="w"> </span><span class="n">location</span><span class="w"> </span><span class="mh">0x000000CA214E4E80</span><span class="p">.</span><span class="w"></span>
</code></pre></div>
<p>Call Stack:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">&gt;</span><span class="w">   </span><span class="mi">000002</span><span class="n">bb0392bd19</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a369dc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03951aaf</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038caa53</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a2c701</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb039f78bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038caa53</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a2c701</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb039f78bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5a965</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03ac8ee0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03ac3058</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb04294c00</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb042df4c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03aaa51f</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0382174a</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038210d4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb044cf7bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb044cfdbb</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">wasmtime_setjmp</span><span class="w"></span><span class="p">()</span><span class="w"> </span><span class="n">C</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN16wasmtime_runtime12traphandlers84_</span><span class="cp">$LT$impl$u20$wasmtime_runtime</span><span class="o">..</span><span class="n">traphandlers</span><span class="o">..</span><span class="n">call_thread_state</span><span class="o">..</span><span class="n">CallThreadState</span><span class="cp">$GT$</span><span class="mi">4</span><span class="n">with17h74c010e2e721401eE</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN16wasmtime_runtime12traphandlers11catch_traps17h7bef31bead668a92E</span><span class="w"></span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN8wasmtime4func4Func18call_unchecked_raw17hcb0b0b7982c6fc66E</span><span class="p">.</span><span class="n">llvm</span><span class="p">.</span><span class="mi">11183561978299839151</span><span class="w"></span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN8wasmtime4func4Func9call_impl17hcb50041b4478fa06E</span><span class="p">.</span><span class="n">llvm</span><span class="p">.</span><span class="mi">11183561978299839151</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">wasmtime_func_call</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615ce96</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615cc68</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615c826</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615c66b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615a56b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615a0ac</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd55f3fd86</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd55f3ef8b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="n">Private</span><span class="p">.</span><span class="n">CoreLib</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffd3609274f</span><span class="p">()</span><span class="w">   </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5aaaac3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59a6d9c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5a8c413</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59836f5</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59835fa</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5983419</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">kernel32</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdeafe74b4</span><span class="p">()</span><span class="w"> </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">ntdll</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdeb2c26a1</span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
</code></pre></div>
<p>Additional notes:</p>
<ul>
<li>On my system, the crash reproduces in more than 50% of the cases.</li>
<li>I can't seem to reproduce the crash when using Wasmtime debug build.</li>
</ul>
<p><strong>Environment:</strong></p>
<ul>
<li>Windows 10 Pro x64 Build 19044 (in a VM)</li>
<li>Hardware: Apple Mac mini (2018), with Parallels Desktop to run the Windows VM</li>
<li>CPU: Intel(R) Core(TM) i7-8700B CPU @ 3.20GHz   3.19 GHz</li>
</ul>
<p>Thank you!</p>
</blockquote>



<a name="312848797"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312848797" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312848797">(Nov 29 2022 at 14:00)</a>:</h4>
<p>kpreisser edited <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Hi,</p>
<p>we are using <code>Wasmtime</code> via <a href="https://github.com/bytecodealliance/wasmtime-dotnet/"><code>wasmtime-dotnet</code></a> in a .NET 6.0 application, where we load a 8 MB WASM file and execute its <code>_start</code> function. However, this causes an <strong>access violation</strong> on Windows in <code>wasmtime_func_call</code> when using Wasmtime from commit ff5abfd9938c78cd75c6c5d6a41565097128c5d3.</p>
<p>The crash started to happen toegher with issue #5328, which is why I also reported it there, but it could be that this was just a trigger and the actual root case is a different one. It could also be that once #5328 is fixed, the access violation is no longer reproducible.</p>
<p>I can reproduce the access violation with the following steps on Windows 10 x64 Build 19044, and on Windows Server 2019:</p>
<ul>
<li>
<p>Build the Wasmtime C API from commit ff5abfd9938c78cd75c6c5d6a41565097128c5d3 on Windows for the current host (<code>x86_64-pc-windows-msvc</code>) as release build: <code>cargo build --release --manifest-path crates/c-api/Cargo.toml
</code></p>
</li>
<li>
<p>Install the <a href="https://dotnet.microsoft.com/en-us/download/dotnet/thank-you/sdk-6.0.403-windows-x64-installer">.NET SDK 6.0.403 for Windows x64</a>, which includes the .NET 6.0.11 runtime.</p>
</li>
<li>Clone <a href="https://github.com/kpreisser/wasmtime-dotnet">https://github.com/kpreisser/wasmtime-dotnet</a>, and switch to branch <code>repro-wasmtime-access-violation</code>, which contains a <a href="https://github.com/kpreisser/wasmtime-dotnet/commit/befee0799769b2c020de1f20a2d113d158cf671b">commit that adds the repro project</a> on top of the current <code>wasmtime-dotnet</code> code.</li>
<li><code>cd</code> into the repo's <code>ReproWasmtimeAccessViolation</code> folder, then run <code>dotnet build ReproWasmtimeAccessViolation.csproj</code>.</li>
<li><code>cd bin\Debug\net6.0</code>, then copy <code>wasmtime.dll</code> and <code>wasmtime.pdb</code> from the build result into this directory.</li>
<li>Download the WASM file as .Zip file here (note: rename the .mov file to .zip ; I renamed it to be able to upload it here): <a href="https://user-images.githubusercontent.com/13289184/203989968-4639d6d5-15c9-4e57-bf01-c2eccd756642.mov">https://user-images.githubusercontent.com/13289184/203989968-4639d6d5-15c9-4e57-bf01-c2eccd756642.mov</a>, and copy the file <code>dotnet-codabix-wasm-build.wasm</code> also into this directory.</li>
<li>Run <code>ReproWasmtimeAccessViolation.exe</code>.</li>
</ul>
<p>After some seconds, the program will exit if the access violation occured. If it didn't occur, it will print <code>"wasmtime_func_call completed! This should not be displayed if the Access Violation occured."</code>, and you can use <code>Ctrl</code>+<code>C</code> to exit.</p>
<p>Unfortunately, the crash doesn't alway occur, it might also have something to do with the hardware on which it is running. You may have to try a few times if the crash doesn't occur.</p>
<p>When attaching Visual Studio 2022 as debugger (using "native code" mode), it will show the following:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Exception</span><span class="w"> </span><span class="n">thrown</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mh">0x000002BB0392BD19</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ReproWasmtimeAccessViolation</span><span class="p">.</span><span class="n">exe</span>: <span class="mh">0xC0000005</span>: <span class="nc">Access</span><span class="w"> </span><span class="n">violation</span><span class="w"> </span><span class="n">writing</span><span class="w"> </span><span class="n">location</span><span class="w"> </span><span class="mh">0x000000CA214E4E80</span><span class="p">.</span><span class="w"></span>
</code></pre></div>
<p>Call Stack:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">&gt;</span><span class="w">   </span><span class="mi">000002</span><span class="n">bb0392bd19</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a369dc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03951aaf</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038caa53</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a2c701</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb039f78bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038caa53</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a2c701</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb039f78bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5a965</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03ac8ee0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03ac3058</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb04294c00</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb042df4c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03aaa51f</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0382174a</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038210d4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb044cf7bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb044cfdbb</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">wasmtime_setjmp</span><span class="w"></span><span class="p">()</span><span class="w"> </span><span class="n">C</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN16wasmtime_runtime12traphandlers84_</span><span class="cp">$LT$impl$u20$wasmtime_runtime</span><span class="o">..</span><span class="n">traphandlers</span><span class="o">..</span><span class="n">call_thread_state</span><span class="o">..</span><span class="n">CallThreadState</span><span class="cp">$GT$</span><span class="mi">4</span><span class="n">with17h74c010e2e721401eE</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN16wasmtime_runtime12traphandlers11catch_traps17h7bef31bead668a92E</span><span class="w"></span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN8wasmtime4func4Func18call_unchecked_raw17hcb0b0b7982c6fc66E</span><span class="p">.</span><span class="n">llvm</span><span class="p">.</span><span class="mi">11183561978299839151</span><span class="w"></span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN8wasmtime4func4Func9call_impl17hcb50041b4478fa06E</span><span class="p">.</span><span class="n">llvm</span><span class="p">.</span><span class="mi">11183561978299839151</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">wasmtime_func_call</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615ce96</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615cc68</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615c826</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615c66b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615a56b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615a0ac</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd55f3fd86</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd55f3ef8b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="n">Private</span><span class="p">.</span><span class="n">CoreLib</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffd3609274f</span><span class="p">()</span><span class="w">   </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5aaaac3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59a6d9c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5a8c413</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59836f5</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59835fa</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5983419</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">kernel32</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdeafe74b4</span><span class="p">()</span><span class="w"> </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">ntdll</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdeb2c26a1</span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
</code></pre></div>
<p>Additional notes:</p>
<ul>
<li>On my system, the crash reproduces in more than 50% of the cases.</li>
<li>I can't seem to reproduce the crash when using Wasmtime debug build.</li>
</ul>
<p><strong>Environment:</strong></p>
<ul>
<li>Windows 10 Pro x64 Build 19044 (in a VM)</li>
<li>Hardware: Apple Mac mini (2018), with Parallels Desktop to run the Windows VM</li>
<li>CPU: Intel(R) Core(TM) i7-8700B CPU @ 3.20GHz   3.19 GHz</li>
</ul>
<p>Thank you!</p>
</blockquote>



<a name="312857382"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312857382" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312857382">(Nov 29 2022 at 14:39)</a>:</h4>
<p>kpreisser edited <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Hi,</p>
<p>we are using <code>Wasmtime</code> via <a href="https://github.com/bytecodealliance/wasmtime-dotnet/"><code>wasmtime-dotnet</code></a> in a .NET 6.0 application, where we load a 8 MB WASM file and execute its <code>_start</code> function. However, this causes an <strong>access violation</strong> on Windows in <code>wasmtime_func_call</code> when using Wasmtime from commit ff5abfd9938c78cd75c6c5d6a41565097128c5d3.</p>
<p>The crash started to happen toegher with issue #5328, which is why I also reported it there, but it could be that this was just a trigger and the actual root case is a different one. It could also be that once #5328 is fixed, the access violation is no longer reproducible.</p>
<p>I can reproduce the access violation with the following steps on Windows 10 x64 Build 19044, and on Windows Server 2019:</p>
<ul>
<li>
<p>Build the Wasmtime C API from commit ff5abfd9938c78cd75c6c5d6a41565097128c5d3 on Windows for the current host (<code>x86_64-pc-windows-msvc</code>) as release build: <code>cargo build --release --manifest-path crates/c-api/Cargo.toml
</code></p>
</li>
<li>
<p>Install the <a href="https://dotnet.microsoft.com/en-us/download/dotnet/thank-you/sdk-6.0.403-windows-x64-installer">.NET SDK 6.0.403 for Windows x64</a>, which includes the .NET 6.0.11 runtime.</p>
</li>
<li>Clone <a href="https://github.com/kpreisser/wasmtime-dotnet">https://github.com/kpreisser/wasmtime-dotnet</a>, and switch to branch <code>repro-wasmtime-access-violation</code>, which contains a <a href="https://github.com/kpreisser/wasmtime-dotnet/commit/ccca66d68963c611b69f9edb4310bc75e4ef7da0">commit that adds the repro project</a> on top of the current <code>wasmtime-dotnet</code> code.</li>
<li><code>cd</code> into the repo's <code>ReproWasmtimeAccessViolation</code> folder, then run <code>dotnet build ReproWasmtimeAccessViolation.csproj</code>.</li>
<li><code>cd bin\Debug\net6.0</code>, then copy <code>wasmtime.dll</code> and <code>wasmtime.pdb</code> from the build result into this directory.</li>
<li>Download the WASM file as .Zip file here (note: rename the .mov file to .zip ; I renamed it to be able to upload it here): <a href="https://user-images.githubusercontent.com/13289184/203989968-4639d6d5-15c9-4e57-bf01-c2eccd756642.mov">https://user-images.githubusercontent.com/13289184/203989968-4639d6d5-15c9-4e57-bf01-c2eccd756642.mov</a>, and copy the file <code>dotnet-codabix-wasm-build.wasm</code> also into this directory.</li>
<li>Run <code>ReproWasmtimeAccessViolation.exe</code>.</li>
</ul>
<p>After some seconds, the program will exit if the access violation occured. If it didn't occur, it will print <code>"wasmtime_func_call completed! This should not be displayed if the Access Violation occured."</code>, and you can use <code>Ctrl</code>+<code>C</code> to exit.</p>
<p>Unfortunately, the crash doesn't alway occur, it might also depend on the hardware or other factors. You may have to try a few times if the crash doesn't occur, or try again at a later time.</p>
<p>When attaching Visual Studio 2022 as debugger (using "native code" mode), it will show the following:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Exception</span><span class="w"> </span><span class="n">thrown</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mh">0x000002BB0392BD19</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ReproWasmtimeAccessViolation</span><span class="p">.</span><span class="n">exe</span>: <span class="mh">0xC0000005</span>: <span class="nc">Access</span><span class="w"> </span><span class="n">violation</span><span class="w"> </span><span class="n">writing</span><span class="w"> </span><span class="n">location</span><span class="w"> </span><span class="mh">0x000000CA214E4E80</span><span class="p">.</span><span class="w"></span>
</code></pre></div>
<p>Call Stack:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">&gt;</span><span class="w">   </span><span class="mi">000002</span><span class="n">bb0392bd19</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a369dc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03951aaf</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038caa53</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a2c701</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb039f78bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038caa53</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a2c701</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb039f78bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5a965</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03ac8ee0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03ac3058</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb04294c00</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb042df4c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03aaa51f</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0382174a</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038210d4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb044cf7bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb044cfdbb</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">wasmtime_setjmp</span><span class="w"></span><span class="p">()</span><span class="w"> </span><span class="n">C</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN16wasmtime_runtime12traphandlers84_</span><span class="cp">$LT$impl$u20$wasmtime_runtime</span><span class="o">..</span><span class="n">traphandlers</span><span class="o">..</span><span class="n">call_thread_state</span><span class="o">..</span><span class="n">CallThreadState</span><span class="cp">$GT$</span><span class="mi">4</span><span class="n">with17h74c010e2e721401eE</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN16wasmtime_runtime12traphandlers11catch_traps17h7bef31bead668a92E</span><span class="w"></span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN8wasmtime4func4Func18call_unchecked_raw17hcb0b0b7982c6fc66E</span><span class="p">.</span><span class="n">llvm</span><span class="p">.</span><span class="mi">11183561978299839151</span><span class="w"></span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN8wasmtime4func4Func9call_impl17hcb50041b4478fa06E</span><span class="p">.</span><span class="n">llvm</span><span class="p">.</span><span class="mi">11183561978299839151</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">wasmtime_func_call</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615ce96</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615cc68</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615c826</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615c66b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615a56b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615a0ac</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd55f3fd86</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd55f3ef8b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="n">Private</span><span class="p">.</span><span class="n">CoreLib</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffd3609274f</span><span class="p">()</span><span class="w">   </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5aaaac3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59a6d9c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5a8c413</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59836f5</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59835fa</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5983419</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">kernel32</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdeafe74b4</span><span class="p">()</span><span class="w"> </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">ntdll</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdeb2c26a1</span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
</code></pre></div>
<p>Additional notes:</p>
<ul>
<li>On my system, the crash reproduces in more than 50% of the cases.</li>
<li>I can't seem to reproduce the crash when using Wasmtime debug build.</li>
</ul>
<p><strong>Environment:</strong></p>
<ul>
<li>Windows 10 Pro x64 Build 19044 (in a VM)</li>
<li>Hardware: Apple Mac mini (2018), with Parallels Desktop to run the Windows VM</li>
<li>CPU: Intel(R) Core(TM) i7-8700B CPU @ 3.20GHz   3.19 GHz</li>
</ul>
<p>Thank you!</p>
</blockquote>



<a name="312860975"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312860975" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312860975">(Nov 29 2022 at 14:56)</a>:</h4>
<p>kpreisser edited <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Hi,</p>
<p>we are using <code>Wasmtime</code> via <a href="https://github.com/bytecodealliance/wasmtime-dotnet/"><code>wasmtime-dotnet</code></a> in a .NET 6.0 application, where we load a 8 MB WASM file and execute its <code>_start</code> function. However, this causes an <strong>access violation</strong> on Windows in <code>wasmtime_func_call</code> when using Wasmtime from commit ff5abfd9938c78cd75c6c5d6a41565097128c5d3.</p>
<p>The crash started to happen toegher with issue #5328, which is why I also reported it there, but it could be that this was just a trigger and the actual root case is a different one. It could also be that once #5328 is fixed, the access violation is no longer reproducible.</p>
<p>I can reproduce the access violation with the following steps on Windows 10 x64 Build 19044, and on Windows Server 2019:</p>
<ul>
<li>
<p>Build the Wasmtime C API from commit ff5abfd9938c78cd75c6c5d6a41565097128c5d3 on Windows for the current host (<code>x86_64-pc-windows-msvc</code>) as release build: <code>cargo build --release --manifest-path crates/c-api/Cargo.toml
</code></p>
</li>
<li>
<p>Install the <a href="https://dotnet.microsoft.com/en-us/download/dotnet/thank-you/sdk-6.0.403-windows-x64-installer">.NET SDK 6.0.403 for Windows x64</a>, which includes the .NET 6.0.11 runtime.</p>
</li>
<li>Clone <a href="https://github.com/kpreisser/wasmtime-dotnet">https://github.com/kpreisser/wasmtime-dotnet</a>, and switch to branch <code>repro-wasmtime-access-violation</code>, which contains a <a href="https://github.com/kpreisser/wasmtime-dotnet/commit/ccca66d68963c611b69f9edb4310bc75e4ef7da0">commit that adds the repro project</a> on top of the current <code>wasmtime-dotnet</code> code.</li>
<li><code>cd</code> into the repo's <code>ReproWasmtimeAccessViolation</code> folder, then run <code>dotnet build ReproWasmtimeAccessViolation.csproj</code>.</li>
<li><code>cd bin\Debug\net6.0</code>, then copy <code>wasmtime.dll</code> and <code>wasmtime.pdb</code> from the build result into this directory.</li>
<li>Download the WASM file as .Zip file here (note: rename the .mov file to .zip ; I renamed it to be able to upload it here): <a href="https://user-images.githubusercontent.com/13289184/203989968-4639d6d5-15c9-4e57-bf01-c2eccd756642.mov">https://user-images.githubusercontent.com/13289184/203989968-4639d6d5-15c9-4e57-bf01-c2eccd756642.mov</a>, and copy the file <code>dotnet-codabix-wasm-build.wasm</code> also into this directory.</li>
<li>Run <code>ReproWasmtimeAccessViolation.exe</code>.</li>
</ul>
<p>After some seconds, the program will exit if the access violation occured (and in Windows Error Reporting, there will be an error entry in the Application log ("Application Error").<br>
If it didn't occur, the program will print <code>"wasmtime_func_call completed! This should not be displayed if the Access Violation occured."</code>, and you can use <code>Ctrl</code>+<code>C</code> to exit.</p>
<p>Unfortunately, the crash doesn't alway occur, it might also depend on the hardware or other factors. You may have to try a few times if the crash doesn't occur, or try again at a later time.</p>
<p>When attaching Visual Studio 2022 as debugger (using "native code" mode), it will show the following:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Exception</span><span class="w"> </span><span class="n">thrown</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mh">0x000002BB0392BD19</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ReproWasmtimeAccessViolation</span><span class="p">.</span><span class="n">exe</span>: <span class="mh">0xC0000005</span>: <span class="nc">Access</span><span class="w"> </span><span class="n">violation</span><span class="w"> </span><span class="n">writing</span><span class="w"> </span><span class="n">location</span><span class="w"> </span><span class="mh">0x000000CA214E4E80</span><span class="p">.</span><span class="w"></span>
</code></pre></div>
<p>Call Stack:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">&gt;</span><span class="w">   </span><span class="mi">000002</span><span class="n">bb0392bd19</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a369dc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03951aaf</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038caa53</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a2c701</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb039f78bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038caa53</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a2c701</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb039f78bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5a965</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03ac8ee0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03ac3058</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb04294c00</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb042df4c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03aaa51f</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0382174a</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038210d4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb044cf7bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb044cfdbb</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">wasmtime_setjmp</span><span class="w"></span><span class="p">()</span><span class="w"> </span><span class="n">C</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN16wasmtime_runtime12traphandlers84_</span><span class="cp">$LT$impl$u20$wasmtime_runtime</span><span class="o">..</span><span class="n">traphandlers</span><span class="o">..</span><span class="n">call_thread_state</span><span class="o">..</span><span class="n">CallThreadState</span><span class="cp">$GT$</span><span class="mi">4</span><span class="n">with17h74c010e2e721401eE</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN16wasmtime_runtime12traphandlers11catch_traps17h7bef31bead668a92E</span><span class="w"></span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN8wasmtime4func4Func18call_unchecked_raw17hcb0b0b7982c6fc66E</span><span class="p">.</span><span class="n">llvm</span><span class="p">.</span><span class="mi">11183561978299839151</span><span class="w"></span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN8wasmtime4func4Func9call_impl17hcb50041b4478fa06E</span><span class="p">.</span><span class="n">llvm</span><span class="p">.</span><span class="mi">11183561978299839151</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">wasmtime_func_call</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615ce96</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615cc68</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615c826</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615c66b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615a56b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615a0ac</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd55f3fd86</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd55f3ef8b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="n">Private</span><span class="p">.</span><span class="n">CoreLib</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffd3609274f</span><span class="p">()</span><span class="w">   </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5aaaac3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59a6d9c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5a8c413</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59836f5</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59835fa</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5983419</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">kernel32</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdeafe74b4</span><span class="p">()</span><span class="w"> </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">ntdll</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdeb2c26a1</span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
</code></pre></div>
<p>Additional notes:</p>
<ul>
<li>On my system, the crash reproduces in more than 50% of the cases.</li>
<li>I can't seem to reproduce the crash when using Wasmtime debug build.</li>
</ul>
<p><strong>Environments</strong> where I can reproduce the crash:</p>
<ul>
<li>Environment 1:<ul>
<li>Hardware: Apple Mac mini (2018), with Parallels Desktop to run the Windows VM</li>
<li>CPU: Intel(R) Core(TM) i7-8700B CPU @ 3.20GHz   3.19 GHz</li>
<li>VM (Parallels Desktop): Windows 10 Pro x64 Build 19044 (in a VM)</li>
</ul>
</li>
<li>Environment 2:<ul>
<li>Hardware: Intel NUC8i7BEH</li>
<li>CPU: Intel Core i7-8559U</li>
<li>VM (VMware Player 16): Windows Server 2019 Build 17763</li>
</ul>
</li>
</ul>
<p>Thank you!</p>
</blockquote>



<a name="312861061"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312861061" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312861061">(Nov 29 2022 at 14:56)</a>:</h4>
<p>kpreisser edited <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Hi,</p>
<p>we are using <code>Wasmtime</code> via <a href="https://github.com/bytecodealliance/wasmtime-dotnet/"><code>wasmtime-dotnet</code></a> in a .NET 6.0 application, where we load a 8 MB WASM file and execute its <code>_start</code> function. However, this causes an <strong>access violation</strong> on Windows in <code>wasmtime_func_call</code> when using Wasmtime from commit ff5abfd9938c78cd75c6c5d6a41565097128c5d3.</p>
<p>The crash started to happen toegher with issue #5328, which is why I also reported it there, but it could be that this was just a trigger and the actual root case is a different one. It could also be that once #5328 is fixed, the access violation is no longer reproducible.</p>
<p>I can reproduce the access violation with the following steps on Windows 10 x64 Build 19044, and on Windows Server 2019:</p>
<ul>
<li>
<p>Build the Wasmtime C API from commit ff5abfd9938c78cd75c6c5d6a41565097128c5d3 on Windows for the current host (<code>x86_64-pc-windows-msvc</code>) as release build: <code>cargo build --release --manifest-path crates/c-api/Cargo.toml
</code></p>
</li>
<li>
<p>Install the <a href="https://dotnet.microsoft.com/en-us/download/dotnet/thank-you/sdk-6.0.403-windows-x64-installer">.NET SDK 6.0.403 for Windows x64</a>, which includes the .NET 6.0.11 runtime.</p>
</li>
<li>Clone <a href="https://github.com/kpreisser/wasmtime-dotnet">https://github.com/kpreisser/wasmtime-dotnet</a>, and switch to branch <code>repro-wasmtime-access-violation</code>, which contains a <a href="https://github.com/kpreisser/wasmtime-dotnet/commit/ccca66d68963c611b69f9edb4310bc75e4ef7da0">commit that adds the repro project</a> on top of the current <code>wasmtime-dotnet</code> code.</li>
<li><code>cd</code> into the repo's <code>ReproWasmtimeAccessViolation</code> folder, then run <code>dotnet build ReproWasmtimeAccessViolation.csproj</code>.</li>
<li><code>cd bin\Debug\net6.0</code>, then copy <code>wasmtime.dll</code> and <code>wasmtime.pdb</code> from the build result into this directory.</li>
<li>Download the WASM file as .Zip file here (note: rename the .mov file to .zip ; I renamed it to be able to upload it here): <a href="https://user-images.githubusercontent.com/13289184/203989968-4639d6d5-15c9-4e57-bf01-c2eccd756642.mov">https://user-images.githubusercontent.com/13289184/203989968-4639d6d5-15c9-4e57-bf01-c2eccd756642.mov</a>, and copy the file <code>dotnet-codabix-wasm-build.wasm</code> also into this directory.</li>
<li>Run <code>ReproWasmtimeAccessViolation.exe</code>.</li>
</ul>
<p>After some seconds, the program will exit if the access violation occured (and in Windows Error Reporting, there will be an error entry in the Application log ("Application Error").<br>
If it didn't occur, the program will print <code>"wasmtime_func_call completed! This should not be displayed if the Access Violation occured."</code>, and you can use <code>Ctrl</code>+<code>C</code> to exit.</p>
<p>Unfortunately, the crash doesn't alway occur, it might also depend on the hardware or other factors. You may have to try a few times if the crash doesn't occur, or try again at a later time.</p>
<p>When attaching Visual Studio 2022 as debugger (using "native code" mode), it will show the following:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Exception</span><span class="w"> </span><span class="n">thrown</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mh">0x000002BB0392BD19</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ReproWasmtimeAccessViolation</span><span class="p">.</span><span class="n">exe</span>: <span class="mh">0xC0000005</span>: <span class="nc">Access</span><span class="w"> </span><span class="n">violation</span><span class="w"> </span><span class="n">writing</span><span class="w"> </span><span class="n">location</span><span class="w"> </span><span class="mh">0x000000CA214E4E80</span><span class="p">.</span><span class="w"></span>
</code></pre></div>
<p>Call Stack:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">&gt;</span><span class="w">   </span><span class="mi">000002</span><span class="n">bb0392bd19</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a369dc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03951aaf</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038caa53</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a2c701</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb039f78bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038caa53</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a2c701</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb039f78bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5a965</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03ac8ee0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03ac3058</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb04294c00</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb042df4c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03aaa51f</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0382174a</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038210d4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb044cf7bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb044cfdbb</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">wasmtime_setjmp</span><span class="w"></span><span class="p">()</span><span class="w"> </span><span class="n">C</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN16wasmtime_runtime12traphandlers84_</span><span class="cp">$LT$impl$u20$wasmtime_runtime</span><span class="o">..</span><span class="n">traphandlers</span><span class="o">..</span><span class="n">call_thread_state</span><span class="o">..</span><span class="n">CallThreadState</span><span class="cp">$GT$</span><span class="mi">4</span><span class="n">with17h74c010e2e721401eE</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN16wasmtime_runtime12traphandlers11catch_traps17h7bef31bead668a92E</span><span class="w"></span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN8wasmtime4func4Func18call_unchecked_raw17hcb0b0b7982c6fc66E</span><span class="p">.</span><span class="n">llvm</span><span class="p">.</span><span class="mi">11183561978299839151</span><span class="w"></span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN8wasmtime4func4Func9call_impl17hcb50041b4478fa06E</span><span class="p">.</span><span class="n">llvm</span><span class="p">.</span><span class="mi">11183561978299839151</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">wasmtime_func_call</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615ce96</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615cc68</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615c826</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615c66b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615a56b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615a0ac</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd55f3fd86</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd55f3ef8b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="n">Private</span><span class="p">.</span><span class="n">CoreLib</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffd3609274f</span><span class="p">()</span><span class="w">   </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5aaaac3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59a6d9c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5a8c413</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59836f5</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59835fa</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5983419</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">kernel32</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdeafe74b4</span><span class="p">()</span><span class="w"> </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">ntdll</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdeb2c26a1</span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
</code></pre></div>
<p>Additional notes:</p>
<ul>
<li>On my system, the crash reproduces in more than 50% of the cases.</li>
<li>I can't seem to reproduce the crash when using Wasmtime debug build.</li>
</ul>
<p><strong>Environments</strong> where I can reproduce the crash:</p>
<ul>
<li>Environment 1:<ul>
<li>Hardware: Apple Mac mini (2018), with Parallels Desktop to run the Windows VM</li>
<li>CPU: Intel(R) Core(TM) i7-8700B CPU @ 3.20GHz   3.19 GHz</li>
<li>VM (Parallels Desktop): Windows 10 Pro x64 Build 19044 (in a VM)</li>
</ul>
</li>
<li>Environment 2:<ul>
<li>Hardware: Intel NUC8i7BEH</li>
<li>CPU: Intel Core i7-8559U</li>
<li>VM (VMware Player 16): Windows Server 2019 Build 17763</li>
</ul>
</li>
</ul>
<p>Thank you!</p>
</blockquote>



<a name="312861259"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312861259" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312861259">(Nov 29 2022 at 14:57)</a>:</h4>
<p>kpreisser edited <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Hi,</p>
<p>we are using <code>Wasmtime</code> via <a href="https://github.com/bytecodealliance/wasmtime-dotnet/"><code>wasmtime-dotnet</code></a> in a .NET 6.0 application, where we load a 8 MB WASM file and execute its <code>_start</code> function. However, this causes an <strong>access violation</strong> on Windows in <code>wasmtime_func_call</code> when using Wasmtime from commit ff5abfd9938c78cd75c6c5d6a41565097128c5d3.</p>
<p>The crash started to happen toegher with issue #5328 (with commit fc62d4ad65892837a1e1af5a9d67c8b0d4310efe), which is why I also reported it there, but it could be that this was just a trigger and the actual root case is a different one. It could also be that once #5328 is fixed, the access violation is no longer reproducible.</p>
<p>I can reproduce the access violation with the following steps on Windows 10 x64 Build 19044, and on Windows Server 2019:</p>
<ul>
<li>
<p>Build the Wasmtime C API from commit ff5abfd9938c78cd75c6c5d6a41565097128c5d3 on Windows for the current host (<code>x86_64-pc-windows-msvc</code>) as release build: <code>cargo build --release --manifest-path crates/c-api/Cargo.toml
</code></p>
</li>
<li>
<p>Install the <a href="https://dotnet.microsoft.com/en-us/download/dotnet/thank-you/sdk-6.0.403-windows-x64-installer">.NET SDK 6.0.403 for Windows x64</a>, which includes the .NET 6.0.11 runtime.</p>
</li>
<li>Clone <a href="https://github.com/kpreisser/wasmtime-dotnet">https://github.com/kpreisser/wasmtime-dotnet</a>, and switch to branch <code>repro-wasmtime-access-violation</code>, which contains a <a href="https://github.com/kpreisser/wasmtime-dotnet/commit/ccca66d68963c611b69f9edb4310bc75e4ef7da0">commit that adds the repro project</a> on top of the current <code>wasmtime-dotnet</code> code.</li>
<li><code>cd</code> into the repo's <code>ReproWasmtimeAccessViolation</code> folder, then run <code>dotnet build ReproWasmtimeAccessViolation.csproj</code>.</li>
<li><code>cd bin\Debug\net6.0</code>, then copy <code>wasmtime.dll</code> and <code>wasmtime.pdb</code> from the build result into this directory.</li>
<li>Download the WASM file as .Zip file here (note: rename the .mov file to .zip ; I renamed it to be able to upload it here): <a href="https://user-images.githubusercontent.com/13289184/203989968-4639d6d5-15c9-4e57-bf01-c2eccd756642.mov">https://user-images.githubusercontent.com/13289184/203989968-4639d6d5-15c9-4e57-bf01-c2eccd756642.mov</a>, and copy the file <code>dotnet-codabix-wasm-build.wasm</code> also into this directory.</li>
<li>Run <code>ReproWasmtimeAccessViolation.exe</code>.</li>
</ul>
<p>After some seconds, the program will exit if the access violation occured (and in Windows Error Reporting, there will be an error entry in the Application log ("Application Error").<br>
If it didn't occur, the program will print <code>"wasmtime_func_call completed! This should not be displayed if the Access Violation occured."</code>, and you can use <code>Ctrl</code>+<code>C</code> to exit.</p>
<p>Unfortunately, the crash doesn't alway occur, it might also depend on the hardware or other factors. You may have to try a few times if the crash doesn't occur, or try again at a later time.</p>
<p>When attaching Visual Studio 2022 as debugger (using "native code" mode), it will show the following:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Exception</span><span class="w"> </span><span class="n">thrown</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mh">0x000002BB0392BD19</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ReproWasmtimeAccessViolation</span><span class="p">.</span><span class="n">exe</span>: <span class="mh">0xC0000005</span>: <span class="nc">Access</span><span class="w"> </span><span class="n">violation</span><span class="w"> </span><span class="n">writing</span><span class="w"> </span><span class="n">location</span><span class="w"> </span><span class="mh">0x000000CA214E4E80</span><span class="p">.</span><span class="w"></span>
</code></pre></div>
<p>Call Stack:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">&gt;</span><span class="w">   </span><span class="mi">000002</span><span class="n">bb0392bd19</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a369dc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03951aaf</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038caa53</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a2c701</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb039f78bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038caa53</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a2c701</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb039f78bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5a965</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03ac8ee0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03ac3058</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb04294c00</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb042df4c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03aaa51f</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0382174a</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038210d4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb044cf7bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb044cfdbb</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">wasmtime_setjmp</span><span class="w"></span><span class="p">()</span><span class="w"> </span><span class="n">C</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN16wasmtime_runtime12traphandlers84_</span><span class="cp">$LT$impl$u20$wasmtime_runtime</span><span class="o">..</span><span class="n">traphandlers</span><span class="o">..</span><span class="n">call_thread_state</span><span class="o">..</span><span class="n">CallThreadState</span><span class="cp">$GT$</span><span class="mi">4</span><span class="n">with17h74c010e2e721401eE</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN16wasmtime_runtime12traphandlers11catch_traps17h7bef31bead668a92E</span><span class="w"></span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN8wasmtime4func4Func18call_unchecked_raw17hcb0b0b7982c6fc66E</span><span class="p">.</span><span class="n">llvm</span><span class="p">.</span><span class="mi">11183561978299839151</span><span class="w"></span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN8wasmtime4func4Func9call_impl17hcb50041b4478fa06E</span><span class="p">.</span><span class="n">llvm</span><span class="p">.</span><span class="mi">11183561978299839151</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">wasmtime_func_call</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615ce96</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615cc68</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615c826</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615c66b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615a56b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615a0ac</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd55f3fd86</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd55f3ef8b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="n">Private</span><span class="p">.</span><span class="n">CoreLib</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffd3609274f</span><span class="p">()</span><span class="w">   </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5aaaac3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59a6d9c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5a8c413</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59836f5</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59835fa</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5983419</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">kernel32</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdeafe74b4</span><span class="p">()</span><span class="w"> </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">ntdll</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdeb2c26a1</span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
</code></pre></div>
<p>Additional notes:</p>
<ul>
<li>On my system, the crash reproduces in more than 50% of the cases.</li>
<li>I can't seem to reproduce the crash when using Wasmtime debug build.</li>
</ul>
<p><strong>Environments</strong> where I can reproduce the crash:</p>
<ul>
<li>Environment 1:<ul>
<li>Hardware: Apple Mac mini (2018), with Parallels Desktop to run the Windows VM</li>
<li>CPU: Intel(R) Core(TM) i7-8700B CPU @ 3.20GHz   3.19 GHz</li>
<li>VM (Parallels Desktop): Windows 10 Pro x64 Build 19044 (in a VM)</li>
</ul>
</li>
<li>Environment 2:<ul>
<li>Hardware: Intel NUC8i7BEH</li>
<li>CPU: Intel Core i7-8559U</li>
<li>VM (VMware Player 16): Windows Server 2019 Build 17763</li>
</ul>
</li>
</ul>
<p>Thank you!</p>
</blockquote>



<a name="312862069"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312862069" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312862069">(Nov 29 2022 at 15:00)</a>:</h4>
<p>kpreisser edited <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Hi,</p>
<p>we are using <code>Wasmtime</code> via <a href="https://github.com/bytecodealliance/wasmtime-dotnet/"><code>wasmtime-dotnet</code></a> in a .NET 6.0 application, where we load a 8 MB WASM file and execute its <code>_start</code> function. However, this causes an <strong>access violation</strong> on Windows in <code>wasmtime_func_call</code> when using Wasmtime from commit ff5abfd9938c78cd75c6c5d6a41565097128c5d3.</p>
<p>The crash started to happen toegher with issue #5328 (with commit fc62d4ad65892837a1e1af5a9d67c8b0d4310efe), which is why I also reported it there, but it could be that this was just a trigger and the actual root case is a different one. It could also be that once #5328 is fixed, the access violation is no longer reproducible.</p>
<p>I can reproduce the access violation with the following steps on Windows 10 x64 Build 19044, and on Windows Server 2019:</p>
<ul>
<li>
<p>Build the Wasmtime C API from commit ff5abfd9938c78cd75c6c5d6a41565097128c5d3 on Windows for the current host (<code>x86_64-pc-windows-msvc</code>) as release build: <code>cargo build --release --manifest-path crates/c-api/Cargo.toml
</code></p>
</li>
<li>
<p>Install the <a href="https://dotnet.microsoft.com/en-us/download/dotnet/thank-you/sdk-6.0.403-windows-x64-installer">.NET SDK 6.0.403 for Windows x64</a>, which includes the .NET 6.0.11 runtime.</p>
</li>
<li>Clone <a href="https://github.com/kpreisser/wasmtime-dotnet">https://github.com/kpreisser/wasmtime-dotnet</a>, and switch to branch <code>repro-wasmtime-access-violation</code>, which contains a <a href="https://github.com/kpreisser/wasmtime-dotnet/commit/ccca66d68963c611b69f9edb4310bc75e4ef7da0">commit that adds the repro project</a> on top of the current <code>wasmtime-dotnet</code> code.</li>
<li><code>cd</code> into the repo's <code>ReproWasmtimeAccessViolation</code> folder, then run <code>dotnet build ReproWasmtimeAccessViolation.csproj</code>.</li>
<li><code>cd bin\Debug\net6.0</code>, then copy <code>wasmtime.dll</code> and <code>wasmtime.pdb</code> from the build result into this directory.</li>
<li>Download the WASM file as .Zip file here (note: rename the .mov file to .zip ; I renamed it to be able to upload it here): <a href="https://user-images.githubusercontent.com/13289184/203989968-4639d6d5-15c9-4e57-bf01-c2eccd756642.mov">https://user-images.githubusercontent.com/13289184/203989968-4639d6d5-15c9-4e57-bf01-c2eccd756642.mov</a>, and copy the file <code>dotnet-codabix-wasm-build.wasm</code> also into this directory.</li>
<li>Run <code>ReproWasmtimeAccessViolation.exe</code>.</li>
</ul>
<p>After some seconds, the program will exit if the access violation occured (and in Windows Error Reporting, there will be an error entry in the Application log ("Application Error").<br>
If it didn't occur, the program will print <code>"wasmtime_func_call completed! This should not be displayed if the Access Violation occured."</code>, and you can use <code>Ctrl</code>+<code>C</code> to exit.</p>
<p>Unfortunately, the crash doesn't alway occur, it might also depend on the hardware or other factors. You may have to try a few times if the crash doesn't occur, or try again at a later time.</p>
<p>When attaching Visual Studio 2022 as debugger (using "native code" mode), it will show the following:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Exception</span><span class="w"> </span><span class="n">thrown</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mh">0x000002BB0392BD19</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ReproWasmtimeAccessViolation</span><span class="p">.</span><span class="n">exe</span>: <span class="mh">0xC0000005</span>: <span class="nc">Access</span><span class="w"> </span><span class="n">violation</span><span class="w"> </span><span class="n">writing</span><span class="w"> </span><span class="n">location</span><span class="w"> </span><span class="mh">0x000000CA214E4E80</span><span class="p">.</span><span class="w"></span>
</code></pre></div>
<p>Call Stack:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">&gt;</span><span class="w">   </span><span class="mi">000002</span><span class="n">bb0392bd19</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a369dc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03951aaf</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038caa53</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a2c701</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb039f78bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038caa53</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a2c701</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb039f78bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5a965</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03ac8ee0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03ac3058</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb04294c00</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb042df4c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03aaa51f</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0382174a</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038210d4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb044cf7bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb044cfdbb</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">wasmtime_setjmp</span><span class="w"></span><span class="p">()</span><span class="w"> </span><span class="n">C</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN16wasmtime_runtime12traphandlers84_</span><span class="cp">$LT$impl$u20$wasmtime_runtime</span><span class="o">..</span><span class="n">traphandlers</span><span class="o">..</span><span class="n">call_thread_state</span><span class="o">..</span><span class="n">CallThreadState</span><span class="cp">$GT$</span><span class="mi">4</span><span class="n">with17h74c010e2e721401eE</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN16wasmtime_runtime12traphandlers11catch_traps17h7bef31bead668a92E</span><span class="w"></span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN8wasmtime4func4Func18call_unchecked_raw17hcb0b0b7982c6fc66E</span><span class="p">.</span><span class="n">llvm</span><span class="p">.</span><span class="mi">11183561978299839151</span><span class="w"></span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN8wasmtime4func4Func9call_impl17hcb50041b4478fa06E</span><span class="p">.</span><span class="n">llvm</span><span class="p">.</span><span class="mi">11183561978299839151</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">wasmtime_func_call</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615ce96</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615cc68</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615c826</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615c66b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615a56b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615a0ac</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd55f3fd86</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd55f3ef8b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="n">Private</span><span class="p">.</span><span class="n">CoreLib</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffd3609274f</span><span class="p">()</span><span class="w">   </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5aaaac3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59a6d9c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5a8c413</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59836f5</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59835fa</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5983419</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">kernel32</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdeafe74b4</span><span class="p">()</span><span class="w"> </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">ntdll</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdeb2c26a1</span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
</code></pre></div>
<p>Additional notes:</p>
<ul>
<li>On my system, the crash reproduces in about 50% of the cases.</li>
<li>I can't seem to reproduce the crash when using Wasmtime debug build.</li>
</ul>
<p><strong>Environments</strong> where I can reproduce the crash:</p>
<ul>
<li>Environment 1:<ul>
<li>Hardware: Apple Mac mini (2018), with Parallels Desktop to run the Windows VM</li>
<li>CPU: Intel(R) Core(TM) i7-8700B CPU @ 3.20GHz   3.19 GHz</li>
<li>VM (Parallels Desktop): Windows 10 Pro x64 Build 19044 (in a VM)</li>
</ul>
</li>
<li>Environment 2:<ul>
<li>Hardware: Intel NUC8i7BEH</li>
<li>CPU: Intel Core i7-8559U</li>
<li>VM (VMware Player 16): Windows Server 2019 Build 17763</li>
</ul>
</li>
</ul>
<p>Thank you!</p>
</blockquote>



<a name="312869488"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312869488" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312869488">(Nov 29 2022 at 15:35)</a>:</h4>
<p>kpreisser edited <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Hi,</p>
<p>we are using <code>Wasmtime</code> via <a href="https://github.com/bytecodealliance/wasmtime-dotnet/"><code>wasmtime-dotnet</code></a> in a .NET 6.0 application, where we load a 8 MB WASM file and execute its <code>_start</code> function. However, this causes an <strong>access violation</strong> on Windows in <code>wasmtime_func_call</code> when using Wasmtime from commit ff5abfd9938c78cd75c6c5d6a41565097128c5d3.</p>
<p>The crash started to happen toegher with issue #5328 (with commit fc62d4ad65892837a1e1af5a9d67c8b0d4310efe), which is why I also reported it there, but it could be that this was just a trigger and the actual root case is a different one. It could also be that once #5328 is fixed, the access violation is no longer reproducible.</p>
<p>I can reproduce the access violation with the following steps on Windows 10 x64 Build 19044, and on Windows Server 2019:</p>
<ul>
<li>
<p>Build the Wasmtime C API from commit ff5abfd9938c78cd75c6c5d6a41565097128c5d3 on Windows for the current host (<code>x86_64-pc-windows-msvc</code>) as release build: <code>cargo build --release --manifest-path crates/c-api/Cargo.toml
</code></p>
</li>
<li>
<p>Install the <a href="https://dotnet.microsoft.com/en-us/download/dotnet/thank-you/sdk-6.0.403-windows-x64-installer">.NET SDK 6.0.403 for Windows x64</a>, which includes the .NET 6.0.11 runtime.</p>
</li>
<li>
<p>Clone <a href="https://github.com/kpreisser/wasmtime-dotnet">https://github.com/kpreisser/wasmtime-dotnet</a>, and switch to branch <code>repro-wasmtime-access-violation</code>, which contains a <a href="https://github.com/kpreisser/wasmtime-dotnet/commit/ccca66d68963c611b69f9edb4310bc75e4ef7da0">commit that adds the repro project</a> on top of the current <code>wasmtime-dotnet</code> code.<br>
  (The code contains a lot of fields/variables and some methods that are not used, but that was as best as I could get it while still reproducing the crash.)</p>
</li>
<li>
<p><code>cd</code> into the repo's <code>ReproWasmtimeAccessViolation</code> folder, then run <code>dotnet build ReproWasmtimeAccessViolation.csproj</code>.</p>
</li>
<li><code>cd bin\Debug\net6.0</code>, then copy <code>wasmtime.dll</code> and <code>wasmtime.pdb</code> from the build result into this directory.</li>
<li>Download the WASM file as .Zip file here (note: rename the .mov file to .zip ; I renamed it to be able to upload it here): <a href="https://user-images.githubusercontent.com/13289184/203989968-4639d6d5-15c9-4e57-bf01-c2eccd756642.mov">https://user-images.githubusercontent.com/13289184/203989968-4639d6d5-15c9-4e57-bf01-c2eccd756642.mov</a>, and copy the file <code>dotnet-codabix-wasm-build.wasm</code> also into this directory.</li>
<li>Run <code>ReproWasmtimeAccessViolation.exe</code>.</li>
</ul>
<p>After some seconds, the program will exit if the access violation occured (and in Windows Error Reporting, there will be an error entry in the Application log ("Application Error").<br>
If it didn't occur, the program will print <code>"wasmtime_func_call completed! This should not be displayed if the Access Violation occured."</code>, and you can use <code>Ctrl</code>+<code>C</code> to exit.</p>
<p>Unfortunately, the crash doesn't alway occur, it might also depend on the hardware or other factors. You may have to try a few times if the crash doesn't occur, or try again at a later time.</p>
<p>When attaching Visual Studio 2022 as debugger (using "native code" mode), it will show the following:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Exception</span><span class="w"> </span><span class="n">thrown</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mh">0x000002BB0392BD19</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ReproWasmtimeAccessViolation</span><span class="p">.</span><span class="n">exe</span>: <span class="mh">0xC0000005</span>: <span class="nc">Access</span><span class="w"> </span><span class="n">violation</span><span class="w"> </span><span class="n">writing</span><span class="w"> </span><span class="n">location</span><span class="w"> </span><span class="mh">0x000000CA214E4E80</span><span class="p">.</span><span class="w"></span>
</code></pre></div>
<p>Call Stack:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">&gt;</span><span class="w">   </span><span class="mi">000002</span><span class="n">bb0392bd19</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a369dc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03951aaf</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038caa53</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a2c701</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb039f78bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038caa53</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a2c701</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb039f78bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5a965</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03ac8ee0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03ac3058</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb04294c00</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb042df4c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03aaa51f</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0382174a</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038210d4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb044cf7bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb044cfdbb</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">wasmtime_setjmp</span><span class="w"></span><span class="p">()</span><span class="w"> </span><span class="n">C</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN16wasmtime_runtime12traphandlers84_</span><span class="cp">$LT$impl$u20$wasmtime_runtime</span><span class="o">..</span><span class="n">traphandlers</span><span class="o">..</span><span class="n">call_thread_state</span><span class="o">..</span><span class="n">CallThreadState</span><span class="cp">$GT$</span><span class="mi">4</span><span class="n">with17h74c010e2e721401eE</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN16wasmtime_runtime12traphandlers11catch_traps17h7bef31bead668a92E</span><span class="w"></span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN8wasmtime4func4Func18call_unchecked_raw17hcb0b0b7982c6fc66E</span><span class="p">.</span><span class="n">llvm</span><span class="p">.</span><span class="mi">11183561978299839151</span><span class="w"></span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN8wasmtime4func4Func9call_impl17hcb50041b4478fa06E</span><span class="p">.</span><span class="n">llvm</span><span class="p">.</span><span class="mi">11183561978299839151</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">wasmtime_func_call</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615ce96</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615cc68</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615c826</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615c66b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615a56b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615a0ac</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd55f3fd86</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd55f3ef8b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="n">Private</span><span class="p">.</span><span class="n">CoreLib</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffd3609274f</span><span class="p">()</span><span class="w">   </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5aaaac3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59a6d9c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5a8c413</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59836f5</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59835fa</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5983419</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">kernel32</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdeafe74b4</span><span class="p">()</span><span class="w"> </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">ntdll</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdeb2c26a1</span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
</code></pre></div>
<p>Additional notes:</p>
<ul>
<li>On my system, the crash reproduces in about 50% of the cases.</li>
<li>I can't seem to reproduce the crash when using Wasmtime debug build.</li>
</ul>
<p><strong>Environments</strong> where I can reproduce the crash:</p>
<ul>
<li>Environment 1:<ul>
<li>Hardware: Apple Mac mini (2018), with Parallels Desktop to run the Windows VM</li>
<li>CPU: Intel(R) Core(TM) i7-8700B CPU @ 3.20GHz   3.19 GHz</li>
<li>VM (Parallels Desktop): Windows 10 Pro x64 Build 19044 (in a VM)</li>
</ul>
</li>
<li>Environment 2:<ul>
<li>Hardware: Intel NUC8i7BEH</li>
<li>CPU: Intel Core i7-8559U</li>
<li>VM (VMware Player 16): Windows Server 2019 Build 17763</li>
</ul>
</li>
</ul>
<p>Thank you!</p>
</blockquote>



<a name="312872606"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312872606" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312872606">(Nov 29 2022 at 15:50)</a>:</h4>
<p>kpreisser edited <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Hi,</p>
<p>we are using <code>Wasmtime</code> via <a href="https://github.com/bytecodealliance/wasmtime-dotnet/"><code>wasmtime-dotnet</code></a> in a .NET 6.0 application, where we load a 8 MB WASM file and execute its <code>_start</code> function. However, this causes an <strong>access violation</strong> on Windows in <code>wasmtime_func_call</code> when using Wasmtime from commit ff5abfd9938c78cd75c6c5d6a41565097128c5d3.</p>
<p>The crash started to happen toegher with issue #5328 (with commit fc62d4ad65892837a1e1af5a9d67c8b0d4310efe), which is why I also reported it there, but it could be that this was just a trigger and the actual root case is a different one. It could also be that once #5328 is fixed, the access violation is no longer reproducible.</p>
<p>I can reproduce the access violation with the following steps on Windows 10 x64 Build 19044, and on Windows Server 2019:</p>
<ul>
<li>
<p>Build the Wasmtime C API from commit ff5abfd9938c78cd75c6c5d6a41565097128c5d3 on Windows for the current host (<code>x86_64-pc-windows-msvc</code>) as release build: <code>cargo build --release --manifest-path crates/c-api/Cargo.toml
</code></p>
</li>
<li>
<p>Install the <a href="https://dotnet.microsoft.com/en-us/download/dotnet/thank-you/sdk-6.0.403-windows-x64-installer">.NET SDK 6.0.403 for Windows x64</a>, which includes the .NET 6.0.11 runtime.</p>
</li>
<li>
<p>Clone <a href="https://github.com/kpreisser/wasmtime-dotnet">https://github.com/kpreisser/wasmtime-dotnet</a>, and switch to branch <code>repro-wasmtime-access-violation</code>, which contains a <a href="https://github.com/kpreisser/wasmtime-dotnet/commit/ccca66d68963c611b69f9edb4310bc75e4ef7da0">commit that adds the repro project</a> on top of the current <code>wasmtime-dotnet</code> code.<br>
  (The code contains a lot of fields/variables and some methods that are not used, but that was as best as I could get it while still reproducing the crash.)</p>
</li>
<li>
<p><code>cd</code> into the repo's <code>ReproWasmtimeAccessViolation</code> folder, then run <code>dotnet build ReproWasmtimeAccessViolation.csproj</code>.</p>
</li>
<li><code>cd bin\Debug\net6.0</code>, then copy <code>wasmtime.dll</code> and <code>wasmtime.pdb</code> from the build result into this directory.</li>
<li>Download the WASM file as .Zip file here (note: rename the .mov file to .zip ; I renamed it to be able to upload it here): <a href="https://user-images.githubusercontent.com/13289184/203989968-4639d6d5-15c9-4e57-bf01-c2eccd756642.mov">https://user-images.githubusercontent.com/13289184/203989968-4639d6d5-15c9-4e57-bf01-c2eccd756642.mov</a>, and copy the file <code>dotnet-codabix-wasm-build.wasm</code> also into this directory.</li>
<li>Run <code>ReproWasmtimeAccessViolation.exe</code>.</li>
</ul>
<p>After some seconds, the program will exit if the access violation occured (and in Windows Error Reporting, there will be an error entry in the Application log ("Application Error").<br>
If it didn't occur, the program will print <code>"wasmtime_func_call completed! This should not be displayed if the Access Violation occured."</code>, and you can use <code>Ctrl</code>+<code>C</code> to exit.</p>
<p>Unfortunately, the crash doesn't alway occur, it might also depend on the hardware or other factors. You may have to try a few times if the crash doesn't occur, or try again at a later time.</p>
<p>When attaching Visual Studio 2022 as debugger (using "native code" mode), it will show the following:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Exception</span><span class="w"> </span><span class="n">thrown</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mh">0x000002BB0392BD19</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ReproWasmtimeAccessViolation</span><span class="p">.</span><span class="n">exe</span>: <span class="mh">0xC0000005</span>: <span class="nc">Access</span><span class="w"> </span><span class="n">violation</span><span class="w"> </span><span class="n">writing</span><span class="w"> </span><span class="n">location</span><span class="w"> </span><span class="mh">0x000000CA214E4E80</span><span class="p">.</span><span class="w"></span>
</code></pre></div>
<p>Call Stack:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">&gt;</span><span class="w">   </span><span class="mi">000002</span><span class="n">bb0392bd19</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a369dc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03951aaf</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038caa53</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a2c701</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb039f78bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038caa53</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a2c701</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb039f78bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5a965</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03ac8ee0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03ac3058</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb04294c00</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb042df4c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03aaa51f</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0382174a</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038210d4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb044cf7bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb044cfdbb</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">wasmtime_setjmp</span><span class="w"></span><span class="p">()</span><span class="w"> </span><span class="n">C</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN16wasmtime_runtime12traphandlers84_</span><span class="cp">$LT$impl$u20$wasmtime_runtime</span><span class="o">..</span><span class="n">traphandlers</span><span class="o">..</span><span class="n">call_thread_state</span><span class="o">..</span><span class="n">CallThreadState</span><span class="cp">$GT$</span><span class="mi">4</span><span class="n">with17h74c010e2e721401eE</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN16wasmtime_runtime12traphandlers11catch_traps17h7bef31bead668a92E</span><span class="w"></span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN8wasmtime4func4Func18call_unchecked_raw17hcb0b0b7982c6fc66E</span><span class="p">.</span><span class="n">llvm</span><span class="p">.</span><span class="mi">11183561978299839151</span><span class="w"></span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN8wasmtime4func4Func9call_impl17hcb50041b4478fa06E</span><span class="p">.</span><span class="n">llvm</span><span class="p">.</span><span class="mi">11183561978299839151</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">wasmtime_func_call</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615ce96</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615cc68</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615c826</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615c66b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615a56b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615a0ac</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd55f3fd86</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd55f3ef8b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="n">Private</span><span class="p">.</span><span class="n">CoreLib</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffd3609274f</span><span class="p">()</span><span class="w">   </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5aaaac3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59a6d9c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5a8c413</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59836f5</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59835fa</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5983419</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">kernel32</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdeafe74b4</span><span class="p">()</span><span class="w"> </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">ntdll</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdeb2c26a1</span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
</code></pre></div>
<p>Additional notes:</p>
<ul>
<li>On my system, the crash reproduces in about 50% of the cases.</li>
<li>I can't seem to reproduce the crash when using Wasmtime debug build.</li>
</ul>
<p><strong>Environments</strong> where I can reproduce the crash:</p>
<ul>
<li>Environment 1:<ul>
<li>Hardware: Apple Mac mini (2018), with Parallels Desktop to run the Windows VM</li>
<li>CPU: Intel(R) Core(TM) i7-8700B CPU @ 3.20GHz   3.19 GHz</li>
<li>VM (Parallels Desktop on macOS): Windows 10 Pro x64 Build 19044 (in a VM)</li>
</ul>
</li>
<li>Environment 2:<ul>
<li>Hardware: Intel NUC8i7BEH</li>
<li>CPU: Intel Core i7-8559U</li>
<li>VM (VMware Player 16 on Window 10 Build 19044): Windows Server 2019 Build 17763</li>
</ul>
</li>
</ul>
<p>Thank you!</p>
</blockquote>



<a name="312877481"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312877481" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312877481">(Nov 29 2022 at 16:11)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1330891072">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Thanks for this! I've read over the source and I don't have a Windows machine on-hand to reproduce with but I've been trying to debug by correlating what's happening in the compiled artifact using the addresses from the backtrace you have. Unfortunately though the image I'm compiling locally seems to have functions at different offsets so I can't get things to line up.</p>
<p>Reading over the code though it looks like this has threading involved, possible GC interactions with .NET, and additionally the reproduction you mention is nondeterministic. @peterhuene would you be able to take a look at this? I've encountered similar-ish issues with the Go bindings historically and it was an often an error in the bindings and how the bindings interacted with the GC so I'm curious if anything jumps out at you here.</p>
</blockquote>



<a name="312895399"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312895399" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312895399">(Nov 29 2022 at 17:31)</a>:</h4>
<p>kpreisser <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331023340">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Hi @alexcrichton thanks for your reply!</p>
<p>That's a good point about the GC, which also applies to the repro project. I <a href="https://github.com/kpreisser/wasmtime-dotnet/commit/82bb8c514f085af58a45899793fe26a0e99201de">modified the code</a> of the repro project to ensure the Wasmtime objects (<code>Config</code>, <code>Engine</code>, <code>Module</code>, <code>Linker</code>, <code>Store</code>) are kept alive while the wasm function is executed (like it is also the case in our real application), so that there shouldn't be any possibility for the GC to prematurely call the finalizer of those objects (or their referenced <code>SafeHandle</code>s) when it detects that the references are no longer in use.<br>
(Sometimes, the .NET runtime can even consider the <code>this</code> pointer within an instance method to no longer be alive when it isn't used in that method.)</p>
<p>The access violation still reproduces for me with these changes. I also tried putting break points in the various <code>Handle.ReleaseHandle()</code> methods in <code>Wasmtime.Dotnet</code> for the above mentioned objects (which call <code>wasm_config_delete</code>, <code>wasm_engine_delete</code>, <code>wasmtime_module_delete</code>, <code>wasmtime_linker_delete</code>, and <code>wasmtime_store_delete</code>), and it seems they are not called when the access violation occurs; only when it doesn't occur they are getting called as expected.</p>
<p>Thanks!</p>
</blockquote>



<a name="312895444"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312895444" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312895444">(Nov 29 2022 at 17:31)</a>:</h4>
<p>kpreisser edited <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Hi,</p>
<p>we are using <code>Wasmtime</code> via <a href="https://github.com/bytecodealliance/wasmtime-dotnet/"><code>wasmtime-dotnet</code></a> in a .NET 6.0 application, where we load a 8 MB WASM file and execute its <code>_start</code> function. However, this causes an <strong>access violation</strong> on Windows in <code>wasmtime_func_call</code> when using Wasmtime from commit ff5abfd9938c78cd75c6c5d6a41565097128c5d3.</p>
<p>The crash started to happen toegher with issue #5328 (with commit fc62d4ad65892837a1e1af5a9d67c8b0d4310efe), which is why I also reported it there, but it could be that this was just a trigger and the actual root case is a different one. It could also be that once #5328 is fixed, the access violation is no longer reproducible.</p>
<p>I can reproduce the access violation with the following steps on Windows 10 x64 Build 19044, and on Windows Server 2019:</p>
<ul>
<li>
<p>Build the Wasmtime C API from commit ff5abfd9938c78cd75c6c5d6a41565097128c5d3 on Windows for the current host (<code>x86_64-pc-windows-msvc</code>) as release build: <code>cargo build --release --manifest-path crates/c-api/Cargo.toml
</code></p>
</li>
<li>
<p>Install the <a href="https://dotnet.microsoft.com/en-us/download/dotnet/thank-you/sdk-6.0.403-windows-x64-installer">.NET SDK 6.0.403 for Windows x64</a>, which includes the .NET 6.0.11 runtime.</p>
</li>
<li>
<p>Clone <a href="https://github.com/kpreisser/wasmtime-dotnet">https://github.com/kpreisser/wasmtime-dotnet</a>, and switch to branch <code>repro-wasmtime-access-violation</code>, which contains a <a href="https://github.com/kpreisser/wasmtime-dotnet/commit/82bb8c514f085af58a45899793fe26a0e99201de">commit that adds the repro project</a> on top of the current <code>wasmtime-dotnet</code> code.<br>
  (The code contains a lot of fields/variables and some methods that are not used, but that was as best as I could get it while still reproducing the crash.)</p>
</li>
<li>
<p><code>cd</code> into the repo's <code>ReproWasmtimeAccessViolation</code> folder, then run <code>dotnet build ReproWasmtimeAccessViolation.csproj</code>.</p>
</li>
<li><code>cd bin\Debug\net6.0</code>, then copy <code>wasmtime.dll</code> and <code>wasmtime.pdb</code> from the build result into this directory.</li>
<li>Download the WASM file as .Zip file here (note: rename the .mov file to .zip ; I renamed it to be able to upload it here): <a href="https://user-images.githubusercontent.com/13289184/203989968-4639d6d5-15c9-4e57-bf01-c2eccd756642.mov">https://user-images.githubusercontent.com/13289184/203989968-4639d6d5-15c9-4e57-bf01-c2eccd756642.mov</a>, and copy the file <code>dotnet-codabix-wasm-build.wasm</code> also into this directory.</li>
<li>Run <code>ReproWasmtimeAccessViolation.exe</code>.</li>
</ul>
<p>After some seconds, the program will exit if the access violation occured (and in Windows Error Reporting, there will be an error entry in the Application log ("Application Error").<br>
If it didn't occur, the program will print <code>"wasmtime_func_call completed! This should not be displayed if the Access Violation occured."</code>, and you can use <code>Ctrl</code>+<code>C</code> to exit.</p>
<p>Unfortunately, the crash doesn't alway occur, it might also depend on the hardware or other factors. You may have to try a few times if the crash doesn't occur, or try again at a later time.</p>
<p>When attaching Visual Studio 2022 as debugger (using "native code" mode), it will show the following:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Exception</span><span class="w"> </span><span class="n">thrown</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mh">0x000002BB0392BD19</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ReproWasmtimeAccessViolation</span><span class="p">.</span><span class="n">exe</span>: <span class="mh">0xC0000005</span>: <span class="nc">Access</span><span class="w"> </span><span class="n">violation</span><span class="w"> </span><span class="n">writing</span><span class="w"> </span><span class="n">location</span><span class="w"> </span><span class="mh">0x000000CA214E4E80</span><span class="p">.</span><span class="w"></span>
</code></pre></div>
<p>Call Stack:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">&gt;</span><span class="w">   </span><span class="mi">000002</span><span class="n">bb0392bd19</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a369dc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03951aaf</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038caa53</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a2c701</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb039f78bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038caa53</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a2c701</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb039f78bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5a965</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03ac8ee0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03ac3058</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb04294c00</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb042df4c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03aaa51f</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0382174a</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038210d4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb044cf7bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb044cfdbb</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">wasmtime_setjmp</span><span class="w"></span><span class="p">()</span><span class="w"> </span><span class="n">C</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN16wasmtime_runtime12traphandlers84_</span><span class="cp">$LT$impl$u20$wasmtime_runtime</span><span class="o">..</span><span class="n">traphandlers</span><span class="o">..</span><span class="n">call_thread_state</span><span class="o">..</span><span class="n">CallThreadState</span><span class="cp">$GT$</span><span class="mi">4</span><span class="n">with17h74c010e2e721401eE</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN16wasmtime_runtime12traphandlers11catch_traps17h7bef31bead668a92E</span><span class="w"></span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN8wasmtime4func4Func18call_unchecked_raw17hcb0b0b7982c6fc66E</span><span class="p">.</span><span class="n">llvm</span><span class="p">.</span><span class="mi">11183561978299839151</span><span class="w"></span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN8wasmtime4func4Func9call_impl17hcb50041b4478fa06E</span><span class="p">.</span><span class="n">llvm</span><span class="p">.</span><span class="mi">11183561978299839151</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">wasmtime_func_call</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615ce96</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615cc68</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615c826</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615c66b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615a56b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615a0ac</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd55f3fd86</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd55f3ef8b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="n">Private</span><span class="p">.</span><span class="n">CoreLib</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffd3609274f</span><span class="p">()</span><span class="w">   </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5aaaac3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59a6d9c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5a8c413</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59836f5</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59835fa</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5983419</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">kernel32</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdeafe74b4</span><span class="p">()</span><span class="w"> </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">ntdll</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdeb2c26a1</span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
</code></pre></div>
<p>Additional notes:</p>
<ul>
<li>On my system, the crash reproduces in about 50% of the cases.</li>
<li>I can't seem to reproduce the crash when using Wasmtime debug build.</li>
</ul>
<p><strong>Environments</strong> where I can reproduce the crash:</p>
<ul>
<li>Environment 1:<ul>
<li>Hardware: Apple Mac mini (2018), with Parallels Desktop to run the Windows VM</li>
<li>CPU: Intel(R) Core(TM) i7-8700B CPU @ 3.20GHz   3.19 GHz</li>
<li>VM (Parallels Desktop on macOS): Windows 10 Pro x64 Build 19044 (in a VM)</li>
</ul>
</li>
<li>Environment 2:<ul>
<li>Hardware: Intel NUC8i7BEH</li>
<li>CPU: Intel Core i7-8559U</li>
<li>VM (VMware Player 16 on Window 10 Build 19044): Windows Server 2019 Build 17763</li>
</ul>
</li>
</ul>
<p>Thank you!</p>
</blockquote>



<a name="312895744"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312895744" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312895744">(Nov 29 2022 at 17:33)</a>:</h4>
<p>kpreisser edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331023340">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Hi @alexcrichton thanks for your reply!</p>
<p>That's a good point about the GC, which also applies to the repro project. I <a href="https://github.com/kpreisser/wasmtime-dotnet/commit/82bb8c514f085af58a45899793fe26a0e99201de">modified the code</a> of the repro project to ensure the Wasmtime objects (<code>Config</code>, <code>Engine</code>, <code>Module</code>, <code>Linker</code>, <code>Store</code>) are kept alive while the wasm function is executed (like it is also the case in our real application), so that there shouldn't be any possibility for the GC to prematurely call the finalizer of those objects (or their referenced <code>SafeHandle</code>s) when it detects that the references are no longer in use.<br>
(Sometimes, the .NET runtime can even consider the <code>this</code> pointer within an instance method (while it still executes) to no longer be alive when it isn't used in that method.)</p>
<p>The access violation still reproduces for me with these changes. I also tried putting break points in the various <code>Handle.ReleaseHandle()</code> methods in <code>Wasmtime.Dotnet</code> for the above mentioned objects (which call <code>wasm_config_delete</code>, <code>wasm_engine_delete</code>, <code>wasmtime_module_delete</code>, <code>wasmtime_linker_delete</code>, and <code>wasmtime_store_delete</code>), and it seems they are not called when the access violation occurs; only when it doesn't occur they are getting called as expected.</p>
<p>Thanks!</p>
</blockquote>



<a name="312895791"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312895791" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312895791">(Nov 29 2022 at 17:33)</a>:</h4>
<p>kpreisser edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331023340">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Hi @alexcrichton thanks for your reply!</p>
<p>That's a good point about the GC, which also applies to the repro project. I <a href="https://github.com/kpreisser/wasmtime-dotnet/commit/82bb8c514f085af58a45899793fe26a0e99201de">modified the code</a> of the repro project to ensure the Wasmtime objects (<code>Config</code>, <code>Engine</code>, <code>Module</code>, <code>Linker</code>, <code>Store</code>) are kept alive while the wasm function is executed (like it is also the case in our real application), so that there shouldn't be any possibility for the GC to prematurely call the finalizer of those objects (or their referenced <code>SafeHandle</code>s) when it detects that the references are no longer in use.<br>
(Sometimes, the .NET runtime can even consider the <code>this</code> pointer within an instance method (while it's still executing) to no longer be alive when it isn't used in that method.)</p>
<p>The access violation still reproduces for me with these changes. I also tried putting break points in the various <code>Handle.ReleaseHandle()</code> methods in <code>Wasmtime.Dotnet</code> for the above mentioned objects (which call <code>wasm_config_delete</code>, <code>wasm_engine_delete</code>, <code>wasmtime_module_delete</code>, <code>wasmtime_linker_delete</code>, and <code>wasmtime_store_delete</code>), and it seems they are not called when the access violation occurs; only when it doesn't occur they are getting called as expected.</p>
<p>Thanks!</p>
</blockquote>



<a name="312895858"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312895858" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312895858">(Nov 29 2022 at 17:33)</a>:</h4>
<p>kpreisser edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331023340">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Hi @alexcrichton thanks for your reply!</p>
<p>That's a good point about the GC, which also applies to the repro project. I <a href="https://github.com/kpreisser/wasmtime-dotnet/commit/82bb8c514f085af58a45899793fe26a0e99201de">modified the code</a> of the repro project to ensure the Wasmtime objects (<code>Config</code>, <code>Engine</code>, <code>Module</code>, <code>Linker</code>, <code>Store</code>) are kept alive while the wasm function is executed (like it is also the case in our real application), so that there shouldn't be any possibility for the GC to prematurely call the finalizer of those objects (or their referenced <code>SafeHandle</code>s) when it detects that the references are no longer in use.<br>
(Sometimes, the .NET runtime can even consider the <code>this</code> pointer within an instance method (while it's still executing) to no longer be alive when <code>this</code> isn't used in that method.)</p>
<p>The access violation still reproduces for me with these changes. I also tried putting break points in the various <code>Handle.ReleaseHandle()</code> methods in <code>Wasmtime.Dotnet</code> for the above mentioned objects (which call <code>wasm_config_delete</code>, <code>wasm_engine_delete</code>, <code>wasmtime_module_delete</code>, <code>wasmtime_linker_delete</code>, and <code>wasmtime_store_delete</code>), and it seems they are not called when the access violation occurs; only when it doesn't occur they are getting called as expected.</p>
<p>Thanks!</p>
</blockquote>



<a name="312898270"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312898270" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312898270">(Nov 29 2022 at 17:45)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331042337">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>@kpreisser thanks for the report and the additional details. I'll investigate this immediately and follow up when I have new information to share.</p>
</blockquote>



<a name="312911540"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312911540" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312911540">(Nov 29 2022 at 18:51)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331136216">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>The AV is a result of a wasm frame overflowing the stack, where the frame size exceeds the guard page size (thus it tries to write to unmapped memory).</p>
<p>I haven't looked too closely at the cranelift issue, but I suspect it's related (digging into it now).</p>
</blockquote>



<a name="312912176"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312912176" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312912176">(Nov 29 2022 at 18:54)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331136216">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>The AV is a result of a wasm frame overflowing the stack, where the frame size exceeds the guard page size (thus it tries to write to unmapped memory).  It is passing the overflow check in the prologue.</p>
<p>I haven't looked too closely at the cranelift issue, but I suspect it's related (digging into it now).</p>
</blockquote>



<a name="312912332"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312912332" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312912332">(Nov 29 2022 at 18:55)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331140516">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Oh! I noticed the <a href="https://github.com/kpreisser/wasmtime-dotnet/commit/ccca66d68963c611b69f9edb4310bc75e4ef7da0#diff-224624d97808300ad37f64316f374222436ce9e06ec17023ec660f546b70c0dbR133">stack size increase</a> which now that I think about it I think that may be larger than the default 1MB stack size on Windows?</p>
<p>The stack safety in Wasmtime relies on the embedder ensuring there's at least that much wasm stack available so if the new thread doesn't have 2MB+ of wasm stack then I think this could happen.</p>
</blockquote>



<a name="312912489"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312912489" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312912489">(Nov 29 2022 at 18:56)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331141261">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>It repros without it too (that is indeed a misconfiguration without also increasing the stack size when creating the thread).</p>
</blockquote>



<a name="312912560"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312912560" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312912560">(Nov 29 2022 at 18:56)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331141261">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>It repros with the default wasm stack size too (that is indeed a misconfiguration without also increasing the stack size when creating the thread).</p>
</blockquote>



<a name="312913112"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312913112" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312913112">(Nov 29 2022 at 18:59)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331147982">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Actually, I take that back as I was debugging off a stale binary; this appears to be just a misconfiguration of the engine where the stack isn't being increased for the native thread the wasm call is operating on.</p>
</blockquote>



<a name="312913317"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312913317" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312913317">(Nov 29 2022 at 19:00)</a>:</h4>
<p>peterhuene deleted a <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331147982">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Actually, I take that back as I was debugging off a stale binary; this appears to be just a misconfiguration of the engine where the stack isn't being increased for the native thread the wasm call is operating on.</p>
</blockquote>



<a name="312913676"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312913676" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312913676">(Nov 29 2022 at 19:02)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331153224">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Ah ok makes sense!</p>
<p>This is perhaps a case where Cranelift could help out where we could insert stack probes in addition to the stack check we have today where the probes could guarantee a segfault to deterministically exit. I don't think we'll want to catch this as a stack overflow trap but reporting this with a better error message I think could be useful.</p>
</blockquote>



<a name="312914051"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312914051" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312914051">(Nov 29 2022 at 19:04)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331157894">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>I stand corrected _again_. It is still reproing with the default wasm stack size; the AV is inconsistent.</p>
</blockquote>



<a name="312914202"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312914202" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312914202">(Nov 29 2022 at 19:05)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331157894">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>I stand corrected _again_. It is still reproing with the default wasm stack size; the AV is inconsistent (probably getting some mapped memory beyond the guard page on some runs).</p>
</blockquote>



<a name="312915342"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312915342" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312915342">(Nov 29 2022 at 19:06)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331157894">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>I stand corrected _again_. It is still reproing with the default wasm stack size; the AV is inconsistent (probably getting some mapped memory beyond the guard page on some runs).</p>
<p>I'm digging into why it's not triggering the overflow trap.</p>
</blockquote>



<a name="312915537"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312915537" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312915537">(Nov 29 2022 at 19:07)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331157894">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>I stand corrected _again_. It is still reproing with the default wasm stack size; the AV is inconsistent (probably getting some mapped writable memory beyond the guard page on some runs).</p>
<p>I'm digging into why it's not triggering the overflow trap.</p>
</blockquote>



<a name="312915678"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312915678" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312915678">(Nov 29 2022 at 19:07)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331165149">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Cranelift has an <code>enable_probestack</code> option, along with a couple choices for <code>probestack_strategy</code> and a knob for <code>probestack_size_log2</code>. Wasmtime enforces that these options are disabled though, in <code>check_compatible_with_shared_flag</code>.</p>
</blockquote>



<a name="312915930"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312915930" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312915930">(Nov 29 2022 at 19:09)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331157894">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>I stand corrected _again_. It is still reproing with the default wasm stack size; the AV is inconsistent (probably getting some mapped writable memory beyond the guard page on some runs).</p>
<p>I'm digging into why it's not triggering the overflow trap (my guess is too much host stack consumed at wasm entrypoint?).</p>
</blockquote>



<a name="312918639"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312918639" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312918639">(Nov 29 2022 at 19:17)</a>:</h4>
<p>kpreisser <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331175599">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Thank you for the investigation and updates!</p>
<p>Regarding the stack size, note that the access violation also occurs if I set the stack size to 8 MB (<code>8388608</code>), e.g. in the <code>Thread</code> constructor, or by using <code>editbin /stack:xyz</code> to set the default thread stack size (the <code>editbin</code> command is actually what we do in our real application, where the access violation also occurs).<br>
So I would think the 2 MB stack size in Wasmtime should be fine when the thread's stack size is 8 MB? (I will also update the repro project with the new stack size)</p>
</blockquote>



<a name="312918719"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312918719" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312918719">(Nov 29 2022 at 19:17)</a>:</h4>
<p>kpreisser edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331175599">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Thank you for the investigation and updates!</p>
<p>Regarding the stack size, note that the access violation also occurs if I set the thread stack size to 8 MB (<code>8388608</code>), e.g. in the <code>Thread</code> constructor, or by using <code>editbin /stack:xyz</code> to set the default thread stack size (the <code>editbin</code> command is actually what we do in our real application, where the access violation also occurs).<br>
So I would think the 2 MB stack size in Wasmtime should be fine when the thread's stack size is 8 MB? (I will also update the repro project with the new stack size)</p>
</blockquote>



<a name="312920049"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312920049" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312920049">(Nov 29 2022 at 19:23)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331157894">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>I stand corrected _again_. It is still reproing with the default wasm stack size; the AV is inconsistent (probably getting some mapped writable memory beyond the guard page on some runs).</p>
<p>I'm digging into why it's not triggering the overflow trap.</p>
</blockquote>



<a name="312921325"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312921325" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312921325">(Nov 29 2022 at 19:30)</a>:</h4>
<p>kpreisser edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331175599">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Thank you for the investigation and updates!</p>
<p>Regarding the stack size, note that the access violation also occurs if I set the thread stack size to 8 MB (<code>8388608</code>), e.g. in the <code>Thread</code> constructor, or by using <code>editbin /stack:xyz</code> to set the default thread stack size (the <code>editbin</code> command is actually what we do in our real application, where the access violation also occurs).<br>
So I would think the 2 MB stack size in Wasmtime should be fine when the thread's stack size is 8 MB? (I have <a href="https://github.com/kpreisser/wasmtime-dotnet/commit/6639bf143a65cd8bd034acf9f0655cab48b5aa72">updated the repro project</a> with the new stack size; I previously forgot this in the repro project.)</p>
</blockquote>



<a name="312921405"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312921405" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312921405">(Nov 29 2022 at 19:30)</a>:</h4>
<p>kpreisser edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331175599">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Thank you for the investigation and updates!</p>
<p>Regarding the stack size, note that the access violation also occurs if I set the thread stack size to 8 MB (<code>8388608</code>), e.g. in the <code>Thread</code> constructor, or by using <code>editbin /stack:xyz</code> to set the default thread stack size (the <code>editbin</code> command is actually what we do in our real application, where the access violation also occurs).<br>
So I would think the 2 MB stack size in Wasmtime should be fine when the thread's stack size is 8 MB? (I have <a href="https://github.com/kpreisser/wasmtime-dotnet/commit/6639bf143a65cd8bd034acf9f0655cab48b5aa72">updated the repro project</a> with the new stack size; I previously forgot this there.)</p>
</blockquote>



<a name="312921427"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312921427" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312921427">(Nov 29 2022 at 19:30)</a>:</h4>
<p>kpreisser edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331175599">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Thank you for the investigation and updates!</p>
<p>Regarding the stack size, note that the access violation also occurs if I set the thread stack size to 8 MB (<code>8388608</code>), e.g. in the <code>Thread</code> constructor, or by using <code>editbin /stack:xyz</code> to set the default thread stack size (the <code>editbin</code> command is actually what we do in our real application, where the access violation also occurs).<br>
So I would think the 2 MB stack size in Wasmtime should be fine when the thread's stack size is 8 MB? (I have <a href="https://github.com/kpreisser/wasmtime-dotnet/commit/6639bf143a65cd8bd034acf9f0655cab48b5aa72">updated the repro project</a> with the new stack size; I previously forgot this there.)</p>
<p>Thanks!</p>
</blockquote>



<a name="312921752"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312921752" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312921752">(Nov 29 2022 at 19:32)</a>:</h4>
<p>kpreisser edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331175599">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Thank you for the investigation and updates!</p>
<p>Regarding the stack size, note that the access violation also occurs if I set the thread stack size to 8 MiB (<code>8388608</code>), e.g. in the <code>Thread</code> constructor, or by using <code>editbin /stack:xyz</code> to set the default thread stack size (the <code>editbin</code> command is actually what we do in our real application, where the access violation also occurs).<br>
So I would think the 2 MiB stack size in Wasmtime should be fine when the thread's stack size is 8 MiB? (I have <a href="https://github.com/kpreisser/wasmtime-dotnet/commit/6639bf143a65cd8bd034acf9f0655cab48b5aa72">updated the repro project</a> to set the thread's stack size to 8 MiB; I previously forgot this there.)</p>
<p>Thanks!</p>
</blockquote>



<a name="312922970"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312922970" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312922970">(Nov 29 2022 at 19:39)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331197220">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>On Windows we need stackprobes anyways to grow the stack. As I understand it on Windows only a small part is committed by default and directly below it is a guard page which if accessed will cause the stack to grow a bit. If you access even a single page below the guard page you will get an AV even though it is still in the part of the memory reserved for the stack. cg_clif also had access violations on windows in some cases which it fixed by enabling inline stack probes. cc <a href="https://github.com/bjorn3/rustc_codegen_cranelift/issues/1261#issuecomment-1219307630">https://github.com/bjorn3/rustc_codegen_cranelift/issues/1261#issuecomment-1219307630</a></p>
</blockquote>



<a name="312925506"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312925506" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312925506">(Nov 29 2022 at 19:54)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331215493">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>@bjorn3 thanks for the reminder as I've willfully purged my Windows knowledge these past few years!</p>
<p>This is indeed what is happening here; the frame is larger than the commit size in the PE header (4KiB), so it's not triggering a fault on the guard page for Windows to commit more stack pages.</p>
<p>We should definitely be forcing a probe on Windows for any frame larger than 4 KiB at a minimum.</p>
</blockquote>



<a name="312926377"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312926377" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312926377">(Nov 29 2022 at 19:58)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331224906">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Also, I will note that the default thread stack size for a 64-bit .NET core apphost is 1.5 MiB and at the fault there was still plenty of wasm stack space left (hence why it succeeded the prologue overflow check), it just didn't probe to get Windows to commit more pages.</p>
</blockquote>



<a name="312926754"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312926754" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312926754">(Nov 29 2022 at 20:00)</a>:</h4>
<p>kpreisser <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331226813">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Thank you! When I modify the repro to allocate (and immediately free) 6 MiB on the stack in the thread when it is started, e.g. with the following code (note that .NET by default initializes stack memory to zero):</p>
<div class="codehilite" data-code-language="C#"><pre><span></span><code><span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">RunWasmInitializerThread</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">void</span><span class="w"> </span><span class="nf">AllocStack</span><span class="p">()</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">Span</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">&gt;</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">stackalloc</span><span class="w"> </span><span class="kt">byte</span><span class="p">[</span><span class="m">6</span><span class="w"> </span><span class="p">*</span><span class="w"> </span><span class="m">1024</span><span class="w"> </span><span class="p">*</span><span class="w"> </span><span class="m">1024</span><span class="p">];</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">AllocStack</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="c1">// ...</span>
</code></pre></div>
<p>then I'm no longer able to reproduce the access violation, which seems to confirm this.</p>
</blockquote>



<a name="312927628"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312927628" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312927628">(Nov 29 2022 at 20:05)</a>:</h4>
<p>kpreisser edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331226813">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Thank you! When I modify the repro to allocate (and immediately free) 6 MiB on the stack in the thread when it is started, e.g. with the following code (note that .NET by default initializes stack memory to zero):</p>
<div class="codehilite" data-code-language="C#"><pre><span></span><code><span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">RunWasmInitializerThread</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">void</span><span class="w"> </span><span class="nf">AllocStack</span><span class="p">()</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">Span</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">&gt;</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">stackalloc</span><span class="w"> </span><span class="kt">byte</span><span class="p">[</span><span class="m">6</span><span class="w"> </span><span class="p">*</span><span class="w"> </span><span class="m">1024</span><span class="w"> </span><span class="p">*</span><span class="w"> </span><span class="m">1024</span><span class="p">];</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">AllocStack</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="c1">// ...</span>
</code></pre></div>
<p>then I'm no longer able to reproduce the access violation.</p>
</blockquote>



<a name="312928782"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312928782" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312928782">(Nov 29 2022 at 20:11)</a>:</h4>
<p>kpreisser edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331226813">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Thank you! When I modify the repro to allocate (and immediately free) 6 MiB on the stack in the thread when it is started, e.g. with the following code (note that .NET by default initializes stack memory to zero):</p>
<div class="codehilite" data-code-language="C#"><pre><span></span><code><span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">RunWasmInitializerThread</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">void</span><span class="w"> </span><span class="nf">AllocStack</span><span class="p">()</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">Span</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">&gt;</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">stackalloc</span><span class="w"> </span><span class="kt">byte</span><span class="p">[</span><span class="m">6</span><span class="w"> </span><span class="p">*</span><span class="w"> </span><span class="m">1024</span><span class="w"> </span><span class="p">*</span><span class="w"> </span><span class="m">1024</span><span class="p">];</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">AllocStack</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="c1">// ...</span>
</code></pre></div>
<p>then I'm indeed no longer able to reproduce the access violation.</p>
</blockquote>



<a name="312931404"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312931404" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312931404">(Nov 29 2022 at 20:26)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331256628">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>FYI, I believe function 217 in the module to be the faulting function as it has over 800 locals!</p>
</blockquote>



<a name="312931937"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312931937" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312931937">(Nov 29 2022 at 20:30)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331256628">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>FYI, I believe function 311 in the module to be the faulting function as it has thousands of locals!</p>
</blockquote>



<a name="312932405"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312932405" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312932405">(Nov 29 2022 at 20:32)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331256628">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>FYI, I believe function 311 in the module to be the faulting function as it has thousands of locals (lol the <code>wasm-tools print</code> prints to column 150221 for the locals declaration)!</p>
</blockquote>



<a name="312932440"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312932440" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312932440">(Nov 29 2022 at 20:32)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331256628">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>FYI, I believe function 311 in the module to be the faulting function as it has thousands of locals (lol: <code>wasm-tools print</code> prints to column 150221 for the locals declaration)!</p>
</blockquote>



<a name="312950570"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312950570" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312950570">(Nov 29 2022 at 22:31)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331403836">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Here's a <a href="https://gist.github.com/peterhuene/530ec6292cd2fcfff9a1465ac1eb1c84">simplified wat</a> that reproduces the problem. It has a function with a frame size of 80192 bytes and that consistently gets <code>wasmtime repro.wat</code> to crash:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">C</span>:<span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">User</span><span class="err">\</span><span class="n">src</span><span class="err">\</span><span class="n">wasmtime</span><span class="o">&gt;</span><span class="n">target</span><span class="err">\</span><span class="n">release</span><span class="err">\</span><span class="n">wasmtime</span><span class="p">.</span><span class="n">exe</span><span class="w"> </span><span class="n">repro</span><span class="p">.</span><span class="n">wat</span><span class="w"></span>

<span class="n">C</span>:<span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">User</span><span class="err">\</span><span class="n">src</span><span class="err">\</span><span class="n">wasmtime</span><span class="o">&gt;</span><span class="n">echo</span><span class="w"> </span><span class="o">%</span><span class="n">ERRORLEVEL</span><span class="o">%</span><span class="w"></span>
<span class="o">-</span><span class="mi">1073741819</span><span class="w"></span>
<span class="err">````</span><span class="w"></span>

<span class="n">By</span><span class="w"> </span><span class="n">eliding</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="n">compatibility</span><span class="w"> </span><span class="n">check</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">enabling</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">probing</span>:
</code></pre></div>
<p>C:\Users\User\src\wasmtime&gt;target\release\wasmtime.exe --cranelift-enable enable_probestack --cranelift-set probestack_strategy=inline repro.wat<br>
warning: using <code>--invoke</code> with a function that returns values is experimental and may break in the future<br>
0</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">I</span><span class="w"> </span><span class="n">think</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">confidently</span><span class="w"> </span><span class="n">say</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">it</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">due</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">missing</span><span class="w"> </span><span class="n">probe</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">these</span><span class="w"> </span><span class="n">large</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span><span class="n">allocations</span><span class="p">.</span><span class="w"></span>
<span class="o">~~~</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="312950631"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312950631" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312950631">(Nov 29 2022 at 22:31)</a>:</h4>
<p>kpreisser <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331404388">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<blockquote>
<p>The stack safety in Wasmtime relies on the embedder ensuring there's at least that much wasm stack available so if the new thread doesn't have 2MB+ of wasm stack then I think this could happen.</p>
</blockquote>
<p>If I understand this correctly, this could be a problem in our application (maybe also Linux) since we don't know how many remaining space is available in the stack when a wasm function is called (because we might call them from events raised e.g. by external plugins or user script code, where an arbitrary number of frames may already be on the stack), so we can't ensure that there is at least the specified max wasm stack size available in the current thread's stack.</p>
<p>Does this mean this would generally require stack probing to be enabled in Cranelift also on non-Windows OSes to be on the safe side (to ensure large wasm frames don't accidentally access memory that doesn't belong to the current thread's stack)?<br>
Thanks!</p>
</blockquote>



<a name="312950788"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312950788" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312950788">(Nov 29 2022 at 22:33)</a>:</h4>
<p>kpreisser edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331404388">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<blockquote>
<p>The stack safety in Wasmtime relies on the embedder ensuring there's at least that much wasm stack available so if the new thread doesn't have 2MB+ of wasm stack then I think this could happen.</p>
</blockquote>
<p>If I understand this correctly, this could be a problem in our application (maybe also Linux) since we don't know how many remaining space is available in the stack when a wasm function is called (because we might call them from events (callbacks) raised e.g. by external plugins or user script code, where an arbitrary number of frames may already be on the stack), so we can't ensure that there is at least the specified max wasm stack size available in the current thread's stack.</p>
<p>Does this mean this would generally require stack probing to be enabled in Cranelift also on non-Windows OSes to be on the safe side (to ensure large wasm frames don't accidentally access memory that doesn't belong to the current thread's stack)?<br>
Thanks!</p>
</blockquote>



<a name="312951312"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312951312" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312951312">(Nov 29 2022 at 22:36)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331408263">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>The bug here for Wasmtime is that on Windows we need to always enable stack probes since it's part of how the system works and we can't escape from that. Stack probes are optional for other hosts but can be useful for detecting situations where not enough native stack was allocated by the host.</p>
<p>For designing an embedding what you'll generally want to do is determine some watermark for how much stack host code will consume (both before wasm and as part of a host call called by wasm) and how much stack wasm can consume. You'll then want to make sure that threads executing wasm have access to the sum of those two numbers. If you get the numbers wrong then the application should be guaranteed to safely abort with stack probes enabled, but without stack probes wasm runs a risk of jumping over the guard page.</p>
</blockquote>



<a name="312953134"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312953134" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312953134">(Nov 29 2022 at 22:49)</a>:</h4>
<p>kpreisser <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331418132">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<blockquote>
<p>The bug here for Wasmtime is that on Windows we need to always enable stack probes since it's part of how the system works and we can't escape from that.</p>
</blockquote>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
<blockquote>
<p>For designing an embedding what you'll generally want to do is determine some watermark for how much stack host code will consume (both before wasm and as part of a host call called by wasm) and how much stack wasm can consume.</p>
</blockquote>
<p>Ok, thank you! However, as described we don't really have a way to ensure the host doesn't use more than a specific amount of stack, because we don't have complete control over the host code/stack. I gather this means that we will need to enable stack probing also on other OSes, to ensure wasm frames don't have a risk of jumping over the guard page.<br>
Is there a way to enable stack probing in the Wasmtime C API?<br>
Thanks!</p>
</blockquote>



<a name="312953285"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312953285" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312953285">(Nov 29 2022 at 22:50)</a>:</h4>
<p>kpreisser edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331418132">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<blockquote>
<p>The bug here for Wasmtime is that on Windows we need to always enable stack probes since it's part of how the system works and we can't escape from that.</p>
</blockquote>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
<blockquote>
<p>For designing an embedding what you'll generally want to do is determine some watermark for how much stack host code will consume (both before wasm and as part of a host call called by wasm) and how much stack wasm can consume.</p>
</blockquote>
<p>Ok, thank you! However, as described we don't really have a way to ensure the host doesn't use more than a specific amount of stack, because we don't have complete control over the host code/stack. I gather this means that we will need to enable stack probing also on other OSes in our application, to ensure wasm frames don't have a risk of jumping over the guard page.<br>
Is there a way to enable stack probing in the Wasmtime C API?<br>
Thanks!</p>
</blockquote>



<a name="312953996"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312953996" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312953996">(Nov 29 2022 at 22:54)</a>:</h4>
<p>kpreisser edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331418132">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<blockquote>
<p>The bug here for Wasmtime is that on Windows we need to always enable stack probes since it's part of how the system works and we can't escape from that.</p>
</blockquote>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
<blockquote>
<p>For designing an embedding what you'll generally want to do is determine some watermark for how much stack host code will consume (both before wasm and as part of a host call called by wasm) and how much stack wasm can consume.</p>
</blockquote>
<p>Ok, thank you! However, as described we don't really have a way to ensure the host doesn't use more than a specific amount of stack, because we don't have complete control over the host code/stack. I gather this means that we will need to enable stack probing also on other OSes in our application, to ensure wasm frames don't have a risk of jumping over the guard page, so that the application is safely aborted in such a case.<br>
Is there a way to enable stack probing in the Wasmtime C API?<br>
Thanks!</p>
</blockquote>



<a name="312954420"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312954420" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312954420">(Nov 29 2022 at 22:57)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331424525">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Not yet, no, and you can't do that today due to the issue @jameysharp mentioned above. @peterhuene were you going to work on a patch to enable that?</p>
<p>Personally I think it's reasonable to unconditionally enable this for all supported platforms since stack probes shouldn't have much of a perf impact anyway. This is only implemented for x86_64 though and other platforms don't have inline stack probes implemented yet and outlined probing support would need more changes in Wasmtime we may not yet be ready for.</p>
</blockquote>



<a name="312955071"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312955071" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312955071">(Nov 29 2022 at 23:01)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331427465">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Yes, I'll create a patch to enable it unconditionally (for x86_64).</p>
</blockquote>



<a name="312963336"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/312963336" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#312963336">(Nov 30 2022 at 00:04)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331476016">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>I've put #5350 up and verified that it addresses the crash you're seeing with your module.</p>
</blockquote>



<a name="313012811"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/313012811" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#313012811">(Nov 30 2022 at 09:00)</a>:</h4>
<p>kpreisser <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331833501">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Thanks a lot for fixing this!</p>
<p>Regarding the stack probing, for us it would be nice to also have inline probing for AArch64 (#4846). For example, on Windows Arm64 (when compiling Wasmtime for <code>aarch64-pc-windows-msvc</code> from #5350), the repro <code>.wat</code> still fails with the access violation.</p>
</blockquote>



<a name="313070032"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/313070032" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#313070032">(Nov 30 2022 at 14:19)</a>:</h4>
<p>kpreisser edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331833501">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Thanks a lot for fixing this!</p>
<p>Regarding the stack probing, for us it would be nice to also have inline probing for AArch64 (#4846).<br>
For example, on Windows Arm64 (when compiling Wasmtime for <code>aarch64-pc-windows-msvc</code> from #5350), the repro <code>.wat</code> still fails with the access violation; and on Linux Aarch64, this will help us to ensure we don't get a security problem when a wasm frame jumps over the guard page due to the stack being nearly exhausted.</p>
</blockquote>



<a name="313091680"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/313091680" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#313091680">(Nov 30 2022 at 15:57)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Hi,</p>
<p>we are using <code>Wasmtime</code> via <a href="https://github.com/bytecodealliance/wasmtime-dotnet/"><code>wasmtime-dotnet</code></a> in a .NET 6.0 application, where we load a 8 MB WASM file and execute its <code>_start</code> function. However, this causes an <strong>access violation</strong> on Windows in <code>wasmtime_func_call</code> when using Wasmtime from commit ff5abfd9938c78cd75c6c5d6a41565097128c5d3.</p>
<p>The crash started to happen toegher with issue #5328 (with commit fc62d4ad65892837a1e1af5a9d67c8b0d4310efe), which is why I also reported it there, but it could be that this was just a trigger and the actual root case is a different one. It could also be that once #5328 is fixed, the access violation is no longer reproducible.</p>
<p>I can reproduce the access violation with the following steps on Windows 10 x64 Build 19044, and on Windows Server 2019:</p>
<ul>
<li>
<p>Build the Wasmtime C API from commit ff5abfd9938c78cd75c6c5d6a41565097128c5d3 on Windows for the current host (<code>x86_64-pc-windows-msvc</code>) as release build: <code>cargo build --release --manifest-path crates/c-api/Cargo.toml
</code></p>
</li>
<li>
<p>Install the <a href="https://dotnet.microsoft.com/en-us/download/dotnet/thank-you/sdk-6.0.403-windows-x64-installer">.NET SDK 6.0.403 for Windows x64</a>, which includes the .NET 6.0.11 runtime.</p>
</li>
<li>
<p>Clone <a href="https://github.com/kpreisser/wasmtime-dotnet">https://github.com/kpreisser/wasmtime-dotnet</a>, and switch to branch <code>repro-wasmtime-access-violation</code>, which contains a <a href="https://github.com/kpreisser/wasmtime-dotnet/commit/82bb8c514f085af58a45899793fe26a0e99201de">commit that adds the repro project</a> on top of the current <code>wasmtime-dotnet</code> code.<br>
  (The code contains a lot of fields/variables and some methods that are not used, but that was as best as I could get it while still reproducing the crash.)</p>
</li>
<li>
<p><code>cd</code> into the repo's <code>ReproWasmtimeAccessViolation</code> folder, then run <code>dotnet build ReproWasmtimeAccessViolation.csproj</code>.</p>
</li>
<li><code>cd bin\Debug\net6.0</code>, then copy <code>wasmtime.dll</code> and <code>wasmtime.pdb</code> from the build result into this directory.</li>
<li>Download the WASM file as .Zip file here (note: rename the .mov file to .zip ; I renamed it to be able to upload it here): <a href="https://user-images.githubusercontent.com/13289184/203989968-4639d6d5-15c9-4e57-bf01-c2eccd756642.mov">https://user-images.githubusercontent.com/13289184/203989968-4639d6d5-15c9-4e57-bf01-c2eccd756642.mov</a>, and copy the file <code>dotnet-codabix-wasm-build.wasm</code> also into this directory.</li>
<li>Run <code>ReproWasmtimeAccessViolation.exe</code>.</li>
</ul>
<p>After some seconds, the program will exit if the access violation occured (and in Windows Error Reporting, there will be an error entry in the Application log ("Application Error").<br>
If it didn't occur, the program will print <code>"wasmtime_func_call completed! This should not be displayed if the Access Violation occured."</code>, and you can use <code>Ctrl</code>+<code>C</code> to exit.</p>
<p>Unfortunately, the crash doesn't alway occur, it might also depend on the hardware or other factors. You may have to try a few times if the crash doesn't occur, or try again at a later time.</p>
<p>When attaching Visual Studio 2022 as debugger (using "native code" mode), it will show the following:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Exception</span><span class="w"> </span><span class="n">thrown</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mh">0x000002BB0392BD19</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ReproWasmtimeAccessViolation</span><span class="p">.</span><span class="n">exe</span>: <span class="mh">0xC0000005</span>: <span class="nc">Access</span><span class="w"> </span><span class="n">violation</span><span class="w"> </span><span class="n">writing</span><span class="w"> </span><span class="n">location</span><span class="w"> </span><span class="mh">0x000000CA214E4E80</span><span class="p">.</span><span class="w"></span>
</code></pre></div>
<p>Call Stack:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">&gt;</span><span class="w">   </span><span class="mi">000002</span><span class="n">bb0392bd19</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a369dc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03951aaf</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038caa53</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a2c701</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb039f78bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e616c0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5d4a3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038caa53</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03a2c701</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb039f78bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0392b8c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0429bb8c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5b2b2</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03e5a965</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03ac8ee0</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03ac3058</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb04294c00</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb042df4c4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb03aaa51f</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb0382174a</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb038210d4</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb044cf7bc</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">000002</span><span class="n">bb044cfdbb</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">wasmtime_setjmp</span><span class="w"></span><span class="p">()</span><span class="w"> </span><span class="n">C</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN16wasmtime_runtime12traphandlers84_</span><span class="cp">$LT$impl$u20$wasmtime_runtime</span><span class="o">..</span><span class="n">traphandlers</span><span class="o">..</span><span class="n">call_thread_state</span><span class="o">..</span><span class="n">CallThreadState</span><span class="cp">$GT$</span><span class="mi">4</span><span class="n">with17h74c010e2e721401eE</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN16wasmtime_runtime12traphandlers11catch_traps17h7bef31bead668a92E</span><span class="w"></span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN8wasmtime4func4Func18call_unchecked_raw17hcb0b0b7982c6fc66E</span><span class="p">.</span><span class="n">llvm</span><span class="p">.</span><span class="mi">11183561978299839151</span><span class="w"></span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">_ZN8wasmtime4func4Func9call_impl17hcb50041b4478fa06E</span><span class="p">.</span><span class="n">llvm</span><span class="p">.</span><span class="mi">11183561978299839151</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="n">wasmtime_func_call</span><span class="w"></span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615ce96</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615cc68</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615c826</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615c66b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615a56b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd5615a0ac</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd55f3fd86</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="mi">00007</span><span class="n">ffd55f3ef8b</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="n">Private</span><span class="p">.</span><span class="n">CoreLib</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffd3609274f</span><span class="p">()</span><span class="w">   </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5aaaac3</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59a6d9c</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5a8c413</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59836f5</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb59835fa</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">coreclr</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdb5983419</span><span class="p">()</span><span class="w">  </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">kernel32</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdeafe74b4</span><span class="p">()</span><span class="w"> </span><span class="n">Unknown</span><span class="w"></span>
<span class="w">    </span><span class="n">ntdll</span><span class="p">.</span><span class="n">dll</span><span class="o">!</span><span class="mi">00007</span><span class="n">ffdeb2c26a1</span><span class="p">()</span><span class="w">    </span><span class="n">Unknown</span><span class="w"></span>
</code></pre></div>
<p>Additional notes:</p>
<ul>
<li>On my system, the crash reproduces in about 50% of the cases.</li>
<li>I can't seem to reproduce the crash when using Wasmtime debug build.</li>
</ul>
<p><strong>Environments</strong> where I can reproduce the crash:</p>
<ul>
<li>Environment 1:<ul>
<li>Hardware: Apple Mac mini (2018), with Parallels Desktop to run the Windows VM</li>
<li>CPU: Intel(R) Core(TM) i7-8700B CPU @ 3.20GHz   3.19 GHz</li>
<li>VM (Parallels Desktop on macOS): Windows 10 Pro x64 Build 19044 (in a VM)</li>
</ul>
</li>
<li>Environment 2:<ul>
<li>Hardware: Intel NUC8i7BEH</li>
<li>CPU: Intel Core i7-8559U</li>
<li>VM (VMware Player 16 on Window 10 Build 19044): Windows Server 2019 Build 17763</li>
</ul>
</li>
</ul>
<p>Thank you!</p>
</blockquote>



<a name="313096483"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/313096483" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#313096483">(Nov 30 2022 at 16:17)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1332415167">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Indeed! I've opened <a href="https://github.com/bytecodealliance/wasmtime/pull/5353">https://github.com/bytecodealliance/wasmtime/pull/5353</a> to add support for aarch64</p>
</blockquote>



<a name="313097344"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/313097344" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#313097344">(Nov 30 2022 at 16:21)</a>:</h4>
<p>kpreisser edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331833501">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Thanks a lot for fixing this!</p>
<p>Regarding the stack probing, for us it would be nice to also have inline probing for AArch64 (#4846).<br>
For example, on Windows Arm64 (when compiling Wasmtime for <code>aarch64-pc-windows-msvc</code> from #5350), the repro <code>.wat</code> still fails with the access violation; and on Linux AArch64, this will help us to ensure we don't get a security problem when a wasm frame jumps over the guard page due to the stack being nearly exhausted.</p>
</blockquote>



<a name="313097481"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/313097481" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#313097481">(Nov 30 2022 at 16:22)</a>:</h4>
<p>kpreisser edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331833501">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<p>Thanks a lot for fixing this!</p>
<p>Regarding the stack probing, for us it would be nice to also have inline probing for AArch64 (#4846).<br>
For example, on Windows Arm64 (when compiling Wasmtime for <code>aarch64-pc-windows-msvc</code> from #5350), the repro <code>.wat</code> still fails with the access violation; and also on Linux AArch64, this will help us to ensure we don't get a security problem when a wasm frame jumps over the guard page due to the stack being nearly exhausted.</p>
</blockquote>



<a name="313097659"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235340%20Access%20Violation%20in%20.NET%20applicati.../near/313097659" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235340.20Access.20Violation.20in.20.2ENET.20applicati.2E.2E.2E.html#313097659">(Nov 30 2022 at 16:22)</a>:</h4>
<p>kpreisser edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5340#issuecomment-1331418132">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5340">issue #5340</a>:</p>
<blockquote>
<blockquote>
<p>The bug here for Wasmtime is that on Windows we need to always enable stack probes since it's part of how the system works and we can't escape from that.</p>
</blockquote>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
<blockquote>
<p>For designing an embedding what you'll generally want to do is determine some watermark for how much stack host code will consume (both before wasm and as part of a host call called by wasm) and how much stack wasm can consume.</p>
</blockquote>
<p>Ok, thank you! However, as described we don't really have a way to always guarantee the host doesn't use more than a specific amount of stack, because we don't have complete control over the host code/stack. I gather this means that we will need to enable stack probing also on other OSes in our application, to ensure wasm frames don't have a risk of jumping over the guard page, so that the application is safely aborted in such a case.<br>
Is there a way to enable stack probing in the Wasmtime C API?<br>
Thanks!</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>