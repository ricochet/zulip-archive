<html>
<head><meta charset="utf-8"><title>wasmtime / issue #4453 cranelift: Use `cranelift-jit` in ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20.2E.2E.2E.html">wasmtime / issue #4453 cranelift: Use `cranelift-jit` in ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="289735536"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20.../near/289735536" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20.2E.2E.2E.html#289735536">(Jul 15 2022 at 14:37)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#issuecomment-1185610180">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4453">issue #4453</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "fuzzing"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>fitzgen: fuzzing</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="292491710"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20.../near/292491710" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20.2E.2E.2E.html#292491710">(Aug 08 2022 at 20:24)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#issuecomment-1208574067">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4453">issue #4453</a>:</p>
<blockquote>
<p>With the CRT issue resolved I think this is ready to merge.</p>
<p>The only changes since the last review were a rebase and enabling the FMA tests that we couldn't enable in #4460.</p>
<p>Thanks for reviewing!</p>
</blockquote>



<a name="292653704"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20.../near/292653704" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20.2E.2E.2E.html#292653704">(Aug 09 2022 at 20:38)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#issuecomment-1209855479">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4453">issue #4453</a>:</p>
<blockquote>
<p>@jameysharp I agree with your comments, however this is sort of an intermediate PR with the follow up cleaning pretty much all of it.</p>
<p>See #4667, we do away with SingleFunctionCompiler and link the entire test file at once, so the repeated compilation issue goes away.</p>
</blockquote>



<a name="292653773"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20.../near/292653773" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20.2E.2E.2E.html#292653773">(Aug 09 2022 at 20:39)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#issuecomment-1209855479">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4453">issue #4453</a>:</p>
<blockquote>
<p>@jameysharp I agree with your comments, however this is sort of an intermediate PR with the follow up cleaning pretty much all of it.</p>
<p>See #4667, we do away with SingleFunctionCompiler and link the entire test file at once, so the repeated compilation issue goes away.</p>
<p>I'd prefer not to have to clean this up, since it's going away as soon as that is done. But let me know if this is a blocker.</p>
</blockquote>



<a name="292664097"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20.../near/292664097" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20.2E.2E.2E.html#292664097">(Aug 09 2022 at 21:55)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#issuecomment-1209931926">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4453">issue #4453</a>:</p>
<blockquote>
<p>I hadn't looked at 4667 yet, and that resolves my concerns. Thanks!</p>
</blockquote>



<a name="307991541"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20.../near/307991541" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20.2E.2E.2E.html#307991541">(Nov 04 2022 at 15:59)</a>:</h4>
<p>uweigand <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#issuecomment-1303803222">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4453">issue #4453</a>:</p>
<blockquote>
<p>As of this commit, I'm now seeing test failures on s390x (Ubuntu 20.04), specifically when running <code>cargo test --doc</code> in the filetests directory.  The symptom is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Test</span><span class="w"> </span><span class="n">executable</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="p">(</span><span class="n">exit</span><span class="w"> </span><span class="n">status</span>: <span class="mi">101</span><span class="p">).</span><span class="w"></span>
<span class="n">stderr</span>:
<span class="nc">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">readable</span><span class="o">+</span><span class="n">executable</span>: <span class="nc">SystemCall</span><span class="p">(</span><span class="n">Os</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">code</span>: <span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="n">kind</span>: <span class="nc">PermissionDenied</span><span class="p">,</span><span class="w"> </span><span class="n">message</span>: <span class="s">"Permission denied"</span><span class="w"> </span><span class="p">})</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">cranelift</span><span class="o">/</span><span class="n">jit</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">memory</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">178</span>:<span class="mi">30</span><span class="w"></span>
</code></pre></div>
<p>when running the sample code in <code>src/function_runner.rs</code>.   A backtrace shows that the failing call is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="mi">0</span><span class="w">  </span><span class="mh">0x000003fffdc8cce0</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">mprotect</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">6</span><span class="w"></span>
#<span class="mi">1</span><span class="w">  </span><span class="mh">0x000002aa0008ee96</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">region</span>::<span class="n">os</span>::<span class="n">unix</span>::<span class="n">set_protection</span><span class="w"> </span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mh">0x2aa00847000</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="mi">4096</span><span class="p">,</span><span class="w"> </span><span class="n">protection</span><span class="o">=..</span><span class="p">.)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">os</span><span class="o">/</span><span class="n">unix</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">30</span><span class="w"></span>
#<span class="mi">2</span><span class="w">  </span><span class="mh">0x000002aa0008e880</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">region</span>::<span class="n">protect</span>::<span class="n">protect</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="mh">0x2aa00847000</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="mi">4096</span><span class="p">,</span><span class="w"> </span><span class="n">protection</span><span class="o">=..</span><span class="p">.)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">protect</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">48</span><span class="w"></span>
#<span class="mi">3</span><span class="w">  </span><span class="mh">0x000002aa00072f6e</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">cranelift_jit</span>::<span class="n">memory</span>::<span class="p">{</span><span class="k">impl</span>#<span class="mi">2</span><span class="p">}</span>::<span class="n">set_readable_and_executable</span>::<span class="p">{</span><span class="n">closure</span>#<span class="mi">0</span><span class="p">}</span><span class="w"> </span><span class="p">(</span><span class="n">ptr</span><span class="o">=</span><span class="mh">0x2aa00847000</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="o">=</span><span class="mi">4096</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">cranelift</span><span class="o">/</span><span class="n">jit</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">memory</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">211</span><span class="w"></span>
#<span class="mi">4</span><span class="w">  </span><span class="mh">0x000002aa00086824</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">cranelift_jit</span>::<span class="n">memory</span>::<span class="n">Memory</span>::<span class="n">set_readable_and_executable</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="o">=</span><span class="mh">0x3ffffffd2d0</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">cranelift</span><span class="o">/</span><span class="n">jit</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">memory</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">221</span><span class="w"></span>
#<span class="mi">5</span><span class="w">  </span><span class="mh">0x000002aa00068332</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">cranelift_jit</span>::<span class="n">backend</span>::<span class="n">JITModule</span>::<span class="n">finalize_definitions</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="o">=</span><span class="mh">0x3ffffffd260</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">cranelift</span><span class="o">/</span><span class="n">jit</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">backend</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">461</span><span class="w"></span>
#<span class="mi">6</span><span class="w">  </span><span class="mh">0x000002aa00045ae0</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">cranelift_filetests</span>::<span class="n">function_runner</span>::<span class="n">TestFileCompiler</span>::<span class="n">compile</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="o">=&lt;</span><span class="n">error</span><span class="w"> </span><span class="n">reading</span><span class="w"> </span><span class="n">variable</span>: <span class="nc">value</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">optimized</span><span class="w"> </span><span class="n">out</span><span class="o">&gt;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="n">cranelift</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">function_runner</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">247</span><span class="w"></span>
</code></pre></div>
<p>Note that this attempts to use <code>mprotect</code> to grant execute permission to memory allocated on the <em>heap</em>.   This is not supported everywhere, and will in particular be prevented by various security hardening settings on Linux.</p>
<p>Instead, you should use separate <code>mmap</code> allocations if you need to grant execute permissions.</p>
</blockquote>



<a name="308004795"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20.../near/308004795" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20.2E.2E.2E.html#308004795">(Nov 04 2022 at 16:59)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#issuecomment-1303884402">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4453">issue #4453</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>Do the regular filetests pass for you on <code>main</code>? We still use <code>mprotect</code>, so I'm surprised as to how we haven't detected this sooner.</p>
<p><code>cranelift-jit</code> has the <code>selinux-fix</code> feature that switches to <code>mmap</code> based allocations, if you try to use that, does that make it pass?</p>
<p>If so, that might be related to: <a href="https://github.com/bytecodealliance/wasmtime/issues/4986">https://github.com/bytecodealliance/wasmtime/issues/4986</a></p>
</blockquote>



<a name="308005116"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20.../near/308005116" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20.2E.2E.2E.html#308005116">(Nov 04 2022 at 17:00)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#issuecomment-1303884402">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4453">issue #4453</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>Do the regular filetests pass for you on <code>main</code>? We still use <code>mprotect</code>, so I'm surprised as to how we haven't detected this sooner.</p>
<p><code>cranelift-jit</code> has the <code>selinux-fix</code> feature that switches to <code>mmap</code> based allocations, if you try to use that, does that make it pass?</p>
<p>If so, this might be related to: <a href="https://github.com/bytecodealliance/wasmtime/issues/4986">https://github.com/bytecodealliance/wasmtime/issues/4986</a></p>
</blockquote>



<a name="308006449"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20.../near/308006449" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20.2E.2E.2E.html#308006449">(Nov 04 2022 at 17:06)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#issuecomment-1303884402">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4453">issue #4453</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>~Do the regular filetests pass for you on <code>main</code>? We still use <code>mprotect</code>, so I'm surprised as to how we haven't detected this sooner.~</p>
<p>Edit: Ignore that I misread your comment and thought that only the doc tests were failing.</p>
<p><code>cranelift-jit</code> has the <code>selinux-fix</code> feature that switches to <code>mmap</code> based allocations, if you try to use that, does that make it pass?</p>
<p>If so, this might be related to: <a href="https://github.com/bytecodealliance/wasmtime/issues/4986">https://github.com/bytecodealliance/wasmtime/issues/4986</a></p>
</blockquote>



<a name="308006466"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20.../near/308006466" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20.2E.2E.2E.html#308006466">(Nov 04 2022 at 17:07)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#issuecomment-1303884402">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4453">issue #4453</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>~Do the regular filetests pass for you on <code>main</code>? We still use <code>mprotect</code>, so I'm surprised as to how we haven't detected this sooner.~</p>
<p>Edit: Ignore that, I misread your comment and thought that only the doc tests were failing.</p>
<p><code>cranelift-jit</code> has the <code>selinux-fix</code> feature that switches to <code>mmap</code> based allocations, if you try to use that, does that make it pass?</p>
<p>If so, this might be related to: <a href="https://github.com/bytecodealliance/wasmtime/issues/4986">https://github.com/bytecodealliance/wasmtime/issues/4986</a></p>
</blockquote>



<a name="308010242"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20.../near/308010242" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20.2E.2E.2E.html#308010242">(Nov 04 2022 at 17:27)</a>:</h4>
<p>uweigand <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#issuecomment-1303915069">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4453">issue #4453</a>:</p>
<blockquote>
<p>No, only the doc tests are indeed failing.  I've been debugging this right now, and the difference is that doc test sample program is single-threaded and uses the main heap, where <code>mprotect</code> <code>PROT_EXEC</code> fails.  However, when running the main filetests, the <code>clif-util</code> program is multi-threaded and glibc uses per-thread heaps, which are separately created via <code>mmap</code>, and therefore the <code>mprotect</code> happens to work ...</p>
<p>How would I use the <code>selinux-fix</code> feature with a doc test?</p>
</blockquote>



<a name="308012391"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20.../near/308012391" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20.2E.2E.2E.html#308012391">(Nov 04 2022 at 17:38)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#issuecomment-1303927705">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4453">issue #4453</a>:</p>
<blockquote>
<blockquote>
<p>No, only the doc tests are indeed failing. I've been debugging this right now, and the difference is that doc test sample program is single-threaded and uses the main heap, where mprotect PROT_EXEC fails. However, when running the main filetests, the clif-util program is multi-threaded and glibc uses per-thread heaps, which are separately created via mmap, and therefore the mprotect happens to work ...</p>
</blockquote>
<p>That's interesting, and weird!</p>
<blockquote>
<p>How would I use the selinux-fix feature with a doc test?</p>
</blockquote>
<p><a href="https://github.com/afonso360/wasmtime/commit/9d72edd9ab411669fa43268e1de70d88c985e8b7">This</a> should do it.</p>
</blockquote>



<a name="308012632"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20.../near/308012632" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20.2E.2E.2E.html#308012632">(Nov 04 2022 at 17:39)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#issuecomment-1303927705">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4453">issue #4453</a>:</p>
<blockquote>
<blockquote>
<p>No, only the doc tests are indeed failing. I've been debugging this right now, and the difference is that doc test sample program is single-threaded and uses the main heap, where mprotect PROT_EXEC fails. However, when running the main filetests, the clif-util program is multi-threaded and glibc uses per-thread heaps, which are separately created via mmap, and therefore the mprotect happens to work ...</p>
</blockquote>
<p>That's interesting, and weird!</p>
<blockquote>
<p>How would I use the selinux-fix feature with a doc test?</p>
</blockquote>
<p><a href="https://github.com/afonso360/wasmtime/commit/9d72edd9ab411669fa43268e1de70d88c985e8b7">This</a> should do it.</p>
<p>However I think that we probably should switch to a mmap allocator since that apparently can solve a bunch of other issues with cranelift-jit.</p>
</blockquote>



<a name="308017374"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20.../near/308017374" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20.2E.2E.2E.html#308017374">(Nov 04 2022 at 17:59)</a>:</h4>
<p>uweigand <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#issuecomment-1303955742">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4453">issue #4453</a>:</p>
<blockquote>
<blockquote>
<blockquote>
<p>How would I use the selinux-fix feature with a doc test?</p>
</blockquote>
<p><a href="https://github.com/afonso360/wasmtime/commit/9d72edd9ab411669fa43268e1de70d88c985e8b7">This</a> should do it.</p>
</blockquote>
<p>This fixes the problem for me.  Submitted as <a href="https://github.com/bytecodealliance/wasmtime/pull/5204">https://github.com/bytecodealliance/wasmtime/pull/5204</a></p>
<blockquote>
<p>However I think that we probably should switch to a mmap allocator since that apparently can solve a bunch of other issues with cranelift-jit.</p>
</blockquote>
<p>Agreed!<br>
</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>