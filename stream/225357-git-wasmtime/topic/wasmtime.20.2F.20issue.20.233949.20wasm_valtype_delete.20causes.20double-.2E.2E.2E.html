<html>
<head><meta charset="utf-8"><title>wasmtime / issue #3949 wasm_valtype_delete causes double-... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233949.20wasm_valtype_delete.20causes.20double-.2E.2E.2E.html">wasmtime / issue #3949 wasm_valtype_delete causes double-...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="276023439"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233949%20wasm_valtype_delete%20causes%20double-.../near/276023439" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233949.20wasm_valtype_delete.20causes.20double-.2E.2E.2E.html#276023439">(Mar 21 2022 at 09:22)</a>:</h4>
<p>spacewander opened <a href="https://github.com/bytecodealliance/wasmtime/issues/3949">issue #3949</a>:</p>
<blockquote>
<p>Thanks for filing a bug report! Please fill out the TODOs below.</p>
<p><strong>Note: if you want to report a security issue, please read our <a href="https://bytecodealliance.org/security">security policy</a>!</strong></p>
<h3>Test Case</h3>
<p>When I upgraded wasmtime from v0.30.0 to 0.35.1, the ci of wasm-nginx-module failed because of a double-free error:<br>
<a href="https://github.com/api7/wasm-nginx-module/runs/5624165257?check_suite_focus=true">https://github.com/api7/wasm-nginx-module/runs/5624165257?check_suite_focus=true</a></p>
<h3>Steps to Reproduce</h3>
<p>The double-free error is caused by <code>wasm_valtype_delete</code> a valtype returned by <code>wasm_valtype_new</code>. After I remove the <code>wasm_valtype_delete</code>, everything works again.</p>
<p>However, according to the doc, <a href="https://github.com/bytecodealliance/wasmtime/blob/e68aa99588560eb63b35aae7e5b27f6a32bcf2bc/crates/c-api/include/doc-wasm.h#L292-L296">https://github.com/bytecodealliance/wasmtime/blob/e68aa99588560eb63b35aae7e5b27f6a32bcf2bc/crates/c-api/include/doc-wasm.h#L292-L296</a></p>
<blockquote>
<p>The caller is responsible for deleting the returned value</p>
</blockquote>
<p>So look like I should keep the call of <code>wasm_valtype_delete</code>?</p>
<p>The call of <code>wasm_valtype_delete</code> is fine under 0.30.0.<br>
Not sure if it is a break change during 0.30.0 to 0.35.1.</p>
<h3>Expected Results</h3>
<p>The same code works well with 0.35.1</p>
<h3>Actual Results</h3>
<p>Here is the full backtrace of double-free crash:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">==</span><span class="mi">23994</span><span class="o">==</span><span class="n">ERROR</span>: <span class="nc">AddressSanitizer</span>: <span class="nc">attempting</span><span class="w"> </span><span class="n">double</span><span class="o">-</span><span class="n">free</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="mh">0x602000094690</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">T0</span>:
    #<span class="mi">0</span><span class="w"> </span><span class="mh">0x4ce40d</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">free</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span><span class="o">+</span><span class="mh">0x4ce40d</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">1</span><span class="w"> </span><span class="mh">0xd766f4</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_http_wasmtime_host_api_func</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">module</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">wasmtime</span><span class="p">.</span><span class="n">c</span>:<span class="mi">72</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">2</span><span class="w"> </span><span class="mh">0xd71f5e</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_wasm_wasmtime_load</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">module</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">wasmtime</span><span class="p">.</span><span class="n">c</span>:<span class="mi">189</span>:<span class="mi">13</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">3</span><span class="w"> </span><span class="mh">0xd5f74d</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_http_wasm_load_plugin</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">module</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">http</span><span class="o">/</span><span class="n">ngx_http_wasm_module</span><span class="p">.</span><span class="n">c</span>:<span class="mi">216</span>:<span class="mi">14</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">4</span><span class="w"> </span><span class="mh">0x7efda509b649</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">lj_vm_ffi_call</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">luajit</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libluajit</span><span class="o">-</span><span class="mf">5.1.</span><span class="n">so</span><span class="p">.</span><span class="mi">2</span><span class="o">+</span><span class="mh">0x53649</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">5</span><span class="w"> </span><span class="mh">0x7efda5312401</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">lj_ccall_func</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">LuaJIT</span><span class="o">-</span><span class="mf">2.1</span><span class="o">-</span><span class="mi">20210510</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lj_ccall</span><span class="p">.</span><span class="n">c</span>:<span class="mi">1382</span>:<span class="mi">5</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">6</span><span class="w"> </span><span class="mh">0x7efda53b8b60</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">lj_cf_ffi_meta___call</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">LuaJIT</span><span class="o">-</span><span class="mf">2.1</span><span class="o">-</span><span class="mi">20210510</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lib_ffi</span><span class="p">.</span><span class="n">c</span>:<span class="mi">230</span>:<span class="mi">15</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">7</span><span class="w"> </span><span class="mh">0x7efda5099062</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">lj_BC_FUNCC</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">luajit</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libluajit</span><span class="o">-</span><span class="mf">5.1.</span><span class="n">so</span><span class="p">.</span><span class="mi">2</span><span class="o">+</span><span class="mh">0x51062</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">8</span><span class="w"> </span><span class="mh">0x7efda512835d</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">lua_pcall</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">LuaJIT</span><span class="o">-</span><span class="mf">2.1</span><span class="o">-</span><span class="mi">20210510</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lj_api</span><span class="p">.</span><span class="n">c</span>:<span class="mi">1169</span>:<span class="mi">12</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">9</span><span class="w"> </span><span class="mh">0xad0d0d</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_http_lua_do_call</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.19.9</span><span class="o">/../</span><span class="n">ngx_lua</span><span class="o">-</span><span class="mf">0.10.20</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ngx_http_lua_util</span><span class="p">.</span><span class="n">c</span>:<span class="mi">4170</span>:<span class="mi">14</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">10</span><span class="w"> </span><span class="mh">0xb4ae4e</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_http_lua_init_by_inline</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.19.9</span><span class="o">/../</span><span class="n">ngx_lua</span><span class="o">-</span><span class="mf">0.10.20</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ngx_http_lua_initby</span><span class="p">.</span><span class="n">c</span>:<span class="mi">24</span>:<span class="mi">17</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">11</span><span class="w"> </span><span class="mh">0xa96748</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_http_lua_init</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.19.9</span><span class="o">/../</span><span class="n">ngx_lua</span><span class="o">-</span><span class="mf">0.10.20</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ngx_http_lua_module</span><span class="p">.</span><span class="n">c</span>:<span class="mi">857</span>:<span class="mi">18</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">12</span><span class="w"> </span><span class="mh">0x675f58</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_http_block</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.19.9</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">http</span><span class="o">/</span><span class="n">ngx_http</span><span class="p">.</span><span class="n">c</span>:<span class="mi">308</span>:<span class="mi">17</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">13</span><span class="w"> </span><span class="mh">0x58ced5</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_conf_handler</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.19.9</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">ngx_conf_file</span><span class="p">.</span><span class="n">c</span>:<span class="mi">463</span>:<span class="mi">18</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">14</span><span class="w"> </span><span class="mh">0x588dae</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_conf_parse</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.19.9</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">ngx_conf_file</span><span class="p">.</span><span class="n">c</span>:<span class="mi">319</span>:<span class="mi">14</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">15</span><span class="w"> </span><span class="mh">0x57aa8a</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_init_cycle</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.19.9</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">ngx_cycle</span><span class="p">.</span><span class="n">c</span>:<span class="mi">284</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">16</span><span class="w"> </span><span class="mh">0x4fe909</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.19.9</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">nginx</span><span class="p">.</span><span class="n">c</span>:<span class="mi">295</span>:<span class="mi">13</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">17</span><span class="w"> </span><span class="mh">0x7efda3bcb0b2</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">__libc_start_main</span><span class="w"> </span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">glibc</span><span class="o">-</span><span class="n">sMfBJT</span><span class="o">/</span><span class="n">glibc</span><span class="o">-</span><span class="mf">2.31</span><span class="o">/</span><span class="n">csu</span><span class="o">/../</span><span class="n">csu</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="n">start</span><span class="p">.</span><span class="n">c</span>:<span class="mi">308</span>:<span class="mi">16</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">18</span><span class="w"> </span><span class="mh">0x45461d</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">_start</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span><span class="o">+</span><span class="mh">0x45461d</span><span class="p">)</span><span class="w"></span>

<span class="mh">0x602000094690</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">located</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">inside</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">1</span><span class="o">-</span><span class="n">byte</span><span class="w"> </span><span class="n">region</span><span class="w"> </span><span class="p">[</span><span class="mh">0x602000094690</span><span class="p">,</span><span class="mh">0x602000094691</span><span class="p">)</span><span class="w"></span>
<span class="n">freed</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">T0</span><span class="w"> </span><span class="n">here</span>:
    #<span class="mi">0</span><span class="w"> </span><span class="mh">0x4ce40d</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">free</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span><span class="o">+</span><span class="mh">0x4ce40d</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">1</span><span class="w"> </span><span class="mh">0x7efda434732f</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">_</span><span class="cp">$LT$core</span><span class="o">..</span><span class="n">iter</span><span class="o">..</span><span class="n">adapters</span><span class="o">..</span><span class="n">map</span><span class="o">..</span><span class="n">Map</span><span class="cp">$LT$I$C$F$GT$$u20$as$u20$core</span><span class="o">..</span><span class="n">iter</span><span class="o">..</span><span class="n">traits</span><span class="o">..</span><span class="n">iterator</span><span class="o">..</span><span class="nb">Iterator</span><span class="cp">$GT$</span>::<span class="n">fold</span>::<span class="n">h67c0ad45f9c8a801</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">module</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">c</span><span class="o">-</span><span class="n">api</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libwasmtime</span><span class="p">.</span><span class="n">so</span><span class="o">+</span><span class="mh">0x18d32f</span><span class="p">)</span><span class="w"></span>

<span class="n">previously</span><span class="w"> </span><span class="n">allocated</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">T0</span><span class="w"> </span><span class="n">here</span>:
    #<span class="mi">0</span><span class="w"> </span><span class="mh">0x4ce68d</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">malloc</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span><span class="o">+</span><span class="mh">0x4ce68d</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">1</span><span class="w"> </span><span class="mh">0x7efda435296f</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasm_valtype_new</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">module</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">c</span><span class="o">-</span><span class="n">api</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libwasmtime</span><span class="p">.</span><span class="n">so</span><span class="o">+</span><span class="mh">0x19896f</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">2</span><span class="w"> </span><span class="mh">0xd71f5e</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_wasm_wasmtime_load</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">module</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">wasmtime</span><span class="p">.</span><span class="n">c</span>:<span class="mi">189</span>:<span class="mi">13</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">3</span><span class="w"> </span><span class="mh">0xd5f74d</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_http_wasm_load_plugin</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">module</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">http</span><span class="o">/</span><span class="n">ngx_http_wasm_module</span><span class="p">.</span><span class="n">c</span>:<span class="mi">216</span>:<span class="mi">14</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">4</span><span class="w"> </span><span class="mh">0x7efda509b649</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">lj_vm_ffi_call</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">luajit</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libluajit</span><span class="o">-</span><span class="mf">5.1.</span><span class="n">so</span><span class="p">.</span><span class="mi">2</span><span class="o">+</span><span class="mh">0x53649</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">5</span><span class="w"> </span><span class="mh">0x7efda5312401</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">lj_ccall_func</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">LuaJIT</span><span class="o">-</span><span class="mf">2.1</span><span class="o">-</span><span class="mi">20210510</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lj_ccall</span><span class="p">.</span><span class="n">c</span>:<span class="mi">1382</span>:<span class="mi">5</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">6</span><span class="w"> </span><span class="mh">0x7efda53b8b60</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">lj_cf_ffi_meta___call</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">LuaJIT</span><span class="o">-</span><span class="mf">2.1</span><span class="o">-</span><span class="mi">20210510</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lib_ffi</span><span class="p">.</span><span class="n">c</span>:<span class="mi">230</span>:<span class="mi">15</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">7</span><span class="w"> </span><span class="mh">0x7efda5099062</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">lj_BC_FUNCC</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">luajit</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libluajit</span><span class="o">-</span><span class="mf">5.1.</span><span class="n">so</span><span class="p">.</span><span class="mi">2</span><span class="o">+</span><span class="mh">0x51062</span><span class="p">)</span><span class="w"></span>

<span class="n">SUMMARY</span>: <span class="nc">AddressSanitizer</span>: <span class="nc">double</span><span class="o">-</span><span class="n">free</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span><span class="o">+</span><span class="mh">0x4ce40d</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">free</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 0.35.1</p>
<p>Operating system: Ubuntu 20.04</p>
<p>Architecture: x86<br>
</p>
</blockquote>



<a name="276023440"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233949%20wasm_valtype_delete%20causes%20double-.../near/276023440" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233949.20wasm_valtype_delete.20causes.20double-.2E.2E.2E.html#276023440">(Mar 21 2022 at 09:22)</a>:</h4>
<p>spacewander labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/3949">issue #3949</a>:</p>
<blockquote>
<p>Thanks for filing a bug report! Please fill out the TODOs below.</p>
<p><strong>Note: if you want to report a security issue, please read our <a href="https://bytecodealliance.org/security">security policy</a>!</strong></p>
<h3>Test Case</h3>
<p>When I upgraded wasmtime from v0.30.0 to 0.35.1, the ci of wasm-nginx-module failed because of a double-free error:<br>
<a href="https://github.com/api7/wasm-nginx-module/runs/5624165257?check_suite_focus=true">https://github.com/api7/wasm-nginx-module/runs/5624165257?check_suite_focus=true</a></p>
<h3>Steps to Reproduce</h3>
<p>The double-free error is caused by <code>wasm_valtype_delete</code> a valtype returned by <code>wasm_valtype_new</code>. After I remove the <code>wasm_valtype_delete</code>, everything works again.</p>
<p>However, according to the doc, <a href="https://github.com/bytecodealliance/wasmtime/blob/e68aa99588560eb63b35aae7e5b27f6a32bcf2bc/crates/c-api/include/doc-wasm.h#L292-L296">https://github.com/bytecodealliance/wasmtime/blob/e68aa99588560eb63b35aae7e5b27f6a32bcf2bc/crates/c-api/include/doc-wasm.h#L292-L296</a></p>
<blockquote>
<p>The caller is responsible for deleting the returned value</p>
</blockquote>
<p>So look like I should keep the call of <code>wasm_valtype_delete</code>?</p>
<p>The call of <code>wasm_valtype_delete</code> is fine under 0.30.0.<br>
Not sure if it is a break change during 0.30.0 to 0.35.1.</p>
<h3>Expected Results</h3>
<p>The same code works well with 0.35.1</p>
<h3>Actual Results</h3>
<p>Here is the full backtrace of double-free crash:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">==</span><span class="mi">23994</span><span class="o">==</span><span class="n">ERROR</span>: <span class="nc">AddressSanitizer</span>: <span class="nc">attempting</span><span class="w"> </span><span class="n">double</span><span class="o">-</span><span class="n">free</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="mh">0x602000094690</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">T0</span>:
    #<span class="mi">0</span><span class="w"> </span><span class="mh">0x4ce40d</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">free</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span><span class="o">+</span><span class="mh">0x4ce40d</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">1</span><span class="w"> </span><span class="mh">0xd766f4</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_http_wasmtime_host_api_func</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">module</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">wasmtime</span><span class="p">.</span><span class="n">c</span>:<span class="mi">72</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">2</span><span class="w"> </span><span class="mh">0xd71f5e</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_wasm_wasmtime_load</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">module</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">wasmtime</span><span class="p">.</span><span class="n">c</span>:<span class="mi">189</span>:<span class="mi">13</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">3</span><span class="w"> </span><span class="mh">0xd5f74d</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_http_wasm_load_plugin</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">module</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">http</span><span class="o">/</span><span class="n">ngx_http_wasm_module</span><span class="p">.</span><span class="n">c</span>:<span class="mi">216</span>:<span class="mi">14</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">4</span><span class="w"> </span><span class="mh">0x7efda509b649</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">lj_vm_ffi_call</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">luajit</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libluajit</span><span class="o">-</span><span class="mf">5.1.</span><span class="n">so</span><span class="p">.</span><span class="mi">2</span><span class="o">+</span><span class="mh">0x53649</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">5</span><span class="w"> </span><span class="mh">0x7efda5312401</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">lj_ccall_func</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">LuaJIT</span><span class="o">-</span><span class="mf">2.1</span><span class="o">-</span><span class="mi">20210510</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lj_ccall</span><span class="p">.</span><span class="n">c</span>:<span class="mi">1382</span>:<span class="mi">5</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">6</span><span class="w"> </span><span class="mh">0x7efda53b8b60</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">lj_cf_ffi_meta___call</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">LuaJIT</span><span class="o">-</span><span class="mf">2.1</span><span class="o">-</span><span class="mi">20210510</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lib_ffi</span><span class="p">.</span><span class="n">c</span>:<span class="mi">230</span>:<span class="mi">15</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">7</span><span class="w"> </span><span class="mh">0x7efda5099062</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">lj_BC_FUNCC</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">luajit</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libluajit</span><span class="o">-</span><span class="mf">5.1.</span><span class="n">so</span><span class="p">.</span><span class="mi">2</span><span class="o">+</span><span class="mh">0x51062</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">8</span><span class="w"> </span><span class="mh">0x7efda512835d</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">lua_pcall</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">LuaJIT</span><span class="o">-</span><span class="mf">2.1</span><span class="o">-</span><span class="mi">20210510</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lj_api</span><span class="p">.</span><span class="n">c</span>:<span class="mi">1169</span>:<span class="mi">12</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">9</span><span class="w"> </span><span class="mh">0xad0d0d</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_http_lua_do_call</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.19.9</span><span class="o">/../</span><span class="n">ngx_lua</span><span class="o">-</span><span class="mf">0.10.20</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ngx_http_lua_util</span><span class="p">.</span><span class="n">c</span>:<span class="mi">4170</span>:<span class="mi">14</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">10</span><span class="w"> </span><span class="mh">0xb4ae4e</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_http_lua_init_by_inline</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.19.9</span><span class="o">/../</span><span class="n">ngx_lua</span><span class="o">-</span><span class="mf">0.10.20</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ngx_http_lua_initby</span><span class="p">.</span><span class="n">c</span>:<span class="mi">24</span>:<span class="mi">17</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">11</span><span class="w"> </span><span class="mh">0xa96748</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_http_lua_init</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.19.9</span><span class="o">/../</span><span class="n">ngx_lua</span><span class="o">-</span><span class="mf">0.10.20</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ngx_http_lua_module</span><span class="p">.</span><span class="n">c</span>:<span class="mi">857</span>:<span class="mi">18</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">12</span><span class="w"> </span><span class="mh">0x675f58</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_http_block</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.19.9</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">http</span><span class="o">/</span><span class="n">ngx_http</span><span class="p">.</span><span class="n">c</span>:<span class="mi">308</span>:<span class="mi">17</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">13</span><span class="w"> </span><span class="mh">0x58ced5</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_conf_handler</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.19.9</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">ngx_conf_file</span><span class="p">.</span><span class="n">c</span>:<span class="mi">463</span>:<span class="mi">18</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">14</span><span class="w"> </span><span class="mh">0x588dae</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_conf_parse</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.19.9</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">ngx_conf_file</span><span class="p">.</span><span class="n">c</span>:<span class="mi">319</span>:<span class="mi">14</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">15</span><span class="w"> </span><span class="mh">0x57aa8a</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_init_cycle</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.19.9</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">ngx_cycle</span><span class="p">.</span><span class="n">c</span>:<span class="mi">284</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">16</span><span class="w"> </span><span class="mh">0x4fe909</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.19.9</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">nginx</span><span class="p">.</span><span class="n">c</span>:<span class="mi">295</span>:<span class="mi">13</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">17</span><span class="w"> </span><span class="mh">0x7efda3bcb0b2</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">__libc_start_main</span><span class="w"> </span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">glibc</span><span class="o">-</span><span class="n">sMfBJT</span><span class="o">/</span><span class="n">glibc</span><span class="o">-</span><span class="mf">2.31</span><span class="o">/</span><span class="n">csu</span><span class="o">/../</span><span class="n">csu</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="n">start</span><span class="p">.</span><span class="n">c</span>:<span class="mi">308</span>:<span class="mi">16</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">18</span><span class="w"> </span><span class="mh">0x45461d</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">_start</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span><span class="o">+</span><span class="mh">0x45461d</span><span class="p">)</span><span class="w"></span>

<span class="mh">0x602000094690</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">located</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">inside</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">1</span><span class="o">-</span><span class="n">byte</span><span class="w"> </span><span class="n">region</span><span class="w"> </span><span class="p">[</span><span class="mh">0x602000094690</span><span class="p">,</span><span class="mh">0x602000094691</span><span class="p">)</span><span class="w"></span>
<span class="n">freed</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">T0</span><span class="w"> </span><span class="n">here</span>:
    #<span class="mi">0</span><span class="w"> </span><span class="mh">0x4ce40d</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">free</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span><span class="o">+</span><span class="mh">0x4ce40d</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">1</span><span class="w"> </span><span class="mh">0x7efda434732f</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">_</span><span class="cp">$LT$core</span><span class="o">..</span><span class="n">iter</span><span class="o">..</span><span class="n">adapters</span><span class="o">..</span><span class="n">map</span><span class="o">..</span><span class="n">Map</span><span class="cp">$LT$I$C$F$GT$$u20$as$u20$core</span><span class="o">..</span><span class="n">iter</span><span class="o">..</span><span class="n">traits</span><span class="o">..</span><span class="n">iterator</span><span class="o">..</span><span class="nb">Iterator</span><span class="cp">$GT$</span>::<span class="n">fold</span>::<span class="n">h67c0ad45f9c8a801</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">module</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">c</span><span class="o">-</span><span class="n">api</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libwasmtime</span><span class="p">.</span><span class="n">so</span><span class="o">+</span><span class="mh">0x18d32f</span><span class="p">)</span><span class="w"></span>

<span class="n">previously</span><span class="w"> </span><span class="n">allocated</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">T0</span><span class="w"> </span><span class="n">here</span>:
    #<span class="mi">0</span><span class="w"> </span><span class="mh">0x4ce68d</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">malloc</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span><span class="o">+</span><span class="mh">0x4ce68d</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">1</span><span class="w"> </span><span class="mh">0x7efda435296f</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasm_valtype_new</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">module</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">c</span><span class="o">-</span><span class="n">api</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libwasmtime</span><span class="p">.</span><span class="n">so</span><span class="o">+</span><span class="mh">0x19896f</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">2</span><span class="w"> </span><span class="mh">0xd71f5e</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_wasm_wasmtime_load</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">module</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">wasmtime</span><span class="p">.</span><span class="n">c</span>:<span class="mi">189</span>:<span class="mi">13</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">3</span><span class="w"> </span><span class="mh">0xd5f74d</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_http_wasm_load_plugin</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">module</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">http</span><span class="o">/</span><span class="n">ngx_http_wasm_module</span><span class="p">.</span><span class="n">c</span>:<span class="mi">216</span>:<span class="mi">14</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">4</span><span class="w"> </span><span class="mh">0x7efda509b649</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">lj_vm_ffi_call</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">luajit</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libluajit</span><span class="o">-</span><span class="mf">5.1.</span><span class="n">so</span><span class="p">.</span><span class="mi">2</span><span class="o">+</span><span class="mh">0x53649</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">5</span><span class="w"> </span><span class="mh">0x7efda5312401</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">lj_ccall_func</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">LuaJIT</span><span class="o">-</span><span class="mf">2.1</span><span class="o">-</span><span class="mi">20210510</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lj_ccall</span><span class="p">.</span><span class="n">c</span>:<span class="mi">1382</span>:<span class="mi">5</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">6</span><span class="w"> </span><span class="mh">0x7efda53b8b60</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">lj_cf_ffi_meta___call</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">LuaJIT</span><span class="o">-</span><span class="mf">2.1</span><span class="o">-</span><span class="mi">20210510</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lib_ffi</span><span class="p">.</span><span class="n">c</span>:<span class="mi">230</span>:<span class="mi">15</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">7</span><span class="w"> </span><span class="mh">0x7efda5099062</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">lj_BC_FUNCC</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">luajit</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libluajit</span><span class="o">-</span><span class="mf">5.1.</span><span class="n">so</span><span class="p">.</span><span class="mi">2</span><span class="o">+</span><span class="mh">0x51062</span><span class="p">)</span><span class="w"></span>

<span class="n">SUMMARY</span>: <span class="nc">AddressSanitizer</span>: <span class="nc">double</span><span class="o">-</span><span class="n">free</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span><span class="o">+</span><span class="mh">0x4ce40d</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">free</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 0.35.1</p>
<p>Operating system: Ubuntu 20.04</p>
<p>Architecture: x86<br>
</p>
</blockquote>



<a name="276023826"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233949%20wasm_valtype_delete%20causes%20double-.../near/276023826" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233949.20wasm_valtype_delete.20causes.20double-.2E.2E.2E.html#276023826">(Mar 21 2022 at 09:26)</a>:</h4>
<p>spacewander <a href="https://github.com/bytecodealliance/wasmtime/issues/3949#issuecomment-1073674659">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3949">issue #3949</a>:</p>
<blockquote>
<blockquote>
<p>#1 0x7efda434732f in _$LT$core..iter..adapters..map..Map$LT$I$C$F$GT$$u20$as$u20$core..iter..traits..iterator..Iterator$GT$::fold::h67c0ad45f9c8a801 ...</p>
</blockquote>
<p>Look like it's first freed in a rust map iterator.</p>
</blockquote>



<a name="276023843"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233949%20wasm_valtype_delete%20causes%20double-.../near/276023843" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233949.20wasm_valtype_delete.20causes.20double-.2E.2E.2E.html#276023843">(Mar 21 2022 at 09:27)</a>:</h4>
<p>spacewander edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/3949#issuecomment-1073674659">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3949">issue #3949</a>:</p>
<blockquote>
<blockquote>
<p>0x7efda434732f in _$LT$core..iter..adapters..map..Map$LT$I$C$F$GT$$u20$as$u20$core..iter..traits..iterator..Iterator$GT$::fold::h67c0ad45f9c8a801 ...</p>
</blockquote>
<p>Look like it's first freed in a rust map iterator.</p>
</blockquote>



<a name="276056353"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233949%20wasm_valtype_delete%20causes%20double-.../near/276056353" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233949.20wasm_valtype_delete.20causes.20double-.2E.2E.2E.html#276056353">(Mar 21 2022 at 14:14)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/3949#issuecomment-1073950946">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3949">issue #3949</a>:</p>
<blockquote>
<p>Can you share how your embedding calls the C API? Some methods are documented as taking ownership of their arguments which means that the free is done for you and would cause a double-free if you otherwise try to free again.</p>
</blockquote>



<a name="276137325"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233949%20wasm_valtype_delete%20causes%20double-.../near/276137325" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233949.20wasm_valtype_delete.20causes.20double-.2E.2E.2E.html#276137325">(Mar 22 2022 at 02:35)</a>:</h4>
<p>spacewander <a href="https://github.com/bytecodealliance/wasmtime/issues/3949#issuecomment-1074663239">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3949">issue #3949</a>:</p>
<blockquote>
<p>The code is used there:<br>
<a href="https://github.com/api7/wasm-nginx-module/blob/4ea1ff83392d95105e7901b0837b4e7eb67e3193/src/vm/wasmtime.c#L61-L75">https://github.com/api7/wasm-nginx-module/blob/4ea1ff83392d95105e7901b0837b4e7eb67e3193/src/vm/wasmtime.c#L61-L75</a></p>
<p>Do you mean wasm_valtype_vec_new or wasm_functype_new will take the ownership?</p>
</blockquote>



<a name="276194520"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233949%20wasm_valtype_delete%20causes%20double-.../near/276194520" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233949.20wasm_valtype_delete.20causes.20double-.2E.2E.2E.html#276194520">(Mar 22 2022 at 14:15)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/3949#issuecomment-1075237347">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3949">issue #3949</a>:</p>
<blockquote>
<p>Looks like the <a href="https://docs.wasmtime.dev/c-api/wasm_8h.html#ac1896fb3b18052f41e518d693f7e695e">documentation here is lacking</a> but <a href="https://github.com/WebAssembly/wasm-c-api/blob/c9d31284651b975f05ac27cee0bab1377560b87e/include/wasm.h#L212-L213">as the function indicates</a> the <code>wasm_functype_new</code> function takes ownership of the contents of the input vectors, so you don't need to further delete them afterwards.</p>
</blockquote>



<a name="276276671"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233949%20wasm_valtype_delete%20causes%20double-.../near/276276671" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233949.20wasm_valtype_delete.20causes.20double-.2E.2E.2E.html#276276671">(Mar 23 2022 at 00:52)</a>:</h4>
<p>spacewander <a href="https://github.com/bytecodealliance/wasmtime/issues/3949#issuecomment-1075796387">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3949">issue #3949</a>:</p>
<blockquote>
<p>Thanks for your reply. Would you mind me updating the doc?<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/e68aa99588560eb63b35aae7e5b27f6a32bcf2bc/crates/c-api/include/doc-wasm.h#L358">https://github.com/bytecodealliance/wasmtime/blob/e68aa99588560eb63b35aae7e5b27f6a32bcf2bc/crates/c-api/include/doc-wasm.h#L358</a></p>
</blockquote>



<a name="276286175"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233949%20wasm_valtype_delete%20causes%20double-.../near/276286175" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233949.20wasm_valtype_delete.20causes.20double-.2E.2E.2E.html#276286175">(Mar 23 2022 at 04:04)</a>:</h4>
<p>peterhuene closed <a href="https://github.com/bytecodealliance/wasmtime/issues/3949">issue #3949</a>:</p>
<blockquote>
<p>Thanks for filing a bug report! Please fill out the TODOs below.</p>
<p><strong>Note: if you want to report a security issue, please read our <a href="https://bytecodealliance.org/security">security policy</a>!</strong></p>
<h3>Test Case</h3>
<p>When I upgraded wasmtime from v0.30.0 to 0.35.1, the ci of wasm-nginx-module failed because of a double-free error:<br>
<a href="https://github.com/api7/wasm-nginx-module/runs/5624165257?check_suite_focus=true">https://github.com/api7/wasm-nginx-module/runs/5624165257?check_suite_focus=true</a></p>
<h3>Steps to Reproduce</h3>
<p>The double-free error is caused by <code>wasm_valtype_delete</code> a valtype returned by <code>wasm_valtype_new</code>. After I remove the <code>wasm_valtype_delete</code>, everything works again.</p>
<p>However, according to the doc, <a href="https://github.com/bytecodealliance/wasmtime/blob/e68aa99588560eb63b35aae7e5b27f6a32bcf2bc/crates/c-api/include/doc-wasm.h#L292-L296">https://github.com/bytecodealliance/wasmtime/blob/e68aa99588560eb63b35aae7e5b27f6a32bcf2bc/crates/c-api/include/doc-wasm.h#L292-L296</a></p>
<blockquote>
<p>The caller is responsible for deleting the returned value</p>
</blockquote>
<p>So look like I should keep the call of <code>wasm_valtype_delete</code>?</p>
<p>The call of <code>wasm_valtype_delete</code> is fine under 0.30.0.<br>
Not sure if it is a break change during 0.30.0 to 0.35.1.</p>
<h3>Expected Results</h3>
<p>The same code works well with 0.35.1</p>
<h3>Actual Results</h3>
<p>Here is the full backtrace of double-free crash:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">==</span><span class="mi">23994</span><span class="o">==</span><span class="n">ERROR</span>: <span class="nc">AddressSanitizer</span>: <span class="nc">attempting</span><span class="w"> </span><span class="n">double</span><span class="o">-</span><span class="n">free</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="mh">0x602000094690</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">T0</span>:
    #<span class="mi">0</span><span class="w"> </span><span class="mh">0x4ce40d</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">free</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span><span class="o">+</span><span class="mh">0x4ce40d</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">1</span><span class="w"> </span><span class="mh">0xd766f4</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_http_wasmtime_host_api_func</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">module</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">wasmtime</span><span class="p">.</span><span class="n">c</span>:<span class="mi">72</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">2</span><span class="w"> </span><span class="mh">0xd71f5e</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_wasm_wasmtime_load</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">module</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">wasmtime</span><span class="p">.</span><span class="n">c</span>:<span class="mi">189</span>:<span class="mi">13</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">3</span><span class="w"> </span><span class="mh">0xd5f74d</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_http_wasm_load_plugin</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">module</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">http</span><span class="o">/</span><span class="n">ngx_http_wasm_module</span><span class="p">.</span><span class="n">c</span>:<span class="mi">216</span>:<span class="mi">14</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">4</span><span class="w"> </span><span class="mh">0x7efda509b649</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">lj_vm_ffi_call</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">luajit</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libluajit</span><span class="o">-</span><span class="mf">5.1.</span><span class="n">so</span><span class="p">.</span><span class="mi">2</span><span class="o">+</span><span class="mh">0x53649</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">5</span><span class="w"> </span><span class="mh">0x7efda5312401</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">lj_ccall_func</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">LuaJIT</span><span class="o">-</span><span class="mf">2.1</span><span class="o">-</span><span class="mi">20210510</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lj_ccall</span><span class="p">.</span><span class="n">c</span>:<span class="mi">1382</span>:<span class="mi">5</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">6</span><span class="w"> </span><span class="mh">0x7efda53b8b60</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">lj_cf_ffi_meta___call</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">LuaJIT</span><span class="o">-</span><span class="mf">2.1</span><span class="o">-</span><span class="mi">20210510</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lib_ffi</span><span class="p">.</span><span class="n">c</span>:<span class="mi">230</span>:<span class="mi">15</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">7</span><span class="w"> </span><span class="mh">0x7efda5099062</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">lj_BC_FUNCC</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">luajit</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libluajit</span><span class="o">-</span><span class="mf">5.1.</span><span class="n">so</span><span class="p">.</span><span class="mi">2</span><span class="o">+</span><span class="mh">0x51062</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">8</span><span class="w"> </span><span class="mh">0x7efda512835d</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">lua_pcall</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">LuaJIT</span><span class="o">-</span><span class="mf">2.1</span><span class="o">-</span><span class="mi">20210510</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lj_api</span><span class="p">.</span><span class="n">c</span>:<span class="mi">1169</span>:<span class="mi">12</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">9</span><span class="w"> </span><span class="mh">0xad0d0d</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_http_lua_do_call</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.19.9</span><span class="o">/../</span><span class="n">ngx_lua</span><span class="o">-</span><span class="mf">0.10.20</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ngx_http_lua_util</span><span class="p">.</span><span class="n">c</span>:<span class="mi">4170</span>:<span class="mi">14</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">10</span><span class="w"> </span><span class="mh">0xb4ae4e</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_http_lua_init_by_inline</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.19.9</span><span class="o">/../</span><span class="n">ngx_lua</span><span class="o">-</span><span class="mf">0.10.20</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ngx_http_lua_initby</span><span class="p">.</span><span class="n">c</span>:<span class="mi">24</span>:<span class="mi">17</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">11</span><span class="w"> </span><span class="mh">0xa96748</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_http_lua_init</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.19.9</span><span class="o">/../</span><span class="n">ngx_lua</span><span class="o">-</span><span class="mf">0.10.20</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ngx_http_lua_module</span><span class="p">.</span><span class="n">c</span>:<span class="mi">857</span>:<span class="mi">18</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">12</span><span class="w"> </span><span class="mh">0x675f58</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_http_block</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.19.9</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">http</span><span class="o">/</span><span class="n">ngx_http</span><span class="p">.</span><span class="n">c</span>:<span class="mi">308</span>:<span class="mi">17</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">13</span><span class="w"> </span><span class="mh">0x58ced5</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_conf_handler</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.19.9</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">ngx_conf_file</span><span class="p">.</span><span class="n">c</span>:<span class="mi">463</span>:<span class="mi">18</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">14</span><span class="w"> </span><span class="mh">0x588dae</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_conf_parse</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.19.9</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">ngx_conf_file</span><span class="p">.</span><span class="n">c</span>:<span class="mi">319</span>:<span class="mi">14</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">15</span><span class="w"> </span><span class="mh">0x57aa8a</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_init_cycle</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.19.9</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">ngx_cycle</span><span class="p">.</span><span class="n">c</span>:<span class="mi">284</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">16</span><span class="w"> </span><span class="mh">0x4fe909</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.19.9</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">nginx</span><span class="p">.</span><span class="n">c</span>:<span class="mi">295</span>:<span class="mi">13</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">17</span><span class="w"> </span><span class="mh">0x7efda3bcb0b2</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">__libc_start_main</span><span class="w"> </span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">glibc</span><span class="o">-</span><span class="n">sMfBJT</span><span class="o">/</span><span class="n">glibc</span><span class="o">-</span><span class="mf">2.31</span><span class="o">/</span><span class="n">csu</span><span class="o">/../</span><span class="n">csu</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="n">start</span><span class="p">.</span><span class="n">c</span>:<span class="mi">308</span>:<span class="mi">16</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">18</span><span class="w"> </span><span class="mh">0x45461d</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">_start</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span><span class="o">+</span><span class="mh">0x45461d</span><span class="p">)</span><span class="w"></span>

<span class="mh">0x602000094690</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">located</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">inside</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">1</span><span class="o">-</span><span class="n">byte</span><span class="w"> </span><span class="n">region</span><span class="w"> </span><span class="p">[</span><span class="mh">0x602000094690</span><span class="p">,</span><span class="mh">0x602000094691</span><span class="p">)</span><span class="w"></span>
<span class="n">freed</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">T0</span><span class="w"> </span><span class="n">here</span>:
    #<span class="mi">0</span><span class="w"> </span><span class="mh">0x4ce40d</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">free</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span><span class="o">+</span><span class="mh">0x4ce40d</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">1</span><span class="w"> </span><span class="mh">0x7efda434732f</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">_</span><span class="cp">$LT$core</span><span class="o">..</span><span class="n">iter</span><span class="o">..</span><span class="n">adapters</span><span class="o">..</span><span class="n">map</span><span class="o">..</span><span class="n">Map</span><span class="cp">$LT$I$C$F$GT$$u20$as$u20$core</span><span class="o">..</span><span class="n">iter</span><span class="o">..</span><span class="n">traits</span><span class="o">..</span><span class="n">iterator</span><span class="o">..</span><span class="nb">Iterator</span><span class="cp">$GT$</span>::<span class="n">fold</span>::<span class="n">h67c0ad45f9c8a801</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">module</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">c</span><span class="o">-</span><span class="n">api</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libwasmtime</span><span class="p">.</span><span class="n">so</span><span class="o">+</span><span class="mh">0x18d32f</span><span class="p">)</span><span class="w"></span>

<span class="n">previously</span><span class="w"> </span><span class="n">allocated</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">T0</span><span class="w"> </span><span class="n">here</span>:
    #<span class="mi">0</span><span class="w"> </span><span class="mh">0x4ce68d</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">malloc</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span><span class="o">+</span><span class="mh">0x4ce68d</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">1</span><span class="w"> </span><span class="mh">0x7efda435296f</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasm_valtype_new</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">module</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">c</span><span class="o">-</span><span class="n">api</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libwasmtime</span><span class="p">.</span><span class="n">so</span><span class="o">+</span><span class="mh">0x19896f</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">2</span><span class="w"> </span><span class="mh">0xd71f5e</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_wasm_wasmtime_load</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">module</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">wasmtime</span><span class="p">.</span><span class="n">c</span>:<span class="mi">189</span>:<span class="mi">13</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">3</span><span class="w"> </span><span class="mh">0xd5f74d</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ngx_http_wasm_load_plugin</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">module</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">http</span><span class="o">/</span><span class="n">ngx_http_wasm_module</span><span class="p">.</span><span class="n">c</span>:<span class="mi">216</span>:<span class="mi">14</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">4</span><span class="w"> </span><span class="mh">0x7efda509b649</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">lj_vm_ffi_call</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">luajit</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libluajit</span><span class="o">-</span><span class="mf">5.1.</span><span class="n">so</span><span class="p">.</span><span class="mi">2</span><span class="o">+</span><span class="mh">0x53649</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">5</span><span class="w"> </span><span class="mh">0x7efda5312401</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">lj_ccall_func</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">LuaJIT</span><span class="o">-</span><span class="mf">2.1</span><span class="o">-</span><span class="mi">20210510</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lj_ccall</span><span class="p">.</span><span class="n">c</span>:<span class="mi">1382</span>:<span class="mi">5</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">6</span><span class="w"> </span><span class="mh">0x7efda53b8b60</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">lj_cf_ffi_meta___call</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lzx</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.19.9.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">LuaJIT</span><span class="o">-</span><span class="mf">2.1</span><span class="o">-</span><span class="mi">20210510</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lib_ffi</span><span class="p">.</span><span class="n">c</span>:<span class="mi">230</span>:<span class="mi">15</span><span class="w"></span>
<span class="w">    </span>#<span class="mi">7</span><span class="w"> </span><span class="mh">0x7efda5099062</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">lj_BC_FUNCC</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">luajit</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libluajit</span><span class="o">-</span><span class="mf">5.1.</span><span class="n">so</span><span class="p">.</span><span class="mi">2</span><span class="o">+</span><span class="mh">0x51062</span><span class="p">)</span><span class="w"></span>

<span class="n">SUMMARY</span>: <span class="nc">AddressSanitizer</span>: <span class="nc">double</span><span class="o">-</span><span class="n">free</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span><span class="o">+</span><span class="mh">0x4ce40d</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">free</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 0.35.1</p>
<p>Operating system: Ubuntu 20.04</p>
<p>Architecture: x86<br>
</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>