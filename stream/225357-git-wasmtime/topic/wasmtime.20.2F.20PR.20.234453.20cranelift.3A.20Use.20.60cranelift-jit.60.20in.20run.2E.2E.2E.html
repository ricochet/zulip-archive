<html>
<head><meta charset="utf-8"><title>wasmtime / PR #4453 cranelift: Use `cranelift-jit` in run... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html">wasmtime / PR #4453 cranelift: Use `cranelift-jit` in run...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="289734558"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/289734558" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#289734558">(Jul 15 2022 at 14:30)</a>:</h4>
<p>afonso360 opened <a href="https://github.com/bytecodealliance/wasmtime/pull/4453">PR #4453</a> from <code>testrunner-jit</code> to <code>main</code>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span>  Hey,</p>
<p>This PR changes our run tests to run via <code>cranelift-jit</code>. Its based on top of #4450 so its probably not worth doing any serious review until that is merged.</p>
<p>Using <code>cranelift-jit</code> in run tests allows us to preform relocations and<br>
libcalls. This is important since some instruction lowerings fallback<br>
to libcall's when an extension is missing, or when it's too complicated<br>
to implement manually.</p>
<p>This is also a first step to being able to test <code>call</code>'s between functions<br>
in the runtest suite. It should also make it easier to eventually test<br>
TLS relocations, symbol resolution and ABI's.</p>
<p>Another benefit of this is that we also get to test the JIT more, since<br>
it now runs the runtests, and gets some fuzzing via <code>fuzzgen</code> (which<br>
uses the <code>SingleFunctionCompiler</code>).</p>
<p>This change causes regressions in terms of runtime for the filetests.<br>
I haven't done any serious benchmarking but what I've been seeing is<br>
that it now takes about ~3 seconds to run the testsuite while it<br>
previously took around 2 seconds.</p>
</blockquote>



<a name="289734652"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/289734652" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#289734652">(Jul 15 2022 at 14:31)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#pullrequestreview-1040383384">PR review</a>.</p>



<a name="289734653"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/289734653" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#289734653">(Jul 15 2022 at 14:31)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#discussion_r922225272">PR review comment</a>:</p>
<blockquote>
<p>I'm slightly concerned about this change.</p>
<p><code>msvcrt</code> does not define <code>ceilf</code>/<code>floorf</code>/<code>nearbyintf</code>/<code>truncf</code>, which are some of the LibCall's that we define. I cannot find the dll that defines those functions pre VS2015.</p>
<p>After VS2015 Microsoft created the Universal C Runtime which defines <code>ucrtbase.dll</code> that does contain all of those functions. However that only became standard with Windows 10 in 2015. Previous versions of Windows can have that dll, but only if they install Visual Studio 2015.</p>
<p>We cannot search <code>msvcrt</code> and fallback to <code>ucrtbase</code> since mixing the two runtimes will cause weird behaviour, probably at the worst time possible.</p>
<p>Does anyone know where we can find those functions? Or alternativley what are the minimum requirements that we have for cranelift and can we upgrade to UCRT?</p>
</blockquote>



<a name="289735207"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/289735207" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#289735207">(Jul 15 2022 at 14:35)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#discussion_r922225272">PR review comment</a>.</p>



<a name="289735232"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/289735232" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#289735232">(Jul 15 2022 at 14:35)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#discussion_r922225272">PR review comment</a>.</p>



<a name="289735945"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/289735945" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#289735945">(Jul 15 2022 at 14:40)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4453">PR #4453</a> from <code>testrunner-jit</code> to <code>main</code>.</p>



<a name="289815867"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/289815867" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#289815867">(Jul 16 2022 at 08:09)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4453">PR #4453</a> from <code>testrunner-jit</code> to <code>main</code>.</p>



<a name="289816278"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/289816278" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#289816278">(Jul 16 2022 at 08:19)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4453">PR #4453</a> from <code>testrunner-jit</code> to <code>main</code>.</p>



<a name="289821910"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/289821910" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#289821910">(Jul 16 2022 at 10:45)</a>:</h4>
<p><strong>afonso360</strong> has marked <a href="https://github.com/bytecodealliance/wasmtime/pull/4453">PR #4453</a> as ready for review.</p>



<a name="290004381"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/290004381" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#290004381">(Jul 18 2022 at 18:23)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#discussion_r923688617">PR review comment</a>:</p>
<blockquote>
<p>I guess the reason that we can't have e.g. a <code>PhantomData</code> carrying a lifetime <code>'a</code> representing the trampoline here is that the lifetime is that of <code>module</code> above (i.e. it's be a self-referential struct), is that right? If so let's add a comment here noting that the lifetime corresponds to <code>module</code> and that we don't ever leak the pointers.</p>
</blockquote>



<a name="290004382"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/290004382" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#290004382">(Jul 18 2022 at 18:23)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#pullrequestreview-1042298988">PR review</a>.</p>



<a name="290004383"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/290004383" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#290004383">(Jul 18 2022 at 18:23)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#pullrequestreview-1042298988">PR review</a>.</p>



<a name="290004384"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/290004384" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#290004384">(Jul 18 2022 at 18:23)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#discussion_r923687384">PR review comment</a>:</p>
<blockquote>
<p>Hmm, I don't have too many opinions on what is reasonable as a minimum version requirement. Keeping to a more conservative set of requirements is always good, everything else being equal; but here if that means we'd have to polyfill (and those polyfills would be tested only on older platforms, i.e. rarely or not at all) then I'm not sure what value that carries.</p>
<p>@peterhuene do you have any thoughts on this re: Windows runtime versions?</p>
</blockquote>



<a name="290018110"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/290018110" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#290018110">(Jul 18 2022 at 20:23)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4453">PR #4453</a> from <code>testrunner-jit</code> to <code>main</code>.</p>



<a name="290018398"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/290018398" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#290018398">(Jul 18 2022 at 20:25)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4453">PR #4453</a> from <code>testrunner-jit</code> to <code>main</code>.</p>



<a name="290018461"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/290018461" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#290018461">(Jul 18 2022 at 20:26)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#pullrequestreview-1042500336">PR review</a>.</p>



<a name="290018462"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/290018462" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#290018462">(Jul 18 2022 at 20:26)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#discussion_r923826626">PR review comment</a>:</p>
<blockquote>
<p>We actually don't need these pointers. I switched the implementation so that we hold <code>FuncId</code>'s from the JITModule, and query the address when calling the function.</p>
</blockquote>



<a name="290018539"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/290018539" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#290018539">(Jul 18 2022 at 20:26)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4453">PR #4453</a> from <code>testrunner-jit</code> to <code>main</code>.</p>



<a name="291249101"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/291249101" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#291249101">(Jul 28 2022 at 20:40)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/4453">PR #4453</a> from <code>testrunner-jit</code> to <code>main</code>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span>  Hey,</p>
<p>This PR changes our run tests to run via <code>cranelift-jit</code>. Its based on top of #4450 so its probably not worth doing any serious review until that is merged.</p>
<p>Using <code>cranelift-jit</code> in run tests allows us to preform relocations and<br>
libcalls. This is important since some instruction lowerings fallback<br>
to libcall's when an extension is missing, or when it's too complicated<br>
to implement manually.</p>
<p>This is also a first step to being able to test <code>call</code>'s between functions<br>
in the runtest suite. It should also make it easier to eventually test<br>
TLS relocations, symbol resolution and ABI's.</p>
<p>Another benefit of this is that we also get to test the JIT more, since<br>
it now runs the runtests, and gets some fuzzing via <code>fuzzgen</code> (which<br>
uses the <code>SingleFunctionCompiler</code>).</p>
<p>This change causes regressions in terms of runtime for the filetests.<br>
I haven't done any serious benchmarking but what I've been seeing is<br>
that it now takes about ~3 seconds to run the testsuite while it<br>
previously took around 2 seconds.</p>
<p>Edit: <br>
This also closes #3030 since we can now do relocations in runtests</p>
</blockquote>



<a name="291249652"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/291249652" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#291249652">(Jul 28 2022 at 20:44)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4453">PR #4453</a> from <code>testrunner-jit</code> to <code>main</code>.</p>



<a name="291252975"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/291252975" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#291252975">(Jul 28 2022 at 21:15)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#pullrequestreview-1054758602">PR review</a>.</p>



<a name="291252976"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/291252976" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#291252976">(Jul 28 2022 at 21:15)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#discussion_r932675983">PR review comment</a>:</p>
<blockquote>
<p>I'm told Windows 8.1 reaches end of life in January, which seems to me like a good enough reason for Cranelift to require Windows 10. But others may disagree.</p>
<p>Since we're looking at using the libm crate for #4517, I thought I'd check if we could get these functions from there, instead of worrying about Windows C runtime versions. It does have <code>ceilf</code>, <code>floorf</code>, and <code>truncf</code>, but unfortunately not <code>nearbyintf</code>, so I'm not sure if that helps with this question.</p>
</blockquote>



<a name="292368183"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/292368183" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#292368183">(Aug 08 2022 at 07:21)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4453">PR #4453</a> from <code>testrunner-jit</code> to <code>main</code>.</p>



<a name="292370783"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/292370783" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#292370783">(Aug 08 2022 at 07:56)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#discussion_r939938006">PR review comment</a>:</p>
<blockquote>
<p>@cfallin I would like to move forward with this PR since it's blocking some stuff on the fuzzer (getting function calls working).</p>
<p>Would @jameysharp 's reasoning that pretty soon all supported windows versions are going to have <code>ucrt</code> be sufficient? An alternative could be to keep using <code>msvcrt</code>, but we would need to disable some ops on the runtest suite, which is also not ideal.</p>
<p>We can also go with polyfill's as @jameysharp mentioned, I don't like this approach since we would probably keep needing to patch holes in msvcrt. In <a href="https://github.com/bjorn3/rustc_codegen_cranelift/pull/1254">https://github.com/bjorn3/rustc_codegen_cranelift/pull/1254</a> we also found that <code>fabsf</code> is missing from msvcrt, so that's going to be another one that we need. With the bonus that we know that one is <a href="https://github.com/bytecodealliance/wasmtime/pull/4517#issuecomment-1195138197">definitely broken in libm</a>.</p>
</blockquote>



<a name="292370784"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/292370784" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#292370784">(Aug 08 2022 at 07:56)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#pullrequestreview-1064755550">PR review</a>.</p>



<a name="292370794"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/292370794" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#292370794">(Aug 08 2022 at 07:56)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#discussion_r939938006">PR review comment</a>.</p>



<a name="292373494"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/292373494" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#292373494">(Aug 08 2022 at 08:26)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#discussion_r939938006">PR review comment</a>.</p>



<a name="292373627"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/292373627" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#292373627">(Aug 08 2022 at 08:27)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#discussion_r939938006">PR review comment</a>.</p>



<a name="292479087"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/292479087" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#292479087">(Aug 08 2022 at 18:32)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#discussion_r940542547">PR review comment</a>:</p>
<blockquote>
<p>Yeah, I think that's fine; Win10 as a minimum requirement here is probably an acceptable compromise, given the context.</p>
</blockquote>



<a name="292479088"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/292479088" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#292479088">(Aug 08 2022 at 18:32)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#pullrequestreview-1065615487">PR review</a>.</p>



<a name="292641723"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/292641723" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#292641723">(Aug 09 2022 at 19:19)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#pullrequestreview-1067249045">PR review</a>.</p>



<a name="292641724"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/292641724" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#292641724">(Aug 09 2022 at 19:19)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#discussion_r941707625">PR review comment</a>:</p>
<blockquote>
<p>Changing <code>SingleFunctionCompiler::compile</code> from taking <code>&amp;mut self</code> to just <code>self</code> feels unfortunate, since it forces callers to build a new <code>TargetIsa</code> for every function they compile. What would you think of changing <code>JITBuilder</code> to take a shared reference instead? Either <code>&amp;dyn TargetIsa</code> or <code>Rc&lt;dyn TargetIsa&gt;</code>, whichever is easier. In the latter case, <code>SingleFunctionCompiler</code> would also take an <code>Rc</code> instead of a <code>Box</code>.</p>
</blockquote>



<a name="292641725"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/292641725" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#292641725">(Aug 09 2022 at 19:19)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#pullrequestreview-1067249045">PR review</a>.</p>



<a name="292641727"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/292641727" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#292641727">(Aug 09 2022 at 19:19)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#discussion_r941710574">PR review comment</a>:</p>
<blockquote>
<p>What is this change for?</p>
</blockquote>



<a name="292641728"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/292641728" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#292641728">(Aug 09 2022 at 19:19)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#discussion_r941713244">PR review comment</a>:</p>
<blockquote>
<p>I'd prefer not to move this code into the loop, if my earlier suggestion on shared references to the <code>TargetIsa</code> works out.</p>
</blockquote>



<a name="292641729"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/292641729" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#292641729">(Aug 09 2022 at 19:19)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#discussion_r941713324">PR review comment</a>:</p>
<blockquote>
<p>I'd prefer not to move this code into the loop, if my earlier suggestion on shared references to the <code>TargetIsa</code> works out.</p>
</blockquote>



<a name="292641730"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/292641730" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#292641730">(Aug 09 2022 at 19:19)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#discussion_r941715692">PR review comment</a>:</p>
<blockquote>
<p>If it works out to keep the <code>SingleFunctionCompiler</code> reusable, do you think it'd be worth keeping the cache of trampolines around too?</p>
</blockquote>



<a name="292653535"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/292653535" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#292653535">(Aug 09 2022 at 20:37)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#pullrequestreview-1067352330">PR review</a>.</p>



<a name="292653537"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/292653537" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#292653537">(Aug 09 2022 at 20:37)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#discussion_r941780430">PR review comment</a>:</p>
<blockquote>
<p>The name <code>user(0, 0)</code> was the trampoline IIRC and the JIT was complaining about it. I'm not too sure, but I can go check.</p>
</blockquote>



<a name="292654053"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/292654053" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#292654053">(Aug 09 2022 at 20:40)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#discussion_r941783322">PR review comment</a>:</p>
<blockquote>
<p>I remember (sorry, this was a while ago) trying to change to <code>&amp;dyn TargetIsa</code>, but it brought a bunch of changes due to lifetimes, and I gave up on that path.</p>
<p>I didn't  try <code>Rc&lt;&gt;</code> but see the comment down below.</p>
</blockquote>



<a name="292654054"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/292654054" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#292654054">(Aug 09 2022 at 20:40)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4453#pullrequestreview-1067356219">PR review</a>.</p>



<a name="292664051"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234453%20cranelift%3A%20Use%20%60cranelift-jit%60%20in%20run.../near/292664051" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234453.20cranelift.3A.20Use.20.60cranelift-jit.60.20in.20run.2E.2E.2E.html#292664051">(Aug 09 2022 at 21:54)</a>:</h4>
<p>jameysharp merged <a href="https://github.com/bytecodealliance/wasmtime/pull/4453">PR #4453</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>