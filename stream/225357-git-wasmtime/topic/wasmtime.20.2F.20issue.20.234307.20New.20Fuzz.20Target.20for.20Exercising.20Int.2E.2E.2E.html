<html>
<head><meta charset="utf-8"><title>wasmtime / issue #4307 New Fuzz Target for Exercising Int... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html">wasmtime / issue #4307 New Fuzz Target for Exercising Int...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="287230719"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/287230719" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#287230719">(Jun 23 2022 at 18:31)</a>:</h4>
<p>fitzgen opened <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<p>To help make the component model and interface types production ready, we want<br>
to extensively fuzz and exercise Wasmtime's ability to pass interface values<br>
back and forth with Wasm.</p>
<p>This fuzz target should:</p>
<ul>
<li>generate an arbitrary interface type <code>T</code>,</li>
<li>
<p>generate a Wasm component that</p>
<ul>
<li>imports a host function <code>T -&gt; T</code>, and</li>
<li>exports a function <code>T -&gt; T</code> that passes its argument to the import function<br>
  and returns the result of the import function,</li>
</ul>
</li>
<li>
<p>generate some number of arbitrary values of type <code>T</code>,</p>
</li>
<li>
<p>and for each value:</p>
<ul>
<li>call the Wasm's exported function,</li>
<li>
<p>when the host function is called, assert that the argument is equal to the<br>
  original value,</p>
</li>
<li>
<p>return the argument from the host function,</p>
</li>
<li>
<p>when the Wasm function returns to the host, assert that the argument is<br>
  equal to the original value,</p>
</li>
<li>
<p>assert that the host function was actually called.</p>
</li>
</ul>
</li>
</ul>
<p>This tests that we can round trip interface values of type <code>T</code> both as arguments<br>
and returns to and from Wasm.</p>
<p>Here is a diagram showing what the fuzz target should do:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">+-------------------+</span><span class="w">                   </span><span class="o">+------------------+</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="n">Host</span><span class="w">              </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w"> </span><span class="n">Wasm</span><span class="w">             </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">   </span><span class="n">argument</span><span class="w">        </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">     </span><span class="n">arbitrary</span><span class="w"> </span><span class="o">-----------------------------</span>-&gt;            <span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">     </span><span class="n">value</span><span class="w">         </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">+-----------------+</span><span class="w">           </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="n">function</span><span class="w">   </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">imported</span><span class="w"> </span><span class="n">by</span><span class="w">     </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">Wasm</span><span class="w">            </span><span class="o">|</span><span class="w">  </span><span class="n">argument</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="n">V</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">            </span><span class="o">&lt;-----------------------</span><span class="w">            </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">assert</span><span class="w">    </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">is</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">equal</span><span class="w">     </span><span class="n">V</span><span class="w">     </span><span class="o">|</span><span class="w">  </span><span class="k">return</span><span class="w">   </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">            </span><span class="o">----------------------</span>-&gt;            <span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">                 </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">+-----------------+</span><span class="w">           </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">      </span><span class="n">V</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">   </span><span class="n">assert</span><span class="w">    </span><span class="o">&lt;--------------------------------</span><span class="w">            </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">   </span><span class="n">value</span><span class="w"> </span><span class="n">is</span><span class="w">        </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">   </span><span class="n">equal</span><span class="w">           </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">+-------------------+</span><span class="w">                   </span><span class="o">+------------------+</span><span class="w"></span>
</code></pre></div>
<h2>Test Case Generator</h2>
<p>The test case generator will be responsible for generating</p>
<ul>
<li>the arbitrary interface type <code>T</code>,</li>
<li>
<p>the Wasm component that takes values of type <code>T</code>, passes them to the imported<br>
  host function, and returns the result of the host function,</p>
</li>
<li>
<p>and instances of type <code>T</code>.</p>
</li>
</ul>
<h2>Oracle</h2>
<p>There are two versions of the oracle:</p>
<ol>
<li>
<p>a version that uses the dynamic interface types API to pass values to Wasm,<br>
   and</p>
</li>
<li>
<p>a version that uses the static interface types API to pass values to Wasm.</p>
</li>
</ol>
<h3>Dynamic API Oracle</h3>
<p>The dynamic API oracle will be paired with the test case generator <em>at runtime</em><br>
and use Wasmtime's dynamic API for interface type values (doesn't exist at time<br>
of writing; the component equivalent of <code>wasmtime::Val</code>).</p>
<h3>Static API Oracle</h3>
<p>The static API oracle will use the test case generator <em>at build time</em> to<br>
generate, say, 1000 interface types <code>T</code> to fuzz, and then generate arbitrary<br>
instances of <code>T</code> at runtime. This means that if <code>T</code> is a struct, for example, we<br>
can define a Rust type like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(InterfaceType)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">MyRustType</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">foo</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">bar</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>whose instances can be passed to the Wasm directly via Wasmtime's static API for<br>
interface types. We will generate arbitrary instance of <code>MyRustType</code> at runtime<br>
in this scenario, but not new types <code>T</code>.</p>
<p>(Note that <code>derive(InterfaceType)</code> does not exist at the time of writing.)<br>
</p>
</blockquote>



<a name="287231323"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/287231323" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#287231323">(Jun 23 2022 at 18:36)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/4307#issuecomment-1164743223">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<p>We might actually want to have two instances of the Wasm component, so that values flow like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">argument</span>: <span class="nc">host</span><span class="w"> </span><span class="o">--</span>-&gt; <span class="nc">wasm</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">--</span>-&gt; <span class="nc">wasm</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="o">--</span>-&gt; <span class="nc">host</span><span class="w"> </span><span class="n">import</span><span class="w"></span>
<span class="k">return</span>: <span class="nc">host</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="o">--</span>-&gt; <span class="nc">wasm</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="o">--</span>-&gt; <span class="nc">wasm</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">--</span>-&gt; <span class="nc">host</span><span class="w"></span>
</code></pre></div>
<p>so that we are exercising component-to-component trampolines and all that.</p>
</blockquote>



<a name="287243060"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/287243060" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#287243060">(Jun 23 2022 at 20:15)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/issues/4307#issuecomment-1164826430">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<p>Thanks, for writing this up, @fitzgen.  A few of questions for you:</p>
<ol>
<li>Given that neither the dynamic API for interface type values nor <code>derive(InterfaceType)</code> yet exist, I assume each of those things will need to be implemented before the corresponding oracle is created.  Is that correct?</li>
<li>Is it worthwhile to do any work on this issue before one of the above features is implemented?  I.e. is there any point in writing the test case generator without any oracles to use it?</li>
<li>For the static API oracle, were you thinking of creating (or extending) a <a href="http://build.rs">build.rs</a> that generates Rust code or writing a procedural macro?</li>
</ol>
</blockquote>



<a name="287243196"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/287243196" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#287243196">(Jun 23 2022 at 20:16)</a>:</h4>
<p>dicej edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4307#issuecomment-1164826430">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<p>Thanks, for writing this up, @fitzgen.  A few of questions for you:</p>
<ol>
<li>Given that neither the dynamic API for interface type values nor <code>derive(InterfaceType)</code> yet exist, I assume each of those things will need to be implemented before the corresponding oracle is created.  Is that correct?</li>
<li>Is it worthwhile to do any work on this issue before one of the above features is implemented?  I.e. is there any value in writing the test case generator prior to being able to write oracles that use it?</li>
<li>For the static API oracle, were you thinking of creating (or extending) a <a href="http://build.rs">build.rs</a> that generates Rust code or writing a procedural macro?</li>
</ol>
</blockquote>



<a name="287244369"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/287244369" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#287244369">(Jun 23 2022 at 20:26)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/4307#issuecomment-1164842338">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<blockquote>
<ul>
<li>
<p>Given that neither the dynamic API for interface type values nor <code>derive(InterfaceType)</code> yet exist, I assume each of those things will need to be implemented before the corresponding oracle is created.  Is that correct?</p>
</li>
<li>
<p>Is it worthwhile to do any work on this issue before one of the above features is implemented?  I.e. is there any value in writing the test case generator prior to being able to write oracles that use it?</p>
</li>
</ul>
</blockquote>
<p>Yeah, I think it makes sense to unblock this before working on it. We could probably technically implement some (most?) of the test case generator without the oracles, but I think it would be best if they were developed in together since I think the shape of the generator may be informed by the oracles.</p>
<blockquote>
<p>For the static API oracle, were you thinking of creating (or extending) a <a href="http://build.rs">build.rs</a> that generates Rust code or writing a procedural macro?</p>
</blockquote>
<p>I think a <code>build.rs</code> would be better, since it would generally just be easier to write, read, and debug.</p>
</blockquote>



<a name="287244719"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/287244719" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#287244719">(Jun 23 2022 at 20:29)</a>:</h4>
<p>fitzgen edited <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<p>To help make the component model and interface types production ready, we want<br>
to extensively fuzz and exercise Wasmtime's ability to pass interface values<br>
back and forth with Wasm.</p>
<p>This fuzz target should:</p>
<ul>
<li>generate an arbitrary interface type <code>T</code>,</li>
<li>
<p>generate a Wasm component that</p>
<ul>
<li>imports a host function <code>T -&gt; T</code>, and</li>
<li>exports a function <code>T -&gt; T</code> that passes its argument to the import function<br>
  and returns the result of the import function,</li>
</ul>
</li>
<li>
<p>generate some number of arbitrary values of type <code>T</code>,</p>
</li>
<li>
<p>and for each value:</p>
<ul>
<li>call the Wasm's exported function,</li>
<li>
<p>when the host function is called, assert that the argument is equal to the<br>
  original value,</p>
</li>
<li>
<p>return the argument from the host function,</p>
</li>
<li>
<p>when the Wasm function returns to the host, assert that the argument is<br>
  equal to the original value,</p>
</li>
<li>
<p>assert that the host function was actually called.</p>
</li>
</ul>
</li>
</ul>
<p>This tests that we can round trip interface values of type <code>T</code> both as arguments<br>
and returns to and from Wasm.</p>
<p>Here is a diagram showing what the fuzz target should do:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">+-------------------+</span><span class="w">                   </span><span class="o">+------------------+</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="n">Host</span><span class="w">              </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w"> </span><span class="n">Wasm</span><span class="w">             </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">   </span><span class="n">argument</span><span class="w">        </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">     </span><span class="n">arbitrary</span><span class="w"> </span><span class="o">-----------------------------</span>-&gt;            <span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">     </span><span class="n">value</span><span class="w">         </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">+-----------------+</span><span class="w">           </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="n">function</span><span class="w">   </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">imported</span><span class="w"> </span><span class="n">by</span><span class="w">     </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">Wasm</span><span class="w">            </span><span class="o">|</span><span class="w">  </span><span class="n">argument</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="n">V</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">            </span><span class="o">&lt;-----------------------</span><span class="w">            </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">assert</span><span class="w">    </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">is</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">equal</span><span class="w">     </span><span class="n">V</span><span class="w">     </span><span class="o">|</span><span class="w">  </span><span class="k">return</span><span class="w">   </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">            </span><span class="o">----------------------</span>-&gt;            <span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">                 </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">+-----------------+</span><span class="w">           </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">          </span><span class="k">return</span><span class="w">   </span><span class="o">|</span><span class="w">      </span><span class="n">V</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">   </span><span class="n">assert</span><span class="w">    </span><span class="o">&lt;--------------------------------</span><span class="w">            </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">   </span><span class="n">value</span><span class="w"> </span><span class="n">is</span><span class="w">        </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">   </span><span class="n">equal</span><span class="w">           </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">+-------------------+</span><span class="w">                   </span><span class="o">+------------------+</span><span class="w"></span>
</code></pre></div>
<h2>Test Case Generator</h2>
<p>The test case generator will be responsible for generating</p>
<ul>
<li>the arbitrary interface type <code>T</code>,</li>
<li>
<p>the Wasm component that takes values of type <code>T</code>, passes them to the imported<br>
  host function, and returns the result of the host function,</p>
</li>
<li>
<p>and instances of type <code>T</code>.</p>
</li>
</ul>
<h2>Oracle</h2>
<p>There are two versions of the oracle:</p>
<ol>
<li>
<p>a version that uses the dynamic interface types API to pass values to Wasm,<br>
   and</p>
</li>
<li>
<p>a version that uses the static interface types API to pass values to Wasm.</p>
</li>
</ol>
<h3>Dynamic API Oracle</h3>
<p>The dynamic API oracle will be paired with the test case generator <em>at runtime</em><br>
and use Wasmtime's dynamic API for interface type values (doesn't exist at time<br>
of writing; the component equivalent of <code>wasmtime::Val</code>).</p>
<h3>Static API Oracle</h3>
<p>The static API oracle will use the test case generator <em>at build time</em> to<br>
generate, say, 1000 interface types <code>T</code> to fuzz, and then generate arbitrary<br>
instances of <code>T</code> at runtime. This means that if <code>T</code> is a struct, for example, we<br>
can define a Rust type like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(InterfaceType)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">MyRustType</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">foo</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">bar</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>whose instances can be passed to the Wasm directly via Wasmtime's static API for<br>
interface types. We will generate arbitrary instance of <code>MyRustType</code> at runtime<br>
in this scenario, but not new types <code>T</code>.</p>
<p>(Note that <code>derive(InterfaceType)</code> does not exist at the time of writing.)<br>
</p>
</blockquote>



<a name="287245099"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/287245099" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#287245099">(Jun 23 2022 at 20:32)</a>:</h4>
<p>dicej edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4307#issuecomment-1164826430">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<p>Thanks, for writing this up, @fitzgen.  A few questions for you:</p>
<ol>
<li>Given that neither the dynamic API for interface type values nor <code>derive(InterfaceType)</code> yet exist, I assume each of those things will need to be implemented before the corresponding oracle is created.  Is that correct?</li>
<li>Is it worthwhile to do any work on this issue before one of the above features is implemented?  I.e. is there any value in writing the test case generator prior to being able to write oracles that use it?</li>
<li>For the static API oracle, were you thinking of creating (or extending) a <a href="http://build.rs">build.rs</a> that generates Rust code or writing a procedural macro?</li>
</ol>
</blockquote>



<a name="287248816"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/287248816" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#287248816">(Jun 23 2022 at 21:03)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/issues/4307#issuecomment-1164870481">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<p>@alexcrichton Are you planning to create an issue for <code>derive(InterfaceType</code>?  I'd be happy to create a placeholder, but I'm still fuzzy on the details, so I'll need help fleshing it out.</p>
<p>Also, it sounds like we might also need an issue for the interface-type-equivalent of <code>wasmtime::Val</code> Nick mentioned above.  I _think_ I understand what's involved there (e.g. copying <a href="http://values.rs">values.rs</a> and adapting it for interface types), but I could use guidance there, too.</p>
</blockquote>



<a name="287259137"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/287259137" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#287259137">(Jun 23 2022 at 21:12)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/4307#issuecomment-1164877807">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<p>I do indeed want to open an issue! Sorry I got caught up all day in a <a href="https://github.com/bytecodealliance/wasmtime/pull/4306#issuecomment-1164875082">debugging adventure</a> but that's over now so I'll go make an issue next.</p>
</blockquote>



<a name="287259180"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/287259180" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#287259180">(Jun 23 2022 at 21:12)</a>:</h4>
<p>alexcrichton labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<p>To help make the component model and interface types production ready, we want<br>
to extensively fuzz and exercise Wasmtime's ability to pass interface values<br>
back and forth with Wasm.</p>
<p>This fuzz target should:</p>
<ul>
<li>generate an arbitrary interface type <code>T</code>,</li>
<li>
<p>generate a Wasm component that</p>
<ul>
<li>imports a host function <code>T -&gt; T</code>, and</li>
<li>exports a function <code>T -&gt; T</code> that passes its argument to the import function<br>
  and returns the result of the import function,</li>
</ul>
</li>
<li>
<p>generate some number of arbitrary values of type <code>T</code>,</p>
</li>
<li>
<p>and for each value:</p>
<ul>
<li>call the Wasm's exported function,</li>
<li>
<p>when the host function is called, assert that the argument is equal to the<br>
  original value,</p>
</li>
<li>
<p>return the argument from the host function,</p>
</li>
<li>
<p>when the Wasm function returns to the host, assert that the argument is<br>
  equal to the original value,</p>
</li>
<li>
<p>assert that the host function was actually called.</p>
</li>
</ul>
</li>
</ul>
<p>This tests that we can round trip interface values of type <code>T</code> both as arguments<br>
and returns to and from Wasm.</p>
<p>Here is a diagram showing what the fuzz target should do:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">+-------------------+</span><span class="w">                   </span><span class="o">+------------------+</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="n">Host</span><span class="w">              </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w"> </span><span class="n">Wasm</span><span class="w">             </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">   </span><span class="n">argument</span><span class="w">        </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">     </span><span class="n">arbitrary</span><span class="w"> </span><span class="o">-----------------------------</span>-&gt;            <span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">     </span><span class="n">value</span><span class="w">         </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">+-----------------+</span><span class="w">           </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="n">function</span><span class="w">   </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">imported</span><span class="w"> </span><span class="n">by</span><span class="w">     </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">Wasm</span><span class="w">            </span><span class="o">|</span><span class="w">  </span><span class="n">argument</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="n">V</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">            </span><span class="o">&lt;-----------------------</span><span class="w">            </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">assert</span><span class="w">    </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">is</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">equal</span><span class="w">     </span><span class="n">V</span><span class="w">     </span><span class="o">|</span><span class="w">  </span><span class="k">return</span><span class="w">   </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">            </span><span class="o">----------------------</span>-&gt;            <span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">                 </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">+-----------------+</span><span class="w">           </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">          </span><span class="k">return</span><span class="w">   </span><span class="o">|</span><span class="w">      </span><span class="n">V</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">   </span><span class="n">assert</span><span class="w">    </span><span class="o">&lt;--------------------------------</span><span class="w">            </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">   </span><span class="n">value</span><span class="w"> </span><span class="n">is</span><span class="w">        </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">   </span><span class="n">equal</span><span class="w">           </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">+-------------------+</span><span class="w">                   </span><span class="o">+------------------+</span><span class="w"></span>
</code></pre></div>
<h2>Test Case Generator</h2>
<p>The test case generator will be responsible for generating</p>
<ul>
<li>the arbitrary interface type <code>T</code>,</li>
<li>
<p>the Wasm component that takes values of type <code>T</code>, passes them to the imported<br>
  host function, and returns the result of the host function,</p>
</li>
<li>
<p>and instances of type <code>T</code>.</p>
</li>
</ul>
<h2>Oracle</h2>
<p>There are two versions of the oracle:</p>
<ol>
<li>
<p>a version that uses the dynamic interface types API to pass values to Wasm,<br>
   and</p>
</li>
<li>
<p>a version that uses the static interface types API to pass values to Wasm.</p>
</li>
</ol>
<h3>Dynamic API Oracle</h3>
<p>The dynamic API oracle will be paired with the test case generator <em>at runtime</em><br>
and use Wasmtime's dynamic API for interface type values (doesn't exist at time<br>
of writing; the component equivalent of <code>wasmtime::Val</code>).</p>
<h3>Static API Oracle</h3>
<p>The static API oracle will use the test case generator <em>at build time</em> to<br>
generate, say, 1000 interface types <code>T</code> to fuzz, and then generate arbitrary<br>
instances of <code>T</code> at runtime. This means that if <code>T</code> is a struct, for example, we<br>
can define a Rust type like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(InterfaceType)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">MyRustType</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">foo</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">bar</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>whose instances can be passed to the Wasm directly via Wasmtime's static API for<br>
interface types. We will generate arbitrary instance of <code>MyRustType</code> at runtime<br>
in this scenario, but not new types <code>T</code>.</p>
<p>(Note that <code>derive(InterfaceType)</code> does not exist at the time of writing.)<br>
</p>
</blockquote>



<a name="288832290"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/288832290" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#288832290">(Jul 07 2022 at 16:40)</a>:</h4>
<p>jameysharp labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<p>To help make the component model and interface types production ready, we want<br>
to extensively fuzz and exercise Wasmtime's ability to pass interface values<br>
back and forth with Wasm.</p>
<p>This fuzz target should:</p>
<ul>
<li>generate an arbitrary interface type <code>T</code>,</li>
<li>
<p>generate a Wasm component that</p>
<ul>
<li>imports a host function <code>T -&gt; T</code>, and</li>
<li>exports a function <code>T -&gt; T</code> that passes its argument to the import function<br>
  and returns the result of the import function,</li>
</ul>
</li>
<li>
<p>generate some number of arbitrary values of type <code>T</code>,</p>
</li>
<li>
<p>and for each value:</p>
<ul>
<li>call the Wasm's exported function,</li>
<li>
<p>when the host function is called, assert that the argument is equal to the<br>
  original value,</p>
</li>
<li>
<p>return the argument from the host function,</p>
</li>
<li>
<p>when the Wasm function returns to the host, assert that the argument is<br>
  equal to the original value,</p>
</li>
<li>
<p>assert that the host function was actually called.</p>
</li>
</ul>
</li>
</ul>
<p>This tests that we can round trip interface values of type <code>T</code> both as arguments<br>
and returns to and from Wasm.</p>
<p>Here is a diagram showing what the fuzz target should do:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">+-------------------+</span><span class="w">                   </span><span class="o">+------------------+</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="n">Host</span><span class="w">              </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w"> </span><span class="n">Wasm</span><span class="w">             </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">   </span><span class="n">argument</span><span class="w">        </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">     </span><span class="n">arbitrary</span><span class="w"> </span><span class="o">-----------------------------</span>-&gt;            <span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">     </span><span class="n">value</span><span class="w">         </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">+-----------------+</span><span class="w">           </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="n">function</span><span class="w">   </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">imported</span><span class="w"> </span><span class="n">by</span><span class="w">     </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">Wasm</span><span class="w">            </span><span class="o">|</span><span class="w">  </span><span class="n">argument</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="n">V</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">            </span><span class="o">&lt;-----------------------</span><span class="w">            </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">assert</span><span class="w">    </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">is</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">equal</span><span class="w">     </span><span class="n">V</span><span class="w">     </span><span class="o">|</span><span class="w">  </span><span class="k">return</span><span class="w">   </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">            </span><span class="o">----------------------</span>-&gt;            <span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">                 </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">+-----------------+</span><span class="w">           </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">          </span><span class="k">return</span><span class="w">   </span><span class="o">|</span><span class="w">      </span><span class="n">V</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">   </span><span class="n">assert</span><span class="w">    </span><span class="o">&lt;--------------------------------</span><span class="w">            </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">   </span><span class="n">value</span><span class="w"> </span><span class="n">is</span><span class="w">        </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">   </span><span class="n">equal</span><span class="w">           </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">+-------------------+</span><span class="w">                   </span><span class="o">+------------------+</span><span class="w"></span>
</code></pre></div>
<h2>Test Case Generator</h2>
<p>The test case generator will be responsible for generating</p>
<ul>
<li>the arbitrary interface type <code>T</code>,</li>
<li>
<p>the Wasm component that takes values of type <code>T</code>, passes them to the imported<br>
  host function, and returns the result of the host function,</p>
</li>
<li>
<p>and instances of type <code>T</code>.</p>
</li>
</ul>
<h2>Oracle</h2>
<p>There are two versions of the oracle:</p>
<ol>
<li>
<p>a version that uses the dynamic interface types API to pass values to Wasm,<br>
   and</p>
</li>
<li>
<p>a version that uses the static interface types API to pass values to Wasm.</p>
</li>
</ol>
<h3>Dynamic API Oracle</h3>
<p>The dynamic API oracle will be paired with the test case generator <em>at runtime</em><br>
and use Wasmtime's dynamic API for interface type values (doesn't exist at time<br>
of writing; the component equivalent of <code>wasmtime::Val</code>).</p>
<h3>Static API Oracle</h3>
<p>The static API oracle will use the test case generator <em>at build time</em> to<br>
generate, say, 1000 interface types <code>T</code> to fuzz, and then generate arbitrary<br>
instances of <code>T</code> at runtime. This means that if <code>T</code> is a struct, for example, we<br>
can define a Rust type like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(InterfaceType)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">MyRustType</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">foo</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">bar</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>whose instances can be passed to the Wasm directly via Wasmtime's static API for<br>
interface types. We will generate arbitrary instance of <code>MyRustType</code> at runtime<br>
in this scenario, but not new types <code>T</code>.</p>
<p>(Note that <code>derive(InterfaceType)</code> does not exist at the time of writing.)<br>
</p>
</blockquote>



<a name="289529970"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/289529970" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#289529970">(Jul 13 2022 at 22:36)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/issues/4307#issuecomment-1183749659">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<p>FYI, I'm planning to start working on this tomorrow, assuming no significant additional work is needed on #4442.</p>
</blockquote>



<a name="289609964"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/289609964" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#289609964">(Jul 14 2022 at 15:48)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/issues/4307#issuecomment-1184605845">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<p>Looks like #4442 needs more work, so I won't be able to tackle this one quite yet.</p>
</blockquote>



<a name="289760710"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/289760710" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#289760710">(Jul 15 2022 at 17:53)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/issues/4307#issuecomment-1185770089">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<p>Quick question: Should the test case generator deliberately generate instances and components which do _not_ match the generated type?</p>
<p>For example, if the generated type is a record with three fields, should the instance generator (sometimes) generate values with too many, not enough, or mis-typed field values (or values which are instances of an entirely different sort of type), and should the component generator (sometimes) generate a component which expects a different record type (or a different sort of type)?</p>
</blockquote>



<a name="289762042"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/289762042" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#289762042">(Jul 15 2022 at 18:02)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/4307#issuecomment-1185776968">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<p>You could do that with very low probability (something like <code>u.ratio(1, 1_000)</code>) if you want, but I don't think it is super critical. Wouldn't work on this kind of thing ahead of working on the main bits.</p>
</blockquote>



<a name="289776643"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/289776643" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#289776643">(Jul 15 2022 at 20:03)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/issues/4307#issuecomment-1185869270">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<p>Regarding the static API oracle: neither <code>libFuzzer</code> nor <code>cargo-fuzz</code> will be involved, correct?  I'm envisioning adding code to the <a href="http://build.rs">build.rs</a> at the root of the repo which generates a .rs file under the tests directory containing a single test that exercises 1000 random test cases, each of which has been generated in <a href="http://build.rs">build.rs</a> using the test case generator with an <code>arbitrary::Unstructured</code> initialized with a random byte slice.  Does that sound right?</p>
</blockquote>



<a name="289964947"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/289964947" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#289964947">(Jul 18 2022 at 13:28)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/4307#issuecomment-1187429770">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<p>Yeah that sounds right to me. We'll want the seed of the byte slice to be deterministic somewhat in the sense that if something hits a bug on oss-fuzz we want to be able to reproduce it locally by overriding the seed. For now I think having an optional env var to specify the seed would be fine, we can always fiddle with it later too.</p>
</blockquote>



<a name="290121799"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/290121799" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#290121799">(Jul 19 2022 at 16:05)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/issues/4307#issuecomment-1189252406">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<p>I'm making good progress on this, but getting hung up on the asymmetry between the <code>ComponentType</code> impls for <code>str</code> and <code>WasmStr</code>.  The former only implements <code>Lower</code>, and the latter only implements <code>Lift</code>, so there's currently no available string type that implements both AFAICT.  This would be an issue any time someone wanted to derive both <code>Lift</code> and <code>Lower</code> for a type containing a string, and it's especially annoying when generating a fuzz test like this one.</p>
<p>My first thought was to create my own type wrapper (e.g. <code>struct MyString(Box&lt;str&gt;)</code>) and then manually implement both <code>Lift</code> and <code>Lower</code> for it, but that's getting ugly fast, and I don't think we should expect <code>wasmtime</code> embedders to do that anyway.  Another option is to have the test case generator generate two versions of each type: one for lifting and one for lowering -- just in case the type has a string somewhere in the hierarchy.  I'd also need to generate a <code>PartialEq</code> impl for each such pair of types, which would be extremely tedious.</p>
<p>@alexcrichton I think life would be a lot easier if <code>String</code> (and <code>Box&lt;str&gt;</code>, etc.) implemented <code>Lift</code>, raising an error if the bytes aren't valid UTF-8.  What do you think?</p>
</blockquote>



<a name="290130906"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/290130906" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#290130906">(Jul 19 2022 at 17:06)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/4307#issuecomment-1189342042">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<p>That actually seems quite reasonable to me, the <code>WasmStr</code> type needed to exist as a base-level of support, but building <code>String</code> on top of <code>Lower for str</code> and <code>Lift for WasmStr</code> I think would work great!</p>
</blockquote>



<a name="290308602"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/290308602" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#290308602">(Jul 20 2022 at 22:34)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/issues/4307#issuecomment-1190832164">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<blockquote>
<p>That actually seems quite reasonable to me, the <code>WasmStr</code> type needed to exist as a base-level of support, but building <code>String</code> on top of <code>Lower for str</code> and <code>Lift for WasmStr</code> I think would work great!</p>
</blockquote>
<p>I tried to do this, but given that <code>Lift::load</code> only receives a <code>Memory</code> and a <code>&amp;[u8]</code> (and no store), there doesn't seem to be a way to access the memory of the string body, so there's no way to construct an actual non-empty <code>String</code>.  Am I missing something?</p>
</blockquote>



<a name="290309011"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/290309011" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#290309011">(Jul 20 2022 at 22:38)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/issues/4307#issuecomment-1190837445">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<p>Regarding the above, would it be reasonable to add a <code>&amp;StoreOpaque</code> parameter to <code>Lift::load</code>?</p>
</blockquote>



<a name="290383864"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/290383864" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#290383864">(Jul 21 2022 at 14:37)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/4307#issuecomment-1191566344">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<p>I think <a href="https://github.com/bytecodealliance/wasmtime/blob/4ce329d1ebdd5a8556f58535b4cbeb698b5c03c4/crates/wasmtime/src/component/func/options.rs#L226-L228"><code>Memory::as_slice</code></a> can be used to get the view into the entire linear memory for indirect pointers?</p>
</blockquote>



<a name="290385318"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/290385318" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#290385318">(Jul 21 2022 at 14:47)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/issues/4307#issuecomment-1191578388">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<blockquote>
<p>I think <a href="https://github.com/bytecodealliance/wasmtime/blob/4ce329d1ebdd5a8556f58535b4cbeb698b5c03c4/crates/wasmtime/src/component/func/options.rs#L226-L228"><code>Memory::as_slice</code></a> can be used to get the view into the entire linear memory for indirect pointers?</p>
</blockquote>
<p>Oh, good call.  I missed that <code>Memory</code> had a <code>StoreOpaque</code> field.  Thanks!</p>
</blockquote>



<a name="291345054"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/291345054" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#291345054">(Jul 29 2022 at 16:00)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/issues/4307#issuecomment-1199615965">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<p>@alexcrichton Things are coming together nicely.  The fuzz tests have found a few bugs, which I've been debugging and fixing.  I could use your help with dependency management, though.</p>
<p>The publish CI job isn't happy with the "component-test-util/component-model" line I added to Cargo.toml, and my cargo skills aren't sharp enough to know how to address it.  In this case <code>component-test-util</code> is a dev depencency, but it's only used when the <code>component-model</code> feature is enabled.  However, apparently dev dependencies can't be <code>optional</code>, so I'm not sure what to do.  Any ideas?</p>
</blockquote>



<a name="291345653"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/291345653" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#291345653">(Jul 29 2022 at 16:04)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/4307#issuecomment-1199624852">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<p>Nice! I'm also happy to help out with debugging if you'd like as well.</p>
<p>Otherwise though I think the best fix is to just unconditionally enable the <code>component-model</code> feature when testing. We already do this for other optional features like <code>async</code> and it'll avoid us having to deal with features-in-tests. In short there's no other easy answer for having an optional dev-dependency.</p>
<p>I'll try to work on a PR to unconditionally enable the <code>component-model</code> when testing.</p>
</blockquote>



<a name="291347416"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/291347416" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#291347416">(Jul 29 2022 at 16:18)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/issues/4307#issuecomment-1199657161">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<p>Here's a fun one:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'&lt;</span><span class="n">unnamed</span><span class="o">&gt;'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Result</span>::<span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="nb">Err</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>: <span class="nc">item</span><span class="w"> </span><span class="n">nesting</span><span class="w"> </span><span class="n">too</span><span class="w"> </span><span class="n">deep</span><span class="w"></span>
<span class="w">     </span><span class="o">-</span>-&gt; <span class="o">&lt;</span><span class="n">anon</span><span class="o">&gt;</span>:<span class="mi">66</span>:<span class="mi">1005</span><span class="w"></span>
<span class="w">      </span><span class="o">|</span><span class="w"></span>
<span class="w">   </span><span class="mi">66</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="p">(</span><span class="n">import</span><span class="w"> </span><span class="s">"echo"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$f</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">record</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="s">"f0"</span><span class="w"> </span><span class="p">(</span><span class="n">record</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="s">"f0"</span><span class="w"> </span><span class="p">(</span><span class="n">record</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="s">"f0"</span><span class="w"> </span><span class="p">(</span><span class="n">record</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="s">"f0"</span><span class="w"> </span><span class="p">(</span><span class="n">record</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="s">"f0"</span><span class="w"> </span><span class="p">(</span><span class="n">record</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="s">"f0"</span><span class="w"> </span><span class="p">(</span><span class="n">record</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="s">"f0"</span><span class="w"> </span><span class="p">(</span><span class="n">record</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="s">"f0"</span><span class="w"> </span><span class="p">(</span><span class="n">record</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="s">"f0"</span><span class="w"> </span><span class="p">(</span><span class="n">record</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="s">"f0"</span><span class="w"> </span><span class="p">(</span><span class="n">record</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="s">"f0"</span><span class="w"> </span><span class="p">(</span><span class="n">record</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="s">"f0"</span><span class="w"> </span><span class="p">(</span><span class="n">record</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="s">"f0"</span><span class="w"> </span><span class="p">(</span><span class="n">record</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="s">"f0"</span><span class="w"> </span><span class="p">(</span><span class="n">record</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="s">"f0"</span><span class="w"> </span><span class="p">(</span><span class="n">record</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="s">"f0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="p">(</span><span class="n">variant</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C0"</span><span class="w"> </span><span class="n">string</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">case</span><span class="w"> </span><span class="s">"C1"</span><span class="w"> </span><span class="n">unit</span><span class="p">)))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="n">unit</span><span class="p">)))</span><span class="w"></span>
<span class="w">      </span><span class="o">|</span><span class="w">                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </span><span class="o">^'</span><span class="p">,</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">fuzzing</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">oracles</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1088</span>:<span class="mi">6</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="291350405"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/291350405" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#291350405">(Jul 29 2022 at 16:44)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/4307#issuecomment-1199717875">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<p>Ah yeah for that we'll want to constrain the <code>Arbitrary</code> for the type hierarchy to have some maximum depth. For that we'll either need to throw out test cases earlier or otherwise change the <code>Arbitrary</code> impl to constrain how deep types can be.</p>
<p>I suppose another idea is to use the binary encoding instead of the text encoding of components since that specific error is coming from the <code>wast</code> parser. </p>
<p>... This makes me think that we may stack overflow with super deep type hierarchies now...</p>
</blockquote>



<a name="292053215"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/292053215" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#292053215">(Aug 04 2022 at 18:49)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/issues/4307#issuecomment-1205648302">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<p>This is done as of #4537, I believe.</p>
</blockquote>



<a name="292055852"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/292055852" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#292055852">(Aug 04 2022 at 19:10)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/4307#issuecomment-1205668162">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<p>Indeed, and thanks again @dicej!</p>
</blockquote>



<a name="292055853"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234307%20New%20Fuzz%20Target%20for%20Exercising%20Int.../near/292055853" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234307.20New.20Fuzz.20Target.20for.20Exercising.20Int.2E.2E.2E.html#292055853">(Aug 04 2022 at 19:10)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/4307">issue #4307</a>:</p>
<blockquote>
<p>To help make the component model and interface types production ready, we want<br>
to extensively fuzz and exercise Wasmtime's ability to pass interface values<br>
back and forth with Wasm.</p>
<p>This fuzz target should:</p>
<ul>
<li>generate an arbitrary interface type <code>T</code>,</li>
<li>
<p>generate a Wasm component that</p>
<ul>
<li>imports a host function <code>T -&gt; T</code>, and</li>
<li>exports a function <code>T -&gt; T</code> that passes its argument to the import function<br>
  and returns the result of the import function,</li>
</ul>
</li>
<li>
<p>generate some number of arbitrary values of type <code>T</code>,</p>
</li>
<li>
<p>and for each value:</p>
<ul>
<li>call the Wasm's exported function,</li>
<li>
<p>when the host function is called, assert that the argument is equal to the<br>
  original value,</p>
</li>
<li>
<p>return the argument from the host function,</p>
</li>
<li>
<p>when the Wasm function returns to the host, assert that the argument is<br>
  equal to the original value,</p>
</li>
<li>
<p>assert that the host function was actually called.</p>
</li>
</ul>
</li>
</ul>
<p>This tests that we can round trip interface values of type <code>T</code> both as arguments<br>
and returns to and from Wasm.</p>
<p>Here is a diagram showing what the fuzz target should do:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">+-------------------+</span><span class="w">                   </span><span class="o">+------------------+</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="n">Host</span><span class="w">              </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w"> </span><span class="n">Wasm</span><span class="w">             </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">   </span><span class="n">argument</span><span class="w">        </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">     </span><span class="n">arbitrary</span><span class="w"> </span><span class="o">-----------------------------</span>-&gt;            <span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">     </span><span class="n">value</span><span class="w">         </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">+-----------------+</span><span class="w">           </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="n">function</span><span class="w">   </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">imported</span><span class="w"> </span><span class="n">by</span><span class="w">     </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">Wasm</span><span class="w">            </span><span class="o">|</span><span class="w">  </span><span class="n">argument</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="n">V</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">            </span><span class="o">&lt;-----------------------</span><span class="w">            </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">assert</span><span class="w">    </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">is</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">equal</span><span class="w">     </span><span class="n">V</span><span class="w">     </span><span class="o">|</span><span class="w">  </span><span class="k">return</span><span class="w">   </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">            </span><span class="o">----------------------</span>-&gt;            <span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">                 </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">         </span><span class="o">+-----------------+</span><span class="w">           </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">          </span><span class="k">return</span><span class="w">   </span><span class="o">|</span><span class="w">      </span><span class="n">V</span><span class="w">           </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">   </span><span class="n">assert</span><span class="w">    </span><span class="o">&lt;--------------------------------</span><span class="w">            </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">   </span><span class="n">value</span><span class="w"> </span><span class="n">is</span><span class="w">        </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">   </span><span class="n">equal</span><span class="w">           </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"></span>
<span class="o">+-------------------+</span><span class="w">                   </span><span class="o">+------------------+</span><span class="w"></span>
</code></pre></div>
<h2>Test Case Generator</h2>
<p>The test case generator will be responsible for generating</p>
<ul>
<li>the arbitrary interface type <code>T</code>,</li>
<li>
<p>the Wasm component that takes values of type <code>T</code>, passes them to the imported<br>
  host function, and returns the result of the host function,</p>
</li>
<li>
<p>and instances of type <code>T</code>.</p>
</li>
</ul>
<h2>Oracle</h2>
<p>There are two versions of the oracle:</p>
<ol>
<li>
<p>a version that uses the dynamic interface types API to pass values to Wasm,<br>
   and</p>
</li>
<li>
<p>a version that uses the static interface types API to pass values to Wasm.</p>
</li>
</ol>
<h3>Dynamic API Oracle</h3>
<p>The dynamic API oracle will be paired with the test case generator <em>at runtime</em><br>
and use Wasmtime's dynamic API for interface type values (doesn't exist at time<br>
of writing; the component equivalent of <code>wasmtime::Val</code>).</p>
<h3>Static API Oracle</h3>
<p>The static API oracle will use the test case generator <em>at build time</em> to<br>
generate, say, 1000 interface types <code>T</code> to fuzz, and then generate arbitrary<br>
instances of <code>T</code> at runtime. This means that if <code>T</code> is a struct, for example, we<br>
can define a Rust type like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(InterfaceType)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">MyRustType</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">foo</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">bar</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>whose instances can be passed to the Wasm directly via Wasmtime's static API for<br>
interface types. We will generate arbitrary instance of <code>MyRustType</code> at runtime<br>
in this scenario, but not new types <code>T</code>.</p>
<p>(Note that <code>derive(InterfaceType)</code> does not exist at the time of writing.)<br>
</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>