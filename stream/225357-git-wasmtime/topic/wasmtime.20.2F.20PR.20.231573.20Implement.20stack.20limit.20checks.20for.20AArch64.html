<html>
<head><meta charset="utf-8"><title>wasmtime / PR #1573 Implement stack limit checks for AArch64 · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231573.20Implement.20stack.20limit.20checks.20for.20AArch64.html">wasmtime / PR #1573 Implement stack limit checks for AArch64</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="194874856"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231573%20Implement%20stack%20limit%20checks%20for%20AArch64/near/194874856" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231573.20Implement.20stack.20limit.20checks.20for.20AArch64.html#194874856">(Apr 21 2020 at 23:39)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/1573" title="https://github.com/bytecodealliance/wasmtime/pull/1573">PR #1573</a> from <code>aarch64-stack-limit</code> to <code>master</code>:</p>
<blockquote>
<p>This commit implements the stack limit checks in cranelift for the<br>
AArch64 backend. This gets the <code>stack_limit</code> argument purpose as well as<br>
a function's global <code>stack_limit</code> directive working for the AArch64<br>
backend. I've tested this locally on some hardware and in an emulator<br>
and it looks to be working for basic tests, but I've never really done<br>
AArch64 before so some scrutiny on the instructions would be most<br>
welcome!</p>
<p>I also suspect that these stack limit checks aren't quite optimal, but they relatively closely match the x86 backend (which also isn't optimal), so for now I'm largely hoping for correctness as opposed to speed.</p>
</blockquote>



<a name="194874868"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231573%20Implement%20stack%20limit%20checks%20for%20AArch64/near/194874868" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231573.20Implement.20stack.20limit.20checks.20for.20AArch64.html#194874868">(Apr 21 2020 at 23:39)</a>:</h4>
<p>alexcrichton edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1573" title="https://github.com/bytecodealliance/wasmtime/pull/1573">PR #1573</a> from <code>aarch64-stack-limit</code> to <code>master</code>:</p>
<blockquote>
<p>This commit implements the stack limit checks in cranelift for the<br>
AArch64 backend. This gets the <code>stack_limit</code> argument purpose as well as<br>
a function's global <code>stack_limit</code> directive working for the AArch64<br>
backend. I've tested this locally on some hardware and in an emulator<br>
and it looks to be working for basic tests, but I've never really done<br>
AArch64 before so some scrutiny on the instructions would be most<br>
welcome!</p>
<p>I also suspect that these stack limit checks aren't quite optimal, but they relatively closely match the x86 backend (which also isn't optimal), so for now I'm largely hoping for correctness as opposed to speed.</p>
<p>Closes #1569</p>
</blockquote>



<a name="194874930"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231573%20Implement%20stack%20limit%20checks%20for%20AArch64/near/194874930" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231573.20Implement.20stack.20limit.20checks.20for.20AArch64.html#194874930">(Apr 21 2020 at 23:40)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1573" title="https://github.com/bytecodealliance/wasmtime/pull/1573">PR #1573</a> from <code>aarch64-stack-limit</code> to <code>master</code>:</p>
<blockquote>
<p>This commit implements the stack limit checks in cranelift for the<br>
AArch64 backend. This gets the <code>stack_limit</code> argument purpose as well as<br>
a function's global <code>stack_limit</code> directive working for the AArch64<br>
backend. I've tested this locally on some hardware and in an emulator<br>
and it looks to be working for basic tests, but I've never really done<br>
AArch64 before so some scrutiny on the instructions would be most<br>
welcome!</p>
<p>I also suspect that these stack limit checks aren't quite optimal, but they relatively closely match the x86 backend (which also isn't optimal), so for now I'm largely hoping for correctness as opposed to speed.</p>
<p>Closes #1569</p>
</blockquote>



<a name="194911170"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231573%20Implement%20stack%20limit%20checks%20for%20AArch64/near/194911170" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231573.20Implement.20stack.20limit.20checks.20for.20AArch64.html#194911170">(Apr 22 2020 at 10:12)</a>:</h4>
<p><strong>bnjbvr</strong> requested <a href="https://github.com/cfallin" title="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1573" title="https://github.com/bytecodealliance/wasmtime/pull/1573">PR #1573</a>.</p>



<a name="194935725"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231573%20Implement%20stack%20limit%20checks%20for%20AArch64/near/194935725" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231573.20Implement.20stack.20limit.20checks.20for.20AArch64.html#194935725">(Apr 22 2020 at 14:07)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1573#discussion_r413014575" title="https://github.com/bytecodealliance/wasmtime/pull/1573#discussion_r413014575">PR Review Comment</a>:</p>
<blockquote>
<div class="codehilite"><pre><span></span>        // documentation in x86/abi.rs for why this is here. The general idea is
</pre></div>


</blockquote>



<a name="194935726"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231573%20Implement%20stack%20limit%20checks%20for%20AArch64/near/194935726" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231573.20Implement.20stack.20limit.20checks.20for.20AArch64.html#194935726">(Apr 22 2020 at 14:07)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1573#pullrequestreview-398228548" title="https://github.com/bytecodealliance/wasmtime/pull/1573#pullrequestreview-398228548">PR Review</a>.</p>



<a name="194976778"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231573%20Implement%20stack%20limit%20checks%20for%20AArch64/near/194976778" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231573.20Implement.20stack.20limit.20checks.20for.20AArch64.html#194976778">(Apr 22 2020 at 19:03)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1573#pullrequestreview-398469616" title="https://github.com/bytecodealliance/wasmtime/pull/1573#pullrequestreview-398469616">PR Review</a>.</p>



<a name="194976779"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231573%20Implement%20stack%20limit%20checks%20for%20AArch64/near/194976779" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231573.20Implement.20stack.20limit.20checks.20for.20AArch64.html#194976779">(Apr 22 2020 at 19:03)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1573#pullrequestreview-398469616" title="https://github.com/bytecodealliance/wasmtime/pull/1573#pullrequestreview-398469616">PR Review</a>.</p>



<a name="194976780"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231573%20Implement%20stack%20limit%20checks%20for%20AArch64/near/194976780" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231573.20Implement.20stack.20limit.20checks.20for.20AArch64.html#194976780">(Apr 22 2020 at 19:03)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/1573#discussion_r413223833" title="https://github.com/bytecodealliance/wasmtime/pull/1573#discussion_r413223833">PR Review Comment</a>:</p>
<blockquote>
<p>Hmm. I'm not wild about having this GlobalValue expansion implementation local to the stack-limit code, but upon looking at <code>aarch64/lower.rs</code>, it seems that in all other cases the legalization pass transforms actual <code>GlobalValue</code> ops into core ops as here.</p>
<p>Perhaps we could at least move <code>generate_gv</code> to <code>aarch64/lower.rs</code> (passing in the vmctx reg as an arg)? This could eventually be used if we shift from the current encodings-based legalization framework to something simpler/more purpose-built as well.</p>
</blockquote>



<a name="194976781"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231573%20Implement%20stack%20limit%20checks%20for%20AArch64/near/194976781" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231573.20Implement.20stack.20limit.20checks.20for.20AArch64.html#194976781">(Apr 22 2020 at 19:03)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/1573#discussion_r413227000" title="https://github.com/bytecodealliance/wasmtime/pull/1573#discussion_r413227000">PR Review Comment</a>:</p>
<blockquote>
<p>Factor this pattern out (also occurs above) -- take <code>f</code> and <code>sig</code>, and return reg for vmctx plus <code>Vec&lt;Inst&gt;</code>?</p>
<p>To allocate a new temp as an <code>into_reg</code> to hold <code>stack_limit</code>, we'll need to finagle the plumbing a bit. Vreg temps are allocated by the <code>LowerCtx</code>, which we've kept separate from the ABI traits, and using this will be tricky because we can't have generic methods on the <code>ABIBody</code> trait. The ordering is slightly tricky too: the <code>ABIBody</code> is created before lowering starts, so that's too early to alloc a temp, but <code>gen_prologue</code> happens late (we lower instructions in reverse order) so we can't do it there either.</p>
<p>Suggestion: perhaps add an <code>init</code> method on the <code>ABIBody</code> trait that takes a "just in case" temp? (vregs are basically free, aside from creating sparsity in the ID space, so this is fine.) Then this could set <code>stack_limit</code> for use by <code>gen_prologue</code> and any calls.</p>
</blockquote>



<a name="194976783"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231573%20Implement%20stack%20limit%20checks%20for%20AArch64/near/194976783" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231573.20Implement.20stack.20limit.20checks.20for.20AArch64.html#194976783">(Apr 22 2020 at 19:03)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/1573#discussion_r413229767" title="https://github.com/bytecodealliance/wasmtime/pull/1573#discussion_r413229767">PR Review Comment</a>:</p>
<blockquote>
<p>Eek, I'm not sure if it's safe to use <code>spilltmp</code> here -- or at least it's not clear it will interact well with anything we might write in the future. The basic invariant is that <code>spilltmp</code> should only be used within a sequence of instructions generated as one unit (the original use was to compute large stackframe offsets for regalloc spills/reloads, hence the name). We should probably take an <code>into_reg</code> as an argument of <code>generate_gv</code> here, and then by implication, to <code>gen_stack_limit</code> too.</p>
<p>(I should've added more documentation about this, sorry -- if you wouldn't mind adding a comment on <code>spilltmp_reg()</code> to this effect, that'd be very helpful, thanks!)</p>
</blockquote>



<a name="194976784"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231573%20Implement%20stack%20limit%20checks%20for%20AArch64/near/194976784" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231573.20Implement.20stack.20limit.20checks.20for.20AArch64.html#194976784">(Apr 22 2020 at 19:03)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/1573#discussion_r413226429" title="https://github.com/bytecodealliance/wasmtime/pull/1573#discussion_r413226429">PR Review Comment</a>:</p>
<blockquote>
<p>Are we worried about &gt;4K struct offsets? If we're making this into a more generic thing anyway, we could handle the overflow case here too -- basically just use <code>Inst::load_constant(rd, value)</code> giving a <code>Vec&lt;Inst&gt;</code> (and we can use the spilltemp reg for the constant).</p>
</blockquote>



<a name="194976785"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231573%20Implement%20stack%20limit%20checks%20for%20AArch64/near/194976785" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231573.20Implement.20stack.20limit.20checks.20for.20AArch64.html#194976785">(Apr 22 2020 at 19:03)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/1573#discussion_r413234785" title="https://github.com/bytecodealliance/wasmtime/pull/1573#discussion_r413234785">PR Review Comment</a>:</p>
<blockquote>
<p>This little register dance hopefully goes away if we use a proper vreg for <code>stack_limit</code>...</p>
</blockquote>



<a name="194976786"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231573%20Implement%20stack%20limit%20checks%20for%20AArch64/near/194976786" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231573.20Implement.20stack.20limit.20checks.20for.20AArch64.html#194976786">(Apr 22 2020 at 19:03)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/1573#discussion_r413243250" title="https://github.com/bytecodealliance/wasmtime/pull/1573#discussion_r413243250">PR Review Comment</a>:</p>
<blockquote>
<p>Actually, one more thought: after reading through the rest of the patch, it seems that <code>stack_limit</code> is not used beyond the prologue. Given this, I think it would be fine to use <code>spilltmp</code> within <code>gen_prologue</code> itself, and then carefully validate that we don't keep it live across anything else that could implicitly use it. This includes any virtual registers at all: the register allocator is liable to pop in and do a surprise spill with a big offset somewhere, wiping out <code>spilltmp</code>.</p>
</blockquote>



<a name="194976787"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231573%20Implement%20stack%20limit%20checks%20for%20AArch64/near/194976787" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231573.20Implement.20stack.20limit.20checks.20for.20AArch64.html#194976787">(Apr 22 2020 at 19:03)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/1573#discussion_r413237028" title="https://github.com/bytecodealliance/wasmtime/pull/1573#discussion_r413237028">PR Review Comment</a>:</p>
<blockquote>
<p>This should have a test case in the emission tests (<code>test_aarch64_binemit()</code> below), with the golden machine code validated as the comment notes (using real aarch64 assembler). Thanks!</p>
</blockquote>



<a name="194992009"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231573%20Implement%20stack%20limit%20checks%20for%20AArch64/near/194992009" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231573.20Implement.20stack.20limit.20checks.20for.20AArch64.html#194992009">(Apr 22 2020 at 21:12)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1573#pullrequestreview-398593103" title="https://github.com/bytecodealliance/wasmtime/pull/1573#pullrequestreview-398593103">PR Review</a>.</p>



<a name="194992011"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231573%20Implement%20stack%20limit%20checks%20for%20AArch64/near/194992011" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231573.20Implement.20stack.20limit.20checks.20for.20AArch64.html#194992011">(Apr 22 2020 at 21:12)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1573#discussion_r413336445" title="https://github.com/bytecodealliance/wasmtime/pull/1573#discussion_r413336445">PR Review Comment</a>:</p>
<blockquote>
<p>Oh nice, <code>Inst::load_constant</code> works great! While I suspect that &gt;4K offsets aren't really that common it seems easy enough to support, so I've gone ahead and added it in.</p>
</blockquote>



<a name="194992306"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231573%20Implement%20stack%20limit%20checks%20for%20AArch64/near/194992306" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231573.20Implement.20stack.20limit.20checks.20for.20AArch64.html#194992306">(Apr 22 2020 at 21:15)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1573#pullrequestreview-398595124" title="https://github.com/bytecodealliance/wasmtime/pull/1573#pullrequestreview-398595124">PR Review</a>.</p>



<a name="194992307"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231573%20Implement%20stack%20limit%20checks%20for%20AArch64/near/194992307" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231573.20Implement.20stack.20limit.20checks.20for.20AArch64.html#194992307">(Apr 22 2020 at 21:15)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1573#discussion_r413338216" title="https://github.com/bytecodealliance/wasmtime/pull/1573#discussion_r413338216">PR Review Comment</a>:</p>
<blockquote>
<p>So FWIW this is definitely an "unfortunate" special context. This is <a href="https://github.com/bytecodealliance/wasmtime/blob/2f1a2f42256b688620b83e95ff8310fc7ed464c0/cranelift/codegen/src/isa/x86/abi.rs#L825-L858" title="https://github.com/bytecodealliance/wasmtime/blob/2f1a2f42256b688620b83e95ff8310fc7ed464c0/cranelift/codegen/src/isa/x86/abi.rs#L825-L858">"duplicated"</a> with the x86 backend as well. The reason for this is that prologue/epilogue happens so late (way after legalization and even after register allocation) that it's difficult to share code. The hope is that the number of global values we'd need to process wouldn't be that large and/or it'd be easy to extend them over time.</p>
<p>In that sense I suspect that the global value legalization pass is unlikely to go away (it's architecture independent too!). That being said I'm happy to move this code around. Given that do you think it'd still have a better home in <code>lower.rs</code>? </p>
<p>(I can definitely do a better job about documenting all this too)</p>
</blockquote>



<a name="195001119"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231573%20Implement%20stack%20limit%20checks%20for%20AArch64/near/195001119" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231573.20Implement.20stack.20limit.20checks.20for.20AArch64.html#195001119">(Apr 22 2020 at 22:55)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1573#pullrequestreview-398646378" title="https://github.com/bytecodealliance/wasmtime/pull/1573#pullrequestreview-398646378">PR Review</a>.</p>



<a name="195001120"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231573%20Implement%20stack%20limit%20checks%20for%20AArch64/near/195001120" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231573.20Implement.20stack.20limit.20checks.20for.20AArch64.html#195001120">(Apr 22 2020 at 22:55)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/1573#discussion_r413387524" title="https://github.com/bytecodealliance/wasmtime/pull/1573#discussion_r413387524">PR Review Comment</a>:</p>
<blockquote>
<p>Hmm, OK. I still think that we should move this to <code>lower.rs</code>, but other refactoring and cleanup can come later -- don't want to hold this up for it!</p>
</blockquote>



<a name="195234896"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231573%20Implement%20stack%20limit%20checks%20for%20AArch64/near/195234896" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231573.20Implement.20stack.20limit.20checks.20for.20AArch64.html#195234896">(Apr 24 2020 at 19:35)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1573" title="https://github.com/bytecodealliance/wasmtime/pull/1573">PR #1573</a> from <code>aarch64-stack-limit</code> to <code>master</code>:</p>
<blockquote>
<p>This commit implements the stack limit checks in cranelift for the<br>
AArch64 backend. This gets the <code>stack_limit</code> argument purpose as well as<br>
a function's global <code>stack_limit</code> directive working for the AArch64<br>
backend. I've tested this locally on some hardware and in an emulator<br>
and it looks to be working for basic tests, but I've never really done<br>
AArch64 before so some scrutiny on the instructions would be most<br>
welcome!</p>
<p>I also suspect that these stack limit checks aren't quite optimal, but they relatively closely match the x86 backend (which also isn't optimal), so for now I'm largely hoping for correctness as opposed to speed.</p>
<p>Closes #1569</p>
</blockquote>



<a name="195236744"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231573%20Implement%20stack%20limit%20checks%20for%20AArch64/near/195236744" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231573.20Implement.20stack.20limit.20checks.20for.20AArch64.html#195236744">(Apr 24 2020 at 19:51)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1573#pullrequestreview-400227841" title="https://github.com/bytecodealliance/wasmtime/pull/1573#pullrequestreview-400227841">PR Review</a>.</p>



<a name="195236745"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231573%20Implement%20stack%20limit%20checks%20for%20AArch64/near/195236745" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231573.20Implement.20stack.20limit.20checks.20for.20AArch64.html#195236745">(Apr 24 2020 at 19:51)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/1573#discussion_r414823603" title="https://github.com/bytecodealliance/wasmtime/pull/1573#discussion_r414823603">PR Review Comment</a>:</p>
<blockquote>
<p>nit: s/caler/caller/</p>
</blockquote>



<a name="195236746"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231573%20Implement%20stack%20limit%20checks%20for%20AArch64/near/195236746" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231573.20Implement.20stack.20limit.20checks.20for.20AArch64.html#195236746">(Apr 24 2020 at 19:51)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1573#pullrequestreview-400227841" title="https://github.com/bytecodealliance/wasmtime/pull/1573#pullrequestreview-400227841">PR Review</a>.</p>



<a name="195237806"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231573%20Implement%20stack%20limit%20checks%20for%20AArch64/near/195237806" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231573.20Implement.20stack.20limit.20checks.20for.20AArch64.html#195237806">(Apr 24 2020 at 20:01)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1573" title="https://github.com/bytecodealliance/wasmtime/pull/1573">PR #1573</a> from <code>aarch64-stack-limit</code> to <code>master</code>:</p>
<blockquote>
<p>This commit implements the stack limit checks in cranelift for the<br>
AArch64 backend. This gets the <code>stack_limit</code> argument purpose as well as<br>
a function's global <code>stack_limit</code> directive working for the AArch64<br>
backend. I've tested this locally on some hardware and in an emulator<br>
and it looks to be working for basic tests, but I've never really done<br>
AArch64 before so some scrutiny on the instructions would be most<br>
welcome!</p>
<p>I also suspect that these stack limit checks aren't quite optimal, but they relatively closely match the x86 backend (which also isn't optimal), so for now I'm largely hoping for correctness as opposed to speed.</p>
<p>Closes #1569</p>
</blockquote>



<a name="195237815"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231573%20Implement%20stack%20limit%20checks%20for%20AArch64/near/195237815" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231573.20Implement.20stack.20limit.20checks.20for.20AArch64.html#195237815">(Apr 24 2020 at 20:01)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/1573" title="https://github.com/bytecodealliance/wasmtime/pull/1573">PR #1573</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>