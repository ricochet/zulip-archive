<html>
<head><meta charset="utf-8"><title>✔ wasi-libc setjmp.h · wasi · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/index.html">wasi</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/.E2.9C.94.20wasi-libc.20setjmp.2Eh.html">✔ wasi-libc setjmp.h</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="440838863"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/%E2%9C%94%20wasi-libc%20setjmp.h/near/440838863" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Namse <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/.E2.9C.94.20wasi-libc.20setjmp.2Eh.html#440838863">(May 27 2024 at 11:56)</a>:</h4>
<p>Hello, I'm trying to build Skia for Wasi, but I'm encountering a build error related to setjmp. <br>
According to <a href="https://github.com/WebAssembly/exception-handling/issues/179">https://github.com/WebAssembly/exception-handling/issues/179</a>, it seems that most browsers like Chrome, Firefox, and Safari have completed the implementation of exception handling. <br>
Even though it's in Phase 3, since most browsers have completed the implementation, wouldn't it be okay for wasi-libc to provide support for it?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/exception-handling/issues/179" style="background-image: url(&quot;https://uploads.zulipusercontent.net/001fab100d527837cc4e18fc7a6ecb8a0fd9d2fc/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f323631303233333664653432383133666430316332643132366263306466366239623738366430393765303462303266623733366637353835656139633862342f576562417373656d626c792f657863657074696f6e2d68616e646c696e672f6973737565732f313739&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/exception-handling/issues/179" title="Plan for Phase 4 · Issue #179 · WebAssembly/exception-handling">Plan for Phase 4 · Issue #179 · WebAssembly/exception-handling</a></div><div class="message_embed_description">This is a tracking issue for the requirements for Phase 4. The text will be edited as we progress. Checkbox will be checked after the relevant PRs land. We also list Phase 2 &amp; 3 requirements becaus...</div></div></div>



<a name="440840950"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/%E2%9C%94%20wasi-libc%20setjmp.h/near/440840950" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Namse <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/.E2.9C.94.20wasi-libc.20setjmp.2Eh.html#440840950">(May 27 2024 at 12:08)</a>:</h4>
<p>According to <a href="https://github.com/WebAssembly/wasi-libc/pull/483">https://github.com/WebAssembly/wasi-libc/pull/483</a>, it seems that the implementation has been done, and just adding <code>-mllvm</code>, <code>-wasm-enable-sjlj</code>, <code>-lsetjmp</code> should allow the build to succeed... But why am I getting errors like <code>error: use of undeclared identifier 'setjmp'</code>?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/wasi-libc/pull/483" style="background-image: url(&quot;https://uploads.zulipusercontent.net/af39f51b93b0d9b9a695c72006261db500cde784/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613965323335393035643833666266353061343062626162666231366164363233353437373832386565646166323532636464646363343162656433333737352f576562417373656d626c792f776173692d6c6962632f70756c6c2f343833&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/wasi-libc/pull/483" title="Add libsetjmp.a/so by yamt · Pull Request #483 · WebAssembly/wasi-libc">Add libsetjmp.a/so by yamt · Pull Request #483 · WebAssembly/wasi-libc</a></div><div class="message_embed_description">Add setjmp/longjump support based on Wasm EH proposal.
It's provided as a separate library (libsetjmp) from libc so that runtimes w/o EH support can still load libc.so.
To use this setjmp/longjmp i...</div></div></div>



<a name="440842100"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/%E2%9C%94%20wasi-libc%20setjmp.h/near/440842100" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Namse <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/.E2.9C.94.20wasi-libc.20setjmp.2Eh.html#440842100">(May 27 2024 at 12:16)</a>:</h4>
<p>Ah! It was added in wasi-sdk version 22. I've been using version 20 like a fool. Sorry about that, haha.</p>



<a name="440842110"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/%E2%9C%94%20wasi-libc%20setjmp.h/near/440842110" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/.E2.9C.94.20wasi-libc.20setjmp.2Eh.html#440842110">(May 27 2024 at 12:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="724127">Namse</span> has marked this topic as resolved.</p>



<a name="441860870"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/%E2%9C%94%20wasi-libc%20setjmp.h/near/441860870" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> YAMAMOTO Takashi <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/.E2.9C.94.20wasi-libc.20setjmp.2Eh.html#441860870">(Jun 01 2024 at 05:36)</a>:</h4>
<p>you also need latest (unreleased) llvm.</p>



<a name="442009130"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/%E2%9C%94%20wasi-libc%20setjmp.h/near/442009130" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Namse <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/.E2.9C.94.20wasi-libc.20setjmp.2Eh.html#442009130">(Jun 02 2024 at 05:29)</a>:</h4>
<p><span class="user-mention" data-user-id="567999">@YAMAMOTO Takashi</span> Can this feature be added in the next version of wasi-sdk?</p>



<a name="442016125"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/%E2%9C%94%20wasi-libc%20setjmp.h/near/442016125" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> YAMAMOTO Takashi <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/.E2.9C.94.20wasi-libc.20setjmp.2Eh.html#442016125">(Jun 02 2024 at 07:09)</a>:</h4>
<p>when llvm 19 is released and wasi-sdk is updated to include it. probably around this summer i guess.</p>



<a name="442462522"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/%E2%9C%94%20wasi-libc%20setjmp.h/near/442462522" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Namse <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/.E2.9C.94.20wasi-libc.20setjmp.2Eh.html#442462522">(Jun 04 2024 at 07:42)</a>:</h4>
<p><span class="user-mention" data-user-id="567999">@YAMAMOTO Takashi</span>  If I need to directly implement saveSetjmp and testSetjmp in JavaScript for the current latest wasi-sdk environment to run in a browser, what code should I follow to make it work properly?</p>



<a name="442486993"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/%E2%9C%94%20wasi-libc%20setjmp.h/near/442486993" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> YAMAMOTO Takashi <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/.E2.9C.94.20wasi-libc.20setjmp.2Eh.html#442486993">(Jun 04 2024 at 09:42)</a>:</h4>
<p>i'm not sure what you are trying to do.<br>
if you are using wasi-sdk, you can use the implementation in wasi-libc.<br>
emscripten has its own implementation.</p>



<a name="442506332"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/%E2%9C%94%20wasi-libc%20setjmp.h/near/442506332" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Namse <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/.E2.9C.94.20wasi-libc.20setjmp.2Eh.html#442506332">(Jun 04 2024 at 11:26)</a>:</h4>
<p>I also don't really understand it well. I'm using the latest version of wasi-sdk 22, and it seems like there is an implementation of setjmp inside wasi-sdk... Nevertheless, even though I linked the setjmp library, the wasm binary I built wants me to import saveSetjmp. I must have done something wrong?</p>



<a name="442507919"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/%E2%9C%94%20wasi-libc%20setjmp.h/near/442507919" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> YAMAMOTO Takashi <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/.E2.9C.94.20wasi-libc.20setjmp.2Eh.html#442507919">(Jun 04 2024 at 11:35)</a>:</h4>
<p>saveSetjmp is old name used by pre llvm 19, including the one included by wasi-sdk-22.<br>
llvm 19 and later will use names like __wasm_setjmp etc, which is what provided by wasi-libc included by wasi-sdk-22.<br>
if you want to use setjmp today, you can install llvm 19 by yourself and use it to build your app, using wasi-sdk-22 sysroot.</p>



<a name="442543316"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/%E2%9C%94%20wasi-libc%20setjmp.h/near/442543316" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Namse <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/.E2.9C.94.20wasi-libc.20setjmp.2Eh.html#442543316">(Jun 04 2024 at 14:29)</a>:</h4>
<p>Thank you! I built Clang and other tools directly from the latest LLVM git repository, and as a result, WebAssembly no longer requires importing saveSetjmp or testSetjmp.</p>
<p>I thought the saveSetjmp code I implemented was causing the issue, but the problem persists. Strangely, when decoding woff2 fonts using brotli, the ThreadId changes from 2 to 9288807377403942. It works fine on the main thread, but there's always an issue with new threads.</p>
<p>I'll need to investigate further to find out what else might be causing the problem. Thank you!</p>



<a name="442688211"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/%E2%9C%94%20wasi-libc%20setjmp.h/near/442688211" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> YAMAMOTO Takashi <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/.E2.9C.94.20wasi-libc.20setjmp.2Eh.html#442688211">(Jun 05 2024 at 04:00)</a>:</h4>
<p>what ThreadId are you talking about? wasi-threads TID?<br>
anyway, i'm not aware of any threading-related problems with this setjmp/longjmp implementation. (well, unless the app is trying to longjmp to a jmp_buf set up by another thread, which is IIRC a undefined behavior in C/posix.)<br>
if you find the cause, please let me know.</p>



<a name="442761370"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/%E2%9C%94%20wasi-libc%20setjmp.h/near/442761370" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Namse <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/.E2.9C.94.20wasi-libc.20setjmp.2Eh.html#442761370">(Jun 05 2024 at 11:34)</a>:</h4>
<p>I found the solution.<br>
The stack size of wasi target in rust is 4096 bytes, which was too small to run font decoding code..........<br>
<span aria-label="cry" class="emoji emoji-1f622" role="img" title="cry">:cry:</span></p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>