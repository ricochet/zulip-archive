<html>
<head><meta charset="utf-8"><title>Trouble building mruby with wasi-sdk · wasi · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/index.html">wasi</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Trouble.20building.20mruby.20with.20wasi-sdk.html">Trouble building mruby with wasi-sdk</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="252440153"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Trouble%20building%20mruby%20with%20wasi-sdk/near/252440153" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> YAMAMOTO Yuji <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Trouble.20building.20mruby.20with.20wasi-sdk.html#252440153">(Sep 08 2021 at 10:59)</a>:</h4>
<p>I'm trying to build <a href="https://github.com/mruby/mruby">mruby</a> with wasi-sdk. After forking from its ver. 3.0.0, I created a build config to build a minimal version of mruby command with wasi-sdk, then deleted several lines of code depending on  non-WASI APIs. But  I still got an error by <code>wasm-ld</code>: </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">wasm</span><span class="o">-</span><span class="n">ld</span>: <span class="nc">error</span>: <span class="nc">entry</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">defined</span><span class="w"> </span><span class="p">(</span><span class="n">pass</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">entry</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">suppress</span><span class="p">)</span>: <span class="nc">_start</span><span class="w"></span>
</code></pre></div>
<p>Now I'm completely unsure of the cause and how to fix. Does anyone know?<br>
Here is the details:</p>
<ul>
<li>Verbopse build log: <a href="https://github.com/igrep/mruby/blob/3cfdb97f7492eb1089288238eba5481c4da5b597/wasi-build-failure.log">https://github.com/igrep/mruby/blob/3cfdb97f7492eb1089288238eba5481c4da5b597/wasi-build-failure.log</a></li>
<li>The change I added to mruby: <a href="https://github.com/igrep/mruby/commit/bdbc9797d0e88c8ac5c98e023cc41683e04262c3">https://github.com/igrep/mruby/commit/bdbc9797d0e88c8ac5c98e023cc41683e04262c3</a></li>
</ul>
<p>See also: Guide to build mruby <a href="https://github.com/mruby/mruby/blob/3.0.0/doc/guides/compile.md">https://github.com/mruby/mruby/blob/3.0.0/doc/guides/compile.md</a></p>
<p>Thanks in advance.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/mruby/mruby" style="background-image: url(https://opengraph.githubassets.com/9fed213e04d918d97b97f8b4bf2972905b1b74b63b8923c376ec9fc49e63e1cb/mruby/mruby)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/mruby/mruby" title="GitHub - mruby/mruby: Lightweight Ruby">GitHub - mruby/mruby: Lightweight Ruby</a></div><div class="message_embed_description">Lightweight Ruby. Contribute to mruby/mruby development by creating an account on GitHub.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/mruby/mruby/blob/3.0.0/doc/guides/compile.md" style="background-image: url(https://opengraph.githubassets.com/9fed213e04d918d97b97f8b4bf2972905b1b74b63b8923c376ec9fc49e63e1cb/mruby/mruby)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/mruby/mruby/blob/3.0.0/doc/guides/compile.md" title="mruby/compile.md at 3.0.0 · mruby/mruby">mruby/compile.md at 3.0.0 · mruby/mruby</a></div><div class="message_embed_description">Lightweight Ruby. Contribute to mruby/mruby development by creating an account on GitHub.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/igrep/mruby/blob/3cfdb97f7492eb1089288238eba5481c4da5b597/wasi-build-failure.log" style="background-image: url(https://opengraph.githubassets.com/c8f95089687715efca6c18e3db03445f4821e084b03db11ce7229423feac0a41/igrep/mruby)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/igrep/mruby/blob/3cfdb97f7492eb1089288238eba5481c4da5b597/wasi-build-failure.log" title="mruby/wasi-build-failure.log at 3cfdb97f7492eb1089288238eba5481c4da5b597 · igrep/mruby">mruby/wasi-build-failure.log at 3cfdb97f7492eb1089288238eba5481c4da5b597 · igrep/mruby</a></div><div class="message_embed_description">Lightweight Ruby. Contribute to igrep/mruby development by creating an account on GitHub.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/igrep/mruby/commit/bdbc9797d0e88c8ac5c98e023cc41683e04262c3" style="background-image: url(https://opengraph.githubassets.com/7d439e726ec08b2dc6332af87a2acd296ab1715dd9a2fa237669d361d3d529a3/igrep/mruby/commit/bdbc9797d0e88c8ac5c98e023cc41683e04262c3)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/igrep/mruby/commit/bdbc9797d0e88c8ac5c98e023cc41683e04262c3" title="(WIP)(WON'T BUILD) Build mruby as a WASI executable · igrep/mruby@bdbc979">(WIP)(WON'T BUILD) Build mruby as a WASI executable · igrep/mruby@bdbc979</a></div><div class="message_embed_description">Now fails with `wasm-ld: error: entry symbol not defined (pass --no-entry to suppress): _start`</div></div></div>



<a name="252441399"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Trouble%20building%20mruby%20with%20wasi-sdk/near/252441399" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Trouble.20building.20mruby.20with.20wasi-sdk.html#252441399">(Sep 08 2021 at 11:10)</a>:</h4>
<p>You aren't passing wasi-libc and the crt to the linker. Does the mruby build system allow you to use clang as driver instead of directly calling wasm-ld? If so you should likely prefer this. If not you will need to pass <code>-lc</code> and I think <code>#{WASI_SDK_ROOT}/share/wasi-sysroot/lib/wasm32-wasi/crt0.wasm</code> to wasm-ld.</p>



<a name="252441418"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Trouble%20building%20mruby%20with%20wasi-sdk/near/252441418" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Trouble.20building.20mruby.20with.20wasi-sdk.html#252441418">(Sep 08 2021 at 11:10)</a>:</h4>
<p><span class="user-mention" data-user-id="265888">@YAMAMOTO Yuji</span></p>



<a name="252562752"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Trouble%20building%20mruby%20with%20wasi-sdk/near/252562752" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> YAMAMOTO Yuji <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Trouble.20building.20mruby.20with.20wasi-sdk.html#252562752">(Sep 09 2021 at 02:37)</a>:</h4>
<p><span class="user-mention" data-user-id="264278">@bjorn3</span>  Thanks for a quick reply! <a href="https://github.com/igrep/mruby/commit/dfdf23ceddbd4863aa76a4117291eb9dd77a8892">This change after your advice</a> fixed the error.  I've got another errors  which look caused by lack of the exception library. So I'll make up some way to avoid. Thanks again!</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/igrep/mruby/commit/dfdf23ceddbd4863aa76a4117291eb9dd77a8892" style="background-image: url(https://opengraph.githubassets.com/35d3ad3712004f32f62de1750bb2fd3cd633b486951af9f9066092c65c88792b/igrep/mruby/commit/dfdf23ceddbd4863aa76a4117291eb9dd77a8892)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/igrep/mruby/commit/dfdf23ceddbd4863aa76a4117291eb9dd77a8892" title="Correct linker config after advice by bjorn3 at Bytecode Alliance's Z… · igrep/mruby@dfdf23c">Correct linker config after advice by bjorn3 at Bytecode Alliance's Z… · igrep/mruby@dfdf23c</a></div><div class="message_embed_description">…ulip

Building still fails. But thanks!</div></div></div>



<a name="252720394"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Trouble%20building%20mruby%20with%20wasi-sdk/near/252720394" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> YAMAMOTO Yuji <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Trouble.20building.20mruby.20with.20wasi-sdk.html#252720394">(Sep 10 2021 at 01:36)</a>:</h4>
<p><a href="https://github.com/igrep/mruby/commit/62ba6790731874e110c0449b31b8b0a15f7ec428">After  disabling C++ exception with this commit</a>, I got more "undefined symbol" error by wasm-ld:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">wasm</span><span class="o">-</span><span class="n">ld</span>: <span class="nc">error</span>: <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">sdk</span><span class="o">-</span><span class="mf">12.0</span><span class="c1">//share/wasi-sysroot/lib/wasm32-wasi/libc.a(pselect.o): undefined symbol: __muloti4</span>
<span class="n">wasm</span><span class="o">-</span><span class="n">ld</span>: <span class="nc">error</span>: <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">sdk</span><span class="o">-</span><span class="mf">12.0</span><span class="c1">//share/wasi-sysroot/lib/wasm32-wasi/libc.a(intscan.o): undefined symbol: __multi3</span>
</code></pre></div>
<p>How can I tell wasm-ld about those built-in functions such as <code>__multi3</code>?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/igrep/mruby/commit/62ba6790731874e110c0449b31b8b0a15f7ec428" style="background-image: url(https://opengraph.githubassets.com/74d3be6a5fef49b1d3c25f78e5016c79178a891a2c7c3ba0567ad99908c6df06/igrep/mruby/commit/62ba6790731874e110c0449b31b8b0a15f7ec428)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/igrep/mruby/commit/62ba6790731874e110c0449b31b8b0a15f7ec428" title="Use fake setjmp implmentation instead of C++ exception, remove flock · igrep/mruby@62ba679">Use fake setjmp implmentation instead of C++ exception, remove flock · igrep/mruby@62ba679</a></div><div class="message_embed_description">Lightweight Ruby. Contribute to igrep/mruby development by creating an account on GitHub.</div></div></div>



<a name="252722454"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Trouble%20building%20mruby%20with%20wasi-sdk/near/252722454" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> YAMAMOTO Yuji <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Trouble.20building.20mruby.20with.20wasi-sdk.html#252722454">(Sep 10 2021 at 02:09)</a>:</h4>
<p>Ah, I found the way by myself: just to add libclang_rt.builtins-wasm32.<br>
<a href="https://github.com/igrep/mruby/commit/5a791a68e041a2c8f7b018dc33a80d1f0d12c7e7">https://github.com/igrep/mruby/commit/5a791a68e041a2c8f7b018dc33a80d1f0d12c7e7</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/igrep/mruby/commit/5a791a68e041a2c8f7b018dc33a80d1f0d12c7e7" style="background-image: url(https://opengraph.githubassets.com/20f7d6e1831c715161ea2c0935871d56ea45eb9bdd309b867b8e8f339c2e56af/igrep/mruby/commit/5a791a68e041a2c8f7b018dc33a80d1f0d12c7e7)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/igrep/mruby/commit/5a791a68e041a2c8f7b018dc33a80d1f0d12c7e7" title="Fix build error: `undefined symbol: __multi3` · igrep/mruby@5a791a6">Fix build error: `undefined symbol: __multi3` · igrep/mruby@5a791a6</a></div><div class="message_embed_description">Lightweight Ruby. Contribute to igrep/mruby development by creating an account on GitHub.</div></div></div>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>