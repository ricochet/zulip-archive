<html>
<head><meta charset="utf-8"><title>Database connection pooling or pre-warmed connections · wasi · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/index.html">wasi</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html">Database connection pooling or pre-warmed connections</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="469593586"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469593586" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pavel Šavara <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469593586">(Sep 12 2024 at 08:14)</a>:</h4>
<p>Yesterday we discussed with <span class="user-mention" data-user-id="509936">@Joel Dice</span>, <span class="user-mention" data-user-id="234973">@Till Schneidereit</span>  and others that TCP+TLS handshake typically have significant network latency.</p>
<p>That latency is not great fit for hosting model where we want to create application/component instance per incoming request/event.</p>
<p>In dotnet application servers this is solved by <a href="https://learn.microsoft.com/en-us/sql/connect/ado-net/sql-server-connection-pooling">connection pooling.</a>. But that is not compatible with instance per request hosting.</p>
<p>So I wonder if we could have something like network session pooling as WASI interface. It could be implemented by the host or by another component with longer lifecycle.</p>
<p>We are designing <a href="https://github.com/WebAssembly/wasi-sockets/issues/100">TLS stream</a> as a transformer. Without the TCP connection. But I wonder if a wrapper of that together with TCP connection is the right direction? Let's call it "TLS session pooling".</p>
<p>Problems I can see are in security and state management of such session.<br>
The session typically would be authenticated to particular DB user, using password or using private key on TLS layer.<br>
The generic session cache would no way knowing how to make the application level (SQL) handshake, like login, selection of the database schema etc.<br>
So the creation of new session would have to be done inside of the application component ?<br>
Also the application should not release the session back to the pool, unless it's in some base state. For example, no open DB transaction.</p>
<p>Alternatively I can see alternate design, where the Microsoft.Data.SqlClient would long lived WASI component living side by side next to the short lived request handler WASI component.<br>
That would make the whole affair very specific to SQL server and dotnet. We could have bespoke WIT for that.<br>
The benefit would be that the existing code is solving those security/state problems already.<br>
I would call that "SQL server connection pooling component for dotnet".</p>
<p>In any case, it seems to me we could not make it work transparently without WASI specific changes in Microsoft.Data.SqlClient, right ?</p>
<p>I can see that other long lived protocols may have similar problems, if they are implemented in terms of wasi:sockets, rather than by the WASI host. Web Sockets and HTTP/3 come to mind.</p>
<p>So I think it would be good to establish at least some common best practice guidance.</p>
<div class="message_embed"><a class="message_embed_image" href="https://learn.microsoft.com/en-us/sql/connect/ado-net/sql-server-connection-pooling" style="background-image: url(&quot;https://uploads.zulipusercontent.net/3ce17f2b2911dcb735720cc46e75758679339053/68747470733a2f2f6c6561726e2e6d6963726f736f66742e636f6d2f656e2d75732f6d656469612f6f70656e2d67726170682d696d6167652e706e67&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://learn.microsoft.com/en-us/sql/connect/ado-net/sql-server-connection-pooling" title="SQL Server connection pooling - ADO.NET Provider for SQL Server">SQL Server connection pooling - ADO.NET Provider for SQL Server</a></div><div class="message_embed_description">Learn how Microsoft SqlClient Data Provider for SQL Server minimizes the cost of opening connections by using SQL Server connection pooling, which reduces overhead for new connections.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/wasi-sockets/issues/100" style="background-image: url(&quot;https://uploads.zulipusercontent.net/aed9451697747ac7622647bdd7fa0a36a8f4458b/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f373337333861356537333064396666666561316533363436656465373864633666306434323766303833323339313338643030633036633631626134356663632f576562417373656d626c792f776173692d736f636b6574732f6973737565732f313030&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/wasi-sockets/issues/100" title="TLS (Transport Layer Security) · Issue #100 · WebAssembly/wasi-sockets">TLS (Transport Layer Security) · Issue #100 · WebAssembly/wasi-sockets</a></div><div class="message_embed_description">TODO https://github.com/Mbed-TLS/mbedtls https://github.com/enarx-archive/tlssock</div></div></div>



<a name="469631963"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469631963" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469631963">(Sep 12 2024 at 10:42)</a>:</h4>
<p>this is of course a great and difficult conversation. I'd chatted a bit with Till periodically about similar things</p>



<a name="469632049"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469632049" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469632049">(Sep 12 2024 at 10:43)</a>:</h4>
<p>what follows is my take, with which everyone should feel free to disagree.</p>



<a name="469632625"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469632625" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469632625">(Sep 12 2024 at 10:45)</a>:</h4>
<p>I see several variables at play:</p>
<ul>
<li>preview 2 vs preview 3++</li>
<li>lifetime considerations, which are typically related to state held on behalf of the shorter-lifetime subcomponents that import the dep</li>
<li>security concerns related to the fact that within a module, there's no readonly memory, meaning that you <strong>must</strong> use component memory boundaries as a primary mechanism to isolate against hostile calling code</li>
</ul>



<a name="469639427"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469639427" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469639427">(Sep 12 2024 at 11:13)</a>:</h4>
<p>in very short-lived functions, CDN functions for example, you really do not WANT threading because scheduling/orch of external work is not really what the function is for. You want execution and cleanup. In these cases:</p>
<ul>
<li>threading is only for code compilation needs, and not for increased throughput. turning off gc in go, for example.</li>
<li>preview 2 doesn't have stream/processing capabilities yet, so there's a bunch of copying for now (not a huge problem except with big data -- wasi-nn's named model escape hatch is for that reason</li>
<li>no real lifetime considerations unrelated to networking and other things that are dependencies that live longer  than the request processing</li>
</ul>



<a name="469639617"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469639617" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469639617">(Sep 12 2024 at 11:13)</a>:</h4>
<p>and for those kinds of functions, you're very likely to ship one component with everythign in it, as there are only a few functions you're implementing/using.</p>



<a name="469640216"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469640216" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469640216">(Sep 12 2024 at 11:15)</a>:</h4>
<p>for me, these don't cause too much trouble</p>



<a name="469640571"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469640571" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469640571">(Sep 12 2024 at 11:17)</a>:</h4>
<p>what does is the real world in which to achieve high throughput requires the things we do not yet have:threads/streams and so on. it also requires components that hold state (caches or pools) for shorter-lived items that use them -- here, the connection pooling is a great example. So I immediately think of layers of components most of which do basic work we already do in native "servers" or "clients that handle lots of things on behalf of various functions"</p>



<a name="469640834"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469640834" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469640834">(Sep 12 2024 at 11:18)</a>:</h4>
<p>wasi:sockets would be the bottom layer, in this view, and then wasi:tcp and wasi:http. Somewhere at the appropriate layer, wasi:tls would be involved -- it handles that portion of the network handshake.</p>



<a name="469641338"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469641338" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469641338">(Sep 12 2024 at 11:20)</a>:</h4>
<p>so this kind of layering might require additions to wasi:http/tcp and so on to do the tls dancing by calling out to a wasi:tls implementation. in each case, we lean into the security boundary of a component to protect against memory attacks from outside the component (keeping always in mind the lack fo readonly memory).</p>



<a name="469641456"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469641456" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469641456">(Sep 12 2024 at 11:21)</a>:</h4>
<p>one quick note before replying to other parts: <code>wasi:http</code> is very intentionally not specified in terms of <code>wasi:sockets</code>, so that layering picture doesn't reflect how things are actually set up. This is pretty key, because it means that <code>wasi:http</code> isn't restricted to functionality that can be expressed in terms of <code>wasi:sockets</code>, nor does being able to implement <code>wasi:http</code> need to imply also being able to implement <code>wasi:sockets</code> (see browsers as an example of the latter)</p>



<a name="469641504"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469641504" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469641504">(Sep 12 2024 at 11:21)</a>:</h4>
<p>in the usual case, these would all be shipped as a "stack" of components that do the right thing, used by a client that invokes the highest abstraction it's necessary to use.</p>



<a name="469641619"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469641619" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469641619">(Sep 12 2024 at 11:22)</a>:</h4>
<p>I also don't think that we need to change any of this to address the issues Pavel raised</p>



<a name="469641862"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469641862" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469641862">(Sep 12 2024 at 11:22)</a>:</h4>
<p>Pavel, Joel, and I had a chance to talk about this during a meeting yesterday, and my following thoughts are substantially based on that conversation:</p>
<p>I agree with Pavel that establishing a new TCP+TLS connection in terms of <code>wasi:sockets</code> each and every time will be prohibitively costly and inefficient. I don't think that'll change in any meaningful way with WASIp3+, nor do intra-component security considerations change the picture all that much—but I'd like to understand your argument about that better, <span class="user-mention" data-user-id="268586">@Ralph</span></p>



<a name="469642027"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469642027" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469642027">(Sep 12 2024 at 11:23)</a>:</h4>
<p>Till, that's a great point -- and one I love. I'm using a layering metaphor merely to ensure that we take into account the <em>feature</em> of the component boundary for memory and the higher level abstraction that most people should use that means -- like wasi:http -- that you can't just reach down and grab wasi:sockets from guest code.</p>



<a name="469642368"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469642368" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469642368">(Sep 12 2024 at 11:24)</a>:</h4>
<p>I also don't think threads really are involved all that much in this. In dotnet specifically, the connection pool is implemented in terms of threads, but that wouldn't have had to be the case. And to me the instance lifetime issues are the much more substantial concern</p>



<a name="469642551"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469642551" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469642551">(Sep 12 2024 at 11:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="234973">Till Schneidereit</span> <a href="#narrow/stream/219900-wasi/topic/Database.20connection.20pooling/near/469641862">said</a>:</p>
<blockquote>
<p>Pavel, Joel, and I had a chance to talk about this during a meeting yesterday, and my following thoughts are substantially based on that conversation:</p>
<p>I agree with Pavel that establishing a new TCP+TLS connection in terms of <code>wasi:sockets</code> each and every time will be prohibitively costly and inefficient. I don't think that'll change in any meaningful way with WASIp3+, nor do intra-component security considerations change the picture all that much—but I'd like to understand your argument about that better, <span class="user-mention silent" data-user-id="268586">Ralph</span></p>
</blockquote>
<p>Take the abstraction and figure out the path that relieves it. connection pooling is a cache to enable shorter-lived things to NOT do connection creation. and this happens at multiple layers with varying kinds of data. Caches are great things.</p>



<a name="469642556"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469642556" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469642556">(Sep 12 2024 at 11:24)</a>:</h4>
<p>Ah, that makes sense, and I strongly agree!</p>



<a name="469642974"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469642974" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469642974">(Sep 12 2024 at 11:26)</a>:</h4>
<p>(will continue in a bit, have to switch trains)</p>



<a name="469643317"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469643317" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469643317">(Sep 12 2024 at 11:27)</a>:</h4>
<p>so I'm thinking out loud about how you would establish a coherent http/tls story that doesn't just open calls up to everyone. Maybe we need to! But I'd like to think that whatever needs to establish secure connections AND pool them might be their own components that are typically configured together. Yes, the user might code to wasi:sql (for one example) and oracle:sql (for another) but we wouldn't be building either with full access to all the calls involved.</p>



<a name="469643465"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469643465" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469643465">(Sep 12 2024 at 11:28)</a>:</h4>
<p>I happen to love the component memory boundary <em>as a feature</em>, and I look for places to lean in.</p>



<a name="469643908"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469643908" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469643908">(Sep 12 2024 at 11:30)</a>:</h4>
<p>but when we're building the innards of the core protocols, it's possible we can't do it easily -- yet. And this is where the threading/streams comes in. Once you have threads, you can have async scale processing that takes advantage of cores. That means that <code>prohibitively costly and inefficient</code> will become less so. Once you have streams, you can have network filters that can actually approach native speeds (which can't happen with copying that fast).</p>



<a name="469644335"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469644335" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469644335">(Sep 12 2024 at 11:31)</a>:</h4>
<p>a real web server does several layers of caching different things and each one is managed using thread systems. They max out the OS functionality to the very best of their ability. There is no way we could hope to approach that in components until we have similar OS-like capabilities. Maybe even then we don't get close enough! But that's the point I'm trying to make about the difference between p2 and p3+.</p>



<a name="469644541"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469644541" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pavel Šavara <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469644541">(Sep 12 2024 at 11:32)</a>:</h4>
<p>I'm thinking that read-only "caching" of the sessions would be ideal from layering and security perspective. We know how to do that for HTTP. Maybe the host uses keep-alive, but individual HTTP requests are well isolated and long-lived aspect is no business of the application code.</p>
<p>This is not the case with SQL session, you use <code>SET NOCOUNT</code> in your session and now the session is "dirty".</p>



<a name="469644610"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469644610" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469644610">(Sep 12 2024 at 11:32)</a>:</h4>
<p>F5's unitd <em>absolutely screams</em> using wasi:http and it's because it handles all the networking.</p>



<a name="469644966"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469644966" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469644966">(Sep 12 2024 at 11:34)</a>:</h4>
<p>I'll be very interested to hear Till's ideas here when he gets on the next train. But wrt <code>This is not the case with SQL session, you use </code>SET NOCOUNT<code> in your session and now the session is "dirty".</code>, how would you model that abstractly now?</p>



<a name="469645154"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469645154" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469645154">(Sep 12 2024 at 11:34)</a>:</h4>
<p>it sounds like a sql conn is potentially dirty and potentially clean.....</p>



<a name="469645532"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469645532" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469645532">(Sep 12 2024 at 11:35)</a>:</h4>
<p>what are the consequences of a dirtyconn, here? That the conn is long lived and has state floating around but is reused anyway?</p>



<a name="469645797"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469645797" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pavel Šavara <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469645797">(Sep 12 2024 at 11:36)</a>:</h4>
<p>And probably the implementation of the pooling in the <code>Microsoft.Data.SqlClient</code> is able to deal with that already. Modeling it abstractly .. we can't trust the application code to say "i made it dirty" with confidence.</p>



<a name="469645862"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469645862" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469645862">(Sep 12 2024 at 11:36)</a>:</h4>
<p>SHOULD the app code be able to do that? currently, the answer is yes?</p>



<a name="469645935"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469645935" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469645935">(Sep 12 2024 at 11:37)</a>:</h4>
<p>and also, can it change the choice dynamically?</p>



<a name="469645986"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469645986" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Bakker (badeend) <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469645986">(Sep 12 2024 at 11:37)</a>:</h4>
<p>In the case of MSSQL specifically: when the shortlived client exits, the host can <code>sp_reset_connection</code> to "clean up" the session and get it ready for the next client session, right?</p>



<a name="469646191"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469646191" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469646191">(Sep 12 2024 at 11:38)</a>:</h4>
<p>does &lt;3 mean yes?</p>



<a name="469646196"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469646196" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469646196">(Sep 12 2024 at 11:38)</a>:</h4>
<p>:-)</p>



<a name="469646323"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469646323" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pavel Šavara <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469646323">(Sep 12 2024 at 11:39)</a>:</h4>
<p>I means I didn't know about it. And that I love it's there. Is is "clean enough" ? IDK</p>



<a name="469646355"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469646355" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469646355">(Sep 12 2024 at 11:39)</a>:</h4>
<p>guess who gets to make that decision? :-P</p>



<a name="469646480"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469646480" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469646480">(Sep 12 2024 at 11:40)</a>:</h4>
<p>question: does Microsoft.Data.SqlClient only connect to mssql? or can u use it against other dbs?</p>



<a name="469646696"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469646696" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Bakker (badeend) <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469646696">(Sep 12 2024 at 11:41)</a>:</h4>
<p>MSSQL only</p>



<a name="469646730"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469646730" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pavel Šavara <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469646730">(Sep 12 2024 at 11:41)</a>:</h4>
<p>there is dedicated <a href="https://github.com/npgsql/npgsql">https://github.com/npgsql/npgsql</a> for example</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/npgsql/npgsql" style="background-image: url(&quot;https://uploads.zulipusercontent.net/e01152bb0abe8e3ee710c9444fa12a8afa0cc9df/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f623363343663333132633761663637366231666361396163613435383266373836643331393231616633663236653966313435303264366134356261306637322f6e706773716c2f6e706773716c&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/npgsql/npgsql" title="GitHub - npgsql/npgsql: Npgsql is the .NET data provider for PostgreSQL.">GitHub - npgsql/npgsql: Npgsql is the .NET data provider for PostgreSQL.</a></div><div class="message_embed_description">Npgsql is the .NET data provider for PostgreSQL. Contribute to npgsql/npgsql development by creating an account on GitHub.</div></div></div>



<a name="469646870"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469646870" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Bakker (badeend) <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469646870">(Sep 12 2024 at 11:42)</a>:</h4>
<p>But, AFAIK, every major database has its own equivalent of <code>sp_reset_connection</code></p>



<a name="469647003"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469647003" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469647003">(Sep 12 2024 at 11:42)</a>:</h4>
<p>So that's a research point, because something like that will really help this conversation <em>about sql</em></p>



<a name="469647056"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469647056" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Bakker (badeend) <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469647056">(Sep 12 2024 at 11:42)</a>:</h4>
<p>Correct</p>



<a name="469647290"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469647290" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pavel Šavara <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469647290">(Sep 12 2024 at 11:43)</a>:</h4>
<p>does HTTP/3 have such thing ?</p>



<a name="469647348"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469647348" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469647348">(Sep 12 2024 at 11:43)</a>:</h4>
<p>http/3 is wild, imho</p>



<a name="469647723"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469647723" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469647723">(Sep 12 2024 at 11:44)</a>:</h4>
<p>that one requires thought. I still think the focus on lifetimes of things doing dependent caching for layers above is the thing that pops the design free</p>



<a name="469647893"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469647893" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469647893">(Sep 12 2024 at 11:45)</a>:</h4>
<p>you can handle varying lifetimes in the same component, but without internal threading that's going to bog down</p>



<a name="469648010"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469648010" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469648010">(Sep 12 2024 at 11:46)</a>:</h4>
<p>but kept separate, you have more possibilities and are likely leaning into the component memory boundary <em>feature</em></p>



<a name="469648063"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469648063" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469648063">(Sep 12 2024 at 11:46)</a>:</h4>
<p>that's my take -- you all are much more intelligent than me here</p>



<a name="469648082"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469648082" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Bakker (badeend) <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469648082">(Sep 12 2024 at 11:46)</a>:</h4>
<p>I don't see what threads have to with this, though. The real issue to me seems to be: how to compose components with varying instance lifetimes.<br>
E.g. in this case there should be a SQL "driver"/"service" instance with a longer lifetime than any of its short-lived consumers. _Without_ having to special case everything as special wasmtime/host behavior</p>



<a name="469648297"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469648297" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469648297">(Sep 12 2024 at 11:47)</a>:</h4>
<p>What I'm saying is that <em>currently</em> if you wanna do pooling, your pool is going to want to scale out and that's done using async/threads.</p>



<a name="469648450"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469648450" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469648450">(Sep 12 2024 at 11:48)</a>:</h4>
<p>if you wanted a wasi:connectionpooling impl, you're either going to have everythign be a component inside or youu're going to use async/threads inside <em>because that's something you already know how to do</em></p>



<a name="469648468"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469648468" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Bakker (badeend) <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469648468">(Sep 12 2024 at 11:48)</a>:</h4>
<p>Right, in the current world, you'd need to set up one long-lived component instance that handles _all_ requests.</p>



<a name="469648645"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469648645" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pavel Šavara <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469648645">(Sep 12 2024 at 11:49)</a>:</h4>
<p>because you can't create pollable in guest, right ?</p>



<a name="469648990"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469648990" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469648990">(Sep 12 2024 at 11:50)</a>:</h4>
<p>now, <span class="user-mention" data-user-id="378155">@Dave Bakker (badeend)</span> you're right in your focus on "compose components with varying lifetimes". Right now, using wasi:http, we don't use threads to go fast! in fact, threads get in the way. The question becomes more important once "people" want to build a connectionpooling component. They can do it using subcomponents as shorterlived items that the outercomponents manages. it's essentially a very small "serverless" approach to avoid threads.</p>



<a name="469649001"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469649001" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469649001">(Sep 12 2024 at 11:50)</a>:</h4>
<p>well, I had written a long thing, which didn't go through because WIFI on trains, and now Zulip reloaded and (properly: correctly) decided that all of that was too poorly worded to retain</p>



<a name="469649075"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469649075" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469649075">(Sep 12 2024 at 11:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="234973">Till Schneidereit</span> <a href="#narrow/stream/219900-wasi/topic/Database.20connection.20pooling/near/469649001">said</a>:</p>
<blockquote>
<p>well, I had written a long thing, which didn't go through because WIFI on trains, and now Zulip reloaded and (properly: correctly) decided that all of that was too poorly worded to retain</p>
</blockquote>
<p>NEVER, TILL, NEVER!!!!!</p>



<a name="469649230"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469649230" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469649230">(Sep 12 2024 at 11:51)</a>:</h4>
<p>in centralized services, you're always going to be handling the really large scale, long lived stuff <em>outside the guest function</em></p>



<a name="469649322"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469649322" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469649322">(Sep 12 2024 at 11:52)</a>:</h4>
<p>you don't need a "host component" for that, even if you could do it.</p>



<a name="469649338"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469649338" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469649338">(Sep 12 2024 at 11:52)</a>:</h4>
<p>too kind, too kind</p>



<a name="469649434"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469649434" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Bakker (badeend) <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469649434">(Sep 12 2024 at 11:52)</a>:</h4>
<blockquote>
<p>because you can't create pollable in guest, right ?</p>
</blockquote>
<p>It Depends™. There exists a conversation somewhere on this Zulip with much more background on that. But the TLDR is somewehre on the spectrum between: "No" and "Yes, but it will be a lot of work"</p>



<a name="469649583"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469649583" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469649583">(Sep 12 2024 at 11:53)</a>:</h4>
<p>but I'm thinking again of the hardware gateway that won't be updated for years and for which someone might want the entire webserver in a component.</p>



<a name="469649619"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469649619" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469649619">(Sep 12 2024 at 11:53)</a>:</h4>
<p>anyway, I propose we set threading aside, because I think we can fully assume that we want to have a way to do pooling without requiring (very) long-lived instances</p>



<a name="469649763"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469649763" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469649763">(Sep 12 2024 at 11:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="234973">Till Schneidereit</span> <a href="#narrow/stream/219900-wasi/topic/Database.20connection.20pooling/near/469649619">said</a>:</p>
<blockquote>
<p>anyway, I propose we set threading aside, because I think we can fully assume that we want to have a way to do pooling without requiring (very) long-lived instances</p>
</blockquote>
<p>agreed, officially set that aside, back to sql conn pooling/dirty/clean</p>



<a name="469651703"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469651703" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Bakker (badeend) <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469651703">(Sep 12 2024 at 12:02)</a>:</h4>
<p>While the "dirty/clean" aspect is an important prerequisite for connection sharing to work, its not really of importance to the WASI/WIT/Components discussion. Either the underlying protocol supports it (HTTP, SQL, ..) and can be implemented by an implementation-specific "driver". Or: the protocol doesn't support it, in which case there's also no need to think about it any further here :P</p>



<a name="469651775"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469651775" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469651775">(Sep 12 2024 at 12:02)</a>:</h4>
<p>Great job! our work is done. :-)</p>



<a name="469651898"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469651898" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Bakker (badeend) <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469651898">(Sep 12 2024 at 12:02)</a>:</h4>
<p>Nice, let's take the rest of the day off <span aria-label="palm tree" class="emoji emoji-1f334" role="img" title="palm tree">:palm_tree:</span></p>



<a name="469651939"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469651939" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469651939">(Sep 12 2024 at 12:03)</a>:</h4>
<p><em>already drinking</em></p>



<a name="469651963"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469651963" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469651963">(Sep 12 2024 at 12:03)</a>:</h4>
<p>exactly! (And I now have proof that Zulip was correct in eating my homework: that's much more concise than what I had)</p>



<a name="469652846"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469652846" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469652846">(Sep 12 2024 at 12:05)</a>:</h4>
<p>What I'm imagining as a minimum client connection pooling API for <code>wasi:tls</code> would be roughly this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">interface</span><span class="w"> </span><span class="n">client</span><span class="o">-</span><span class="n">connection</span><span class="o">-</span><span class="n">pool</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">put</span><span class="p">(</span><span class="n">connection</span><span class="p">:</span><span class="w"> </span><span class="nc">client</span><span class="o">-</span><span class="n">connection</span><span class="p">,</span><span class="w"> </span><span class="n">identities</span><span class="p">:</span><span class="w"> </span><span class="nc">option</span><span class="o">&lt;</span><span class="n">list</span><span class="o">&lt;</span><span class="n">borrow</span><span class="o">&lt;</span><span class="n">private</span><span class="o">-</span><span class="n">identity</span><span class="o">&gt;&gt;&gt;</span><span class="p">);</span>
<span class="w">    </span><span class="n">get</span><span class="p">(</span><span class="n">identities</span><span class="p">:</span><span class="w"> </span><span class="nc">option</span><span class="o">&lt;</span><span class="n">list</span><span class="o">&lt;</span><span class="n">borrow</span><span class="o">&lt;</span><span class="n">private</span><span class="o">-</span><span class="n">identity</span><span class="o">&gt;&gt;&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">option</span><span class="o">&lt;</span><span class="n">result</span><span class="o">&lt;</span><span class="n">client</span><span class="o">-</span><span class="n">connection</span><span class="o">&gt;&gt;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>The idea being that for connections that make use of client certificates, you must prove that you'd be able to create a new connection with the same certificate, otherwise you shouldn't get to reuse an existing one.</p>



<a name="469652904"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469652904" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469652904">(Sep 12 2024 at 12:05)</a>:</h4>
<p>I guess it'd make sense to add a few things such as optional TTL setting and such</p>



<a name="469653016"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469653016" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469653016">(Sep 12 2024 at 12:06)</a>:</h4>
<p>Zulip has weird opinions on how to highlight <code>.wit</code></p>



<a name="469653175"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469653175" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469653175">(Sep 12 2024 at 12:07)</a>:</h4>
<p><span class="user-mention" data-user-id="378155">@Dave Bakker (badeend)</span> do you see any reason why we wouldn't be able to implement this kind of pool?</p>



<a name="469653235"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469653235" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469653235">(Sep 12 2024 at 12:07)</a>:</h4>
<p>oh also, I think it'd make sense to have the same kind of pool for non-TLS socket connections</p>



<a name="469653985"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469653985" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Bakker (badeend) <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469653985">(Sep 12 2024 at 12:10)</a>:</h4>
<p>Hmm. I'd have to think about it more.<br>
My initial reaction is that TCP/TLS sockets is the wrong abstraction level (too low) to provide a pool for. As Resetting a connection requires higher-level knowledge on how to do that. (e.g. the <code>sp_reset_connection</code> example from above)</p>



<a name="469654645"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469654645" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469654645">(Sep 12 2024 at 12:13)</a>:</h4>
<p>my thinking is that, outside of a hypothetical <code>wasi:mssql</code>, it should be up to the component to ensure that the connection is ready for reuse. Yes, that does mean that there's a risk of improperly reusing a connection, but that seems pretty fundamental to me (again, outside of higher-level interfaces)</p>



<a name="469656058"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469656058" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469656058">(Sep 12 2024 at 12:18)</a>:</h4>
<p>i think that's the proper responsibility of the component, absolutely.</p>



<a name="469656843"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469656843" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Bakker (badeend) <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469656843">(Sep 12 2024 at 12:21)</a>:</h4>
<p>Maybe, that can only work <em>if</em> the components are cooperating and can 100% trust each other.</p>



<a name="469657094"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469657094" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469657094">(Sep 12 2024 at 12:22)</a>:</h4>
<p>I would imagine that the most common scenario is for this pool to be implemented by the host</p>



<a name="469657293"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469657293" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469657293">(Sep 12 2024 at 12:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="234973">Till Schneidereit</span> <a href="#narrow/stream/219900-wasi/topic/Database.20connection.20pooling/near/469657094">said</a>:</p>
<blockquote>
<p>I would imagine that the most common scenario is for this pool to be implemented by the host</p>
</blockquote>
<p>most commonly yes, but in the future a long lived client component could want to pool a large number of calls as well. But first things first.</p>



<a name="469658335"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469658335" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Bakker (badeend) <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469658335">(Sep 12 2024 at 12:26)</a>:</h4>
<blockquote>
<p>would imagine that the most common scenario is for this pool to be implemented by the host</p>
</blockquote>
<p>Ok. My comment was targeted at:</p>
<blockquote>
<p>it should be up to the component to ensure that the connection is ready for reuse.</p>
</blockquote>



<a name="469658374"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469658374" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469658374">(Sep 12 2024 at 12:27)</a>:</h4>
<p>true, yes. But in that case it seems like you're fundamentally trusting the pooling component to give you back a connection with the same state that you'd have put it in, and conversely the pooling component fundamentally trusts its clients to properly clean up connections before putting them into the pool</p>



<a name="469658652"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469658652" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469658652">(Sep 12 2024 at 12:28)</a>:</h4>
<p>yes, this must be the case. the pooling component is an inner component of the ultimate used connection manager. Does that make any sense?</p>



<a name="469658770"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469658770" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469658770">(Sep 12 2024 at 12:28)</a>:</h4>
<p>ah, that gets to another thing Pavel and I talked about yesterday: ideally the pooling mechanism would be client-isolated. I.e., you'd not share a pool with other client components, so you get to rely on the exact set of properties you ensure for pooled connections</p>



<a name="469658872"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469658872" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469658872">(Sep 12 2024 at 12:29)</a>:</h4>
<p>and certainly one would never ever ever share a pool across tenants</p>



<a name="469658898"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469658898" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469658898">(Sep 12 2024 at 12:29)</a>:</h4>
<p>like, boooooooooooo</p>



<a name="469658900"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469658900" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Bakker (badeend) <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469658900">(Sep 12 2024 at 12:29)</a>:</h4>
<p>Makes sense</p>



<a name="469659303"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469659303" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469659303">(Sep 12 2024 at 12:30)</a>:</h4>
<p>I think for component composition scenarios that'd largely Just Happen, but we'd absolutely want to specify this as part of the semantics</p>



<a name="469659470"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469659470" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469659470">(Sep 12 2024 at 12:31)</a>:</h4>
<p>(then again, we don't even have the spec mechanisms for composing components with differing lifetimes, so who knows whether it'd still Just Happen once we have those)</p>



<a name="469659929"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469659929" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469659929">(Sep 12 2024 at 12:33)</a>:</h4>
<p>that's interesting: I was unaware we hadn't fleshed out what happens with different lifetimes. hmmmm. Or are you just saying we don't have the language to describe that?</p>



<a name="469660399"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469660399" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Bakker (badeend) <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469660399">(Sep 12 2024 at 12:34)</a>:</h4>
<blockquote>
<p>it seems like you're fundamentally trusting the pooling component to give you back a connection with the same state that you'd have put it in, and conversely the pooling component fundamentally trusts its clients to properly clean up connections before putting them into the pool</p>
</blockquote>
<p>Right. And that's exactly why I'm doubting this solution path. Ideally, a component shouldn't have to worry about pooling at all and would be able to just say "give me a SQL[1] connection, I'll drop it when I'm done". And let the pooling component figure out how to reset &amp; resuse the connection.</p>
<p>[1] (mentally replace "SQL" with your favorite protocol in your head)</p>



<a name="469660699"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469660699" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469660699">(Sep 12 2024 at 12:35)</a>:</h4>
<p>yes, but that's the ultimate guest code's position!</p>



<a name="469660780"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469660780" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469660780">(Sep 12 2024 at 12:36)</a>:</h4>
<p>what we're discussing here is the underlying imple components that actually do that work, right?</p>



<a name="469661083"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469661083" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469661083">(Sep 12 2024 at 12:37)</a>:</h4>
<p>Ralph the PM writing code to call a db should just say, "give me a connection, I'll drop it when I'm done"</p>



<a name="469661175"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469661175" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469661175">(Sep 12 2024 at 12:37)</a>:</h4>
<p>but something underneath that interface has to do the work of managing a pool, and underneath that actually implement the pool</p>



<a name="469661230"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469661230" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469661230">(Sep 12 2024 at 12:37)</a>:</h4>
<p>it could be the same component, of course.</p>



<a name="469661314"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469661314" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469661314">(Sep 12 2024 at 12:38)</a>:</h4>
<p>one big wasi:msssql</p>



<a name="469661320"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469661320" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469661320">(Sep 12 2024 at 12:38)</a>:</h4>
<p>for exzample</p>



<a name="469661321"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469661321" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pavel Šavara <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469661321">(Sep 12 2024 at 12:38)</a>:</h4>
<p>I realized when reading we are possibly dealing with <code>MSDTC</code>because of "transaction context"</p>
<p>That document about connection pooling I linked above is good read. It mentions </p>
<ul>
<li>"Each connection pool is associated with a distinct connection string." </li>
<li>"Pool fragmentation due to integrated security" and "Pool fragmentation due to many databases"</li>
</ul>



<a name="469661402"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469661402" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469661402">(Sep 12 2024 at 12:38)</a>:</h4>
<p>oh, transactions, fun</p>



<a name="469661440"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469661440" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469661440">(Sep 12 2024 at 12:38)</a>:</h4>
<p><span class="user-mention" data-user-id="378155">@Dave Bakker (badeend)</span> absolutely. But that seems to fundamentally require specific interfaces such as <code>wasi:mssql</code>, no?</p>
<p>The only really alternative way to set up pooling without abstracting all the connection handling completely would involve an interface with setup and teardown/cleanup hooks, where you'd say "give me a connection, and if you need to set it up, call this function, and if you need to reset it, call this one". But I don't think that'd address your concerns at all, because you'd still have to trust that the reset is done correctly</p>



<a name="469661787"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469661787" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469661787">(Sep 12 2024 at 12:40)</a>:</h4>
<p>I mean, just fundamentally something has to do the setup/reset/teardown. And I think we should provide an interface that lets that "something" be the client component. Which then allows us to implement things like a pooling <code>wasi:mssql</code> in user space</p>



<a name="469662187"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469662187" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469662187">(Sep 12 2024 at 12:42)</a>:</h4>
<p>one important aspect here is that we've learned the hard way that even if we wanted to (and could) provide all the high-level interfaces, it'd not be enough: we'd not just have to provide all these interfaces, we'd also have to convince the world to change All The Code to make use of these interfaces instead of the implementations they already have in terms of a lower-level thing</p>



<a name="469662313"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469662313" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469662313">(Sep 12 2024 at 12:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="234973">Till Schneidereit</span> <a href="#narrow/stream/219900-wasi/topic/Database.20connection.20pooling/near/469662187">said</a>:</p>
<blockquote>
<p>one important aspect here is that we've learned the hard way that even if we wanted to (and could) provide all the high-level interfaces, it'd not be enough: we'd not just have to provide all these interfaces, we'd also have to convince the world to change All The Code to make use of these interfaces instead of the implementations they already have in terms of a lower-level thing</p>
</blockquote>
<p>this is the largest problem we face.</p>



<a name="469662332"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469662332" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469662332">(Sep 12 2024 at 12:43)</a>:</h4>
<p>well said</p>



<a name="469662344"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469662344" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469662344">(Sep 12 2024 at 12:43)</a>:</h4>
<p>that's not to say the high-level interfaces aren't a good thing: where possible and where people are asking for them, we should provide them. But we shouldn't force them on people</p>



<a name="469662459"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469662459" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469662459">(Sep 12 2024 at 12:43)</a>:</h4>
<p>the higher level and different interfaces will become popular if they hit the sweet spot for users. that is the only path they have. it may well take time for a lot of them.</p>



<a name="469662767"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469662767" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469662767">(Sep 12 2024 at 12:44)</a>:</h4>
<p>(yes, I'm one of the people who had to learn this the hard way. See also: <code>wasi:grpc</code> requiring substantially more work in the spec, host implementations, and all language ecosystems than extending <code>wasi:http</code> to support gRPC)</p>



<a name="469663552"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469663552" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469663552">(Sep 12 2024 at 12:46)</a>:</h4>
<p>it <em>will be better having wasi:grpc</em>! But man, that will take time for adoption.</p>



<a name="469663631"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469663631" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469663631">(Sep 12 2024 at 12:46)</a>:</h4>
<p>yes to both!</p>



<a name="469663672"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469663672" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469663672">(Sep 12 2024 at 12:47)</a>:</h4>
<p>at a minimum, the best higher level abstractions will take 3-5 years before they hit the sweet spot. It seems like a long time, but it really isn't.</p>



<a name="469663752"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469663752" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469663752">(Sep 12 2024 at 12:47)</a>:</h4>
<p>but, I guess the optimistic look at this is that <em>we need time to make those all happen anyway</em></p>



<a name="469663761"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469663761" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469663761">(Sep 12 2024 at 12:47)</a>:</h4>
<p>????????</p>



<a name="469663904"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469663904" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469663904">(Sep 12 2024 at 12:48)</a>:</h4>
<p>I think we got it right by-and-large with <code>wasi:http</code>, and I still believe in the fundamental approach to WASI (and WIT more generally) API design of "as high-level as feasible, but no higher". My thinking on the "feasible" bit has evolved a bit</p>



<a name="469664009"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469664009" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469664009">(Sep 12 2024 at 12:48)</a>:</h4>
<p>yes. I have a feeling that "new" interfaces will have more adoption than "why did you screw up tcp?"</p>



<a name="469664229"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469664229" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469664229">(Sep 12 2024 at 12:49)</a>:</h4>
<p>my hope is also that as we see things like component-based middleware, db connectors, etc, all of this will matter less and less, because we'll have much tighter pinch-points</p>



<a name="469664449"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469664449" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469664449">(Sep 12 2024 at 12:50)</a>:</h4>
<p>it's going to happen</p>



<a name="469664483"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469664483" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469664483">(Sep 12 2024 at 12:50)</a>:</h4>
<p><span class="user-mention" data-user-id="378155">@Dave Bakker (badeend)</span> how do you feel about TLS connection pooling after all this discussion?</p>



<a name="469667005"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469667005" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pavel Šavara <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469667005">(Sep 12 2024 at 13:00)</a>:</h4>
<p>I think that single-use/throw-away pre-opened anonymous TLS sessions would reduce necessary latency on of the application code. And be generic and secure. It would not bring the scalability. But maybe that good enough for MVP ?</p>



<a name="469667059"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469667059" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469667059">(Sep 12 2024 at 13:01)</a>:</h4>
<p>absolutely it would</p>



<a name="469667102"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469667102" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469667102">(Sep 12 2024 at 13:01)</a>:</h4>
<p>imho, that is.</p>



<a name="469668616"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469668616" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469668616">(Sep 12 2024 at 13:06)</a>:</h4>
<p>so you're thinking of something that'd reduce <a href="https://github.com/badeend/wasi-sockets/blob/tls/TLS.md#minimal-client">this example</a> to something like this?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// TCP setup:</span>
<span class="kd">let</span><span class="p">(</span><span class="n">tls_input</span><span class="p">,</span><span class="w"> </span><span class="n">tls_output</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasi_tls</span><span class="p">::</span><span class="n">connect</span><span class="p">(</span><span class="s">"example.com"</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="c1">// Usage:</span>
<span class="n">tls_output</span><span class="p">.</span><span class="n">blocking_write_and_flush</span><span class="p">(</span><span class="s">"GET / HTTP/1.1</span><span class="se">\r\n</span><span class="s">Host: example.com</span><span class="se">\r\n\r\n</span><span class="s">"</span><span class="p">);</span>
<span class="kd">let</span><span class="w"> </span><span class="n">http_response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tls_input</span><span class="p">.</span><span class="n">blocking_read</span><span class="p">();</span>

<span class="fm">println!</span><span class="p">(</span><span class="n">http_response</span><span class="p">);</span>
</code></pre></div>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/badeend/wasi-sockets/blob/tls/TLS.md#minimal-client" style="background-image: url(&quot;https://uploads.zulipusercontent.net/ae9246f3f632810949047d8ada7b6773d60beb88/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f616436623835353466633461393933366234386166653530373937373436383266323861373364653332616337643030353732643136666164656337663039612f62616465656e642f776173692d736f636b657473&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/badeend/wasi-sockets/blob/tls/TLS.md#minimal-client" title="wasi-sockets/TLS.md at tls · badeend/wasi-sockets">wasi-sockets/TLS.md at tls · badeend/wasi-sockets</a></div><div class="message_embed_description">WASI API proposal for managing sockets. Contribute to badeend/wasi-sockets development by creating an account on GitHub.</div></div></div>



<a name="469669049"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469669049" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469669049">(Sep 12 2024 at 13:07)</a>:</h4>
<p>Could we encourage pool-per-client by defining a standard resource but <em>not</em> a standard interface? Consumers would need to define how the pool is exposed but it would take deliberate effort to share between components.<br>
<em>edit: actually I'm not sure bindgen produces the same type for a resource in different interfaces, so maybe not all that useful</em></p>



<a name="469669164"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469669164" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469669164">(Sep 12 2024 at 13:07)</a>:</h4>
<p>(i.e., let the import handle the DNS lookup, socket connection, and TLS handshake, so that that can all happen concurrently and preemptively)</p>



<a name="469669392"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469669392" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pavel Šavara <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469669392">(Sep 12 2024 at 13:08)</a>:</h4>
<p>Now I'm thinking how to make that transparent to existing C# Socket &amp; SslStream APIs</p>



<a name="469669539"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469669539" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469669539">(Sep 12 2024 at 13:09)</a>:</h4>
<p>yeah, I think we're in the same space of difficult-to-adopt abstractions</p>



<a name="469670551"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469670551" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469670551">(Sep 12 2024 at 13:12)</a>:</h4>
<p><span class="user-mention" data-user-id="480579">@Lann Martin</span> you'd ultimately still import an interface that would provide a function for acquiring the pool resource handle though, right? so it'd still be the most straightforward thing to always return the same handle</p>



<a name="469670710"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469670710" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pavel Šavara <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469670710">(Sep 12 2024 at 13:12)</a>:</h4>
<p>the host could just hand out unbound handle/resource when wasi:sockets:connect and if that is followed by call to TLS transform, it could take it from different pool.</p>



<a name="469670735"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469670735" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469670735">(Sep 12 2024 at 13:12)</a>:</h4>
<p>The problem is that it is <em>disastrous</em> to share a TLS connection pool with an untrusted component</p>



<a name="469670745"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469670745" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469670745">(Sep 12 2024 at 13:12)</a>:</h4>
<p>but I just remember that there were sketches somewhere about shared and non-shared instance imports. We'd want a non-shared instance import here, I think</p>



<a name="469670862"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469670862" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469670862">(Sep 12 2024 at 13:13)</a>:</h4>
<p>indeed, yes</p>



<a name="469670995"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469670995" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469670995">(Sep 12 2024 at 13:13)</a>:</h4>
<p>but much in the same way as sharing an <code>outgoing-handler</code>, right?</p>



<a name="469671106"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469671106" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469671106">(Sep 12 2024 at 13:14)</a>:</h4>
<p>an "optimistic pre-fetching pool" (or whatever you want to call the pre-warmed connection approach) definitely seems like the best bang-for-buck</p>



<a name="469671244"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469671244" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469671244">(Sep 12 2024 at 13:14)</a>:</h4>
<p>i.e., to the degree we have this issue for connection pools, we also have it for anything that can establish outgoing connections</p>



<a name="469671295"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469671295" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469671295">(Sep 12 2024 at 13:14)</a>:</h4>
<blockquote>
<p>but much in the same way as sharing an <code>outgoing-handler</code>, right?</p>
</blockquote>
<p>Not really. HTTP is pretty rigorously stateless</p>



<a name="469671652"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469671652" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pavel Šavara <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469671652">(Sep 12 2024 at 13:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="480579">Lann Martin</span> <a href="#narrow/stream/219900-wasi/topic/Database.20connection.20pooling/near/469670735">said</a>:</p>
<blockquote>
<p>The problem is that it is <em>disastrous</em> to share a TLS connection pool with an untrusted component</p>
</blockquote>
<p>Those would be throw away, after the end of life of that resource. The host would consider it dirty and actually close the real connection. Is that not enough ?</p>



<a name="469671770"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469671770" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469671770">(Sep 12 2024 at 13:16)</a>:</h4>
<p>what I mean is that a specific <code>outgoing-handler</code> provides specific capabilities, at least as long as the exporter applies some kind of restrictions to where requests can be sent to</p>



<a name="469671967"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469671967" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469671967">(Sep 12 2024 at 13:16)</a>:</h4>
<p><span class="user-mention" data-user-id="471788">@Pavel Šavara</span> Yeah sorry; we should call the "pre-warmed connections" idea something other than "pooling". I like that idea.</p>



<a name="469672044"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469672044" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469672044">(Sep 12 2024 at 13:16)</a>:</h4>
<p>a naive userspace implementation of <code>outgoing-handler</code> in a persistent instance would share its allowlist with all importers</p>



<a name="469672223"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469672223" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469672223">(Sep 12 2024 at 13:17)</a>:</h4>
<p>same as a naive userspace implementation of a connection pool would share the pool with all importers</p>



<a name="469674522"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469674522" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469674522">(Sep 12 2024 at 13:24)</a>:</h4>
<p>I guess I'm just thinking of the obvious "allow all" case for both http and a tls pool. For HTTP, a reused connection has pretty well understood state(lessness), assuming the implementation doesn't allow returning e.g. websockets to the pool. A TLS socket pool has too much flexibility here; e.g. a malicious component could set up an HTTP proxy on a socket and then put it in the pool masquerading as a "normal" HTTPS connection to the proxy host.</p>



<a name="469676414"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469676414" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469676414">(Sep 12 2024 at 13:29)</a>:</h4>
<p>I agree that that is a very bad scenario. It seems to me like it's ultimately one example of the more fundamental issue that the moment you allow yourself to be imported by multiple components you'd better ensure that you retain the right level of isolation between the state you provide them with</p>



<a name="469676482"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469676482" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Bakker (badeend) <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469676482">(Sep 12 2024 at 13:29)</a>:</h4>
<p>What are the <em>actual</em> real-world use cases we're thinking of here, other than HTTP &amp; SQL?</p>



<a name="469676671"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469676671" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469676671">(Sep 12 2024 at 13:29)</a>:</h4>
<p>other databases, e.g. Redis, Mongo, etc.</p>



<a name="469676780"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469676780" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469676780">(Sep 12 2024 at 13:30)</a>:</h4>
<p>MQTT</p>



<a name="469676937"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469676937" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469676937">(Sep 12 2024 at 13:30)</a>:</h4>
<p>I guess any protocols on top of TCP or UDP?</p>



<a name="469677214"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469677214" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469677214">(Sep 12 2024 at 13:31)</a>:</h4>
<p>where not all of them are actual real-world use cases, but there are enough that I think it makes sense for us to treat them as unbounded</p>



<a name="469678221"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469678221" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469678221">(Sep 12 2024 at 13:35)</a>:</h4>
<blockquote>
<p>malicious component</p>
</blockquote>
<p>There's a continuum of "how much I trust the other component" from "I don't trust it at all" (in which case I probably shouldn't be using it) to "I wrote it myself and trust it completely, and I have other reasons besides security to make it a separate component" (e.g. different lifetimes, different languages, etc.).</p>



<a name="469678472"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469678472" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469678472">(Sep 12 2024 at 13:36)</a>:</h4>
<p><span class="user-mention" data-user-id="480579">@Lann Martin</span> the more I think about it, the more I really don't think connection pools are special. Fundamentally, a very reasonable approximation is Thou Shalt Not Mix Capabilities.</p>
<p>I do think this poses very interesting problems for composition between long- and short-lived things, which I think we've only gotten away with ignoring so far because existing systems manage capabilities in the host pretty exclusively</p>



<a name="469678635"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469678635" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469678635">(Sep 12 2024 at 13:37)</a>:</h4>
<p>as in, I don't even know if we'd have a mechanism by which a component that'd be imported by two other components would be able to tell apart which of those a call originated in</p>



<a name="469678937"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469678937" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469678937">(Sep 12 2024 at 13:38)</a>:</h4>
<p>This is what unforgeable resources are for right? <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="469679003"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469679003" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469679003">(Sep 12 2024 at 13:38)</a>:</h4>
<p>yeah, I just realize that's not the right question</p>



<a name="469679133"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469679133" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469679133">(Sep 12 2024 at 13:39)</a>:</h4>
<p>better question: how do you ensure that a component importing you should get access to the same resource a previous instance of the same component definition did?</p>



<a name="469679779"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469679779" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469679779">(Sep 12 2024 at 13:41)</a>:</h4>
<p>Say I have a single, long-lived, component <code>Pool</code>, imported by an arbitrary series of instances of both <code>A</code> and <code>B</code>. How can I tell calls from instances of <code>A</code> apart from those of instances of <code>B</code>, so I can establish isolated caches for each of the component definitions?</p>



<a name="469680106"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469680106" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Bakker (badeend) <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469680106">(Sep 12 2024 at 13:42)</a>:</h4>
<blockquote>
<p>one important aspect here is that we've learned the hard way that even if we wanted to (and could) provide all the high-level interfaces, it'd not be enough: we'd not just have to provide all these interfaces, we'd also have to convince the world to change All The Code to make use of these interfaces instead of the implementations they already have in terms of a lower-level thing</p>
</blockquote>
<p>Everything discussed so far isn't POSIX (obviously), so "All The Code" will need to change anyway in some form or another. Right?</p>



<a name="469680358"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469680358" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469680358">(Sep 12 2024 at 13:43)</a>:</h4>
<p>One possible answer could be "you don't, because that's not a setup you get to have". Instead, there could be one long-lived instance <code>Pool-A</code> imported by all instances of <code>A</code>, and another <code>Pool-B</code> imported by all instances of <code>B</code></p>



<a name="469680791"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469680791" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469680791">(Sep 12 2024 at 13:44)</a>:</h4>
<blockquote>
<p>Everything discussed so far isn't POSIX (obviously), so "All The Code" will need to change anyway in some form or another. Right?</p>
</blockquote>
<p>That was my intuition as well, but I don't think it holds, no: there's a huge difference between having to change an ecosystem's HTTP abstraction(s) and let everything on top work without modification, and having to change all the things on top individually</p>



<a name="469681220"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469681220" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469681220">(Sep 12 2024 at 13:46)</a>:</h4>
<p>The only idea that comes to mind that would be compatible with existing code would be per-instance session management</p>



<a name="469681486"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469681486" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469681486">(Sep 12 2024 at 13:47)</a>:</h4>
<p>as in, the thing we have now for sockets, and will have for TLS with Dave's proposal?</p>



<a name="469681555"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469681555" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Bakker (badeend) <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469681555">(Sep 12 2024 at 13:47)</a>:</h4>
<p>I agree that the required changes should be limited to the standard-library(-like) libraries, and should not impact each and every application</p>



<a name="469681838"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469681838" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469681838">(Sep 12 2024 at 13:48)</a>:</h4>
<p>I guess it would have to be host magic that was aware of export call sites</p>



<a name="469682004"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469682004" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469682004">(Sep 12 2024 at 13:49)</a>:</h4>
<p>or ~equivalently slice up composed components to give them wrapped copies of shared imports</p>



<a name="469682157"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469682157" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469682157">(Sep 12 2024 at 13:50)</a>:</h4>
<p>yeah, I remember Luke sketching out something along the latter lines</p>



<a name="469682301"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469682301" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469682301">(Sep 12 2024 at 13:50)</a>:</h4>
<p>cybernetic component implants <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="469682415"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469682415" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469682415">(Sep 12 2024 at 13:51)</a>:</h4>
<p>Would it make sense to add a "hint flag" to the component model that tells the host "instances of this (sub)component should be kept alive and reused if possible", i.e. the app will work fine even if the hint is ignored, but it will work <em>better</em> if the instances are reused?  I believe we discussed this with <span class="user-mention" data-user-id="253998">@Luke Wagner</span> and others already, but I don't recall if we discussed the scenario where e.g. a component has three subcomponents, only one of which has the hint flag attached to it, meaning the other two are <em>not</em> expected to be reused (and in fact <em>shouldn't</em> be reused), but they may use the "long lived" one to cache state.</p>



<a name="469682498"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469682498" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469682498">(Sep 12 2024 at 13:51)</a>:</h4>
<p>with dynamic instantiation, you could imagine a component exporting an API that gives a fresh instance for an interface instance export, but provides that exported instance with imports that are shared internally. Then each of those short-lived instances could hold a session key</p>



<a name="469682815"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469682815" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pavel Šavara <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469682815">(Sep 12 2024 at 13:52)</a>:</h4>
<p>Are you guys still discussing session "pool" ? Meaning that the session would not be throw-away ? And Joel means "hint that I trust the pool" ? I think I got lost.</p>



<a name="469683040"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469683040" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469683040">(Sep 12 2024 at 13:53)</a>:</h4>
<p>My comment was regarding the general problem of caching for otherwise short-lived instances.  Could be data caching, connection caching, or whatever.</p>



<a name="469683056"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469683056" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469683056">(Sep 12 2024 at 13:53)</a>:</h4>
<p>You don't even need dynamic instantiation per-se, just preprocessing to split shared imports plus a convention for how the host maps those split imports to their components</p>



<a name="469683208"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469683208" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469683208">(Sep 12 2024 at 13:54)</a>:</h4>
<p>I guess I'm not convinced that a pool is inherently more dangerous. And OTOH, prewarmed connections would require a completely different approach to establishing connections from what's proposed right now—one which would be harder to integrated into content toolchains</p>



<a name="469683554"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469683554" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469683554">(Sep 12 2024 at 13:55)</a>:</h4>
<p>Some prewarming strategies wouldn't require new interfaces; as a simple example you could immediately prewarm a connection upon opening a cold connection, optimistically assuming that it is likely to be used soon</p>



<a name="469683895"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469683895" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pavel Šavara <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469683895">(Sep 12 2024 at 13:56)</a>:</h4>
<p>And there could be configuration that for each IP the pre-warmer should keep 10 open un-used connections ready.</p>



<a name="469684127"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469684127" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469684127">(Sep 12 2024 at 13:57)</a>:</h4>
<p>given that Dave's proposal has multiple discrete steps, are you suggesting the host (or more generally, the exporter) would effectively record the sequence of these steps and then rerun them optimistically because they're likely to be repeated in exactly the same way?</p>



<a name="469684262"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469684262" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Bakker (badeend) <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469684262">(Sep 12 2024 at 13:58)</a>:</h4>
<p><span class="user-mention" data-user-id="234973">@Till Schneidereit</span> Earlier you gave a <code>client-connection-pool</code> example. Does this need to be specialized for any kind of transport (TCP and/or TLS, ..) or can it even be a generic duplex stream pool, like:</p>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>get-preopened-pool: func(name: string) -&gt; option&lt;io-pool&gt;;

interface io-pool {
    open() -&gt; tuple&lt;input-stream, output-stream&gt;;
    close(input-stream, output-stream);
}
</code></pre></div>



<a name="469684535"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469684535" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469684535">(Sep 12 2024 at 13:59)</a>:</h4>
<p>ooh, that's a great question! I can't immediately see any reason why you'd not be able to generalize it.</p>
<p>The one thing you'd lose is having to provide a proof that you'd be able to recreate the same configuration</p>



<a name="469684585"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469684585" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469684585">(Sep 12 2024 at 13:59)</a>:</h4>
<p>but maybe we could recreate even that</p>



<a name="469684756"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469684756" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pavel Šavara <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469684756">(Sep 12 2024 at 14:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="234973">Till Schneidereit</span> <a href="#narrow/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections/near/469684127">said</a>:</p>
<blockquote>
<p>given that Dave's proposal has multiple discrete steps, are you suggesting the host (or more generally, the exporter) would effectively record the sequence of these steps and then rerun them optimistically because they're likely to be repeated in exactly the same way?</p>
</blockquote>
<p>I assumed that wasi:TCP &amp; wasi:TLS are fused implementation. And that they know how to do that handshake, there are probably no application specific steps to replay, or are there ?</p>



<a name="469684815"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469684815" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469684815">(Sep 12 2024 at 14:00)</a>:</h4>
<p>You could use secret tokens as pool keys <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="469684976"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469684976" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pavel Šavara <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469684976">(Sep 12 2024 at 14:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="480579">Lann Martin</span> <a href="#narrow/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections/near/469684815">said</a>:</p>
<blockquote>
<p>You could use secret tokens as pool keys <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>
</blockquote>
<p>I previously said "anonymous", meaning PK are out of scope.</p>



<a name="469685014"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469685014" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469685014">(Sep 12 2024 at 14:01)</a>:</h4>
<p>yeah, and in fact establishing a TLS connection could return a key to use</p>



<a name="469685349"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469685349" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469685349">(Sep 12 2024 at 14:02)</a>:</h4>
<p>Well "token" is maybe the wrong term. You could for example derive the pool key from a TLS private key</p>



<a name="469685378"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469685378" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pavel Šavara <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469685378">(Sep 12 2024 at 14:02)</a>:</h4>
<p>does fingerprint of that PK become part of the cache-key then ?</p>



<a name="469685423"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469685423" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469685423">(Sep 12 2024 at 14:03)</a>:</h4>
<p>oh, and you'd be able to derive the same key/hash/token by an operation taking the same imputs</p>



<a name="469685464"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469685464" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469685464">(Sep 12 2024 at 14:03)</a>:</h4>
<p>what Lann said <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="469685750"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469685750" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469685750">(Sep 12 2024 at 14:04)</a>:</h4>
<p>In case this isn't obvious: <em>this requires very careful design; don't just hash the PK</em></p>



<a name="469685756"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469685756" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469685756">(Sep 12 2024 at 14:04)</a>:</h4>
<blockquote>
<p>I assumed that wasi:TCP &amp; wasi:TLS are fused implementation. And that they know how to do that handshake, there are probably no application specific steps to replay, or are there ?</p>
</blockquote>
<p>That's at least not how things are specified right now, and it gets us back to higher-level abstractions being harder to integrate into existing toolchains</p>



<a name="469686329"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469686329" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469686329">(Sep 12 2024 at 14:06)</a>:</h4>
<p>hmm actually this is a good question for TLS in particular; do we actually need socket pools or do we just need session resumption?</p>



<a name="469686511"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469686511" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469686511">(Sep 12 2024 at 14:07)</a>:</h4>
<p>TLS 1.3 has "0-RTT" session resumption, which just requires a secret resumption ticket iirc</p>



<a name="469686595"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469686595" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469686595">(Sep 12 2024 at 14:08)</a>:</h4>
<p>You'd still eat the normal TCP startup but that's much faster than TLS</p>



<a name="469687745"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469687745" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469687745">(Sep 12 2024 at 14:12)</a>:</h4>
<p>if we wanted to support a proof system for a general-purpose cache, we could do something like this:</p>
<ul>
<li>each operation that returns a connection (i.e. an IO stream pair) also returns a token</li>
<li>there's an operation that allows you to provide the same inputs but instead of returning the connection and the token just returns the token</li>
<li>each operation that transforms a connection into a different kind of connection (e.g. upgrades a socket connection to a TLS connection) also returns a token</li>
<li>and finally, there's an equivalent operation that takes a token instead of a connection to transform, and returns a new token</li>
</ul>
<p>With these things, you'd be able to have a chain such as</p>
<ol>
<li>establish a socket connection, get connection and token</li>
<li>upgrade to TLS, get encrypted connection and token</li>
<li>use connection however you want</li>
<li>reset connection however your use case requires</li>
<li>store connection in pool (with the associated token being stored as part of the entry implicitly)</li>
</ol>
<p>And to retrieve a connection from the pool, you'd do this:</p>
<ol>
<li>call the function to get the token for the unencrypted connection</li>
<li>call the function to get the "upgraded token"</li>
<li>get a connection from the pool with the token</li>
<li>[same as before]</li>
<li>[same as before]</li>
</ol>



<a name="469688264"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469688264" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pavel Šavara <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469688264">(Sep 12 2024 at 14:15)</a>:</h4>
<p>How would the new instance ask for connection from pool? What would give it the token ?</p>



<a name="469688294"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469688294" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469688294">(Sep 12 2024 at 14:15)</a>:</h4>
<p>actually, ignore all the "and token" parts of the first list: those aren't needed</p>



<a name="469688346"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469688346" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469688346">(Sep 12 2024 at 14:15)</a>:</h4>
<p>yeah, exactly</p>



<a name="469688378"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469688378" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469688378">(Sep 12 2024 at 14:15)</a>:</h4>
<p>one sec, sketching out example code</p>



<a name="469688597"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469688597" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469688597">(Sep 12 2024 at 14:16)</a>:</h4>
<p>for backward compatibility: trade the token to the host for a reserved ip/port that can be passed to existing client code</p>



<a name="469689477"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469689477" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Bakker (badeend) <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469689477">(Sep 12 2024 at 14:19)</a>:</h4>
<p>I'm a bit overwhelmed by all the discussion above. Could someone explain why we need "tokens/private-keys/proof-system/etc.." ?</p>



<a name="469689663"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469689663" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469689663">(Sep 12 2024 at 14:20)</a>:</h4>
<p>It is essentially about "authenticating" that your instance has permission/capability to get a particular connection from the pool</p>



<a name="469689816"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469689816" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469689816">(Sep 12 2024 at 14:21)</a>:</h4>
<p>the concern I'm trying to address is that you shouldn't be able to reuse a connection if you'd not be able to create a new one with the same properties. For example if you lost access to a client certificate, you shouldn't be able to reuse a connection that used that certificate</p>



<a name="469690660"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469690660" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Bakker (badeend) <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469690660">(Sep 12 2024 at 14:24)</a>:</h4>
<p>Hmm. In my example (<a href="#narrow/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections/near/469684262">https://bytecodealliance.zulipchat.com/#narrow/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections/near/469684262</a>) there is no such thing as "the" pool. There is a set of preopened pools that you have access to. I.e. if a pool is preopened for your component instance, then you access to those streams. Similar to files.</p>
<blockquote>
<p>you shouldn't be able to reuse a connection if you'd not be able to create a new one with the same properties. For example if you lost access to a client certificate, you shouldn't be able to reuse a connection that used that certificate</p>
</blockquote>
<p>Continuing with my example; that could be the responsibility of the child component who is putting in the streams into the pool. By putting them in, they're also giving access to use the streams. Capability-style.</p>



<a name="469690932"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469690932" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Bakker (badeend) <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469690932">(Sep 12 2024 at 14:25)</a>:</h4>
<p>It then becomes a game of logically divvying up separate kind of streams (with different permissions / authority) into separate pools.</p>



<a name="469691253"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469691253" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469691253">(Sep 12 2024 at 14:26)</a>:</h4>
<p>Yeah, "private imports" are a reasonable approach. I think the tooling just doesn't support them yet.</p>



<a name="469691349"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469691349" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469691349">(Sep 12 2024 at 14:27)</a>:</h4>
<p>I don't think that addresses the issue I'm trying to address</p>



<a name="469691845"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469691845" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469691845">(Sep 12 2024 at 14:28)</a>:</h4>
<p>the sequence of concern is</p>
<ol>
<li>client component instance <code>a</code> establishes a connection using a client certificate, and stores it in the pool</li>
<li>access to the client certificate is revoked</li>
<li>client component instance <code>b</code> retrieves connection from pool, despite not having access to the certificate anymore</li>
</ol>



<a name="469692049"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469692049" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469692049">(Sep 12 2024 at 14:29)</a>:</h4>
<p>i.e., being able to put a connection into the pool isn't sufficient to ensure that it's also okay to later retrieve it from the pool</p>



<a name="469692304"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469692304" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pavel Šavara <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469692304">(Sep 12 2024 at 14:30)</a>:</h4>
<p>could we put client certificates out of scope ?</p>



<a name="469692365"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469692365" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469692365">(Sep 12 2024 at 14:30)</a>:</h4>
<p>here's the simple client example, modified with what I have in mind:</p>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>// TCP setup:
fn from_pool() -&gt; result&lt;(io::incoming_stream, io::outgoing_stream)&gt; {
    let ip_token = wasi_sockets::get_address_resolution_token("example.com")?;
    let connection_token = wasi_sockets::get_connection_token(ip_token, 443)?;
    let tls_token = wasi_tls::get_client_connection_token(connection_token)?;
    wasi::io_pool::get(tls_token)
}

let (tls_input, tls_output)) = match from_pool() {
    Ok(connection) =&gt; connection,
    _ =&gt; {
        // TCP setup:
        let ip = wasi_sockets::resolve_addresses("example.com").await?[0];
        let tcp_client = wasi_sockets::TcpSocket::new();
        let (tcp_input, tcp_output) = tcp_client.connect(ip, 443).await;

        // TLS setup:
        let (tls_input, tls_output) = wasi_tls::ClientConnection::new(tcp_input, tcp_output)
            .connect("example.com")?
            .finish().await?;
    }
}

// Usage:
tls_output.blocking_write_and_flush("GET / HTTP/1.1\r\nHost: example.com\r\n\r\n");
let http_response = tls_input.blocking_read();

println!(http_response);

// Reset and prepare for reuse
// [Do whatever is needed to reset the connection]
wasi::io_pool::put(tls_input, tls_output);
</code></pre></div>



<a name="469692503"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469692503" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469692503">(Sep 12 2024 at 14:31)</a>:</h4>
<p>the same issue applies to allowlists for outgoing connections, and to the ability to do DNS resolution</p>



<a name="469693198"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469693198" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Bakker (badeend) <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469693198">(Sep 12 2024 at 14:33)</a>:</h4>
<blockquote>
<p>access to the client certificate is revoked</p>
</blockquote>
<p>While an active connection is using it?</p>



<a name="469693510"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469693510" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469693510">(Sep 12 2024 at 14:35)</a>:</h4>
<p>no, this would happen in-between instantiations of <code>a</code> and <code>b</code></p>



<a name="469693813"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469693813" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469693813">(Sep 12 2024 at 14:36)</a>:</h4>
<p>I shouldn't have used "revoked": I mean only the <em>access</em> to the certificate, not the certificate itself</p>



<a name="469693945"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469693945" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Bakker (badeend) <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469693945">(Sep 12 2024 at 14:37)</a>:</h4>
<p>Yeah, but the physical connection is still alive in the meantime. For the native TLS implementation, it would still be considered "in use"</p>



<a name="469694284"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469694284" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469694284">(Sep 12 2024 at 14:38)</a>:</h4>
<p>right. All I'm trying to ensure is that if you're losing access to the capability required to create a new connection, you should also lose the ability to reuse an existing connection established with those capabilities</p>



<a name="469694497"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469694497" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469694497">(Sep 12 2024 at 14:39)</a>:</h4>
<p>if we want to do a TLS specific pool, that's easy to tie to the certificate. But I really like your idea of a more general IO pool, and I think this setup would enable it</p>



<a name="469700973"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469700973" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pavel Šavara <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469700973">(Sep 12 2024 at 15:01)</a>:</h4>
<p><a href="https://github.com/dotnet/SqlClient/blob/main/src/Microsoft.Data.SqlClient/netcore/src/Microsoft/Data/SqlClient/SNI/SNITcpHandle.cs">https://github.com/dotnet/SqlClient/blob/main/src/Microsoft.Data.SqlClient/netcore/src/Microsoft/Data/SqlClient/SNI/SNITcpHandle.cs</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/dotnet/SqlClient/blob/main/src/Microsoft.Data.SqlClient/netcore/src/Microsoft/Data/SqlClient/SNI/SNITcpHandle.cs" style="background-image: url(&quot;https://uploads.zulipusercontent.net/acb005e1ffc1bba09a54f23235b875801a5b3ac6/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f316231313933313238366563643065626361356335653930306532383963336563646636303762323363326633653831326466316237396133393834643836642f646f746e65742f53716c436c69656e74&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/dotnet/SqlClient/blob/main/src/Microsoft.Data.SqlClient/netcore/src/Microsoft/Data/SqlClient/SNI/SNITcpHandle.cs" title="SqlClient/src/Microsoft.Data.SqlClient/netcore/src/Microsoft/Data/SqlClient/SNI/SNITcpHandle.cs at main · dotnet/SqlClient">SqlClient/src/Microsoft.Data.SqlClient/netcore/src/Microsoft/Data/SqlClient/SNI/SNITcpHandle.cs at main · dotnet/SqlClient</a></div><div class="message_embed_description">Microsoft.Data.SqlClient provides database connectivity to SQL Server for .NET applications. - dotnet/SqlClient</div></div></div>



<a name="469719039"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/469719039" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pavel Šavara <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#469719039">(Sep 12 2024 at 16:08)</a>:</h4>
<p>that's SQL client connection code, which ideally would not need any modifications, if we were able to hide those "caching tokens" inside dotnet base class library. I don't know if that's possible.</p>



<a name="471113284"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Database%20connection%20pooling%20or%20pre-warmed%20connections/near/471113284" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Wagner <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Database.20connection.20pooling.20or.20pre-warmed.20connections.html#471113284">(Sep 17 2024 at 22:50)</a>:</h4>
<p>Chatting with Joel and Lann a bit more about this, my impression is that, while, in the abstract, I see the value of enabling TLS connections to be pooled by the host (just like HTTP already allows), given the pure semantics of TLS (with no baked-in knowledge that we're, e.g., talking to a database with a "reset" command), it doesn't seem like something we can safely do in general without putting too much trust in the guests.  Thus, I like the idea of using a long-lived instance that handles multiple requests while maintaining its own guest-implemented pool of long-lived TLS connections.</p>
<p>The issue Joel mentioned above for the "reuse hint" is <a href="https://github.com/WebAssembly/component-model/issues/307">C-M/#307</a> and my impression is that the reuse hint proposed in that issue is a perfect match for this use case and a good short-term "Step 1".</p>
<p>As for a later "Step 2", it does seem like, as Joel suggested, we can recover the per-request isolation using the "runtime instantiation" feature (which I think should be the last significant feature to add after Preview 3 before a 1.0-rc).  With runtime instantiation, a long-lived root component could create 1 long-lived connection-pooling child instance, and then export a "handle request" function that internally uses runtime-instantiation to create a fresh request-handler child instance per request, with these dynamic children all importing the same connection-pooling instance.  What's nice is that this would all be under producer toolchain control, which I think is important because I expect there are many fine-grained policy choices to tweak how this works that we wouldn't want to bake once-and-for-all into the spec or host implementation.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/component-model/issues/307" style="background-image: url(&quot;https://uploads.zulipusercontent.net/94dd3e306685a29bde6315ebbc4b2e00e54ee6e2/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f363530643364366261316166343439653466623832626162313630363536386633343532373637396231643838303365306461346261656465346636393263622f576562417373656d626c792f636f6d706f6e656e742d6d6f64656c2f6973737565732f333037&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/component-model/issues/307" title="Consider defining an &quot;instance reuse hint&quot; · Issue #307 · WebAssembly/component-model">Consider defining an "instance reuse hint" · Issue #307 · WebAssembly/component-model</a></div><div class="message_embed_description">There's an interesting question and discussion in wasi-http/#95 that, by the end, doesn't feel specific to "HTTP" at all and thus perhaps deserving of being addressed more generally in the Componen...</div></div></div>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>