<html>
<head><meta charset="utf-8"><title>Reactors and Commands in Preview 2 · wasi · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/index.html">wasi</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html">Reactors and Commands in Preview 2</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="411237688"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/411237688" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#411237688">(Jan 04 2024 at 18:13)</a>:</h4>
<p>What's the current status of the Reactor vs Command distinction in Preview 2? My vague understanding for Commands was that a Command instance would have its "main" function (and no other exports) called exactly once. Is that the expectation for <code>wasi:cli/run</code>? (and if so it seems like that should be documented in either that interface or the <code>wasi:cli/command</code> world)</p>



<a name="411252707"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/411252707" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mossaka (Joe) <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#411252707">(Jan 04 2024 at 20:00)</a>:</h4>
<p>Related to this question, is wasi:http using the reactor mode? If so, could we add an exported <code>setup()</code> function to wasi:http/proxy that register callbacks at the initialization phase?</p>



<a name="411253076"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/411253076" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#411253076">(Jan 04 2024 at 20:02)</a>:</h4>
<p><span aria-label="point up" class="emoji emoji-1f446" role="img" title="point up">:point_up:</span>  This is actually (part of) the context for my question: how should reactor initialization be done prior to the implementation of start defs.</p>



<a name="417546304"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417546304" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mossaka (Joe) <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417546304">(Jan 23 2024 at 23:19)</a>:</h4>
<p>re: <a href="https://github.com/golang/go/issues/65199#issuecomment-1905205827">https://github.com/golang/go/issues/65199#issuecomment-1905205827</a> </p>
<blockquote>
<p>there isn't an export for reactor-style wasm programs</p>
</blockquote>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/golang/go/issues/65199#issuecomment-1905205827" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/84f7dcf3a1ff27fac7276b93bda89da7932a5f25\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f396365383436636134373331343363343231323135636237346134623834323462656334386339666366323963316631396262626533383762666638613639352f676f6c616e672f676f2f6973737565732f3635313939)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/golang/go/issues/65199#issuecomment-1905205827" title="proposal: cmd/compile: add go:wasmexport directive · Issue #65199 · golang/go">proposal: cmd/compile: add go:wasmexport directive · Issue #65199 · golang/go</a></div><div class="message_embed_description">Background #38248 defined a new compiler directive, go:wasmimport, for interfacing with host defined functions. This allowed calling from Go code into host functions, but it’s still not possible to...</div></div></div>



<a name="417551842"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417551842" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417551842">(Jan 24 2024 at 00:11)</a>:</h4>
<p>What I wrote there is actually wrong; there currently is no initialization mechanism for user code; we can't use the component-model start function, and there is discussion of WASI adding an export for this purpose.</p>



<a name="417694534"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417694534" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Randy Reddig <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417694534">(Jan 24 2024 at 17:32)</a>:</h4>
<blockquote>
<p>"no initialization mechanism for user code" <br>
Is there an initialization mechanism for the runtime or non-user code?</p>
</blockquote>



<a name="417695101"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417695101" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417695101">(Jan 24 2024 at 17:36)</a>:</h4>
<p>There is a component-model start function, that runs on instantiation. Code that doesn't need to call imports can use it. The thing I had forgotten was, that start function is not currently permitted to call imports, which means it wouldn't be friendly to give it to users and say "here, write your init code!" if it's going to trap as soon as they call an import.</p>



<a name="417695317"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417695317" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417695317">(Jan 24 2024 at 17:37)</a>:</h4>
<p>But, I just talked about this with Luke yesterday, and he's now thinking we can remove the restriction on calling imports. Assuming we do do this, then what I wrote in that issue would become correct again, and we could use the component-model start function for any purpose.</p>



<a name="417695339"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417695339" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Randy Reddig <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417695339">(Jan 24 2024 at 17:37)</a>:</h4>
<p>Got it, so the component-model start happens too early in the lifecycle to be used by a runtime which is likely to call imports.</p>



<a name="417695398"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417695398" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Randy Reddig <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417695398">(Jan 24 2024 at 17:37)</a>:</h4>
<p>What are the considerations if that constraint is relaxed?</p>



<a name="417695688"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417695688" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417695688">(Jan 24 2024 at 17:39)</a>:</h4>
<p>The start function runs automatically on instantiation, so if it can call imports, it means that component instantiation can evoke I/O. The thinking was, there may be situations where users want to instantiate a component, but without letting it do any I/O until a later step.</p>



<a name="417696009"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417696009" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Randy Reddig <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417696009">(Jan 24 2024 at 17:40)</a>:</h4>
<p>In Go’s case, the runtime picks up a few things from the local filesystem (assuming it’s readable), and user <code>init</code> code can do I/O</p>



<a name="417696093"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417696093" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Randy Reddig <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417696093">(Jan 24 2024 at 17:41)</a>:</h4>
<p>Assuming that <code>wasi:filesystem</code> and <code>wasi:cli</code> and its dependents would be initialized prior to a user component?</p>



<a name="417696293"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417696293" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417696293">(Jan 24 2024 at 17:42)</a>:</h4>
<p>In many cases, "the filesystem" is likely to be virtualized, so the resulting component wouldn't actually do that I/O. But yes, not everything will work that way.</p>



<a name="417696386"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417696386" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Randy Reddig <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417696386">(Jan 24 2024 at 17:43)</a>:</h4>
<p>Maybe a better question is: are components initialized in order of dependence?</p>



<a name="417696392"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417696392" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417696392">(Jan 24 2024 at 17:43)</a>:</h4>
<p>Also yes, component dependencies are acyclic, and initialized topologically.</p>



<a name="417696819"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417696819" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Randy Reddig <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417696819">(Jan 24 2024 at 17:45)</a>:</h4>
<p>Somewhat related to Go and the Component Model: we’re currently using <code>wasm-tools component embed</code> and <code>wasm-tools component new</code> to create a component from a Wasm module generated by the TinyGo compiler.</p>
<p>Is there a way to differentiate which <code>realloc</code> gets called a component export or import?</p>



<a name="417697047"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417697047" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417697047">(Jan 24 2024 at 17:47)</a>:</h4>
<p>I don't think so; the canonical ABI just has one <code>realloc</code>.</p>



<a name="417698577"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417698577" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Randy Reddig <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417698577">(Jan 24 2024 at 17:57)</a>:</h4>
<p>I’ve spoken with Luke about this, how <code>cabi_realloc</code> might interact with the Go GC, given that it allocates byte slabs, which might not be the correct GC shape for say something like a <code>string</code> which contains a pointer.</p>



<a name="417698912"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417698912" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417698912">(Jan 24 2024 at 17:59)</a>:</h4>
<p>the canonical abi has one realloc per import or export function - you can assign a different realloc function to each</p>



<a name="417698952"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417698952" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417698952">(Jan 24 2024 at 17:59)</a>:</h4>
<p>we have some "cheat codes" to do this for us for the preview 1 adapter in <code>wasm-tools component new</code> but no generalized support fori t</p>



<a name="417699117"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417699117" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Randy Reddig <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417699117">(Jan 24 2024 at 18:00)</a>:</h4>
<p>Luke commented about a cheat code for making allocations cheaper for I/O, e.g. hijacking the next call to <code>realloc</code> before calling <code>read</code> on a stream, to enable BYO buffer.</p>



<a name="417699126"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417699126" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417699126">(Jan 24 2024 at 18:00)</a>:</h4>
<p>so, if specializing per import/export fn is enough, that may be possible without spec changes, and we just have to encode it somehow in the module and teach <code>component new</code> to do that</p>



<a name="417699178"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417699178" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417699178">(Jan 24 2024 at 18:01)</a>:</h4>
<p>oh, hmm, thats more/different than i was thinking</p>



<a name="417699221"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417699221" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417699221">(Jan 24 2024 at 18:01)</a>:</h4>
<p>but it may also be possible</p>



<a name="417699251"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417699251" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417699251">(Jan 24 2024 at 18:01)</a>:</h4>
<p>thats some bookkeeping youd need to do inside your module</p>



<a name="417699355"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417699355" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417699355">(Jan 24 2024 at 18:02)</a>:</h4>
<p>vs exposing many distinct reallocs and assigning them to different import/export lift/lowers is something your module would expose and <code>component new</code> would do the wiring for</p>



<a name="417699371"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417699371" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Randy Reddig <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417699371">(Jan 24 2024 at 18:02)</a>:</h4>
<p>Going back to the Component Model start for a sec, can <code>wasm-tools</code> wire up a module <code>_initialize</code> to the Component Model start section?</p>



<a name="417699401"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417699401" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417699401">(Jan 24 2024 at 18:02)</a>:</h4>
<p>in theory yes</p>



<a name="417699484"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417699484" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417699484">(Jan 24 2024 at 18:02)</a>:</h4>
<p>but ill admit i dont fully understand the implications of doing so at the moment, some things in the above conversation were new to me so id need to make sure i really understood what was going on first</p>



<a name="417699707"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417699707" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417699707">(Jan 24 2024 at 18:04)</a>:</h4>
<p>(maybe <code>cabi_initialize</code> is a better name than <code>_initialize</code> but thats bikeshedding)</p>



<a name="417703376"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417703376" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417703376">(Jan 24 2024 at 18:27)</a>:</h4>
<blockquote>
<p>Going back to the Component Model start for a sec, can wasm-tools wire up a module _initialize to the Component Model start section?</p>
</blockquote>
<p>Yes, that's something <code>wasm-encoder</code> can do if one were encoding a component manually, but it's not implemented in <code>wit-component</code> when converting a core module to a component.</p>
<p>Additionally, I'll point out that component start sections aren't implemented in Wasmtime as they require fully supporting value import and exports to implement, which are also currently not implemented.</p>



<a name="417703610"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417703610" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417703610">(Jan 24 2024 at 18:29)</a>:</h4>
<p>can we make a restriction on the spec to eliminate the value imports/exports for now?</p>



<a name="417703687"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417703687" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417703687">(Jan 24 2024 at 18:30)</a>:</h4>
<p>i don't see why not, something like limiting it to <code>arg*</code> of 0 length and <code>r</code> of zero (no result)?</p>



<a name="417703738"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417703738" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417703738">(Jan 24 2024 at 18:30)</a>:</h4>
<p>so easily calling something like <code>_initialize</code></p>



<a name="417704142"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417704142" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417704142">(Jan 24 2024 at 18:32)</a>:</h4>
<p>could probably just make that limitation in wasmtime and have it non-conforming on start section implementation like it is now (until values are implemented)</p>



<a name="417704497"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417704497" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417704497">(Jan 24 2024 at 18:35)</a>:</h4>
<p>We should probably put this limitation in the spec.</p>



<a name="417704580"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417704580" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417704580">(Jan 24 2024 at 18:35)</a>:</h4>
<p>yes we should bubble it up to the spec level with the preview2 emoji as a qualifier</p>



<a name="417708350"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417708350" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Randy Reddig <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417708350">(Jan 24 2024 at 18:59)</a>:</h4>
<p>Thanks. I think that will help ease the implementation of the <code>go:wasmexport</code> proposal in Go, and simplify our work implementing the Component Model and Preview 2</p>



<a name="417708401"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417708401" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Randy Reddig <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417708401">(Jan 24 2024 at 18:59)</a>:</h4>
<p>Ideally the Go (and TinyGo) toolchains will be able to emit a component directly, once the spec is formalized.</p>



<a name="417708560"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417708560" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417708560">(Jan 24 2024 at 19:00)</a>:</h4>
<p>I filed <a href="https://github.com/WebAssembly/component-model/pull/297">https://github.com/WebAssembly/component-model/pull/297</a> to remove the restriction on imports, and to add the no-args-no-returns restriction.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/component-model/pull/297" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/281a03b3697f7fb4b0c0fed74e40b6ce14a60b3c\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f626565313162643764336132343338663038376637363638393733316532323162353331353732353634333064663464343833663130663366343466393161392f576562417373656d626c792f636f6d706f6e656e742d6d6f64656c2f70756c6c2f323937)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/component-model/pull/297" title="Allow start functions to call imports, and restrict args/returns. by sunfishcode · Pull Request #297 · WebAssembly/component-model">Allow start functions to call imports, and restrict args/returns. by sunfishcode · Pull Request #297 · WebAssembly/component-model</a></div><div class="message_embed_description">Remove the restriction on component start functions calling imports. This allows start functions to run artbitrary user code.
And, adjust the 🪙 to include start functions in the MVP, and add a rest...</div></div></div>



<a name="417709173"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417709173" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417709173">(Jan 24 2024 at 19:04)</a>:</h4>
<p>Possibly interesting tidbit: <code>componentize-py</code> relies on <code>wasm-tools component link</code> to create a component using shared-everything linking.  Part of that process involves synthesizing an "init" module which has a <code>start</code> function that calls any <code>__wasm_call_ctors</code> or <code>_initialize</code> functions found in the input modules.  Some of those functions call host imports, and that succeeds because of the order of instantiation inside the component.  So calling imports from a (module-level) <code>start</code> function <em>is</em> possible in certain cases, and <code>componentize-py</code> has been relying on that for a while.</p>



<a name="417710077"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417710077" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417710077">(Jan 24 2024 at 19:10)</a>:</h4>
<p>that's implemented with a component start section?</p>



<a name="417796402"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417796402" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417796402">(Jan 24 2024 at 19:59)</a>:</h4>
<p>No, it's a module start section inside the last module to be instantiated inside the component.</p>



<a name="417796657"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417796657" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417796657">(Jan 24 2024 at 20:00)</a>:</h4>
<p>relevant code: <a href="https://github.com/bytecodealliance/wasm-tools/blob/6470aa9df1782b4e7a21e5f065d0b991e0797862/crates/wit-component/src/linking.rs#L727-L759">https://github.com/bytecodealliance/wasm-tools/blob/6470aa9df1782b4e7a21e5f065d0b991e0797862/crates/wit-component/src/linking.rs#L727-L759</a></p>



<a name="417796849"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417796849" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417796849">(Jan 24 2024 at 20:01)</a>:</h4>
<p>ah, gotcha!</p>



<a name="417955551"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417955551" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417955551">(Jan 24 2024 at 20:09)</a>:</h4>
<p>Here's the code that ensures the desired instantiation order, FWIW: <a href="https://github.com/bytecodealliance/wasm-tools/blob/main/crates/wit-component/src/encoding.rs#L604-L630">https://github.com/bytecodealliance/wasm-tools/blob/main/crates/wit-component/src/encoding.rs#L604-L630</a></p>



<a name="417957023"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417957023" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417957023">(Jan 24 2024 at 20:18)</a>:</h4>
<p>Can that code call component imports?</p>



<a name="417958278"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417958278" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417958278">(Jan 24 2024 at 20:26)</a>:</h4>
<p>Yes</p>



<a name="417958442"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417958442" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417958442">(Jan 24 2024 at 20:27)</a>:</h4>
<p>oh! do we even need a component start section if, for the case without argument or return values, module start functions do the trick?</p>



<a name="417958586"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417958586" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417958586">(Jan 24 2024 at 20:28)</a>:</h4>
<p>Well you need to split your code over at least two modules in order for the above trick to work (or have <code>wasm-tools compoonent link</code> do that for you, based on an input shared library).</p>



<a name="417958768"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417958768" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417958768">(Jan 24 2024 at 20:30)</a>:</h4>
<p>It's easy enough for <code>componentize-py</code> since it controls the whole toolchain, but I'm not sure how generalizable it is to other languages and toolchains.</p>



<a name="417959079"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417959079" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417959079">(Jan 24 2024 at 20:32)</a>:</h4>
<p>Interesting. I wasn't aware we could do that. So yeah, I'd still like to have component start functions, so the core-wasm toolchain story can just be to export a function with a designated name, and wit-component can put it in the component-model start section.</p>



<a name="417963093"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417963093" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417963093">(Jan 24 2024 at 21:02)</a>:</h4>
<p><del>While investigating this, I noticed that while you can call imports from the core-wasm start function, the function table isn't always initialized at that time. I was able to call <code>write(1, ...)</code> and it worked, but <code>printf</code> didn't work because it does a call_indirect internally.</del></p>



<a name="417963481"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/417963481" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#417963481">(Jan 24 2024 at 21:04)</a>:</h4>
<p>Or, wait, the table is initialized, but the adapter's table isn't initialized yet.</p>



<a name="418463849"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/418463849" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Randy Reddig <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#418463849">(Jan 28 2024 at 02:12)</a>:</h4>
<p>Question regarding the Go <code>wasmexport</code> proposal and how it might interact with <code>cabi_realloc</code>:</p>
<ol>
<li>Is a guest allowed to make host calls inside of a call to <code>cabi_realloc</code>?</li>
<li>The Go <code>wasmexport</code> proposal presumes that the Go scheduler will be activated and run while the exported function runs, and pause other goroutines when the called func completes. My guess is that might not be desirable in a <code>cabi_realloc</code> call.</li>
</ol>



<a name="418464331"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/418464331" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#418464331">(Jan 28 2024 at 02:21)</a>:</h4>
<blockquote>
<p>Is a guest allowed to make host calls inside of a call to cabi_realloc?</p>
</blockquote>
<p>Short answer: no.</p>
<p>Long answer: You'll want to take a look at <a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/CanonicalABI.md">CanonicalABI.md</a> which outlines all of this. Specifically what you'll be interested in here is the <code>may_leave</code> flag. This is notably set to <code>False</code> while <code>lower_values</code> is called, meaning that when values are being lowered into a component (which is when <code>cabi_realloc</code> would be called) the flag is false which means that an import would trap. More-or-less <code>cabi_realloc</code> is expected to be a "stay inside the module" kind of thing.</p>
<blockquote>
<p>My guess is that might not be desirable in a cabi_realloc call.</p>
</blockquote>
<p>If activating the schedule has high overhead, then yes you probably don't want to do that. If there's low overhead though it may not be an issue. It's worth pointing out that there are no threads in components at this time, and it'll be awhile before there are. That means that in a single-threaded world where you're calling <code>malloc</code> there's not much use for the scheduler, especially if imports can't be called</p>



<a name="418464517"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/418464517" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Randy Reddig <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#418464517">(Jan 28 2024 at 02:25)</a>:</h4>
<p>Thanks!</p>



<a name="418464631"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Reactors%20and%20Commands%20in%20Preview%202/near/418464631" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Randy Reddig <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Reactors.20and.20Commands.20in.20Preview.202.html#418464631">(Jan 28 2024 at 02:27)</a>:</h4>
<p>I suspect if the Go runtime is adapted for this, then anytime it’s not allowed to call imports, it could block the calling goroutine until it can, and go to another goroutine</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>