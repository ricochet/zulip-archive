<html>
<head><meta charset="utf-8"><title>compiling wasi-libc p2 hello world · wasi · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/index.html">wasi</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/compiling.20wasi-libc.20p2.20hello.20world.html">compiling wasi-libc p2 hello world</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="431957933"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/compiling%20wasi-libc%20p2%20hello%20world/near/431957933" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ovf <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/compiling.20wasi-libc.20p2.20hello.20world.html#431957933">(Apr 08 2024 at 12:26)</a>:</h4>
<p>i've finally started looking at p2.<br>
built current main (d0382948) of <a href="https://github.com/WebAssembly/wasi-libc">https://github.com/WebAssembly/wasi-libc</a> with <code>make WASI_SNAPSHOT=p2</code></p>
<p>i'm compiling this one-line c program:<br>
<code>$ cat hello.c 
int puts(const char*);int main(){puts("Hello, world!");}
$ clang-17 -target wasm32-wasip2 --sysroot /s/wasi-libc/sysroot -O2 hello.c</code><br>
this seems to produce a file with rather unexpected imports:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">wasm</span><span class="o">-</span><span class="n">objdump</span><span class="w"> </span><span class="o">-</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="n">j</span><span class="w"> </span><span class="n">Import</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">out</span>

<span class="n">a</span><span class="p">.</span><span class="n">out</span>:  <span class="nc">file</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="mh">0x1</span>

<span class="n">Section</span><span class="w"> </span><span class="n">Details</span>:

<span class="nc">Import</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>:
 <span class="o">-</span><span class="w"> </span><span class="n">func</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="n">sig</span><span class="o">=</span><span class="mi">2</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wasi_snapshot_preview1</span><span class="p">.</span><span class="n">fd_close</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">wasi_snapshot_preview1</span><span class="p">.</span><span class="n">fd_close</span>
<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">func</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="n">sig</span><span class="o">=</span><span class="mi">5</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wasi_snapshot_preview1</span><span class="p">.</span><span class="n">fd_fdstat_get</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">wasi_snapshot_preview1</span><span class="p">.</span><span class="n">fd_fdstat_get</span>
<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">func</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="n">sig</span><span class="o">=</span><span class="mi">6</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wasi_snapshot_preview1</span><span class="p">.</span><span class="n">fd_seek</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">wasi_snapshot_preview1</span><span class="p">.</span><span class="n">fd_seek</span>
<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">func</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="n">sig</span><span class="o">=</span><span class="mi">4</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wasi_snapshot_preview1</span><span class="p">.</span><span class="n">fd_write</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">wasi_snapshot_preview1</span><span class="p">.</span><span class="n">fd_write</span>
<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">func</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="n">sig</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wasi</span>:<span class="nc">io</span><span class="o">/</span><span class="n">poll</span><span class="o">@</span><span class="mf">0.2.0.</span><span class="p">[</span><span class="n">resource</span><span class="o">-</span><span class="nb">drop</span><span class="p">]</span><span class="n">pollable</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">wasi</span>:<span class="nc">io</span><span class="o">/</span><span class="n">poll</span><span class="o">@</span><span class="mf">0.2.0.</span><span class="p">[</span><span class="n">resource</span><span class="o">-</span><span class="nb">drop</span><span class="p">]</span><span class="n">pollable</span>
<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">func</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="n">sig</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wasi</span>:<span class="nc">io</span><span class="o">/</span><span class="n">streams</span><span class="o">@</span><span class="mf">0.2.0.</span><span class="p">[</span><span class="n">resource</span><span class="o">-</span><span class="nb">drop</span><span class="p">]</span><span class="n">input</span><span class="o">-</span><span class="n">stream</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">wasi</span>:<span class="nc">io</span><span class="o">/</span><span class="n">streams</span><span class="o">@</span><span class="mf">0.2.0.</span><span class="p">[</span><span class="n">resource</span><span class="o">-</span><span class="nb">drop</span><span class="p">]</span><span class="n">input</span><span class="o">-</span><span class="n">stream</span>
<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">func</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="n">sig</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wasi</span>:<span class="nc">io</span><span class="o">/</span><span class="n">streams</span><span class="o">@</span><span class="mf">0.2.0.</span><span class="p">[</span><span class="n">resource</span><span class="o">-</span><span class="nb">drop</span><span class="p">]</span><span class="n">output</span><span class="o">-</span><span class="n">stream</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">wasi</span>:<span class="nc">io</span><span class="o">/</span><span class="n">streams</span><span class="o">@</span><span class="mf">0.2.0.</span><span class="p">[</span><span class="n">resource</span><span class="o">-</span><span class="nb">drop</span><span class="p">]</span><span class="n">output</span><span class="o">-</span><span class="n">stream</span>
<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">func</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="w"> </span><span class="n">sig</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wasi</span>:<span class="nc">sockets</span><span class="o">/</span><span class="n">udp</span><span class="o">@</span><span class="mf">0.2.0.</span><span class="p">[</span><span class="n">resource</span><span class="o">-</span><span class="nb">drop</span><span class="p">]</span><span class="n">udp</span><span class="o">-</span><span class="n">socket</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">wasi</span>:<span class="nc">sockets</span><span class="o">/</span><span class="n">udp</span><span class="o">@</span><span class="mf">0.2.0.</span><span class="p">[</span><span class="n">resource</span><span class="o">-</span><span class="nb">drop</span><span class="p">]</span><span class="n">udp</span><span class="o">-</span><span class="n">socket</span>
<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">func</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="n">sig</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wasi</span>:<span class="nc">sockets</span><span class="o">/</span><span class="n">udp</span><span class="o">@</span><span class="mf">0.2.0.</span><span class="p">[</span><span class="n">resource</span><span class="o">-</span><span class="nb">drop</span><span class="p">]</span><span class="n">incoming</span><span class="o">-</span><span class="n">datagram</span><span class="o">-</span><span class="n">stream</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">wasi</span>:<span class="nc">sockets</span><span class="o">/</span><span class="n">udp</span><span class="o">@</span><span class="mf">0.2.0.</span><span class="p">[</span><span class="n">resource</span><span class="o">-</span><span class="nb">drop</span><span class="p">]</span><span class="n">incoming</span><span class="o">-</span><span class="n">datagram</span><span class="o">-</span><span class="n">stream</span>
<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">func</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="w"> </span><span class="n">sig</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wasi</span>:<span class="nc">sockets</span><span class="o">/</span><span class="n">udp</span><span class="o">@</span><span class="mf">0.2.0.</span><span class="p">[</span><span class="n">resource</span><span class="o">-</span><span class="nb">drop</span><span class="p">]</span><span class="n">outgoing</span><span class="o">-</span><span class="n">datagram</span><span class="o">-</span><span class="n">stream</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">wasi</span>:<span class="nc">sockets</span><span class="o">/</span><span class="n">udp</span><span class="o">@</span><span class="mf">0.2.0.</span><span class="p">[</span><span class="n">resource</span><span class="o">-</span><span class="nb">drop</span><span class="p">]</span><span class="n">outgoing</span><span class="o">-</span><span class="n">datagram</span><span class="o">-</span><span class="n">stream</span>
<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">func</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="w"> </span><span class="n">sig</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wasi</span>:<span class="nc">sockets</span><span class="o">/</span><span class="n">tcp</span><span class="o">@</span><span class="mf">0.2.0.</span><span class="p">[</span><span class="n">resource</span><span class="o">-</span><span class="nb">drop</span><span class="p">]</span><span class="n">tcp</span><span class="o">-</span><span class="n">socket</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">wasi</span>:<span class="nc">sockets</span><span class="o">/</span><span class="n">tcp</span><span class="o">@</span><span class="mf">0.2.0.</span><span class="p">[</span><span class="n">resource</span><span class="o">-</span><span class="nb">drop</span><span class="p">]</span><span class="n">tcp</span><span class="o">-</span><span class="n">socket</span>
<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">func</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="w"> </span><span class="n">sig</span><span class="o">=</span><span class="mi">2</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wasi_snapshot_preview1</span><span class="p">.</span><span class="n">adapter_close_badfd</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">wasi_snapshot_preview1</span><span class="p">.</span><span class="n">adapter_close_badfd</span>
</code></pre></div>
<p>and sure enough, i can't seem to run it:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">S</span><span class="w"> </span><span class="n">preview2</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">out</span>
<span class="n">Error</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="err">`</span><span class="n">a</span><span class="p">.</span><span class="n">out</span><span class="err">`</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="mi">0</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">instantiate</span><span class="w"> </span><span class="s">"a.out"</span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">unknown</span><span class="w"> </span><span class="n">import</span>: <span class="err">`</span><span class="n">wasi</span>:<span class="nc">io</span><span class="o">/</span><span class="n">poll</span><span class="o">@</span><span class="mf">0.2.0</span>::<span class="p">[</span><span class="n">resource</span><span class="o">-</span><span class="nb">drop</span><span class="p">]</span><span class="n">pollable</span><span class="err">`</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">defined</span>
</code></pre></div>
<p>what am i missing?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/wasi-libc" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/3af91abd85d37ee7938c1ebd369834f7bd33b4eb\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f396631653934373330366435313064616565663130633763653837356664323435313766356138396538623662633561633538373863343831326139616537392f576562417373656d626c792f776173692d6c696263)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/wasi-libc" title="GitHub - WebAssembly/wasi-libc: WASI libc implementation for WebAssembly">GitHub - WebAssembly/wasi-libc: WASI libc implementation for WebAssembly</a></div><div class="message_embed_description">WASI libc implementation for WebAssembly. Contribute to WebAssembly/wasi-libc development by creating an account on GitHub.</div></div></div>



<a name="431972361"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/compiling%20wasi-libc%20p2%20hello%20world/near/431972361" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/compiling.20wasi-libc.20p2.20hello.20world.html#431972361">(Apr 08 2024 at 13:34)</a>:</h4>
<p>If you install <a href="https://github.com/bytecodealliance/wasm-tools/releases">wasm-tools</a>, then grab the Preview 1 adapter (e.g. <code>curl -LO https://github.com/bytecodealliance/wasmtime/releases/download/v19.0.1/wasi_snapshot_preview1.command.wasm</code>) and run <code>wasm-tools component new --adapt wasi_snapshot_preview1.command.wasm a.out -o component.wasm</code>, Wasmtime should be able to run <code>component.wasm</code>.</p>
<p>The reasons you need to do the above are (1) <code>wasm-ld</code> generates a module, but Wasmtime only knows how to run Preview 1 modules and Preview 2 components, and (2) the <code>wasm32-wasip2</code> target in <code>wasi-sdk</code> currently imports a mix of Preview 1 and Preview 2 functions while we incrementally add support for Preview 2, and while that is the case we need to use an adapter to map the Preview 1 imports to Preview 2 imports.  See <a href="https://github.com/WebAssembly/wasi-libc/issues/447">https://github.com/WebAssembly/wasi-libc/issues/447</a> for details.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasm-tools/releases" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/8fefa0280a48cb91f6b65b9bad9ea4d600fe707c\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f323238646136313136643130343731646565346438643533386630633233336664663533633536376236613436633033663261663162633137333034613361302f62797465636f6465616c6c69616e63652f7761736d2d746f6f6c73)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasm-tools/releases" title="Releases · bytecodealliance/wasm-tools">Releases · bytecodealliance/wasm-tools</a></div><div class="message_embed_description"> CLI and Rust libraries for low-level manipulation of WebAssembly modules  - bytecodealliance/wasm-tools</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/wasi-libc/issues/447" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/24612f513f15ebb508a89de5010ebebf8bf64743\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f373864613935636635376630313861306439643438653039336330393631356162303066333731313765313734356136323465633831616365633435626439312f576562417373656d626c792f776173692d6c6962632f6973737565732f343437)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/wasi-libc/issues/447" title="Proposal: add `wasm32-wasi-preview2` target, prioritizing `wasi-sockets` support · Issue #447 · WebAssembly/wasi-libc">Proposal: add `wasm32-wasi-preview2` target, prioritizing `wasi-sockets` support · Issue #447 · WebAssembly/wasi-libc</a></div><div class="message_embed_description">Summary This is a proposal to add wasi-sockets support to wasi-libc as a first step towards full WASI Preview 2 support. This includes adding a new wasm32-wasi-preview2 build target to differentiat...</div></div></div>



<a name="431990533"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/compiling%20wasi-libc%20p2%20hello%20world/near/431990533" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ovf <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/compiling.20wasi-libc.20p2.20hello.20world.html#431990533">(Apr 08 2024 at 14:54)</a>:</h4>
<p>thanks! so if my aim was to implement enough of wasip2 in my runtime to run my (wasi-libc-based) code, it might be a bit too soon?</p>
<p>the second takeaway for me, which isn't really a question, is that i should once again try and read through the component model documentation in the hopes of understanding (in order of importance) the why and the how.</p>
<p>is wasmtime expected to eventually support wasip2 modules through the cm canonical abi, or will it be component model all the way?</p>



<a name="431998198"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/compiling%20wasi-libc%20p2%20hello%20world/near/431998198" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/compiling.20wasi-libc.20p2.20hello.20world.html#431998198">(Apr 08 2024 at 15:17)</a>:</h4>
<p>I'm not aware of any plans to support wasip2 modules.  One easy way to do it would be to convert such modules to components "just in time" using <code>wit-component</code> prior to instantiating them in <code>wasmtime run</code>.  Not sure if there's interest in adding such a feature, though.  If you're adding support for wasip2 to your own runtime, though, you're free to do whatever you like.  This might be relevant: <a href="https://github.com/WebAssembly/wasi-libc/issues/447#issuecomment-1971367144">https://github.com/WebAssembly/wasi-libc/issues/447#issuecomment-1971367144</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/wasi-libc/issues/447#issuecomment-1971367144" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/24612f513f15ebb508a89de5010ebebf8bf64743\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f373864613935636635376630313861306439643438653039336330393631356162303066333731313765313734356136323465633831616365633435626439312f576562417373656d626c792f776173692d6c6962632f6973737565732f343437)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/wasi-libc/issues/447#issuecomment-1971367144" title="Proposal: add `wasm32-wasi-preview2` target, prioritizing `wasi-sockets` support · Issue #447 · WebAssembly/wasi-libc">Proposal: add `wasm32-wasi-preview2` target, prioritizing `wasi-sockets` support · Issue #447 · WebAssembly/wasi-libc</a></div><div class="message_embed_description">Summary This is a proposal to add wasi-sockets support to wasi-libc as a first step towards full WASI Preview 2 support. This includes adding a new wasm32-wasi-preview2 build target to differentiat...</div></div></div>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>