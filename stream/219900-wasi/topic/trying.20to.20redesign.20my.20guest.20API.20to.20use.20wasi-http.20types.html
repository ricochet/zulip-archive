<html>
<head><meta charset="utf-8"><title>trying to redesign my guest API to use wasi-http types · wasi · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/index.html">wasi</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/trying.20to.20redesign.20my.20guest.20API.20to.20use.20wasi-http.20types.html">trying to redesign my guest API to use wasi-http types</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="422694674"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/trying%20to%20redesign%20my%20guest%20API%20to%20use%20wasi-http%20types/near/422694674" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bob Aman <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/trying.20to.20redesign.20my.20guest.20API.20to.20use.20wasi-http.20types.html#422694674">(Feb 21 2024 at 19:50)</a>:</h4>
<p>With wasi 0.2.0, I opted to redesign my guest API to use wasi-http. Unfortunately, I'm running into some issues with <code>incoming-response</code> in particular. My guest environment can read an <code>incoming-request</code> body just fine, but the same code to read a response body fails trying to <code>consume()</code> the body. There doesn't seem to be an error type to help diagnose the problem, so I'm not sure what I've done wrong. Notably, this doesn't use incoming-handler because the guest doesn't produce a response itself but rather makes security decisions based on requests/responses. I'm also currently reading everything into a buffer ahead of time because the same request/response have to be sent to multiple guest environments.</p>
<p>Code's public. Here's the bits I suspect are most relevant:<br>
<a href="https://github.com/bulwark-security/bulwark/blob/api-refactor/wit/handlers.wit#L32">https://github.com/bulwark-security/bulwark/blob/api-refactor/wit/handlers.wit#L32</a><br>
<a href="https://github.com/bulwark-security/bulwark/blob/api-refactor/crates/wasm-host/src/plugin.rs#L475-L493">https://github.com/bulwark-security/bulwark/blob/api-refactor/crates/wasm-host/src/plugin.rs#L475-L493</a><br>
<a href="https://github.com/bulwark-security/bulwark/blob/api-refactor/crates/wasm-sdk-macros/src/lib.rs#L402-L411">https://github.com/bulwark-security/bulwark/blob/api-refactor/crates/wasm-sdk-macros/src/lib.rs#L402-L411</a></p>
<p>Sample output for a single guest plugin:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">INFO</span><span class="w">     </span><span class="n">handle</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mf">3.42</span><span class="n">ms</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">0.00</span><span class="o">%</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">100.00</span><span class="o">%</span><span class="w"> </span><span class="p">]</span>
<span class="n">INFO</span><span class="w">     </span><span class="err">┕━</span><span class="w"> </span><span class="n">route</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mf">3.42</span><span class="n">ms</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">30.54</span><span class="o">%</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">100.00</span><span class="o">%</span><span class="w"> </span><span class="p">]</span>
<span class="n">INFO</span><span class="w">        </span><span class="err">┝━</span><span class="w"> </span><span class="err">ｉ</span><span class="w"> </span><span class="p">[</span><span class="n">info</span><span class="p">]</span>: <span class="s">"process request"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">method</span>: <span class="s">"POST"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">uri</span>: <span class="s">"/echo"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">user_agent</span>: <span class="s">"curl/8.1.2"</span>
<span class="n">INFO</span><span class="w">        </span><span class="err">┝━</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="n">on_init</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mi">277</span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">8.12</span><span class="o">%</span><span class="w"> </span><span class="p">]</span>
<span class="n">INFO</span><span class="w">        </span><span class="err">┝━</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="n">on_request</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mf">1.40</span><span class="n">ms</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">41.03</span><span class="o">%</span><span class="w"> </span><span class="p">]</span>
<span class="n">INFO</span><span class="w">        </span><span class="err">┝━</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="n">on_request_decision</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mi">243</span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">7.11</span><span class="o">%</span><span class="w"> </span><span class="p">]</span>
<span class="n">INFO</span><span class="w">        </span><span class="err">│</span><span class="w">  </span><span class="err">┕━</span><span class="w"> </span><span class="err">ｉ</span><span class="w"> </span><span class="p">[</span><span class="n">info</span><span class="p">]</span>: <span class="s">"plugin decision"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">name</span>: <span class="s">"blank_slate"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">accept</span>: <span class="mf">0.0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">restrict</span>: <span class="mf">0.0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">unknown</span>: <span class="mf">1.0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">score</span>: <span class="mf">0.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">weight</span>: <span class="mf">1.0</span>
<span class="n">INFO</span><span class="w">        </span><span class="err">┝━</span><span class="w"> </span><span class="err">ｉ</span><span class="w"> </span><span class="p">[</span><span class="n">info</span><span class="p">]</span>: <span class="s">"combine decision"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">accept</span>: <span class="mf">0.0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">restrict</span>: <span class="mf">0.0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">unknown</span>: <span class="mf">1.0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">score</span>: <span class="mf">0.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">outcome</span>: <span class="s">"accepted"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">observe_only</span>: <span class="nc">true</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">tags</span>: <span class="s">"blank-slate"</span>
<span class="n">INFO</span><span class="w">        </span><span class="err">┝━</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="n">on_response_decision</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mi">326</span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">9.52</span><span class="o">%</span><span class="w"> </span><span class="p">]</span>
<span class="n">ERROR</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">┕━</span><span class="w"> </span><span class="err">🚨</span><span class="w"> </span><span class="p">[</span><span class="n">error</span><span class="p">]</span>: <span class="s">"plugin error"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">error</span>: <span class="s">"Error::Other(</span><span class="se">\"</span><span class="s">body cannot be consumed</span><span class="se">\"</span><span class="s">)"</span>
<span class="n">ERROR</span><span class="w">       </span><span class="err">┝━</span><span class="w"> </span><span class="err">🚨</span><span class="w"> </span><span class="p">[</span><span class="n">error</span><span class="p">]</span>: <span class="s">"plugin execution error"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">elapsed</span>: <span class="nc">HandlerError</span><span class="p">(</span><span class="n">Error</span>::<span class="n">Other</span><span class="p">(</span><span class="s">"body cannot be consumed"</span><span class="p">))</span>
<span class="n">INFO</span><span class="w">        </span><span class="err">┝━</span><span class="w"> </span><span class="err">ｉ</span><span class="w"> </span><span class="p">[</span><span class="n">info</span><span class="p">]</span>: <span class="s">"combine decision"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">accept</span>: <span class="mf">0.0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">restrict</span>: <span class="mf">0.0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">unknown</span>: <span class="mf">1.0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">score</span>: <span class="mf">0.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">outcome</span>: <span class="s">"accepted"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">observe_only</span>: <span class="nc">true</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">tags</span>: <span class="s">"error"</span>
<span class="n">INFO</span><span class="w">        </span><span class="err">┝━</span><span class="w"> </span><span class="err">ｉ</span><span class="w"> </span><span class="p">[</span><span class="n">info</span><span class="p">]</span>: <span class="s">"process response"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">status</span>: <span class="mi">200</span>
<span class="n">INFO</span><span class="w">        </span><span class="err">┝━</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="n">on_decision_feedback</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mi">108</span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">3.15</span><span class="o">%</span><span class="w"> </span><span class="p">]</span>
<span class="n">ERROR</span><span class="w">       </span><span class="err">┝━</span><span class="w"> </span><span class="err">🚨</span><span class="w"> </span><span class="p">[</span><span class="n">error</span><span class="p">]</span>: <span class="s">"plugin execution error"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">elapsed</span>: <span class="nc">HandlerError</span><span class="p">(</span><span class="n">Error</span>::<span class="n">Other</span><span class="p">(</span><span class="s">"body cannot be consumed"</span><span class="p">))</span>
<span class="n">INFO</span><span class="w">        </span><span class="err">┕━</span><span class="w"> </span><span class="n">plugin</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mf">18.1</span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">0.53</span><span class="o">%</span><span class="w"> </span><span class="p">]</span>
</code></pre></div>
<p>The last several issues I've run into have turned out to be blindingly obvious to other people, and I'm hoping this is another in that category since I don't seem to be making any headway myself at this point. Would anyone be willing to take a look?</p>



<a name="422873327"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/trying%20to%20redesign%20my%20guest%20API%20to%20use%20wasi-http%20types/near/422873327" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/trying.20to.20redesign.20my.20guest.20API.20to.20use.20wasi-http.20types.html#422873327">(Feb 22 2024 at 18:00)</a>:</h4>
<p>one thing you could try is to get Wasmtime to give you more information. You should be able to do so by adding this before your invocation:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">RUST_LOG</span><span class="o">=</span><span class="s">"error,wasmtime_wasi=trace"</span>
</code></pre></div>
<p>(If that doesn't work, try <code>WASMTIME_LOG</code> instead)</p>



<a name="422882849"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/trying%20to%20redesign%20my%20guest%20API%20to%20use%20wasi-http%20types/near/422882849" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bob Aman <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/trying.20to.20redesign.20my.20guest.20API.20to.20use.20wasi-http.20types.html#422882849">(Feb 22 2024 at 18:47)</a>:</h4>
<p>Unfortunately that just tells me what I already know, but in more detail. The <code>incoming-response</code>'s body <code>consume()</code> is unsuccessful, but the <code>incoming-request</code> is fine.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">INFO</span><span class="w">     </span><span class="n">handle</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mf">10.2</span><span class="n">ms</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">0.00</span><span class="o">%</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">100.00</span><span class="o">%</span><span class="w"> </span><span class="p">]</span>
<span class="n">INFO</span><span class="w">     </span><span class="err">┕━</span><span class="w"> </span><span class="n">route</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mf">10.2</span><span class="n">ms</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">0.00</span><span class="o">%</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">100.00</span><span class="o">%</span><span class="w"> </span><span class="p">]</span>
<span class="n">INFO</span><span class="w">        </span><span class="err">┝━</span><span class="w"> </span><span class="err">ｉ</span><span class="w"> </span><span class="p">[</span><span class="n">info</span><span class="p">]</span>: <span class="s">"process request"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">method</span>: <span class="s">"POST"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">uri</span>: <span class="s">"/echo"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">user_agent</span>: <span class="s">"curl/8.1.2"</span>
<span class="p">[</span><span class="n">snip</span><span class="p">]</span>
<span class="n">INFO</span><span class="w">        </span><span class="err">┝━</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="n">on_response_decision</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mi">803</span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">7.02</span><span class="o">%</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">7.86</span><span class="o">%</span><span class="w"> </span><span class="p">]</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">┝━</span><span class="w"> </span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mf">5.90</span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">0.06</span><span class="o">%</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">module</span>: <span class="s">"types"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">function</span>: <span class="s">"[method]incoming-request.scheme"</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┝━</span><span class="w"> </span><span class="err">📍</span><span class="w"> </span><span class="p">[</span><span class="n">trace</span><span class="p">]</span>: <span class="nc">call</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">self_</span>: <span class="nc">Resource</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">rep</span>: <span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">state</span>: <span class="s">"borrow"</span><span class="w"> </span><span class="p">}</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┕━</span><span class="w"> </span><span class="err">📍</span><span class="w"> </span><span class="p">[</span><span class="n">trace</span><span class="p">]</span>: <span class="nc">return</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">result</span>: <span class="nb">Ok</span><span class="p">(</span><span class="nb">None</span><span class="p">)</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">┝━</span><span class="w"> </span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mf">3.42</span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">0.03</span><span class="o">%</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">module</span>: <span class="s">"types"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">function</span>: <span class="s">"[method]incoming-request.authority"</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┝━</span><span class="w"> </span><span class="err">📍</span><span class="w"> </span><span class="p">[</span><span class="n">trace</span><span class="p">]</span>: <span class="nc">call</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">self_</span>: <span class="nc">Resource</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">rep</span>: <span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">state</span>: <span class="s">"borrow"</span><span class="w"> </span><span class="p">}</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┕━</span><span class="w"> </span><span class="err">📍</span><span class="w"> </span><span class="p">[</span><span class="n">trace</span><span class="p">]</span>: <span class="nc">return</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">result</span>: <span class="nb">Ok</span><span class="p">(</span><span class="nb">None</span><span class="p">)</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">┝━</span><span class="w"> </span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mf">4.88</span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">0.05</span><span class="o">%</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">module</span>: <span class="s">"types"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">function</span>: <span class="s">"[method]incoming-request.method"</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┝━</span><span class="w"> </span><span class="err">📍</span><span class="w"> </span><span class="p">[</span><span class="n">trace</span><span class="p">]</span>: <span class="nc">call</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">self_</span>: <span class="nc">Resource</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">rep</span>: <span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">state</span>: <span class="s">"borrow"</span><span class="w"> </span><span class="p">}</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┕━</span><span class="w"> </span><span class="err">📍</span><span class="w"> </span><span class="p">[</span><span class="n">trace</span><span class="p">]</span>: <span class="nc">return</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">result</span>: <span class="nb">Ok</span><span class="p">(</span><span class="n">Method</span>::<span class="n">Post</span><span class="p">)</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">┝━</span><span class="w"> </span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mf">3.30</span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">0.03</span><span class="o">%</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">module</span>: <span class="s">"types"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">function</span>: <span class="s">"[method]incoming-request.path-with-query"</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┝━</span><span class="w"> </span><span class="err">📍</span><span class="w"> </span><span class="p">[</span><span class="n">trace</span><span class="p">]</span>: <span class="nc">call</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">self_</span>: <span class="nc">Resource</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">rep</span>: <span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">state</span>: <span class="s">"borrow"</span><span class="w"> </span><span class="p">}</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┕━</span><span class="w"> </span><span class="err">📍</span><span class="w"> </span><span class="p">[</span><span class="n">trace</span><span class="p">]</span>: <span class="nc">return</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">result</span>: <span class="nb">Ok</span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="s">"/echo"</span><span class="p">))</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">┝━</span><span class="w"> </span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mf">4.38</span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">0.04</span><span class="o">%</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">module</span>: <span class="s">"types"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">function</span>: <span class="s">"[method]incoming-request.headers"</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┝━</span><span class="w"> </span><span class="err">📍</span><span class="w"> </span><span class="p">[</span><span class="n">trace</span><span class="p">]</span>: <span class="nc">call</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">self_</span>: <span class="nc">Resource</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">rep</span>: <span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">state</span>: <span class="s">"borrow"</span><span class="w"> </span><span class="p">}</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┕━</span><span class="w"> </span><span class="err">📍</span><span class="w"> </span><span class="p">[</span><span class="n">trace</span><span class="p">]</span>: <span class="nc">return</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">result</span>: <span class="nb">Ok</span><span class="p">(</span><span class="n">Resource</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">rep</span>: <span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">state</span>: <span class="s">"own (not in table)"</span><span class="w"> </span><span class="p">})</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">┝━</span><span class="w"> </span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mf">13.8</span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">0.13</span><span class="o">%</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">module</span>: <span class="s">"types"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">function</span>: <span class="s">"[method]fields.entries"</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┝━</span><span class="w"> </span><span class="err">📍</span><span class="w"> </span><span class="p">[</span><span class="n">trace</span><span class="p">]</span>: <span class="nc">call</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">self_</span>: <span class="nc">Resource</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">rep</span>: <span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">state</span>: <span class="s">"borrow"</span><span class="w"> </span><span class="p">}</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┕━</span><span class="w"> </span><span class="err">📍</span><span class="w"> </span><span class="p">[</span><span class="n">trace</span><span class="p">]</span>: <span class="nc">return</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">result</span>: <span class="nb">Ok</span><span class="p">([(</span><span class="s">"user-agent"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">99</span><span class="p">,</span><span class="w"> </span><span class="mi">117</span><span class="p">,</span><span class="w"> </span><span class="mi">114</span><span class="p">,</span><span class="w"> </span><span class="mi">108</span><span class="p">,</span><span class="w"> </span><span class="mi">47</span><span class="p">,</span><span class="w"> </span><span class="mi">56</span><span class="p">,</span><span class="w"> </span><span class="mi">46</span><span class="p">,</span><span class="w"> </span><span class="mi">49</span><span class="p">,</span><span class="w"> </span><span class="mi">46</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">]),</span><span class="w"> </span><span class="p">(</span><span class="s">"accept"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">42</span><span class="p">,</span><span class="w"> </span><span class="mi">47</span><span class="p">,</span><span class="w"> </span><span class="mi">42</span><span class="p">]),</span><span class="w"> </span><span class="p">(</span><span class="s">"content-length"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">52</span><span class="p">]),</span><span class="w"> </span><span class="p">(</span><span class="s">"content-type"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">97</span><span class="p">,</span><span class="w"> </span><span class="mi">112</span><span class="p">,</span><span class="w"> </span><span class="mi">112</span><span class="p">,</span><span class="w"> </span><span class="mi">108</span><span class="p">,</span><span class="w"> </span><span class="mi">105</span><span class="p">,</span><span class="w"> </span><span class="mi">99</span><span class="p">,</span><span class="w"> </span><span class="mi">97</span><span class="p">,</span><span class="w"> </span><span class="mi">116</span><span class="p">,</span><span class="w"> </span><span class="mi">105</span><span class="p">,</span><span class="w"> </span><span class="mi">111</span><span class="p">,</span><span class="w"> </span><span class="mi">110</span><span class="p">,</span><span class="w"> </span><span class="mi">47</span><span class="p">,</span><span class="w"> </span><span class="mi">120</span><span class="p">,</span><span class="w"> </span><span class="mi">45</span><span class="p">,</span><span class="w"> </span><span class="mi">119</span><span class="p">,</span><span class="w"> </span><span class="mi">119</span><span class="p">,</span><span class="w"> </span><span class="mi">119</span><span class="p">,</span><span class="w"> </span><span class="mi">45</span><span class="p">,</span><span class="w"> </span><span class="mi">102</span><span class="p">,</span><span class="w"> </span><span class="mi">111</span><span class="p">,</span><span class="w"> </span><span class="mi">114</span><span class="p">,</span><span class="w"> </span><span class="mi">109</span><span class="p">,</span><span class="w"> </span><span class="mi">45</span><span class="p">,</span><span class="w"> </span><span class="mi">117</span><span class="p">,</span><span class="w"> </span><span class="mi">114</span><span class="p">,</span><span class="w"> </span><span class="mi">108</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span><span class="p">,</span><span class="w"> </span><span class="mi">110</span><span class="p">,</span><span class="w"> </span><span class="mi">99</span><span class="p">,</span><span class="w"> </span><span class="mi">111</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">]),</span><span class="w"> </span><span class="p">(</span><span class="s">"x-forwarded-proto"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">104</span><span class="p">,</span><span class="w"> </span><span class="mi">116</span><span class="p">,</span><span class="w"> </span><span class="mi">116</span><span class="p">,</span><span class="w"> </span><span class="mi">112</span><span class="p">]),</span><span class="w"> </span><span class="p">(</span><span class="s">"x-request-id"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="mi">102</span><span class="p">,</span><span class="w"> </span><span class="mi">55</span><span class="p">,</span><span class="w"> </span><span class="mi">54</span><span class="p">,</span><span class="w"> </span><span class="mi">99</span><span class="p">,</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span><span class="p">,</span><span class="w"> </span><span class="mi">45</span><span class="p">,</span><span class="w"> </span><span class="mi">52</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="mi">45</span><span class="p">,</span><span class="w"> </span><span class="mi">52</span><span class="p">,</span><span class="w"> </span><span class="mi">56</span><span class="p">,</span><span class="w"> </span><span class="mi">55</span><span class="p">,</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="mi">45</span><span class="p">,</span><span class="w"> </span><span class="mi">97</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">99</span><span class="p">,</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="mi">45</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span><span class="p">,</span><span class="w"> </span><span class="mi">97</span><span class="p">,</span><span class="w"> </span><span class="mi">55</span><span class="p">,</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="mi">54</span><span class="p">,</span><span class="w"> </span><span class="mi">56</span><span class="p">,</span><span class="w"> </span><span class="mi">56</span><span class="p">,</span><span class="w"> </span><span class="mi">98</span><span class="p">,</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="mi">56</span><span class="p">,</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="mi">49</span><span class="p">])])</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">┝━</span><span class="w"> </span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mf">4.30</span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">0.04</span><span class="o">%</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">module</span>: <span class="s">"types"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">function</span>: <span class="s">"[method]incoming-request.consume"</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┝━</span><span class="w"> </span><span class="err">📍</span><span class="w"> </span><span class="p">[</span><span class="n">trace</span><span class="p">]</span>: <span class="nc">call</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">self_</span>: <span class="nc">Resource</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">rep</span>: <span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">state</span>: <span class="s">"borrow"</span><span class="w"> </span><span class="p">}</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┕━</span><span class="w"> </span><span class="err">📍</span><span class="w"> </span><span class="p">[</span><span class="n">trace</span><span class="p">]</span>: <span class="nc">return</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">result</span>: <span class="nb">Ok</span><span class="p">(</span><span class="nb">Ok</span><span class="p">(</span><span class="n">Resource</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">rep</span>: <span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">state</span>: <span class="s">"own (not in table)"</span><span class="w"> </span><span class="p">}))</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">┝━</span><span class="w"> </span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mf">4.39</span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">0.04</span><span class="o">%</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">module</span>: <span class="s">"types"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">function</span>: <span class="s">"[method]incoming-body.stream"</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┝━</span><span class="w"> </span><span class="err">📍</span><span class="w"> </span><span class="p">[</span><span class="n">trace</span><span class="p">]</span>: <span class="nc">call</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">self_</span>: <span class="nc">Resource</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">rep</span>: <span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">state</span>: <span class="s">"borrow"</span><span class="w"> </span><span class="p">}</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┕━</span><span class="w"> </span><span class="err">📍</span><span class="w"> </span><span class="p">[</span><span class="n">trace</span><span class="p">]</span>: <span class="nc">return</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">result</span>: <span class="nb">Ok</span><span class="p">(</span><span class="nb">Ok</span><span class="p">(</span><span class="n">Resource</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">rep</span>: <span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="n">state</span>: <span class="s">"own (not in table)"</span><span class="w"> </span><span class="p">}))</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">┝━</span><span class="w"> </span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mf">10.6</span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">0.10</span><span class="o">%</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">module</span>: <span class="s">"streams"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">function</span>: <span class="s">"[method]input-stream.read"</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┝━</span><span class="w"> </span><span class="err">📍</span><span class="w"> </span><span class="p">[</span><span class="n">trace</span><span class="p">]</span>: <span class="nc">call</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">self_</span>: <span class="nc">Resource</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">rep</span>: <span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="n">state</span>: <span class="s">"borrow"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">len</span>: <span class="mi">1048576</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┕━</span><span class="w"> </span><span class="err">📍</span><span class="w"> </span><span class="p">[</span><span class="n">trace</span><span class="p">]</span>: <span class="nc">return</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">result</span>: <span class="nb">Ok</span><span class="p">([</span><span class="mi">116</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span><span class="p">,</span><span class="w"> </span><span class="mi">115</span><span class="p">,</span><span class="w"> </span><span class="mi">116</span><span class="p">])</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">┝━</span><span class="w"> </span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mf">6.61</span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">0.06</span><span class="o">%</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">module</span>: <span class="s">"types"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">function</span>: <span class="s">"[method]incoming-response.status"</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┝━</span><span class="w"> </span><span class="err">📍</span><span class="w"> </span><span class="p">[</span><span class="n">trace</span><span class="p">]</span>: <span class="nc">call</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">self_</span>: <span class="nc">Resource</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">rep</span>: <span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">state</span>: <span class="s">"borrow"</span><span class="w"> </span><span class="p">}</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┕━</span><span class="w"> </span><span class="err">📍</span><span class="w"> </span><span class="p">[</span><span class="n">trace</span><span class="p">]</span>: <span class="nc">return</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">result</span>: <span class="nb">Ok</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">┝━</span><span class="w"> </span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mf">8.09</span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">0.08</span><span class="o">%</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">module</span>: <span class="s">"types"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">function</span>: <span class="s">"[method]incoming-response.headers"</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┝━</span><span class="w"> </span><span class="err">📍</span><span class="w"> </span><span class="p">[</span><span class="n">trace</span><span class="p">]</span>: <span class="nc">call</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">self_</span>: <span class="nc">Resource</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">rep</span>: <span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">state</span>: <span class="s">"borrow"</span><span class="w"> </span><span class="p">}</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┕━</span><span class="w"> </span><span class="err">📍</span><span class="w"> </span><span class="p">[</span><span class="n">trace</span><span class="p">]</span>: <span class="nc">return</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">result</span>: <span class="nb">Ok</span><span class="p">(</span><span class="n">Resource</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">rep</span>: <span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">state</span>: <span class="s">"own (not in table)"</span><span class="w"> </span><span class="p">})</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">┝━</span><span class="w"> </span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mf">11.1</span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">0.11</span><span class="o">%</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">module</span>: <span class="s">"types"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">function</span>: <span class="s">"[method]fields.entries"</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┝━</span><span class="w"> </span><span class="err">📍</span><span class="w"> </span><span class="p">[</span><span class="n">trace</span><span class="p">]</span>: <span class="nc">call</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">self_</span>: <span class="nc">Resource</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">rep</span>: <span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">state</span>: <span class="s">"borrow"</span><span class="w"> </span><span class="p">}</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┕━</span><span class="w"> </span><span class="err">📍</span><span class="w"> </span><span class="p">[</span><span class="n">trace</span><span class="p">]</span>: <span class="nc">return</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">result</span>: <span class="nb">Ok</span><span class="p">([(</span><span class="s">"content-type"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">97</span><span class="p">,</span><span class="w"> </span><span class="mi">112</span><span class="p">,</span><span class="w"> </span><span class="mi">112</span><span class="p">,</span><span class="w"> </span><span class="mi">108</span><span class="p">,</span><span class="w"> </span><span class="mi">105</span><span class="p">,</span><span class="w"> </span><span class="mi">99</span><span class="p">,</span><span class="w"> </span><span class="mi">97</span><span class="p">,</span><span class="w"> </span><span class="mi">116</span><span class="p">,</span><span class="w"> </span><span class="mi">105</span><span class="p">,</span><span class="w"> </span><span class="mi">111</span><span class="p">,</span><span class="w"> </span><span class="mi">110</span><span class="p">,</span><span class="w"> </span><span class="mi">47</span><span class="p">,</span><span class="w"> </span><span class="mi">120</span><span class="p">,</span><span class="w"> </span><span class="mi">45</span><span class="p">,</span><span class="w"> </span><span class="mi">119</span><span class="p">,</span><span class="w"> </span><span class="mi">119</span><span class="p">,</span><span class="w"> </span><span class="mi">119</span><span class="p">,</span><span class="w"> </span><span class="mi">45</span><span class="p">,</span><span class="w"> </span><span class="mi">102</span><span class="p">,</span><span class="w"> </span><span class="mi">111</span><span class="p">,</span><span class="w"> </span><span class="mi">114</span><span class="p">,</span><span class="w"> </span><span class="mi">109</span><span class="p">,</span><span class="w"> </span><span class="mi">45</span><span class="p">,</span><span class="w"> </span><span class="mi">117</span><span class="p">,</span><span class="w"> </span><span class="mi">114</span><span class="p">,</span><span class="w"> </span><span class="mi">108</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span><span class="p">,</span><span class="w"> </span><span class="mi">110</span><span class="p">,</span><span class="w"> </span><span class="mi">99</span><span class="p">,</span><span class="w"> </span><span class="mi">111</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">]),</span><span class="w"> </span><span class="p">(</span><span class="s">"content-length"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">52</span><span class="p">]),</span><span class="w"> </span><span class="p">(</span><span class="s">"date"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">84</span><span class="p">,</span><span class="w"> </span><span class="mi">104</span><span class="p">,</span><span class="w"> </span><span class="mi">117</span><span class="p">,</span><span class="w"> </span><span class="mi">44</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">70</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span><span class="p">,</span><span class="w"> </span><span class="mi">98</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">48</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">52</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">49</span><span class="p">,</span><span class="w"> </span><span class="mi">56</span><span class="p">,</span><span class="w"> </span><span class="mi">58</span><span class="p">,</span><span class="w"> </span><span class="mi">51</span><span class="p">,</span><span class="w"> </span><span class="mi">49</span><span class="p">,</span><span class="w"> </span><span class="mi">58</span><span class="p">,</span><span class="w"> </span><span class="mi">53</span><span class="p">,</span><span class="w"> </span><span class="mi">53</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">71</span><span class="p">,</span><span class="w"> </span><span class="mi">77</span><span class="p">,</span><span class="w"> </span><span class="mi">84</span><span class="p">]),</span><span class="w"> </span><span class="p">(</span><span class="s">"x-envoy-upstream-service-time"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">49</span><span class="p">])])</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">┝━</span><span class="w"> </span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mf">4.80</span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">0.05</span><span class="o">%</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="n">module</span>: <span class="s">"types"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">function</span>: <span class="s">"[method]incoming-response.consume"</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┝━</span><span class="w"> </span><span class="err">📍</span><span class="w"> </span><span class="p">[</span><span class="n">trace</span><span class="p">]</span>: <span class="nc">call</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">self_</span>: <span class="nc">Resource</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">rep</span>: <span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">state</span>: <span class="s">"borrow"</span><span class="w"> </span><span class="p">}</span>
<span class="n">TRACE</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┕━</span><span class="w"> </span><span class="err">📍</span><span class="w"> </span><span class="p">[</span><span class="n">trace</span><span class="p">]</span>: <span class="nc">return</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">result</span>: <span class="nb">Ok</span><span class="p">(</span><span class="nb">Err</span><span class="p">(()))</span>
<span class="n">ERROR</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">┕━</span><span class="w"> </span><span class="err">🚨</span><span class="w"> </span><span class="p">[</span><span class="n">error</span><span class="p">]</span>: <span class="s">"plugin error"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">error</span>: <span class="s">"Error::Other(</span><span class="se">\"</span><span class="s">body cannot be consumed</span><span class="se">\"</span><span class="s">)"</span>
<span class="n">ERROR</span><span class="w">       </span><span class="err">┝━</span><span class="w"> </span><span class="err">🚨</span><span class="w"> </span><span class="p">[</span><span class="n">error</span><span class="p">]</span>: <span class="s">"plugin execution error"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">elapsed</span>: <span class="nc">HandlerError</span><span class="p">(</span><span class="n">Error</span>::<span class="n">Other</span><span class="p">(</span><span class="s">"body cannot be consumed"</span><span class="p">))</span>
<span class="n">INFO</span><span class="w">        </span><span class="err">┝━</span><span class="w"> </span><span class="err">ｉ</span><span class="w"> </span><span class="p">[</span><span class="n">info</span><span class="p">]</span>: <span class="s">"combine decision"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">accept</span>: <span class="mf">0.0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">restrict</span>: <span class="mf">0.0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">unknown</span>: <span class="mf">1.0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">score</span>: <span class="mf">0.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">outcome</span>: <span class="s">"accepted"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">observe_only</span>: <span class="nc">true</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">tags</span>: <span class="s">"error"</span>
<span class="n">INFO</span><span class="w">        </span><span class="err">┝━</span><span class="w"> </span><span class="err">ｉ</span><span class="w"> </span><span class="p">[</span><span class="n">info</span><span class="p">]</span>: <span class="s">"process response"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">status</span>: <span class="mi">200</span>
</code></pre></div>
<p>I wondered if maybe something additional needed to happen w/ the <code>incoming-body</code> resource that I'm not doing, but I didn't see anything in the equivalent code for <code>WasiHttpView</code>'s <code>new_incoming_request</code> implementation to suggest it.</p>



<a name="422885470"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/trying%20to%20redesign%20my%20guest%20API%20to%20use%20wasi-http%20types/near/422885470" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bob Aman <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/trying.20to.20redesign.20my.20guest.20API.20to.20use.20wasi-http.20types.html#422885470">(Feb 22 2024 at 19:02)</a>:</h4>
<p>For additional context, <code>new_incoming_request</code> originates with the <code>wasmtime-wasi-http</code> dependency, while <code>new_incoming_response</code> is my own code. I was a little surprised that it didn't already exist, but maybe it's more typical for those to be coming in from an outgoing handler?</p>



<a name="422907675"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/trying%20to%20redesign%20my%20guest%20API%20to%20use%20wasi-http%20types/near/422907675" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/trying.20to.20redesign.20my.20guest.20API.20to.20use.20wasi-http.20types.html#422907675">(Feb 22 2024 at 21:28)</a>:</h4>
<p>hmm, my best guess would be that the problem is in that implementation—that somehow what you're creating doesn't support the wasi-http implementation's expectations for doing the <code>consume</code> operation on it</p>



<a name="422922856"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/trying%20to%20redesign%20my%20guest%20API%20to%20use%20wasi-http%20types/near/422922856" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bob Aman <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/trying.20to.20redesign.20my.20guest.20API.20to.20use.20wasi-http.20types.html#422922856">(Feb 22 2024 at 23:34)</a>:</h4>
<p>Yeah, that's essentially what I've been trying to do — deduce what those expectations are, since I haven't found any documentation that seems to lay it out. I've been trying to go through every piece of code I could find that touches <code>wasmtime_wasi_http::types::HostIncomingResponse</code> or <code>wasmtime_wasi_http::body::HostIncomingBody</code>, but I'm not sure I'm much closer to understanding the expectations at this point. It seems like there's a lot more documentation for consuming a body than provisioning one for consumption.</p>



<a name="423079084"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/trying%20to%20redesign%20my%20guest%20API%20to%20use%20wasi-http%20types/near/423079084" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bob Aman <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/trying.20to.20redesign.20my.20guest.20API.20to.20use.20wasi-http.20types.html#423079084">(Feb 23 2024 at 19:17)</a>:</h4>
<p>Dug in a bit further. Looking at this code snippet inside the <code>wasmtime-wasi-http</code> <code>consume()</code> implementation, a <code>body</code> value of <code>None</code>, always results in an error.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">match</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">take</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">Some</span><span class="p">(</span><span class="n">body</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">table</span><span class="p">().</span><span class="n">push</span><span class="p">(</span><span class="n">body</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="nb">Ok</span><span class="p">(</span><span class="n">id</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="nb">Err</span><span class="p">(())),</span>
<span class="p">}</span>
</code></pre></div>
<p>It looks like there were two issues that combined to make for something harder-to-debug.</p>
<ul>
<li>First, The <code>Option&lt;HostIncomingBody&gt;</code> on <code>HostIncomingResponse</code> wasn't documented and I incorrectly assumed a <code>None</code> here would represent something like a response to a <code>HEAD</code> request. Instead it seems to be an error condition, possibly used when the body was already consumed? Not sure?</li>
<li>Second, when shipping the response body through, it looks like envoy just doesn't send a response body at all. So that's a bit of a problem, and probably a mistake in my gRPC code somewhere, but it's not WASI-related.</li>
</ul>
<p>Thanks for the help!</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>