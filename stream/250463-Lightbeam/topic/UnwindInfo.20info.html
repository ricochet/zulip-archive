<html>
<head><meta charset="utf-8"><title>UnwindInfo info · Lightbeam · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/index.html">Lightbeam</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html">UnwindInfo info</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="205406922"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205406922" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205406922">(Jul 29 2020 at 20:05)</a>:</h4>
<p>Currently, <code>UnwindInfo</code> resides in the cranelift-codegen crate e.g. <a href="https://github.com/bytecodealliance/wasmtime/blob/c9a3f05afd45961b0b397f97c4ad79cd7a7c807d/cranelift/codegen/src/isa/unwind/systemv.rs#L100">https://github.com/bytecodealliance/wasmtime/blob/c9a3f05afd45961b0b397f97c4ad79cd7a7c807d/cranelift/codegen/src/isa/unwind/systemv.rs#L100</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/c9a3f05afd45961b0b397f97c4ad79cd7a7c807d/cranelift/codegen/src/isa/unwind/systemv.rs#L100" style="background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/c9a3f05afd45961b0b397f97c4ad79cd7a7c807d/cranelift/codegen/src/isa/unwind/systemv.rs#L100" title="bytecodealliance/wasmtime">bytecodealliance/wasmtime</a></div><div class="message_embed_description">Standalone JIT-style runtime for WebAssembly, using Cranelift - bytecodealliance/wasmtime</div></div></div>



<a name="205407061"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205407061" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205407061">(Jul 29 2020 at 20:06)</a>:</h4>
<p>Nothing stops to make this structures more generic to be used with other compilers</p>



<a name="205407350"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205407350" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205407350">(Jul 29 2020 at 20:09)</a>:</h4>
<p>Main issue is knowing what stack unwind info can be provided by Lightbeam, and only Lightbeam knows how registers, IP, SP are saved on the stack</p>



<a name="205407960"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205407960" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205407960">(Jul 29 2020 at 20:14)</a>:</h4>
<p>As easy hack, <code>CallFrameInstruction</code> in this file, can be made public</p>



<a name="205409105"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205409105" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Collison <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205409105">(Jul 29 2020 at 20:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="253991">Yury Delendik</span> <a href="#narrow/stream/250463-Lightbeam-UnwindInfo/topic/UnwindInfo.20info/near/205407960">said</a>:</p>
<blockquote>
<p>As easy hack, <code>CallFrameInstruction</code> in this file, can be made public</p>
</blockquote>
<p>Looks like a potential path forward, let's see what Jack has to say.</p>



<a name="205468802"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205468802" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205468802">(Jul 30 2020 at 11:56)</a>:</h4>
<p>I'm investigating exactly how this works and how Lightbeam could use it, but we will also need Wasmtime to use <code>CallFrameInstruction</code>s from both Lightbeam and Cranelift instead of only one or the other. Lightbeam is currently not quite up-to-date with the latest Wasmtime because multi-value is causing tests to fail and I don't feel comfortable merging it back in while it's still causing test failures, so if that work is done on the latest version of Wasmtime we'll have to figure out a way to backport it into the version that I've been working on (I believe the last version I merged into my branch is around a month old at this point)</p>



<a name="205470410"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205470410" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205470410">(Jul 30 2020 at 12:15)</a>:</h4>
<p>So it looks like Lightbeam will just be able to emit <code>CallFrameInstruction::Cfa(RBP, 16)</code> at the start of every function and that should be enough, right?</p>



<a name="205470694"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205470694" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205470694">(Jul 30 2020 at 12:18)</a>:</h4>
<p>Maybe we could emit <code>rsp + 8</code> at the start of the function and then <code>rsp + 16</code> after <code>push rbp</code>, but we emit the prelude at the start of every function anyway right now. We used to never emit a prelude, and I might change it in the future, but for now our backtraces should be pretty simple.</p>



<a name="205477953"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205477953" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205477953">(Jul 30 2020 at 13:26)</a>:</h4>
<p>can you post sample/typical function disassembly?</p>



<a name="205478060"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205478060" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205478060">(Jul 30 2020 at 13:27)</a>:</h4>
<p>as a hack, simple set of <code>CallFrameInstruction</code> might work, but in practice you will need to save all common registers</p>



<a name="205478569"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205478569" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205478569">(Jul 30 2020 at 13:32)</a>:</h4>
<p>(I had plans to recover vmctx from parameters based on unwind info, though it might not be feasible just yet)</p>



<a name="205480321"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205480321" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205480321">(Jul 30 2020 at 13:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="253991">Yury Delendik</span> <a href="#narrow/stream/250463-Lightbeam/topic/UnwindInfo.20info/near/205478060">said</a>:</p>
<blockquote>
<p>as a hack, simple set of <code>CallFrameInstruction</code> might work, but in practice you will need to save all common registers</p>
</blockquote>
<p>I would say that the fact that we reserve <code>rbp</code> for the stack pointer is a hack, but just generating simple <code>CallFrameInstruction</code>s doesn't sound like a hack if we know that we always generate a prelude. How do you mean that we will need to save all common registers?</p>



<a name="205480732"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205480732" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205480732">(Jul 30 2020 at 13:52)</a>:</h4>
<p>unwinders follow these instructions, starting from the moment of signal. unwinders often want to know values of specific register (as in my example)</p>



<a name="205480968"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205480968" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205480968">(Jul 30 2020 at 13:54)</a>:</h4>
<p>I never use callee-saved registers right now anyway. There's a refactor that I want to do that would make implementing saving callee-saved registers cleanly easy, but I haven't finished that refactor yet.</p>



<a name="205480980"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205480980" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205480980">(Jul 30 2020 at 13:54)</a>:</h4>
<p>FDE will help you walk the frame, but sometimes data inside of these frames is important too</p>



<a name="205481044"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205481044" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205481044">(Jul 30 2020 at 13:55)</a>:</h4>
<p>Ah, I see what you mean</p>



<a name="205481246"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205481246" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205481246">(Jul 30 2020 at 13:57)</a>:</h4>
<p>So I should be emitting <code>Expression</code>, <code>ValExpression</code>, <code>Register</code> and so forth for every instruction I emit?</p>



<a name="205481257"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205481257" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205481257">(Jul 30 2020 at 13:57)</a>:</h4>
<p>/me just saying that some effort shall be done so it will not look like a hack</p>



<a name="205481426"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205481426" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205481426">(Jul 30 2020 at 13:58)</a>:</h4>
<p>Right, exactly. I'm just trying to find where that boundary is between hack and MVP, because although I don't want it to be a hack, I don't want to implement absolutely full functionality right now because I'm the only one doing the programming on this project and there are other things I need to do.</p>



<a name="205481518"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205481518" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205481518">(Jul 30 2020 at 13:59)</a>:</h4>
<p>normally only handful of commands it needed, e.g. Cfa, Offset, maybe RememberState/RestoreState</p>



<a name="205481631"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205481631" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205481631">(Jul 30 2020 at 14:00)</a>:</h4>
<p>Should I be annotating every time the stack pointer changes, or is it enough to just tell the debugger to use <code>RBP</code>?</p>



<a name="205481869"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205481869" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205481869">(Jul 30 2020 at 14:02)</a>:</h4>
<p>Because I don't use rbp as a general-purpose register right now, I always push it at the start of the function and reserve it for the stack pointer (same reason as why I don't use callee-saved registers - I want to wait until some refactoring is done before I use it as a general-purpose register)</p>



<a name="205481952"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205481952" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205481952">(Jul 30 2020 at 14:03)</a>:</h4>
<p>/me would like to see typical output from lightbeam</p>



<a name="205482135"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205482135" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205482135">(Jul 30 2020 at 14:04)</a>:</h4>
<p>Sure, one moment</p>



<a name="205482866"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205482866" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205482866">(Jul 30 2020 at 14:10)</a>:</h4>
<p>Wasm:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$fib</span><span class="w"> </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">&quot;fib&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="cp">$p0</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">local</span><span class="w"> </span><span class="cp">$l1</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">local</span><span class="p">.</span><span class="n">set</span><span class="w"> </span><span class="cp">$l1</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">block</span><span class="w"> </span><span class="cp">$B0</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">br_if</span><span class="w"> </span><span class="cp">$B0</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="n">lt_u</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="cp">$p0</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">2</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">local</span><span class="p">.</span><span class="n">set</span><span class="w"> </span><span class="cp">$l1</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">loop</span><span class="w"> </span><span class="cp">$L1</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">local</span><span class="p">.</span><span class="n">set</span><span class="w"> </span><span class="cp">$l1</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">          </span><span class="p">(</span><span class="n">call</span><span class="w"> </span><span class="cp">$fib</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">              </span><span class="p">(</span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="cp">$p0</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span><span class="w"></span>
<span class="w">          </span><span class="p">(</span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="cp">$l1</span><span class="p">)))</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">br_if</span><span class="w"> </span><span class="cp">$L1</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="n">gt_u</span><span class="w"></span>
<span class="w">          </span><span class="p">(</span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="cp">$p0</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">              </span><span class="p">(</span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="cp">$p0</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="p">)))</span><span class="w"></span>
<span class="w">          </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">1</span><span class="p">)))))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="cp">$l1</span><span class="p">))</span><span class="w"></span>
</code></pre></div>


<p>Assembly:</p>
<div class="codehilite"><pre><span></span><code><span class="mi">131</span><span class="w"> </span><span class="n">bytes</span>:
   <span class="mi">0</span>:   <span class="mi">55</span><span class="w">                          </span><span class="n">push</span><span class="w">    </span><span class="n">rbp</span><span class="w"></span>
<span class="w">   </span><span class="mi">1</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">e5</span><span class="w">                    </span><span class="n">mov</span><span class="w"> </span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="n">rsp</span><span class="w"></span>
<span class="w">   </span><span class="mi">4</span>:   <span class="mi">40</span><span class="w"> </span><span class="mi">81</span><span class="w"> </span><span class="n">fa</span><span class="w"> </span><span class="mi">02</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">        </span><span class="n">cmp</span><span class="w"> </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">   </span><span class="n">b</span>:   <span class="mi">40</span><span class="w"> </span><span class="n">b8</span><span class="w"> </span><span class="mi">01</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">           </span><span class="n">mov</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="mi">11</span>:   <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">82</span><span class="w"> </span><span class="mi">63</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">           </span><span class="n">jb</span><span class="w">  </span><span class="mh">0x7a</span><span class="w"></span>
<span class="w">  </span><span class="mi">17</span>:   <span class="mi">40</span><span class="w"> </span><span class="n">b8</span><span class="w"> </span><span class="mi">01</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">           </span><span class="n">mov</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="mi">1</span><span class="n">d</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="n">a5</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">        </span><span class="n">lea</span><span class="w"> </span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rbp</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="mi">24</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">d1</span><span class="w">                    </span><span class="n">mov</span><span class="w"> </span><span class="n">rcx</span><span class="p">,</span><span class="w"> </span><span class="n">rdx</span><span class="w"></span>
<span class="w">  </span><span class="mi">27</span>:   <span class="mi">40</span><span class="w"> </span><span class="mi">81</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w">        </span><span class="n">add</span><span class="w"> </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="w"></span>
<span class="w">  </span><span class="mi">2</span><span class="n">e</span>:   <span class="mi">40</span><span class="w"> </span><span class="mi">52</span><span class="w">                       </span><span class="n">push</span><span class="w">    </span><span class="n">rdx</span><span class="w"></span>
<span class="w">  </span><span class="mi">30</span>:   <span class="mi">40</span><span class="w"> </span><span class="mi">50</span><span class="w">                       </span><span class="n">push</span><span class="w">    </span><span class="n">rax</span><span class="w"></span>
<span class="w">  </span><span class="mi">32</span>:   <span class="mi">40</span><span class="w"> </span><span class="mi">51</span><span class="w">                       </span><span class="n">push</span><span class="w">    </span><span class="n">rcx</span><span class="w"></span>
<span class="w">  </span><span class="mi">34</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="n">a4</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="n">f8</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w">     </span><span class="n">lea</span><span class="w"> </span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">8</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="mi">3</span><span class="n">c</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">b</span><span class="w"> </span><span class="mi">94</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">08</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">     </span><span class="n">mov</span><span class="w"> </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">8</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="mi">44</span>:   <span class="nc">e8</span><span class="w"> </span><span class="n">b7</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w">              </span><span class="n">call</span><span class="w">    </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="mi">49</span>:   <span class="mi">40</span><span class="w"> </span><span class="mi">03</span><span class="w"> </span><span class="mi">84</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">     </span><span class="n">add</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x10</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="mi">51</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">b</span><span class="w"> </span><span class="mi">8</span><span class="n">c</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">     </span><span class="n">mov</span><span class="w"> </span><span class="n">rcx</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x18</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="mi">59</span>:   <span class="mi">40</span><span class="w"> </span><span class="mi">81</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="n">fe</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w">        </span><span class="n">add</span><span class="w"> </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfffffffe</span><span class="w"></span>
<span class="w">  </span><span class="mi">60</span>:   <span class="mi">40</span><span class="w"> </span><span class="mi">81</span><span class="w"> </span><span class="n">f9</span><span class="w"> </span><span class="mi">01</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">        </span><span class="n">cmp</span><span class="w"> </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="mi">67</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">ca</span><span class="w">                    </span><span class="n">mov</span><span class="w"> </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">rcx</span><span class="w"></span>
<span class="w">  </span><span class="mi">6</span><span class="n">a</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">ec</span><span class="w">                    </span><span class="n">mov</span><span class="w"> </span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="mi">6</span><span class="n">d</span>:   <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">87</span><span class="w"> </span><span class="n">aa</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w">           </span><span class="n">ja</span><span class="w">  </span><span class="mh">0x1d</span><span class="w"></span>
<span class="w">  </span><span class="mi">73</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="n">a5</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">        </span><span class="n">lea</span><span class="w"> </span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rbp</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="mi">7</span><span class="n">a</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="n">a5</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">        </span><span class="n">lea</span><span class="w"> </span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rbp</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="mi">81</span>:   <span class="mi">5</span><span class="n">d</span><span class="w">                          </span><span class="n">pop</span><span class="w"> </span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="mi">82</span>:   <span class="nc">c3</span><span class="w">                          </span><span class="n">ret</span><span class="w"></span>
</code></pre></div>



<a name="205484190"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205484190" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205484190">(Jul 30 2020 at 14:20)</a>:</h4>
<p>so at 1, you will need to change offset of CFA, and at 4 define CFA at rbp</p>



<a name="205484431"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205484431" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205484431">(Jul 30 2020 at 14:22)</a>:</h4>
<p>Right, ok so that's what I expected. Is there anything else I'd need to do right now?</p>



<a name="205484510"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205484510" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205484510">(Jul 30 2020 at 14:23)</a>:</h4>
<p>here is what cranelift does <a href="https://gist.github.com/yurydelendik/1dc5f78bb5edc67041100d7b3b837835#file-fib-frames-dump-L20-L24">https://gist.github.com/yurydelendik/1dc5f78bb5edc67041100d7b3b837835#file-fib-frames-dump-L20-L24</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://gist.github.com/yurydelendik/1dc5f78bb5edc67041100d7b3b837835#file-fib-frames-dump-L20-L24" style="background-image: url(https://github.githubassets.com/images/modules/gists/gist-og-image.png)"></a><div class="data-container"><div class="message_embed_title"><a href="https://gist.github.com/yurydelendik/1dc5f78bb5edc67041100d7b3b837835#file-fib-frames-dump-L20-L24" title="fib.wat with cranelift">fib.wat with cranelift</a></div><div class="message_embed_description">fib.wat with cranelift. GitHub Gist: instantly share code, notes, and snippets.</div></div></div>



<a name="205484801"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205484801" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205484801">(Jul 30 2020 at 14:25)</a>:</h4>
<p>BTW my lightbeam output is</p>
<div class="codehilite"><pre><span></span><code><span class="mi">0000000000000000</span><span class="w"> </span><span class="o">&lt;</span><span class="n">__wasm_function_0</span><span class="o">&gt;</span>:
   <span class="mi">0</span>:   <span class="mi">40</span><span class="w"> </span><span class="mi">81</span><span class="w"> </span><span class="n">fa</span><span class="w"> </span><span class="mi">02</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="n">rex</span><span class="w"> </span><span class="n">cmp</span><span class="w"> </span><span class="cp">$</span><span class="mh">0x2</span><span class="p">,</span><span class="o">%</span><span class="n">edx</span><span class="w"></span>
<span class="w">   </span><span class="mi">7</span>:   <span class="mi">40</span><span class="w"> </span><span class="n">b8</span><span class="w"> </span><span class="mi">01</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">       </span><span class="n">rex</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="cp">$</span><span class="mh">0x1</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span><span class="w"></span>
<span class="w">   </span><span class="n">d</span>:   <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">82</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">       </span><span class="n">jb</span><span class="w">     </span><span class="mi">65</span><span class="w"> </span><span class="o">&lt;</span><span class="n">__wasm_function_0</span><span class="o">+</span><span class="mh">0x65</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="mi">13</span>:   <span class="mi">40</span><span class="w"> </span><span class="n">b8</span><span class="w"> </span><span class="mi">01</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">       </span><span class="n">rex</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="cp">$</span><span class="mh">0x1</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span><span class="w"></span>
<span class="w">  </span><span class="mi">19</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">d1</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rdx</span><span class="p">,</span><span class="o">%</span><span class="n">rcx</span><span class="w"></span>
<span class="w">  </span><span class="mi">1</span><span class="n">c</span>:   <span class="mi">40</span><span class="w"> </span><span class="mi">81</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w">    </span><span class="n">rex</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="cp">$</span><span class="mh">0xffffffff</span><span class="p">,</span><span class="o">%</span><span class="n">ecx</span><span class="w"></span>
<span class="w">  </span><span class="mi">23</span>:   <span class="mi">40</span><span class="w"> </span><span class="mi">52</span><span class="w">                   </span><span class="n">rex</span><span class="w"> </span><span class="n">push</span><span class="w"> </span><span class="o">%</span><span class="n">rdx</span><span class="w"></span>
<span class="w">  </span><span class="mi">25</span>:   <span class="mi">40</span><span class="w"> </span><span class="mi">50</span><span class="w">                   </span><span class="n">rex</span><span class="w"> </span><span class="n">push</span><span class="w"> </span><span class="o">%</span><span class="n">rax</span><span class="w"></span>
<span class="w">  </span><span class="mi">27</span>:   <span class="mi">40</span><span class="w"> </span><span class="mi">51</span><span class="w">                   </span><span class="n">rex</span><span class="w"> </span><span class="n">push</span><span class="w"> </span><span class="o">%</span><span class="n">rcx</span><span class="w"></span>
<span class="w">  </span><span class="mi">29</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">b</span><span class="w"> </span><span class="mi">94</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="n">mov</span><span class="w">    </span><span class="mh">0x0</span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="o">%</span><span class="n">rdx</span><span class="w"></span>
<span class="w">  </span><span class="mi">30</span>:   <span class="mi">00</span><span class="w"></span>
<span class="w">  </span><span class="mi">31</span>:   <span class="nc">e8</span><span class="w"> </span><span class="n">ca</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w">          </span><span class="n">callq</span><span class="w">  </span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;</span><span class="n">__wasm_function_0</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="mi">36</span>:   <span class="mi">40</span><span class="w"> </span><span class="mi">03</span><span class="w"> </span><span class="mi">84</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">08</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="n">rex</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span><span class="w"></span>
<span class="w">  </span><span class="mi">3</span><span class="n">d</span>:   <span class="mi">00</span><span class="w"></span>
<span class="w">  </span><span class="mi">3</span><span class="n">e</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">b</span><span class="w"> </span><span class="mi">8</span><span class="n">c</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="n">mov</span><span class="w">    </span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="o">%</span><span class="n">rcx</span><span class="w"></span>
<span class="w">  </span><span class="mi">45</span>:   <span class="mi">00</span><span class="w"></span>
<span class="w">  </span><span class="mi">46</span>:   <span class="mi">40</span><span class="w"> </span><span class="mi">81</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="n">fe</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w">    </span><span class="n">rex</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="cp">$</span><span class="mh">0xfffffffe</span><span class="p">,</span><span class="o">%</span><span class="n">ecx</span><span class="w"></span>
<span class="w">  </span><span class="mi">4</span><span class="n">d</span>:   <span class="mi">40</span><span class="w"> </span><span class="mi">81</span><span class="w"> </span><span class="n">f9</span><span class="w"> </span><span class="mi">01</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="n">rex</span><span class="w"> </span><span class="n">cmp</span><span class="w"> </span><span class="cp">$</span><span class="mh">0x1</span><span class="p">,</span><span class="o">%</span><span class="n">ecx</span><span class="w"></span>
<span class="w">  </span><span class="mi">54</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">ca</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rcx</span><span class="p">,</span><span class="o">%</span><span class="n">rdx</span><span class="w"></span>
<span class="w">  </span><span class="mi">57</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="n">a4</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="n">lea</span><span class="w">    </span><span class="mh">0x18</span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="o">%</span><span class="n">rsp</span><span class="w"></span>
<span class="w">  </span><span class="mi">5</span><span class="n">e</span>:   <span class="mi">00</span><span class="w"></span>
<span class="w">  </span><span class="mi">5</span><span class="n">f</span>:   <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">87</span><span class="w"> </span><span class="n">b4</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w">       </span><span class="n">ja</span><span class="w">     </span><span class="mi">19</span><span class="w"> </span><span class="o">&lt;</span><span class="n">__wasm_function_0</span><span class="o">+</span><span class="mh">0x19</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="mi">65</span>:   <span class="nc">c3</span><span class="w">                      </span><span class="n">retq</span><span class="w"></span>
</code></pre></div>



<a name="205485268"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205485268" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205485268">(Jul 30 2020 at 14:29)</a>:</h4>
<p>So the upstream version of Lightbeam at bytecodealliance/wasmtime generates different code to the current version that I'm using. The main difference is that the upstream version generates the prelude and resets <code>rsp</code> by doing <code>mov rsp, rbp</code>, but that's not necessary. I might actually remove the prelude again, it doesn't look like it'd be too much more difficult to generate the <code>CallFrameInstruction</code>s for the code that you've posted</p>



<a name="205485271"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205485271" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205485271">(Jul 30 2020 at 14:29)</a>:</h4>
<p>in the case above CFA needs to be offset at least after 29 and adjusted at 31/36, but preferably after each push + registers saved (since there is no dedicated frame base)</p>



<a name="205485634"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205485634" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205485634">(Jul 30 2020 at 14:32)</a>:</h4>
<p>so it you are getting rid off dedicated frame base (BP), than you will need to take care of maintaining proper CFA</p>



<a name="205485721"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205485721" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205485721">(Jul 30 2020 at 14:32)</a>:</h4>
<p>notice that CIE says it is in SP, so if SP changes you need to have CfaOffset</p>



<a name="205485762"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205485762" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205485762">(Jul 30 2020 at 14:33)</a>:</h4>
<p>/me hopes it makes sense</p>



<a name="205523416"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205523416" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205523416">(Jul 30 2020 at 19:43)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="253989">@Peter Huene</span> just to see if Windows will need more arrangements</p>



<a name="205572323"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205572323" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205572323">(Jul 31 2020 at 09:19)</a>:</h4>
<p>So now we've got an idea of how Lightbeam's side of this will work, how do you think we should go about allowing Wasmtime to consume this metadata?</p>



<a name="205590967"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205590967" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205590967">(Jul 31 2020 at 13:41)</a>:</h4>
<p>Currently lightbeam creates <code>Compilation</code> just from the (code) buffer (at crates/environ/src/lightbeam.rs). It is marked with comment at <a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/environ/src/compilation.rs#L52">https://github.com/bytecodealliance/wasmtime/blob/main/crates/environ/src/compilation.rs#L52</a> -- all generated UnwindInfo are consumed by Wasmtime if present in the <code>CompiledFunction</code></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/environ/src/compilation.rs#L52" style="background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/environ/src/compilation.rs#L52" title="bytecodealliance/wasmtime">bytecodealliance/wasmtime</a></div><div class="message_embed_description">Standalone JIT-style runtime for WebAssembly, using Cranelift - bytecodealliance/wasmtime</div></div></div>



<a name="205595250"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205595250" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205595250">(Jul 31 2020 at 14:17)</a>:</h4>
<p>I recommend to move from_buffer logic to <a href="http://lightbeam.rs">lightbeam.rs</a> and just create Compilation/CompiledFunction there with UnwindInfo generated by the lightbeam.</p>



<a name="205597627"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205597627" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205597627">(Jul 31 2020 at 14:36)</a>:</h4>
<p>to troubleshot you can use <code>wasmtime wasm2obj -g ...</code> -- it will create obj file that you can further inspect using <code>objdump -d</code> and <code>dwarfdump -debug-frame</code></p>



<a name="205810740"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/205810740" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#205810740">(Aug 03 2020 at 15:48)</a>:</h4>
<p><a href="https://github.com/bytecodealliance/wasmtime/pull/2086">https://github.com/bytecodealliance/wasmtime/pull/2086</a> addresses removal of <code>from_buffer</code></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/2086" style="background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/2086" title="Refactor where results of compilation are stored by alexcrichton · Pull Request #2086 · bytecodealliance/wasmtime">Refactor where results of compilation are stored by alexcrichton · Pull Request #2086 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">This commit refactors the internals of compilation in Wasmtime to change
where results of individual function compilation are stored. Previously
compilation resulted in many maps being returned, an...</div></div></div>



<a name="207527348"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/207527348" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#207527348">(Aug 20 2020 at 14:21)</a>:</h4>
<p>Any progress on the subject? The <a href="https://github.com/bytecodealliance/wasmtime/pull/2117">https://github.com/bytecodealliance/wasmtime/pull/2117</a> landed, will it affect unwindinfo progress?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/2117" style="background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/2117" title="wasmtime: Extract cranelift/lightbeam compilers to separate crates by alexcrichton · Pull Request #2117 · bytecodealliance/wasmtime">wasmtime: Extract cranelift/lightbeam compilers to separate crates by alexcrichton · Pull Request #2117 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">This commit extracts the two implementations of Compiler into two
separate crates, wasmtime-cranelfit and wasmtime-lightbeam. The
wasmtime-jit crate then depends on these two and instantiates them
...</div></div></div>



<a name="209493065"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/209493065" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#209493065">(Sep 09 2020 at 10:15)</a>:</h4>
<p>So to keep everyone informed, I quit Parity and it's unlikely that I will continue working on the unwind info before my last day of work. Keep this chat open though, it's very possible that Michael or Dmitriy will work on it in the future.</p>



<a name="215852377"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/250463-Lightbeam/topic/UnwindInfo%20info/near/215852377" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/250463-Lightbeam/topic/UnwindInfo.20info.html#215852377">(Nov 06 2020 at 14:26)</a>:</h4>
<p>Unwind data structures were made public at <a href="https://github.com/bytecodealliance/wasmtime/pull/2357">https://github.com/bytecodealliance/wasmtime/pull/2357</a> -- it can make life easier for the lightbeam</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/2357" style="background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/2357" title="cranelift: refactor unwind logic to accommodate multiple backends   by yurydelendik · Pull Request #2357 · bytecodealliance/wasmtime">cranelift: refactor unwind logic to accommodate multiple backends   by yurydelendik · Pull Request #2357 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">Prepares code for #2313

Make cranelift_codegen::isa::unwind::input public
Move UnwindCode&#39;s common offset field out of the structure
Make MachCompileResult::unwind_info more generic
Record ini...</div></div></div>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>