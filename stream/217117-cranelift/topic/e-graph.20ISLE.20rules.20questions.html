<html>
<head><meta charset="utf-8"><title>e-graph ISLE rules questions · cranelift · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/index.html">cranelift</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html">e-graph ISLE rules questions</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="292072035"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292072035" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292072035">(Aug 04 2022 at 21:26)</a>:</h4>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> <span class="user-mention" data-user-id="254389">@Chris Fallin</span> </p>
<p>I'm trying to add some of the div/rem opts i talked about on github, i just had a few questions on things im a bit stuck on if you dont mind:</p>
<p>would this be the overall correct way to implement the basic transform?</p>
<div class="codehilite" data-code-language="Common Lisp"><pre><span></span><code><span class="p">(</span><span class="nv">rule</span><span class="w"> </span><span class="p">(</span><span class="nv">simplify</span><span class="w"> </span><span class="p">(</span><span class="nv">udiv</span><span class="w"> </span><span class="nv">ty</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">c</span><span class="w"> </span><span class="nv">@</span><span class="w"> </span><span class="p">(</span><span class="nv">iconst</span><span class="w"> </span><span class="nv">ty</span><span class="w"> </span><span class="p">(</span><span class="nv">power_of_two</span><span class="w"> </span><span class="nv">_</span><span class="p">))))</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="nv">ushr</span><span class="w"> </span><span class="nv">ty</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">c</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
<p>I am mostly just confused on how to handle the immediate RHS value. I wrote this small extractor here: </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="k">fn</span> <span class="nf">power_of_two</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">imm</span>: <span class="nc">Imm64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Imm64</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">((</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">pow</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i64_is_power_of_two</span><span class="p">(</span><span class="n">imm</span><span class="p">.</span><span class="n">bits</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nb">Some</span><span class="p">(</span><span class="n">Imm64</span>::<span class="n">new</span><span class="p">(</span><span class="n">pow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nb">None</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>As part of <code>prelude_opt.isle</code> to extract the power of two imm. I then run <code>cargo run -- test ./filetests/filetests/egraph/algebraic.clif</code> for which i added another function below the existing one:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">div_rem_pow_2</span><span class="p">(</span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i32</span><span class="p">)</span>:
    <span class="nc">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">udiv</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="p">;</span><span class="w"> </span><span class="n">check</span>: <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ushr</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>It seems to fail however. I presume i am doing something wrong or missing something. I am also unsure if i should insert an upper bound for <code>power_of_two</code>, since the existing preopts seem to do that too.</p>



<a name="292072592"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292072592" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292072592">(Aug 04 2022 at 21:31)</a>:</h4>
<p>in particular, im not sure how to match a const on the rhs with a specific extractor, and then <em>also</em> use the value in the rewrite</p>



<a name="292072610"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292072610" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292072610">(Aug 04 2022 at 21:31)</a>:</h4>
<p><span class="user-mention" data-user-id="418736">@Riccardo D'Ambrosio</span> the general shape here looks correct. I'm not sure why the if-let on <code>i64_is_power_of_two</code>'s result matches a <code>false</code> (what does the returned tuple mean? the function definition isn't here to check). Ah, and the rule as-written will use the original 2^x constant as the shift amount, rather than x</p>



<a name="292072636"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292072636" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292072636">(Aug 04 2022 at 21:31)</a>:</h4>
<p>You'll probably want to write <code>(iconst ty (power_of_two c))</code> and then use <code>c</code> as the shift-amount</p>



<a name="292072717"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292072717" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292072717">(Aug 04 2022 at 21:32)</a>:</h4>
<p>its the function from <code>simple_preopt.rs</code>, the false is to check if the power of two is not negative</p>



<a name="292072729"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292072729" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292072729">(Aug 04 2022 at 21:32)</a>:</h4>
<p>which it should not be because this is udiv, but im not sure</p>



<a name="292072897"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292072897" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292072897">(Aug 04 2022 at 21:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="254389">Chris Fallin</span> <a href="#narrow/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions/near/292072636">said</a>:</p>
<blockquote>
<p>You'll probably want to write <code>(iconst ty (power_of_two c))</code> and then use <code>c</code> as the shift-amount</p>
</blockquote>
<p>iirc i tried that, but it complained that <code>Variable 'c' has type Imm64 but we need Id in context</code>. Which makes sense to me, but i wasn't quite sure how to put a new value into the graph and get back an ID</p>



<a name="292072940"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292072940" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292072940">(Aug 04 2022 at 21:34)</a>:</h4>
<p>ah! for that you probably want <code>(iconst ty c)</code> in the right-hand side</p>



<a name="292072969"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292072969" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292072969">(Aug 04 2022 at 21:34)</a>:</h4>
<p>(<code>iconst</code> along with the other opcodes work as both extractors and constructors in the mid-end)</p>



<a name="292072993"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292072993" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292072993">(Aug 04 2022 at 21:35)</a>:</h4>
<p>I see</p>



<a name="292073015"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292073015" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292073015">(Aug 04 2022 at 21:35)</a>:</h4>
<p>it compiles but it does not pass the test: </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">FAIL</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">egraph</span><span class="o">/</span><span class="n">algebraic</span><span class="p">.</span><span class="n">clif</span>: <span class="nc">optimize</span><span class="w"></span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="nc">filecheck</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="mi">15</span>:
    #<span class="mi">0</span><span class="w"> </span><span class="n">check</span>: <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ushr</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="o">&gt;</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">div_rem_pow_2</span><span class="p">(</span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="nc">fast</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Missed</span><span class="w"> </span>#<span class="mi">0</span>: <span class="err">\</span><span class="n">bv2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ushr</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="err">\</span><span class="n">b</span><span class="w"></span>
<span class="w">    </span><span class="o">&gt;</span><span class="w">                                 </span><span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i32</span><span class="p">)</span>:
    <span class="o">&gt;</span><span class="w">                                     </span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="o">&gt;</span><span class="w">                                     </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">udiv</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="o">&gt;</span><span class="w">                                     </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="w">    </span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="292073116"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292073116" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292073116">(Aug 04 2022 at 21:36)</a>:</h4>
<p>ok. I think I just need to look at this myself -- this stuff is literally a few days old and I'm still working out the kinks; debugging indirectly is an order of magnitude harder. But thank you for kicking the tires early :-)</p>



<a name="292073127"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292073127" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292073127">(Aug 04 2022 at 21:36)</a>:</h4>
<p>no problem <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="292073679"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292073679" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292073679">(Aug 04 2022 at 21:43)</a>:</h4>
<p>oh wait, i just noticed, that should not be an <code>iconst.i32 2</code>, i need to check for <code>v1 = iconst.i32 1</code>, tho i dont think thats the root issue</p>



<a name="292075924"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292075924" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292075924">(Aug 04 2022 at 22:06)</a>:</h4>
<p>seems like <code>udiv</code> stuff overall doesn't match, even with the existing <code>x / 1 =&gt; x</code> transform, odd</p>



<a name="292178812"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292178812" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292178812">(Aug 05 2022 at 16:39)</a>:</h4>
<p><span class="user-mention" data-user-id="254389">@Chris Fallin</span> i figured it out, <code>imul</code> maps to a <code>Pure</code> node because it cannot trap, while <code>udiv</code>/<code>sdiv</code> map to <code>Instr</code> because it could trap.  So it is not matching the Instr node.</p>



<a name="292179075"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292179075" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292179075">(Aug 05 2022 at 16:41)</a>:</h4>
<p>a possible solution i noticed is adding <code>Node::Instr</code> to the <code>ContextIter</code> handler, though i am unsure if that's what you planned to do to handle such node types</p>



<a name="292179442"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292179442" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292179442">(Aug 05 2022 at 16:44)</a>:</h4>
<p>Ah! That would do it. I suspect we might want to actually make the extractor iterate over all nodes instead (or <code>Pure</code> and <code>Inst</code> at least) for this reason, and perhaps have a way of marking a non-pure node as "deleted" when we can prove that it's safe, e.g. if we statically know the trap will never occur (this case)</p>



<a name="292179502"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292179502" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292179502">(Aug 05 2022 at 16:45)</a>:</h4>
<p>Yeah that would make sense</p>



<a name="292179534"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292179534" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292179534">(Aug 05 2022 at 16:45)</a>:</h4>
<p>thanks for tracking this down; I've been working on integrating the alias analysis then I'll likely make this change</p>



<a name="292179544"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292179544" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292179544">(Aug 05 2022 at 16:45)</a>:</h4>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="292179653"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292179653" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292179653">(Aug 05 2022 at 16:46)</a>:</h4>
<p>kinda surprised you can integrate alias analysis without this change tho haha</p>



<a name="292179732"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292179732" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292179732">(Aug 05 2022 at 16:47)</a>:</h4>
<p>then again im not quite sure how an e-graph alias analysis would look like, since alias analysis requires tracking information in multiple passes and things like that</p>



<a name="292180308"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292180308" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292180308">(Aug 05 2022 at 16:52)</a>:</h4>
<p>oh, I had been writing a special set of ctors/etors to make it work; and the analysis itself (last-store analysis) is separate</p>



<a name="292180361"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292180361" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292180361">(Aug 05 2022 at 16:52)</a>:</h4>
<p>interestingly Redundant Load Elimination can actually just fall out of the node dedup, if one defines the node identity (Hash/Eq) carefully: based on addr eclass and offset (and load type), but not specific load instruction. Store-to-load forwarding is a bit harder :-)</p>



<a name="292180546"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292180546" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292180546">(Aug 05 2022 at 16:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="254389">Chris Fallin</span> <a href="#narrow/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions/near/292180308">said</a>:</p>
<blockquote>
<p>oh, I had been writing a special set of ctors/etors to make it work; and the analysis itself (last-store analysis) is separate</p>
</blockquote>
<p>I see, what does the analysis pass run on/when? my confusion is that, wouldn't you need to run the pass at every iteration of the graph?</p>



<a name="292180669"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292180669" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292180669">(Aug 05 2022 at 16:55)</a>:</h4>
<p>No, because stores are side-effecting so always exist and will not move; the analysis happens on the CLIF before egraph build and computes a property for each load</p>



<a name="292180698"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292180698" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292180698">(Aug 05 2022 at 16:55)</a>:</h4>
<p>Oh interesting</p>



<a name="292180782"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292180782" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292180782">(Aug 05 2022 at 16:56)</a>:</h4>
<p>i imagine that might get a bit more complex though once things like unrolling are added</p>



<a name="292180817"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292180817" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292180817">(Aug 05 2022 at 16:56)</a>:</h4>
<p>If/when we want dead-store elimination that gets more complex, but DSE is quite tricky for Wasm at least because we have to get the state at any given trap point right</p>



<a name="292180855"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292180855" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292180855">(Aug 05 2022 at 16:56)</a>:</h4>
<p>I see</p>



<a name="292180885"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292180885" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292180885">(Aug 05 2022 at 16:56)</a>:</h4>
<p>unrolling falls into "control-flow opt" which is outside the scope of the egraph-based work for now -- needs more thought!</p>



<a name="292180907"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292180907" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292180907">(Aug 05 2022 at 16:57)</a>:</h4>
<p>Yeah absolutely</p>



<a name="292180997"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292180997" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292180997">(Aug 05 2022 at 16:57)</a>:</h4>
<p>there is certainly a fixpoint between at least inlining and egraph value opts (specifically: constant prop can lead to constant func ptr can lead to inlining can lead to more constant prop; important for dynamic-dispatch cases) so I do want to think more about control flow in the context of the egraph work eventually</p>



<a name="292181270"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292181270" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292181270">(Aug 05 2022 at 16:59)</a>:</h4>
<p>Yeah</p>



<a name="292181432"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292181432" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292181432">(Aug 05 2022 at 17:00)</a>:</h4>
<p>i imagine inling in an e-graph may work fairly well if the whole program is a single e-graph, since it could select between inlining and not inlining much better because it knows that inlining allowed for better optimization that outweighed the cost</p>



<a name="292181473"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292181473" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292181473">(Aug 05 2022 at 17:01)</a>:</h4>
<p>yep! and that was suggested by mwillsey over in the rfc thread actually too</p>



<a name="292181505"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292181505" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292181505">(Aug 05 2022 at 17:01)</a>:</h4>
<p>one could in theory have a bridge from the callsite to the function body also in the egraph, and let elaboration go transparently across that bridge</p>



<a name="292181635"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292181635" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292181635">(Aug 05 2022 at 17:02)</a>:</h4>
<p>Right, i noticed some talk about whether everything should be a single e-graph or not, but i forget what the final decision was/if there was one</p>



<a name="292181642"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292181642" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292181642">(Aug 05 2022 at 17:02)</a>:</h4>
<p>it gets a bit trickier once one wants to optimize though: fundamentally the different inlined bodies want to diverge sometimes. so some sort of cloning is needed</p>



<a name="292181669"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292181669" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292181669">(Aug 05 2022 at 17:02)</a>:</h4>
<p>for now it's a big architectural change (everything in Cranelift assumes per-function compilation) so it's more of a "future thoughts" sort of thing</p>



<a name="292181696"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292181696" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292181696">(Aug 05 2022 at 17:03)</a>:</h4>
<p>everything being one graph sounds awesome for memory usage since e-graphs are great at sharing</p>



<a name="292181704"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292181704" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292181704">(Aug 05 2022 at 17:03)</a>:</h4>
<p>but more complex as well</p>



<a name="292181721"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292181721" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292181721">(Aug 05 2022 at 17:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="254389">Chris Fallin</span> <a href="#narrow/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions/near/292181669">said</a>:</p>
<blockquote>
<p>for now it's a big architectural change (everything in Cranelift assumes per-function compilation) so it's more of a "future thoughts" sort of thing</p>
</blockquote>
<p>Ah ok</p>



<a name="292182350"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292182350" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292182350">(Aug 05 2022 at 17:08)</a>:</h4>
<p>btw, does cranelift have a concept of NSW/NUW? i.e. ops which assume overflow does not happen. I know that condition is required for a significant amount of optimizations in llvm</p>



<a name="292182473"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292182473" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292182473">(Aug 05 2022 at 17:09)</a>:</h4>
<p>nope; that actually came up somewhere here a bit ago when I was looking at address-computation code</p>



<a name="292182581"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292182581" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292182581">(Aug 05 2022 at 17:10)</a>:</h4>
<p>the major issue with that is it introduces semantically undefined behavior, which is a notorious correctness footgun; it's better, all other things equal, to fully define the output for every set of inputs</p>



<a name="292182591"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292182591" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292182591">(Aug 05 2022 at 17:10)</a>:</h4>
<p>Yeah it's required for things like optimizing out bounds checks</p>



<a name="292182603"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292182603" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292182603">(Aug 05 2022 at 17:10)</a>:</h4>
<p>Yeah true</p>



<a name="292182631"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292182631" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292182631">(Aug 05 2022 at 17:10)</a>:</h4>
<p>I suspect that there may be cases where we can instead encode the knowledge in the types, or ... basically I want to find a way around adding it</p>



<a name="292182643"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292182643" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292182643">(Aug 05 2022 at 17:11)</a>:</h4>
<p>but this, too, needs more thought</p>



<a name="292182656"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292182656" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292182656">(Aug 05 2022 at 17:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="418736">Riccardo D'Ambrosio</span> <a href="#narrow/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions/near/292182591">said</a>:</p>
<blockquote>
<p>Yeah it's required for things like optimizing out bounds checks</p>
</blockquote>
<p>well, to some degree, llvm has to also prove the condition does not overflow before optimizing it out</p>



<a name="292182787"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292182787" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292182787">(Aug 05 2022 at 17:12)</a>:</h4>
<p>This presentation by the llvm devs on how they optimize out math-based conditions was very interesting <a href="https://www.youtube.com/watch?v=1hm5ZVmBEvo">YouTube - 2021 LLVM Dev Mtg “A New Approach to Removing Redundant Conditions in LLVM”</a></p>
<div class="youtube-video message_inline_image"><a data-id="1hm5ZVmBEvo" href="https://www.youtube.com/watch?v=1hm5ZVmBEvo"><img src="https://uploads.zulipusercontent.net/e12ab907d6c0a67322a2f4bf8c67868c7b6bdb02/68747470733a2f2f692e7974696d672e636f6d2f76692f31686d355a566d4245766f2f64656661756c742e6a7067"></a></div>



<a name="292182802"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292182802" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292182802">(Aug 05 2022 at 17:12)</a>:</h4>
<p>right, so for example a range-analysis could drive a rule that widens adds or removes uextends or whatever when the wraparound behavior can't be hit</p>



<a name="292182816"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292182816" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292182816">(Aug 05 2022 at 17:12)</a>:</h4>
<p>cool, I'll add that to my queue, thanks!</p>



<a name="292182837"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292182837" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292182837">(Aug 05 2022 at 17:12)</a>:</h4>
<p>I was wondering at some point if its possible to do it using e-graphs by tracking invariants using <code>egg::Analysis</code>-like things, but i never explored it a lot</p>



<a name="292182891"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292182891" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292182891">(Aug 05 2022 at 17:13)</a>:</h4>
<p>range analysis should definitely be possible to build using such a framework</p>



<a name="292182898"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292182898" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292182898">(Aug 05 2022 at 17:13)</a>:</h4>
<p>because it requires storing a variable amount of invariants for each node/eclass, which is difficult to manage, allocation-optimization-wise</p>



<a name="292182938"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292182938" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292182938">(Aug 05 2022 at 17:13)</a>:</h4>
<p>and it uses fourier-motzkin elimination to check the invariants, which is probably possible in a constructor, but it needs more thought</p>



<a name="292183183"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292183183" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292183183">(Aug 05 2022 at 17:15)</a>:</h4>
<p>if it doesn't explode the number of invariants kept, it's probably possible to store just an id into a bump-allocator or something</p>



<a name="292183712"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292183712" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292183712">(Aug 05 2022 at 17:20)</a>:</h4>
<p>hmm, I guess I've envisioned range analysis as something much simpler: if the analysis domain allows just a single integer range (open-ended or closed on both sides) then it's constant space per value, no?</p>



<a name="292183762"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292183762" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292183762">(Aug 05 2022 at 17:20)</a>:</h4>
<p>my concern is mainly that it might widely increase memory usage as optimization proceeds, because data is associated with every eclass, so you may end up having to allocate a lot of invariants, especially if you support a variable amount of range invariants per class</p>



<a name="292183803"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292183803" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292183803">(Aug 05 2022 at 17:21)</a>:</h4>
<p>this seems sufficient for something like eliminating overflow cases: if we can carry the fact that x \in [0, 4095) or whatever then we can use that, and we can propagate these through a number of binary operators too</p>



<a name="292183913"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292183913" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292183913">(Aug 05 2022 at 17:22)</a>:</h4>
<p>Yeah that's true, a simple single-range system might work fairly well as a starting experiment</p>



<a name="292183959"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292183959" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292183959">(Aug 05 2022 at 17:22)</a>:</h4>
<p>anything that involves solving more complex systems (variable number of constraints etc) I think would probably not be practical in our compilation-time envelope, though I would be curious to see what use-cases/applications of that you had in mind</p>



<a name="292183978"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292183978" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292183978">(Aug 05 2022 at 17:22)</a>:</h4>
<p>Yeah i think it's probably out of scope for cranelift</p>



<a name="292184101"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292184101" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292184101">(Aug 05 2022 at 17:23)</a>:</h4>
<p>Im writing a shader language, and naturally, the core of optimizing shaders is optimizing the math to hell and back, which is why im exploring e-graphs, since from simple experiments, they work unbelievably well for this task, i had this wild optimization my experiment did a while back:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mf">2.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">2.0</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">3.0</span><span class="p">)</span><span class="w"> </span><span class="o">---</span>-&gt; <span class="nc">fma</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">neg</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="n">fma</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">recip</span><span class="p">(</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="mi">5</span><span class="p">))</span><span class="w"></span>
<span class="n">Cost</span>: <span class="mf">26.5</span><span class="w"> </span>-&gt; <span class="mi">12</span><span class="w"></span>
</code></pre></div>



<a name="292184186"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292184186" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292184186">(Aug 05 2022 at 17:24)</a>:</h4>
<p>However, one intricacy about shader optimization is that some transforms only work on normalized vectors/floats, so i must track that invariant somehow</p>



<a name="292184211"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292184211" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292184211">(Aug 05 2022 at 17:24)</a>:</h4>
<p>interesting, that's pretty cool</p>



<a name="292184243"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292184243" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292184243">(Aug 05 2022 at 17:25)</a>:</h4>
<p>this is definitely a case where more expensive analysis is warranted</p>



<a name="292184274"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292184274" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292184274">(Aug 05 2022 at 17:25)</a>:</h4>
<p>i think a single range associated with each eclass may work, i probably won't have indexing conditions that require disjoint ranges</p>



<a name="292184387"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292184387" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292184387">(Aug 05 2022 at 17:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="254389">Chris Fallin</span> <a href="#narrow/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions/near/292184243">said</a>:</p>
<blockquote>
<p>this is definitely a case where more expensive analysis is warranted</p>
</blockquote>
<p>To some degree i actually think using e-graphs <em>vastly</em> simplifies my job, since the e-graph can propagate invariants for me really easily. I just have to store the invariants efficiently and write rules that check them</p>



<a name="292184585"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292184585" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292184585">(Aug 05 2022 at 17:28)</a>:</h4>
<p>though i have an RVSDG-based IR also, so im not solely working off the e-graph, which allows me to do some analyses much easier, to then propagate those results into the egraph</p>



<a name="292184869"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292184869" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292184869">(Aug 05 2022 at 17:31)</a>:</h4>
<p>another analysis which might work very well with egraphs is scalar evolution (thats what llvm calls it), which builds a "chain of recurrences" to describe how a loop calculates its next result, i.e. how it evolves. An e-graph that knows about such info might be able to make really good inferences about moving out or transforming things inside the loop</p>



<a name="292184931"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292184931" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292184931">(Aug 05 2022 at 17:31)</a>:</h4>
<p>yup, that's a really good point</p>



<a name="292185084"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292185084" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292185084">(Aug 05 2022 at 17:33)</a>:</h4>
<p>its probably also possible to piggyback off the CR for LICM, any recurrence not directly associated with an induction variable can be moved out</p>



<a name="292185214"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292185214" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292185214">(Aug 05 2022 at 17:34)</a>:</h4>
<p>not sure if you are familiar with chains of recurrences, but this article breaks it down fairly well <a href="https://kristerw.blogspot.com/2019/04/how-llvm-optimizes-geometric-sums.html">https://kristerw.blogspot.com/2019/04/how-llvm-optimizes-geometric-sums.html</a></p>



<a name="292185257"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292185257" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292185257">(Aug 05 2022 at 17:35)</a>:</h4>
<p>i'm unsure of how expensive of an analysis it actually is however</p>



<a name="292185293"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292185293" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292185293">(Aug 05 2022 at 17:35)</a>:</h4>
<p>yep, I've looked at the general idea before. there's certainly a lot we could do here</p>



<a name="292185396"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292185396" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292185396">(Aug 05 2022 at 17:36)</a>:</h4>
<p>one thing I want to be a little careful of avoiding is actually introducing loops into the egraph; right now blockparams (hence part of the path for any recurrence) are terminals (nodes without children)</p>



<a name="292185397"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292185397" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292185397">(Aug 05 2022 at 17:36)</a>:</h4>
<p>Yeah, i imagine they play a somewhat significant part in performance for some programs</p>



<a name="292185423"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292185423" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292185423">(Aug 05 2022 at 17:36)</a>:</h4>
<p>I see</p>



<a name="292185443"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292185443" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292185443">(Aug 05 2022 at 17:36)</a>:</h4>
<p>but perhaps there's a way of giving rules access to preds/inputs without actually wiring up the dataflow (a separate extractor, etc)</p>



<a name="292185470"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292185470" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292185470">(Aug 05 2022 at 17:36)</a>:</h4>
<p>could loops perhaps be special <code>Loop</code> nodes?</p>



<a name="292185479"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292185479" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292185479">(Aug 05 2022 at 17:36)</a>:</h4>
<p>so, this, too, "needs more thought" (sorry that's becoming my frequent refrain :-) )</p>



<a name="292185517"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292185517" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292185517">(Aug 05 2022 at 17:37)</a>:</h4>
<p>that gets hairy really quickly. I looked at more structured forms of graph IR (RVSDGs etc) but the issue is going into and out of it from the CFG world on either end</p>



<a name="292185531"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292185531" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292185531">(Aug 05 2022 at 17:37)</a>:</h4>
<p>hehe, yeah, i feel like this is mostly uncharted waters</p>



<a name="292185570"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292185570" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292185570">(Aug 05 2022 at 17:37)</a>:</h4>
<p>hmm, yeah</p>



<a name="292185584"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292185584" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292185584">(Aug 05 2022 at 17:38)</a>:</h4>
<p>so for now I keep the CFG in the "side-effect skeleton" and avoid completely any questions of reasoning about CFG-related patterns, but perhaps there's something we could do</p>



<a name="292185670"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292185670" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292185670">(Aug 05 2022 at 17:38)</a>:</h4>
<p>at least an overlay (a node representing "this is a loop and these are the recurrent inputs") that doesn't feed into the lowering-back-out but can be used to match</p>



<a name="292185678"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292185678" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292185678">(Aug 05 2022 at 17:38)</a>:</h4>
<p>couldn't loop outputs be treated as opaque variables? like variables used in more than one place</p>



<a name="292185774"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292185774" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292185774">(Aug 05 2022 at 17:39)</a>:</h4>
<p>inputs you mean? or specifically outputs?</p>



<a name="292185833"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292185833" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292185833">(Aug 05 2022 at 17:40)</a>:</h4>
<p>uhhh, mostly outputs, but maybe it could apply to inputs too? idk haha</p>



<a name="292185894"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292185894" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292185894">(Aug 05 2022 at 17:40)</a>:</h4>
<p>kind of like how RVSDG has input and output edges for loop nodes</p>



<a name="292186005"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292186005" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292186005">(Aug 05 2022 at 17:41)</a>:</h4>
<p>in general, what are the issues with treating structured control flow as special nodes if you know they fit a particular control flow pattern like looping or switching/branching?</p>



<a name="292186072"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292186072" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292186072">(Aug 05 2022 at 17:41)</a>:</h4>
<p>I guess the main issue I was trying to avoid was fitting <em>all</em> control flow into that form; we have to be able to accept arbitrary CFGs as input and I don't want a Relooper-like algorithm</p>



<a name="292186126"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292186126" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292186126">(Aug 05 2022 at 17:42)</a>:</h4>
<p>Yeah absolutely</p>



<a name="292186183"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292186183" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292186183">(Aug 05 2022 at 17:42)</a>:</h4>
<p>so then there's a question of how to mix the two; an overlay node for informational purposes only seems totally reasonable, as long as the control flow <em>also</em> exists in the current blockparam nodes and side-effecting skeleton</p>



<a name="292186239"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292186239" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292186239">(Aug 05 2022 at 17:43)</a>:</h4>
<p>Yeah it needs some way of combining both unstructured control flow, and structured control flow known to fit some pattern</p>



<a name="292186521"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292186521" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292186521">(Aug 05 2022 at 17:45)</a>:</h4>
<p>ok, I am going to disappear from this conversation for a bit to get some hacking done :-) but thanks for all the ideas, I'll keep chewing on this</p>



<a name="292186542"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292186542" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292186542">(Aug 05 2022 at 17:45)</a>:</h4>
<p>bye <span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span></p>



<a name="292428002"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292428002" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292428002">(Aug 08 2022 at 16:49)</a>:</h4>
<p>noticed PR seems to now support inst nodes, i'll try to add the div/rem transforms now</p>



<a name="292428180"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292428180" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292428180">(Aug 08 2022 at 16:51)</a>:</h4>
<p>most of the hard work seems to already be done from simple_preopt so i hope it won't be too bad</p>



<a name="292428220"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292428220" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292428220">(Aug 08 2022 at 16:51)</a>:</h4>
<p>also, has there been any thought on being able to mark certain ISLE rules as bidirectional? it's helpful for some rules</p>



<a name="292428403"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292428403" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292428403">(Aug 08 2022 at 16:52)</a>:</h4>
<p>for example, <code>x * 2</code> &lt;---&gt; <code>x &gt;&gt; 1</code> which could help in discovering other transforms based on the mul</p>



<a name="292428467"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292428467" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292428467">(Aug 08 2022 at 16:53)</a>:</h4>
<p>the bidirectional thing is interesting but I would want to be a bit careful with this as it would be easy to produce a lot of blowup</p>



<a name="292428549"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292428549" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292428549">(Aug 08 2022 at 16:53)</a>:</h4>
<p>Yes absolutely, from my experiments it seems that rules that allow the optimizer to create random terms are <em>really</em> bad, not sure what i expected tho...</p>



<a name="292428668"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292428668" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292428668">(Aug 08 2022 at 16:54)</a>:</h4>
<p>in general I think I need to nail down some "rules for rules" more precisely -- something like layering for forward-progress guarantees</p>



<a name="292428682"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292428682" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292428682">(Aug 08 2022 at 16:54)</a>:</h4>
<p>Yeah totally</p>



<a name="292428716"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292428716" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292428716">(Aug 08 2022 at 16:54)</a>:</h4>
<p>I've found it not too hard to accidentally create a generative loop, and because we don't do full eq-sat we end up creating an infinite chain of union nodes instead</p>



<a name="292428734"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292428734" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292428734">(Aug 08 2022 at 16:54)</a>:</h4>
<p>associativity/commutativity rules are an interesting case specifically</p>



<a name="292428797"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292428797" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292428797">(Aug 08 2022 at 16:55)</a>:</h4>
<p>but in limited cases ("either of these two nodes creates the other automatically") I agree some sort of syntax sugar for one rule to become two might be useful</p>



<a name="292428824"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292428824" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292428824">(Aug 08 2022 at 16:55)</a>:</h4>
<p>Yeah, and you dont do exponential backoff either, so it's a recipe for disaster haha</p>



<a name="292428834"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292428834" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292428834">(Aug 08 2022 at 16:55)</a>:</h4>
<p>associativity/commutativity scare me a bit because it's easy to get combinatorial blowup</p>



<a name="292428877"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292428877" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292428877">(Aug 08 2022 at 16:55)</a>:</h4>
<p>yeah i never really decided on an approach to standardize how they would work so they dont end up dominating rewrite time</p>



<a name="292428936"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292428936" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292428936">(Aug 08 2022 at 16:56)</a>:</h4>
<p>so for now what I'm doing is having two forms of each rule (in cprop for example) for commutativity, and some rules that try to reassociate in certain cases for cprop and licm</p>



<a name="292464447"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292464447" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292464447">(Aug 08 2022 at 17:00)</a>:</h4>
<p>makes sense, although i think such rewrite rules are very helpful once u have simplifications that can take multiple terms, such as FMA (<code>a * b + c</code> -&gt; <code>fma(a, b, c)</code>). Though this might not be a problem for cranelift</p>



<a name="292464588"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292464588" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292464588">(Aug 08 2022 at 17:00)</a>:</h4>
<p>maybe doing some sort of marking to avoid one associative rewrite from happening infinitely many times, idk</p>



<a name="292465167"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292465167" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292465167">(Aug 08 2022 at 17:05)</a>:</h4>
<p>This is another problem with bidirectional rules, something like an FMA rewrite can result in infinite loops. And im not quite sure that its possible to avoid such a problem without having a way to make the rewriter realize that it already went through such a rewrite</p>



<a name="292465423"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292465423" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292465423">(Aug 08 2022 at 17:07)</a>:</h4>
<p>right, the interning/dedup is important there. over the weekend I did some hacking on the aegraph implementation to do hash/eq on nodes based on a "canonical id" which is different from the "latest id" (pointing to the whole tree of union nodes) that should help in that regard...</p>



<a name="292465500"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292465500" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292465500">(Aug 08 2022 at 17:08)</a>:</h4>
<p>one still has to be careful about truly generative rules of course</p>



<a name="292465510"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292465510" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292465510">(Aug 08 2022 at 17:08)</a>:</h4>
<p>Yeah</p>



<a name="292465612"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292465612" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292465612">(Aug 08 2022 at 17:09)</a>:</h4>
<p>it might also be possible to order the rules in a way where actually "meaningful" rewrites are tried first, but doing that automatically seems challenging</p>



<a name="292466122"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292466122" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292466122">(Aug 08 2022 at 17:13)</a>:</h4>
<p>yeah, what I'm finding is that there's a good amount of tweaking/engineering that goes into this if one wants to make it performant on par with a handwritten pass</p>



<a name="292466165"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292466165" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292466165">(Aug 08 2022 at 17:13)</a>:</h4>
<p>it's still better than actually writing a pass by hand! but I'm thinking we'll want to invest in tooling to show what's going on maybe, or at least write down some guidelines</p>



<a name="292466722"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292466722" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292466722">(Aug 08 2022 at 17:18)</a>:</h4>
<p>yeah, especially with no full eq-sat it might be easy for a contributor to accidentally create hard to debug infinite loops</p>



<a name="292489261"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292489261" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292489261">(Aug 08 2022 at 20:03)</a>:</h4>
<p>Another random thought i had, e-graphs might make it really easy to implement at least basic SLP vectorization, assuming the optimizer can figure out how to potentially reorder statements to allow this to happen</p>



<a name="292491254"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292491254" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292491254">(Aug 08 2022 at 20:20)</a>:</h4>
<p>Hmm seems like inst nodes still don't match, i think the issue now is that there is only a single constructor, and that is for pure enodes. Though im unsure of how to solve this since constructing an inst node requires a sourceloc as well, so the sourceloc value has to be either passed transparently through the rewrite somehow, or matched in the rule</p>



<a name="292491844"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292491844" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292491844">(Aug 08 2022 at 20:25)</a>:</h4>
<p>Yeah, you're hitting a very "under construction" bit of code again</p>



<a name="292491937"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292491937" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292491937">(Aug 08 2022 at 20:26)</a>:</h4>
<p>right now my focus has been on pure nodes as reasoning about merging and code motion with side-effects is quite a bit more complex</p>



<a name="292499012"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292499012" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292499012">(Aug 08 2022 at 21:28)</a>:</h4>
<p>makes sense</p>



<a name="292499054"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292499054" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292499054">(Aug 08 2022 at 21:29)</a>:</h4>
<p>i kind of wonder if it might be possible to do something similar to what RVSDG does for solving the side effect problem with graphs</p>



<a name="292499096"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292499096" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292499096">(Aug 08 2022 at 21:29)</a>:</h4>
<p>where you have edges for every side-effectful op and they connect together to form an ordering constraint for what ops must run before/after</p>



<a name="292682476"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292682476" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jamey Sharp <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292682476">(Aug 10 2022 at 01:32)</a>:</h4>
<p>I'm late to the conversation but Riccardo, your project sounds cool! I did experiments a few months ago on manipulating RVSDGs in e-graphs (<a href="https://github.com/jameysharp/optir">https://github.com/jameysharp/optir</a>), if you want to see a way you can do full control-flow inside your e-graph. Cranelift isn't going that direction because the trade-offs are different but I bet it'd expose more opportunities in a shader compiler. regarding the earlier conversation about inlining: I found it's especially neat in e-graphs because you can optimize call sites based on information you learn from inlining, but then still decide not to inline; that doesn't change the fact that Cranelift isn't designed for that, but I think it makes the potential future gains from this work bigger.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/jameysharp/optir" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/61387605f7a7db4b28e1cbd8ffb33b8b073ce0ec\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f623436613638323539396630623966666134643861663566613331303637636639366434633037663566613663303832336464393239363661636630323366392f6a616d657973686172702f6f70746972)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/jameysharp/optir" title="GitHub - jameysharp/optir: Compiler optimizer for arbitrary control flow based on equality saturation">GitHub - jameysharp/optir: Compiler optimizer for arbitrary control flow based on equality saturation</a></div><div class="message_embed_description">Compiler optimizer for arbitrary control flow based on equality saturation - GitHub - jameysharp/optir: Compiler optimizer for arbitrary control flow based on equality saturation</div></div></div>



<a name="292687683"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292687683" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292687683">(Aug 10 2022 at 03:12)</a>:</h4>
<p><span class="user-mention" data-user-id="504918">@Jamey Sharp</span> oh hey i read optir a lot to check out ideas! awesome. I was a little confused in some areas but i got the general gist and it inspired me to try RVSDG + egraphs even more. Im interested in e-graphs mostly for superoptimizing math, since shaders are just blobs of math, and float math is criminally underoptimized, especially trigonometry. Inlining is something i'd like to explore a bit more fine-grained, my current (and potentially final) approach is to just recursively inline <em>everything</em> and optimize a single graph for each shader entry point. Reason being that shaders don't exactly have true function calls, and literally every single gpu compiler on the planet inlines everything it can get away with, even CUDA compilers. Especially when it comes to math and optimizing math across functions. But maybe it would be cool to let e-graphs drive cross-function discovery to choose whether to inline or decide to treat it as "opaque" for optimization purposes</p>



<a name="292687846"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292687846" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292687846">(Aug 10 2022 at 03:15)</a>:</h4>
<p>the timing of cranelift's e-graphs RFC could not have been more perfect <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="292687938"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292687938" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292687938">(Aug 10 2022 at 03:17)</a>:</h4>
<p>in particular i think RVSDG + e-graphs could help tremendously for cases where the ordering of actual operations doesnt matter, only how they are connected together</p>



<a name="292687989"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292687989" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292687989">(Aug 10 2022 at 03:18)</a>:</h4>
<p>and once u think about it, this fits <em>so many</em> optimizations, even something pretty complex like superword level parallelism</p>



<a name="292688051"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292688051" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292688051">(Aug 10 2022 at 03:19)</a>:</h4>
<p>so i think it's the perfect combination once it can be explored more in depth, RVSDG excels at the "large bits", analyzing how things connect, things like that. And e-graphs excel at discovering the smaller bits and how they can be potentially rewritten to be better</p>



<a name="292820606"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292820606" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jamey Sharp <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292820606">(Aug 10 2022 at 19:40)</a>:</h4>
<p>I think there are also interesting opportunities with noticing that different expressions of control-flow are equivalent. I didn't previously have any intraprocedural examples where e-graphs help with that, but the link you shared last week about "How LLVM optimizes power sums" is a good one: for small loop counts, the closed-form loop-free version may take longer than the simpler loop. doing that transformation on an e-graph means you can defer the decision about whether it's profitable until you've reached saturation, at which point your cost function may have more information to work with. like with inlining, it also allows surrounding code to be improved based on information learned from the power-sum analysis, even if the later decision is to emit a loop after all.<br>
and yeah, I agree that there are a ton of interesting directions to go, various kinds of parallelism definitely included! I think the general criterion for "would an e-graph help here" is: are you sure this transformation is an improvement in all cases? if not, an e-graph is great, and I think most optimizations have this kind of uncertainty. (although I think it'd be nice if egg provided some better support for pruning alternatives if you do know they're always worse; the way egg's examples do constant-folding seems like it's a foot-gun without some more restricted API.)<br>
on the other hand I think you're right that for shaders you should just always inline everything.</p>



<a name="292832775"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/e-graph%20ISLE%20rules%20questions/near/292832775" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/e-graph.20ISLE.20rules.20questions.html#292832775">(Aug 10 2022 at 21:03)</a>:</h4>
<p>Yeah, shaders in particular make it easier to do certain things, for example, its rarely not profitable to unroll a loop unless its a really big loop.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>