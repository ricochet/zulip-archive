<html>
<head><meta charset="utf-8"><title>ValueUseState::Multiple and multi-result instructions · cranelift · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/index.html">cranelift</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html">ValueUseState::Multiple and multi-result instructions</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="462833578"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462833578" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462833578">(Aug 16 2024 at 18:00)</a>:</h4>
<p>I'm curious to explore some 128-bit stuff a bit and right now I'm looking at input such as:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span><span class="p">:</span><span class="mi">0</span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="n">tail</span><span class="w"> </span><span class="p">{</span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">):</span>
<span class="w">    </span><span class="nc">v10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v0</span>
<span class="w">    </span><span class="n">v18</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uextend</span><span class="p">.</span><span class="kt">i128</span><span class="w"> </span><span class="n">v1</span>
<span class="w">    </span><span class="n">v20</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uextend</span><span class="p">.</span><span class="kt">i128</span><span class="w"> </span><span class="n">v10</span>
<span class="w">    </span><span class="n">v14</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v18</span><span class="p">,</span><span class="w"> </span><span class="n">v20</span>
<span class="w">    </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isplit</span><span class="w"> </span><span class="n">v14</span>
<span class="w">    </span><span class="n">jump</span><span class="w"> </span><span class="n">block1</span>

<span class="n">block1</span><span class="p">:</span>
<span class="w">    </span><span class="nc">return</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v16</span>
<span class="p">}</span>
</code></pre></div>
<p>which after <a href="https://github.com/bytecodealliance/wasmtime/pull/9136">https://github.com/bytecodealliance/wasmtime/pull/9136</a> produces:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">   </span><span class="mi">0</span><span class="p">:</span><span class="w">   </span><span class="mi">55</span><span class="w">                      </span><span class="n">pushq</span><span class="w">   </span><span class="o">%</span><span class="n">rbp</span>
<span class="w">   </span><span class="mi">1</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">e5</span><span class="w">                </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span>
<span class="w">   </span><span class="mi">4</span><span class="p">:</span><span class="w">   </span><span class="mi">4</span><span class="n">c</span><span class="w"> </span><span class="mi">8</span><span class="n">b</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w">                </span><span class="n">movq</span><span class="w">    </span><span class="p">(</span><span class="o">%</span><span class="n">rdi</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">r9</span>
<span class="w">   </span><span class="mi">7</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="n">c9</span><span class="w">                </span><span class="n">xorq</span><span class="w">    </span><span class="o">%</span><span class="n">rcx</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rcx</span>
<span class="w">   </span><span class="n">a</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">f0</span><span class="w">                </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rsi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rax</span>
<span class="w">   </span><span class="n">d</span><span class="p">:</span><span class="w">   </span><span class="mi">4</span><span class="n">c</span><span class="w"> </span><span class="mi">01</span><span class="w"> </span><span class="n">c8</span><span class="w">                </span><span class="n">addq</span><span class="w">    </span><span class="o">%</span><span class="n">r9</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rax</span>
<span class="w">  </span><span class="mi">10</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">83</span><span class="w"> </span><span class="n">d1</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">adcq</span><span class="w">    </span><span class="cp">$</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rcx</span>
<span class="w">  </span><span class="mi">14</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">ec</span><span class="w">                </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span>
<span class="w">  </span><span class="mi">17</span><span class="p">:</span><span class="w">   </span><span class="mi">5</span><span class="n">d</span><span class="w">                      </span><span class="n">popq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span>
<span class="w">  </span><span class="mi">18</span><span class="p">:</span><span class="w">   </span><span class="nc">c3</span><span class="w">                      </span><span class="n">retq</span>
</code></pre></div>
<p>notably what I'm trying to get happen is to sink the <code>movq    (%rdi), %r9</code> into <code>addq    %r9, %rax</code>. Currently the sinking is being prevented by <a href="https://github.com/bytecodealliance/wasmtime/blob/3f5c21bff4babe54f51deceed1bb1d3321b6f2aa/cranelift/codegen/src/machinst/lower.rs#L539-L542">this line</a> but I don't fully understand the comment there. It seems like if this heuristic is needed then it's probably a conservative one because load sinking should be ok in this specific scenario at least. </p>
<p>Which leads me to my question: could this <code>force_multiple</code> be explained a bit more? Is there an example of how this could go wrong if <code>force_multiple</code> were ignored? (if I set it to <code>false</code> unconditionally no filetests break so I wasn't able to learn more via that). Furthermore is there a way to perhaps make this check less conservative to allow load sinking in the above case?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/9136" style="background-image: url(&quot;https://uploads.zulipusercontent.net/44c4d813ab24f1308ad56060b4912f220aafe8f2/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f633238326138623463303062643035323866663730666661366163306236643866356634653564666636653766393931313834303264366638623533623365642f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f39313336&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/9136" title="Implement a few minor optimizations around 128-bit integers by alexcrichton · Pull Request #9136 · bytecodealliance/wasmtime">Implement a few minor optimizations around 128-bit integers by alexcrichton · Pull Request #9136 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">This commit implements a few minor changes for i128 in both the egraph optimizations and lowerings for x64. The optimization pass will now transform iconcat into a uextend or sextend where appropri...</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/3f5c21bff4babe54f51deceed1bb1d3321b6f2aa/cranelift/codegen/src/machinst/lower.rs#L539-L542" style="background-image: url(&quot;https://uploads.zulipusercontent.net/94756e259a6e0e4d169e20e7601bc20887d37224/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f363435633462323633376132323762663061346535393932666565366563303036616632383761326132333966303836346634613937666662303266383663662f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/3f5c21bff4babe54f51deceed1bb1d3321b6f2aa/cranelift/codegen/src/machinst/lower.rs#L539-L542" title="wasmtime/cranelift/codegen/src/machinst/lower.rs at 3f5c21bff4babe54f51deceed1bb1d3321b6f2aa · bytecodealliance/wasmtime">wasmtime/cranelift/codegen/src/machinst/lower.rs at 3f5c21bff4babe54f51deceed1bb1d3321b6f2aa · bytecodealliance/wasmtime</a></div><div class="message_embed_description">A fast and secure runtime for WebAssembly. Contribute to bytecodealliance/wasmtime development by creating an account on GitHub.</div></div></div>



<a name="462833974"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462833974" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462833974">(Aug 16 2024 at 18:03)</a>:</h4>
<p>blame says it is a fix for <a href="https://github.com/bytecodealliance/wasmtime/issues/3953">https://github.com/bytecodealliance/wasmtime/issues/3953</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/issues/3953" style="background-image: url(&quot;https://uploads.zulipusercontent.net/24a48bea30561eeaa41d1f0d511eab0e6db9b2fe/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f383435353361626436303932393536333331626663643263663234626466666134336230396334666535343466323939333033353037393534366637343536312f62797465636f6465616c6c69616e63652f7761736d74696d652f6973737565732f33393533&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/issues/3953" title="Cranelift: avoid load coalescing when an operand is reused · Issue #3953 · bytecodealliance/wasmtime">Cranelift: avoid load coalescing when an operand is reused · Issue #3953 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">In examining #3951 and #3934, the main problem in both cases seems to be that the load coalescing logic cannot detect when a loaded operand may be reused. Because of this, we must manually ensure t...</div></div></div>



<a name="462833995"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462833995" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462833995">(Aug 16 2024 at 18:03)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="254389">@Chris Fallin</span> <span class="user-mention" data-user-id="254110">@Andrew Brown</span></p>



<a name="462834174"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462834174" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462834174">(Aug 16 2024 at 18:04)</a>:</h4>
<p>yep, that; the case you show in CLIF above is a special case where a single instruction is responsible for both of the uses, in theory we could detect that, we'd want to think it through very carefully though</p>



<a name="462834242"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462834242" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462834242">(Aug 16 2024 at 18:05)</a>:</h4>
<p>(nit: not "heuristic" but "invariant" or "rule"; heuristics can be violated without correctness issues)</p>



<a name="462834777"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462834777" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462834777">(Aug 16 2024 at 18:08)</a>:</h4>
<p>hm ok, I still don't really understand what this is doing but sounds like I should assume this can't easily change</p>



<a name="462834829"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462834829" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462834829">(Aug 16 2024 at 18:09)</a>:</h4>
<p>so the basic idea of the analysis is to prove that an instruction is used only (or at most) once; that's the condition we need to sink it</p>



<a name="462834858"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462834858" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462834858">(Aug 16 2024 at 18:09)</a>:</h4>
<p>(we could do better if we reasoned about location and sunk it to the first of several locations it's used if it dominates all the others, but that's way more complex)</p>



<a name="462834902"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462834902" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462834902">(Aug 16 2024 at 18:10)</a>:</h4>
<p>when there is a single output, this is reasonably straightforward: we do a transitive fixpoint algorithm where we generate a "Multiple" at any op that's used multiple times, and propagate that backward</p>



<a name="462834972"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462834972" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462834972">(Aug 16 2024 at 18:10)</a>:</h4>
<p>(because matching/sinking can go arbitrarily high up the tree, we need a transitive notion of "used more than once")</p>



<a name="462835014"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462835014" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462835014">(Aug 16 2024 at 18:10)</a>:</h4>
<p>when there are multiple outputs, even if each output is used only once, the op itself is used more than once</p>



<a name="462835067"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462835067" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462835067">(Aug 16 2024 at 18:11)</a>:</h4>
<p>we could refine the lattice more and encode logic for 0+0 -&gt; 0, 0+1 / 1+0 -&gt; 1, 1+1 -&gt; many, 1+many / many+1 -&gt; many</p>



<a name="462835081"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462835081" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462835081">(Aug 16 2024 at 18:11)</a>:</h4>
<p>and then add a special case for 1+1 (if same 1) -&gt; 1</p>



<a name="462835111"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462835111" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462835111">(Aug 16 2024 at 18:11)</a>:</h4>
<p>but that's... a lot of subtlety and I don't have confidence enough in it to do it right now</p>



<a name="462835125"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462835125" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462835125">(Aug 16 2024 at 18:11)</a>:</h4>
<p>hopefully makes more sense?</p>



<a name="462835224"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462835224" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462835224">(Aug 16 2024 at 18:12)</a>:</h4>
<p>One part I don't understand though is why multiple-results matter here. ISLE can't match instructions with multiple results in patterns afaik so we can't possibly go up the tree and somehow duplicate the operands of a multi-result instruction, right?</p>



<a name="462835333"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462835333" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462835333">(Aug 16 2024 at 18:13)</a>:</h4>
<p>well, when building the analysis we try not to couple current implementation limits such as "ISLE can't match instructions with multiple results" with the invariants elsewhere; that could easily lead to very subtle bugs later when we expand its capability, and in any case leads to very hard to reason about invariants</p>



<a name="462835349"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462835349" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462835349">(Aug 16 2024 at 18:13)</a>:</h4>
<p>the specific case of <code>isplit</code> returning two things and then <code>ret</code> consuming both is a bit of a red herring as it was the first test case I came up with, the actual benchmark I think stores the two results of <code>isplit</code> into memory or just one or something like that</p>



<a name="462835350"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462835350" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462835350">(Aug 16 2024 at 18:13)</a>:</h4>
<p>I think the right fix here, if we want to make the analysis more powerful, is to do as noted above -- recognize the special case</p>



<a name="462835396"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462835396" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462835396">(Aug 16 2024 at 18:13)</a>:</h4>
<p>or alternately, have a notion of "rooted value" that stops propagation of multiplicity</p>



<a name="462835412"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462835412" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462835412">(Aug 16 2024 at 18:14)</a>:</h4>
<p>then we need to guarantee that this is never matched through</p>



<a name="462835580"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462835580" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462835580">(Aug 16 2024 at 18:15)</a>:</h4>
<p>the key there would be to have a single source of truth for that notion/kind of instruction and consult it in both places</p>



<a name="462835787"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462835787" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462835787">(Aug 16 2024 at 18:17)</a>:</h4>
<p>I'm still not understanding though because isn't it structurally not possible to match through a multi-result instruction?</p>



<a name="462835807"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462835807" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462835807">(Aug 16 2024 at 18:17)</a>:</h4>
<p>in that aren't we already guaranteed that doesn't happen?</p>



<a name="462835890"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462835890" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462835890">(Aug 16 2024 at 18:18)</a>:</h4>
<p>it currently isn't possible, but let's not bake in that assumption, is what I'm saying; it's an implementation limit not something fundamental</p>



<a name="462835973"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462835973" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462835973">(Aug 16 2024 at 18:18)</a>:</h4>
<p>the "rooted instruction" notion above is my attempt to reify it as an actual concept we can rely on :-)</p>



<a name="462836021"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462836021" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462836021">(Aug 16 2024 at 18:18)</a>:</h4>
<p>said another way: can we describe accurately what the result of the analysis is?</p>



<a name="462836036"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462836036" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462836036">(Aug 16 2024 at 18:19)</a>:</h4>
<p>ok yeah that makes sense, I'm just trying to affirm my current understanding of the world to understand what you're saying we want to move towards</p>



<a name="462836048"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462836048" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462836048">(Aug 16 2024 at 18:19)</a>:</h4>
<p>e.g. I don't know what you mean by "rooted instruction"</p>



<a name="462836061"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462836061" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462836061">(Aug 16 2024 at 18:19)</a>:</h4>
<p>if the answer has to invoke implementation limits and just-so arguments why it won't cause an issue, that's a very bad place to be in</p>



<a name="462836085"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462836085" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462836085">(Aug 16 2024 at 18:19)</a>:</h4>
<p>vs. having a semantic concept and defining things around it</p>



<a name="462836086"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462836086" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462836086">(Aug 16 2024 at 18:19)</a>:</h4>
<p>and it's difficult for me to reason about matching through things when that's currently just a hypothetical for multi-result instructions</p>



<a name="462836199"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462836199" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462836199">(Aug 16 2024 at 18:20)</a>:</h4>
<p>"rooted instruction" is a concept that reifies the notion of "thing that cannot be matched through"</p>



<a name="462836215"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462836215" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462836215">(Aug 16 2024 at 18:20)</a>:</h4>
<p>rooted because we need to actually codegen it at the root of a matching tree</p>



<a name="462836244"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462836244" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462836244">(Aug 16 2024 at 18:20)</a>:</h4>
<p>once we have that guarantee, semantically, we can define multiplicity in terms of it</p>



<a name="462836281"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462836281" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462836281">(Aug 16 2024 at 18:20)</a>:</h4>
<p>basically my whole thing here is: we need to define multiplicity succinctly and clearly so we can think about it. if our definition includes reasoning about matching/lowering algorithm stuff, we've failed</p>



<a name="462836323"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462836323" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462836323">(Aug 16 2024 at 18:21)</a>:</h4>
<p>(in the sense that, that's a recipe for muddy thinking and further bugs)</p>



<a name="462836388"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462836388" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462836388">(Aug 16 2024 at 18:21)</a>:</h4>
<p>sorry I'm also trying to catch up because it sounds like you're trying to rebut a change I'm proposing but I'm not proposing anything and am trying to better understand what we have today</p>



<a name="462836479"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462836479" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462836479">(Aug 16 2024 at 18:22)</a>:</h4>
<p>basically I'm justifying why we have what we have today against the "why can't we remove <code>force_multiple</code>"</p>



<a name="462836733"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462836733" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462836733">(Aug 16 2024 at 18:24)</a>:</h4>
<p>as succinctly as I can put it: multiplicity has been defined (in this analysis) to mean "is an instruction referenced multiple times, or referenced by another instruction that is referenced multiple times". The algorithm approximates that in the presence of multiple-output instructions by the use of the <code>force_multiple</code> mechanism</p>



<a name="462836795"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462836795" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462836795">(Aug 16 2024 at 18:24)</a>:</h4>
<p>what I'm then proposing is that we can <em>change</em> that definition to change the answer to your question ("why can't we remove" -&gt; "now we can") by introducing this notion of rooted instructions</p>



<a name="462837080"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462837080" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462837080">(Aug 16 2024 at 18:27)</a>:</h4>
<p>ok that makes sense to me yeah, thanks!</p>



<a name="462837124"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462837124" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462837124">(Aug 16 2024 at 18:27)</a>:</h4>
<p>cool. happy to review if you want to take a stab at this (I unfortunately don't have the time or mental energy atm to do it myself!)</p>



<a name="462837135"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462837135" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462837135">(Aug 16 2024 at 18:27)</a>:</h4>
<p>is <a href="https://github.com/bytecodealliance/wasmtime/blob/3f5c21bff4babe54f51deceed1bb1d3321b6f2aa/cranelift/codegen/src/machinst/lower.rs#L1278">this function</a>, <code>get_value_as_source_or_const</code>, a suitable "choke point" where the concept of a rooted instruction might be able to be inserted?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/3f5c21bff4babe54f51deceed1bb1d3321b6f2aa/cranelift/codegen/src/machinst/lower.rs#L1278" style="background-image: url(&quot;https://uploads.zulipusercontent.net/94756e259a6e0e4d169e20e7601bc20887d37224/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f363435633462323633376132323762663061346535393932666565366563303036616632383761326132333966303836346634613937666662303266383663662f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/3f5c21bff4babe54f51deceed1bb1d3321b6f2aa/cranelift/codegen/src/machinst/lower.rs#L1278" title="wasmtime/cranelift/codegen/src/machinst/lower.rs at 3f5c21bff4babe54f51deceed1bb1d3321b6f2aa · bytecodealliance/wasmtime">wasmtime/cranelift/codegen/src/machinst/lower.rs at 3f5c21bff4babe54f51deceed1bb1d3321b6f2aa · bytecodealliance/wasmtime</a></div><div class="message_embed_description">A fast and secure runtime for WebAssembly. Contribute to bytecodealliance/wasmtime development by creating an account on GitHub.</div></div></div>



<a name="462837212"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462837212" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462837212">(Aug 16 2024 at 18:28)</a>:</h4>
<p>I see that for side-effecting instructions it <a href="https://github.com/bytecodealliance/wasmtime/blob/3f5c21bff4babe54f51deceed1bb1d3321b6f2aa/cranelift/codegen/src/machinst/lower.rs#L1332">already ensures there's only one output</a> but I suspect more would be needed</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/3f5c21bff4babe54f51deceed1bb1d3321b6f2aa/cranelift/codegen/src/machinst/lower.rs#L1332" style="background-image: url(&quot;https://uploads.zulipusercontent.net/94756e259a6e0e4d169e20e7601bc20887d37224/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f363435633462323633376132323762663061346535393932666565366563303036616632383761326132333966303836346634613937666662303266383663662f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/3f5c21bff4babe54f51deceed1bb1d3321b6f2aa/cranelift/codegen/src/machinst/lower.rs#L1332" title="wasmtime/cranelift/codegen/src/machinst/lower.rs at 3f5c21bff4babe54f51deceed1bb1d3321b6f2aa · bytecodealliance/wasmtime">wasmtime/cranelift/codegen/src/machinst/lower.rs at 3f5c21bff4babe54f51deceed1bb1d3321b6f2aa · bytecodealliance/wasmtime</a></div><div class="message_embed_description">A fast and secure runtime for WebAssembly. Contribute to bytecodealliance/wasmtime development by creating an account on GitHub.</div></div></div>



<a name="462837326"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462837326" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462837326">(Aug 16 2024 at 18:29)</a>:</h4>
<p>yep, that's indeed where we have all the conditions for "seeing through" a use, so let's add conditions there (for pure and impure cases) for "is rooted" and avoid seeing it as any more than an opaque value if so</p>



<a name="462837381"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462837381" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462837381">(Aug 16 2024 at 18:29)</a>:</h4>
<p>how come it would be necessary for the "pure" case?</p>



<a name="462837433"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462837433" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462837433">(Aug 16 2024 at 18:30)</a>:</h4>
<p>oh wait let me try to answer myself</p>



<a name="462837582"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462837582" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462837582">(Aug 16 2024 at 18:30)</a>:</h4>
<p>let's say that you <code>v0 = load ... ; v1, v2 = isplit v0</code> - if you "look through" the <code>isplit</code>, despite it being pure, you could "look through" a use of <code>v1</code> and <code>v2</code> and possibly generate two loads</p>



<a name="462837588"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462837588" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462837588">(Aug 16 2024 at 18:30)</a>:</h4>
<p>is that right?</p>



<a name="462837607"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462837607" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462837607">(Aug 16 2024 at 18:30)</a>:</h4>
<p>yep exactly</p>



<a name="462837652"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462837652" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462837652">(Aug 16 2024 at 18:31)</a>:</h4>
<p>so we cut things at the isplit, it's "rooted" now, it becomes just a single use for the load, and we can't look through it</p>



<a name="462837952"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462837952" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462837952">(Aug 16 2024 at 18:33)</a>:</h4>
<p>(I'm not sure if that addresses your original desire to get more load-sinking; the loads you want sunk are actually single-use and the splits happen as consumers of the things like iadds that consume loads, right?)</p>



<a name="462837999"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462837999" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462837999">(Aug 16 2024 at 18:34)</a>:</h4>
<p>so as perhaps the most simple change, it would perhaps look like:</p>
<ul>
<li>remove <code>force_multiple</code></li>
<li>add logic to <code>get_value_as_source_or_const</code> to return <code>InputSourceInst::None</code> if the instruction has multiple outputs</li>
</ul>



<a name="462838050"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462838050" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462838050">(Aug 16 2024 at 18:34)</a>:</h4>
<p>yeah what specifically I was seeing was that any operand to <code>isplit</code> would transitively mark all operands as <code>Multiple</code> which thwarted load sinking elsewhere</p>



<a name="462838185"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462838185" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462838185">(Aug 16 2024 at 18:36)</a>:</h4>
<p>the downside of this "simple" change though is that if a multi-result instruction has a dead result, e.g. the second return value of <code>isplit</code>, it in theory should allow seeing through the <code>isplit</code> but it doesn't?</p>



<a name="462838257"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462838257" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462838257">(Aug 16 2024 at 18:36)</a>:</h4>
<p>that delta is I think the logical outcome of the concept of "rooted" being defined for now as any multi-output; I was going to suggest a more generalized thing but then it would result in silly dead code; as long as we have comments where <code>force_multiple</code> is noting that we explicitly do not look through multi-output insts when matching, and add a comment where we block such seeing-through noting that it is load-bearing</p>



<a name="462838318"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462838318" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462838318">(Aug 16 2024 at 18:37)</a>:</h4>
<p>another alternative is to make the multiplicity analysis smarter: Once + Once -&gt; Multiple, including across multiple inputs, but Once + not-used should result in Once</p>



<a name="462838334"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462838334" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462838334">(Aug 16 2024 at 18:37)</a>:</h4>
<p>s/multiple inputs/multiple outputs/</p>



<a name="462838377"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462838377" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462838377">(Aug 16 2024 at 18:37)</a>:</h4>
<p>removing <code>force_multiple</code> gets that for free though right?</p>



<a name="462838408"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462838408" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462838408">(Aug 16 2024 at 18:37)</a>:</h4>
<p>b/c if you only use one result of <code>isplit</code> the operand only gets a single use?</p>



<a name="462838534"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462838534" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462838534">(Aug 16 2024 at 18:38)</a>:</h4>
<p>hm actually wait I don't think "just" removing <code>force_multiple</code> enough, the DFS would have to stop propagating through a multi-result instruction</p>



<a name="462838576"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462838576" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462838576">(Aug 16 2024 at 18:39)</a>:</h4>
<p>b/c otherwise if you use both results of <code>isplit</code> it'll naturally mark the operand as used twice right? (if the only change is to remove <code>force_multiple</code>)</p>



<a name="462838625"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462838625" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462838625">(Aug 16 2024 at 18:39)</a>:</h4>
<p>right, I think we actually need the notion of "rooted"; it's actually that we force codegen at that matching root (by not seeing through it) and really do only use the input once as a result</p>



<a name="462838876"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462838876" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462838876">(Aug 16 2024 at 18:41)</a>:</h4>
<p>hm ok I'll try to poke at this and see if I can't bottom this out more</p>



<a name="462838929"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462838929" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462838929">(Aug 16 2024 at 18:41)</a>:</h4>
<p>happy to talk more in next week's CL meeting too!</p>



<a name="462855365"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/ValueUseState%3A%3AMultiple%20and%20multi-result%20instructions/near/462855365" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/ValueUseState.3A.3AMultiple.20and.20multi-result.20instructions.html#462855365">(Aug 16 2024 at 20:55)</a>:</h4>
<p>I've ended up with <a href="https://github.com/bytecodealliance/wasmtime/pull/9137">https://github.com/bytecodealliance/wasmtime/pull/9137</a> as an attempt of this</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/9137" style="background-image: url(&quot;https://uploads.zulipusercontent.net/d6963be17dc18a9500a20d75c6b5737093acc9d1/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f626464653335336165326666383561393638646263343332313735366261653232633762663233646438353234363538373236386430623161623438343732312f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f39313337&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/9137" title=" Don't force `Multiple` on multi-result instructions  by alexcrichton · Pull Request #9137 · bytecodealliance/wasmtime"> Don't force `Multiple` on multi-result instructions  by alexcrichton · Pull Request #9137 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">This commit is a result of discussion on Zulip and is
attempting to fix an issue where some 128-bit instructions aren&#39;t fully
benefitting from load sinking on x64. At a high level 128-bit
addit...</div></div></div>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>