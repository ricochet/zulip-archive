<html>
<head><meta charset="utf-8"><title>new recipe · cranelift · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/index.html">cranelift</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html">new recipe</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="215353418"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215353418" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215353418">(Nov 02 2020 at 17:46)</a>:</h4>
<p><span class="user-mention" data-user-id="254389">@Chris Fallin</span> I'm poking around at the stack limit issue, and I don't think that cranelift has an encoding already for something like <code>subq $8, (%rsi)</code>, so I'm trying to add one</p>



<a name="215353424"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215353424" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215353424">(Nov 02 2020 at 17:46)</a>:</h4>
<p>as</p>



<a name="215353449"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215353449" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215353449">(Nov 02 2020 at 17:46)</a>:</h4>
<p>as expected I'm lost in a jungle of encodings and recipes, and was wondering if you'd be able to help out?</p>



<a name="215353470"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215353470" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215353470">(Nov 02 2020 at 17:46)</a>:</h4>
<p>I also have no idea how x86 encoding works, so that probably doesn't help</p>



<a name="215353537"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215353537" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215353537">(Nov 02 2020 at 17:47)</a>:</h4>
<p>Ah, I am not as much an expert in the old system (I grokked it enough to take the useful parts and build the redesign) but I can certainly help to dig in!</p>



<a name="215353630"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215353630" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215353630">(Nov 02 2020 at 17:47)</a>:</h4>
<p>One issue though is that an encoding should correspond to a single CLIF op; i.e. one can't have many-to-one matches (many CLIF ops to one machine instruction)</p>



<a name="215353719"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215353719" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215353719">(Nov 02 2020 at 17:48)</a>:</h4>
<p>So the above sub-from-memory is really a load-sub-store which... would be difficult to support if it arrives in that form.</p>



<a name="215353732"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215353732" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215353732">(Nov 02 2020 at 17:48)</a>:</h4>
<p>yeah that's fine, this is very raw so far so I'm basically generating raw instructions</p>



<a name="215353749"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215353749" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215353749">(Nov 02 2020 at 17:48)</a>:</h4>
<p>So I think the best option would be to invent a purpose-built CLIF op just for this, and give it the right encoding</p>



<a name="215353769"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215353769" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215353769">(Nov 02 2020 at 17:48)</a>:</h4>
<p>yeah that's what I've <a href="https://github.com/alexcrichton/wasmtime/commit/3a421c3a4c075ec5050e1531322db2d860408d3e#diff-93c7085e3c20345fbddc46dbb91c57f6b70a207132b7a6cf5ca5be10e2aedb47R722">got so far</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/alexcrichton/wasmtime/commit/3a421c3a4c075ec5050e1531322db2d860408d3e#diff-93c7085e3c20345fbddc46dbb91c57f6b70a207132b7a6cf5ca5be10e2aedb47R722" style="background-image: url(https://avatars0.githubusercontent.com/u/64996?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/alexcrichton/wasmtime/commit/3a421c3a4c075ec5050e1531322db2d860408d3e#diff-93c7085e3c20345fbddc46dbb91c57f6b70a207132b7a6cf5ca5be10e2aedb47R722" title="wat · alexcrichton/wasmtime@3a421c3">wat · alexcrichton/wasmtime@3a421c3</a></div><div class="message_embed_description">Standalone JIT-style runtime for WebAsssembly, using Cranelift - alexcrichton/wasmtime</div></div></div>



<a name="215353838"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215353838" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215353838">(Nov 02 2020 at 17:49)</a>:</h4>
<p>and I added a <a href="https://github.com/alexcrichton/wasmtime/commit/3a421c3a4c075ec5050e1531322db2d860408d3e#diff-749618e77328febdf7f76845b5b36eaaabb33af182bdf4f5523fe86cda17f143R249">new format too</a> for "has output condition codes" (I think)</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/alexcrichton/wasmtime/commit/3a421c3a4c075ec5050e1531322db2d860408d3e#diff-749618e77328febdf7f76845b5b36eaaabb33af182bdf4f5523fe86cda17f143R249" style="background-image: url(https://avatars0.githubusercontent.com/u/64996?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/alexcrichton/wasmtime/commit/3a421c3a4c075ec5050e1531322db2d860408d3e#diff-749618e77328febdf7f76845b5b36eaaabb33af182bdf4f5523fe86cda17f143R249" title="wat · alexcrichton/wasmtime@3a421c3">wat · alexcrichton/wasmtime@3a421c3</a></div><div class="message_embed_description">Standalone JIT-style runtime for WebAsssembly, using Cranelift - alexcrichton/wasmtime</div></div></div>



<a name="215353901"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215353901" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215353901">(Nov 02 2020 at 17:49)</a>:</h4>
<p>stack checks just generate <a href="https://github.com/alexcrichton/wasmtime/commit/3a421c3a4c075ec5050e1531322db2d860408d3e#diff-11ebdbbad369ec6d7529b9290cab1355ebaba578fd571d46bbe9ca53ef4d60d0R951">the raw instruction</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/alexcrichton/wasmtime/commit/3a421c3a4c075ec5050e1531322db2d860408d3e#diff-11ebdbbad369ec6d7529b9290cab1355ebaba578fd571d46bbe9ca53ef4d60d0R951" style="background-image: url(https://avatars0.githubusercontent.com/u/64996?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/alexcrichton/wasmtime/commit/3a421c3a4c075ec5050e1531322db2d860408d3e#diff-11ebdbbad369ec6d7529b9290cab1355ebaba578fd571d46bbe9ca53ef4d60d0R951" title="wat · alexcrichton/wasmtime@3a421c3">wat · alexcrichton/wasmtime@3a421c3</a></div><div class="message_embed_description">Standalone JIT-style runtime for WebAsssembly, using Cranelift - alexcrichton/wasmtime</div></div></div>



<a name="215353941"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215353941" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215353941">(Nov 02 2020 at 17:49)</a>:</h4>
<p>what I'm stuck on is the encoding</p>



<a name="215353967"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215353967" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215353967">(Nov 02 2020 at 17:49)</a>:</h4>
<p>in <code>encodings.rs</code> and <code>recipes.rs</code></p>



<a name="215354037"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215354037" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215354037">(Nov 02 2020 at 17:50)</a>:</h4>
<p>I'm sort of just copying push/pop right now (which have x86-specific things)</p>



<a name="215354053"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215354053" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215354053">(Nov 02 2020 at 17:50)</a>:</h4>
<p>but I have no idea how to fill out <code>recipes.rs</code></p>



<a name="215354078"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215354078" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215354078">(Nov 02 2020 at 17:50)</a>:</h4>
<p>and tbh I don't know how to encode this instruction either</p>



<a name="215354101"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215354101" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215354101">(Nov 02 2020 at 17:50)</a>:</h4>
<p>I just know that gas gives me <code>0: 48 83 6e 04 03                subq    $3, 4(%rsi)</code></p>



<a name="215354453"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215354453" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215354453">(Nov 02 2020 at 17:53)</a>:</h4>
<p>OK, so in the recipe -- I don't fully grok why we have <code>EvexContext</code> and all of that or why the input and output are FP regs? But that's aside from the actual question... I'm refilling my L1 cache wrt encodings infra now :-)</p>



<a name="215354522"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215354522" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215354522">(Nov 02 2020 at 17:54)</a>:</h4>
<p>oh sorry that's just copy/pasted from above</p>



<a name="215354548"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215354548" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215354548">(Nov 02 2020 at 17:54)</a>:</h4>
<p>the above recipe that is</p>



<a name="215354554"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215354554" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215354554">(Nov 02 2020 at 17:54)</a>:</h4>
<p>the string should be "TODO":</p>



<a name="215354721"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215354721" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215354721">(Nov 02 2020 at 17:55)</a>:</h4>
<p>Ah yes, OK, so we'll need to add the encoding bytes in <code>opcodes.rs</code>; then follow for example how <code>iadd</code> is tied to a recipe and opcode at line 1468: <code>e.enc_i32_i64(inst, recipe.opcodes(&amp;OPCODE))</code></p>



<a name="215354803"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215354803" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215354803">(Nov 02 2020 at 17:56)</a>:</h4>
<p>the Rust-code-as-string in the recipe then needs to do ... things ... to emit the immediate following the opcode bytes</p>



<a name="215354838"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215354838" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215354838">(Nov 02 2020 at 17:56)</a>:</h4>
<p>and properly embed the register number in the ModRM (?) byte</p>



<a name="215355110"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215355110" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215355110">(Nov 02 2020 at 17:58)</a>:</h4>
<p>so, maybe weird question, how do I figure out the opcode?</p>



<a name="215355126"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215355126" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215355126">(Nov 02 2020 at 17:58)</a>:</h4>
<p>some gas stuff gives:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="mi">0</span>: <span class="mi">48</span><span class="w"> </span><span class="mi">83</span><span class="w"> </span><span class="mi">2</span><span class="n">e</span><span class="w"> </span><span class="mi">03</span><span class="w">                   </span><span class="n">subq</span><span class="w">    </span><span class="cp">$</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">rsi</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="mi">4</span>: <span class="mi">48</span><span class="w"> </span><span class="mi">83</span><span class="w"> </span><span class="mi">29</span><span class="w"> </span><span class="mi">03</span><span class="w">                   </span><span class="n">subq</span><span class="w">    </span><span class="cp">$</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">rcx</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="mi">8</span>: <span class="mi">48</span><span class="w"> </span><span class="mi">83</span><span class="w"> </span><span class="mi">69</span><span class="w"> </span><span class="mi">03</span><span class="w"> </span><span class="mi">03</span><span class="w">                </span><span class="n">subq</span><span class="w">    </span><span class="cp">$</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">(</span><span class="o">%</span><span class="n">rcx</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">d</span>: <span class="mi">48</span><span class="w"> </span><span class="mi">83</span><span class="w"> </span><span class="n">a9</span><span class="w"> </span><span class="mi">2</span><span class="n">c</span><span class="w"> </span><span class="mi">01</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">03</span><span class="w">       </span><span class="n">subq</span><span class="w">    </span><span class="cp">$</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">300</span><span class="p">(</span><span class="o">%</span><span class="n">rcx</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="mi">15</span>: <span class="mi">48</span><span class="w"> </span><span class="mi">83</span><span class="w"> </span><span class="n">a9</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">03</span><span class="w">       </span><span class="n">subq</span><span class="w">    </span><span class="cp">$</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">(</span><span class="o">%</span><span class="n">rcx</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="mi">1</span><span class="n">d</span>: <span class="mi">48</span><span class="w"> </span><span class="mi">83</span><span class="w"> </span><span class="mi">69</span><span class="w"> </span><span class="mi">7</span><span class="n">f</span><span class="w"> </span><span class="mi">03</span><span class="w">                </span><span class="n">subq</span><span class="w">    </span><span class="cp">$</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">(</span><span class="o">%</span><span class="n">rcx</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="mi">22</span>: <span class="mi">83</span><span class="w"> </span><span class="mi">2</span><span class="n">e</span><span class="w"> </span><span class="mi">03</span><span class="w">                      </span><span class="n">subl</span><span class="w">    </span><span class="cp">$</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">rsi</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="mi">25</span>: <span class="nc">c3</span><span class="w">                            </span><span class="n">retq</span><span class="w"></span>
</code></pre></div>



<a name="215355140"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215355140" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215355140">(Nov 02 2020 at 17:58)</a>:</h4>
<p>does that mean  the opcode here is <code>0x83</code>?</p>



<a name="215355170"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215355170" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215355170">(Nov 02 2020 at 17:58)</a>:</h4>
<p>(I have no idea how x86 encoding works)</p>



<a name="215355251"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215355251" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215355251">(Nov 02 2020 at 17:59)</a>:</h4>
<p>according <a href="https://www.intel.com/content/dam/www/public/us/en/documents/manuals/64-ia-32-architectures-software-developer-instruction-set-reference-manual-325383.pdf">to this</a> it claims I want <code>REX.W + 83 /5 ib</code></p>



<a name="215355274"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215355274" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215355274">(Nov 02 2020 at 17:59)</a>:</h4>
<p>so I guess <code>REX.W</code> is 0x48, but I don't know what <code>/5</code> or<code>ib</code> are</p>



<a name="215355446"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215355446" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215355446">(Nov 02 2020 at 18:01)</a>:</h4>
<p>Oh, yes, 0x83 is the opcode there; 0x48 is the REX byte; 0x2e (in the first instruction) is the ModRM</p>



<a name="215355514"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215355514" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215355514">(Nov 02 2020 at 18:01)</a>:</h4>
<p>ModRM?</p>



<a name="215355523"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215355523" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215355523">(Nov 02 2020 at 18:01)</a>:</h4>
<p>the register number for the sub will be in the modrm and the high bit (try e.g. r12) will be in the REX byte</p>



<a name="215355562"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215355562" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215355562">(Nov 02 2020 at 18:01)</a>:</h4>
<p>ModRM is... modifier, register, memory? Something like that; basically "operands to the x86 instruction". x86 is weird</p>



<a name="215355616"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215355616" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215355616">(Nov 02 2020 at 18:02)</a>:</h4>
<p>aha ok</p>



<a name="215355780"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215355780" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215355780">(Nov 02 2020 at 18:03)</a>:</h4>
<p>let me know if you still run into issues and I can try to help; I had to mess with those recipes when I first started in Cranelift and it was not easy to figure out</p>



<a name="215355847"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215355847" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215355847">(Nov 02 2020 at 18:03)</a>:</h4>
<p>(the /5 above is the "modifier" I think; and <code>ib</code> is "immediate byte", I am guessing)</p>



<a name="215355912"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215355912" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215355912">(Nov 02 2020 at 18:04)</a>:</h4>
<p>ok yeah I';m starting to actually read the manual</p>



<a name="215355920"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215355920" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215355920">(Nov 02 2020 at 18:04)</a>:</h4>
<p>"/digit — A digit between 0 and 7 indicates that the ModR/M byte of the instruction uses only the r/m (register or memory) operand. The reg field contains the digit that provides an extension to the instruction's opcode."</p>



<a name="215355931"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215355931" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215355931">(Nov 02 2020 at 18:04)</a>:</h4>
<p>"ib, iw, id, io — A 1-byte (ib), 2-byte (iw), 4-byte (id) or 8-byte (io) immediate operand to the instruction that follows the opcode, ModR/M bytes or scale-indexing bytes. The opcode determines if the operand is a signed value. All words, doublewords and quadwords are given with the low-order byte first."</p>



<a name="215356458"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215356458" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215356458">(Nov 02 2020 at 18:08)</a>:</h4>
<p>oh man ok I'm still very lost</p>



<a name="215356463"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215356463" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215356463">(Nov 02 2020 at 18:08)</a>:</h4>
<p>on <code>recipes.rs</code></p>



<a name="215357866"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215357866" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215357866">(Nov 02 2020 at 18:20)</a>:</h4>
<p>ok I'm throwing things at the wall, filecheck errors are inscrutable to me though</p>



<a name="215357887"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215357887" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215357887">(Nov 02 2020 at 18:20)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">FAIL</span><span class="w"> </span><span class="n">filetests</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">prologue</span><span class="o">-</span><span class="n">epilogue</span><span class="p">.</span><span class="n">clif</span>: <span class="nc">compile</span><span class="w"></span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="nc">filecheck</span><span class="w"> </span><span class="n">failed</span>:
    <span class="err">#</span><span class="mi">0</span><span class="w"> </span><span class="n">check</span>: <span class="nc">function</span><span class="w"> </span><span class="o">%</span><span class="n">empty</span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="n">fp</span><span class="w"> </span><span class="p">[</span><span class="o">%</span><span class="n">rbp</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">fp</span><span class="w"> </span><span class="p">[</span><span class="o">%</span><span class="n">rbp</span><span class="p">]</span><span class="w"> </span><span class="n">fast</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="err">#</span><span class="mi">1</span><span class="w"> </span><span class="n">nextln</span>: <span class="nc">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">incoming_arg</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">-</span><span class="mi">16</span><span class="w"></span>
<span class="w">    </span><span class="err">#</span><span class="mi">2</span><span class="w"> </span><span class="n">nextln</span>: <span class="nc">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span> <span class="p">[</span><span class="o">%</span><span class="n">rbp</span><span class="p">])</span>:
    <span class="err">#</span><span class="mi">3</span><span class="w"> </span><span class="n">nextln</span>: <span class="nc">x86_push</span><span class="w"> </span><span class="n">v0</span><span class="w"></span>
<span class="w">    </span><span class="err">#</span><span class="mi">4</span><span class="w"> </span><span class="n">nextln</span>: <span class="nc">copy_special</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span><span class="w"> </span>-&gt; <span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">    </span><span class="err">#</span><span class="mi">5</span><span class="w"> </span><span class="n">nextln</span>: <span class="nc">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x86_pop</span><span class="p">.</span><span class="kt">i64</span><span class="w"></span>
<span class="w">    </span><span class="err">#</span><span class="mi">6</span><span class="w"> </span><span class="n">nextln</span>: <span class="nc">return</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="err">#</span><span class="mi">7</span><span class="w"> </span><span class="n">nextln</span>: <span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="o">&gt;</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">empty</span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="n">fp</span><span class="w"> </span><span class="p">[</span><span class="o">%</span><span class="n">rbp</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">fp</span><span class="w"> </span><span class="p">[</span><span class="o">%</span><span class="n">rbp</span><span class="p">]</span><span class="w"> </span><span class="n">fast</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="o">^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span class="w"></span>
<span class="w">    </span><span class="n">Matched</span><span class="w"> </span><span class="err">#</span><span class="mi">0</span>: <span class="err">\</span><span class="n">bfunction</span><span class="w"> </span><span class="o">%</span><span class="n">empty</span><span class="err">\</span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="n">fp</span><span class="w"> </span><span class="err">\</span><span class="p">[</span><span class="o">%</span><span class="n">rbp</span><span class="err">\</span><span class="p">]</span><span class="err">\</span><span class="p">)</span><span class="w"> </span><span class="err">\</span>-&gt; <span class="kt">i64</span> <span class="nc">fp</span><span class="w"> </span><span class="err">\</span><span class="p">[</span><span class="o">%</span><span class="n">rbp</span><span class="err">\</span><span class="p">]</span><span class="w"> </span><span class="n">fast</span><span class="w"> </span><span class="err">\</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="o">&gt;</span><span class="w">     </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">incoming_arg</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">-</span><span class="mi">16</span><span class="w"></span>
<span class="w">          </span><span class="o">^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span class="w"></span>
<span class="w">    </span><span class="n">Matched</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span>: <span class="err">\</span><span class="n">bss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">incoming_arg</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="err">\</span><span class="o">-</span><span class="mi">16</span><span class="err">\</span><span class="n">b</span><span class="w"></span>
<span class="w">    </span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="n">Missed</span><span class="w"> </span><span class="err">#</span><span class="mi">2</span>: <span class="err">\</span><span class="n">bblock0</span><span class="err">\</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span> <span class="err">\</span><span class="p">[</span><span class="o">%</span><span class="n">rbp</span><span class="err">\</span><span class="p">]</span><span class="err">\</span><span class="p">)</span>:
    <span class="o">&gt;</span><span class="w">                                 </span><span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span> <span class="p">[</span><span class="o">%</span><span class="n">rbp</span><span class="p">])</span>:
    <span class="o">&gt;</span><span class="w"> </span><span class="p">[</span><span class="n">Op1pushq</span><span class="err">#</span><span class="mi">50</span><span class="p">]</span><span class="w">                       </span><span class="n">x86_push</span><span class="w"> </span><span class="n">v0</span><span class="w"></span>
<span class="w">    </span><span class="o">&gt;</span><span class="w"> </span><span class="p">[</span><span class="n">RexOp1copysp</span><span class="err">#</span><span class="mi">8089</span><span class="p">]</span><span class="w">                 </span><span class="n">copy_special</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span><span class="w"> </span>-&gt; <span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">    </span><span class="o">&gt;</span><span class="w"> </span><span class="p">[</span><span class="n">Op1popq</span><span class="err">#</span><span class="mi">58</span><span class="p">,</span><span class="o">%</span><span class="n">rbp</span><span class="p">]</span><span class="w">                   </span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x86_pop</span><span class="p">.</span><span class="kt">i64</span><span class="w"></span>
<span class="w">    </span><span class="o">&gt;</span><span class="w"> </span><span class="p">[</span><span class="n">Op1ret</span><span class="err">#</span><span class="n">c3</span><span class="p">]</span><span class="w">                         </span><span class="k">return</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="mi">1</span><span class="w"> </span><span class="n">tests</span><span class="w"></span>
<span class="n">Error</span>: <span class="mi">1</span><span class="w"> </span><span class="n">failure</span><span class="w"></span>
</code></pre></div>



<a name="215357901"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215357901" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215357901">(Nov 02 2020 at 18:20)</a>:</h4>
<p>what's happening there?</p>



<a name="215358454"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215358454" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215358454">(Nov 02 2020 at 18:25)</a>:</h4>
<p>Hmm, so this filetest isn't expecting the stackslot (<code>ss0</code>) created to name the incoming arg</p>



<a name="215358566"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215358566" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215358566">(Nov 02 2020 at 18:26)</a>:</h4>
<p>If this is part of your patch, you can just add it, or alter <code>nextln</code> to <code>check</code> to allow content between the <code>function</code> line and the start of the BB</p>



<a name="215359124"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215359124" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215359124">(Nov 02 2020 at 18:30)</a>:</h4>
<p>I think the <code>ss0</code> is fine (matched), it may be a new line that cranelift-reader inserts before block headers (see the empty <code>&gt; </code>)</p>



<a name="215359209"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215359209" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215359209">(Nov 02 2020 at 18:31)</a>:</h4>
<p>but I think the same thing applies: <code>check: block0...</code> will reset the matcher so that it skips the newline</p>



<a name="215359405"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215359405" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215359405">(Nov 02 2020 at 18:33)</a>:</h4>
<p>oh I remember this now</p>



<a name="215359412"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215359412" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215359412">(Nov 02 2020 at 18:33)</a>:</h4>
<p>my editor strips trailing whitespace</p>



<a name="215359417"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215359417" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215359417">(Nov 02 2020 at 18:33)</a>:</h4>
<p>and that's significant here...</p>



<a name="215360035"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215360035" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215360035">(Nov 02 2020 at 18:39)</a>:</h4>
<p>yeah I would really like filecheck not to be trailing whitespace significant...</p>



<a name="215360105"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215360105" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215360105">(Nov 02 2020 at 18:40)</a>:</h4>
<p>ok I've thrown things at the wall</p>



<a name="215360159"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215360159" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215360159">(Nov 02 2020 at 18:40)</a>:</h4>
<p>and now I get </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">[</span><span class="n">RexOp1umr</span><span class="err">#</span><span class="mi">8089</span><span class="p">,</span><span class="o">%</span><span class="n">rax</span><span class="p">]</span><span class="w">               </span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copy</span><span class="w"> </span><span class="n">v0</span><span class="w"></span>
<span class="p">[</span><span class="n">RexOp1sub_mem</span><span class="err">#</span><span class="mi">83</span><span class="p">,</span><span class="o">%</span><span class="n">rflags</span><span class="p">]</span><span class="w">          </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x86_sub_mem</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="mi">184</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="p">;</span><span class="o">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">error</span>: <span class="nc">inst2</span>: <span class="nc">RexOp1sub_mem</span><span class="err">#</span><span class="mi">83</span><span class="w"> </span><span class="n">constraints</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">satisfied</span><span class="w"> </span><span class="k">in</span>: <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x86_sub_mem</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="mi">184</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">stack_limit</span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="n">stack_limit</span><span class="w"> </span><span class="p">[</span><span class="o">%</span><span class="n">rdi</span><span class="p">],</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="n">fp</span><span class="w"> </span><span class="p">[</span><span class="o">%</span><span class="n">rbp</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">fp</span><span class="w"> </span><span class="p">[</span><span class="o">%</span><span class="n">rbp</span><span class="p">]</span><span class="w"> </span><span class="n">fast</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">168</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">-</span><span class="mi">184</span><span class="w"></span>
<span class="w">    </span><span class="n">ss1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">incoming_arg</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">-</span><span class="mi">16</span><span class="w"></span>
</code></pre></div>



<a name="215360195"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215360195" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215360195">(Nov 02 2020 at 18:40)</a>:</h4>
<p>where are constraints configured here? is that also in <a href="http://recipes.rs">recipes.rs</a>?</p>



<a name="215360306"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215360306" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215360306">(Nov 02 2020 at 18:41)</a>:</h4>
<p>I think the constraints originate (or at least can originate) from the <code>operands_in</code> and <code>operands_out</code> builder methods invoked in <a href="http://recipes.rs">recipes.rs</a></p>



<a name="215360381"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215360381" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215360381">(Nov 02 2020 at 18:42)</a>:</h4>
<p>ok cool, thanks!</p>



<a name="215360394"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215360394" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215360394">(Nov 02 2020 at 18:42)</a>:</h4>
<p>those are indeed garbage values, I should think on those</p>



<a name="215360413"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215360413" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215360413">(Nov 02 2020 at 18:42)</a>:</h4>
<p>Probably you want <code>vec![gpr]</code> for ins and <code>vec![]</code> for outs?</p>



<a name="215360466"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215360466" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215360466">(Nov 02 2020 at 18:43)</a>:</h4>
<p>if I have iflags going out</p>



<a name="215360476"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215360476" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215360476">(Nov 02 2020 at 18:43)</a>:</h4>
<p>is it <code>vec![rflags]</code>?</p>



<a name="215360611"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215360611" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215360611">(Nov 02 2020 at 18:44)</a>:</h4>
<p>ok cool making progress, now have </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">FAIL</span><span class="w"> </span><span class="n">filetests</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">prologue</span><span class="o">-</span><span class="n">epilogue</span><span class="p">.</span><span class="n">clif</span>: <span class="nc">compile</span><span class="w"></span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="nc">Expected</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="n">got</span><span class="w"> </span><span class="mi">29</span><span class="w"></span>
<span class="mi">1</span><span class="w"> </span><span class="n">tests</span><span class="w"></span>
<span class="n">Error</span>: <span class="mi">1</span><span class="w"> </span><span class="n">failure</span><span class="w"></span>
</code></pre></div>
<p>looks like I need to actually fill out the encoding now</p>



<a name="215360879"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215360879" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215360879">(Nov 02 2020 at 18:46)</a>:</h4>
<p>ah, yeah, I think you want <code>rflags</code> out for completeness (to denote that the reg is clobbered), but I don't recall exactly how the flags checker works. Though it shouldn't matter if this is only being generated explicitly in a prologue</p>



<a name="215361291"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215361291" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215361291">(Nov 02 2020 at 18:49)</a>:</h4>
<p>ok so I got to the point where the test is failing for the reason I expect it to be failing, basically I need to update the clif for the new instruction</p>



<a name="215361309"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215361309" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215361309">(Nov 02 2020 at 18:49)</a>:</h4>
<p>before I do that though I want to actually implement the encoding</p>



<a name="215361350"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215361350" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215361350">(Nov 02 2020 at 18:50)</a>:</h4>
<p>so I'm adding a <code>binemit</code> test for this?</p>



<a name="215361434"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215361434" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215361434">(Nov 02 2020 at 18:50)</a>:</h4>
<p>yup</p>



<a name="215361470"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215361470" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215361470">(Nov 02 2020 at 18:51)</a>:</h4>
<p>hm ok, so I added a simple one</p>



<a name="215361472"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215361472" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215361472">(Nov 02 2020 at 18:51)</a>:</h4>
<p>and I get</p>



<a name="215361493"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215361493" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215361493">(Nov 02 2020 at 18:51)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">worker</span><span class="w"> </span><span class="err">#</span><span class="mi">0</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Option</span>::<span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="err">`</span><span class="nb">None</span><span class="err">`</span><span class="w"> </span><span class="n">value</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">cranelift</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">test_binemit</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">143</span>:<span class="mi">37</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span><span class="w"></span>
<span class="n">FAIL</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">clif</span>: <span class="nc">panicked</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">worker</span><span class="w"> </span><span class="err">#</span><span class="mi">0</span>: <span class="nc">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Option</span>::<span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="err">`</span><span class="nb">None</span><span class="err">`</span><span class="w"> </span><span class="n">value</span><span class="w"></span>
<span class="mi">1</span><span class="w"> </span><span class="n">tests</span><span class="w"></span>
<span class="n">Error</span>: <span class="mi">1</span><span class="w"> </span><span class="n">failure</span><span class="w"></span>
</code></pre></div>



<a name="215361536"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215361536" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215361536">(Nov 02 2020 at 18:51)</a>:</h4>
<p>those pesky <code>None</code>s... hmm</p>



<a name="215361547"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215361547" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215361547">(Nov 02 2020 at 18:51)</a>:</h4>
<p>where the panic is <a href="https://github.com/bytecodealliance/wasmtime/blob/146a393a9aeb1a6e505caf0c5c6aeda8ff43a13d/cranelift/filetests/src/test_binemit.rs#L143">here</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/146a393a9aeb1a6e505caf0c5c6aeda8ff43a13d/cranelift/filetests/src/test_binemit.rs#L143" style="background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/146a393a9aeb1a6e505caf0c5c6aeda8ff43a13d/cranelift/filetests/src/test_binemit.rs#L143" title="bytecodealliance/wasmtime">bytecodealliance/wasmtime</a></div><div class="message_embed_description">Standalone JIT-style runtime for WebAssembly, using Cranelift - bytecodealliance/wasmtime</div></div></div>



<a name="215361560"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215361560" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215361560">(Nov 02 2020 at 18:51)</a>:</h4>
<p>I guess I need to fill that in in the backend</p>



<a name="215361567"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215361567" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215361567">(Nov 02 2020 at 18:52)</a>:</h4>
<p>somewhere...</p>



<a name="215361701"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215361701" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215361701">(Nov 02 2020 at 18:53)</a>:</h4>
<p>Does your patch add new stackslots?</p>



<a name="215361732"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215361732" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215361732">(Nov 02 2020 at 18:53)</a>:</h4>
<p>I don't think so</p>



<a name="215361733"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215361733" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215361733">(Nov 02 2020 at 18:53)</a>:</h4>
<p>(I am mostly no better than <code>ripgrep</code> to help you here, though, sorry :-/ )</p>



<a name="215361740"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215361740" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215361740">(Nov 02 2020 at 18:53)</a>:</h4>
<p>I just moved it to a <code>filter_map</code> temporarily</p>



<a name="215361753"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215361753" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215361753">(Nov 02 2020 at 18:53)</a>:</h4>
<p>nah it's ok</p>



<a name="215361762"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215361762" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215361762">(Nov 02 2020 at 18:53)</a>:</h4>
<p>I will soldier on</p>



<a name="215361951"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215361951" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215361951">(Nov 02 2020 at 18:55)</a>:</h4>
<p>fwiw I'll be happy to help bring this up in the new backend :-)</p>



<a name="215361988"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215361988" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215361988">(Nov 02 2020 at 18:55)</a>:</h4>
<p>(which I imagine we'll need to do shortly if this becomes the normal translation for stack checks)</p>



<a name="215362134"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215362134" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215362134">(Nov 02 2020 at 18:56)</a>:</h4>
<p>bah it seems binemit doesn't match the prologue epilogue</p>



<a name="215362160"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215362160" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215362160">(Nov 02 2020 at 18:56)</a>:</h4>
<p>what does your foo.clif look like?</p>



<a name="215362166"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215362166" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215362166">(Nov 02 2020 at 18:56)</a>:</h4>
<p>ah but yeah I will need to implement this in the new backend before landing</p>



<a name="215362211"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215362211" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215362211">(Nov 02 2020 at 18:57)</a>:</h4>
<p>current the clif is </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">binemit</span><span class="w"></span>
<span class="n">set</span><span class="w"> </span><span class="n">opt_level</span><span class="o">=</span><span class="n">speed_and_size</span><span class="w"></span>
<span class="n">set</span><span class="w"> </span><span class="n">is_pic</span><span class="w"></span>
<span class="n">set</span><span class="w"> </span><span class="n">enable_probestack</span><span class="o">=</span><span class="kc">false</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"> </span><span class="n">haswell</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">stack_limit</span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="n">stack_limit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">asm</span>: <span class="nc">xxx</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">bin</span>: <span class="mi">30</span><span class="w"></span>
<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">168</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">)</span>:
    <span class="nc">return</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="215362254"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215362254" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215362254">(Nov 02 2020 at 18:57)</a>:</h4>
<p>but it seems to want that directive to be attached to an instruction</p>



<a name="215362270"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215362270" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215362270">(Nov 02 2020 at 18:57)</a>:</h4>
<p>oh I guess I can manually type in the instruction</p>



<a name="215362363"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215362363" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215362363">(Nov 02 2020 at 18:58)</a>:</h4>
<p>yup, that sounds right</p>



<a name="215362386"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215362386" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215362386">(Nov 02 2020 at 18:58)</a>:</h4>
<p>now I must learn to write clif...</p>



<a name="215362444"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215362444" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215362444">(Nov 02 2020 at 18:58)</a>:</h4>
<p>what is the op you need to add?</p>



<a name="215362489"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215362489" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215362489">(Nov 02 2020 at 18:59)</a>:</h4>
<p>I'm adding <code>sub $imm, (%r12)</code> basically</p>



<a name="215362514"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215362514" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215362514">(Nov 02 2020 at 18:59)</a>:</h4>
<p>I haven't even gotten to try out the encoding</p>



<a name="215362525"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215362525" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215362525">(Nov 02 2020 at 18:59)</a>:</h4>
<p>trying to write up a test which gives me "your encoding is weird" so far</p>



<a name="215362725"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215362725" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215362725">(Nov 02 2020 at 19:01)</a>:</h4>
<p>(hm, scanning my brain to see if I remember if <code>(%r12)</code> addressing is even possible in the old backend...)</p>



<a name="215362802"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215362802" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215362802">(Nov 02 2020 at 19:01)</a>:</h4>
<p>I mean syntactically... if you write an encoding for a new instruction it should be possible</p>



<a name="215362904"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215362904" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215362904">(Nov 02 2020 at 19:02)</a>:</h4>
<p>yeah I'm just adding a whole new recipe/instruction</p>



<a name="215362936"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215362936" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215362936">(Nov 02 2020 at 19:02)</a>:</h4>
<p>time to acquire llvm-mc...</p>



<a name="215363248"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215363248" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215363248">(Nov 02 2020 at 19:04)</a>:</h4>
<p>ok so I now have:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span>:
    <span class="p">[</span><span class="o">-</span><span class="p">,</span><span class="o">%</span><span class="n">rax</span><span class="p">]</span><span class="w">            </span><span class="n">v0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="p">;</span><span class="w"> </span><span class="n">asm</span>: <span class="nc">sub</span><span class="w"> </span><span class="cp">$</span><span class="mi">123</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">rax</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="o">-</span><span class="p">,</span><span class="o">%</span><span class="n">rbx</span><span class="p">]</span><span class="w">            </span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x86_sub_mem</span><span class="w"> </span><span class="mi">123</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">bin</span>: <span class="mi">30</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>which yields</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">FAIL</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">clif</span>: <span class="nc">binemit</span><span class="w"></span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="nc">No</span><span class="w"> </span><span class="n">encodings</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="k">for</span>: <span class="nc">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x86_sub_mem</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">123</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span><span class="w"></span>
<span class="mi">1</span><span class="w"> </span><span class="n">tests</span><span class="w"></span>
<span class="n">Error</span>: <span class="mi">1</span><span class="w"> </span><span class="n">failure</span><span class="w"></span>
</code></pre></div>



<a name="215363260"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215363260" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215363260">(Nov 02 2020 at 19:05)</a>:</h4>
<p>if you run into issues with llvm-mc I've been using XED recently and it can disassemble machine code</p>



<a name="215363308"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215363308" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215363308">(Nov 02 2020 at 19:05)</a>:</h4>
<p>what does your <a href="http://encodings.rs">encodings.rs</a> have in it?</p>



<a name="215363310"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215363310" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215363310">(Nov 02 2020 at 19:05)</a>:</h4>
<p>oh that should be iconst.i64</p>



<a name="215363343"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215363343" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215363343">(Nov 02 2020 at 19:05)</a>:</h4>
<p>I left it as </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">recipes</span><span class="p">.</span><span class="n">add_template</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">Template</span>::<span class="n">new</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">EncodingRecipeBuilder</span>::<span class="n">new</span><span class="p">(</span><span class="s">"sub_mem"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">formats</span><span class="p">.</span><span class="n">store_imm</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">operands_in</span><span class="p">(</span><span class="n">vec</span><span class="o">!</span><span class="p">[</span><span class="n">gpr</span><span class="p">])</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">operands_out</span><span class="p">(</span><span class="n">vec</span><span class="o">!</span><span class="p">[</span><span class="n">reg_rflags</span><span class="p">])</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">r</span><span class="err">#</span><span class="s">"</span>
<span class="s">                    {{PUT_OP}}(bits | (in_reg0 &amp; 7), rex1(in_reg0), sink);</span>
<span class="s">                "</span><span class="err">#</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">regs</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">rex_kind</span><span class="p">(</span><span class="n">RecipePrefixKind</span>::<span class="n">AlwaysEmitRex</span><span class="p">),</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="215363364"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215363364" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215363364">(Nov 02 2020 at 19:05)</a>:</h4>
<p>which should be the encoding of pushing a register I think</p>



<a name="215363431"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215363431" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215363431">(Nov 02 2020 at 19:06)</a>:</h4>
<p>no, I mean where you bind the CLIF to the recipe</p>



<a name="215363463"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215363463" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215363463">(Nov 02 2020 at 19:06)</a>:</h4>
<p>it says <code>e.enc_x86_64(x86_sub_mem.bind(I64), rec_x86_sub_mem.opcodes(&amp;SUB_MEM));</code></p>



<a name="215363484"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215363484" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215363484">(Nov 02 2020 at 19:06)</a>:</h4>
<p>like, if you didn't bind <code>x86_sub_mem</code> to the right type then that can cause the "no encodings" error</p>



<a name="215363564"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215363564" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215363564">(Nov 02 2020 at 19:07)</a>:</h4>
<p>so you are binding to <code>I64</code> there but in foo.clif you use <code>x86_sub_mem.i32</code></p>



<a name="215363593"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215363593" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215363593">(Nov 02 2020 at 19:07)</a>:</h4>
<p>oops yeah, now I get a little different</p>



<a name="215363594"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215363594" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215363594">(Nov 02 2020 at 19:07)</a>:</h4>
<p>I suspect one should change to match the other</p>



<a name="215363607"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215363607" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215363607">(Nov 02 2020 at 19:07)</a>:</h4>
<p><code>No matching encodings for v1 = x86_sub_mem.i64 123, v0 in [RexOp1sub_mem#83, RexOp1sub_mem#83]</code></p>



<a name="215363623"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215363623" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215363623">(Nov 02 2020 at 19:07)</a>:</h4>
<p>after changing to <code>iconst.i64</code></p>



<a name="215364055"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215364055" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215364055">(Nov 02 2020 at 19:10)</a>:</h4>
<p>Hm... weird that you are getting two of the same in that list</p>



<a name="215364060"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215364060" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215364060">(Nov 02 2020 at 19:10)</a>:</h4>
<p>aha got it!</p>



<a name="215364075"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215364075" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215364075">(Nov 02 2020 at 19:10)</a>:</h4>
<p>I needed the output to be <code>%rflags</code></p>



<a name="215370435"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215370435" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215370435">(Nov 02 2020 at 19:58)</a>:</h4>
<p>ok I think I have almost wrangled everything, thanks again for your help <span class="user-mention" data-user-id="254110">@Andrew Brown</span> and <span class="user-mention" data-user-id="254389">@Chris Fallin</span> !</p>



<a name="215391379"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215391379" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215391379">(Nov 02 2020 at 23:06)</a>:</h4>
<p>ok so turns out this is all folly, the decrement of the stack limit isn't atomic but it's also being updated from other threads</p>



<a name="215391383"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new%20recipe/near/215391383" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new.20recipe.html#215391383">(Nov 02 2020 at 23:06)</a>:</h4>
<p>back to the drawing board!</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>