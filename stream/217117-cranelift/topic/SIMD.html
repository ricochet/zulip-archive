<html>
<head><meta charset="utf-8"><title>SIMD · cranelift · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/index.html">cranelift</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html">SIMD</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="183409009"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/183409009" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#183409009">(Dec 13 2019 at 22:50)</a>:</h4>
<p>If you have a spare moment could you review some of the fixes I pushed as I was running the SIMD spec tests in wasmtime? The reviews should be rather short (&lt;50 lines): <a href="https://github.com/bytecodealliance/cranelift/pulls/abrown" target="_blank" title="https://github.com/bytecodealliance/cranelift/pulls/abrown">https://github.com/bytecodealliance/cranelift/pulls/abrown</a>.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/cranelift/pulls/abrown" style="background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)" target="_blank"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/cranelift/pulls/abrown" target="_blank" title="bytecodealliance/cranelift">bytecodealliance/cranelift</a></div><div class="message_embed_description">Cranelift code generator. Contribute to bytecodealliance/cranelift development by creating an account on GitHub.</div></div></div>



<a name="188250886"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/188250886" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#188250886">(Feb 14 2020 at 21:55)</a>:</h4>
<p>If anyone is interested in AVX-512 support in Cranelift, I just pushed <a href="https://github.com/bytecodealliance/cranelift/pull/1370" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1370">https://github.com/bytecodealliance/cranelift/pull/1370</a> to add the ability to encode instructions using the EVEX format.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/cranelift/pull/1370" style="background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)" target="_blank"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/cranelift/pull/1370" target="_blank" title="Add initial support for EVEX encodings by abrown · Pull Request #1370 · bytecodealliance/cranelift">Add initial support for EVEX encodings by abrown · Pull Request #1370 · bytecodealliance/cranelift</a></div><div class="message_embed_description">This has been discussed in issue #1244.
 A short description of what this does, why it is needed: since the Wasm SIMD spec has re-added instructions (e.g. i64x2.mul) that are optimally encoded in V...</div></div></div>



<a name="199783400"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/199783400" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#199783400">(Jun 04 2020 at 17:41)</a>:</h4>
<p>Before <span class="user-mention" data-user-id="254393">@Benjamin Bouvier</span> comes back online, I am giving anyone interested a heads up of a four PR sequence adding some remaining legalizations for Wasm SIMD instructions. The sequence is: #1765 -&gt; #1820 -&gt; #1821 -&gt; #1822. The blocking issue for me to finish this PRs has been that the spec defines semantics that make it very difficult to lower efficiently on x86. To get around this in the short term, I've added some disabled-by-default flags, <code>assert_no_nans</code> and <code>assert_in_bounds</code>, that allow users to reassure Cranelift that it doesn't need to do the extra work. I'm interested in feedback so please take a look if interested!</p>



<a name="200300668"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200300668" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200300668">(Jun 09 2020 at 22:46)</a>:</h4>
<p>Tagging some people per <span class="user-mention" data-user-id="254393">@Benjamin Bouvier</span>'s comment in <a href="https://github.com/bytecodealliance/wasmtime/pull/1820">https://github.com/bytecodealliance/wasmtime/pull/1820</a>: <span class="user-mention" data-user-id="254083">@Dan Gohman</span>, <span class="user-mention" data-user-id="254389">@Chris Fallin</span>, <span class="user-mention" data-user-id="268444">@Julian Seward</span></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/1820" style="background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/1820" title="Implement fcvt_to_sint_sat (f32x4 -&gt; i32x4) for x86 by abrown · Pull Request #1820 · bytecodealliance/wasmtime">Implement fcvt_to_sint_sat (f32x4 -&gt; i32x4) for x86 by abrown · Pull Request #1820 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">This is a follow-on to #1765 and should be merged after that PR.
The most notable change here is the addition of the ISA-specific flags assert_no_nans and assert_in_bounds which are disabled by def...</div></div></div>



<a name="200300836"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200300836" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200300836">(Jun 09 2020 at 22:49)</a>:</h4>
<p>If assert_no_nans is set and a NaN happens, it's undefined behavior?</p>



<a name="200300865"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200300865" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200300865">(Jun 09 2020 at 22:49)</a>:</h4>
<p>Yes</p>



<a name="200300884"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200300884" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200300884">(Jun 09 2020 at 22:49)</a>:</h4>
<p>So we won't be able to set that for wasm code</p>



<a name="200300890"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200300890" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200300890">(Jun 09 2020 at 22:49)</a>:</h4>
<p>(I'm writing up a more full explanation... one sec)</p>



<a name="200301104"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200301104" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200301104">(Jun 09 2020 at 22:51)</a>:</h4>
<p>The idea of adding <code>assert_no_nans</code> (or any other flag that would make runtime guarantees) is a tricky one. With #1820 I added only a first step in that direction by allowing users to assert at runtime that their program will not have NaNs--this allows Cranelift to generate faster code. Of course, this is a hammer approach to a screwdriver problem because it affects, e.g., every f32x4.max in the program. This is bad: 1) the user has to apply the guarantee to the whole program, and 2) the user usually can't make this guarantee since they don't understand all the parts of the code they are running</p>



<a name="200301363"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200301363" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200301363">(Jun 09 2020 at 22:53)</a>:</h4>
<p>I thought of this flag as an experimental thing and not the end solution. The end solution would have to involve programmer guarantees through, e.g., new C attributes like <code>__attribute__((no_nans))</code> which would have to propagate through a Wasm custom section to Cranelift.</p>



<a name="200301463"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200301463" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200301463">(Jun 09 2020 at 22:54)</a>:</h4>
<p>So, it could be set for Wasm code... initially for experimental benchmarking with the hammer flag and eventually through a more fine-grained mechanism</p>



<a name="200301630"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200301630" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200301630">(Jun 09 2020 at 22:56)</a>:</h4>
<p>Does that explain the idea better?</p>



<a name="200301703"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200301703" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200301703">(Jun 09 2020 at 22:57)</a>:</h4>
<p>Ok, so that would be something we'd coordinate with the wasm simd proposal?</p>



<a name="200301840"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200301840" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200301840">(Jun 09 2020 at 22:59)</a>:</h4>
<p>Eventually... I would like to try out this experimental flag approach with some benchmarks and see if it is worth it to pursue further</p>



<a name="200301871"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200301871" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200301871">(Jun 09 2020 at 22:59)</a>:</h4>
<p>Ah, ok.</p>



<a name="200301872"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200301872" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200301872">(Jun 09 2020 at 22:59)</a>:</h4>
<p>If it is and there is support from other people, then we could standardize it; if not, we just remove the flags</p>



<a name="200302000"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200302000" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200302000">(Jun 09 2020 at 23:00)</a>:</h4>
<p>So, looking at the code, why is there a <code>band</code> with an all-ones operand?</p>



<a name="200302209"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200302209" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200302209">(Jun 09 2020 at 23:03)</a>:</h4>
<p>Um... it's been a bit since I looked at it but I thought that had to do with quieting NaNs</p>



<a name="200302282"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200302282" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200302282">(Jun 09 2020 at 23:04)</a>:</h4>
<p>(or it could be a mistake as I was looking at V8 at the time)</p>



<a name="200302292"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200302292" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200302292">(Jun 09 2020 at 23:04)</a>:</h4>
<p>We run with signaling-NaN signaling disabled, so we can probably skip that</p>



<a name="200302379"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200302379" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200302379">(Jun 09 2020 at 23:05)</a>:</h4>
<p>We = all Cranelift-using wasm engines</p>



<a name="200302404"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200302404" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200302404">(Jun 09 2020 at 23:05)</a>:</h4>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> and can you point me to where that is happening?</p>



<a name="200302503"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200302503" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200302503">(Jun 09 2020 at 23:06)</a>:</h4>
<p><a href="https://github.com/bytecodealliance/wasmtime/pull/1820/files#diff-f5aa2e18f8d875720c00f30b86cb69d4R1003">https://github.com/bytecodealliance/wasmtime/pull/1820/files#diff-f5aa2e18f8d875720c00f30b86cb69d4R1003</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/1820/files#diff-f5aa2e18f8d875720c00f30b86cb69d4R1003" style="background-image: url(https://avatars0.githubusercontent.com/u/541880?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/1820/files#diff-f5aa2e18f8d875720c00f30b86cb69d4R1003" title="Implement fcvt_to_sint_sat (f32x4 -&gt; i32x4) for x86 by abrown · Pull Request #1820 · bytecodealliance/wasmtime">Implement fcvt_to_sint_sat (f32x4 -&gt; i32x4) for x86 by abrown · Pull Request #1820 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">This is a follow-on to #1765 and should be merged after that PR.
The most notable change here is the addition of the ISA-specific flags assert_no_nans and assert_in_bounds which are disabled by def...</div></div></div>



<a name="200302521"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200302521" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200302521">(Jun 09 2020 at 23:07)</a>:</h4>
<p>No, I mean the FP configuration</p>



<a name="200302527"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200302527" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200302527">(Jun 09 2020 at 23:07)</a>:</h4>
<p>...if any</p>



<a name="200302727"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200302727" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200302727">(Jun 09 2020 at 23:09)</a>:</h4>
<p>oh, it's the default mxcsr setting</p>



<a name="200303315"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200303315" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200303315">(Jun 09 2020 at 23:17)</a>:</h4>
<p>Also, I'm trying to figure out that bxor at the end.  Should that be a band_not?</p>



<a name="200303514"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200303514" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200303514">(Jun 09 2020 at 23:20)</a>:</h4>
<p>Here's what I referenced in V8: <a href="https://github.com/v8/v8/blob/master/src/compiler/backend/x64/code-generator-x64.cc#L3011-L3028">https://github.com/v8/v8/blob/master/src/compiler/backend/x64/code-generator-x64.cc#L3011-L3028</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/v8/v8/blob/master/src/compiler/backend/x64/code-generator-x64.cc#L3011-L3028" style="background-image: url(https://avatars0.githubusercontent.com/u/113781?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/v8/v8/blob/master/src/compiler/backend/x64/code-generator-x64.cc#L3011-L3028" title="v8/v8">v8/v8</a></div><div class="message_embed_description">The official mirror of the V8 Git repository. Contribute to v8/v8 development by creating an account on GitHub.</div></div></div>



<a name="200303528"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200303528" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200303528">(Jun 09 2020 at 23:20)</a>:</h4>
<p>I documented some of the other instructions better than this one...</p>



<a name="200303812"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200303812" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200303812">(Jun 09 2020 at 23:24)</a>:</h4>
<p>Need to drop but I'll check back in tomorrow; I'm interested in hearing more opinions on this experimental flag idea... and Dan if you just want to review that PR that would be great!!!</p>



<a name="200303963"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200303963" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200303963">(Jun 09 2020 at 23:26)</a>:</h4>
<p>oh, I think the cmpeqps in there isn't generating an all-ones</p>



<a name="200526286"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200526286" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Julian Seward <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200526286">(Jun 11 2020 at 10:20)</a>:</h4>
<p><span class="user-mention" data-user-id="254110">@Andrew Brown</span> can you say some more about the difficulties in implementing <code>fcvt_to_sint_sat (f32x4 -&gt; i32x4)</code>efficiently?  What sequence do you have to generate?</p>



<a name="200560471"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200560471" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200560471">(Jun 11 2020 at 15:30)</a>:</h4>
<p>I can't say I suffered through that sequence much since I followed <a href="https://github.com/v8/v8/blob/master/src/compiler/backend/x64/code-generator-x64.cc#L3011-L3028">what v8 does</a> (with one misunderstanding about their use of CMPEQPS). I think the bigger problem is that this and <a href="https://github.com/WebAssembly/simd/issues?q=is%3Aissue+is%3Aopen+inefficient">many other instructions</a> have inefficient lowerings on x86 compared to other architectures. I've raised the issues and measured benchmarks and what I have concluded is that to make up for the extra instructions the spec semantics require we need several optimizations (like <a href="https://github.com/bytecodealliance/wasmtime/issues/1187">this one</a>) and something along the lines of the guarantees I proposed in #1820. As noted above the "experimental flag" approach is not the best long-term solution but it can reduce the number of instructions emitted for several of the most inefficient instructions.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/v8/v8/blob/master/src/compiler/backend/x64/code-generator-x64.cc#L3011-L3028" style="background-image: url(https://avatars0.githubusercontent.com/u/113781?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/v8/v8/blob/master/src/compiler/backend/x64/code-generator-x64.cc#L3011-L3028" title="v8/v8">v8/v8</a></div><div class="message_embed_description">The official mirror of the V8 Git repository. Contribute to v8/v8 development by creating an account on GitHub.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/simd/issues?q=is%3Aissue+is%3Aopen+inefficient" style="background-image: url(https://avatars3.githubusercontent.com/u/11578470?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/simd/issues?q=is%3Aissue+is%3Aopen+inefficient" title="WebAssembly/simd">WebAssembly/simd</a></div><div class="message_embed_description">Branch of the spec repo scoped to discussion of SIMD in WebAssembly  - WebAssembly/simd</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/issues/1187" style="background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/issues/1187" title="Improve bitselect codegen with knowledge of operand origin · Issue #1187 · bytecodealliance/wasmtime">Improve bitselect codegen with knowledge of operand origin · Issue #1187 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">Feature As discussed in WebAssembly/simd#192, the Wasm SIMD bitselect instruction could be lowered to one of the x86 BLEND* family of instructions instead using 3-4 instructions. Benefit Potentiall...</div></div></div>



<a name="200561980"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200561980" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Bouvier <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200561980">(Jun 11 2020 at 15:41)</a>:</h4>
<p>Re: the flag, i was trying to think briefly in terms of security behaviors. The only case in which it's fine to set the flag is when you're running Cranelift on your own hardware; otherwise, it seems that setting the flag could open the door for correctness issues in the best case, security vulnerabilities in the worst one. So it might not be applicable to the browser use case, for one thing.</p>



<a name="200562478"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200562478" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Bouvier <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200562478">(Jun 11 2020 at 15:44)</a>:</h4>
<p>I hear the performance improvements it can bring, and from my memories of the wasm spec in general (around max/min), I understand there might be some nice wins from doing this. I would be tempted to have this if we had a clear understanding of what's the worst that can happen when the flag isn't respected, and what we can do for this.</p>



<a name="200562625"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200562625" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Bouvier <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200562625">(Jun 11 2020 at 15:45)</a>:</h4>
<p>Or considering alternatives; maybe we want some other low-level CLIR instructions that don't have these checks, and the emitter can choose to emit one or the other, or group the unsafe ones in a code sequence guarded by a check that the inputs are not NaNs. (Mostly equivalent to hoisting the NaN checks in one place)</p>



<a name="200562842"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200562842" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Bouvier <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200562842">(Jun 11 2020 at 15:46)</a>:</h4>
<p>Could the experiments be done without checking in all the code upstream (in wasmtime master)?</p>



<a name="200568502"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200568502" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200568502">(Jun 11 2020 at 16:27)</a>:</h4>
<blockquote>
<p>The only case in which it's fine to set the flag is when you're running Cranelift on your own hardware</p>
</blockquote>
<p>I agree with what you said about experimental flags, but I have convinced myself that a per-instruction attribute (the better, long-term solution) set by the programmer (not knowing the runtime hardware) would also be just as safe--I mean, the user is already trusting the programmer to write correct code so they can also trust the programmer to make a per-instruction guarantee</p>
<blockquote>
<p>I would be tempted to have this if we had a clear understanding of what's the worst that can happen when the flag isn't respected</p>
</blockquote>
<p>I don't think I understand this concern: if the user doesn't apply the flag, the code runs slower; if the user applies the flag, they may have unexpected data (if they assumed a NaN was converted to a zero but then was not).</p>



<a name="200569137"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200569137" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200569137">(Jun 11 2020 at 16:31)</a>:</h4>
<p>On the alternatives: hoisting doesn't work if the operands of the guaranteed instruction are created inside a loop. And I could just keep all my optimizations local and just test locally but I guess the point of discussing this is to figure out if you all agree that Cranelift should try out this approach, from a philosophical standpoint, first as an experimental flag and possibly later with a per-instruction attribute.</p>



<a name="200569459"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200569459" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200569459">(Jun 11 2020 at 16:34)</a>:</h4>
<p>(looks like we are all online if and I would be open to discussing on Zoom for a few minutes if that is quicker)</p>



<a name="200570301"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200570301" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Julian Seward <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200570301">(Jun 11 2020 at 16:41)</a>:</h4>
<p>I must be honest and say I am not in favour of <code>assert_no_nans</code>.  The effect of it is to make the meaning of CLIR dependent on some external context, where it wasn't before.  "Under-the-table" semantics, I think of it as.</p>
<p>As Dan says, we can't use it for translating wasm.  What would perhaps be better is to wait for v2 of the wasm simd spec, which Lars tells me might have some variants of existing insns that have cheaper to implement on Intel.  Then we'd have a cheaper implementation available exactly for those insns which are currently expensive, without <code>assert_no_nans</code>, and without creating the possibility of tagging arbitrary cranelift insns with a "cheap semantics please" flag in cases where that has no meaning.  Specifically, we could add cheap-variant CLIR ops for exactly those which are currently problematic, and for no others.</p>



<a name="200572169"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200572169" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200572169">(Jun 11 2020 at 16:53)</a>:</h4>
<p>I don't have much confidence in v2 of the spec... my experience so far has been that it is very difficult raise these types of lowering issues and get some type of resolution for x86 (hence looking at "under-the-table" semantics <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span>). I agree that a solution at the spec level would be best but, in the absence of that, this approach seemed second-best and perhaps even a way to influence the spec, e.g. "if this flag is necessary to achieve near-native performance, why don't we just add some Wasm SIMD instructions?"</p>



<a name="200572605"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200572605" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200572605">(Jun 11 2020 at 16:56)</a>:</h4>
<blockquote>
<p>As Dan says, we can't use it for translating Wasm</p>
</blockquote>
<p>I think you can in certain scenarios (e.g. performance experiments) but by default this flag would be off; users would have to know what they're doing before using something like this.</p>



<a name="200731352"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200731352" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200731352">(Jun 12 2020 at 22:25)</a>:</h4>
<p>Ok, to resolve this discussion: I closed #1820 (which had guarantee flags) and re-opened it without flags as <a href="https://github.com/bytecodealliance/wasmtime/pull/1876">https://github.com/bytecodealliance/wasmtime/pull/1876</a>.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/1876" style="background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/1876" title="Implement fcvt_to_sint_sat (f32x4 -&gt; i32x4) for x86 by abrown · Pull Request #1876 · bytecodealliance/wasmtime">Implement fcvt_to_sint_sat (f32x4 -&gt; i32x4) for x86 by abrown · Pull Request #1876 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">This is the same as #1820 without the runtime guarantee flags.</div></div></div>



<a name="200731516"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/SIMD/near/200731516" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/SIMD.html#200731516">(Jun 12 2020 at 22:27)</a>:</h4>
<p>I tagged <span class="user-mention" data-user-id="268444">@Julian Seward</span> as the reviewer since you looked at the last one--thanks for the reviews!</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>