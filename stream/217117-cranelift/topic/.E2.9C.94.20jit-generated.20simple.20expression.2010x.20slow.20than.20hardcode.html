<html>
<head><meta charset="utf-8"><title>✔ jit-generated simple expression 10x slow than hardcode · cranelift · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/index.html">cranelift</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20jit-generated.20simple.20expression.2010x.20slow.20than.20hardcode.html">✔ jit-generated simple expression 10x slow than hardcode</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="422077002"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20jit-generated%20simple%20expression%2010x%20slow%20than%20hardcode/near/422077002" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jeremy Mei(梅杰) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20jit-generated.20simple.20expression.2010x.20slow.20than.20hardcode.html#422077002">(Feb 18 2024 at 07:51)</a>:</h4>
<p>Hi, everyone.</p>
<h2>summary</h2>
<p>after compare the performance, i found jit-generated simple expression <code>(3.0 + 4.0) / 3.0 &lt; 4.0</code> 10x slow than hardcode. so my question is:</p>
<ol>
<li>Is this as expected?</li>
<li>If not，how i can improved the performance?</li>
</ol>
<h2>the bench</h2>
<p>the  <code>create_jit_op</code>function generate a function that are equivalent to <code>arrow_native_calc</code>.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">arrow_native_calc</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">ArrowNativeTypeOp</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span>: <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="n">c</span>: <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="n">d</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">add_wrapping</span><span class="p">(</span><span class="n">b</span><span class="p">).</span><span class="n">div_wrapping</span><span class="p">(</span><span class="n">c</span><span class="p">).</span><span class="n">lt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">hardcode_calc</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span>
<span class="w">    </span><span class="p">(</span><span class="mf">3.0_</span><span class="k">f64</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">4.0_</span><span class="k">f64</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">3.0_</span><span class="k">f64</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">4.0_</span><span class="k">f64</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">add_benchmark</span><span class="p">(</span><span class="n">c</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Criterion</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_jit_op</span><span class="p">();</span>
<span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">bench_function</span><span class="p">(</span><span class="s">"arrow_native_calc"</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">b</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">b</span><span class="p">.</span><span class="n">iter</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="n">criterion</span>::<span class="n">black_box</span><span class="p">(</span><span class="n">arrow_native_calc</span><span class="p">(</span><span class="mf">3.0_</span><span class="k">f64</span><span class="p">,</span><span class="w"> </span><span class="mf">4.0_</span><span class="k">f64</span><span class="p">,</span><span class="w"> </span><span class="mf">3.0_</span><span class="k">f64</span><span class="p">,</span><span class="w"> </span><span class="mf">4.0_</span><span class="k">f64</span><span class="p">)))</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">bench_function</span><span class="p">(</span><span class="s">"hardcode_calc"</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">b</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">b</span><span class="p">.</span><span class="n">iter</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="n">criterion</span>::<span class="n">black_box</span><span class="p">(</span><span class="n">hardcode_calc</span><span class="p">()))</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">bench_function</span><span class="p">(</span><span class="s">"jit_calc"</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">b</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">b</span><span class="p">.</span><span class="n">iter</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="n">criterion</span>::<span class="n">black_box</span><span class="p">(</span><span class="n">op</span><span class="p">(</span><span class="mf">3.0_</span><span class="k">f64</span><span class="p">,</span><span class="w"> </span><span class="mf">4.0_</span><span class="k">f64</span><span class="p">)))</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">}</span>

<span class="n">criterion_group</span><span class="o">!</span><span class="p">(</span><span class="n">benches</span><span class="p">,</span><span class="w"> </span><span class="n">add_benchmark</span><span class="p">);</span>
<span class="n">criterion_main</span><span class="o">!</span><span class="p">(</span><span class="n">benches</span><span class="p">);</span>
</code></pre></div>
<h2>bench result</h2>
<p>the result show <code>jit_calc</code> 10x slower than <code>arrow_native_calc</code> and <code>hardcode_calc</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">arrow_native_calc</span><span class="w">       </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">543.67</span><span class="w"> </span><span class="n">ps</span><span class="w"> </span><span class="mf">546.12</span><span class="w"> </span><span class="n">ps</span><span class="w"> </span><span class="mf">549.82</span><span class="w"> </span><span class="n">ps</span><span class="p">]</span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">-</span><span class="mf">0.9606</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">0.4079</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">2.0981</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.68</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
<span class="w">                        </span><span class="n">No</span><span class="w"> </span><span class="n">change</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">performance</span><span class="w"> </span><span class="n">detected</span><span class="p">.</span>
<span class="n">Found</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">outliers</span><span class="w"> </span><span class="n">among</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">measurements</span><span class="w"> </span><span class="p">(</span><span class="mf">5.00</span><span class="o">%</span><span class="p">)</span>
<span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="mf">1.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">low</span><span class="w"> </span><span class="n">mild</span>
<span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="mf">2.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">mild</span>
<span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="mf">2.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">severe</span>

<span class="n">hardcode_calc</span><span class="w">           </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">541.32</span><span class="w"> </span><span class="n">ps</span><span class="w"> </span><span class="mf">542.14</span><span class="w"> </span><span class="n">ps</span><span class="w"> </span><span class="mf">542.98</span><span class="w"> </span><span class="n">ps</span><span class="p">]</span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">-</span><span class="mf">1.1323</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">0.7533</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">0.4321</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
<span class="w">                        </span><span class="n">Change</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="n">noise</span><span class="w"> </span><span class="n">threshold</span><span class="p">.</span>
<span class="n">Found</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">outliers</span><span class="w"> </span><span class="n">among</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">measurements</span><span class="w"> </span><span class="p">(</span><span class="mf">2.00</span><span class="o">%</span><span class="p">)</span>
<span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="mf">1.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">mild</span>
<span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="mf">1.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">severe</span>

<span class="n">jit_calc</span><span class="w">                </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">8.4618</span><span class="w"> </span><span class="n">ns</span><span class="w"> </span><span class="mf">8.5140</span><span class="w"> </span><span class="n">ns</span><span class="w"> </span><span class="mf">8.5938</span><span class="w"> </span><span class="n">ns</span><span class="p">]</span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">-</span><span class="mf">98.873</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">98.850</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">98.831</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span>
<span class="n">Found</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="n">outliers</span><span class="w"> </span><span class="n">among</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">measurements</span><span class="w"> </span><span class="p">(</span><span class="mf">14.00</span><span class="o">%</span><span class="p">)</span>
<span class="w">  </span><span class="mi">4</span><span class="w"> </span><span class="p">(</span><span class="mf">4.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">mild</span>
<span class="w">  </span><span class="mi">10</span><span class="w"> </span><span class="p">(</span><span class="mf">10.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">severe</span>
</code></pre></div>
<h2>the detail of <code>create_jit_op</code></h2>
<ol>
<li><strong>how function generated</strong></li>
</ol>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">create_jit_op</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">fn</span><span class="p">(</span><span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="kt">f64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CodegenContext</span>::<span class="n">default</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// call_conv is CallConv::Fast,</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">func_ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">create_func_gen_ctx</span><span class="p">(</span>
<span class="w">        </span><span class="s">"op"</span><span class="p">,</span>
<span class="w">        </span><span class="fm">vec!</span><span class="p">[</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">F64</span><span class="p">),</span><span class="w"> </span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">F64</span><span class="p">)],</span>
<span class="w">        </span><span class="fm">vec!</span><span class="p">[</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">I8</span><span class="p">)],</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">entry_block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_ctx</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="n">create_block</span><span class="p">();</span>
<span class="w">    </span><span class="n">func_ctx</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="n">switch_to_block</span><span class="p">(</span><span class="n">entry_block</span><span class="p">);</span>
<span class="w">    </span><span class="n">func_ctx</span>
<span class="w">        </span><span class="p">.</span><span class="n">builder</span>
<span class="w">        </span><span class="p">.</span><span class="n">append_block_params_for_function_params</span><span class="p">(</span><span class="n">entry_block</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// call f64 add wrapping on tuple, and call_conv: CallConv::Fast,</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">lhs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_ctx</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="n">block_params</span><span class="p">(</span><span class="n">entry_block</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rhs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_ctx</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="n">block_params</span><span class="p">(</span><span class="n">entry_block</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_ctx</span><span class="p">.</span><span class="n">call_f64_add_wrapping</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span><span class="w"> </span><span class="n">rhs</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// call f64 div wrapping on res and f64 const and call_conv: CallConv::Fast,</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rhs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_ctx</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">f64const</span><span class="p">(</span><span class="mf">3.0</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_ctx</span><span class="p">.</span><span class="n">call_f64_div_wrapping</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">rhs</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// call f64 lt on &amp;res and &amp;f64 const and call_conv: CallConv::Fast,</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">slot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_ctx</span>
<span class="w">        </span><span class="p">.</span><span class="n">builder</span>
<span class="w">        </span><span class="p">.</span><span class="n">func</span>
<span class="w">        </span><span class="p">.</span><span class="n">create_sized_stack_slot</span><span class="p">(</span><span class="n">StackSlotData</span>::<span class="n">new</span><span class="p">(</span><span class="n">StackSlotKind</span>::<span class="n">ExplicitSlot</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res_ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_ctx</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">stack_addr</span><span class="p">(</span><span class="n">func_ctx</span><span class="p">.</span><span class="n">ptype</span><span class="p">,</span><span class="w"> </span><span class="n">slot</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">func_ctx</span>
<span class="w">        </span><span class="p">.</span><span class="n">builder</span>
<span class="w">        </span><span class="p">.</span><span class="n">ins</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">MemFlags</span>::<span class="n">new</span><span class="p">(),</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">res_ref</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rhs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_ctx</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">f64const</span><span class="p">(</span><span class="mf">4.0</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rhs_ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_ctx</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">stack_addr</span><span class="p">(</span><span class="n">func_ctx</span><span class="p">.</span><span class="n">ptype</span><span class="p">,</span><span class="w"> </span><span class="n">slot</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">func_ctx</span>
<span class="w">        </span><span class="p">.</span><span class="n">builder</span>
<span class="w">        </span><span class="p">.</span><span class="n">ins</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">MemFlags</span>::<span class="n">new</span><span class="p">(),</span><span class="w"> </span><span class="n">rhs</span><span class="p">,</span><span class="w"> </span><span class="n">rhs_ref</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_ctx</span><span class="p">.</span><span class="n">call_f64_lt</span><span class="p">(</span><span class="n">res_ref</span><span class="p">,</span><span class="w"> </span><span class="n">rhs_ref</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">func_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_ctx</span><span class="p">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">func_id</span><span class="p">);</span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">mem</span>::<span class="n">transmute</span>::<span class="o">&lt;</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="kt">f64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span><span class="o">&gt;</span><span class="p">(</span><span class="n">code</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ol start="2">
<li><strong>call imported function.</strong></li>
</ol>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">call_f64_add_wrapping</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">lhs</span>: <span class="nc">Value</span><span class="p">,</span><span class="w"> </span><span class="n">rhs</span>: <span class="nc">Value</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Value</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NativeOpCall</span>::<span class="n">Float64AddWrapping</span><span class="p">;</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">call_binary</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">lhs</span><span class="p">,</span><span class="w"> </span><span class="n">rhs</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">call_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">op</span>: <span class="nc">NativeOpCall</span><span class="p">,</span><span class="w"> </span><span class="n">lhs</span>: <span class="nc">Value</span><span class="p">,</span><span class="w"> </span><span class="n">rhs</span>: <span class="nc">Value</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Value</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">op</span><span class="p">.</span><span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">ptype</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// FIXME this don't generate new func id during every call.</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">func_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span>
<span class="w">            </span><span class="p">.</span><span class="n">module</span>
<span class="w">            </span><span class="p">.</span><span class="n">declare_function</span><span class="p">(</span><span class="n">op</span><span class="p">.</span><span class="n">name</span><span class="p">(),</span><span class="w"> </span><span class="n">Linkage</span>::<span class="n">Import</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sig</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">declare_func_in_func</span><span class="p">(</span><span class="n">func_id</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="n">func</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">call</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">lhs</span><span class="p">,</span><span class="w"> </span><span class="n">rhs</span><span class="p">]);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="n">inst_results</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">len</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="k">fn</span> <span class="nf">signature</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">pointer_type</span>: <span class="nc">Type</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Signature</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">use</span><span class="w"> </span><span class="n">NativeOpCall</span>::<span class="o">*</span><span class="p">;</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Float64AddWrapping</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Float64DivWrapping</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Signature</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">params</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">F64</span><span class="p">),</span><span class="w"> </span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">F64</span><span class="p">)],</span>
<span class="w">                </span><span class="n">returns</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">F64</span><span class="p">)],</span>
<span class="w">                </span><span class="n">call_conv</span>: <span class="nc">CallConv</span>::<span class="n">Fast</span><span class="p">,</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="n">Float64Lt</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Signature</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">params</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer_type</span><span class="p">),</span><span class="w"> </span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">pointer_type</span><span class="p">)],</span>
<span class="w">                </span><span class="n">returns</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">I8</span><span class="p">)],</span>
<span class="w">                </span><span class="n">call_conv</span>: <span class="nc">CallConv</span>::<span class="n">Fast</span><span class="p">,</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="k">fn</span> <span class="nf">addr</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">use</span><span class="w"> </span><span class="n">NativeOpCall</span>::<span class="o">*</span><span class="p">;</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Float64AddWrapping</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kt">f64</span>::<span class="n">add_wrapping</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">            </span><span class="n">Float64DivWrapping</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kt">f64</span>::<span class="n">div_wrapping</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">            </span><span class="n">Float64Lt</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kt">f64</span>::<span class="n">lt</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<ol start="3">
<li><strong>flag settings</strong></li>
</ol>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">build_flags</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">settings</span>::<span class="n">Flags</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">flag_builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span>::<span class="n">builder</span><span class="p">();</span>
<span class="w">    </span><span class="n">flag_builder</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="s">"use_colocated_libcalls"</span><span class="p">,</span><span class="w"> </span><span class="s">"false"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="n">flag_builder</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="s">"is_pic"</span><span class="p">,</span><span class="w"> </span><span class="s">"false"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="n">flag_builder</span>
<span class="w">        </span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="s">"enable_llvm_abi_extensions"</span><span class="p">,</span><span class="w"> </span><span class="s">"true"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="n">flag_builder</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="s">"opt_level"</span><span class="p">,</span><span class="w"> </span><span class="s">"speed"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span>::<span class="n">Flags</span>::<span class="n">new</span><span class="p">(</span><span class="n">flag_builder</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="o">!</span><span class="n">flags</span><span class="p">.</span><span class="n">use_colocated_libcalls</span><span class="p">());</span>
<span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="o">!</span><span class="n">flags</span><span class="p">.</span><span class="n">is_pic</span><span class="p">());</span>
<span class="w">    </span><span class="n">flags</span>
<span class="p">}</span>
</code></pre></div>



<a name="422086808"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20jit-generated%20simple%20expression%2010x%20slow%20than%20hardcode/near/422086808" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20jit-generated.20simple.20expression.2010x.20slow.20than.20hardcode.html#422086808">(Feb 18 2024 at 10:27)</a>:</h4>
<p>LLVM will optimize hardcode_calc and the arrow_native_calc call to constant values. You need to black_box the constants in the calculation to prevent this. I'm not sure if Cranelift optimizes float operations with known operands to a constant.</p>



<a name="422088620"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20jit-generated%20simple%20expression%2010x%20slow%20than%20hardcode/near/422088620" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jeremy Mei(梅杰) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20jit-generated.20simple.20expression.2010x.20slow.20than.20hardcode.html#422088620">(Feb 18 2024 at 10:57)</a>:</h4>
<p><span class="user-mention" data-user-id="264278">@bjorn3</span> still 5x slow.</p>
<h1>bench result.</h1>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Running</span><span class="w"> </span><span class="n">benches</span><span class="o">/</span><span class="n">scalar_calc</span><span class="p">.</span><span class="n">rs</span><span class="w"> </span><span class="p">(</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">deps</span><span class="o">/</span><span class="n">scalar_calc</span><span class="o">-</span><span class="n">a5b82b9d208b7531</span><span class="p">)</span>
<span class="n">arrow_native_calc</span><span class="w">       </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">1.4768</span><span class="w"> </span><span class="n">ns</span><span class="w"> </span><span class="mf">1.4820</span><span class="w"> </span><span class="n">ns</span><span class="w"> </span><span class="mf">1.4890</span><span class="w"> </span><span class="n">ns</span><span class="p">]</span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">-</span><span class="mf">0.6881</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">0.2297</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">0.1460</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.29</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
<span class="w">                        </span><span class="n">No</span><span class="w"> </span><span class="n">change</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">performance</span><span class="w"> </span><span class="n">detected</span><span class="p">.</span>
<span class="n">Found</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="n">outliers</span><span class="w"> </span><span class="n">among</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">measurements</span><span class="w"> </span><span class="p">(</span><span class="mf">9.00</span><span class="o">%</span><span class="p">)</span>
<span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="mf">1.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">low</span><span class="w"> </span><span class="n">severe</span>
<span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="mf">1.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">low</span><span class="w"> </span><span class="n">mild</span>
<span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="mf">2.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">mild</span>
<span class="w">  </span><span class="mi">5</span><span class="w"> </span><span class="p">(</span><span class="mf">5.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">severe</span>

<span class="n">hardcode_calc</span><span class="w">           </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">1.8864</span><span class="w"> </span><span class="n">ns</span><span class="w"> </span><span class="mf">1.8950</span><span class="w"> </span><span class="n">ns</span><span class="w"> </span><span class="mf">1.9124</span><span class="w"> </span><span class="n">ns</span><span class="p">]</span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">-</span><span class="mf">0.6743</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">0.0642</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">0.6151</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.86</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
<span class="w">                        </span><span class="n">No</span><span class="w"> </span><span class="n">change</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">performance</span><span class="w"> </span><span class="n">detected</span><span class="p">.</span>
<span class="n">Found</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="n">outliers</span><span class="w"> </span><span class="n">among</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">measurements</span><span class="w"> </span><span class="p">(</span><span class="mf">14.00</span><span class="o">%</span><span class="p">)</span>
<span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="mf">1.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">low</span><span class="w"> </span><span class="n">severe</span>
<span class="w">  </span><span class="mi">6</span><span class="w"> </span><span class="p">(</span><span class="mf">6.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">mild</span>
<span class="w">  </span><span class="mi">7</span><span class="w"> </span><span class="p">(</span><span class="mf">7.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">severe</span>

<span class="n">jit_calc</span><span class="w">                </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">7.4061</span><span class="w"> </span><span class="n">ns</span><span class="w"> </span><span class="mf">7.4375</span><span class="w"> </span><span class="n">ns</span><span class="w"> </span><span class="mf">7.4785</span><span class="w"> </span><span class="n">ns</span><span class="p">]</span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">-</span><span class="mf">99.119</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">99.081</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">99.043</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span>
<span class="n">Found</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="n">outliers</span><span class="w"> </span><span class="n">among</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">measurements</span><span class="w"> </span><span class="p">(</span><span class="mf">12.00</span><span class="o">%</span><span class="p">)</span>
<span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="mf">2.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">mild</span>
<span class="w">  </span><span class="mi">10</span><span class="w"> </span><span class="p">(</span><span class="mf">10.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">severe</span>
</code></pre></div>
<h1>the bench code.</h1>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">arrow_native_calc</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">ArrowNativeTypeOp</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span>: <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="n">c</span>: <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="n">d</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">add_wrapping</span><span class="p">(</span><span class="n">b</span><span class="p">).</span><span class="n">div_wrapping</span><span class="p">(</span><span class="n">c</span><span class="p">).</span><span class="n">lt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">hardcode_calc</span><span class="p">(</span><span class="n">a</span>: <span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="n">c</span>: <span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="n">d</span>: <span class="kt">f64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span>
<span class="w">    </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">d</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">add_benchmark</span><span class="p">(</span><span class="n">c</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Criterion</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_jit_op</span><span class="p">();</span>
<span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">bench_function</span><span class="p">(</span><span class="s">"arrow_native_calc"</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">b</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">b</span><span class="p">.</span><span class="n">iter</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">arrow_native_calc</span><span class="p">(</span>
<span class="w">                </span><span class="n">black_box</span><span class="p">(</span><span class="mf">3.0_</span><span class="k">f64</span><span class="p">),</span>
<span class="w">                </span><span class="n">black_box</span><span class="p">(</span><span class="mf">4.0_</span><span class="k">f64</span><span class="p">),</span>
<span class="w">                </span><span class="n">black_box</span><span class="p">(</span><span class="mf">3.0_</span><span class="k">f64</span><span class="p">),</span>
<span class="w">                </span><span class="n">black_box</span><span class="p">(</span><span class="mf">4.0_</span><span class="k">f64</span><span class="p">),</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">bench_function</span><span class="p">(</span><span class="s">"hardcode_calc"</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">b</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">b</span><span class="p">.</span><span class="n">iter</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">criterion</span>::<span class="n">black_box</span><span class="p">(</span><span class="n">hardcode_calc</span><span class="p">(</span>
<span class="w">                </span><span class="n">black_box</span><span class="p">(</span><span class="mf">3.0_</span><span class="k">f64</span><span class="p">),</span>
<span class="w">                </span><span class="n">black_box</span><span class="p">(</span><span class="mf">4.0_</span><span class="k">f64</span><span class="p">),</span>
<span class="w">                </span><span class="n">black_box</span><span class="p">(</span><span class="mf">3.0_</span><span class="k">f64</span><span class="p">),</span>
<span class="w">                </span><span class="n">black_box</span><span class="p">(</span><span class="mf">4.0_</span><span class="k">f64</span><span class="p">),</span>
<span class="w">            </span><span class="p">))</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">bench_function</span><span class="p">(</span><span class="s">"jit_calc"</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">b</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">b</span><span class="p">.</span><span class="n">iter</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="n">op</span><span class="p">(</span><span class="n">black_box</span><span class="p">(</span><span class="mf">3.0_</span><span class="k">f64</span><span class="p">),</span><span class="w"> </span><span class="n">black_box</span><span class="p">(</span><span class="mf">4.0_</span><span class="k">f64</span><span class="p">)))</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">}</span>

<span class="n">criterion_group</span><span class="o">!</span><span class="p">(</span><span class="n">benches</span><span class="p">,</span><span class="w"> </span><span class="n">add_benchmark</span><span class="p">);</span>
<span class="n">criterion_main</span><span class="o">!</span><span class="p">(</span><span class="n">benches</span><span class="p">);</span>
</code></pre></div>



<a name="422093819"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20jit-generated%20simple%20expression%2010x%20slow%20than%20hardcode/near/422093819" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20jit-generated.20simple.20expression.2010x.20slow.20than.20hardcode.html#422093819">(Feb 18 2024 at 12:23)</a>:</h4>
<p>Could you try replacing <code>hardcode_calc(...)</code> with <code>criterion::black_box(hardcode_calc as fn(f64, f64, f64, f64) -&gt; f64)(...)</code> to avoid inlining the <code>hardcode_calc</code> function itself?</p>



<a name="422093886"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20jit-generated%20simple%20expression%2010x%20slow%20than%20hardcode/near/422093886" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20jit-generated.20simple.20expression.2010x.20slow.20than.20hardcode.html#422093886">(Feb 18 2024 at 12:24)</a>:</h4>
<p>Also it looks like you are calling an external function for every float add. The rust version would inline this too.</p>



<a name="422095893"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20jit-generated%20simple%20expression%2010x%20slow%20than%20hardcode/near/422095893" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jeremy Mei(梅杰) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20jit-generated.20simple.20expression.2010x.20slow.20than.20hardcode.html#422095893">(Feb 18 2024 at 12:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="264278">bjorn3</span> <a href="#narrow/stream/217117-cranelift/topic/jit-generated.20simple.20expression.2010x.20slow.20than.20hardcode/near/422093819">said</a>:</p>
<blockquote>
<p>Could you try replacing <code>hardcode_calc(...)</code> with <code>criterion::black_box(hardcode_calc as fn(f64, f64, f64, f64) -&gt; f64)(...)</code> to avoid inlining the <code>hardcode_calc</code> function itself?</p>
</blockquote>
<p>yes, all of those  add_wrapping, div_wrapping, lt function is inline function. but seem jit-generated function do not inline.</p>
<ol>
<li><strong>the new ben result after this changed</strong>:</li>
</ol>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="n">Running</span><span class="w"> </span><span class="n">benches</span><span class="o">/</span><span class="n">scalar_calc</span><span class="p">.</span><span class="n">rs</span><span class="w"> </span><span class="p">(</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">deps</span><span class="o">/</span><span class="n">scalar_calc</span><span class="o">-</span><span class="n">a5b82b9d208b7531</span><span class="p">)</span>
<span class="n">arrow_native_calc</span><span class="w">       </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">1.4803</span><span class="w"> </span><span class="n">ns</span><span class="w"> </span><span class="mf">1.4847</span><span class="w"> </span><span class="n">ns</span><span class="w"> </span><span class="mf">1.4919</span><span class="w"> </span><span class="n">ns</span><span class="p">]</span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">+</span><span class="mf">0.2458</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">0.9349</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">2.0967</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.03</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
<span class="w">                        </span><span class="n">Change</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="n">noise</span><span class="w"> </span><span class="n">threshold</span><span class="p">.</span>
<span class="n">Found</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="n">outliers</span><span class="w"> </span><span class="n">among</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">measurements</span><span class="w"> </span><span class="p">(</span><span class="mf">6.00</span><span class="o">%</span><span class="p">)</span>
<span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="mf">2.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">low</span><span class="w"> </span><span class="n">severe</span>
<span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="mf">1.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">mild</span>
<span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="mf">3.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">severe</span>

<span class="n">hardcode_calc</span><span class="w">           </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">2.0588</span><span class="w"> </span><span class="n">ns</span><span class="w"> </span><span class="mf">2.0776</span><span class="w"> </span><span class="n">ns</span><span class="w"> </span><span class="mf">2.1101</span><span class="w"> </span><span class="n">ns</span><span class="p">]</span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">+</span><span class="mf">38.601</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">39.948</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">41.544</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">regressed</span><span class="p">.</span>
<span class="n">Found</span><span class="w"> </span><span class="mi">17</span><span class="w"> </span><span class="n">outliers</span><span class="w"> </span><span class="n">among</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">measurements</span><span class="w"> </span><span class="p">(</span><span class="mf">17.00</span><span class="o">%</span><span class="p">)</span>
<span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="mf">1.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">low</span><span class="w"> </span><span class="n">severe</span>
<span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="mf">3.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">low</span><span class="w"> </span><span class="n">mild</span>
<span class="w">  </span><span class="mi">4</span><span class="w"> </span><span class="p">(</span><span class="mf">4.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">mild</span>
<span class="w">  </span><span class="mi">9</span><span class="w"> </span><span class="p">(</span><span class="mf">9.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">severe</span>

<span class="n">jit_calc</span><span class="w">                </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">5.4364</span><span class="w"> </span><span class="n">ns</span><span class="w"> </span><span class="mf">5.4583</span><span class="w"> </span><span class="n">ns</span><span class="w"> </span><span class="mf">5.4957</span><span class="w"> </span><span class="n">ns</span><span class="p">]</span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">-</span><span class="mf">99.014</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">99.003</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">98.994</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span>
<span class="n">Found</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">outliers</span><span class="w"> </span><span class="n">among</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">measurements</span><span class="w"> </span><span class="p">(</span><span class="mf">2.00</span><span class="o">%</span><span class="p">)</span>
<span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="mf">2.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">severe</span>
</code></pre></div>
<ol start="2">
<li><strong>disasm of <code>create_jit_op</code> function from test debug.</strong></li>
</ol>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="err">"</span><span class="w">  </span><span class="nf">pushq</span><span class="w">   </span><span class="nv">%rbp</span>
<span class="w">  </span><span class="nf">unwind</span><span class="w"> </span><span class="no">PushFrameRegs</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="no">offset_upward_to_caller_sp</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="nf">movq</span><span class="w">    </span><span class="nv">%rsp</span><span class="p">,</span><span class="w"> </span><span class="nv">%rbp</span>
<span class="w">  </span><span class="nf">unwind</span><span class="w"> </span><span class="no">DefineNewFrame</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="no">offset_upward_to_caller_sp</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="no">offset_downward_to_clobbers</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="nf">subq</span><span class="w">    </span><span class="nv">%rsp</span><span class="p">,</span><span class="w"> </span><span class="no">$16</span><span class="p">,</span><span class="w"> </span><span class="nv">%rsp</span>
<span class="w">  </span><span class="nf">movq</span><span class="w">    </span><span class="nv">%r13</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="nv">%rsp</span><span class="p">)</span>
<span class="w">  </span><span class="nf">unwind</span><span class="w"> </span><span class="no">SaveReg</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="no">clobber_offset</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="no">reg</span><span class="p">:</span><span class="w"> </span><span class="no">p13i</span><span class="w"> </span><span class="p">}</span>
<span class="nl">block0:</span>
<span class="w">  </span><span class="nf">movq</span><span class="w">    </span><span class="nv">%rdi</span><span class="p">,</span><span class="w"> </span><span class="nv">%r13</span>
<span class="w">  </span><span class="nf">load_ext_name</span><span class="w"> </span><span class="no">userextname0</span><span class="err">+</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">%rax</span>
<span class="w">  </span><span class="nf">call</span><span class="w">    </span><span class="p">*</span><span class="nv">%rax</span>
<span class="w">  </span><span class="nf">movabsq</span><span class="w"> </span><span class="no">$4613937818241073152</span><span class="p">,</span><span class="w"> </span><span class="nv">%rdi</span>
<span class="w">  </span><span class="nf">vmovq</span><span class="w">   </span><span class="nv">%rdi</span><span class="p">,</span><span class="w"> </span><span class="nv">%xmm1</span>
<span class="w">  </span><span class="nf">load_ext_name</span><span class="w"> </span><span class="no">userextname1</span><span class="err">+</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">%rax</span>
<span class="w">  </span><span class="nf">call</span><span class="w">    </span><span class="p">*</span><span class="nv">%rax</span>
<span class="w">  </span><span class="nf">load_ext_name</span><span class="w"> </span><span class="no">userextname2</span><span class="err">+</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">%rax</span>
<span class="w">  </span><span class="nf">movq</span><span class="w">    </span><span class="nv">%r13</span><span class="p">,</span><span class="w"> </span><span class="nv">%rdi</span>
<span class="w">  </span><span class="nf">call</span><span class="w">    </span><span class="p">*</span><span class="nv">%rax</span>
<span class="w">  </span><span class="nf">movq</span><span class="w">    </span><span class="mi">0</span><span class="p">(</span><span class="nv">%rsp</span><span class="p">),</span><span class="w"> </span><span class="nv">%r13</span>
<span class="w">  </span><span class="nf">addq</span><span class="w">    </span><span class="nv">%rsp</span><span class="p">,</span><span class="w"> </span><span class="no">$16</span><span class="p">,</span><span class="w"> </span><span class="nv">%rsp</span>
<span class="w">  </span><span class="nf">movq</span><span class="w">    </span><span class="nv">%rbp</span><span class="p">,</span><span class="w"> </span><span class="nv">%rsp</span>
<span class="w">  </span><span class="nf">popq</span><span class="w">    </span><span class="nv">%rbp</span>
<span class="w">  </span><span class="nf">ret</span>
<span class="err">"</span>
</code></pre></div>



<a name="422096096"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20jit-generated%20simple%20expression%2010x%20slow%20than%20hardcode/near/422096096" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20jit-generated.20simple.20expression.2010x.20slow.20than.20hardcode.html#422096096">(Feb 18 2024 at 13:00)</a>:</h4>
<blockquote>
<p>but seem jit-generated function do not inline.</p>
</blockquote>
<p>Correct. There is no way to inline between LLVM and Cranelift generated functions, just like there is no way to inline between LLVM and GCC generated functions.</p>



<a name="422096245"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20jit-generated%20simple%20expression%2010x%20slow%20than%20hardcode/near/422096245" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20jit-generated.20simple.20expression.2010x.20slow.20than.20hardcode.html#422096245">(Feb 18 2024 at 13:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="691571">Jeremy Mei(梅杰)</span> has marked this topic as resolved.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>