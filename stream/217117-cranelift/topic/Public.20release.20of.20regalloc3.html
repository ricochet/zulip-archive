<html>
<head><meta charset="utf-8"><title>Public release of regalloc3 · cranelift · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/index.html">cranelift</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html">Public release of regalloc3</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="454929061"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/454929061" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#454929061">(Jul 29 2024 at 19:32)</a>:</h4>
<p><a href="https://github.com/Amanieu/regalloc3">regalloc3</a> is a project that I've been working on for the past ~6 months which aims to write a new register allocator to succeed regalloc2. It is currently still a work in progress (notably, live range splitting is not implemented yet) but it is in a state where I would welcome reviews, comments and suggestions.</p>
<p>From the README, here's a list of API-level changes compared to regalloc2:</p>
<ul>
<li>Support for 2^28 (~268M) values ("vregs" in regalloc2) per function.</li>
<li>Support for up to 64 different register classes.</li>
<li>Support for up to 512 registers.</li>
<li>Support for compound registers and overlapping registers (e.g. <code>S0</code> / <code>S1</code> / <code>D0</code> on AArch32).</li>
<li>Support for multi-register groups (e.g. <code>CASP</code> register pairs on AArch64, <code>LD4</code> SIMD vector loads on AArch64).</li>
<li>Support for rematerialization of constants as an alternative to spilling.</li>
<li>Support for explicit block frequencies.</li>
<li>Register descriptions are described by a <code>RegInfo</code> trait.</li>
<li>Functions and register descriptions can be serialized to a text format and parsed back into memory.</li>
<li>Faster compilation of multiple functions by preserving and reusing memory allocations across runs.</li>
<li>Validation functions to check <code>Function</code> and <code>RegInfo</code> implementations.</li>
</ul>
<p>It also has several algorithmic level improvements, such as better handling of fixed register constraints and reused registers, a new faster algorithm for computing live ranges and a faster linear scan allocator for spill slot allocation.</p>
<p>I also have a <a href="https://github.com/Amanieu/regalloc2/tree/regalloc3">branch</a> of regalloc2 which adapts the input function and then passes it on to regalloc3.</p>
<p>I've used this to benchmark regalloc2 and regalloc3 using wasmtime. Some benchmark results when compiling <code>pulldown-cmark.wasm</code> from sightglass:</p>
<p><a href="/user_uploads/15107/NbGBHE2TcWP1jSC4tUR4o3xO/ra3.png">ra3.png</a><br>
<a href="/user_uploads/15107/aSr9qKIz385XlFCquM4A1exV/ra2.png">ra2.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/15107/NbGBHE2TcWP1jSC4tUR4o3xO/ra3.png" title="ra3.png"><img data-original-dimensions="1721x841" src="/user_uploads/thumbnail/15107/NbGBHE2TcWP1jSC4tUR4o3xO/ra3.png/840x560.webp"></a></div><div class="message_inline_image"><a href="/user_uploads/15107/aSr9qKIz385XlFCquM4A1exV/ra2.png" title="ra2.png"><img data-original-dimensions="1840x824" src="/user_uploads/thumbnail/15107/aSr9qKIz385XlFCquM4A1exV/ra2.png/840x560.webp"></a></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/Amanieu/regalloc3" style='background-image: url("https://uploads.zulipusercontent.net/8f3099e95f0fd7978d6e0e724beea90e0b6e7e14/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f303637653062383064356231313463663864623566383831663665323534386637653833636638333331326134663235396162366430346339643166663635362f416d616e6965752f726567616c6c6f6333")'></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/Amanieu/regalloc3" title="GitHub - Amanieu/regalloc3: New register allocator designed as a successor to regalloc2">GitHub - Amanieu/regalloc3: New register allocator designed as a successor to regalloc2</a></div><div class="message_embed_description">New register allocator designed as a successor to regalloc2 - Amanieu/regalloc3</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/Amanieu/regalloc2/tree/regalloc3" style='background-image: url("https://uploads.zulipusercontent.net/d115a60fe3f66457c233ca6f95b488ec278eaaa8/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613930313730626161373932643565326166376364343365323564336533636639333266306236643363643036666463633663333736333961643336623066352f416d616e6965752f726567616c6c6f6332")'></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/Amanieu/regalloc2/tree/regalloc3" title="GitHub - Amanieu/regalloc2 at regalloc3">GitHub - Amanieu/regalloc2 at regalloc3</a></div><div class="message_embed_description">A new register allocator. Contribute to Amanieu/regalloc2 development by creating an account on GitHub.</div></div></div>



<a name="454945274"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/454945274" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#454945274">(Jul 29 2024 at 20:48)</a>:</h4>
<p>congrats on releasing! looks very cool!</p>
<blockquote>
<p>I've used this to benchmark regalloc2 and regalloc3 using wasmtime. Some benchmark results when compiling <code>pulldown-cmark.wasm</code> from sightglass:</p>
</blockquote>
<p>do you have the sightglass results as well? the screenshots of the profiler don't tell us the actual speed up/slow down observed for compilation time and execution time vs regalloc2</p>



<a name="454946733"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/454946733" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#454946733">(Jul 29 2024 at 20:54)</a>:</h4>
<p>The total samples gives you an idea of how much time is spent in register allocation. The numbers are relatively stable across runs.</p>



<a name="454947108"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/454947108" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#454947108">(Jul 29 2024 at 20:55)</a>:</h4>
<p>Hyperfine results:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Summary</span>
<span class="w">  </span><span class="p">.</span><span class="o">/</span><span class="n">ra3</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">-</span><span class="n">C</span><span class="w"> </span><span class="n">parallel</span><span class="o">-</span><span class="n">compilation</span><span class="o">=</span><span class="n">n</span><span class="w">  </span><span class="o">../</span><span class="n">sightglass</span><span class="o">/</span><span class="n">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="n">ran</span>
<span class="w">    </span><span class="mf">1.03</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">0.03</span><span class="w"> </span><span class="n">times</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">base</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">-</span><span class="n">C</span><span class="w"> </span><span class="n">parallel</span><span class="o">-</span><span class="n">compilation</span><span class="o">=</span><span class="n">n</span><span class="w">  </span><span class="o">../</span><span class="n">sightglass</span><span class="o">/</span><span class="n">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>
</code></pre></div>



<a name="454947349"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/454947349" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#454947349">(Jul 29 2024 at 20:56)</a>:</h4>
<p>3% is nothing to sneeze at, nice!</p>



<a name="454947402"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/454947402" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#454947402">(Jul 29 2024 at 20:57)</a>:</h4>
<p>do you have measurements of runtime (quality of generated code) by any chance?</p>



<a name="454947925"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/454947925" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#454947925">(Jul 29 2024 at 20:58)</a>:</h4>
<p>The increase isn't much because regalloc is only 30% of the total runtime.</p>



<a name="454948034"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/454948034" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#454948034">(Jul 29 2024 at 20:59)</a>:</h4>
<p>The detailed profiles give a better idea of the relative performance of just the allocators.</p>



<a name="454948336"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/454948336" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#454948336">(Jul 29 2024 at 21:00)</a>:</h4>
<p>Sightglass is giving me strange results though, claiming that regalloc2 is ~20% faster.</p>



<a name="454948393"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/454948393" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#454948393">(Jul 29 2024 at 21:00)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">compilation</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">cycles</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">102683574.00</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">19686025.05</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="n">baseline</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.16</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.23</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">ra3</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">506461200</span><span class="w"> </span><span class="mf">524084844.50</span><span class="w"> </span><span class="mi">556646895</span><span class="p">]</span><span class="w"> </span><span class="n">baseline</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">609491400</span><span class="w"> </span><span class="mf">626768418.50</span><span class="w"> </span><span class="mi">666477735</span><span class="p">]</span><span class="w"> </span><span class="n">ra3</span><span class="p">.</span><span class="n">so</span>
</code></pre></div>



<a name="454948938"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/454948938" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#454948938">(Jul 29 2024 at 21:02)</a>:</h4>
<p>Execution time isn't great now, but I think that's mostly because I haven't implemented splitting yet:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">execution</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">cycles</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1957518.50</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">254885.40</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="n">baseline</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.21</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.28</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">ra3</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">7821135</span><span class="w"> </span><span class="mf">7976304.00</span><span class="w"> </span><span class="mi">8446655</span><span class="p">]</span><span class="w"> </span><span class="n">baseline</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">9711310</span><span class="w"> </span><span class="mf">9933822.50</span><span class="w"> </span><span class="mi">10376345</span><span class="p">]</span><span class="w"> </span><span class="n">ra3</span><span class="p">.</span><span class="n">so</span>
</code></pre></div>



<a name="454992892"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/454992892" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#454992892">(Jul 30 2024 at 01:54)</a>:</h4>
<p>can it handle stuff like where there's 128 integer registers and it needs to allocate register ranges starting at any register of size 12, 64, 37, and 3? or does it still rely on O(n^2) listing all possible allocations ahead of time (huge for arbitrary-sized ranges allocated out of 128 registers, 8128 possible afaict)?</p>



<a name="454992899"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/454992899" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#454992899">(Jul 30 2024 at 01:54)</a>:</h4>
<p>Your second to last point is interesting as that is something I just implemented for regalloc and saved quite a bit of time(5%) for larger binaries by minimizing heap allocations.</p>



<a name="455043655"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/455043655" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#455043655">(Jul 30 2024 at 06:55)</a>:</h4>
<p><span class="user-mention" data-user-id="315881">@Jacob Lifshay</span> Yes! Well, almost. At the moment I have a limit of 8 registers per reg group, but that can easily just be bumped up. You can see an example for RISC-V vectors <a href="https://github.com/Amanieu/regalloc3/blob/main/example_reginfo/riscv.reginfo">here</a>.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/Amanieu/regalloc3/blob/main/example_reginfo/riscv.reginfo" style="background-image: url(&quot;https://uploads.zulipusercontent.net/5fbf54098ec6a3716d49232a9892ce1ed3ec0f2c/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f313363613431303331333230323534653738326333643962313364383733626464326530306333363663636233343539623831646335386230613632313364632f416d616e6965752f726567616c6c6f6333&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/Amanieu/regalloc3/blob/main/example_reginfo/riscv.reginfo" title="regalloc3/example_reginfo/riscv.reginfo at main · Amanieu/regalloc3">regalloc3/example_reginfo/riscv.reginfo at main · Amanieu/regalloc3</a></div><div class="message_embed_description">New register allocator designed as a successor to regalloc2 - Amanieu/regalloc3</div></div></div>



<a name="455044915"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/455044915" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#455044915">(Jul 30 2024 at 07:00)</a>:</h4>
<p>You do need to list out all the allocatable combinations, but only once in the register definition which never changes.</p>



<a name="455050729"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/455050729" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#455050729">(Jul 30 2024 at 07:24)</a>:</h4>
<p>The way register groups work is approximately based on <a href="https://llvm.org/devmtg/2016-11/Slides/Braun-DealingWithRegisterHierarchies.pdf">https://llvm.org/devmtg/2016-11/Slides/Braun-DealingWithRegisterHierarchies.pdf</a></p>



<a name="455170901"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/455170901" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> African Hungarian <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#455170901">(Jul 30 2024 at 17:00)</a>:</h4>
<p>Wagwan, looks very neat looking forward to use this when it is ready to replace regalloc2 fully</p>



<a name="455294046"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/455294046" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#455294046">(Jul 31 2024 at 06:25)</a>:</h4>
<p>Does crane lift produce a pruned ssa? I don’t think so…</p>



<a name="455294067"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/455294067" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#455294067">(Jul 31 2024 at 06:25)</a>:</h4>
<p>So it isn’t trying to remove all truly useless phis</p>



<a name="455294945"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/455294945" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#455294945">(Jul 31 2024 at 06:31)</a>:</h4>
<p>(deleted)</p>



<a name="455294993"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/455294993" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#455294993">(Jul 31 2024 at 06:31)</a>:</h4>
<p>(deleted)</p>



<a name="455295852"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/455295852" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#455295852">(Jul 31 2024 at 06:39)</a>:</h4>
<p>Sorry wrong channel</p>



<a name="455357960"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/455357960" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#455357960">(Jul 31 2024 at 11:49)</a>:</h4>
<p>If you are quick enough you can move messages between topics inside a channel using the move messages option.</p>



<a name="455407030"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/455407030" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rm <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#455407030">(Jul 31 2024 at 15:34)</a>:</h4>
<p>This is very exciting. Once the code base has stabilized I would love to see a design overview like the one for regalloc2.</p>
<p>One thing I am especially interested in is the handling of spills for Arm (Aarch32/64). Spilling requires additional registers to load the spilled value into and materialize the stack offset. How does regalloc3 deal with this? Are these registers modelled by the allocator or are certain registers set aside for this purpose?</p>



<a name="455408662"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/455408662" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#455408662">(Jul 31 2024 at 15:39)</a>:</h4>
<p>Not currently, but I have some design notes on how to handle that. It does handle the scratch register for stack-to-stack moves though (like regalloc2 does)</p>



<a name="455412718"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/455412718" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#455412718">(Jul 31 2024 at 15:51)</a>:</h4>
<p>It's a bit tricky since, if you need to spill to free up a register, you need to ensure that the slot you spill to doesn't need a scratch register to calculate the spillslot address.</p>



<a name="459910344"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/459910344" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#459910344">(Aug 11 2024 at 16:30)</a>:</h4>
<p>New benchmarks, including a move optimizer post-processing pass that I haven't pushed yet:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">compilation</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">cycles</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">9800371.00</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">3117907.67</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="n">ra3</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.06</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.12</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">baseline</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">103712420</span><span class="w"> </span><span class="mf">116994400.95</span><span class="w"> </span><span class="mi">143270540</span><span class="p">]</span><span class="w"> </span><span class="n">baseline</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">93272620</span><span class="w"> </span><span class="mf">107194029.95</span><span class="w"> </span><span class="mi">133119665</span><span class="p">]</span><span class="w"> </span><span class="n">ra3</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">cycles</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">400260.70</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">121688.71</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="n">ra3</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.03</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.06</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">baseline</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">9414475</span><span class="w"> </span><span class="mf">9589995.80</span><span class="w"> </span><span class="mi">10502695</span><span class="p">]</span><span class="w"> </span><span class="n">baseline</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">8977885</span><span class="w"> </span><span class="mf">9189735.10</span><span class="w"> </span><span class="mi">13234935</span><span class="p">]</span><span class="w"> </span><span class="n">ra3</span><span class="p">.</span><span class="n">so</span>
</code></pre></div>



<a name="459910383"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/459910383" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#459910383">(Aug 11 2024 at 16:31)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">compilation</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">cycles</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">21871418.80</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">3220053.20</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="n">ra3</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.22</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.29</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">baseline</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">97671420</span><span class="w"> </span><span class="mf">108323316.50</span><span class="w"> </span><span class="mi">143930605</span><span class="p">]</span><span class="w"> </span><span class="n">baseline</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">75466125</span><span class="w"> </span><span class="mf">86451897.70</span><span class="w"> </span><span class="mi">113070615</span><span class="p">]</span><span class="w"> </span><span class="n">ra3</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">cycles</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2363113.90</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">590882.98</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="n">ra3</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.02</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.03</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">baseline</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">117038180</span><span class="w"> </span><span class="mf">118659545.20</span><span class="w"> </span><span class="mi">133033110</span><span class="p">]</span><span class="w"> </span><span class="n">baseline</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">115063375</span><span class="w"> </span><span class="mf">116296431.30</span><span class="w"> </span><span class="mi">122370570</span><span class="p">]</span><span class="w"> </span><span class="n">ra3</span><span class="p">.</span><span class="n">so</span>
</code></pre></div>



<a name="459910557"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/459910557" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#459910557">(Aug 11 2024 at 16:32)</a>:</h4>
<p>I disabled the shuffling allocator in wasmtime-bench-api (for both <code>ra3.so</code> and <code>baseline.so</code>) because it was distorting the results: the shuffling allocator is <em>extremely</em> slow.</p>



<a name="459910738"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/459910738" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#459910738">(Aug 11 2024 at 16:34)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">compilation</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">cycles</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">104370202.30</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">27034267.63</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="n">ra3</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.06</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.11</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">baseline</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">1248169230</span><span class="w"> </span><span class="mf">1331614134.20</span><span class="w"> </span><span class="mi">1492533140</span><span class="p">]</span><span class="w"> </span><span class="n">baseline</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">1172304280</span><span class="w"> </span><span class="mf">1227243931.90</span><span class="w"> </span><span class="mi">1351484785</span><span class="p">]</span><span class="w"> </span><span class="n">ra3</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">cycles</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">27698273.40</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">5688050.16</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="n">baseline</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.02</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.03</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">ra3</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">1152335590</span><span class="w"> </span><span class="mf">1165996450.50</span><span class="w"> </span><span class="mi">1191607235</span><span class="p">]</span><span class="w"> </span><span class="n">baseline</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">1181614875</span><span class="w"> </span><span class="mf">1193694723.90</span><span class="w"> </span><span class="mi">1232190190</span><span class="p">]</span><span class="w"> </span><span class="n">ra3</span><span class="p">.</span><span class="n">so</span>
</code></pre></div>



<a name="462226348"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462226348" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462226348">(Aug 13 2024 at 23:14)</a>:</h4>
<p><span class="user-mention" data-user-id="301625">@Amanieu</span> Have you implemented live range splitting?</p>



<a name="462226541"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462226541" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462226541">(Aug 13 2024 at 23:15)</a>:</h4>
<p>Additionally, those benchmarks, are they of the allocator itself running, or the emitted code?</p>



<a name="462227109"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462227109" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462227109">(Aug 13 2024 at 23:18)</a>:</h4>
<p>Live range splitting is not implemented yet, I'm currently studying the existing heuristics used in different allocators.</p>



<a name="462227124"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462227124" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462227124">(Aug 13 2024 at 23:18)</a>:</h4>
<p>The benchmarks show both <code>execution</code> and <code>compilation</code>.</p>



<a name="462228814"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462228814" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462228814">(Aug 13 2024 at 23:32)</a>:</h4>
<p>Oh wow, nice! Seems like there's still some performance to squeeze out AND you're already meeting the baseline!</p>



<a name="462231221"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462231221" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462231221">(Aug 13 2024 at 23:57)</a>:</h4>
<p>Also ~15% of the allocator time is spent converting from the regalloc2 format to the regalloc3 format.</p>



<a name="462241738"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462241738" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462241738">(Aug 14 2024 at 01:52)</a>:</h4>
<p>Hmmm even more enticing. I will watch your progress with great interest.</p>



<a name="462418572"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462418572" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462418572">(Aug 14 2024 at 21:16)</a>:</h4>
<p>Any idea why I might be failing the .expect("missing allocation"); in move_resolver.rs:760 when using the regalloc2 translation layer?</p>



<a name="462418747"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462418747" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462418747">(Aug 14 2024 at 21:18)</a>:</h4>
<p>Is this with cranelift?</p>



<a name="462418839"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462418839" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462418839">(Aug 14 2024 at 21:19)</a>:</h4>
<p>It is not.</p>



<a name="462418937"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462418937" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462418937">(Aug 14 2024 at 21:20)</a>:</h4>
<p>Hmm possibly you are passing invalid input to the register allocator.</p>



<a name="462419015"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462419015" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462419015">(Aug 14 2024 at 21:21)</a>:</h4>
<p>It does complete fine with normal regalloc2.</p>



<a name="462419054"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462419054" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462419054">(Aug 14 2024 at 21:21)</a>:</h4>
<p>Is this with a debug build? There is a <code>cfg!(debug_assertions)</code> that validates the input.</p>



<a name="462419100"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462419100" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462419100">(Aug 14 2024 at 21:22)</a>:</h4>
<p>It is release</p>



<a name="462419111"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462419111" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462419111">(Aug 14 2024 at 21:22)</a>:</h4>
<p>I'll try debug.</p>



<a name="462419658"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462419658" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462419658">(Aug 14 2024 at 21:27)</a>:</h4>
<p>Interesting, it is claiming there are predecessors to the entry block, however I also have an assertion of my own prior to register allocation that makes sure there are not. I will investigate further and let you know what I find.</p>



<a name="462419764"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462419764" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462419764">(Aug 14 2024 at 21:28)</a>:</h4>
<p>Ah I see...</p>



<a name="462419768"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462419768" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462419768">(Aug 14 2024 at 21:28)</a>:</h4>
<div class="message_inline_image"><a href="https://i.imgur.com/aO0wvAI.png"><img src="https://uploads.zulipusercontent.net/a18258c9f81e2bf37643fb68fb58f42aaab69f9a/68747470733a2f2f692e696d6775722e636f6d2f614f30777641492e706e67"></a></div>



<a name="462419821"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462419821" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462419821">(Aug 14 2024 at 21:28)</a>:</h4>
<p>It seems this may be incorrect here? I'll look more.</p>



<a name="462419853"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462419853" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462419853">(Aug 14 2024 at 21:29)</a>:</h4>
<p>My cfg is NOT in a RPO so the entry block is NOT block zero.</p>



<a name="462419872"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462419872" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462419872">(Aug 14 2024 at 21:29)</a>:</h4>
<p>Ah that might be it. regalloc3 assumes the entry block is block 0.</p>



<a name="462419903"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462419903" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462419903">(Aug 14 2024 at 21:29)</a>:</h4>
<p>Does the translation layer do anything current to rewrite this?</p>



<a name="462419961"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462419961" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462419961">(Aug 14 2024 at 21:30)</a>:</h4>
<p>No, it doesn't change the block ordering.</p>



<a name="462419983"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462419983" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462419983">(Aug 14 2024 at 21:30)</a>:</h4>
<p>I suppose it could...</p>



<a name="462420014"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462420014" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462420014">(Aug 14 2024 at 21:30)</a>:</h4>
<p>For now, I'll compute an RPO and feed that in, been meaning to do this for a while anyway.</p>



<a name="462420096"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462420096" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462420096">(Aug 14 2024 at 21:31)</a>:</h4>
<p>regalloc3 requires that if block A dominates block B, A must come before B in the block order. Since the entry block dominates everything, it must be the first block.</p>



<a name="462420188"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462420188" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462420188">(Aug 14 2024 at 21:32)</a>:</h4>
<p><span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span></p>



<a name="462420276"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462420276" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462420276">(Aug 14 2024 at 21:33)</a>:</h4>
<p>Additionally, I'm a bit curious about the omission of <code>branch_blockparams</code> in the <code>Function</code> trait.</p>
<p>I see the jump params method but why none for conditional branches? Are separate destinations not allowed to have separate parameter lists?</p>



<a name="462420391"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462420391" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462420391">(Aug 14 2024 at 21:34)</a>:</h4>
<p>Block parameters are only allowed on blocks with multiple predecessors.</p>



<a name="462420445"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462420445" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462420445">(Aug 14 2024 at 21:34)</a>:</h4>
<p>This makes sense if you think about it: if there is only a single predecessor then you can just use the value from the predecessor directly instead of creating a separate value that is just a copy.</p>



<a name="462420670"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462420670" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462420670">(Aug 14 2024 at 21:36)</a>:</h4>
<p>I agree with that, having trouble wrapping my mind around the implementation. </p>
<p>If I originally had this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span><span class="w"> </span><span class="nf">branch_blockparams</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">:</span><span class="w"> </span><span class="nc">Block</span><span class="p">,</span><span class="w"> </span><span class="n">_insn</span><span class="p">:</span><span class="w"> </span><span class="nc">Inst</span><span class="p">,</span><span class="w"> </span><span class="n">succ_idx</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kp">&amp;</span><span class="p">[</span><span class="n">VReg</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">block</span><span class="p">.</span><span class="n">index</span><span class="p">()].</span><span class="n">successor_params</span><span class="p">[</span><span class="n">succ_idx</span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p>implementation for regalloc2, where is the equivalent or similar requirement in regalloc3?</p>



<a name="462420693"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462420693" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462420693">(Aug 14 2024 at 21:37)</a>:</h4>
<p>It's called <code>jump_blockparams</code></p>



<a name="462420763"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462420763" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462420763">(Aug 14 2024 at 21:37)</a>:</h4>
<p>I make a distinction between <code>jump</code> terminators (which can have blockparams but no operands) and <code>branch</code> terminators (which can have operands but no blockparams).</p>



<a name="462420826"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462420826" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462420826">(Aug 14 2024 at 21:38)</a>:</h4>
<p>I see that, but there it is not specified which successor is the target, as is done above with <code>succ_index</code>.</p>



<a name="462421183"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462421183" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462421183">(Aug 14 2024 at 21:41)</a>:</h4>
<p>Because there can only be 1 successor if the successor has multiple predecessors.</p>



<a name="462421232"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462421232" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462421232">(Aug 14 2024 at 21:42)</a>:</h4>
<p>Due to the critical edge rule.</p>



<a name="462422130"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462422130" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462422130">(Aug 14 2024 at 21:51)</a>:</h4>
<p>Ah... yes that is true!</p>



<a name="462429795"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462429795" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462429795">(Aug 14 2024 at 23:05)</a>:</h4>
<p>Is there a reason terminating instructions cannot have clobbers? I have a call to a non returning function(fastfails on windows) which is the "terminating instruction" and ra3 isn't happy about that. I can just put a UD2 or INT3 after it to quiet it down but still what is the rationale behind that requirement?</p>



<a name="462430001"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462430001" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462430001">(Aug 14 2024 at 23:07)</a>:</h4>
<p>Specifically this: <code>Terminator with no successors cannot have clobbers</code></p>



<a name="462430012"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462430012" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462430012">(Aug 14 2024 at 23:07)</a>:</h4>
<p>Also I love your error printing, very nice!</p>



<a name="462430212"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462430212" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462430212">(Aug 14 2024 at 23:09)</a>:</h4>
<p>Because clobbers have no effect in that context: there's nothing after the instruction.</p>



<a name="462430301"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462430301" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462430301">(Aug 14 2024 at 23:09)</a>:</h4>
<p>But it doesn't strictly cause a problem does it?</p>



<a name="462430414"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462430414" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462430414">(Aug 14 2024 at 23:10)</a>:</h4>
<p>Well I did want to take advantage of this for some optimizations, but never got around to it.</p>



<a name="462430488"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462430488" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462430488">(Aug 14 2024 at 23:10)</a>:</h4>
<p>It's still on my TODO list.</p>



<a name="462430494"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462430494" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462430494">(Aug 14 2024 at 23:10)</a>:</h4>
<p>Putting a UD2/nop or something will solve it for me so not really a big problem anyway to impose that requirement.</p>



<a name="462430514"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462430514" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462430514">(Aug 14 2024 at 23:11)</a>:</h4>
<p>No, the solution is to remove the clobbers since they have no effect.</p>



<a name="462430573"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462430573" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462430573">(Aug 14 2024 at 23:11)</a>:</h4>
<p>But that would require making the call aware that it is "special" and doesn't return.</p>



<a name="462430648"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462430648" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462430648">(Aug 14 2024 at 23:12)</a>:</h4>
<p>You could always add a check in <code>inst_clobbers</code> to see if this is the last instruction in the block or something.</p>



<a name="462430670"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462430670" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462430670">(Aug 14 2024 at 23:12)</a>:</h4>
<p>I suppose I could also relax the check, but I'm not super comfortable about it.</p>



<a name="462690374"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462690374" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462690374">(Aug 16 2024 at 03:45)</a>:</h4>
<p>Somewhat interesting, there seem to be some unnecessary moves taking place back into spill slots and registers even though they are not used after the move. Here is an example:<br>
<a href="https://i.imgur.com/ecAa5Cp.png">https://i.imgur.com/ecAa5Cp.png</a><br>
The superfluous move of the value in RAX into a stack slot(at 2C0h) which is never again touched(this block is the last in the function) is seen above^</p>
<div class="message_inline_image"><a href="https://i.imgur.com/ecAa5Cp.png"><img src="https://uploads.zulipusercontent.net/c4a66518d4ac6879da8dae6ad32b2a9740fe2427/68747470733a2f2f692e696d6775722e636f6d2f656341613543702e706e67"></a></div>



<a name="462731203"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462731203" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462731203">(Aug 16 2024 at 07:29)</a>:</h4>
<p>That's from the lack of splitting. We are immediately spilling right after the definition of a value.</p>



<a name="462731430"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462731430" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462731430">(Aug 16 2024 at 07:31)</a>:</h4>
<p>However move optimization is able to optimize the reload away but not the spill.</p>



<a name="462818298"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462818298" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462818298">(Aug 16 2024 at 16:14)</a>:</h4>
<p>I should also point out the output there, and I cannot figure it out why exactly(because that single function basic block is quite large) is not semantically equivalent to the regalloc2 output and causes the binary to exit because a conditional branch is taken in a later function that shouldn't be.</p>
<p>Again though, this is an extreme example, I was compiling chrome.dll on Windows, and this is a very very large function. I'm not going to do much more with it now as I have other things that need tending to, but I can send you the output for regalloc2 and regalloc3 in DMs if you wish to see it yourself, as well as my machine instruction representation that is fed into regalloc.</p>



<a name="462827611"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462827611" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462827611">(Aug 16 2024 at 17:11)</a>:</h4>
<p>With <code>debug_assertions</code> enabled it also validates that the result of register allocation is correct.</p>



<a name="462827633"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462827633" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462827633">(Aug 16 2024 at 17:11)</a>:</h4>
<p>You can try a release build with debug assertions enabled if debug builds are too slow.</p>



<a name="462828068"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/462828068" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#462828068">(Aug 16 2024 at 17:15)</a>:</h4>
<p>Alternatively if you've already narrowed it down to a single function, you can edit the regalloc2 adapter to dump the text representation of the input function in  a way that can be later used with regalloc3-tool:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">            </span><span class="n">log</span><span class="p">::</span><span class="n">info</span><span class="o">!</span><span class="p">(</span>
<span class="w">                </span><span class="s">"Reginfo:</span><span class="se">\n</span><span class="s">{}"</span><span class="p">,</span>
<span class="w">                </span><span class="n">regalloc3</span><span class="p">::</span><span class="n">debug_utils</span><span class="p">::</span><span class="n">DisplayRegInfo</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">reginfo</span><span class="p">)</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">            </span><span class="n">log</span><span class="p">::</span><span class="n">info</span><span class="o">!</span><span class="p">(</span>
<span class="w">                </span><span class="s">"Input function:</span><span class="se">\n</span><span class="s">{}"</span><span class="p">,</span>
<span class="w">                </span><span class="n">regalloc3</span><span class="p">::</span><span class="n">debug_utils</span><span class="p">::</span><span class="n">DisplayFunction</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">adapter</span><span class="p">)</span>
<span class="w">            </span><span class="p">);</span>
</code></pre></div>



<a name="466573949"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/466573949" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ghostway <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#466573949">(Aug 31 2024 at 16:10)</a>:</h4>
<p>This is one cool of a project! Is there a todo.txt anywhere? Would love to help</p>



<a name="466770017"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/466770017" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#466770017">(Sep 01 2024 at 22:33)</a>:</h4>
<p><span class="user-mention" data-user-id="598026">@ghostway</span> I do have an internal todo.txt locally, but it's not really suitable for public consumption. I'm taking a break at the moment to work on other things, but I will get back to regalloc3 soon.</p>



<a name="467985501"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/467985501" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Panagiotis Karouzakis <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#467985501">(Sep 05 2024 at 21:14)</a>:</h4>
<p>Hello! While we are not working on RegAlloc me and <span class="user-mention" data-user-id="709820">@Dimitris Aspetakis</span> are working on Instruction Scheduling inside Cranelift.</p>
<p>We have implemented some heuristics without so much benefit, only on some benchmarks of the XNNPACK. Currently we are implementing another heuristic but we get different results in different machines.</p>
<p>We are thinking that this is probably cause of the Reg Allocation.<br>
Can we somehow count the number of spills?</p>



<a name="467986562"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/467986562" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#467986562">(Sep 05 2024 at 21:22)</a>:</h4>
<p><span class="user-mention" data-user-id="709823">@Panagiotis Karouzakis</span> a very simple (slightly hacky) way to do this is to do a <code>wasmtime compile</code>, then <code>objdump</code> the resulting <code>.cwasm</code> file, and grep with a regular expression that matches loads/stores relative to the stack pointer</p>



<a name="467986680"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/467986680" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#467986680">(Sep 05 2024 at 21:23)</a>:</h4>
<p>something like <code>mov.*(%rsp).*</code> on x86-64, or <code>ldr.*sp.*</code> + <code>str.*sp.*</code> on aarch64</p>



<a name="467986726"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Public%20release%20of%20regalloc3/near/467986726" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Public.20release.20of.20regalloc3.html#467986726">(Sep 05 2024 at 21:23)</a>:</h4>
<p>then count lines in the disassembly that match</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>