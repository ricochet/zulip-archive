<html>
<head><meta charset="utf-8"><title>✔ Recover from errors/panics · cranelift · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/index.html">cranelift</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Recover.20from.20errors.2Fpanics.html">✔ Recover from errors/panics</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="445273586"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Recover%20from%20errors/panics/near/445273586" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> West <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Recover.20from.20errors.2Fpanics.html#445273586">(Jun 18 2024 at 05:17)</a>:</h4>
<p>I'm currently using cranelift to create a programming environment for my language. The problem is that cranelift will panic a lot and I need to recover from errors and continue running the application. How can I handle panics? Is the only solution to implement proper error handling in cranelift itself?</p>



<a name="445293317"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Recover%20from%20errors/panics/near/445293317" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Recover.20from.20errors.2Fpanics.html#445293317">(Jun 18 2024 at 07:50)</a>:</h4>
<p>You can use catch_unwind, but cranelift shouldn't panic unless you passed in ir which doesn't pass the verifier.</p>



<a name="445293715"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Recover%20from%20errors/panics/near/445293715" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> West <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Recover.20from.20errors.2Fpanics.html#445293715">(Jun 18 2024 at 07:51)</a>:</h4>
<p>Right, I said language, but that's an oversimplification so I could get the problem out.<br>
Really I want to create an interface to edit cranelift IR directly, then test and disassemble the output. The interface is what needs to live on when cranelift crashes.<br>
Imma try <code>catch_unwind</code>. Thank you!</p>



<a name="445306939"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Recover%20from%20errors/panics/near/445306939" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Recover.20from.20errors.2Fpanics.html#445306939">(Jun 18 2024 at 09:01)</a>:</h4>
<p>Can you run the verifier before trying to compile it and skip compiling if the verifier reports an error?</p>



<a name="445311966"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Recover%20from%20errors/panics/near/445311966" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> West <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Recover.20from.20errors.2Fpanics.html#445311966">(Jun 18 2024 at 09:27)</a>:</h4>
<p>I didn't even know about any sort of verifier. Lemme check it out.</p>



<a name="445313734"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Recover%20from%20errors/panics/near/445313734" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> West <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Recover.20from.20errors.2Fpanics.html#445313734">(Jun 18 2024 at 09:36)</a>:</h4>
<p>Here is some working code I have right now so you can skim through. Basically I'm adding abstractions so that I can give the user a nicer interface for writing IR. Perhaps "compiler" was the wrong word to express this intent.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">anyhow</span><span class="p">::{</span><span class="n">anyhow</span><span class="p">,</span><span class="w"> </span><span class="nb">Result</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">ir</span><span class="p">::{</span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="n">AbiParam</span><span class="p">,</span><span class="w"> </span><span class="n">Function</span><span class="p">,</span><span class="w"> </span><span class="n">InstBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">Signature</span><span class="p">,</span><span class="w"> </span><span class="n">UserFuncName</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">OwnedTargetIsa</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">settings</span><span class="p">::{</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">Configurable</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">Context</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_frontend</span><span class="p">::{</span><span class="n">FunctionBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">FunctionBuilderContext</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_module</span><span class="p">::{</span><span class="n">default_libcall_names</span><span class="p">,</span><span class="w"> </span><span class="n">Linkage</span><span class="p">,</span><span class="w"> </span><span class="n">Module</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_object</span><span class="p">::{</span><span class="n">ObjectBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">ObjectModule</span><span class="p">,</span><span class="w"> </span><span class="n">ObjectProduct</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">io</span><span class="p">::</span><span class="n">Write</span><span class="p">;</span>

<span class="k">type</span><span class="w"> </span><span class="nc">Ns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">u32</span><span class="p">;</span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Compiler</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">namespace</span><span class="p">:</span><span class="w"> </span><span class="nc">Ns</span><span class="p">,</span>
<span class="w">    </span><span class="n">context</span><span class="p">:</span><span class="w"> </span><span class="nc">Context</span><span class="p">,</span>
<span class="w">    </span><span class="n">module</span><span class="p">:</span><span class="w"> </span><span class="nc">ObjectModule</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="nb">Default</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Compiler</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">default</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Compiler</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">new</span><span class="p">(</span><span class="n">namespace</span><span class="p">:</span><span class="w"> </span><span class="nc">Ns</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ObjectModule</span><span class="p">::</span><span class="n">new</span><span class="p">(</span>
<span class="w">            </span><span class="n">ObjectBuilder</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">get_isa</span><span class="p">(),</span><span class="w"> </span><span class="s">"default"</span><span class="p">,</span><span class="w"> </span><span class="n">default_libcall_names</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">(),</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">namespace</span><span class="p">,</span>
<span class="w">            </span><span class="n">context</span><span class="p">:</span><span class="w"> </span><span class="nc">module</span><span class="p">.</span><span class="n">make_context</span><span class="p">(),</span>
<span class="w">            </span><span class="n">module</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">add_fn</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">params</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="p">[</span><span class="n">AbiParam</span><span class="p">],</span>
<span class="w">        </span><span class="n">returns</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="p">[</span><span class="n">AbiParam</span><span class="p">],</span>
<span class="w">        </span><span class="n">function_builder</span><span class="p">:</span><span class="w"> </span><span class="nc">impl</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">FunctionBuilderContext</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">(),</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">fn_context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionBuilderContext</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">create_fn_signature</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">returns</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">declare_function</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">Linkage</span><span class="p">::</span><span class="n">Local</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sig</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">signature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sig</span><span class="p">;</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UserFuncName</span><span class="p">::</span><span class="n">user</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">namespace</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">.</span><span class="n">as_u32</span><span class="p">());</span>
<span class="w">        </span><span class="n">function_builder</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">fn_context</span><span class="p">);</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">define_function</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">context</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">clear_context</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">context</span><span class="p">);</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">clone</span><span class="p">())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">create_fn_signature</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="p">[</span><span class="n">AbiParam</span><span class="p">],</span><span class="w"> </span><span class="n">returns</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="p">[</span><span class="n">AbiParam</span><span class="p">])</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Signature</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">make_signature</span><span class="p">();</span>
<span class="w">        </span><span class="n">params</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">for_each</span><span class="p">(</span><span class="o">|</span><span class="n">param</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="o">*</span><span class="n">param</span><span class="p">);</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">        </span><span class="n">returns</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">for_each</span><span class="p">(</span><span class="o">|</span><span class="n">return_</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">sig</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="o">*</span><span class="n">return_</span><span class="p">);</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">        </span><span class="n">sig</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">disasm</span><span class="p">(</span><span class="n">bytes</span><span class="p">:</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">mktemp</span><span class="p">::</span><span class="n">Temp</span><span class="p">;</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">process</span><span class="p">::</span><span class="n">Command</span><span class="p">;</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">process</span><span class="p">::</span><span class="n">Stdio</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tempfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Temp</span><span class="p">::</span><span class="n">new_file</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">opened_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">fs</span><span class="p">::</span><span class="n">File</span><span class="p">::</span><span class="n">options</span><span class="p">().</span><span class="n">write</span><span class="p">(</span><span class="kc">true</span><span class="p">).</span><span class="n">open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tempfile</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">opened_file</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bytes</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Command</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="s">"objdump"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">arg</span><span class="p">(</span><span class="s">"-S"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">arg</span><span class="p">(</span><span class="s">"-s"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">arg</span><span class="p">(</span><span class="n">tempfile</span><span class="p">.</span><span class="n">to_path_buf</span><span class="p">().</span><span class="n">to_string_lossy</span><span class="p">().</span><span class="n">as_ref</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">stdin</span><span class="p">(</span><span class="n">Stdio</span><span class="p">::</span><span class="n">piped</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">stdout</span><span class="p">(</span><span class="n">Stdio</span><span class="p">::</span><span class="n">piped</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">spawn</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">stdin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">child</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="n">take</span><span class="p">().</span><span class="n">ok_or</span><span class="p">(</span><span class="n">anyhow</span><span class="o">!</span><span class="p">(</span><span class="s">"Failed to get stdin"</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="p">::</span><span class="n">thread</span><span class="p">::</span><span class="n">spawn</span><span class="p">(</span><span class="k">move</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// FIXME Propagate any errors</span>
<span class="w">        </span><span class="n">stdin</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bytes</span><span class="p">).</span><span class="n">expect</span><span class="p">(</span><span class="s">"Failed to write to stdin"</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">child</span><span class="p">.</span><span class="n">wait_with_output</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">disassembly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span><span class="p">::</span><span class="n">from_utf8</span><span class="p">(</span><span class="n">output</span><span class="p">.</span><span class="n">stdout</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">disassembly</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">get_isa</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">OwnedTargetIsa</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">flag_builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span><span class="p">::</span><span class="n">builder</span><span class="p">();</span>
<span class="w">    </span><span class="n">flag_builder</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="s">"use_colocated_libcalls"</span><span class="p">,</span><span class="w"> </span><span class="s">"false"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// FIXME set `is_pic` back to `true` once the x64 backend supports it.</span>
<span class="w">    </span><span class="n">flag_builder</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="s">"is_pic"</span><span class="p">,</span><span class="w"> </span><span class="s">"false"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">isa_builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cranelift_native</span><span class="p">::</span><span class="n">builder</span><span class="p">().</span><span class="n">unwrap_or_else</span><span class="p">(</span><span class="o">|</span><span class="n">msg</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">panic!</span><span class="p">(</span><span class="s">"host machine is not supported: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">isa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isa_builder</span>
<span class="w">        </span><span class="p">.</span><span class="n">finish</span><span class="p">(</span><span class="n">settings</span><span class="p">::</span><span class="n">Flags</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">flag_builder</span><span class="p">))</span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="n">isa</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Output</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">functions</span><span class="p">:</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">disasm</span><span class="p">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[no_mangle]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">compile_functions</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">compiler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Compiler</span><span class="p">::</span><span class="n">default</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fn_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compiler</span><span class="p">.</span><span class="n">add_fn</span><span class="p">(</span>
<span class="w">        </span><span class="s">"move_input_to_output"</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="p">[</span><span class="n">AbiParam</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">types</span><span class="p">::</span><span class="n">F64</span><span class="p">)],</span>
<span class="w">        </span><span class="o">&amp;</span><span class="p">[</span><span class="n">AbiParam</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">types</span><span class="p">::</span><span class="n">F64</span><span class="p">)],</span>
<span class="w">        </span><span class="o">|</span><span class="n">context</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">fn_context</span><span class="p">:</span><span class="w"> </span><span class="nc">FunctionBuilderContext</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionBuilder</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">fn_context</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">create_block</span><span class="p">();</span>
<span class="w">            </span><span class="n">builder</span><span class="p">.</span><span class="n">append_block_params_for_function_params</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
<span class="w">            </span><span class="n">builder</span><span class="p">.</span><span class="n">switch_to_block</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
<span class="w">            </span><span class="n">builder</span><span class="p">.</span><span class="n">seal_block</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[];</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">param</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">block_params</span><span class="p">(</span><span class="n">block</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">return_</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
<span class="w">            </span><span class="n">builder</span><span class="p">.</span><span class="n">finalize</span><span class="p">();</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fn_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compiler</span><span class="p">.</span><span class="n">add_fn</span><span class="p">(</span>
<span class="w">        </span><span class="s">"sqaure"</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="p">[</span><span class="n">AbiParam</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">types</span><span class="p">::</span><span class="n">I64</span><span class="p">)],</span>
<span class="w">        </span><span class="o">&amp;</span><span class="p">[</span><span class="n">AbiParam</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">types</span><span class="p">::</span><span class="n">I64</span><span class="p">)],</span>
<span class="w">        </span><span class="o">|</span><span class="n">context</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">fn_context</span><span class="p">:</span><span class="w"> </span><span class="nc">FunctionBuilderContext</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionBuilder</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">fn_context</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">create_block</span><span class="p">();</span>
<span class="w">            </span><span class="n">builder</span><span class="p">.</span><span class="n">append_block_params_for_function_params</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
<span class="w">            </span><span class="n">builder</span><span class="p">.</span><span class="n">switch_to_block</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>

<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">param0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">block_params</span><span class="p">(</span><span class="n">block</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">imul</span><span class="p">(</span><span class="n">param0</span><span class="p">,</span><span class="w"> </span><span class="n">param0</span><span class="p">);</span>

<span class="w">            </span><span class="n">builder</span><span class="p">.</span><span class="n">seal_block</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
<span class="w">            </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">return_</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="n">val</span><span class="p">]);</span>
<span class="w">            </span><span class="n">builder</span><span class="p">.</span><span class="n">finalize</span><span class="p">();</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">objectmodule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compiler</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">finish</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objectmodule</span><span class="p">.</span><span class="n">emit</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">disasm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">disasm</span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Output</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">functions</span><span class="p">:</span><span class="w"> </span><span class="nc">vec</span><span class="o">!</span><span class="p">[</span><span class="n">fn_1</span><span class="p">,</span><span class="w"> </span><span class="n">fn_2</span><span class="p">],</span>
<span class="w">        </span><span class="n">disasm</span><span class="p">,</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">}</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span>
<span class="w">        </span><span class="s">"{}"</span><span class="p">,</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">compile_functions</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">o</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">disasm</span><span class="p">,</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>



<a name="445313893"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Recover%20from%20errors/panics/near/445313893" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> West <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Recover.20from.20errors.2Fpanics.html#445313893">(Jun 18 2024 at 09:37)</a>:</h4>
<p>As far as I understand the verifier is always enabled, so that wouldn't help with panics if build a function incorrectly.</p>



<a name="445334879"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Recover%20from%20errors/panics/near/445334879" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Recover.20from.20errors.2Fpanics.html#445334879">(Jun 18 2024 at 11:30)</a>:</h4>
<p>The verifier has to be explicitly enabled.</p>



<a name="445335166"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Recover%20from%20errors/panics/near/445335166" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Recover.20from.20errors.2Fpanics.html#445335166">(Jun 18 2024 at 11:31)</a>:</h4>
<p>You can either call <code>cranelift_codegen::verifier::verify_function</code> manually or set <code>enable_verifier</code> on the flag_builder.</p>



<a name="445335313"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Recover%20from%20errors/panics/near/445335313" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Recover.20from.20errors.2Fpanics.html#445335313">(Jun 18 2024 at 11:32)</a>:</h4>
<p>The latter will also run the verifier in between optimization passes, which wouldn't be strictly necessary here.</p>



<a name="445350445"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Recover%20from%20errors/panics/near/445350445" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> West <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Recover.20from.20errors.2Fpanics.html#445350445">(Jun 18 2024 at 12:56)</a>:</h4>
<p>Ok, I enabled the verifier by flag.<br>
If I comment one of the calls to <code>switch_to_block</code>, then I still get a crash.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'&lt;</span><span class="n">unnamed</span><span class="o">&gt;'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba150</span>
<span class="mi">01</span><span class="n">f</span><span class="o">/</span><span class="n">cranelift</span><span class="o">-</span><span class="n">entity</span><span class="o">-</span><span class="mf">0.108.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">packed_option</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">64</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span>
<span class="nc">Please</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">switch_to_block</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="n">inserting</span><span class="w"> </span><span class="n">instructions</span>
<span class="n">note</span><span class="p">:</span><span class="w"> </span><span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span>
<span class="n">fatal</span><span class="w"> </span><span class="n">runtime</span><span class="w"> </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nc">Rust</span><span class="w"> </span><span class="n">cannot</span><span class="w"> </span><span class="n">catch</span><span class="w"> </span><span class="n">foreign</span><span class="w"> </span><span class="n">exceptions</span>
</code></pre></div>
<p>It is possible that my abstraction can be such that I don't have to worry about these sorts of panics, but I don't know.<br>
Would be nice if the type system enforced how and when these functions must be called.</p>



<a name="445352922"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Recover%20from%20errors/panics/near/445352922" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> West <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Recover.20from.20errors.2Fpanics.html#445352922">(Jun 18 2024 at 13:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="264278">bjorn3</span> <a href="#narrow/stream/217117-cranelift/topic/Recover.20from.20errors.2Fpanics/near/445334879">said</a>:</p>
<blockquote>
<p>The verifier has to be explicitly enabled.</p>
</blockquote>
<p>Not what the docs say by the way. <a href="https://docs.rs/cranelift/latest/cranelift/prelude/settings/struct.Flags.html#method.enable_verifier">https://docs.rs/cranelift/latest/cranelift/prelude/settings/struct.Flags.html#method.enable_verifier</a></p>



<a name="445397838"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Recover%20from%20errors/panics/near/445397838" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Recover.20from.20errors.2Fpanics.html#445397838">(Jun 18 2024 at 15:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="729491">West</span> <a href="#narrow/stream/217117-cranelift/topic/Recover.20from.20errors.2Fpanics/near/445352922">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="264278">bjorn3</span> <a href="#narrow/stream/217117-cranelift/topic/Recover.20from.20errors.2Fpanics/near/445334879">said</a>:</p>
<blockquote>
<p>The verifier has to be explicitly enabled.</p>
</blockquote>
<p>Not what the docs say by the way. <a href="https://docs.rs/cranelift/latest/cranelift/prelude/settings/struct.Flags.html#method.enable_verifier">https://docs.rs/cranelift/latest/cranelift/prelude/settings/struct.Flags.html#method.enable_verifier</a></p>
</blockquote>
<p>You're right: <a href="https://github.com/bytecodealliance/wasmtime/blob/3171ef6df3165c40bd2a2b60d2e9de248581689e/cranelift/codegen/meta/src/shared/settings.rs#L63">https://github.com/bytecodealliance/wasmtime/blob/3171ef6df3165c40bd2a2b60d2e9de248581689e/cranelift/codegen/meta/src/shared/settings.rs#L63</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/3171ef6df3165c40bd2a2b60d2e9de248581689e/cranelift/codegen/meta/src/shared/settings.rs#L63" style="background-image: url(&quot;https://uploads.zulipusercontent.net/4db54521ed35ee53826147c706fae932ea1e04db/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f636463626361303837643932343165336136333537623233646137613764343835626465633565633962363134633530306630633465643836363462633436372f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/3171ef6df3165c40bd2a2b60d2e9de248581689e/cranelift/codegen/meta/src/shared/settings.rs#L63" title="wasmtime/cranelift/codegen/meta/src/shared/settings.rs at 3171ef6df3165c40bd2a2b60d2e9de248581689e · bytecodealliance/wasmtime">wasmtime/cranelift/codegen/meta/src/shared/settings.rs at 3171ef6df3165c40bd2a2b60d2e9de248581689e · bytecodealliance/wasmtime</a></div><div class="message_embed_description">A fast and secure runtime for WebAssembly. Contribute to bytecodealliance/wasmtime development by creating an account on GitHub.</div></div></div>



<a name="445398911"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Recover%20from%20errors/panics/near/445398911" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Recover.20from.20errors.2Fpanics.html#445398911">(Jun 18 2024 at 15:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="729491">West</span> <a href="#narrow/stream/217117-cranelift/topic/Recover.20from.20errors.2Fpanics/near/445350445">said</a>:</p>
<blockquote>
<p>Ok, I enabled the verifier by flag.<br>
If I comment one of the calls to <code>switch_to_block</code>, then I still get a crash.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'&lt;</span><span class="n">unnamed</span><span class="o">&gt;'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba150</span>
<span class="mi">01</span><span class="n">f</span><span class="o">/</span><span class="n">cranelift</span><span class="o">-</span><span class="n">entity</span><span class="o">-</span><span class="mf">0.108.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">packed_option</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">64</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span>
<span class="nc">Please</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">switch_to_block</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="n">inserting</span><span class="w"> </span><span class="n">instructions</span>
<span class="n">note</span><span class="p">:</span><span class="w"> </span><span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span>
<span class="n">fatal</span><span class="w"> </span><span class="n">runtime</span><span class="w"> </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nc">Rust</span><span class="w"> </span><span class="n">cannot</span><span class="w"> </span><span class="n">catch</span><span class="w"> </span><span class="n">foreign</span><span class="w"> </span><span class="n">exceptions</span>
</code></pre></div>
<p>It is possible that my abstraction can be such that I don't have to worry about these sorts of panics, but I don't know.<br>
Would be nice if the type system enforced how and when these functions must be called.</p>
</blockquote>
<p>Oh, I thought you were having an issue with Cranelift panicking when compiling. This is a panic while building the clif ir in the first place. The builder api is kind of expected to panic when you misuse it. The only alternative would be to return a <code>Result</code> from pretty much every method, which would both be non-ergonomic and make it much easier to accidentally ignore errors.</p>



<a name="445563592"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Recover%20from%20errors/panics/near/445563592" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> West <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Recover.20from.20errors.2Fpanics.html#445563592">(Jun 19 2024 at 11:07)</a>:</h4>
<p>Ok, so basically I need to make a wrapper that avoids panicking cranelift.<br>
Alright, then. I'll give it a shot.</p>



<a name="445563612"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Recover%20from%20errors/panics/near/445563612" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Recover.20from.20errors.2Fpanics.html#445563612">(Jun 19 2024 at 11:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="729491">West</span> has marked this topic as resolved.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>