<html>
<head><meta charset="utf-8"><title>cg_clif can bootstrap rustc · cranelift · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/index.html">cranelift</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/cg_clif.20can.20bootstrap.20rustc.html">cg_clif can bootstrap rustc</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="202726576"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/cg_clif%20can%20bootstrap%20rustc/near/202726576" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/cg_clif.20can.20bootstrap.20rustc.html#202726576">(Jul 02 2020 at 18:23)</a>:</h4>
<p><a href="https://github.com/bjorn3/rustc_codegen_cranelift/issues/743#issuecomment-651108168">https://github.com/bjorn3/rustc_codegen_cranelift/issues/743#issuecomment-651108168</a></p>
<p>Cross posting from <a href="https://rust-lang.zulipchat.com/#narrow/stream/131828-t-compiler/topic/bootstrap.20rustc.20using.20cg_clif">https://rust-lang.zulipchat.com/#narrow/stream/131828-t-compiler/topic/bootstrap.20rustc.20using.20cg_clif</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bjorn3/rustc_codegen_cranelift/issues/743#issuecomment-651108168" style="background-image: url(https://avatars0.githubusercontent.com/u/17426603?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bjorn3/rustc_codegen_cranelift/issues/743#issuecomment-651108168" title="Compile rustc using cg_clif · Issue #743 · bjorn3/rustc_codegen_cranelift">Compile rustc using cg_clif · Issue #743 · bjorn3/rustc_codegen_cranelift</a></div><div class="message_embed_description">$ cd rustc_codegen_cranelift $ cargo build --release $ git clone https://github.com/rust-lang/rust.git $ cd rust $ git apply ../patches/* $ git apply - &lt;&lt;EOF diff --git a/src/bootstrap/bin/ru...</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://rust-lang.zulipchat.com/#narrow/stream/131828-t-compiler/topic/bootstrap.20rustc.20using.20cg_clif" style="background-image: url(https://zulip-avatars.s3.amazonaws.com/4715/realm/icon.png?version=2)"></a><div class="data-container"><div class="message_embed_title"><a href="https://rust-lang.zulipchat.com/#narrow/stream/131828-t-compiler/topic/bootstrap.20rustc.20using.20cg_clif" title="rust-lang">rust-lang</a></div><div class="message_embed_description">rust-lang org</div></div></div>



<a name="202726602"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/cg_clif%20can%20bootstrap%20rustc/near/202726602" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/cg_clif.20can.20bootstrap.20rustc.html#202726602">(Jul 02 2020 at 18:23)</a>:</h4>
<p>Depends on <a href="https://github.com/bytecodealliance/wasmtime/pull/1559">https://github.com/bytecodealliance/wasmtime/pull/1559</a> and <a href="https://github.com/bytecodealliance/wasmtime/pull/1939">https://github.com/bytecodealliance/wasmtime/pull/1939</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/1559" style="background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/1559" title="SystemV struct arguments by bjorn3 · Pull Request #1559 · bytecodealliance/wasmtime">SystemV struct arguments by bjorn3 · Pull Request #1559 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">According to the SystemV abi, struct arguments must be passed at a fixed stack offset. Cranelift didn&#39;t have any way to implement this before. This is necessary to compile proc-macros using cg_...</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/1939" style="background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/1939" title="Fix Switch for 128bit integers by bjorn3 · Pull Request #1939 · bytecodealliance/wasmtime">Fix Switch for 128bit integers by bjorn3 · Pull Request #1939 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">Fixes bjorn3/rustc_codegen_cranelift#757
Required by bjorn3/rustc_codegen_cranelift#743</div></div></div>



<a name="202727401"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/cg_clif%20can%20bootstrap%20rustc/near/202727401" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/cg_clif.20can.20bootstrap.20rustc.html#202727401">(Jul 02 2020 at 18:30)</a>:</h4>
<p>Very nice!</p>



<a name="202784850"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/cg_clif%20can%20bootstrap%20rustc/near/202784850" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joey Gouly <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/cg_clif.20can.20bootstrap.20rustc.html#202784850">(Jul 03 2020 at 09:35)</a>:</h4>
<p><span class="user-mention" data-user-id="264278">@bjorn3</span> on x86 I assume?</p>



<a name="202784919"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/cg_clif%20can%20bootstrap%20rustc/near/202784919" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joey Gouly <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/cg_clif.20can.20bootstrap.20rustc.html#202784919">(Jul 03 2020 at 09:36)</a>:</h4>
<p>Wondering how hard it would be to try on my arm64 machine</p>



<a name="202785241"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/cg_clif%20can%20bootstrap%20rustc/near/202785241" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/cg_clif.20can.20bootstrap.20rustc.html#202785241">(Jul 03 2020 at 09:40)</a>:</h4>
<p>Yes I used x86_64. arm64 doesn't yet work with cg_clif. The aarch64 backend doesn't yet support 128bit integers. Those are used very extensively in the const eval part of rustc. In fact the last thing I had to solve before cg_clif could bootstrap ristc was adding 128bit support to cranelift_frontend::Switch.</p>



<a name="202785350"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/cg_clif%20can%20bootstrap%20rustc/near/202785350" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joey Gouly <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/cg_clif.20can.20bootstrap.20rustc.html#202785350">(Jul 03 2020 at 09:42)</a>:</h4>
<p>Does cranelift not have legalisation for 128 bit integers?</p>



<a name="202785416"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/cg_clif%20can%20bootstrap%20rustc/near/202785416" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Bouvier <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/cg_clif.20can.20bootstrap.20rustc.html#202785416">(Jul 03 2020 at 09:43)</a>:</h4>
<p>We do have some of it; it might be disabled for the aarch64 backend, though, not sure.</p>



<a name="202786330"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/cg_clif%20can%20bootstrap%20rustc/near/202786330" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/cg_clif.20can.20bootstrap.20rustc.html#202786330">(Jul 03 2020 at 09:54)</a>:</h4>
<p>No new style backends have the necessary legalizations enabled. They only enable a small subset.</p>



<a name="202786416"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/cg_clif%20can%20bootstrap%20rustc/near/202786416" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/cg_clif.20can.20bootstrap.20rustc.html#202786416">(Jul 03 2020 at 09:55)</a>:</h4>
<p>Also for function parameters and calls the necessary legalizations are part of the abi handling for the old style backends.</p>



<a name="202786498"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/cg_clif%20can%20bootstrap%20rustc/near/202786498" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/cg_clif.20can.20bootstrap.20rustc.html#202786498">(Jul 03 2020 at 09:56)</a>:</h4>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/08efcbd9d5638c3d1ff2989f00e65c22ddc3c803/cranelift/codegen/src/legalizer/boundary.rs#L465-L477">https://github.com/bytecodealliance/wasmtime/blob/08efcbd9d5638c3d1ff2989f00e65c22ddc3c803/cranelift/codegen/src/legalizer/boundary.rs#L465-L477</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/08efcbd9d5638c3d1ff2989f00e65c22ddc3c803/cranelift/codegen/src/legalizer/boundary.rs#L465-L477" style="background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/08efcbd9d5638c3d1ff2989f00e65c22ddc3c803/cranelift/codegen/src/legalizer/boundary.rs#L465-L477" title="bytecodealliance/wasmtime">bytecodealliance/wasmtime</a></div><div class="message_embed_description">Standalone JIT-style runtime for WebAssembly, using Cranelift - bytecodealliance/wasmtime</div></div></div>



<a name="203700143"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/cg_clif%20can%20bootstrap%20rustc/near/203700143" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/cg_clif.20can.20bootstrap.20rustc.html#203700143">(Jul 13 2020 at 10:45)</a>:</h4>
<p>Can somebody please review <a href="https://github.com/bytecodealliance/wasmtime/pull/1939">https://github.com/bytecodealliance/wasmtime/pull/1939</a>? It should be easy to do.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/1939" style="background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/1939" title="Fix Switch for 128bit integers by bjorn3 · Pull Request #1939 · bytecodealliance/wasmtime">Fix Switch for 128bit integers by bjorn3 · Pull Request #1939 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">Fixes bjorn3/rustc_codegen_cranelift#757
Required by bjorn3/rustc_codegen_cranelift#743</div></div></div>



<a name="204127012"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/cg_clif%20can%20bootstrap%20rustc/near/204127012" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/cg_clif.20can.20bootstrap.20rustc.html#204127012">(Jul 16 2020 at 18:56)</a>:</h4>
<p><span class="user-mention" data-user-id="253994">@Alex Crichton</span> On <a href="https://github.com/bytecodealliance/wasmtime/pull/1559">https://github.com/bytecodealliance/wasmtime/pull/1559</a> the macOS builder failed without log. Can you restart it?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/1559" style="background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/1559" title="SystemV struct arguments by bjorn3 · Pull Request #1559 · bytecodealliance/wasmtime">SystemV struct arguments by bjorn3 · Pull Request #1559 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">According to the SystemV abi, struct arguments must be passed at a fixed stack offset. Cranelift didn&#39;t have any way to implement this before. This is necessary to compile proc-macros using cg_...</div></div></div>



<a name="204127061"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/cg_clif%20can%20bootstrap%20rustc/near/204127061" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/cg_clif.20can.20bootstrap.20rustc.html#204127061">(Jul 16 2020 at 18:56)</a>:</h4>
<p>eh I wouldn't worry about it, unfortunately we can't restart just one builder</p>



<a name="204127072"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/cg_clif%20can%20bootstrap%20rustc/near/204127072" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/cg_clif.20can.20bootstrap.20rustc.html#204127072">(Jul 16 2020 at 18:57)</a>:</h4>
<p>and it passed debug tests on macos so it's unlikely to fail in release anyway</p>



<a name="204127313"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/cg_clif%20can%20bootstrap%20rustc/near/204127313" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/cg_clif.20can.20bootstrap.20rustc.html#204127313">(Jul 16 2020 at 18:58)</a>:</h4>
<p>okay</p>



<a name="204197035"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/cg_clif%20can%20bootstrap%20rustc/near/204197035" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/cg_clif.20can.20bootstrap.20rustc.html#204197035">(Jul 17 2020 at 11:55)</a>:</h4>
<p><a href="https://github.com/bytecodealliance/wasmtime/pull/1559">https://github.com/bytecodealliance/wasmtime/pull/1559</a> has been merged, so it is no longer necessary to patch cg_clif to bootstrap rustc. Only rustc needs to be patched to integrate with cg_clif. <a href="https://github.com/bjorn3/rustc_codegen_cranelift/issues/743#issuecomment-660046919">https://github.com/bjorn3/rustc_codegen_cranelift/issues/743#issuecomment-660046919</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/1559" style="background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/1559" title="SystemV struct arguments by bjorn3 · Pull Request #1559 · bytecodealliance/wasmtime">SystemV struct arguments by bjorn3 · Pull Request #1559 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">According to the SystemV abi, struct arguments must be passed at a fixed stack offset. Cranelift didn&#39;t have any way to implement this before. This is necessary to compile proc-macros using cg_...</div></div></div>



<a name="204197128"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/cg_clif%20can%20bootstrap%20rustc/near/204197128" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Bouvier <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/cg_clif.20can.20bootstrap.20rustc.html#204197128">(Jul 17 2020 at 11:57)</a>:</h4>
<p>Great work <span class="user-mention" data-user-id="264278">@bjorn3</span> !</p>



<a name="204197140"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/cg_clif%20can%20bootstrap%20rustc/near/204197140" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/cg_clif.20can.20bootstrap.20rustc.html#204197140">(Jul 17 2020 at 11:57)</a>:</h4>
<p>Thanks!</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>