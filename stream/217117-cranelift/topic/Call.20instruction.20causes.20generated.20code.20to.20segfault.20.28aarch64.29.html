<html>
<head><meta charset="utf-8"><title>Call instruction causes generated code to segfault (aarch64) · cranelift · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/index.html">cranelift</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html">Call instruction causes generated code to segfault (aarch64)</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="404768224"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/404768224" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leslie Kerman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#404768224">(Nov 29 2023 at 03:13)</a>:</h4>
<p><a href="/user_uploads/15107/JCgB81XOtXpusbBVqY_Ae_l2/Screenshot-2023-11-29-at-03.11.50.png">Screenshot-2023-11-29-at-03.11.50.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/15107/JCgB81XOtXpusbBVqY_Ae_l2/Screenshot-2023-11-29-at-03.11.50.png" title="Screenshot-2023-11-29-at-03.11.50.png"><img src="/user_uploads/15107/JCgB81XOtXpusbBVqY_Ae_l2/Screenshot-2023-11-29-at-03.11.50.png"></a></div><p>The minimum reproducible case:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">File</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">prelude</span>::<span class="p">{</span>
<span class="w">    </span><span class="n">types</span>::<span class="p">{</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="p">},</span>
<span class="w">    </span><span class="n">Value</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="p">{</span>
<span class="w">    </span><span class="n">ir</span>::<span class="p">{</span>
<span class="w">        </span><span class="n">AbiParam</span><span class="p">,</span><span class="w"> </span><span class="n">Block</span><span class="p">,</span><span class="w"> </span><span class="n">ExtFuncData</span><span class="p">,</span><span class="w"> </span><span class="n">ExternalName</span><span class="p">,</span><span class="w"> </span><span class="n">Function</span><span class="p">,</span><span class="w"> </span><span class="n">InstBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">Signature</span><span class="p">,</span>
<span class="w">        </span><span class="n">UserExternalName</span><span class="p">,</span><span class="w"> </span><span class="n">UserFuncName</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">isa</span>::<span class="n">CallConv</span><span class="p">,</span>
<span class="w">    </span><span class="n">settings</span>::<span class="p">{</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">Flags</span><span class="p">},</span>
<span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_frontend</span>::<span class="p">{</span><span class="n">FunctionBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">FunctionBuilderContext</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_module</span>::<span class="p">{</span><span class="n">Linkage</span><span class="p">,</span><span class="w"> </span><span class="n">Module</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_object</span>::<span class="p">{</span><span class="n">ObjectBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">ObjectModule</span><span class="p">};</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Cranelift setup.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Flags</span>::<span class="n">new</span><span class="p">(</span><span class="n">settings</span>::<span class="n">builder</span><span class="p">());</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">object_module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">isa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cranelift_native</span>::<span class="n">builder</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"Error getting native ISA"</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">finish</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">obj_builder</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">ObjectBuilder</span>::<span class="n">new</span><span class="p">(</span><span class="n">isa</span><span class="p">,</span><span class="w"> </span><span class="s">"program"</span><span class="p">,</span><span class="w"> </span><span class="n">cranelift_module</span>::<span class="n">default_libcall_names</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="n">ObjectModule</span>::<span class="n">new</span><span class="p">(</span><span class="n">obj_builder</span><span class="p">)</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder_ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionBuilderContext</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Some repeating patterns used in both fn0 and fn1.</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">make_sig</span><span class="p">(</span><span class="n">params</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">Type</span><span class="p">],</span><span class="w"> </span><span class="n">returns</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">Type</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nc">Signature</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Signature</span>::<span class="n">new</span><span class="p">(</span><span class="n">CallConv</span>::<span class="n">SystemV</span><span class="p">);</span>
<span class="w">        </span><span class="n">sig</span><span class="p">.</span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">|&amp;</span><span class="n">t</span><span class="o">|</span><span class="w"> </span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">t</span><span class="p">)).</span><span class="n">collect</span><span class="p">();</span>
<span class="w">        </span><span class="n">sig</span><span class="p">.</span><span class="n">returns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">returns</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">|&amp;</span><span class="n">t</span><span class="o">|</span><span class="w"> </span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">t</span><span class="p">)).</span><span class="n">collect</span><span class="p">();</span>
<span class="w">        </span><span class="n">sig</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">init_entry_block</span><span class="p">(</span><span class="n">builder</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">FunctionBuilder</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Block</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">create_block</span><span class="p">();</span>
<span class="w">        </span><span class="n">builder</span><span class="p">.</span><span class="n">append_block_params_for_function_params</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
<span class="w">        </span><span class="n">builder</span><span class="p">.</span><span class="n">switch_to_block</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
<span class="w">        </span><span class="n">builder</span><span class="p">.</span><span class="n">seal_block</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
<span class="w">        </span><span class="n">block</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Function `succ(i32) -&gt; i32`.</span>
<span class="w">    </span><span class="c1">// fn 0:0</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sig0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">make_sig</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="n">types</span>::<span class="n">I32</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">types</span>::<span class="n">I32</span><span class="p">]);</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">func_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">object_module</span>
<span class="w">            </span><span class="p">.</span><span class="n">declare_function</span><span class="p">(</span><span class="s">"succ"</span><span class="p">,</span><span class="w"> </span><span class="n">Linkage</span>::<span class="n">Export</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sig0</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Function</span>::<span class="n">with_name_signature</span><span class="p">(</span><span class="n">UserFuncName</span>::<span class="n">user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">sig0</span><span class="p">.</span><span class="n">clone</span><span class="p">());</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionBuilder</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">builder_ctx</span><span class="p">);</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">entry_block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">init_entry_block</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">arg0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">block_params</span><span class="p">(</span><span class="n">entry_block</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">iadd_imm</span><span class="p">(</span><span class="n">arg0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">return_</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="n">val</span><span class="p">]);</span>
<span class="w">        </span><span class="n">builder</span><span class="p">.</span><span class="n">finalize</span><span class="p">();</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">);</span>
<span class="w">        </span><span class="n">object_module</span>
<span class="w">            </span><span class="p">.</span><span class="n">define_function</span><span class="p">(</span><span class="n">func_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">Context</span>::<span class="n">for_function</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="n">func_id</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// Function `main() -&gt; i32`.</span>
<span class="w">    </span><span class="c1">// fn 0:1</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sig1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">make_sig</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[],</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">types</span>::<span class="n">I32</span><span class="p">]);</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">func_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">object_module</span>
<span class="w">            </span><span class="p">.</span><span class="n">declare_function</span><span class="p">(</span><span class="s">"main"</span><span class="p">,</span><span class="w"> </span><span class="n">Linkage</span>::<span class="n">Export</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sig1</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Function</span>::<span class="n">with_name_signature</span><span class="p">(</span><span class="n">UserFuncName</span>::<span class="n">user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">sig1</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionBuilder</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">builder_ctx</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Import fn0.</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">fn0_ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">sig_ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">import_signature</span><span class="p">(</span><span class="n">sig0</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">name_ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span>
<span class="w">                </span><span class="p">.</span><span class="n">func</span>
<span class="w">                </span><span class="p">.</span><span class="n">declare_imported_user_function</span><span class="p">(</span><span class="n">UserExternalName</span>::<span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="w">            </span><span class="n">builder</span><span class="p">.</span><span class="n">import_function</span><span class="p">(</span><span class="n">ExtFuncData</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">name</span>: <span class="nc">ExternalName</span>::<span class="n">user</span><span class="p">(</span><span class="n">name_ref</span><span class="p">),</span>
<span class="w">                </span><span class="n">signature</span>: <span class="nc">sig_ref</span><span class="p">,</span>
<span class="w">                </span><span class="n">colocated</span>: <span class="nc">false</span><span class="p">,</span>
<span class="w">            </span><span class="p">})</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="n">init_entry_block</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">iconst</span><span class="p">(</span><span class="n">types</span>::<span class="n">I32</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// This call instruction causes the generated code to segfault:</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">call_inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">call</span><span class="p">(</span><span class="n">fn0_ref</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">x</span><span class="p">]);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="o">&amp;</span><span class="n">call_result</span>: <span class="kp">&amp;</span><span class="nc">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span>
<span class="w">            </span><span class="p">.</span><span class="n">inst_results</span><span class="p">(</span><span class="n">call_inst</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">iter</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">next</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">into</span><span class="p">();</span>
<span class="w">        </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">return_</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="n">call_result</span><span class="p">]);</span>
<span class="w">        </span><span class="c1">// Commenting the above and uncomment this line does not segfault:</span>
<span class="w">        </span><span class="c1">// builder.ins().return_(&amp;[x]);</span>
<span class="w">        </span><span class="n">builder</span><span class="p">.</span><span class="n">finalize</span><span class="p">();</span>

<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">);</span>
<span class="w">        </span><span class="n">object_module</span>
<span class="w">            </span><span class="p">.</span><span class="n">define_function</span><span class="p">(</span><span class="n">func_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">Context</span>::<span class="n">for_function</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="n">func_id</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">obj_prod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">object_module</span><span class="p">.</span><span class="n">finish</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obj_prod</span><span class="p">.</span><span class="n">emit</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="n">write_bytes_to_path</span><span class="p">(</span><span class="s">"program.o"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bytes</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">write_bytes_to_path</span><span class="p">(</span><span class="n">path</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nc">std</span>::<span class="n">io</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span>::<span class="n">create</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span>::<span class="n">io</span>::<span class="n">Write</span>::<span class="n">write_all</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>Am I doing something wrong here or is this a bug?</p>



<a name="404856185"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/404856185" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Afonso Bordado <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#404856185">(Nov 29 2023 at 12:41)</a>:</h4>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>This looks pretty much correct, I got this to run on my machine by changing the call instruction to call <code>u0:0</code> instead of <code>u0:1</code>, I think it's just recursing into <code>main</code> until the stack overflows.</p>



<a name="404856507"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/404856507" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leslie Kerman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#404856507">(Nov 29 2023 at 12:43)</a>:</h4>
<p>Sorry, my mistake. Changing the call instruction to <code>u0:0</code> still results in segfault.<br>
<a href="/user_uploads/15107/-hPfBorKWB3i1Wu336W8rSrP/Screenshot-2023-11-29-at-12.43.29.png">Screenshot-2023-11-29-at-12.43.29.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/15107/-hPfBorKWB3i1Wu336W8rSrP/Screenshot-2023-11-29-at-12.43.29.png" title="Screenshot-2023-11-29-at-12.43.29.png"><img src="/user_uploads/15107/-hPfBorKWB3i1Wu336W8rSrP/Screenshot-2023-11-29-at-12.43.29.png"></a></div>



<a name="404857166"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/404857166" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Afonso Bordado <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#404857166">(Nov 29 2023 at 12:46)</a>:</h4>
<p>Huh, weird, that works in my machine. <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> Can you try disabling pointer authentication by adding a </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="n">isa</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="s">"sign_return_address"</span><span class="p">,</span><span class="w"> </span><span class="s">"false"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</code></pre></div>



<a name="404857186"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/404857186" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Afonso Bordado <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#404857186">(Nov 29 2023 at 12:47)</a>:</h4>
<p>when building the ISA?</p>



<a name="404857274"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/404857274" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Afonso Bordado <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#404857274">(Nov 29 2023 at 12:47)</a>:</h4>
<p>I don't know if pointer authentication needs someting special to work</p>



<a name="404858302"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/404858302" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leslie Kerman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#404858302">(Nov 29 2023 at 12:53)</a>:</h4>
<p>I'm not sure what you meant by <code>isa.set(...)</code>, as there's no function <code>set</code> for <code>TargetIsa</code>. Could you clarify which line I'm supposed to add this in?</p>



<a name="404858439"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/404858439" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Afonso Bordado <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#404858439">(Nov 29 2023 at 12:54)</a>:</h4>
<p>Right, sorry, it's in the ISABuilder, so something along these lines:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">isa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cranelift_native</span>::<span class="n">builder</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"Error getting native ISA"</span><span class="p">);</span>
<span class="w">        </span><span class="n">isa</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="s">"sign_return_address"</span><span class="p">,</span><span class="w"> </span><span class="s">"false"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">isa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isa</span>
<span class="w">            </span><span class="p">.</span><span class="n">finish</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
</code></pre></div>



<a name="404859100"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/404859100" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leslie Kerman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#404859100">(Nov 29 2023 at 12:56)</a>:</h4>
<p><a href="/user_uploads/15107/X41O36pXqBiu0UIXUS3Di8dg/Screenshot-2023-11-29-at-12.55.49.png">Screenshot-2023-11-29-at-12.55.49.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/15107/X41O36pXqBiu0UIXUS3Di8dg/Screenshot-2023-11-29-at-12.55.49.png" title="Screenshot-2023-11-29-at-12.55.49.png"><img src="/user_uploads/15107/X41O36pXqBiu0UIXUS3Di8dg/Screenshot-2023-11-29-at-12.55.49.png"></a></div><p>It doesn't generate pointer auth anymore but it still segfaults. I suspect it's something wrong with my linking process.</p>



<a name="404859393"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/404859393" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Afonso Bordado <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#404859393">(Nov 29 2023 at 12:57)</a>:</h4>
<p>could you run it under lldb/gdb to check where it's crashing?</p>



<a name="404860257"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/404860257" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Afonso Bordado <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#404860257">(Nov 29 2023 at 13:00)</a>:</h4>
<p>Oh, also we could test with a PIE executable, not sure if that helps</p>



<a name="404860366"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/404860366" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Afonso Bordado <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#404860366">(Nov 29 2023 at 13:01)</a>:</h4>
<p>Try using these flags</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">flags_builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span>::<span class="n">builder</span><span class="p">();</span>
<span class="w">    </span><span class="n">flags_builder</span><span class="p">.</span><span class="n">enable</span><span class="p">(</span><span class="s">"is_pic"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Flags</span>::<span class="n">new</span><span class="p">(</span><span class="n">flags_builder</span><span class="p">);</span>
</code></pre></div>



<a name="404861359"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/404861359" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leslie Kerman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#404861359">(Nov 29 2023 at 13:05)</a>:</h4>
<p><a href="/user_uploads/15107/jCBd4RDURPrF4FYVm4Qs8M9p/Screenshot-2023-11-29-at-13.04.35.png">Screenshot-2023-11-29-at-13.04.35.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/15107/jCBd4RDURPrF4FYVm4Qs8M9p/Screenshot-2023-11-29-at-13.04.35.png" title="Screenshot-2023-11-29-at-13.04.35.png"><img src="/user_uploads/15107/jCBd4RDURPrF4FYVm4Qs8M9p/Screenshot-2023-11-29-at-13.04.35.png"></a></div><p>Clang crashed on linking in this case</p>



<a name="404861581"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/404861581" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Afonso Bordado <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#404861581">(Nov 29 2023 at 13:06)</a>:</h4>
<p>That is weird! Could you send me that binary, or run <code>objdump -Dr</code> on it?</p>



<a name="404861677"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/404861677" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leslie Kerman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#404861677">(Nov 29 2023 at 13:07)</a>:</h4>
<p><a href="/user_uploads/15107/IPgJWW9Xech-V-vUzw3d6LwB/Screenshot-2023-11-29-at-13.07.00.png">Screenshot-2023-11-29-at-13.07.00.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/15107/IPgJWW9Xech-V-vUzw3d6LwB/Screenshot-2023-11-29-at-13.07.00.png" title="Screenshot-2023-11-29-at-13.07.00.png"><img src="/user_uploads/15107/IPgJWW9Xech-V-vUzw3d6LwB/Screenshot-2023-11-29-at-13.07.00.png"></a></div>



<a name="404861698"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/404861698" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Afonso Bordado <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#404861698">(Nov 29 2023 at 13:07)</a>:</h4>
<p>(although i think that is probably unrelated to the main issue)</p>



<a name="404861730"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/404861730" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leslie Kerman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#404861730">(Nov 29 2023 at 13:07)</a>:</h4>
<p><a href="/user_uploads/15107/A4UkHr3r3aG0QZkWmw-8Bk0a/program.o">program.o</a><br>
the program</p>



<a name="404861901"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/404861901" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leslie Kerman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#404861901">(Nov 29 2023 at 13:08)</a>:</h4>
<p><a href="/user_uploads/15107/HTRbLMu6Fuu0f4QJzPFMsQ_Z/program.o">program.o</a><br>
Also this is the emitted object without enabling <code>is_pic</code> flag</p>



<a name="404866028"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/404866028" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Afonso Bordado <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#404866028">(Nov 29 2023 at 13:30)</a>:</h4>
<p>These all look okay to me. Could you try running the non PIC version under a debugger, and check where it crashes?</p>



<a name="404866095"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/404866095" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Afonso Bordado <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#404866095">(Nov 29 2023 at 13:30)</a>:</h4>
<p>I think the linker error under the PIC might be unrelated, although probably something to follow up after</p>



<a name="404866204"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/404866204" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Afonso Bordado <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#404866204">(Nov 29 2023 at 13:31)</a>:</h4>
<p>Unfortunateley I don't have a Mac to be able to run these examples</p>



<a name="404866362"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/404866362" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leslie Kerman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#404866362">(Nov 29 2023 at 13:32)</a>:</h4>
<p>It was fine on my x64 laptop, so it's probably a M-chip specific problem</p>



<a name="404866597"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/404866597" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leslie Kerman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#404866597">(Nov 29 2023 at 13:33)</a>:</h4>
<p><a href="/user_uploads/15107/snNdtNPi4Oj9bGI0Cv-GPH4i/Screenshot-2023-11-29-at-13.33.27.png">Screenshot-2023-11-29-at-13.33.27.png</a><br>
this is the output on lldb</p>
<div class="message_inline_image"><a href="/user_uploads/15107/snNdtNPi4Oj9bGI0Cv-GPH4i/Screenshot-2023-11-29-at-13.33.27.png" title="Screenshot-2023-11-29-at-13.33.27.png"><img src="/user_uploads/15107/snNdtNPi4Oj9bGI0Cv-GPH4i/Screenshot-2023-11-29-at-13.33.27.png"></a></div>



<a name="404906549"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/404906549" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Afonso Bordado <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#404906549">(Nov 29 2023 at 16:37)</a>:</h4>
<p>I don't have much more time to look at this today, sorry! Would you be able to figure out where that invalid load is coming from? We have one load instruction in the main function, is it that one? Or does it happen before?</p>



<a name="404975783"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/404975783" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leslie Kerman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#404975783">(Nov 30 2023 at 00:30)</a>:</h4>
<p>That's ok. Thanks for your help</p>



<a name="404976285"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/404976285" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leslie Kerman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#404976285">(Nov 30 2023 at 00:33)</a>:</h4>
<p><a href="/user_uploads/15107/F1r9pKQSLi_TtzZDK3rKjb1O/Screenshot-2023-11-30-at-00.29.57.png">Screenshot-2023-11-30-at-00.29.57.png</a><br>
The executable seem to segfault on the instruction <code>blr x2</code>.</p>
<div class="message_inline_image"><a href="/user_uploads/15107/F1r9pKQSLi_TtzZDK3rKjb1O/Screenshot-2023-11-30-at-00.29.57.png" title="Screenshot-2023-11-30-at-00.29.57.png"><img src="/user_uploads/15107/F1r9pKQSLi_TtzZDK3rKjb1O/Screenshot-2023-11-30-at-00.29.57.png"></a></div>



<a name="405098801"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/405098801" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Afonso Bordado <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#405098801">(Nov 30 2023 at 11:39)</a>:</h4>
<p>Some interesting results. I borrowed a M1 Mac, it has <code>clang 14.0.3</code> instead of 15.</p>
<p>Compiling with <code>is_pic</code> and linking with <code>clang</code> makes the executable work without issue. </p>
<p>Compiling without <code>is_pic</code> crashes in the dynamic linker before getting to <code>main</code>. I also tried  to compile that binary with <code>clang -fno-pie ./program.o</code>, which led to the following warnings:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">ld</span>: <span class="nc">warning</span>: <span class="o">-</span><span class="n">no_pie</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">deprecated</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">targeting</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">OS</span><span class="w"> </span><span class="n">versions</span>
<span class="n">ld</span>: <span class="nc">warning</span>: <span class="o">-</span><span class="n">no_pie</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">arm64</span>
</code></pre></div>
<p>So I'm not sure compiling without <code>is_pic</code> for Mac ARM machines is a valid configuration</p>



<a name="405098846"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/405098846" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Afonso Bordado <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#405098846">(Nov 30 2023 at 11:39)</a>:</h4>
<p>I'm going to try to install clang 15 to reproduce the issue you were having with <code>is_pic</code></p>



<a name="405100314"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/405100314" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Afonso Bordado <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#405100314">(Nov 30 2023 at 11:48)</a>:</h4>
<p>Hmm, compiling with clang-15 worked here <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="405101395"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/405101395" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leslie Kerman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#405101395">(Nov 30 2023 at 11:55)</a>:</h4>
<p><a href="/user_uploads/15107/Gu49OVlBaR8ncI6rjYSSCOmv/Screenshot-2023-11-30-at-11.54.21.png">Screenshot-2023-11-30-at-11.54.21.png</a><br>
Can you try linking with <code>ld</code>? I think it's the problem of <code>ld</code> here not <code>clang</code>'s invocation of it.</p>
<div class="message_inline_image"><a href="/user_uploads/15107/Gu49OVlBaR8ncI6rjYSSCOmv/Screenshot-2023-11-30-at-11.54.21.png" title="Screenshot-2023-11-30-at-11.54.21.png"><img src="/user_uploads/15107/Gu49OVlBaR8ncI6rjYSSCOmv/Screenshot-2023-11-30-at-11.54.21.png"></a></div>



<a name="405101616"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/405101616" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Afonso Bordado <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#405101616">(Nov 30 2023 at 11:56)</a>:</h4>
<p>It didn't seem to crash:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">m1</span><span class="o">@</span><span class="n">ab850359</span><span class="o">-</span><span class="n">a1b4</span><span class="o">-</span><span class="mi">4</span><span class="n">fa7</span><span class="o">-</span><span class="mi">85</span><span class="n">ab</span><span class="o">-</span><span class="n">da6c63f0c56d</span><span class="w"> </span><span class="n">clif</span><span class="o">-</span><span class="n">test</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">ld</span><span class="w"> </span><span class="o">-</span><span class="n">arch</span><span class="w"> </span><span class="n">arm64</span><span class="w"> </span><span class="o">-</span><span class="n">macos_version_min</span><span class="w"> </span><span class="mf">14.0.0</span><span class="w"> </span><span class="n">program</span><span class="p">.</span><span class="n">o</span>
<span class="n">ld</span>: <span class="nc">dynamic</span><span class="w"> </span><span class="n">executables</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">dylibs</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">libSystem</span><span class="p">.</span><span class="n">dylib</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">architecture</span><span class="w"> </span><span class="n">arm64</span>
</code></pre></div>



<a name="405101723"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/405101723" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Afonso Bordado <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#405101723">(Nov 30 2023 at 11:57)</a>:</h4>
<p>Would you be able to try with an older xcode version?</p>



<a name="405101791"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/405101791" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Afonso Bordado <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#405101791">(Nov 30 2023 at 11:57)</a>:</h4>
<p>I wonder if this an issue only on newer linkers</p>



<a name="405102373"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/405102373" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Afonso Bordado <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#405102373">(Nov 30 2023 at 12:00)</a>:</h4>
<p>Also, do you have an alternate linker such as lld available? Using it also worked for me:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">m1</span><span class="o">@</span><span class="n">ab850359</span><span class="o">-</span><span class="n">a1b4</span><span class="o">-</span><span class="mi">4</span><span class="n">fa7</span><span class="o">-</span><span class="mi">85</span><span class="n">ab</span><span class="o">-</span><span class="n">da6c63f0c56d</span><span class="w"> </span><span class="n">clif</span><span class="o">-</span><span class="n">test</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">clang</span><span class="w"> </span><span class="o">-</span><span class="n">fuse</span><span class="o">-</span><span class="n">ld</span><span class="o">=</span><span class="n">lld</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">program</span><span class="p">.</span><span class="n">o</span>
<span class="n">Homebrew</span><span class="w"> </span><span class="n">clang</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="mf">15.0.7</span>
<span class="n">Target</span>: <span class="nc">arm64</span><span class="o">-</span><span class="n">apple</span><span class="o">-</span><span class="n">darwin23</span><span class="p">.</span><span class="mf">1.0</span>
<span class="n">Thread</span><span class="w"> </span><span class="n">model</span>: <span class="nc">posix</span>
<span class="n">InstalledDir</span>: <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">homebrew</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">llvm</span><span class="o">@</span><span class="mi">15</span><span class="o">/</span><span class="n">bin</span>
<span class="w"> </span><span class="s">"/opt/homebrew/opt/llvm@15/bin/ld64.lld"</span><span class="w"> </span><span class="o">-</span><span class="n">demangle</span><span class="w"> </span><span class="o">-</span><span class="n">dynamic</span><span class="w"> </span><span class="o">-</span><span class="n">arch</span><span class="w"> </span><span class="n">arm64</span><span class="w"> </span><span class="o">-</span><span class="n">platform_version</span><span class="w"> </span><span class="n">macos</span><span class="w"> </span><span class="mf">14.0.0</span><span class="w"> </span><span class="mf">14.0.0</span><span class="w"> </span><span class="o">-</span><span class="n">syslibroot</span><span class="w"> </span><span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Developer</span><span class="o">/</span><span class="n">CommandLineTools</span><span class="o">/</span><span class="n">SDKs</span><span class="o">/</span><span class="n">MacOSX14</span><span class="p">.</span><span class="n">sdk</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">out</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">program</span><span class="p">.</span><span class="n">o</span><span class="w"> </span><span class="o">-</span><span class="n">lSystem</span><span class="w"> </span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">homebrew</span><span class="o">/</span><span class="n">Cellar</span><span class="o">/</span><span class="n">llvm</span><span class="o">@</span><span class="mi">15</span><span class="o">/</span><span class="mf">15.0.7</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">clang</span><span class="o">/</span><span class="mf">15.0.7</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">darwin</span><span class="o">/</span><span class="n">libclang_rt</span><span class="p">.</span><span class="n">osx</span><span class="p">.</span><span class="n">a</span>
<span class="n">m1</span><span class="o">@</span><span class="n">ab850359</span><span class="o">-</span><span class="n">a1b4</span><span class="o">-</span><span class="mi">4</span><span class="n">fa7</span><span class="o">-</span><span class="mi">85</span><span class="n">ab</span><span class="o">-</span><span class="n">da6c63f0c56d</span><span class="w"> </span><span class="n">clif</span><span class="o">-</span><span class="n">test</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">out</span>
<span class="n">m1</span><span class="o">@</span><span class="n">ab850359</span><span class="o">-</span><span class="n">a1b4</span><span class="o">-</span><span class="mi">4</span><span class="n">fa7</span><span class="o">-</span><span class="mi">85</span><span class="n">ab</span><span class="o">-</span><span class="n">da6c63f0c56d</span><span class="w"> </span><span class="n">clif</span><span class="o">-</span><span class="n">test</span><span class="w"> </span><span class="o">%</span>
</code></pre></div>



<a name="405104056"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/405104056" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leslie Kerman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#405104056">(Nov 30 2023 at 12:09)</a>:</h4>
<p><a href="/user_uploads/15107/4PTiYe-2u_0fKQeZN7B4tbdu/Screenshot-2023-11-30-at-12.09.06.png">Screenshot-2023-11-30-at-12.09.06.png</a><br>
I have this error here with both LLVM15's lld and LLVM17's</p>
<div class="message_inline_image"><a href="/user_uploads/15107/4PTiYe-2u_0fKQeZN7B4tbdu/Screenshot-2023-11-30-at-12.09.06.png" title="Screenshot-2023-11-30-at-12.09.06.png"><img src="/user_uploads/15107/4PTiYe-2u_0fKQeZN7B4tbdu/Screenshot-2023-11-30-at-12.09.06.png"></a></div>



<a name="405104749"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/405104749" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leslie Kerman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#405104749">(Nov 30 2023 at 12:13)</a>:</h4>
<p>Ok using ld64.lld works</p>



<a name="405104761"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/405104761" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leslie Kerman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#405104761">(Nov 30 2023 at 12:13)</a>:</h4>
<p>Thanks a lot for the help</p>



<a name="405104885"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Call%20instruction%20causes%20generated%20code%20to%20segfault%20%28aarch64%29/near/405104885" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Afonso Bordado <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Call.20instruction.20causes.20generated.20code.20to.20segfault.20.28aarch64.29.html#405104885">(Nov 30 2023 at 12:14)</a>:</h4>
<p>hmm, i think that would point it to being an issue with the version that apple ships in the latest xcode. Or alternatively they no longer accepting something we are producing</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>