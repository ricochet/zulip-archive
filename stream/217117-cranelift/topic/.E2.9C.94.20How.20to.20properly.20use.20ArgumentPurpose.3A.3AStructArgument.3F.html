<html>
<head><meta charset="utf-8"><title>✔ How to properly use ArgumentPurpose::StructArgument? · cranelift · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/index.html">cranelift</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20How.20to.20properly.20use.20ArgumentPurpose.3A.3AStructArgument.3F.html">✔ How to properly use ArgumentPurpose::StructArgument?</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="445223153"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20How%20to%20properly%20use%20ArgumentPurpose%3A%3AStructArgument%3F/near/445223153" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cherry <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20How.20to.20properly.20use.20ArgumentPurpose.3A.3AStructArgument.3F.html#445223153">(Jun 17 2024 at 20:53)</a>:</h4>
<p>Note: Using Windows x86_64</p>
<p>From my understanding, I can add this as a param with type I64 and <code>ArgumentPurpose::StructArgument(size)</code>. I receive a pointer to the struct which I can read from to get the data.</p>
<p>I've tried doing this, but the struct I passed in is not coming out correctly unless I offset the ptr read by 16 bytes.</p>
<p>I know the structs size ahead of time. But I do not know of any way to properly read this. Either that or I'm doing this wrong and missing something.</p>
<p>The test case is quite simple however. I read straight off of the <code>v0</code> I passed into another function.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">defining</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">funcid1</span><span class="p">:</span><span class="w"> </span><span class="nc">function</span><span class="w"> </span><span class="n">u0</span><span class="p">:</span><span class="mi">1</span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="n">sarg</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="n">sret</span><span class="p">)</span><span class="w"> </span><span class="n">windows_fastcall</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">sig0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="n">windows_fastcall</span>
<span class="w">    </span><span class="n">fn0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u0</span><span class="p">:</span><span class="mi">0</span><span class="w"> </span><span class="n">sig0</span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">):</span>
<span class="w">    </span><span class="nc">stack_store</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">ss0</span>
<span class="w">    </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mh">0x01af_9243_d8f0</span>
<span class="w">    </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">)</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x01af_9243_d8f0</span>
<span class="w">    </span><span class="k">return</span>
<span class="p">}</span>
</code></pre></div>



<a name="445223404"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20How%20to%20properly%20use%20ArgumentPurpose%3A%3AStructArgument%3F/near/445223404" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20How.20to.20properly.20use.20ArgumentPurpose.3A.3AStructArgument.3F.html#445223404">(Jun 17 2024 at 20:54)</a>:</h4>
<p>What is the function declaration on the caller's side? Eg if you called it from C what is the function signature and struct definition.</p>



<a name="445223579"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20How%20to%20properly%20use%20ArgumentPurpose%3A%3AStructArgument%3F/near/445223579" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20How.20to.20properly.20use.20ArgumentPurpose.3A.3AStructArgument.3F.html#445223579">(Jun 17 2024 at 20:56)</a>:</h4>
<p>Also did you mean to pass v0 as struct or as pointer to fn0?</p>



<a name="445223987"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20How%20to%20properly%20use%20ArgumentPurpose%3A%3AStructArgument%3F/near/445223987" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cherry <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20How.20to.20properly.20use.20ArgumentPurpose.3A.3AStructArgument.3F.html#445223987">(Jun 17 2024 at 20:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="264278">bjorn3</span> <a href="#narrow/stream/217117-cranelift/topic/How.20to.20properly.20use.20ArgumentPurpose.3A.3AStructArgument.3F/near/445223579">said</a>:</p>
<blockquote>
<p>Also did you mean to pass v0 as struct or as pointer to fn0?</p>
</blockquote>
<p>I meant to pass it as a ptr. My real code actually is storing sarg into an explicit stack, where I pass the stack addr into the function, and read the ptr out of it. But it appears to be the same effect either way.</p>
<p>fn0 has this signature:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"fastcall"</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">__jit_cb</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">Data</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Ret</span><span class="p">)</span>
</code></pre></div>
<p>My bad for not providing the code. My quick test case is this. I replaced <code>ret</code> with my JITted fn (<code>funcid1</code>) and I'm doing a test call using <code>get_ret()</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(Debug)]</span>
<span class="cp">#[repr(C)]</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">TestStruct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">one</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="n">two</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="n">three</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="n">four</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[inline(never)]</span>
<span class="k">extern</span><span class="w"> </span><span class="s">"fastcall"</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">ret</span><span class="p">(</span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="nc">TestStruct</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">TestStruct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"ret() got {data:?}"</span><span class="p">);</span>
<span class="w">    </span><span class="n">data</span>
<span class="p">}</span>

<span class="cp">#[inline(never)]</span>
<span class="k">extern</span><span class="w"> </span><span class="s">"fastcall"</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">get_ret</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestStruct</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">one</span><span class="p">:</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span>
<span class="w">        </span><span class="n">two</span><span class="p">:</span><span class="w"> </span><span class="mi">44</span><span class="p">,</span>
<span class="w">        </span><span class="n">three</span><span class="p">:</span><span class="w"> </span><span class="mi">55</span><span class="p">,</span>
<span class="w">        </span><span class="n">four</span><span class="p">:</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"get_ret() got: {data:?}"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>



<a name="445224554"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20How%20to%20properly%20use%20ArgumentPurpose%3A%3AStructArgument%3F/near/445224554" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20How.20to.20properly.20use.20ArgumentPurpose.3A.3AStructArgument.3F.html#445224554">(Jun 17 2024 at 21:02)</a>:</h4>
<p>What is the definition of the function you called from the jitted function?</p>



<a name="445224592"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20How%20to%20properly%20use%20ArgumentPurpose%3A%3AStructArgument%3F/near/445224592" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20How.20to.20properly.20use.20ArgumentPurpose.3A.3AStructArgument.3F.html#445224592">(Jun 17 2024 at 21:02)</a>:</h4>
<p>on llvm, sret arguments generally have to be the first argument, cranelift is most likely the same. you have your sret argument as the second argument</p>



<a name="445224827"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20How%20to%20properly%20use%20ArgumentPurpose%3A%3AStructArgument%3F/near/445224827" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20How.20to.20properly.20use.20ArgumentPurpose.3A.3AStructArgument.3F.html#445224827">(Jun 17 2024 at 21:03)</a>:</h4>
<p>Right, of course. Cranelift indeed requires it to be first. Probably should add a verifier check for that.</p>



<a name="445224940"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20How%20to%20properly%20use%20ArgumentPurpose%3A%3AStructArgument%3F/near/445224940" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cherry <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20How.20to.20properly.20use.20ArgumentPurpose.3A.3AStructArgument.3F.html#445224940">(Jun 17 2024 at 21:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="315881">Jacob Lifshay</span> <a href="#narrow/stream/217117-cranelift/topic/How.20to.20properly.20use.20ArgumentPurpose.3A.3AStructArgument.3F/near/445224592">said</a>:</p>
<blockquote>
<p>on llvm, sret arguments generally have to be the first argument, cranelift is most likely the same. you have your sret argument as the second argument</p>
</blockquote>
<p>Thank you for this tip. I'll go fix my code to place it first and reply back after with the result.</p>



<a name="445228245"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20How%20to%20properly%20use%20ArgumentPurpose%3A%3AStructArgument%3F/near/445228245" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cherry <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20How.20to.20properly.20use.20ArgumentPurpose.3A.3AStructArgument.3F.html#445228245">(Jun 17 2024 at 21:25)</a>:</h4>
<p>Ok, I have this now, but it seems I still have the same issue with needing to offset sarg by 16 to find the data (you can ignore the explicit stack. same effect happens even with passing and using the direct ptr)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">defining</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">funcid1</span><span class="p">:</span><span class="w"> </span><span class="nc">function</span><span class="w"> </span><span class="n">u0</span><span class="p">:</span><span class="mi">1</span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="n">sret</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="n">sarg</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span><span class="w"> </span><span class="n">windows_fastcall</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">align</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span>
<span class="w">    </span><span class="n">sig0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="n">windows_fastcall</span>
<span class="w">    </span><span class="n">fn0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u0</span><span class="p">:</span><span class="mi">0</span><span class="w"> </span><span class="n">sig0</span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">):</span>
<span class="w">    </span><span class="nc">stack_store</span><span class="w"> </span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">ss0</span>
<span class="w">    </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mh">0x023a_d589_0320</span>
<span class="w">    </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_addr</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">ss0</span>
<span class="w">    </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span><span class="p">)</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x023a_d589_0320</span>
<span class="w">    </span><span class="k">return</span>
<span class="p">}</span>
</code></pre></div>



<a name="445231385"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20How%20to%20properly%20use%20ArgumentPurpose%3A%3AStructArgument%3F/near/445231385" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20How.20to.20properly.20use.20ArgumentPurpose.3A.3AStructArgument.3F.html#445231385">(Jun 17 2024 at 21:50)</a>:</h4>
<p>What is the definition of the function being called by the jitter function?</p>



<a name="445233024"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20How%20to%20properly%20use%20ArgumentPurpose%3A%3AStructArgument%3F/near/445233024" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cherry <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20How.20to.20properly.20use.20ArgumentPurpose.3A.3AStructArgument.3F.html#445233024">(Jun 17 2024 at 22:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="264278">bjorn3</span> <a href="#narrow/stream/217117-cranelift/topic/How.20to.20properly.20use.20ArgumentPurpose.3A.3AStructArgument.3F/near/445231385">said</a>:</p>
<blockquote>
<p>What is the definition of the function being called by the jitter function?</p>
</blockquote>
<p>I've simplified the test case. Here is all the info:</p>
<p>I am passing a stack addr in, on which I stored sarg's ptr at offset 0. I read the ptr from the stack address passed in.</p>
<p>The JIT fn is calling this signature. stack address is first ptr <code>args</code><br>
<code>pub extern "fastcall" fn __jit_cb(args: *const (), data: &amp;Data, ret: *mut Ret) {</code><br>
Inside the jit cb, I read the sarg from the stack addr<br>
<code>unsafe { *args.cast::&lt;*const u8&gt;() };</code><br>
I then read bytes from this (32 in this test case) into a Vec with nonoverlapping copy, and finally transmute it back to TestStruct</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span><span class="p">::</span><span class="n">with_capacity</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>

<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ptr</span><span class="p">::</span><span class="n">copy_nonoverlapping</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">(),</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">buffer</span><span class="p">.</span><span class="n">set_len</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p>The ir is here</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">defining</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">funcid1</span><span class="p">:</span><span class="w"> </span><span class="nc">function</span><span class="w"> </span><span class="n">u0</span><span class="p">:</span><span class="mi">1</span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="n">sret</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="n">sarg</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span><span class="w"> </span><span class="n">windows_fastcall</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">align</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span>
<span class="w">    </span><span class="n">sig0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="n">windows_fastcall</span><span class="w"> </span><span class="c1">// &lt;-- __jit_cb</span>
<span class="w">    </span><span class="n">fn0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u0</span><span class="p">:</span><span class="mi">0</span><span class="w"> </span><span class="n">sig0</span><span class="w"> </span><span class="c1">// &lt;-- __jit_cb</span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">):</span>
<span class="w">    </span><span class="nc">stack_store</span><span class="w"> </span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">ss0</span>
<span class="w">    </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mh">0x01af_78a8_0610</span>
<span class="w">    </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_addr</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">ss0</span>
<span class="w">    </span><span class="c1">// *const (), data: &amp;Data, ret: *mut Ret</span>
<span class="w">    </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span><span class="p">)</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x01af_78a8_0610</span>
<span class="w">    </span><span class="k">return</span>
<span class="p">}</span>
</code></pre></div>
<p>After I generate the JIT fn, I set the resulting fn ptr on the static and call <code>get_ret()</code> which calls the JIT fn</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(Debug)]</span>
<span class="cp">#[repr(C)]</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">TestStruct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">one</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="n">two</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="n">three</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="n">four</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1">// funcid1 below</span>
<span class="k">static</span><span class="w"> </span><span class="n">TEST_FN</span><span class="p">:</span><span class="w"> </span><span class="nc">OnceLock</span><span class="o">&lt;</span><span class="k">extern</span><span class="w"> </span><span class="s">"fastcall"</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="n">TestStruct</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">TestStruct</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OnceLock</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>

<span class="cp">#[inline(never)]</span>
<span class="k">extern</span><span class="w"> </span><span class="s">"fastcall"</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">get_ret</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestStruct</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">one</span><span class="p">:</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span>
<span class="w">        </span><span class="n">two</span><span class="p">:</span><span class="w"> </span><span class="mi">44</span><span class="p">,</span>
<span class="w">        </span><span class="n">three</span><span class="p">:</span><span class="w"> </span><span class="mi">55</span><span class="p">,</span>
<span class="w">        </span><span class="n">four</span><span class="p">:</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TEST_FN</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()(</span><span class="n">data</span><span class="p">);</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"get_ret() got: {data:?}"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>My output is as follows. The TEST_FN is simply reading sargs bytes and returning them in sret, nothing fancy</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">get_ret</span><span class="p">()</span><span class="w"> </span><span class="n">got</span><span class="p">:</span><span class="w"> </span><span class="nc">TestStruct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">one</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">two</span><span class="p">:</span><span class="w"> </span><span class="mi">1853154559352</span><span class="p">,</span><span class="w"> </span><span class="n">three</span><span class="p">:</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span><span class="w"> </span><span class="n">four</span><span class="p">:</span><span class="w"> </span><span class="mi">44</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>



<a name="445251878"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20How%20to%20properly%20use%20ArgumentPurpose%3A%3AStructArgument%3F/near/445251878" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cherry <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20How.20to.20properly.20use.20ArgumentPurpose.3A.3AStructArgument.3F.html#445251878">(Jun 18 2024 at 01:04)</a>:</h4>
<p>I made a reduced test case here (run it on Win x64)<br>
<a href="https://github.com/MolotovCherry/cranelift-misalignment">https://github.com/MolotovCherry/cranelift-misalignment</a></p>
<p>After making this as simple as I can and still seeing it, I have no idea what to do anymore to solve this. If this really is something I'm doing wrong, I hope someone can point it out</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">defining</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">funcid1</span><span class="p">:</span><span class="w"> </span><span class="nc">function</span><span class="w"> </span><span class="n">u0</span><span class="p">:</span><span class="mi">1</span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="n">sret</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="n">sarg</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span><span class="w"> </span><span class="n">windows_fastcall</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">sig0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="n">sret</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="n">sarg</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span><span class="w"> </span><span class="n">windows_fastcall</span>
<span class="w">    </span><span class="n">fn0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u0</span><span class="p">:</span><span class="mi">0</span><span class="w"> </span><span class="n">sig0</span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">):</span>
<span class="w">    </span><span class="nc">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span>
<span class="p">}</span>

<span class="c1">// I passed in</span>
<span class="c1">//  TestStruct {</span>
<span class="c1">//     one: 22,</span>
<span class="c1">//     two: 44,</span>
<span class="c1">//     three: 55,</span>
<span class="c1">//     four: 57,</span>
<span class="c1">//  }</span>
<span class="n">cb</span><span class="w"> </span><span class="n">got</span><span class="w"> </span><span class="n">TestStruct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">one</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">two</span><span class="p">:</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span><span class="w"> </span><span class="n">three</span><span class="p">:</span><span class="w"> </span><span class="mi">44</span><span class="p">,</span><span class="w"> </span><span class="n">four</span><span class="p">:</span><span class="w"> </span><span class="mi">55</span><span class="w"> </span><span class="p">}</span>
<span class="n">get_ret</span><span class="w"> </span><span class="n">got</span><span class="p">:</span><span class="w"> </span><span class="nc">TestStruct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">one</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">two</span><span class="p">:</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span><span class="w"> </span><span class="n">three</span><span class="p">:</span><span class="w"> </span><span class="mi">44</span><span class="p">,</span><span class="w"> </span><span class="n">four</span><span class="p">:</span><span class="w"> </span><span class="mi">55</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/MolotovCherry/cranelift-misalignment" style="background-image: url(&quot;https://uploads.zulipusercontent.net/88953abd4e2d52cc86f8e3acd7d7dfd362bc4a3a/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f653134346133663631656466353533653830356661623861303031643761343965356532636135643430333134393563383233356636393261333134343866632f4d6f6c6f746f764368657272792f6372616e656c6966742d6d6973616c69676e6d656e74&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/MolotovCherry/cranelift-misalignment" title="GitHub - MolotovCherry/cranelift-misalignment">GitHub - MolotovCherry/cranelift-misalignment</a></div><div class="message_embed_description">Contribute to MolotovCherry/cranelift-misalignment development by creating an account on GitHub.</div></div></div>



<a name="445306067"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20How%20to%20properly%20use%20ArgumentPurpose%3A%3AStructArgument%3F/near/445306067" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20How.20to.20properly.20use.20ArgumentPurpose.3A.3AStructArgument.3F.html#445306067">(Jun 18 2024 at 08:57)</a>:</h4>
<p>Looks like for the windows calling convention structs larger than 64bits are passed by-reference rather than at a fixed stack offset. In other words you have to omit the <code>sarg</code> attribute.</p>
<p>See <a href="https://github.com/rust-lang/rust/blob/737e42308c6e957575692965d73b17937f936f28/compiler/rustc_target/src/abi/call/x86_win64.rs#L8-L28">https://github.com/rust-lang/rust/blob/737e42308c6e957575692965d73b17937f936f28/compiler/rustc_target/src/abi/call/x86_win64.rs#L8-L28</a> for how to calculate the right ABI.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/rust-lang/rust/blob/737e42308c6e957575692965d73b17937f936f28/compiler/rustc_target/src/abi/call/x86_win64.rs#L8-L28" style="background-image: url(&quot;https://uploads.zulipusercontent.net/938869cb0e1e7fe06aa364a31446b58ddecf5c92/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f316163656634663461386466363063343431643333333938336531366334623533303963386266333332326539383864623161623334643634393161646366372f727573742d6c616e672f72757374&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/rust-lang/rust/blob/737e42308c6e957575692965d73b17937f936f28/compiler/rustc_target/src/abi/call/x86_win64.rs#L8-L28" title="rust/compiler/rustc_target/src/abi/call/x86_win64.rs at 737e42308c6e957575692965d73b17937f936f28 · rust-lang/rust">rust/compiler/rustc_target/src/abi/call/x86_win64.rs at 737e42308c6e957575692965d73b17937f936f28 · rust-lang/rust</a></div><div class="message_embed_description">Empowering everyone to build reliable and efficient software. - rust-lang/rust</div></div></div>



<a name="445306388"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20How%20to%20properly%20use%20ArgumentPurpose%3A%3AStructArgument%3F/near/445306388" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20How.20to.20properly.20use.20ArgumentPurpose.3A.3AStructArgument.3F.html#445306388">(Jun 18 2024 at 08:59)</a>:</h4>
<p>You have to pass a pointer when <code>arg.make_indirect()</code> is used and <code>sarg</code> when <code>arg.make_indirect_byval(align)</code> is used.</p>



<a name="445306768"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20How%20to%20properly%20use%20ArgumentPurpose%3A%3AStructArgument%3F/near/445306768" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20How.20to.20properly.20use.20ArgumentPurpose.3A.3AStructArgument.3F.html#445306768">(Jun 18 2024 at 09:00)</a>:</h4>
<p>Just like LLVM, Cranelift only handles the lower half of the calling convention. The upper half which lowers C types is required to be implemented by the frontend. You can find the rust implementations of this for various architectures at <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_target/src/abi/call">https://github.com/rust-lang/rust/blob/master/compiler/rustc_target/src/abi/call</a> This code is shared by the LLVM, GCC and Cranelift backends of rustc.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_target/src/abi/call" style="background-image: url(&quot;https://uploads.zulipusercontent.net/938869cb0e1e7fe06aa364a31446b58ddecf5c92/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f316163656634663461386466363063343431643333333938336531366334623533303963386266333332326539383864623161623334643634393161646366372f727573742d6c616e672f72757374&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_target/src/abi/call" title="rust/compiler/rustc_target/src/abi/call at master · rust-lang/rust">rust/compiler/rustc_target/src/abi/call at master · rust-lang/rust</a></div><div class="message_embed_description">Empowering everyone to build reliable and efficient software. - rust-lang/rust</div></div></div>



<a name="445404126"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20How%20to%20properly%20use%20ArgumentPurpose%3A%3AStructArgument%3F/near/445404126" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cherry <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20How.20to.20properly.20use.20ArgumentPurpose.3A.3AStructArgument.3F.html#445404126">(Jun 18 2024 at 16:19)</a>:</h4>
<p>Thanks! That was just the info I needed. I guess in the end we can use I8,I16,I32,I64 for bits of 1,2,4,8, where odd ones and not power of 2 ones and &gt; 8 ones are an I64 to a ptr of the respective size. Seems to work properly now!</p>



<a name="445406407"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20How%20to%20properly%20use%20ArgumentPurpose%3A%3AStructArgument%3F/near/445406407" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20How.20to.20properly.20use.20ArgumentPurpose.3A.3AStructArgument.3F.html#445406407">(Jun 18 2024 at 16:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="702818">Cherry</span> has marked this topic as resolved.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>