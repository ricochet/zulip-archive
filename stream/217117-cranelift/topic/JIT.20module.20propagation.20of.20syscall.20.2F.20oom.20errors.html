<html>
<head><meta charset="utf-8"><title>JIT module propagation of syscall / oom errors · cranelift · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/index.html">cranelift</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/JIT.20module.20propagation.20of.20syscall.20.2F.20oom.20errors.html">JIT module propagation of syscall / oom errors</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="307353304"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/JIT%20module%20propagation%20of%20syscall%20/%20oom%20errors/near/307353304" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Evan Thompson <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/JIT.20module.20propagation.20of.20syscall.20.2F.20oom.20errors.html#307353304">(Nov 01 2022 at 16:36)</a>:</h4>
<p>Hey folks, when starting to use the JIT module, I noticed there are a number of places where it <code>expects</code> or <code>panics</code> on syscall errors, for example <a href="https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/jit/src/memory.rs#L193">this panic</a> on <code>mprotect</code> or <a href="https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/jit/src/backend.rs#L691">this one</a> during function allocation.</p>
<p>I’d like to update these to propagate the errors onward instead, as just crashing can be a nasty source of correlated failure in distributed systems, eg in Linux if the <code>vm.max_map_count</code> for the process is mistakenly configured too low, you would see correlated panics when each node tries to <code>mmap</code> or <code>mprotect</code> one too many times</p>
<p>Doing so would involve updating some apis like <a href="https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/jit/src/memory.rs#L171">set_readable_and_executable</a> and <a href="https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/jit/src/backend.rs#L430">finalize_definitions</a> to return Result types and let the caller handle the error (probably initially by just unwrapping, punting the issue upward a few layers)</p>
<p>How stable are the JIT module apis, is it generally OK to update them in this manner?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/jit/src/memory.rs#L193" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/3dd878c9fd09caaa36ab6a25e8ba54e23dde4b2b\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f316132333362336138653864336134343564386138303533343136376233366230396638343831393162353537346665363537633633366238666131373338632f62797465636f6465616c6c69616e63652f7761736d74696d65)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/jit/src/memory.rs#L193" title="wasmtime/memory.rs at main · bytecodealliance/wasmtime">wasmtime/memory.rs at main · bytecodealliance/wasmtime</a></div><div class="message_embed_description">A fast and secure runtime for WebAssembly. Contribute to bytecodealliance/wasmtime development by creating an account on GitHub.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/jit/src/backend.rs#L691" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/3dd878c9fd09caaa36ab6a25e8ba54e23dde4b2b\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f316132333362336138653864336134343564386138303533343136376233366230396638343831393162353537346665363537633633366238666131373338632f62797465636f6465616c6c69616e63652f7761736d74696d65)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/jit/src/backend.rs#L691" title="wasmtime/backend.rs at main · bytecodealliance/wasmtime">wasmtime/backend.rs at main · bytecodealliance/wasmtime</a></div><div class="message_embed_description">A fast and secure runtime for WebAssembly. Contribute to bytecodealliance/wasmtime development by creating an account on GitHub.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/jit/src/memory.rs#L171" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/3dd878c9fd09caaa36ab6a25e8ba54e23dde4b2b\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f316132333362336138653864336134343564386138303533343136376233366230396638343831393162353537346665363537633633366238666131373338632f62797465636f6465616c6c69616e63652f7761736d74696d65)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/jit/src/memory.rs#L171" title="wasmtime/memory.rs at main · bytecodealliance/wasmtime">wasmtime/memory.rs at main · bytecodealliance/wasmtime</a></div><div class="message_embed_description">A fast and secure runtime for WebAssembly. Contribute to bytecodealliance/wasmtime development by creating an account on GitHub.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/jit/src/backend.rs#L430" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/3dd878c9fd09caaa36ab6a25e8ba54e23dde4b2b\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f316132333362336138653864336134343564386138303533343136376233366230396638343831393162353537346665363537633633366238666131373338632f62797465636f6465616c6c69616e63652f7761736d74696d65)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/jit/src/backend.rs#L430" title="wasmtime/backend.rs at main · bytecodealliance/wasmtime">wasmtime/backend.rs at main · bytecodealliance/wasmtime</a></div><div class="message_embed_description">A fast and secure runtime for WebAssembly. Contribute to bytecodealliance/wasmtime development by creating an account on GitHub.</div></div></div>



<a name="307375667"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/JIT%20module%20propagation%20of%20syscall%20/%20oom%20errors/near/307375667" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/JIT.20module.20propagation.20of.20syscall.20.2F.20oom.20errors.html#307375667">(Nov 01 2022 at 18:19)</a>:</h4>
<p>I would expect this to be an OK refactoring; <span class="user-mention" data-user-id="264278">@bjorn3</span> might have more opinions.</p>



<a name="307376410"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/JIT%20module%20propagation%20of%20syscall%20/%20oom%20errors/near/307376410" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/JIT.20module.20propagation.20of.20syscall.20.2F.20oom.20errors.html#307376410">(Nov 01 2022 at 18:23)</a>:</h4>
<p>Returning errors would be fine, however be sure to ensure that all invariants are upheld even if an error is returned. For example if you want to remove the expects in <code>finalize_definitions</code> (which I don't think you should as they are programmer errors, not environment errors) you have to put back all not yet processed functions or data objects to finalize.</p>



<a name="307379953"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/JIT%20module%20propagation%20of%20syscall%20/%20oom%20errors/near/307379953" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Evan Thompson <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/JIT.20module.20propagation.20of.20syscall.20.2F.20oom.20errors.html#307379953">(Nov 01 2022 at 18:41)</a>:</h4>
<p>Thanks! I wasn't planning to remove the existing <code>expects</code> (for function and data object compilation) from <code>finalize_definitions</code>, but I was planning to add some new error handling. For example, <code>finalize_definitions</code> calls <code>self.memory.code.set_readable_and_executable</code> which is really a wrapper around syscalls like <code>mprotect</code>, which can fail for a variety of reasons not programmer-error-related</p>



<a name="307404133"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/JIT%20module%20propagation%20of%20syscall%20/%20oom%20errors/near/307404133" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/JIT.20module.20propagation.20of.20syscall.20.2F.20oom.20errors.html#307404133">(Nov 01 2022 at 21:10)</a>:</h4>
<p>Yeah, those are totally reasonable to turn into Result returning functions.</p>



<a name="307404309"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/JIT%20module%20propagation%20of%20syscall%20/%20oom%20errors/near/307404309" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/JIT.20module.20propagation.20of.20syscall.20.2F.20oom.20errors.html#307404309">(Nov 01 2022 at 21:12)</a>:</h4>
<p>You should however probably ensure that if mprotect fails that the respective memory region is not marked as having been made read+execute in the state of <code>self.memory.code</code>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>