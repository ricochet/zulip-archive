<html>
<head><meta charset="utf-8"><title>✔ Tricks with linkage internal / module external functions? · cranelift · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/index.html">cranelift</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Tricks.20with.20linkage.20internal.20.2F.20module.20external.20functions.3F.html">✔ Tricks with linkage internal / module external functions?</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="319840256"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Tricks%20with%20linkage%20internal%20/%20module%20external%20functions%3F/near/319840256" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adam Wick <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Tricks.20with.20linkage.20internal.20.2F.20module.20external.20functions.3F.html#319840256">(Jan 06 2023 at 18:45)</a>:</h4>
<p>Are there any tricks to declaring functions that are internal to the total linkage unit, but external to the current module? In particular, I'm trying to define a reference to a function that I'm going to declare in a different object file, but link statically.</p>
<p>It looks like cranelift is emitting full dynamic library calls / relocation info no matter what I do (I've tried declaring with Linkage::Import, and Linkage::Preemptible with a fake body), which gets me a linker warning on Linux and a bus error on MacOS.</p>
<p>Since the MacOS error is slightly more illuminating, I'll say that it pops up in dyld:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">lldb</span><span class="p">)</span><span class="w"> </span><span class="n">bt</span><span class="w"></span>
<span class="o">*</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span>#<span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">stop</span><span class="w"> </span><span class="n">reason</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EXC_BAD_ACCESS</span><span class="w"> </span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="o">=</span><span class="mh">0x100003f50</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span>#<span class="mi">0</span>: <span class="mh">0x00000001b096eb7c</span><span class="w"> </span><span class="n">dyld</span><span class="err">`</span><span class="n">dyld4</span>::<span class="n">fixupPage64</span><span class="p">(</span><span class="n">void</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">mwl_info_hdr</span><span class="w"> </span><span class="k">const</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">dyld_chained_starts_in_segment</span><span class="w"> </span><span class="k">const</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="n">int</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">132</span><span class="w"></span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span>#<span class="mi">1</span>: <span class="mh">0x00000001b096e924</span><span class="w"> </span><span class="n">dyld</span><span class="err">`</span><span class="n">dyld4</span>::<span class="n">dyld_map_with_linking_np</span><span class="p">(</span><span class="n">mwl_region</span><span class="w"> </span><span class="k">const</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="n">int</span><span class="p">,</span><span class="w"> </span><span class="n">mwl_info_hdr</span><span class="w"> </span><span class="k">const</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="n">int</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">528</span><span class="w"></span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span>#<span class="mi">2</span>: <span class="mh">0x00000001b096adc8</span><span class="w"> </span><span class="n">dyld</span><span class="err">`</span><span class="n">dyld4</span>::<span class="n">setUpPageInLinkingRegions</span><span class="p">(</span><span class="n">dyld4</span>::<span class="n">RuntimeState</span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="n">dyld4</span>::<span class="n">Loader</span><span class="w"> </span><span class="k">const</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="n">long</span><span class="p">,</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="n">short</span><span class="p">,</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="n">short</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="n">dyld3</span>::<span class="n">Array</span><span class="o">&lt;</span><span class="n">dyld4</span>::<span class="n">PageInLinkingRange</span><span class="o">&gt;</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="n">dyld3</span>::<span class="n">Array</span><span class="o">&lt;</span><span class="n">void</span><span class="w"> </span><span class="k">const</span><span class="o">*&gt;</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">832</span><span class="w"></span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span>#<span class="mi">3</span>: <span class="mh">0x00000001b096a718</span><span class="w"> </span><span class="n">dyld</span><span class="err">`</span><span class="n">invocation</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">dyld4</span>::<span class="n">Loader</span>::<span class="n">setUpPageInLinking</span><span class="p">(</span><span class="n">Diagnostics</span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="n">dyld4</span>::<span class="n">RuntimeState</span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="n">long</span><span class="p">,</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="n">long</span><span class="w"> </span><span class="n">long</span><span class="p">,</span><span class="w"> </span><span class="n">dyld3</span>::<span class="n">Array</span><span class="o">&lt;</span><span class="n">void</span><span class="w"> </span><span class="k">const</span><span class="o">*&gt;</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">380</span><span class="w"></span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span>#<span class="mi">4</span>: <span class="mh">0x00000001b096a48c</span><span class="w"> </span><span class="n">dyld</span><span class="err">`</span><span class="n">dyld4</span>::<span class="n">Loader</span>::<span class="n">setUpPageInLinking</span><span class="p">(</span><span class="n">Diagnostics</span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="n">dyld4</span>::<span class="n">RuntimeState</span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="n">long</span><span class="p">,</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="n">long</span><span class="w"> </span><span class="n">long</span><span class="p">,</span><span class="w"> </span><span class="n">dyld3</span>::<span class="n">Array</span><span class="o">&lt;</span><span class="n">void</span><span class="w"> </span><span class="k">const</span><span class="o">*&gt;</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">536</span><span class="w"></span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span>#<span class="mi">5</span>: <span class="mh">0x00000001b096af10</span><span class="w"> </span><span class="n">dyld</span><span class="err">`</span><span class="n">dyld4</span>::<span class="n">Loader</span>::<span class="n">applyFixupsGeneric</span><span class="p">(</span><span class="n">Diagnostics</span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="n">dyld4</span>::<span class="n">RuntimeState</span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="n">long</span><span class="w"> </span><span class="n">long</span><span class="p">,</span><span class="w"> </span><span class="n">dyld3</span>::<span class="n">Array</span><span class="o">&lt;</span><span class="n">void</span><span class="w"> </span><span class="k">const</span><span class="o">*&gt;</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="n">dyld3</span>::<span class="n">Array</span><span class="o">&lt;</span><span class="n">void</span><span class="w"> </span><span class="k">const</span><span class="o">*&gt;</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="n">dyld3</span>::<span class="n">Array</span><span class="o">&lt;</span><span class="n">dyld4</span>::<span class="n">Loader</span>::<span class="n">MissingFlatLazySymbol</span><span class="o">&gt;</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">152</span><span class="w"></span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span>#<span class="mi">6</span>: <span class="mh">0x00000001b09709ec</span><span class="w"> </span><span class="n">dyld</span><span class="err">`</span><span class="n">dyld4</span>::<span class="n">JustInTimeLoader</span>::<span class="n">applyFixups</span><span class="p">(</span><span class="n">Diagnostics</span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="n">dyld4</span>::<span class="n">RuntimeState</span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="n">dyld4</span>::<span class="n">DyldCacheDataConstLazyScopedWriter</span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">680</span><span class="w"></span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span>#<span class="mi">7</span>: <span class="mh">0x00000001b09548d0</span><span class="w"> </span><span class="n">dyld</span><span class="err">`</span><span class="n">dyld4</span>::<span class="n">prepare</span><span class="p">(</span><span class="n">dyld4</span>::<span class="n">APIs</span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="n">dyld3</span>::<span class="n">MachOAnalyzer</span><span class="w"> </span><span class="k">const</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2212</span><span class="w"></span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span>#<span class="mi">8</span>: <span class="mh">0x00000001b0953dc4</span><span class="w"> </span><span class="n">dyld</span><span class="err">`</span><span class="n">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2404</span><span class="w"></span>
</code></pre></div>
<p>The fault address (0x100003f50) is where I'd expect the call to be:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">lldb</span><span class="p">)</span><span class="w"> </span><span class="n">disassemble</span><span class="w"> </span><span class="o">-</span><span class="n">n</span><span class="w"> </span><span class="n">gogogo</span><span class="w"></span>
<span class="n">test</span><span class="err">`</span><span class="n">gogogo</span>:
    <span class="mh">0x100003f40</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">0</span><span class="o">&gt;</span>:  <span class="nc">stp</span><span class="w">    </span><span class="n">x29</span><span class="p">,</span><span class="w"> </span><span class="n">x30</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">sp</span><span class="p">,</span><span class="w"> </span>#<span class="o">-</span><span class="mh">0x10</span><span class="p">]</span><span class="o">!</span><span class="w"></span>
<span class="w">    </span><span class="mh">0x100003f44</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">4</span><span class="o">&gt;</span>:  <span class="nc">mov</span><span class="w">    </span><span class="n">x29</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="w"></span>
<span class="w">    </span><span class="mh">0x100003f48</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">8</span><span class="o">&gt;</span>:  <span class="nc">ldr</span><span class="w">    </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span>#<span class="mh">0x8</span><span class="w">                  </span><span class="p">;</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">16</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="mh">0x100003f4c</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">12</span><span class="o">&gt;</span>: <span class="nc">b</span><span class="w">      </span><span class="mh">0x100003f58</span><span class="w">               </span><span class="p">;</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">24</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="mh">0x100003f50</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">16</span><span class="o">&gt;</span>: <span class="nc">udf</span><span class="w">    </span>#<span class="mh">0x3f91</span><span class="w"></span>
<span class="w">    </span><span class="mh">0x100003f54</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">20</span><span class="o">&gt;</span>: <span class="p">.</span><span class="n">long</span><span class="w">  </span><span class="mh">0x00280000</span><span class="w">                </span><span class="p">;</span><span class="w"> </span><span class="n">unknown</span><span class="w"> </span><span class="n">opcode</span><span class="w"></span>
<span class="w">    </span><span class="mh">0x100003f58</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">24</span><span class="o">&gt;</span>: <span class="nc">mov</span><span class="w">    </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span>#<span class="mh">0x4</span><span class="w"></span>
<span class="w">    </span><span class="mh">0x100003f5c</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">28</span><span class="o">&gt;</span>: <span class="nc">ldr</span><span class="w">    </span><span class="n">x3</span><span class="p">,</span><span class="w"> </span>#<span class="mh">0x8</span><span class="w">                  </span><span class="p">;</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">36</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="mh">0x100003f60</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">32</span><span class="o">&gt;</span>: <span class="nc">b</span><span class="w">      </span><span class="mh">0x100003f6c</span><span class="w">               </span><span class="p">;</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">44</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="mh">0x100003f64</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">36</span><span class="o">&gt;</span>: <span class="nc">udf</span><span class="w">    </span>#<span class="mh">0x3e80</span><span class="w"></span>
<span class="w">    </span><span class="mh">0x100003f68</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">40</span><span class="o">&gt;</span>: <span class="nc">udf</span><span class="w">    </span>#<span class="mh">0x0</span><span class="w"></span>
<span class="w">    </span><span class="mh">0x100003f6c</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">44</span><span class="o">&gt;</span>: <span class="nc">blr</span><span class="w">    </span><span class="n">x3</span><span class="w"></span>
<span class="w">    </span><span class="mh">0x100003f70</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">48</span><span class="o">&gt;</span>: <span class="nc">ldp</span><span class="w">    </span><span class="n">x29</span><span class="p">,</span><span class="w"> </span><span class="n">x30</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">sp</span><span class="p">],</span><span class="w"> </span>#<span class="mh">0x10</span><span class="w"></span>
<span class="w">    </span><span class="mh">0x100003f74</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">52</span><span class="o">&gt;</span>: <span class="nc">ret</span><span class="w"></span>
</code></pre></div>
<p>I'm going to assume that the bus error is a write to read-only memory. (Although I'm curious what it would've written.) Also, for reference, the warning I get on Linux is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ld</span>: <span class="nc">output</span><span class="p">.</span><span class="n">o</span>: <span class="nc">warning</span>: <span class="nc">relocation</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">read</span><span class="o">-</span><span class="n">only</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="err">`</span><span class="p">.</span><span class="n">text</span><span class="o">'</span><span class="w"></span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ld</span>: <span class="nc">warning</span>: <span class="nc">creating</span><span class="w"> </span><span class="n">DT_TEXTREL</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">PIE</span><span class="w"></span>
</code></pre></div>
<p>Although the resultant binary does run.</p>
<p>This is a "simplified" version of what I'm running: <a href="https://github.com/acw/cranelift-hmmm">https://github.com/acw/cranelift-hmmm</a><br>
(<code>makedo.sh</code> will get you direct to <code>lldb</code>)</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/acw/cranelift-hmmm" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/0af0bae493aa7d67e68861b36a26563ae9ed8316\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f623161313065656530306631623637353438663031373531353831643336356563323739366237613232633532353431333062353634643536303739393036312f6163772f6372616e656c6966742d686d6d6d)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/acw/cranelift-hmmm" title="GitHub - acw/cranelift-hmmm: a cranelift example">GitHub - acw/cranelift-hmmm: a cranelift example</a></div><div class="message_embed_description">a cranelift example. Contribute to acw/cranelift-hmmm development by creating an account on GitHub.</div></div></div>



<a name="319841631"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Tricks%20with%20linkage%20internal%20/%20module%20external%20functions%3F/near/319841631" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Tricks.20with.20linkage.20internal.20.2F.20module.20external.20functions.3F.html#319841631">(Jan 06 2023 at 18:53)</a>:</h4>
<p>Try setting the is_pic flag when creating the target isa.</p>



<a name="319842440"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Tricks%20with%20linkage%20internal%20/%20module%20external%20functions%3F/near/319842440" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Tricks.20with.20linkage.20internal.20.2F.20module.20external.20functions.3F.html#319842440">(Jan 06 2023 at 18:57)</a>:</h4>
<blockquote>
<p>Are there any tricks to declaring functions that are internal to the total linkage unit, but external to the current module? </p>
</blockquote>
<p>Hidden visibility is not yet supported, but for PIE executables that shouldn't matter with respect to relocations as in PIE executables everything is handled as if the protected visibility is used, which prevents overriding of symbols by other DSO's. The problem here is that non-position independent code can't be linked into a position independent executable, so you need to tell cranelift to build position independent code using is_pic.</p>



<a name="319845230"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Tricks%20with%20linkage%20internal%20/%20module%20external%20functions%3F/near/319845230" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adam Wick <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Tricks.20with.20linkage.20internal.20.2F.20module.20external.20functions.3F.html#319845230">(Jan 06 2023 at 19:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="264278">bjorn3</span> <a href="#narrow/stream/217117-cranelift/topic/Tricks.20with.20linkage.20internal.20.2F.20module.20external.20functions.3F/near/319841631">said</a>:</p>
<blockquote>
<p>Try setting the is_pic flag when creating the target isa.</p>
</blockquote>
<p>Interesting. That seems to fix the linker warning on Linux, but doesn't fix the bus error on macOS.</p>
<p><a href="https://github.com/acw/cranelift-hmmm/commit/017c46bd119390b7f08fab3913a2daf5ed56ed50">Diff for reference</a>.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/acw/cranelift-hmmm/commit/017c46bd119390b7f08fab3913a2daf5ed56ed50" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/e6fabcdace1e64d065872398f1be4ad33976cda2\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f386566663733346362396364303961386138653938303165656236613037363938636563343939333465643065366131656636353238303633613137646134302f6163772f6372616e656c6966742d686d6d6d2f636f6d6d69742f30313763343662643131393339306237663038666162333931336132646166356564353665643530)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/acw/cranelift-hmmm/commit/017c46bd119390b7f08fab3913a2daf5ed56ed50" title="Try adding is_pic · acw/cranelift-hmmm@017c46b">Try adding is_pic · acw/cranelift-hmmm@017c46b</a></div><div class="message_embed_description">a cranelift example. Contribute to acw/cranelift-hmmm development by creating an account on GitHub.</div></div></div>



<a name="319848529"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Tricks%20with%20linkage%20internal%20/%20module%20external%20functions%3F/near/319848529" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Tricks.20with.20linkage.20internal.20.2F.20module.20external.20functions.3F.html#319848529">(Jan 06 2023 at 19:33)</a>:</h4>
<p>Can you show the output of <code>objdump -dr output.o</code> on macOS?</p>



<a name="319848693"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Tricks%20with%20linkage%20internal%20/%20module%20external%20functions%3F/near/319848693" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Tricks.20with.20linkage.20internal.20.2F.20module.20external.20functions.3F.html#319848693">(Jan 06 2023 at 19:34)</a>:</h4>
<p>(arguments may be slightly different on macOS. basically I want a disassembly (<code>-d</code>) with relocations (<code>-r</code>))</p>



<a name="319851168"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Tricks%20with%20linkage%20internal%20/%20module%20external%20functions%3F/near/319851168" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adam Wick <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Tricks.20with.20linkage.20internal.20.2F.20module.20external.20functions.3F.html#319851168">(Jan 06 2023 at 19:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="264278">bjorn3</span> <a href="#narrow/stream/217117-cranelift/topic/Tricks.20with.20linkage.20internal.20.2F.20module.20external.20functions.3F/near/319848529">said</a>:</p>
<blockquote>
<p>Can you show the output of <code>objdump -dr output.o</code> on macOS?</p>
</blockquote>
<p>Oh, interesting:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">%</span><span class="w"> </span><span class="n">objdump</span><span class="w"> </span><span class="o">-</span><span class="n">dr</span><span class="w"> </span><span class="n">output</span><span class="p">.</span><span class="n">o</span><span class="w"></span>

<span class="n">output</span><span class="p">.</span><span class="n">o</span>:       <span class="nc">file</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">mach</span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">arm64</span><span class="w"></span>

<span class="n">Disassembly</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="n">__TEXT</span><span class="p">,</span><span class="n">__text</span>:

<span class="mi">0000000000000020</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_gogogo</span><span class="o">&gt;</span>:
      <span class="mi">20</span>: <span class="nc">fd</span><span class="w"> </span><span class="mi">7</span><span class="n">b</span><span class="w"> </span><span class="n">bf</span><span class="w"> </span><span class="n">a9</span><span class="w">   </span><span class="n">stp</span><span class="w">     </span><span class="n">x29</span><span class="p">,</span><span class="w"> </span><span class="n">x30</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">sp</span><span class="p">,</span><span class="w"> </span>#<span class="o">-</span><span class="mi">16</span><span class="p">]</span><span class="o">!</span><span class="w"></span>
<span class="w">      </span><span class="mi">24</span>: <span class="nc">fd</span><span class="w"> </span><span class="mi">03</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">91</span><span class="w">   </span><span class="n">mov</span><span class="w">     </span><span class="n">x29</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="w"></span>
<span class="w">      </span><span class="mi">28</span>: <span class="mi">40</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">58</span><span class="w">   </span><span class="n">ldr</span><span class="w">     </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_gogogo</span><span class="o">+</span><span class="mh">0x10</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">      </span><span class="mi">2</span><span class="n">c</span>: <span class="mi">03</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">14</span><span class="w">   </span><span class="n">b</span><span class="w">       </span><span class="mh">0x38</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_gogogo</span><span class="o">+</span><span class="mh">0x18</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">      </span><span class="mi">30</span>: <span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">   </span><span class="n">udf</span><span class="w">     </span>#<span class="mi">0</span><span class="w"></span>
<span class="w">                </span><span class="mi">0000000000000030</span>:  <span class="nc">ARM64_RELOC_UNSIGNED</span><span class="w"> </span><span class="n">_variable</span><span class="o">-</span><span class="n">name</span><span class="o">-</span><span class="n">x</span><span class="w"></span>
<span class="w">      </span><span class="mi">34</span>: <span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">   </span><span class="n">udf</span><span class="w">     </span>#<span class="mi">0</span><span class="w"></span>
<span class="w">      </span><span class="mi">38</span>: <span class="mi">81</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="n">d2</span><span class="w">   </span><span class="n">mov</span><span class="w">     </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span>#<span class="mi">4</span><span class="w"></span>
<span class="w">      </span><span class="mi">3</span><span class="n">c</span>: <span class="mi">43</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">58</span><span class="w">   </span><span class="n">ldr</span><span class="w">     </span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="mh">0x44</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_gogogo</span><span class="o">+</span><span class="mh">0x24</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">      </span><span class="mi">40</span>: <span class="mi">03</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">14</span><span class="w">   </span><span class="n">b</span><span class="w">       </span><span class="mh">0x4c</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_gogogo</span><span class="o">+</span><span class="mh">0x2c</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">      </span><span class="mi">44</span>: <span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">   </span><span class="n">udf</span><span class="w">     </span>#<span class="mi">0</span><span class="w"></span>
<span class="w">                </span><span class="mi">0000000000000044</span>:  <span class="nc">ARM64_RELOC_UNSIGNED</span><span class="w"> </span><span class="n">_print</span><span class="w"></span>
<span class="w">      </span><span class="mi">48</span>: <span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">   </span><span class="n">udf</span><span class="w">     </span>#<span class="mi">0</span><span class="w"></span>
<span class="w">      </span><span class="mi">4</span><span class="n">c</span>: <span class="mi">60</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">3</span><span class="n">f</span><span class="w"> </span><span class="n">d6</span><span class="w">   </span><span class="n">blr</span><span class="w">     </span><span class="n">x3</span><span class="w"></span>
<span class="w">      </span><span class="mi">50</span>: <span class="nc">fd</span><span class="w"> </span><span class="mi">7</span><span class="n">b</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="n">a8</span><span class="w">   </span><span class="n">ldp</span><span class="w">     </span><span class="n">x29</span><span class="p">,</span><span class="w"> </span><span class="n">x30</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">sp</span><span class="p">],</span><span class="w"> </span>#<span class="mi">16</span><span class="w"></span>
<span class="w">      </span><span class="mi">54</span>: <span class="nc">c0</span><span class="w"> </span><span class="mi">03</span><span class="w"> </span><span class="mi">5</span><span class="n">f</span><span class="w"> </span><span class="n">d6</span><span class="w">   </span><span class="n">ret</span><span class="w"></span>
</code></pre></div>
<p>looks like the failure is actually do to a relocation from the string I'm declaring? hmmm.</p>



<a name="319872347"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Tricks%20with%20linkage%20internal%20/%20module%20external%20functions%3F/near/319872347" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Tricks.20with.20linkage.20internal.20.2F.20module.20external.20functions.3F.html#319872347">(Jan 06 2023 at 22:15)</a>:</h4>
<p>I think that is just because it is the first relocation. Neither should use an absolute ARM64_RELOC_UNSIGNED relocation (which has to be resolved by the dynamic linker), but instead use a pc relative relocation that gets resolved during linking.</p>



<a name="319872599"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Tricks%20with%20linkage%20internal%20/%20module%20external%20functions%3F/near/319872599" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Tricks.20with.20linkage.20internal.20.2F.20module.20external.20functions.3F.html#319872599">(Jan 06 2023 at 22:16)</a>:</h4>
<p>Could you please double check that you used the is_pic change on macOS too? If you did indeed use it, I don't understand why absolute relocations are used in the text segment.</p>



<a name="319872917"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Tricks%20with%20linkage%20internal%20/%20module%20external%20functions%3F/near/319872917" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Tricks.20with.20linkage.20internal.20.2F.20module.20external.20functions.3F.html#319872917">(Jan 06 2023 at 22:19)</a>:</h4>
<p>Apart from is_pic, my cranelift based backend for rustc doesn't set any flags or anything that could affect what kind of relocations are used, yet it works just fine on macOS.</p>



<a name="319899969"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Tricks%20with%20linkage%20internal%20/%20module%20external%20functions%3F/near/319899969" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adam Wick <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Tricks.20with.20linkage.20internal.20.2F.20module.20external.20functions.3F.html#319899969">(Jan 07 2023 at 03:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="264278">bjorn3</span> <a href="#narrow/stream/217117-cranelift/topic/Tricks.20with.20linkage.20internal.20.2F.20module.20external.20functions.3F/near/319872599">said</a>:</p>
<blockquote>
<p>Could you please double check that you used the is_pic change on macOS too? If you did indeed use it, I don't understand why absolute relocations are used in the text segment.</p>
</blockquote>
<p>Yup, it's set. Ran <code>.set("is_pic", "true")</code> on the builder, and then <code>.is_pic()</code> on the flag returns true afterwards. It appears to be a MacOS thing, specifically, as the Linux build appears to be PC relative in both cases:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">0000000000000000</span><span class="w"> </span><span class="o">&lt;</span><span class="n">gogogo</span><span class="o">&gt;</span>:
   <span class="mi">0</span>:   <span class="mi">55</span><span class="w">                      </span><span class="n">push</span><span class="w">   </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">   </span><span class="mi">1</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">e5</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">   </span><span class="mi">4</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">b</span><span class="w"> </span><span class="mi">3</span><span class="n">d</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="n">mov</span><span class="w">    </span><span class="mh">0x0</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">),</span><span class="o">%</span><span class="n">rdi</span><span class="w">        </span>#<span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">&lt;</span><span class="n">gogogo</span><span class="o">+</span><span class="mh">0xb</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">                        </span><span class="mi">7</span>: <span class="nc">R_X86_64_GOTPCREL</span><span class="w">    </span><span class="n">variable</span><span class="o">-</span><span class="n">name</span><span class="o">-</span><span class="n">x</span><span class="o">-</span><span class="mh">0x4</span><span class="w"></span>
<span class="w">   </span><span class="n">b</span>:   <span class="nc">be</span><span class="w"> </span><span class="mi">04</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="n">mov</span><span class="w">    </span><span class="cp">$</span><span class="mh">0x4</span><span class="p">,</span><span class="o">%</span><span class="n">esi</span><span class="w"></span>
<span class="w">  </span><span class="mi">10</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">b</span><span class="w"> </span><span class="mi">0</span><span class="n">d</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="n">mov</span><span class="w">    </span><span class="mh">0x0</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">),</span><span class="o">%</span><span class="n">rcx</span><span class="w">        </span>#<span class="w"> </span><span class="mi">17</span><span class="w"> </span><span class="o">&lt;</span><span class="n">gogogo</span><span class="o">+</span><span class="mh">0x17</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">                        </span><span class="mi">13</span>: <span class="nc">R_X86_64_GOTPCREL</span><span class="w">   </span><span class="n">print</span><span class="o">-</span><span class="mh">0x4</span><span class="w"></span>
<span class="w">  </span><span class="mi">17</span>:   <span class="nc">ff</span><span class="w"> </span><span class="n">d1</span><span class="w">                   </span><span class="n">call</span><span class="w">   </span><span class="o">*%</span><span class="n">rcx</span><span class="w"></span>
<span class="w">  </span><span class="mi">19</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">ec</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="p">,</span><span class="o">%</span><span class="n">rsp</span><span class="w"></span>
<span class="w">  </span><span class="mi">1</span><span class="n">c</span>:   <span class="mi">5</span><span class="n">d</span><span class="w">                      </span><span class="n">pop</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">  </span><span class="mi">1</span><span class="n">d</span>:   <span class="nc">c3</span><span class="w">                      </span><span class="n">ret</span><span class="w"></span>
</code></pre></div>
<p><a href="https://github.com/acw/cranelift-hmmm/blob/develop/src/main.rs">Full source code that I'm using, if anyone sees anything odd.</a> (Apologies for it being a trace long.)</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/acw/cranelift-hmmm/blob/develop/src/main.rs" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/0af0bae493aa7d67e68861b36a26563ae9ed8316\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f623161313065656530306631623637353438663031373531353831643336356563323739366237613232633532353431333062353634643536303739393036312f6163772f6372616e656c6966742d686d6d6d)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/acw/cranelift-hmmm/blob/develop/src/main.rs" title="cranelift-hmmm/main.rs at develop · acw/cranelift-hmmm">cranelift-hmmm/main.rs at develop · acw/cranelift-hmmm</a></div><div class="message_embed_description">a cranelift example. Contribute to acw/cranelift-hmmm development by creating an account on GitHub.</div></div></div>



<a name="319935643"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Tricks%20with%20linkage%20internal%20/%20module%20external%20functions%3F/near/319935643" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Tricks.20with.20linkage.20internal.20.2F.20module.20external.20functions.3F.html#319935643">(Jan 07 2023 at 10:47)</a>:</h4>
<p>Looks like the AArch64 backend doesn't support emitting pc-relative GOT relocations when trying to get the address of an external symbol.</p>



<a name="319936391"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Tricks%20with%20linkage%20internal%20/%20module%20external%20functions%3F/near/319936391" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Tricks.20with.20linkage.20internal.20.2F.20module.20external.20functions.3F.html#319936391">(Jan 07 2023 at 10:53)</a>:</h4>
<p><span class="user-mention" data-user-id="576957">@Adam Wick</span> Opened <a href="https://github.com/bytecodealliance/wasmtime/issues/5544">https://github.com/bytecodealliance/wasmtime/issues/5544</a>.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/issues/5544" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/99ca6ff25ad13c4b0e40c788a2221c9a5deb9518\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f663166633831353936313963383065316261353237616139633137363264336633356632343665653662346338356439366165316264366561333764366165342f62797465636f6465616c6c69616e63652f7761736d74696d652f6973737565732f35353434)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/issues/5544" title="Cranelift: AArch64 backend uses absolute relocations instead of GOT-relative relocations when using is_pic · Issue #5544 · bytecodealliance/wasmtime">Cranelift: AArch64 backend uses absolute relocations instead of GOT-relative relocations when using is_pic · Issue #5544 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">.clif Test Case Any code which uses global_value or a call to a function not marked as colocated. Steps to Reproduce Compile with is_pic for AArch64 Expected Results Object file has a GOT relocatio...</div></div></div>



<a name="320096302"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Tricks%20with%20linkage%20internal%20/%20module%20external%20functions%3F/near/320096302" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Afonso Bordado <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Tricks.20with.20linkage.20internal.20.2F.20module.20external.20functions.3F.html#320096302">(Jan 08 2023 at 16:37)</a>:</h4>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span>   Hey <span class="user-mention" data-user-id="576957">@Adam Wick</span> ,</p>
<p>I've been working on adding pc relative GOT relocations, could you try your code with <a href="https://github.com/afonso360/wasmtime/tree/aarch64-got">this branch</a> of cranelift and let me know if it works?</p>
<p>I tested it on AArch64 Linux and it seems to work, not sure if we need anything else for MacOS.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/afonso360/wasmtime/tree/aarch64-got" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/d259672f6e7dba0a033e680147257f915a465917\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f313762643363366238666161663564346536393736616637303965356537393065386333363637313561656431643633393030633166613431363731316332362f61666f6e736f3336302f7761736d74696d65)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/afonso360/wasmtime/tree/aarch64-got" title="GitHub - afonso360/wasmtime at aarch64-got">GitHub - afonso360/wasmtime at aarch64-got</a></div><div class="message_embed_description">Standalone JIT-style runtime for WebAssembly, using Cranelift - GitHub - afonso360/wasmtime at aarch64-got</div></div></div>



<a name="320100858"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Tricks%20with%20linkage%20internal%20/%20module%20external%20functions%3F/near/320100858" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Afonso Bordado <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Tricks.20with.20linkage.20internal.20.2F.20module.20external.20functions.3F.html#320100858">(Jan 08 2023 at 17:29)</a>:</h4>
<p>hmm, just noticed I only had implemented the ELF relocations but not the MachO ones, when I added them it now crashes in the object crate</p>



<a name="320103109"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Tricks%20with%20linkage%20internal%20/%20module%20external%20functions%3F/near/320103109" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Afonso Bordado <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Tricks.20with.20linkage.20internal.20.2F.20module.20external.20functions.3F.html#320103109">(Jan 08 2023 at 17:56)</a>:</h4>
<p>It looks like we are in luck and the upstream object crate already supports this! I was able to compile it for MachO and dump it with llvm-objdump after updating it. Let me know if it works for you.</p>



<a name="320535689"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Tricks%20with%20linkage%20internal%20/%20module%20external%20functions%3F/near/320535689" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adam Wick <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Tricks.20with.20linkage.20internal.20.2F.20module.20external.20functions.3F.html#320535689">(Jan 10 2023 at 20:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="410955">Afonso Bordado</span> <a href="#narrow/stream/217117-cranelift/topic/Tricks.20with.20linkage.20internal.20.2F.20module.20external.20functions.3F/near/320103109">said</a>:</p>
<blockquote>
<p>It looks like we are in luck and the upstream object crate already supports this! I was able to compile it for MachO and dump it with llvm-objdump after updating it. Let me know if it works for you.</p>
</blockquote>
<p>Hey, just going to confirm in thread (just in case someone finds this via search) that Afonso's fix in <a href="https://github.com/bytecodealliance/wasmtime/pull/5550">PR 5550</a> resolves this issue.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/5550" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/889f73bc92697319b1b5aa46f20b46bf5e379ba7\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f636534636431363766323432643565666565616235303863393835366631393738343731356332353163623634633937656231663037656166666538373965312f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f35353530)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/5550" title="aarch64: Support GOT Relative relocations in PIC mode by afonso360 · Pull Request #5550 · bytecodealliance/wasmtime">aarch64: Support GOT Relative relocations in PIC mode by afonso360 · Pull Request #5550 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">👋 Hey,
This PR adds support for using the GOT in PIC mode on AArch64. It implements the relocations for both ELF and MachO.
In order to support the MachO relocations we need to update the object cr...</div></div></div>



<a name="320535859"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Tricks%20with%20linkage%20internal%20/%20module%20external%20functions%3F/near/320535859" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Tricks.20with.20linkage.20internal.20.2F.20module.20external.20functions.3F.html#320535859">(Jan 10 2023 at 20:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="576957">Adam Wick</span> has marked this topic as resolved.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>