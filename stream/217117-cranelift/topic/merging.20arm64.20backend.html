<html>
<head><meta charset="utf-8"><title>merging arm64 backend · cranelift · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/index.html">cranelift</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/merging.20arm64.20backend.html">merging arm64 backend</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="193511691"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/merging%20arm64%20backend/near/193511691" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/merging.20arm64.20backend.html#193511691">(Apr 09 2020 at 21:29)</a>:</h4>
<p>Hi all -- I've put together a patch stack to start the review process for the new backend and the ARM64 machine-specific use of it. See <a href="https://github.com/cfallin/wasmtime/tree/arm64-merge" title="https://github.com/cfallin/wasmtime/tree/arm64-merge">https://github.com/cfallin/wasmtime/tree/arm64-merge</a> for the 11 commits. This is a rollup of the ~4 months of work on the <code>arm64</code> side-branch (excluding the incomplete x64 backend). It's ~17KLoC of code.</p>
<p>Questions:</p>
<ol>
<li>
<p>Who wants to review? I recall <span class="user-mention" data-user-id="254083">@Dan Gohman</span> volunteering a few weeks ago; <span class="user-mention" data-user-id="254393">@Benjamin Bouvier</span> and <span class="user-mention" data-user-id="268444">@Julian Seward</span> and I also are happy to review each others' code (i.e., code we didn't write), if others are fine with that.</p>
</li>
<li>
<p>Would it be better to do this in a single PR, keeping the 11-commit stack just to ease review partitioning, or submit a dependent chain of 11 PRs?</p>
</li>
</ol>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/cfallin/wasmtime/tree/arm64-merge" style="background-image: url(https://avatars2.githubusercontent.com/u/216148?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/cfallin/wasmtime/tree/arm64-merge" title="cfallin/wasmtime">cfallin/wasmtime</a></div><div class="message_embed_description">Standalone JIT-style runtime for WebAssembly, using Cranelift - cfallin/wasmtime</div></div></div>



<a name="193512493"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/merging%20arm64%20backend/near/193512493" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/merging.20arm64.20backend.html#193512493">(Apr 09 2020 at 21:37)</a>:</h4>
<p>My thought is that one PR makes sense. This will save you a lot of work over juggling a long chain of dependent PRs. It'll be a big review, but we can focus on making sure we understand the main shape of things rather than probing into every detail, and then, in return for us having saved you all that juggling work, you can be responsive to people probing into the details and asking questions after it lands :-)</p>



<a name="193512524"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/merging%20arm64%20backend/near/193512524" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/merging.20arm64.20backend.html#193512524">(Apr 09 2020 at 21:37)</a>:</h4>
<p>How does that sound?</p>



<a name="193512645"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/merging%20arm64%20backend/near/193512645" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/merging.20arm64.20backend.html#193512645">(Apr 09 2020 at 21:38)</a>:</h4>
<p>That sounds eminently reasonable!</p>



<a name="193513133"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/merging%20arm64%20backend/near/193513133" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/merging.20arm64.20backend.html#193513133">(Apr 09 2020 at 21:42)</a>:</h4>
<p><a href="https://github.com/bytecodealliance/wasmtime/pull/1494" title="https://github.com/bytecodealliance/wasmtime/pull/1494">https://github.com/bytecodealliance/wasmtime/pull/1494</a> -- review away!</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/1494" style="background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/1494" title="Add new `MachInst` backend and ARM64 support. by cfallin · Pull Request #1494 · bytecodealliance/wasmtime">Add new `MachInst` backend and ARM64 support. by cfallin · Pull Request #1494 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">This PR contributes a new backend framework built around MachInsts (machine instructions) contained in VCode (virtual-registerized code) containers. Furthermore, it contains a working ARM64 backend...</div></div></div>



<a name="193539865"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/merging%20arm64%20backend/near/193539865" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Julian Seward <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/merging.20arm64.20backend.html#193539865">(Apr 10 2020 at 05:42)</a>:</h4>
<p><span class="user-mention" data-user-id="254389">@Chris Fallin</span> , excellent work.  I am of course happy to review stuff.<br>
Somewhat related question: what is now the situation regarding further commits to your branch?  I ask because as I work to speed up the register allocator, I am beginning to see inefficiencies on the CL side (in the new code) that also need to be fixed.  I could make patches for those and put them off to one side until after reviewing/merging is done, if that would be helpful.</p>



<a name="193540056"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/merging%20arm64%20backend/near/193540056" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/merging.20arm64.20backend.html#193540056">(Apr 10 2020 at 05:48)</a>:</h4>
<p><span class="user-mention" data-user-id="268444">@Julian Seward</span> great! I think that Dan is going to review at a high level (as he indicated in the #cranelift channel) but please feel free to go over anything in more detail</p>



<a name="193540111"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/merging%20arm64%20backend/near/193540111" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/merging.20arm64.20backend.html#193540111">(Apr 10 2020 at 05:48)</a>:</h4>
<p>Regarding the branch -- I don't want to block ongoing work, so I think we can keep pushing to <code>arm64</code> until the PR lands; and then we can rebase whatever has happened in the meantime and review as additional PRs</p>



<a name="193540124"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/merging%20arm64%20backend/near/193540124" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/merging.20arm64.20backend.html#193540124">(Apr 10 2020 at 05:49)</a>:</h4>
<p>(The alternative is to stack up a bunch of dependent PRs which is especially messy as reviews change things -- don't really want to go there)</p>



<a name="193550769"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/merging%20arm64%20backend/near/193550769" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Bouvier <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/merging.20arm64.20backend.html#193550769">(Apr 10 2020 at 09:05)</a>:</h4>
<p>Yay \o/</p>



<a name="193550956"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/merging%20arm64%20backend/near/193550956" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Bouvier <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/merging.20arm64.20backend.html#193550956">(Apr 10 2020 at 09:08)</a>:</h4>
<p>Two things that come to mind:</p>
<ol>
<li>Would it be possible to add in your commit messages the following (adapted for each commit, of course), in the body:</li>
</ol>
<div class="codehilite"><pre><span></span>Co-authored-by: Julian Seward &lt;jseward@acm.org&gt;
Co-authored-by: Joey Gouly &lt;joey.gouly@arm.com&gt;
Co-authored-by: Benjamin Bouvier &lt;public@benj.me&gt;
</pre></div>


<p>Then Github is able to pattern-match this and mark commits as being co-authored, which is nice to better attribute credit.</p>
<ol start="2">
<li>There hasn't been any reviews of the <a href="http://regalloc.rs" title="http://regalloc.rs">regalloc.rs</a> crate, which is used in the new backend, so I think this should happen, probably in parallel. Again, we're in a territory where "things work", but no one has checked the work of anybody else. I'll sync up with Julian.</li>
</ol>



<a name="193604240"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/merging%20arm64%20backend/near/193604240" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/merging.20arm64.20backend.html#193604240">(Apr 10 2020 at 18:53)</a>:</h4>
<p><span class="user-mention" data-user-id="254389">@Chris Fallin</span> I'm just realizing that this design of parameterizing on the instruction means that it looks like the entire mach backend gets monomorphized for every target, is that right?</p>



<a name="193604295"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/merging%20arm64%20backend/near/193604295" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/merging.20arm64.20backend.html#193604295">(Apr 10 2020 at 18:53)</a>:</h4>
<p>Yes, that's right; we made this decision early on to avoid dynamic dispatch</p>



<a name="193604390"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/merging%20arm64%20backend/near/193604390" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/merging.20arm64.20backend.html#193604390">(Apr 10 2020 at 18:54)</a>:</h4>
<p>That does work out well for the JIT case where just one target is active, of course, so it's not necessarily a bad idea.</p>



<a name="193604442"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/merging%20arm64%20backend/near/193604442" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/merging.20arm64.20backend.html#193604442">(Apr 10 2020 at 18:55)</a>:</h4>
<p>We figured that in the common case, the compiler would be built with support for one target, and in the uncommon case, the code that gets monomorphized is ideally not a large portion of the total code (most of the bulk is in the machine backend and in the target-indep passes, it seems)</p>



<a name="193604605"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/merging%20arm64%20backend/near/193604605" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/merging.20arm64.20backend.html#193604605">(Apr 10 2020 at 18:56)</a>:</h4>
<p>Yeah, and in any configuration linking in multiple targets (rustc?), there's going to be a lot of target-specific code anyway.</p>



<a name="193604853"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/merging%20arm64%20backend/near/193604853" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/merging.20arm64.20backend.html#193604853">(Apr 10 2020 at 18:58)</a>:</h4>
<p>This may make things harder if we pursue the crazy idea I mentioned earlier of replacing clif IR with vcode IR entirely, because more code would be monomorphized then, but it may still be manageable.</p>



<a name="193605672"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/merging%20arm64%20backend/near/193605672" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/merging.20arm64.20backend.html#193605672">(Apr 10 2020 at 19:05)</a>:</h4>
<p>the VCode methods at least would be monomorphized twice, but e.g. the lowering wouldn't be (I imagine we'd conceptually have <code>fn lower&lt;FromInst: VCodeInst, ToInst: VCodeInst&gt;(...)</code> and just one (from, to) pair in the common case)</p>



<a name="193605727"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/merging%20arm64%20backend/near/193605727" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/merging.20arm64.20backend.html#193605727">(Apr 10 2020 at 19:06)</a>:</h4>
<p>so yeah, maybe not too bad.</p>



<a name="194336337"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/merging%20arm64%20backend/near/194336337" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Bouvier <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/merging.20arm64.20backend.html#194336337">(Apr 16 2020 at 17:04)</a>:</h4>
<p><span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>