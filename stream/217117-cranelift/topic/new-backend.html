<html>
<head><meta charset="utf-8"><title>new-backend · cranelift · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/index.html">cranelift</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html">new-backend</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="188737298"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/188737298" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joey Gouly <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#188737298">(Feb 21 2020 at 14:45)</a>:</h4>
<p>Thought I'd create  a stream for the new proposed backend, to continue on from irc</p>



<a name="188748216"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/188748216" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Bouvier <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#188748216">(Feb 21 2020 at 16:28)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="254389">@Chris Fallin</span> (Julian is not here yet).</p>



<a name="188751677"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/188751677" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#188751677">(Feb 21 2020 at 17:02)</a>:</h4>
<p>Hello! Looking forward to new-backend discussions here.</p>



<a name="188759257"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/188759257" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#188759257">(Feb 21 2020 at 18:16)</a>:</h4>
<p>does the slide deck from a month or so ago still reflect the current state of work for the new backend? interested in staying abreast of its design and thinking about how we might fit in pattern match and replace DSLs for peephole opts and legalization etc</p>



<a name="188760177"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/188760177" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#188760177">(Feb 21 2020 at 18:27)</a>:</h4>
<p><span class="user-mention" data-user-id="253990">@Nick Fitzgerald</span> , you're referring to the 2020-01-06 presentation? At a high level, yes, we're still moving in that direction, though there's been a lot of implementation and refinement since then!</p>
<p>For raw data, you can see our in-progress side-branch at <a href="https://github.com/cfallin/cranelift" target="_blank" title="https://github.com/cfallin/cranelift">https://github.com/cfallin/cranelift</a> (the interesting bits are in cranelift-codegen/src/{machinst,isa/arm64,isa/x64}), though we could (and will) do a better job of documenting the high-level structure once we've got our MVP (integer instruction set on ARM64, running Wasm) done.</p>
<p>I'd be happy to talk more about how this might integrate with peephole / superoptimizer-type work, though!</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/cfallin/cranelift" style="background-image: url(https://avatars2.githubusercontent.com/u/216148?s=400&amp;v=4)" target="_blank"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/cfallin/cranelift" target="_blank" title="cfallin/cranelift">cfallin/cranelift</a></div><div class="message_embed_description">Contribute to cfallin/cranelift development by creating an account on GitHub.</div></div></div>



<a name="188760752"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/188760752" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#188760752">(Feb 21 2020 at 18:32)</a>:</h4>
<p>thanks for the link! I'll add a topic to the next cranelift meeting's agenda.</p>
<p>context is I'm going to help Jubi Taneja finish her research project to create a peephole optimizer for cranelift that is seeded with optimizations from souper that she started as an intern a couple summers ago. my hope is that once the new backend gets in place we can try and merge this in / rebase it on top</p>



<a name="188763183"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/188763183" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#188763183">(Feb 21 2020 at 18:59)</a>:</h4>
<p><span class="user-mention" data-user-id="254389">@Chris Fallin</span> thanks for this nice doc comment :)</p>
<p><a href="https://github.com/cfallin/cranelift/blame/new-isa-def-2/cranelift-codegen/src/machinst/mod.rs#L1" target="_blank" title="https://github.com/cfallin/cranelift/blame/new-isa-def-2/cranelift-codegen/src/machinst/mod.rs#L1">https://github.com/cfallin/cranelift/blame/new-isa-def-2/cranelift-codegen/src/machinst/mod.rs#L1</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/cfallin/cranelift/blame/new-isa-def-2/cranelift-codegen/src/machinst/mod.rs#L1" style="background-image: url(https://avatars2.githubusercontent.com/u/216148?s=400&amp;v=4)" target="_blank"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/cfallin/cranelift/blame/new-isa-def-2/cranelift-codegen/src/machinst/mod.rs#L1" target="_blank" title="cfallin/cranelift">cfallin/cranelift</a></div><div class="message_embed_description">Contribute to cfallin/cranelift development by creating an account on GitHub.</div></div></div>



<a name="188763249"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/188763249" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#188763249">(Feb 21 2020 at 19:00)</a>:</h4>
<p>For reference: <span class="user-mention" data-user-id="253990">@Nick Fitzgerald</span> is probably talking about <a href="https://github.com/jubitaneja/codegen" target="_blank" title="https://github.com/jubitaneja/codegen">https://github.com/jubitaneja/codegen</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/jubitaneja/codegen" style="background-image: url(https://avatars0.githubusercontent.com/u/6600596?s=400&amp;v=4)" target="_blank"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/jubitaneja/codegen" target="_blank" title="jubitaneja/codegen">jubitaneja/codegen</a></div><div class="message_embed_description">Automatic peephole optimizer for Cranelift JIT compiler - jubitaneja/codegen</div></div></div>



<a name="188763283"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/188763283" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#188763283">(Feb 21 2020 at 19:00)</a>:</h4>
<p>yes :)</p>



<a name="189006400"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189006400" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joey Gouly <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189006400">(Feb 25 2020 at 10:16)</a>:</h4>
<p><span class="user-mention" data-user-id="253990">@Nick Fitzgerald</span>  <a href="https://github.com/jubitaneja/codegen/blob/master/fn.rs" target="_blank" title="https://github.com/jubitaneja/codegen/blob/master/fn.rs">https://github.com/jubitaneja/codegen/blob/master/fn.rs</a> this is auto-generated?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/jubitaneja/codegen/blob/master/fn.rs" style="background-image: url(https://avatars0.githubusercontent.com/u/6600596?s=400&amp;v=4)" target="_blank"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/jubitaneja/codegen/blob/master/fn.rs" target="_blank" title="jubitaneja/codegen">jubitaneja/codegen</a></div><div class="message_embed_description">Automatic peephole optimizer for Cranelift JIT compiler - jubitaneja/codegen</div></div></div>



<a name="189016191"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189016191" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joey Gouly <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189016191">(Feb 25 2020 at 12:47)</a>:</h4>
<p><span class="user-mention" data-user-id="254389">@Chris Fallin</span> has 'clif-util compile' changed behaviour? It seems to be running code from <code>cranelift-codegen/meta/src/shared/legalize.rs</code> now?</p>



<a name="189036267"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189036267" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189036267">(Feb 25 2020 at 16:42)</a>:</h4>
<p><span class="user-mention" data-user-id="265780">@Joey Gouly</span> yes, that's right, I've wired (some) legalization passes into the new backend's pipeline now. Is it interfering with one of the new instructions you're adding?</p>



<a name="189036593"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189036593" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joey Gouly <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189036593">(Feb 25 2020 at 16:46)</a>:</h4>
<p><span class="user-mention" data-user-id="254389">@Chris Fallin</span> but there seems to be a difference between clif-util test and clif-util compile?</p>



<a name="189036683"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189036683" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joey Gouly <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189036683">(Feb 25 2020 at 16:47)</a>:</h4>
<p>try <code>cargo r test filetests/vcode/arm64/bitops.clif</code> (works) <code>cargo r compile --target arm64 filetests/vcode/arm64/bitops.clif</code> (fails)</p>



<a name="189036916"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189036916" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189036916">(Feb 25 2020 at 16:50)</a>:</h4>
<p>oh, I see -- I'll take a look. The wiring up of the new pipeline is still very much a work-in-progress so I may have missed something :-)</p>



<a name="189037462"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189037462" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joey Gouly <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189037462">(Feb 25 2020 at 16:54)</a>:</h4>
<p>you might have to implement the ihsr+imm stuff, or turn off the bitrev legalisation for now</p>



<a name="189044292"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189044292" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189044292">(Feb 25 2020 at 18:04)</a>:</h4>
<p><span class="user-mention" data-user-id="265780">@Joey Gouly</span> I believe so, yes</p>



<a name="189126282"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189126282" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joey Gouly <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189126282">(Feb 26 2020 at 15:47)</a>:</h4>
<p><span class="user-mention" data-user-id="254389">@Chris Fallin</span> also <code>--set=opt_level=speed</code> doesn't work. In <code>cranelift-codegen/src/context.rs</code> <code>opt_level</code> is still <code>None</code>.</p>



<a name="189137679"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189137679" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189137679">(Feb 26 2020 at 17:40)</a>:</h4>
<p><span class="user-mention" data-user-id="265780">@Joey Gouly</span> : it seems that opt_level comes through the ISA flags, which I haven't plumbed through in any real way yet... thanks for the heads-up!</p>



<a name="189139336"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189139336" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joey Gouly <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189139336">(Feb 26 2020 at 17:57)</a>:</h4>
<p><span class="user-mention" data-user-id="254389">@Chris Fallin</span>  It also seems like the legalisation isn't working as intended, I'm still getting GlobalValue and IcmpImm through to the lower() functions</p>



<a name="189139426"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189139426" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189139426">(Feb 26 2020 at 17:58)</a>:</h4>
<p>Yes, I was debugging this yesterday afternoon as part of wasmtime bringup; I'll try to work this out today</p>



<a name="189139531"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189139531" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joey Gouly <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189139531">(Feb 26 2020 at 17:59)</a>:</h4>
<p>Cool, I saw that you were working on that. Let me know when there is something testable on wasmtime. I can try on my arm64 desktop</p>



<a name="189139859"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189139859" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189139859">(Feb 26 2020 at 18:02)</a>:</h4>
<p>Will do!</p>



<a name="189139956"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189139956" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joey Gouly <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189139956">(Feb 26 2020 at 18:03)</a>:</h4>
<p>I've been trying to compile some wasm with <code>clif-util wasm</code>, and I'm just stubbing stuff out as I go, to see what isn't implemented (stubbing them out usually with a mov rd, 0)</p>



<a name="189140395"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189140395" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189140395">(Feb 26 2020 at 18:07)</a>:</h4>
<p>I'm using a hello world compiled with wasi-sdk, so I'm jumping into the deep end with interesting libc initialization bits; so far I know that the new backend is at least missing jump tables, and probably a few more details related to global values, and I haven't written any code to interpret the arm64 relocations yet so that should come in somewhere. But it seems it's not too far off</p>



<a name="189220416"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189220416" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joey Gouly <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189220416">(Feb 27 2020 at 14:57)</a>:</h4>
<p><span class="user-mention" data-user-id="254389">@Chris Fallin</span> I have a function where RA takes 460s!</p>



<a name="189234233"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189234233" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189234233">(Feb 27 2020 at 17:18)</a>:</h4>
<p><span class="user-mention" data-user-id="265780">@Joey Gouly</span> wow, that's... impressive. @jseward and <span class="user-mention" data-user-id="254393">@Benjamin Bouvier</span> are leading work on the regalloc crate -- we'd probably be interested in a test case (or at least a general description -- very long function, deeply nested control flow, too many overlapping live ranges, ...?)</p>



<a name="189234316"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189234316" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joey Gouly <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189234316">(Feb 27 2020 at 17:19)</a>:</h4>
<p>Is Julian on holiday? Seems like he doesn't want to join zulip :P I see that there's a hot function <code>SortedRangeFragIxs::check</code> function which looks like it should (?) be enabled in debug only</p>



<a name="189234434"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189234434" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189234434">(Feb 27 2020 at 17:20)</a>:</h4>
<p>Just pinged both on Matrix (they're both online)!</p>



<a name="189234599"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189234599" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joey Gouly <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189234599">(Feb 27 2020 at 17:22)</a>:</h4>
<p>I saw that Benjamin added a <code>EpiloguePlaceholder</code>, I guess that's the new backends <code>FallthroughReturn</code></p>



<a name="189235129"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189235129" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joey Gouly <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189235129">(Feb 27 2020 at 17:28)</a>:</h4>
<p><code>SortedRangeFragIxs::del</code> and <code>SortedRangeFragIxs::can_add</code> seem to be other hot functions. I changed <code>del</code> to use <code>with_capacity</code> instead of <code>new</code> for <code>res</code>, but it didn't seem to have much of an effect</p>



<a name="189235162"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189235162" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189235162">(Feb 27 2020 at 17:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="265780">Joey Gouly</span> <a href="#narrow/stream/217117-cranelift/topic/new-backend/near/189234599" title="#narrow/stream/217117-cranelift/topic/new-backend/near/189234599">said</a>:</p>
<blockquote>
<p>I saw that Benjamin added a <code>EpiloguePlaceholder</code>, I guess that's the new backends <code>FallthroughReturn</code></p>
</blockquote>
<p>Yep, we decided this was a less confusing name.</p>



<a name="189236272"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189236272" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joey Gouly <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189236272">(Feb 27 2020 at 17:41)</a>:</h4>
<p>In this test case <code>SortedRangeFragIxs::del</code> is called 21,902,029 times</p>



<a name="189357262"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189357262" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189357262">(Feb 28 2020 at 22:27)</a>:</h4>
<p>Progress: new ARM64 backend has enough working to get through wasi libc init and print "Hello world"!</p>
<div class="codehilite"><pre><span></span>$  qemu-aarch64  target/aarch64-unknown-linux-gnu/release/wasmtime run ~/hello-world.wasm
hello world
</pre></div>



<a name="189358476"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189358476" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189358476">(Feb 28 2020 at 22:41)</a>:</h4>
<p>It takes quite a lot of code to print hello world with libc, so that really says something!</p>



<a name="189586691"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189586691" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joey Gouly <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189586691">(Mar 03 2020 at 12:09)</a>:</h4>
<p>welcome <span class="user-mention" data-user-id="268444">@Julian Seward</span></p>



<a name="189587786"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189587786" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Julian Seward <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189587786">(Mar 03 2020 at 12:24)</a>:</h4>
<p>Hi!</p>



<a name="189587811"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189587811" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Julian Seward <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189587811">(Mar 03 2020 at 12:25)</a>:</h4>
<p>That's a big bit of CLIF.  Can I ask a couple questions about it?</p>



<a name="189587813"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189587813" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joey Gouly <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189587813">(Mar 03 2020 at 12:25)</a>:</h4>
<p>So did you manage to reproduce the long compile time?</p>



<a name="189587818"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189587818" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joey Gouly <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189587818">(Mar 03 2020 at 12:25)</a>:</h4>
<p>sure!</p>



<a name="189587904"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189587904" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Julian Seward <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189587904">(Mar 03 2020 at 12:26)</a>:</h4>
<p>Not yet.  I spent all yesterday and this morning rewriting the allocator's core allocate-evict loop so as to remove a very stupid performance problem that exists in the current version (and which I'm sure is related to what you saw).</p>



<a name="189587915"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189587915" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Julian Seward <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189587915">(Mar 03 2020 at 12:27)</a>:</h4>
<p>Now I'm trying to un-break it :-/</p>



<a name="189587975"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189587975" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Julian Seward <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189587975">(Mar 03 2020 at 12:28)</a>:</h4>
<p>Q: (mostly for my curiousity): (1) what is that CLIF?  Where is it from?  and (2) do the existing allocator sources create a correct allocation for it, after 70 mins?</p>



<a name="189588224"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189588224" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joey Gouly <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189588224">(Mar 03 2020 at 12:30)</a>:</h4>
<p>I don't know what function it is, but it's from a benchmark I wrote using the regex crate. Im not sure if it's correct, since I didn't run it (+ some arm64 functionality was stubbed out)</p>



<a name="189588333"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189588333" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Julian Seward <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189588333">(Mar 03 2020 at 12:32)</a>:</h4>
<p>Ok.  Well, let me try to get this thing back on the road.  Then I'll have a look at the test case.</p>



<a name="189602389"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189602389" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Julian Seward <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189602389">(Mar 03 2020 at 15:19)</a>:</h4>
<p>Trying it now.  So far, it's spending a lot of time in calculation of dominators</p>



<a name="189602429"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189602429" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Julian Seward <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189602429">(Mar 03 2020 at 15:19)</a>:</h4>
<p>Were you using a debug or release build?</p>



<a name="189602460"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189602460" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joey Gouly <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189602460">(Mar 03 2020 at 15:20)</a>:</h4>
<p>Release</p>



<a name="189602625"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189602625" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Julian Seward <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189602625">(Mar 03 2020 at 15:21)</a>:</h4>
<p>Er, how do I get that?  (cd cranelift &amp;&amp; cargo build release) doesn't work</p>



<a name="189602631"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189602631" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joey Gouly <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189602631">(Mar 03 2020 at 15:21)</a>:</h4>
<p>--release</p>



<a name="189602999"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189602999" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joey Gouly <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189602999">(Mar 03 2020 at 15:24)</a>:</h4>
<p>you can also do <code>cargo run --release</code></p>



<a name="189605381"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189605381" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Julian Seward <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189605381">(Mar 03 2020 at 15:51)</a>:</h4>
<p>Running now.  Roughly how big was the original function?  I am seeing tens of thousands of virtual registers coming into regalloc.</p>



<a name="189605474"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189605474" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joey Gouly <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189605474">(Mar 03 2020 at 15:52)</a>:</h4>
<p>I didn't find out what the original function was, just took the CLIF that was generated</p>



<a name="189609838"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/new-backend/near/189609838" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joey Gouly <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/new-backend.html#189609838">(Mar 03 2020 at 16:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="254389">Chris Fallin</span> <a href="#narrow/stream/217117-cranelift/topic/new-backend/near/189357262" title="#narrow/stream/217117-cranelift/topic/new-backend/near/189357262">said</a>:</p>
<blockquote>
<p>Progress: new ARM64 backend has enough working to get through wasi libc init and print "Hello world"!</p>
<div class="codehilite"><pre><span></span>$  qemu-aarch64  target/aarch64-unknown-linux-gnu/release/wasmtime run ~/hello-world.wasm
hello world
</pre></div>


</blockquote>
<p>I reproduced this natively on my arm64 desktop!</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>