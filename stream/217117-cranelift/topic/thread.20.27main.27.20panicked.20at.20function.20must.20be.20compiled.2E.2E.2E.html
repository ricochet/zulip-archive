<html>
<head><meta charset="utf-8"><title>thread &#x27;main&#x27; panicked at function must be compiled... · cranelift · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/index.html">cranelift</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html">thread &#x27;main&#x27; panicked at function must be compiled...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="262434802"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262434802" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ivan Chinenov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262434802">(Nov 23 2021 at 10:09)</a>:</h4>
<p>I am encountering a lot of this obscure error:<br>
<code>thread 'main' panicked at 'function must be compiled before it can be finalized', /home/johnd/.cargo/registry/src/github.com-1ecc6299db9ec823/cranelift-jit-0.78.0/src/backend.rs:356:14</code><br>
It sure would be nice why exactly the function doesn't compile. As far as I explored, one thing that causes this is type mismatch between signature and actual params, but there's a bunch of more subtle things that cause this that i am yet to figure out</p>



<a name="262438049"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262438049" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ivan Chinenov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262438049">(Nov 23 2021 at 10:41)</a>:</h4>
<p>Here is the CLIF for a function that fails to compile:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="p">(</span><span class="n">r64</span><span class="p">,</span><span class="w"> </span><span class="n">r64</span><span class="p">)</span><span class="w"> </span><span class="n">system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">31</span><span class="w"></span>
<span class="w">    </span><span class="n">ss1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
<span class="w">    </span><span class="n">ss2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
<span class="w">    </span><span class="n">ss3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
<span class="w">    </span><span class="n">sig0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">r64</span><span class="p">,</span><span class="w"> </span><span class="n">r64</span><span class="p">,</span><span class="w"> </span><span class="n">r64</span><span class="p">)</span><span class="w"> </span><span class="n">system_v</span><span class="w"></span>
<span class="w">    </span><span class="n">fn0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="w"> </span><span class="n">sig0</span><span class="w"></span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">r64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">r64</span><span class="p">)</span>:
    <span class="nc">v19</span><span class="w"> </span>-&gt; <span class="nc">v0</span><span class="w"></span>
<span class="w">    </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_addr</span><span class="p">.</span><span class="n">r64</span><span class="w"> </span><span class="n">ss0</span><span class="w"></span>
<span class="w">    </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_addr</span><span class="p">.</span><span class="n">r64</span><span class="w"> </span><span class="n">ss1</span><span class="w"></span>
<span class="w">    </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
<span class="w">    </span><span class="n">v6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span><span class="o">+</span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">v8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v3</span><span class="o">+</span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="n">brz</span><span class="w"> </span><span class="n">v8</span><span class="p">,</span><span class="w"> </span><span class="n">block2</span><span class="w"></span>
<span class="w">    </span><span class="n">jump</span><span class="w"> </span><span class="n">block1</span><span class="w"></span>

<span class="n">block1</span>:
    <span class="nc">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_addr</span><span class="p">.</span><span class="n">r64</span><span class="w"> </span><span class="n">ss2</span><span class="w"></span>
<span class="w">    </span><span class="n">v11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">v12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v12</span><span class="p">,</span><span class="w"> </span><span class="n">v10</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v11</span><span class="p">,</span><span class="w"> </span><span class="n">v10</span><span class="o">+</span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="n">jump</span><span class="w"> </span><span class="n">block3</span><span class="p">(</span><span class="n">v10</span><span class="p">)</span><span class="w"></span>

<span class="n">block2</span>:
    <span class="nc">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v14</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_addr</span><span class="p">.</span><span class="n">r64</span><span class="w"> </span><span class="n">ss3</span><span class="w"></span>
<span class="w">    </span><span class="n">v15</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="n">v16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v16</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span><span class="o">+</span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="n">jump</span><span class="w"> </span><span class="n">block3</span><span class="p">(</span><span class="n">v14</span><span class="p">)</span><span class="w"></span>

<span class="n">block3</span><span class="p">(</span><span class="n">v7</span>: <span class="kt">f64</span><span class="p">)</span>:
    <span class="nc">v17</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v7</span><span class="w"></span>
<span class="w">    </span><span class="n">v18</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v7</span><span class="o">+</span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v17</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v18</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span><span class="o">+</span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="262438208"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262438208" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262438208">(Nov 23 2021 at 10:43)</a>:</h4>
<p>Did you define all functions you declared with a linkage other than <code>Linkage::Import</code> before you called <code>.finalize_definitions()</code>?</p>



<a name="262438495"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262438495" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ivan Chinenov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262438495">(Nov 23 2021 at 10:46)</a>:</h4>
<p>Yes:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">callee</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">module</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">declare_function</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">env</span><span class="p">.</span><span class="n">lookup_symbol</span><span class="p">(</span><span class="n">name</span><span class="p">).</span><span class="n">unwrap</span><span class="p">(),</span><span class="w"> </span><span class="n">Linkage</span>::<span class="n">Import</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sig</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"problem declaring function"</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">local_callee</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">declare_func_in_func</span><span class="p">(</span><span class="n">callee</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="n">func</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>Note that in this case the function is recursive. I suspect that there is something wrong with how I translate if condition, since non-recursive calls without if condition work, but break when wrapped in an if</p>



<a name="262438653"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262438653" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ivan Chinenov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262438653">(Nov 23 2021 at 10:48)</a>:</h4>
<p>For reference, here is the translation function for if: <a href="https://github.com/JohnDowson/CraneLisp/blob/struct-values/src/jit.rs#L367-L397">https://github.com/JohnDowson/CraneLisp/blob/struct-values/src/jit.rs#L367-L397</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/JohnDowson/CraneLisp/blob/struct-values/src/jit.rs#L367-L397" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/a49b5957087aae52a486aa6c269ddaae205a8d29\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f373438636361333932323234616333633862316237306234366233633361356439663666343635623662393336393561356230366364373437393938666161362f4a6f686e446f77736f6e2f4372616e654c697370)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/JohnDowson/CraneLisp/blob/struct-values/src/jit.rs#L367-L397" title="CraneLisp/jit.rs at struct-values · JohnDowson/CraneLisp">CraneLisp/jit.rs at struct-values · JohnDowson/CraneLisp</a></div><div class="message_embed_description">Lisp in rust using cranelift as compiler backend. Contribute to JohnDowson/CraneLisp development by creating an account on GitHub.</div></div></div>



<a name="262439791"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262439791" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262439791">(Nov 23 2021 at 10:59)</a>:</h4>
<p>One unrelated nit. You can unconditionally call <code>prepare_for_function_redefine</code> at <a href="https://github.com/JohnDowson/CraneLisp/blob/aec9b9710b31f32e53634c3f4b81416cbd412b75/src/jit.rs#L119">https://github.com/JohnDowson/CraneLisp/blob/aec9b9710b31f32e53634c3f4b81416cbd412b75/src/jit.rs#L119</a> I believe. Even if it hasn't been defined previously.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/JohnDowson/CraneLisp/blob/aec9b9710b31f32e53634c3f4b81416cbd412b75/src/jit.rs#L119" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/a49b5957087aae52a486aa6c269ddaae205a8d29\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f373438636361333932323234616333633862316237306234366233633361356439663666343635623662393336393561356230366364373437393938666161362f4a6f686e446f77736f6e2f4372616e654c697370)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/JohnDowson/CraneLisp/blob/aec9b9710b31f32e53634c3f4b81416cbd412b75/src/jit.rs#L119" title="CraneLisp/jit.rs at aec9b9710b31f32e53634c3f4b81416cbd412b75 · JohnDowson/CraneLisp">CraneLisp/jit.rs at aec9b9710b31f32e53634c3f4b81416cbd412b75 · JohnDowson/CraneLisp</a></div><div class="message_embed_description">Lisp in rust using cranelift as compiler backend. Contribute to JohnDowson/CraneLisp development by creating an account on GitHub.</div></div></div>



<a name="262440387"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262440387" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262440387">(Nov 23 2021 at 11:04)</a>:</h4>
<p>I don't see anything wrong with your code.</p>



<a name="262440475"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262440475" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ivan Chinenov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262440475">(Nov 23 2021 at 11:05)</a>:</h4>
<p>I guess I should file an issue then.</p>



<a name="262449015"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262449015" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ivan Chinenov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262449015">(Nov 23 2021 at 12:32)</a>:</h4>
<p>Linking the issue just in case <a href="https://github.com/bytecodealliance/wasmtime/issues/3559">https://github.com/bytecodealliance/wasmtime/issues/3559</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/issues/3559" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/45083d3d4a12a4c28ad318cab2c7833f619e9242\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f336662633139303531376330386330613564353964306263343764323730346136303033326331643861656538326466623361613735613636633666346266312f62797465636f6465616c6c69616e63652f7761736d74696d652f6973737565732f33353539)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/issues/3559" title="Cranelift:  · Issue #3559 · bytecodealliance/wasmtime">Cranelift:  · Issue #3559 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">.clif Test Case function u0:0(r64, r64) system_v { ss0 = explicit_slot 31 ss1 = explicit_slot 16 ss2 = explicit_slot 16 ss3 = explicit_slot 16 sig0 = (r64, r64, r64) system_v fn0 = u0:0 sig0 block0...</div></div></div>



<a name="262453049"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262453049" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262453049">(Nov 23 2021 at 13:13)</a>:</h4>
<p><span class="user-mention" data-user-id="455945">@Ivan Chinenov</span> <code>ifjit.crl</code> is missing in the struct-values branch.</p>



<a name="262468729"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262468729" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ivan Chinenov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262468729">(Nov 23 2021 at 15:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="264278">bjorn3</span> <a href="#narrow/stream/217117-cranelift/topic/thread.20'main'.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E/near/262453049">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="455945">Ivan Chinenov</span> <code>ifjit.crl</code> is missing in the struct-values branch.</p>
</blockquote>
<p>Thank you for pointing this out, I forgot to push the file.</p>



<a name="262472682"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262472682" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262472682">(Nov 23 2021 at 15:41)</a>:</h4>
<p>I can reproduce the issue now.</p>



<a name="262474179"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262474179" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262474179">(Nov 23 2021 at 15:52)</a>:</h4>
<p>The problem was that <code>module.declare_function</code> returned an error other than <code>DuplicateDefinition</code>. This is completely ignored by your code. When adding an <code>unwrap()</code> I get:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Result</span>::<span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="nb">Err</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>: <span class="nc">Verifier</span><span class="p">(</span><span class="n">VerifierErrors</span><span class="p">([</span><span class="n">VerifierError</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">location</span>: <span class="nc">inst17</span><span class="p">,</span><span class="w"> </span><span class="n">context</span>: <span class="nb">Some</span><span class="p">(</span><span class="s">"jump block3(v10)"</span><span class="p">),</span><span class="w"> </span><span class="n">message</span>: <span class="s">"arg 0 (v10) has type r64, expected f64"</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">VerifierError</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">location</span>: <span class="nc">inst24</span><span class="p">,</span><span class="w"> </span><span class="n">context</span>: <span class="nb">Some</span><span class="p">(</span><span class="s">"jump block3(v14)"</span><span class="p">),</span><span class="w"> </span><span class="n">message</span>: <span class="s">"arg 0 (v14) has type r64, expected f64"</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">VerifierError</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">location</span>: <span class="nc">inst25</span><span class="p">,</span><span class="w"> </span><span class="n">context</span>: <span class="nb">Some</span><span class="p">(</span><span class="s">"v17 = load.i64 aligned v7"</span><span class="p">),</span><span class="w"> </span><span class="n">message</span>: <span class="s">"arg 0 (v7) with type f64 failed to satisfy type set ValueTypeSet { lanes: BitSet(1), ints: BitSet(96), floats: BitSet(0), bools: BitSet(0), refs: BitSet(96) }"</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">VerifierError</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">location</span>: <span class="nc">inst26</span><span class="p">,</span><span class="w"> </span><span class="n">context</span>: <span class="nb">Some</span><span class="p">(</span><span class="s">"v18 = load.i64 aligned v7+8"</span><span class="p">),</span><span class="w"> </span><span class="n">message</span>: <span class="s">"arg 0 (v7) with type f64 failed to satisfy type set ValueTypeSet { lanes: BitSet(1), ints: BitSet(96), floats: BitSet(0), bools: BitSet(0), refs: BitSet(96) }"</span><span class="w"> </span><span class="p">}]))</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bjorn</span><span class="o">/</span><span class="n">Projects</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">jit</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">backend</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">659</span>:<span class="mi">37</span><span class="w"></span>
</code></pre></div>



<a name="262474199"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262474199" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262474199">(Nov 23 2021 at 15:52)</a>:</h4>
<p><span class="user-mention" data-user-id="455945">@Ivan Chinenov</span></p>



<a name="262474264"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262474264" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262474264">(Nov 23 2021 at 15:53)</a>:</h4>
<p>You are confusing <code>r64</code> and <code>f64</code>.</p>



<a name="262481215"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262481215" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ivan Chinenov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262481215">(Nov 23 2021 at 16:46)</a>:</h4>
<p>Oh god, this is embarrassing, I've stared at my code for many hours and did not notice that.</p>



<a name="262890941"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262890941" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262890941">(Nov 27 2021 at 20:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="455945">Ivan Chinenov</span> has marked this topic as resolved.</p>



<a name="262891767"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262891767" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262891767">(Nov 27 2021 at 20:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="455945">Ivan Chinenov</span> has marked this topic as unresolved.</p>



<a name="262891913"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262891913" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ivan Chinenov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262891913">(Nov 27 2021 at 20:40)</a>:</h4>
<p>Okay, this time I didn't ignore any errors:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="nc">vlr_env</span><span class="p">[</span><span class="n">cand_vlrix</span><span class="p">].</span><span class="n">is_ref</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">is_ref</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">johnd</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">regalloc</span><span class="o">-</span><span class="mf">0.0.32</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">bt_spillslot_allocator</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">295</span>:<span class="mi">13</span><span class="w"></span>
</code></pre></div>
<p>clif: </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="p">(</span><span class="n">r64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">r64</span><span class="w"> </span><span class="n">system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
<span class="w">    </span><span class="n">ss1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
<span class="w">    </span><span class="n">ss2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
<span class="w">    </span><span class="n">ss3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
<span class="w">    </span><span class="n">ss4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
<span class="w">    </span><span class="n">sig0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">r64</span><span class="w"> </span><span class="n">system_v</span><span class="w"></span>
<span class="w">    </span><span class="n">sig1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">r64</span><span class="w"> </span><span class="n">system_v</span><span class="w"></span>
<span class="w">    </span><span class="n">sig2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">r64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">r64</span><span class="w"> </span><span class="n">system_v</span><span class="w"></span>
<span class="w">    </span><span class="n">fn0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="w"> </span><span class="n">sig0</span><span class="w"></span>
<span class="w">    </span><span class="n">fn1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">1</span><span class="w"> </span><span class="n">sig1</span><span class="w"></span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">r64</span><span class="p">)</span>:
    <span class="nc">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mh">0x55a4_6e04_70f0</span><span class="w"></span>
<span class="w">    </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">raw_bitcast</span><span class="p">.</span><span class="n">r64</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="w">    </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_addr</span><span class="p">.</span><span class="n">r64</span><span class="w"> </span><span class="n">ss0</span><span class="w"></span>
<span class="w">    </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">v6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span><span class="o">+</span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="n">v7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_addr</span><span class="p">.</span><span class="n">r64</span><span class="w"> </span><span class="n">ss1</span><span class="w"></span>
<span class="w">    </span><span class="n">v8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="n">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">v7</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v8</span><span class="p">,</span><span class="w"> </span><span class="n">v7</span><span class="o">+</span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="n">v10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_addr</span><span class="p">.</span><span class="n">r64</span><span class="w"> </span><span class="n">ss2</span><span class="w"></span>
<span class="w">    </span><span class="n">v11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">    </span><span class="n">v12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v12</span><span class="p">,</span><span class="w"> </span><span class="n">v10</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v11</span><span class="p">,</span><span class="w"> </span><span class="n">v10</span><span class="o">+</span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_addr</span><span class="p">.</span><span class="n">r64</span><span class="w"> </span><span class="n">ss3</span><span class="w"></span>
<span class="w">    </span><span class="n">v14</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="w">    </span><span class="n">v15</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v14</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span><span class="o">+</span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="n">v16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_addr</span><span class="p">.</span><span class="n">r64</span><span class="w"> </span><span class="n">ss4</span><span class="w"></span>
<span class="w">    </span><span class="n">v17</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="n">v18</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v18</span><span class="p">,</span><span class="w"> </span><span class="n">v16</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v17</span><span class="p">,</span><span class="w"> </span><span class="n">v16</span><span class="o">+</span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="n">v19</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="n">v20</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">40</span><span class="w"></span>
<span class="w">    </span><span class="n">v21</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn1</span><span class="p">(</span><span class="n">v20</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v4</span><span class="p">,</span><span class="w"> </span><span class="n">v21</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v7</span><span class="p">,</span><span class="w"> </span><span class="n">v21</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v10</span><span class="p">,</span><span class="w"> </span><span class="n">v21</span><span class="o">+</span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v13</span><span class="p">,</span><span class="w"> </span><span class="n">v21</span><span class="o">+</span><span class="mi">3</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v16</span><span class="p">,</span><span class="w"> </span><span class="n">v21</span><span class="o">+</span><span class="mi">4</span><span class="w"></span>
<span class="w">    </span><span class="n">v22</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call_indirect</span><span class="w"> </span><span class="n">sig2</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span><span class="p">(</span><span class="n">v19</span><span class="p">,</span><span class="w"> </span><span class="n">v21</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v22</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>What I am trying to do: call malloc and pass the resulting pointer to a callee:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// malloc</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">m_sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">make_signature</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">m_sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">I64</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">m_sig</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">R64</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">malloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">module</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">declare_function</span><span class="p">(</span><span class="s">"malloc"</span><span class="p">,</span><span class="w"> </span><span class="n">Linkage</span>::<span class="n">Import</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">m_sig</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">local_malloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">declare_func_in_func</span><span class="p">(</span><span class="n">malloc</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="n">func</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">make_signature</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="n">sig</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">R64</span><span class="p">));</span><span class="w"></span>

<span class="w">        </span><span class="n">sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">I64</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">R64</span><span class="p">));</span><span class="w"></span>

<span class="w">        </span><span class="cp">#[allow(clippy::fn_to_numeric_cast)]</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">func</span><span class="p">.</span><span class="n">body</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">import_signature</span><span class="p">(</span><span class="n">sig</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">callee</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">iconst</span><span class="p">(</span><span class="n">types</span>::<span class="n">I64</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">.</span><span class="n">body</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">callee</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">raw_bitcast</span><span class="p">(</span><span class="n">types</span>::<span class="n">R64</span><span class="p">,</span><span class="w"> </span><span class="n">callee</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">arg_values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>

<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exprs</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">into_iter</span><span class="p">()</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">a</span><span class="o">|</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">translate_expr</span><span class="p">(</span><span class="n">a</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">collect</span>::<span class="o">&lt;</span><span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;&gt;&gt;</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">iconst</span><span class="p">(</span><span class="n">types</span>::<span class="n">I64</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="c1">// call malloc</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">count_bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">builder</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">ins</span><span class="p">()</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">iconst</span><span class="p">(</span><span class="n">types</span>::<span class="n">I64</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">call</span><span class="p">(</span><span class="n">local_malloc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">count_bytes</span><span class="p">]);</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">heap_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="n">inst_results</span><span class="p">(</span><span class="n">call</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>

<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">memflags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MemFlags</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="n">memflags</span><span class="p">.</span><span class="n">set_aligned</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="n">into_iter</span><span class="p">().</span><span class="n">enumerate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">store</span><span class="p">(</span><span class="n">memflags</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="n">heap_addr</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="n">arg_values</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">count</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">arg_values</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">heap_addr</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">call_indirect</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="w"> </span><span class="n">callee</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg_values</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="n">inst_results</span><span class="p">(</span><span class="n">call</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">okay</span><span class="p">()</span><span class="w"></span>
</code></pre></div>



<a name="262895157"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262895157" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262895157">(Nov 27 2021 at 22:01)</a>:</h4>
<p>The <code>raw_bitcast.r64</code> may be the problem. The register allocator has some problems with dealing with this kind of construct. <span class="user-mention" data-user-id="254389">@Chris Fallin</span> regalloc2 fixes this once it gets merged, right?</p>



<a name="262895221"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262895221" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262895221">(Nov 27 2021 at 22:02)</a>:</h4>
<p><span class="user-mention" data-user-id="455945">@Ivan Chinenov</span> Please <code>@</code> mention me if you respond so I get a notification.</p>



<a name="262895528"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262895528" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ivan Chinenov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262895528">(Nov 27 2021 at 22:09)</a>:</h4>
<p><span class="user-mention" data-user-id="264278">@bjorn3</span> so if it is invalid to use R64 with iconst, and it is invalid to bitcast I64 to R64, how am I supposed to get a R64 value from an external pointer?</p>



<a name="262895694"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262895694" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262895694">(Nov 27 2021 at 22:13)</a>:</h4>
<p>I guess storing on the stack as i64 and loading as r64 may work around this bug.</p>



<a name="262896195"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262896195" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ivan Chinenov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262896195">(Nov 27 2021 at 22:26)</a>:</h4>
<p><span class="user-mention" data-user-id="264278">@bjorn3</span> oh, yeah, that works.</p>



<a name="262926514"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262926514" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ivan Chinenov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262926514">(Nov 28 2021 at 12:34)</a>:</h4>
<p>Oh, I think I could've just used <code>const_addr</code>.</p>



<a name="262940479"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262940479" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ivan Chinenov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262940479">(Nov 28 2021 at 18:02)</a>:</h4>
<p><span class="user-mention" data-user-id="264278">@bjorn3</span> is there some way to insert comments into generated function clif? I see that there is something like that in rustc_cranelift_codegen but it seems to be fairly intertwined with abstractions you've built over the cranelift.</p>



<a name="262940756"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262940756" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262940756">(Nov 28 2021 at 18:09)</a>:</h4>
<p>CommentWriter from rustc_codegen_cranelift doesn't depend on any abstractions at all. All functions that depend on abstractions in cg_clif are convenience functions only.</p>



<a name="262940806"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262940806" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262940806">(Nov 28 2021 at 18:10)</a>:</h4>
<p><span class="user-mention" data-user-id="455945">@Ivan Chinenov</span> Maybe I should upstream CommentWriter one day.</p>



<a name="262944444"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262944444" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ivan Chinenov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262944444">(Nov 28 2021 at 19:34)</a>:</h4>
<p><span class="user-mention" data-user-id="264278">@bjorn3</span> that would be supremely useful!</p>
<p>On a side note, do you know if call_indirect supposed to use half-width register for callq and then jump into non-executable memory?</p>



<a name="262945776"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262945776" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262945776">(Nov 28 2021 at 20:07)</a>:</h4>
<p>No, call_indirect should directly call into executable memory. For cranelift-jit it will jump to a stub that calls the actual function. This is how redefining functions can work without having to make all executable memory writable again and relocating everything.</p>



<a name="262945782"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262945782" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262945782">(Nov 28 2021 at 20:07)</a>:</h4>
<p><span class="user-mention" data-user-id="455945">@Ivan Chinenov</span> Can you show a disassembly?</p>



<a name="262946382"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262946382" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ivan Chinenov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262946382">(Nov 28 2021 at 20:22)</a>:</h4>
<p><span class="user-mention" data-user-id="264278">@bjorn3</span> I did some rubber duck debugging on people in the rust community discord and found out that i'm either processing or passing arguments incorrectly. I'm basically doing variadics via a heap array.</p>



<a name="262946482"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262946482" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ivan Chinenov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262946482">(Nov 28 2021 at 20:24)</a>:</h4>
<p>Either here <a href="https://github.com/JohnDowson/CraneLisp/blob/main/src/jit.rs#L571-L625">https://github.com/JohnDowson/CraneLisp/blob/main/src/jit.rs#L571-L625</a><br>
or here <a href="https://github.com/JohnDowson/CraneLisp/blob/main/src/function.rs#L26-L30">https://github.com/JohnDowson/CraneLisp/blob/main/src/function.rs#L26-L30</a><br>
respectively</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/JohnDowson/CraneLisp/blob/main/src/jit.rs#L571-L625" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/f27c92c03af72edbe37329342c6de9b1f86cb546\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f396365616464646539373033326166323232353439626435653666653635663462353165366633656531323330643363613737636164363437313834643638642f4a6f686e446f77736f6e2f4372616e654c697370)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/JohnDowson/CraneLisp/blob/main/src/jit.rs#L571-L625" title="CraneLisp/jit.rs at main · JohnDowson/CraneLisp">CraneLisp/jit.rs at main · JohnDowson/CraneLisp</a></div><div class="message_embed_description">Lisp in rust using cranelift as compiler backend. Contribute to JohnDowson/CraneLisp development by creating an account on GitHub.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/JohnDowson/CraneLisp/blob/main/src/function.rs#L26-L30" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/f27c92c03af72edbe37329342c6de9b1f86cb546\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f396365616464646539373033326166323232353439626435653666653635663462353165366633656531323330643363613737636164363437313834643638642f4a6f686e446f77736f6e2f4372616e654c697370)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/JohnDowson/CraneLisp/blob/main/src/function.rs#L26-L30" title="CraneLisp/function.rs at main · JohnDowson/CraneLisp">CraneLisp/function.rs at main · JohnDowson/CraneLisp</a></div><div class="message_embed_description">Lisp in rust using cranelift as compiler backend. Contribute to JohnDowson/CraneLisp development by creating an account on GitHub.</div></div></div>



<a name="262946501"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262946501" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ivan Chinenov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262946501">(Nov 28 2021 at 20:25)</a>:</h4>
<p>I hope you don't mind being poked by my footshooting questions.</p>



<a name="262946718"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262946718" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262946718">(Nov 28 2021 at 20:31)</a>:</h4>
<p><span class="user-mention" data-user-id="455945">@Ivan Chinenov</span> The jitted code expects an array of <code>*mut Atom</code>, right? You are passing a  reference to an array of <code>Atom</code>s.</p>



<a name="262946775"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262946775" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ivan Chinenov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262946775">(Nov 28 2021 at 20:32)</a>:</h4>
<p>Also one thing i'm wondering, is to how to do pointer arithmetic without the load/store trick, cause iadd_imm doesn't work on R types</p>



<a name="262946846"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262946846" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262946846">(Nov 28 2021 at 20:34)</a>:</h4>
<p>Cranelift reference types are currently pretty much only used for wasm reference types, which are opaque.</p>



<a name="262946855"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262946855" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262946855">(Nov 28 2021 at 20:34)</a>:</h4>
<p>I think adding support for pointer arithmetic to reference types makes sense though.</p>



<a name="262947012"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262947012" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ivan Chinenov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262947012">(Nov 28 2021 at 20:38)</a>:</h4>
<p>That's super counter-intuitive. And also wouldn't you have to cast either way to use I64 with store/load?</p>



<a name="262947030"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262947030" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ivan Chinenov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262947030">(Nov 28 2021 at 20:39)</a>:</h4>
<p>Also yes, that one mistake in <code>call</code> cost me at 4-5 hours today, seems to work fine now.</p>



<a name="262947110"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262947110" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ivan Chinenov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262947110">(Nov 28 2021 at 20:41)</a>:</h4>
<p><span class="user-mention" data-user-id="264278">@bjorn3</span> although for some reason only first two arguments work, trying to use a third one still causes a segfault.</p>



<a name="262947518"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262947518" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262947518">(Nov 28 2021 at 20:52)</a>:</h4>
<p>store and load work just fine with i64. cranelift ir uses i64 as pointer type on 64bit systems. r64 exists for when you have a garbage collector that needs to know where on the stack it can find roots. Every r64 value is considered a root.</p>



<a name="262947528"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262947528" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262947528">(Nov 28 2021 at 20:52)</a>:</h4>
<blockquote>
<p><span class="user-mention silent" data-user-id="264278">bjorn3</span> although for some reason only first two arguments work, trying to use a third one still causes a segfault.</p>
</blockquote>
<p>did you push your changes?</p>



<a name="262947730"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262947730" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ivan Chinenov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262947730">(Nov 28 2021 at 20:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="264278">bjorn3</span> <a href="#narrow/stream/217117-cranelift/topic/thread.20'main'.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E/near/262947518">said</a>:</p>
<blockquote>
<p>store and load work just fine with i64. cranelift ir uses i64 as pointer type on 64bit systems. r64 exists for when you have a garbage collector that needs to know where on the stack it can find roots. Every r64 value is considered a root.</p>
</blockquote>
<p>That's certainly nice to know.</p>



<a name="262947748"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262947748" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ivan Chinenov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262947748">(Nov 28 2021 at 20:59)</a>:</h4>
<p><span class="user-mention" data-user-id="264278">@bjorn3</span> <a href="#narrow/stream/217117-cranelift/topic/thread.20'main'.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E/near/262947528">said</a>:</p>
<blockquote>
<blockquote>
<p><span class="user-mention silent" data-user-id="264278">bjorn3</span> although for some reason only first two arguments work, trying to use a third one still causes a segfault.</p>
</blockquote>
<p>did you push your changes?</p>
</blockquote>
<p>I have now, although that shouldn't affect anything.</p>



<a name="262948142"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262948142" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262948142">(Nov 28 2021 at 21:05)</a>:</h4>
<p>The code to call into the jitted code looks correct now. I can't find anything obviously wrong with the argument handling in the  jitted code either right now.</p>



<a name="262948259"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262948259" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ivan Chinenov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262948259">(Nov 28 2021 at 21:07)</a>:</h4>
<p><span class="user-mention" data-user-id="264278">@bjorn3</span>  Another thing, am I using memflags right?</p>



<a name="262948426"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262948426" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ivan Chinenov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262948426">(Nov 28 2021 at 21:11)</a>:</h4>
<p>As in, everything should be aligned, right?</p>



<a name="262949101"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262949101" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262949101">(Nov 28 2021 at 21:25)</a>:</h4>
<p>Yeah, the stackslot should be 16 bytes aligned and the array 8 bytes aligned. All loads only need 8 bytes alignment and load at a multiple of 8 offset from the start of the array, so everything should be aligned just fine.</p>



<a name="262949182"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262949182" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262949182">(Nov 28 2021 at 21:27)</a>:</h4>
<p>If it isn't aligned, you won't notice anything going wrong on x86 by the way unless you try to load or store floats or vectors. Cranelift itself doesn't have any optimization that will cause unaligned accesses to misbehave if the underlying CPU allows them.</p>



<a name="262965405"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/thread%20%27main%27%20panicked%20at%20function%20must%20be%20compiled.../near/262965405" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/thread.20.27main.27.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E.html#262965405">(Nov 29 2021 at 04:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="264278">bjorn3</span> <a href="#narrow/stream/217117-cranelift/topic/thread.20'main'.20panicked.20at.20function.20must.20be.20compiled.2E.2E.2E/near/262895157">said</a>:</p>
<blockquote>
<p>The <code>raw_bitcast.r64</code> may be the problem. The register allocator has some problems with dealing with this kind of construct. <span class="user-mention silent" data-user-id="254389">Chris Fallin</span> regalloc2 fixes this once it gets merged, right?</p>
</blockquote>
<p>Not directly but at least puts us in a better place to fix this. <code>raw_bitcast</code> in general is a hack and I'd prefer to have real ref-to-int and int-to-ref operators; but right now, you're right (and apologies <span class="user-mention" data-user-id="455945">@Ivan Chinenov</span> ) the way that reference-typed values work is mostly filled out just enough to support Wasm reference types, which are completely opaque and never cast to/from ints or pointers within the Cranelift-compiled code, only carried through and passed back out.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>