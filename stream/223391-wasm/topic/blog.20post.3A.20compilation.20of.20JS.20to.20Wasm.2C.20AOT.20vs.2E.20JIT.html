<html>
<head><meta charset="utf-8"><title>blog post: compilation of JS to Wasm, AOT vs. JIT · wasm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/223391-wasm/index.html">wasm</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/223391-wasm/topic/blog.20post.3A.20compilation.20of.20JS.20to.20Wasm.2C.20AOT.20vs.2E.20JIT.html">blog post: compilation of JS to Wasm, AOT vs. JIT</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="465484913"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/223391-wasm/topic/blog%20post%3A%20compilation%20of%20JS%20to%20Wasm%2C%20AOT%20vs.%20JIT/near/465484913" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/223391-wasm/topic/blog.20post.3A.20compilation.20of.20JS.20to.20Wasm.2C.20AOT.20vs.2E.20JIT.html#465484913">(Aug 27 2024 at 15:34)</a>:</h4>
<p>I've just posted a blog post here: <a href="https://cfallin.org/blog/2024/08/27/aot-js/">https://cfallin.org/blog/2024/08/27/aot-js/</a></p>
<p>(this is the first in a pair of posts about the weval-based JS compilation work I've been doing; second half will come tomorrow)</p>



<a name="465760095"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/223391-wasm/topic/blog%20post%3A%20compilation%20of%20JS%20to%20Wasm%2C%20AOT%20vs.%20JIT/near/465760095" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/223391-wasm/topic/blog.20post.3A.20compilation.20of.20JS.20to.20Wasm.2C.20AOT.20vs.2E.20JIT.html#465760095">(Aug 28 2024 at 13:00)</a>:</h4>
<p>as it was morning here, I'm WAITING, CHRIS</p>



<a name="465811849"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/223391-wasm/topic/blog%20post%3A%20compilation%20of%20JS%20to%20Wasm%2C%20AOT%20vs.%20JIT/near/465811849" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/223391-wasm/topic/blog.20post.3A.20compilation.20of.20JS.20to.20Wasm.2C.20AOT.20vs.2E.20JIT.html#465811849">(Aug 28 2024 at 16:41)</a>:</h4>
<p>Unfortunately my blog is only open 9am-5pm Pacific time, weekdays, with federal holidays and other random vacations excluded; your request is being processed :-)</p>



<a name="465812093"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/223391-wasm/topic/blog%20post%3A%20compilation%20of%20JS%20to%20Wasm%2C%20AOT%20vs.%20JIT/near/465812093" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/223391-wasm/topic/blog.20post.3A.20compilation.20of.20JS.20to.20Wasm.2C.20AOT.20vs.2E.20JIT.html#465812093">(Aug 28 2024 at 16:42)</a>:</h4>
<p>Alright, a followup with the next part, about weval itself: <a href="https://cfallin.org/blog/2024/08/28/weval/">https://cfallin.org/blog/2024/08/28/weval/</a></p>



<a name="466163496"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/223391-wasm/topic/blog%20post%3A%20compilation%20of%20JS%20to%20Wasm%2C%20AOT%20vs.%20JIT/near/466163496" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Victor Adossi <a href="https://bytecodealliance.github.io/zulip-archive/stream/223391-wasm/topic/blog.20post.3A.20compilation.20of.20JS.20to.20Wasm.2C.20AOT.20vs.2E.20JIT.html#466163496">(Aug 30 2024 at 05:27)</a>:</h4>
<p>I think you might be out of business hours right now but  ahumble feature request for your blog: automatic dark mode</p>



<a name="466165935"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/223391-wasm/topic/blog%20post%3A%20compilation%20of%20JS%20to%20Wasm%2C%20AOT%20vs.%20JIT/near/466165935" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/223391-wasm/topic/blog.20post.3A.20compilation.20of.20JS.20to.20Wasm.2C.20AOT.20vs.2E.20JIT.html#466165935">(Aug 30 2024 at 05:47)</a>:</h4>
<p>if anyone can tell me how to do that with a hacked up Jekyll site generator tree from 2014, that only works with a very specific version of Ruby and various gems locked in place via nix-shell, I'm all ears!</p>



<a name="466165950"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/223391-wasm/topic/blog%20post%3A%20compilation%20of%20JS%20to%20Wasm%2C%20AOT%20vs.%20JIT/near/466165950" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/223391-wasm/topic/blog.20post.3A.20compilation.20of.20JS.20to.20Wasm.2C.20AOT.20vs.2E.20JIT.html#466165950">(Aug 30 2024 at 05:47)</a>:</h4>
<p>(my html skills are current circa 1998)</p>



<a name="466288702"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/223391-wasm/topic/blog%20post%3A%20compilation%20of%20JS%20to%20Wasm%2C%20AOT%20vs.%20JIT/near/466288702" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/223391-wasm/topic/blog.20post.3A.20compilation.20of.20JS.20to.20Wasm.2C.20AOT.20vs.2E.20JIT.html#466288702">(Aug 30 2024 at 15:04)</a>:</h4>
<p>Specific Jekyll and specific ruby version, both outdated, is way too real <span aria-label="sob" class="emoji emoji-1f62d" role="img" title="sob">:sob:</span></p>



<a name="466291098"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/223391-wasm/topic/blog%20post%3A%20compilation%20of%20JS%20to%20Wasm%2C%20AOT%20vs.%20JIT/near/466291098" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Milan <a href="https://bytecodealliance.github.io/zulip-archive/stream/223391-wasm/topic/blog.20post.3A.20compilation.20of.20JS.20to.20Wasm.2C.20AOT.20vs.2E.20JIT.html#466291098">(Aug 30 2024 at 15:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="254389">Chris Fallin</span> <a href="#narrow/stream/223391-wasm/topic/blog.20post.3A.20compilation.20of.20JS.20to.20Wasm.2C.20AOT.20vs.2E.20JIT/near/466165935">said</a>:</p>
<blockquote>
<p>if anyone can tell me how to do that with a hacked up Jekyll site generator tree from 2014, that only works with a very specific version of Ruby and various gems locked in place via nix-shell, I'm all ears!</p>
</blockquote>
<p>FWIW, it is a CSS only change to be responsive to the system light-dark preference. Override the styles for the <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/@media/prefers-color-scheme#examples">prefers-color-scheme</a> media query :)</p>
<div class="message_embed"><a class="message_embed_image" href="https://developer.mozilla.org/en-US/docs/Web/CSS/@media/prefers-color-scheme#examples" style="background-image: url(&quot;https://uploads.zulipusercontent.net/d1458923d9e958200387f84e96afd92a33caed8b/68747470733a2f2f646576656c6f7065722e6d6f7a696c6c612e6f72672f6d646e2d736f6369616c2d73686172652e63643663346135612e706e67&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/@media/prefers-color-scheme#examples" title="prefers-color-scheme - CSS: Cascading Style Sheets | MDN">prefers-color-scheme - CSS: Cascading Style Sheets | MDN</a></div><div class="message_embed_description">The prefers-color-scheme CSS media feature is used to detect if a user has requested light or dark color themes.
  A user indicates their preference through an operating system setting (e.g. light or dark mode) or a user agent setting.</div></div></div>



<a name="466425827"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/223391-wasm/topic/blog%20post%3A%20compilation%20of%20JS%20to%20Wasm%2C%20AOT%20vs.%20JIT/near/466425827" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Victor Adossi <a href="https://bytecodealliance.github.io/zulip-archive/stream/223391-wasm/topic/blog.20post.3A.20compilation.20of.20JS.20to.20Wasm.2C.20AOT.20vs.2E.20JIT.html#466425827">(Aug 31 2024 at 02:49)</a>:</h4>
<p>The trick for that being... you'll have to reconfigure all those styles :)</p>
<p>Also if the source is open I'm happy to contribute!</p>



<a name="466434506"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/223391-wasm/topic/blog%20post%3A%20compilation%20of%20JS%20to%20Wasm%2C%20AOT%20vs.%20JIT/near/466434506" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Victor Adossi <a href="https://bytecodealliance.github.io/zulip-archive/stream/223391-wasm/topic/blog.20post.3A.20compilation.20of.20JS.20to.20Wasm.2C.20AOT.20vs.2E.20JIT.html#466434506">(Aug 31 2024 at 03:48)</a>:</h4>
<p>Wow just realized my own blog didn't have it, and it was amazingly easy to add with <code>prefers-color-scheme</code>. CSS in 2024, amazing</p>



<a name="468534959"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/223391-wasm/topic/blog%20post%3A%20compilation%20of%20JS%20to%20Wasm%2C%20AOT%20vs.%20JIT/near/468534959" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://bytecodealliance.github.io/zulip-archive/stream/223391-wasm/topic/blog.20post.3A.20compilation.20of.20JS.20to.20Wasm.2C.20AOT.20vs.2E.20JIT.html#468534959">(Sep 08 2024 at 09:04)</a>:</h4>
<p>These blog posts aren't for the faint of heart. I think I've read the "JavaScript compilation" parts 1 and 2 about three times already and I'm still a bit hazy on the details.</p>



<a name="468536464"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/223391-wasm/topic/blog%20post%3A%20compilation%20of%20JS%20to%20Wasm%2C%20AOT%20vs.%20JIT/near/468536464" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://bytecodealliance.github.io/zulip-archive/stream/223391-wasm/topic/blog.20post.3A.20compilation.20of.20JS.20to.20Wasm.2C.20AOT.20vs.2E.20JIT.html#468536464">(Sep 08 2024 at 09:16)</a>:</h4>
<p>Looking at the second post, I'm still confused about how pre-compiling a corpus of ICs can possibly work for object shapes.</p>



<a name="468537314"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/223391-wasm/topic/blog%20post%3A%20compilation%20of%20JS%20to%20Wasm%2C%20AOT%20vs.%20JIT/near/468537314" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://bytecodealliance.github.io/zulip-archive/stream/223391-wasm/topic/blog.20post.3A.20compilation.20of.20JS.20to.20Wasm.2C.20AOT.20vs.2E.20JIT.html#468537314">(Sep 08 2024 at 09:21)</a>:</h4>
<p>Says I have this code:</p>
<div class="codehilite" data-code-language="JavaScript"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">foo</span><span class="o">:</span><span class="w"> </span><span class="mf">42</span><span class="p">,</span><span class="w"> </span><span class="nx">bar</span><span class="o">:</span><span class="w"> </span><span class="s2">"Hello world"</span><span class="w"> </span><span class="p">};</span>

<span class="c1">// ...</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">obj</span><span class="p">.</span><span class="nx">foo</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">3</span><span class="p">;</span>
</code></pre></div>
<p>To properly optimize this code, the JIT needs the following information:</p>
<ul>
<li><code>obj</code> has the shape (Number, String).</li>
<li><code>foo</code> is the first element of that shape.</li>
<li>Therefore <code>obj.foo</code> is a Number.</li>
</ul>



<a name="468538226"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/223391-wasm/topic/blog%20post%3A%20compilation%20of%20JS%20to%20Wasm%2C%20AOT%20vs.%20JIT/near/468538226" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://bytecodealliance.github.io/zulip-archive/stream/223391-wasm/topic/blog.20post.3A.20compilation.20of.20JS.20to.20Wasm.2C.20AOT.20vs.2E.20JIT.html#468538226">(Sep 08 2024 at 09:29)</a>:</h4>
<p>How can you possibly encode this in pre-compiled ICs? What do the ICs look like? I can imagine an IC that's like:</p>
<div class="codehilite" data-code-language="txt"><pre><span></span><code>GuardShape obj, (Number, String)
GuardField obj, "foo", 0
LoadNumberField obj, 0
</code></pre></div>
<p>But then wouldn't you need thousands of ICs for any field access anywhere in your code? Even if you're only covering shapes with up to four fields that's already thousands of possible shapes. Doing a linked list search through those can't possibly be more efficient that a hashmap access.</p>



<a name="468543346"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/223391-wasm/topic/blog%20post%3A%20compilation%20of%20JS%20to%20Wasm%2C%20AOT%20vs.%20JIT/near/468543346" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://bytecodealliance.github.io/zulip-archive/stream/223391-wasm/topic/blog.20post.3A.20compilation.20of.20JS.20to.20Wasm.2C.20AOT.20vs.2E.20JIT.html#468543346">(Sep 08 2024 at 10:10)</a>:</h4>
<p>Second question</p>



<a name="468543794"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/223391-wasm/topic/blog%20post%3A%20compilation%20of%20JS%20to%20Wasm%2C%20AOT%20vs.%20JIT/near/468543794" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://bytecodealliance.github.io/zulip-archive/stream/223391-wasm/topic/blog.20post.3A.20compilation.20of.20JS.20to.20Wasm.2C.20AOT.20vs.2E.20JIT.html#468543794">(Sep 08 2024 at 10:13)</a>:</h4>
<p>Regarding weval, I'm a little surprised you had to go through so much trouble with the <code>update_context</code> intrinsic.</p>



<a name="468543800"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/223391-wasm/topic/blog%20post%3A%20compilation%20of%20JS%20to%20Wasm%2C%20AOT%20vs.%20JIT/near/468543800" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://bytecodealliance.github.io/zulip-archive/stream/223391-wasm/topic/blog.20post.3A.20compilation.20of.20JS.20to.20Wasm.2C.20AOT.20vs.2E.20JIT.html#468543800">(Sep 08 2024 at 10:13)</a>:</h4>
<p>Does SpiderMonkey's bytecode not have a concept of EBBs? Because if so, it feels like you could just have a <code>run_ebb</code> function that takes a slice of bytecode instructions as a parameter and loops over them, and add an annotation to unroll that loop.</p>



<a name="468543946"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/223391-wasm/topic/blog%20post%3A%20compilation%20of%20JS%20to%20Wasm%2C%20AOT%20vs.%20JIT/near/468543946" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://bytecodealliance.github.io/zulip-archive/stream/223391-wasm/topic/blog.20post.3A.20compilation.20of.20JS.20to.20Wasm.2C.20AOT.20vs.2E.20JIT.html#468543946">(Sep 08 2024 at 10:15)</a>:</h4>
<p>(Plus the annotation you currently use to mark that slice as constant.)</p>



<a name="468580578"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/223391-wasm/topic/blog%20post%3A%20compilation%20of%20JS%20to%20Wasm%2C%20AOT%20vs.%20JIT/near/468580578" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/223391-wasm/topic/blog.20post.3A.20compilation.20of.20JS.20to.20Wasm.2C.20AOT.20vs.2E.20JIT.html#468580578">(Sep 08 2024 at 14:40)</a>:</h4>
<p>I believe polymorphic inline caches can have arguments which indicate eg the offset of the field to access and the expected type and then the inline cache itself would use those arguments instead of hard coding them. This allows generating a single polymorphic inline cache for each shape of inline cache we want rather than fully specializing it.</p>



<a name="468585546"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/223391-wasm/topic/blog%20post%3A%20compilation%20of%20JS%20to%20Wasm%2C%20AOT%20vs.%20JIT/near/468585546" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://bytecodealliance.github.io/zulip-archive/stream/223391-wasm/topic/blog.20post.3A.20compilation.20of.20JS.20to.20Wasm.2C.20AOT.20vs.2E.20JIT.html#468585546">(Sep 08 2024 at 15:22)</a>:</h4>
<blockquote>
<p>This allows generating a single polymorphic inline cache for each shape of inline cache</p>
</blockquote>
<p>If the field offset and type are passed as arguments, I'm not sure I have a model of what you mean by "each shape of inline cache" here.</p>



<a name="468632901"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/223391-wasm/topic/blog%20post%3A%20compilation%20of%20JS%20to%20Wasm%2C%20AOT%20vs.%20JIT/near/468632901" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/223391-wasm/topic/blog.20post.3A.20compilation.20of.20JS.20to.20Wasm.2C.20AOT.20vs.2E.20JIT.html#468632901">(Sep 08 2024 at 21:36)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="354194">@Olivier FAURE</span> , I'd recommend you read the 2023 paper on CacheIR, linked in my blog posts, for more information on how that part of SpiderMonkey works.</p>
<p>In a little more detail: your conception of what an "object shape" is is a little off, and also you're missing the notion of parameterized ICs. The idea is that the IC <em>code</em> is constant, and known ahead of time, but it is parameterized on runtime values in the "stub data" that are attached when the IC chain is filled out. The IC for a simple property access (no weird corner cases) is: check the shape pointer (encodes mapping from field names to offsets); load offset. And both the shape pointer and offset are in teh stub data, so we have <em>one</em> IC body that we can use for every property access everywhere.</p>



<a name="468633013"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/223391-wasm/topic/blog%20post%3A%20compilation%20of%20JS%20to%20Wasm%2C%20AOT%20vs.%20JIT/near/468633013" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/223391-wasm/topic/blog.20post.3A.20compilation.20of.20JS.20to.20Wasm.2C.20AOT.20vs.2E.20JIT.html#468633013">(Sep 08 2024 at 21:38)</a>:</h4>
<p>Re: SpiderMonkey bytecode and EBBs: I think there may be such a property but it's fairly irrelevant: the entire point of the weval-based approach is that we do <em>not</em> know anything about the interpreter or the code it's interpreting, beyond the one intrinsic to denote "change of PC". More complex intermeshing of properties limits the scope of applicability and makes reasoning about bugs much harder.</p>



<a name="469191114"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/223391-wasm/topic/blog%20post%3A%20compilation%20of%20JS%20to%20Wasm%2C%20AOT%20vs.%20JIT/near/469191114" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Catherine (whitequark) <a href="https://bytecodealliance.github.io/zulip-archive/stream/223391-wasm/topic/blog.20post.3A.20compilation.20of.20JS.20to.20Wasm.2C.20AOT.20vs.2E.20JIT.html#469191114">(Sep 10 2024 at 19:22)</a>:</h4>
<p><span class="user-mention" data-user-id="254389">@Chris Fallin</span> The weval transform is incredibly cool. Some of my earlier work (on Foundry and ARTIQ) used similar principles, but it didn't go as far, and I'm really happy to see this research. I hope one day I'll be able to apply it.</p>



<a name="480916183"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/223391-wasm/topic/blog%20post%3A%20compilation%20of%20JS%20to%20Wasm%2C%20AOT%20vs.%20JIT/near/480916183" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://bytecodealliance.github.io/zulip-archive/stream/223391-wasm/topic/blog.20post.3A.20compilation.20of.20JS.20to.20Wasm.2C.20AOT.20vs.2E.20JIT.html#480916183">(Nov 06 2024 at 13:06)</a>:</h4>
<p>So, reading the 2023 paper...</p>
<blockquote>
<p>In addition to operands, CacheIR stubs have stub fields, which are values associated with and used within the stub. For Baseline ICs, stub fields facilitate the sharing of native code for stubs that are identical except for offsets and pointer values, and simplify the process of integrating stubs into the garbage collector.</p>
</blockquote>
<p>So... My understanding of what happens when you execute <code>let x = foo.bar</code>:</p>
<ul>
<li>The interpreter / compiled code reaches a dynamic jump instruction pointing to the IC chain.</li>
<li>The first stub in the IC chain has a pointer to some x86/ARM/etc code which is jumped to.</li>
<li>The code starts with some "guard" instructions that checks that the <code>foo</code> object has the expected shape/hidden-class/etc. "Shape" in that context means a specific set of field names and types, so if the IC was generated for a shape <code>baz: Number, bar: Object</code> and foo currently has shape <code>baz: String, bar: Object</code>, you're out of luck, even though the binary code would work the same in principle. (On the plus side, because shapes are immutable, that check is a single pointer compare.)</li>
<li>If the guard instruction exits, it jumps to the next IC in the chain.</li>
<li>If the guard instruction fall through, the rest of the IC's binary is executed. In that case, the binary being executed is "add an offset to the base pointer, load the resulting address, return the value to the main code".</li>
</ul>
<p>Regarding stub fields specifically, the IC stub includes both a pointer to x86 executable code, and some additional variables that the executable code can read; in the case of the field access above, those additional variables are "a pointer to the immutable shape, and a field offset".</p>



<a name="480917037"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/223391-wasm/topic/blog%20post%3A%20compilation%20of%20JS%20to%20Wasm%2C%20AOT%20vs.%20JIT/near/480917037" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://bytecodealliance.github.io/zulip-archive/stream/223391-wasm/topic/blog.20post.3A.20compilation.20of.20JS.20to.20Wasm.2C.20AOT.20vs.2E.20JIT.html#480917037">(Nov 06 2024 at 13:11)</a>:</h4>
<p>So to answer my own question, the "executable code" parts of the ICs can be precompiled because they're massively shared between ICs. Even if your program has thousands of shapes, it only needs one <code>brneq reg1 reg2; load reg1+reg3; ret;</code> chunk of executable code. Each callsite can store pointers to that code alongside different values for reg2 (shape pointer) and reg3 (offset), and <em>these</em> values can be generated dynamically.</p>



<a name="480947388"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/223391-wasm/topic/blog%20post%3A%20compilation%20of%20JS%20to%20Wasm%2C%20AOT%20vs.%20JIT/near/480947388" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/223391-wasm/topic/blog.20post.3A.20compilation.20of.20JS.20to.20Wasm.2C.20AOT.20vs.2E.20JIT.html#480947388">(Nov 06 2024 at 15:38)</a>:</h4>
<p>Yep, that’s pretty much it!</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>