<html>
<head><meta charset="utf-8"><title>✔ component Linker and instantiate · wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/index.html">wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html">✔ component Linker and instantiate</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="374044511"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374044511" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374044511">(Jul 10 2023 at 18:00)</a>:</h4>
<p>Maybe it's too early to try this, but I am trying to create an export in Rust and link it as a component to  a Wasm module with this</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">wasmtime</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Configure an `Engine` and compile the `Component` that is being run for</span>
<span class="w">    </span><span class="c1">// the application.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">wasm_component_model</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span>::<span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="s">"./cswasi.wasm"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="w">    </span><span class="n">HelloWorld</span>::<span class="n">add_to_linker</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">state</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">MyState</span><span class="o">|</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span>
<span class="w">        </span><span class="n">MyState</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">name</span>: <span class="mi">1</span><span class="k">f32</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">bindings</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HelloWorld</span>::<span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">linker</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</code></pre></div>
<p>which is wrong, for starters <code>instantiate</code> doesn't take the module but the component.  Is this too early, or can I modify this to work?</p>



<a name="374044951"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374044951" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374044951">(Jul 10 2023 at 18:02)</a>:</h4>
<p>preceeding code is </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">bindgen</span><span class="o">!</span><span class="p">();</span>

<span class="k">struct</span> <span class="nc">MyState</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">name</span>: <span class="kt">f32</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1">// Imports into the world, like the `name` import for this world, are satisfied</span>
<span class="c1">// through traits.</span>
<span class="k">impl</span><span class="w"> </span><span class="n">HelloWorldImports</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyState</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Note the `Result` return value here where `Ok` is returned back to</span>
<span class="w">    </span><span class="c1">// the component and `Err` will raise a trap.S</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">name</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="kt">f32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">wasmtime</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Hello from rust {}"</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">);</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>and the wit</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">package</span><span class="w"> </span><span class="n">my</span>:<span class="nc">project</span>

<span class="n">world</span><span class="w"> </span><span class="n">hello</span><span class="o">-</span><span class="n">world</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">import</span><span class="w"> </span><span class="n">name</span>: <span class="nc">func</span><span class="p">(</span><span class="n">f</span>: <span class="nc">float32</span><span class="p">)</span>
<span class="w">    </span><span class="n">export</span><span class="w"> </span><span class="n">greet</span>: <span class="nc">func</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>



<a name="374047593"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374047593" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Guy Bedford <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374047593">(Jul 10 2023 at 18:13)</a>:</h4>
<p><span class="user-mention" data-user-id="395878">@Scott Waye</span> this should work, but you want <code>let component = Component::from_binary(&amp;engine, &amp;component_bytes).unwrap();</code></p>



<a name="374047917"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374047917" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Guy Bedford <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374047917">(Jul 10 2023 at 18:15)</a>:</h4>
<p>I haven't personally been able to figure out function imports yet, but instances with functions can be added eg via</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">iface_instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linker</span><span class="p">.</span><span class="n">instance</span><span class="p">(</span><span class="s">"iface"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="n">iface_instance</span><span class="p">.</span><span class="n">func_wrap</span><span class="p">(</span><span class="s">"name"</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">_store</span><span class="p">,</span><span class="w"> </span><span class="n">params</span>: <span class="p">(</span><span class="kt">f32</span><span class="p">,)</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">})</span><span class="o">?</span><span class="p">;</span>
</code></pre></div>
<p>For the WIT:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">import</span><span class="w"> </span><span class="n">iface</span>: <span class="nc">interface</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">name</span>: <span class="nc">func</span><span class="p">(</span><span class="n">f</span>: <span class="nc">float32</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>



<a name="374048049"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374048049" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Guy Bedford <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374048049">(Jul 10 2023 at 18:15)</a>:</h4>
<p>also depending on how you produce the component you may need to include the wasi bindings</p>



<a name="374048182"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374048182" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Guy Bedford <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374048182">(Jul 10 2023 at 18:16)</a>:</h4>
<p>there's a wasi linking example in <a href="https://github.com/bytecodealliance/componentize-js/blob/main/example/src/main.rs">https://github.com/bytecodealliance/componentize-js/blob/main/example/src/main.rs</a> if it helps</p>



<a name="374049396"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374049396" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374049396">(Jul 10 2023 at 18:21)</a>:</h4>
<p>for plain function imports which are not inside an instance, <code>linker.root()</code> gives you the root namespace, as a substitute to linker.instance("name")?</p>



<a name="374049713"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374049713" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Guy Bedford <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374049713">(Jul 10 2023 at 18:23)</a>:</h4>
<p>ah nice, I wasn't aware of that</p>



<a name="374050934"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374050934" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374050934">(Jul 10 2023 at 18:28)</a>:</h4>
<p>If my terminology is right, I thought the component would be produced by the <code>bindgen!</code> macro and the <code>impl</code>.  I want to export from rust, so I change the wit to </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">world</span><span class="w"> </span><span class="n">hello</span><span class="o">-</span><span class="n">world</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">export</span><span class="w"> </span><span class="n">name</span>: <span class="nc">func</span><span class="p">(</span><span class="n">f</span>: <span class="nc">float32</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>but what is the trait name, I tried HelloWorld and HelloWorldExports and neither compiles.  or if I <code>func_wrap</code> do I not need the trait?</p>



<a name="374051103"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374051103" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374051103">(Jul 10 2023 at 18:29)</a>:</h4>
<p>the trait should be named <code>Host</code></p>



<a name="374051356"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374051356" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374051356">(Jul 10 2023 at 18:30)</a>:</h4>
<p>i'm not sure off the top of my head what module it lives in. i usually run <code>cargo doc</code> when i need to figure out what got generated.</p>



<a name="374051730"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374051730" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374051730">(Jul 10 2023 at 18:32)</a>:</h4>
<p>the componentize-js example looks interesting, I guess I should be getting some wasm generated by the macro which I need to <code> let component = Component::from_file(&amp;engine, "hello.component.wasm").unwrap();</code></p>



<a name="374051862"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374051862" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374051862">(Jul 10 2023 at 18:32)</a>:</h4>
<p>no wait, that can't be right</p>



<a name="374052061"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374052061" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374052061">(Jul 10 2023 at 18:33)</a>:</h4>
<p>let me try <code>linker.root</code></p>



<a name="374059293"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374059293" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374059293">(Jul 10 2023 at 19:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="253992">Pat Hickey</span> <a href="#narrow/stream/217126-wasmtime/topic/component.20Linker.20and.20instantiate/near/374051103">said</a>:</p>
<blockquote>
<p>the trait should be named <code>Host</code></p>
</blockquote>
<p>WHere does the string <code>Host</code> come from, is that hard coded somewhere as it is not in my rust or wit?</p>



<a name="374059520"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374059520" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374059520">(Jul 10 2023 at 19:03)</a>:</h4>
<p>and I get </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span><span class="p">[</span><span class="n">E0405</span><span class="p">]</span>: <span class="nc">cannot</span><span class="w"> </span><span class="n">find</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="err">`</span><span class="n">Host</span><span class="err">`</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">scope</span>
<span class="w">  </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="err">\</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">12</span>:<span class="mi">6</span>
<span class="w">   </span><span class="o">|</span>
<span class="mi">12</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyState</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="o">|</span><span class="w">      </span><span class="o">^^^^</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">scope</span>
</code></pre></div>



<a name="374060034"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374060034" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374060034">(Jul 10 2023 at 19:05)</a>:</h4>
<p>every trait generated by wasmtime::component::bindgen! is named <code>Host</code>, but they end up in different modules to differentiate them</p>



<a name="374060228"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374060228" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374060228">(Jul 10 2023 at 19:06)</a>:</h4>
<p>im not sure what module the root ends up in (and maybe it doesnt, which would be a bug) - that was what i was suggesting cargo doc to explore</p>



<a name="374060287"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374060287" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374060287">(Jul 10 2023 at 19:06)</a>:</h4>
<p>try <code>hello_world::Host</code> i suppose</p>



<a name="374060345"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374060345" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374060345">(Jul 10 2023 at 19:07)</a>:</h4>
<p>I see, unfortunately <code>cargo doc</code>errors with </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="n">Documenting</span><span class="w"> </span><span class="n">cs</span><span class="o">-</span><span class="n">runtime</span><span class="o">-</span><span class="n">example</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">1.0</span><span class="w"> </span><span class="p">(</span><span class="n">C</span>:<span class="err">\</span><span class="n">github</span><span class="err">\</span><span class="n">cs</span><span class="o">-</span><span class="n">runtime</span><span class="o">-</span><span class="n">example</span><span class="o">-</span><span class="n">wasmtime</span><span class="p">)</span>
<span class="n">error</span><span class="p">[</span><span class="n">E0405</span><span class="p">]</span>: <span class="nc">cannot</span><span class="w"> </span><span class="n">find</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="err">`</span><span class="n">Host</span><span class="err">`</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">scope</span>
<span class="w">  </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="err">\</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">12</span>:<span class="mi">6</span>
<span class="w">   </span><span class="o">|</span>
<span class="mi">12</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyState</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="o">|</span><span class="w">      </span><span class="o">^^^^</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">scope</span>

<span class="n">For</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">information</span><span class="w"> </span><span class="n">about</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="kr">try</span><span class="w"> </span><span class="err">`</span><span class="n">rustc</span><span class="w"> </span><span class="o">--</span><span class="n">explain</span><span class="w"> </span><span class="n">E0405</span><span class="err">`</span><span class="p">.</span>
</code></pre></div>



<a name="374060393"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374060393" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374060393">(Jul 10 2023 at 19:07)</a>:</h4>
<p>oh, you'll have to comment out the parts of your code that dont typecheck yet</p>



<a name="374060481"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374060481" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374060481">(Jul 10 2023 at 19:07)</a>:</h4>
<p>it should be sufficient to just run bindgen in an otherwise empty crate and see the docs of it</p>



<a name="374062218"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374062218" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374062218">(Jul 10 2023 at 19:15)</a>:</h4>
<p>thanks, <code>doc</code> has completed, but I dont thinkg the trait was generated as a grep for Host in <code>cs-runtime-example-wasmtime\target\doc\cs_runtime_example</code> revealed no hits<br>
<a href="/user_uploads/15107/CXwQzFrmm1b67TsJK-ygD7Qe/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/15107/CXwQzFrmm1b67TsJK-ygD7Qe/image.png" title="image.png"><img src="/user_uploads/15107/CXwQzFrmm1b67TsJK-ygD7Qe/image.png"></a></div>



<a name="374063876"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374063876" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374063876">(Jul 10 2023 at 19:22)</a>:</h4>
<p>oh, ok. i had gotten <code>import</code> and <code>export</code> mixed up when i read your example.</p>



<a name="374064004"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374064004" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374064004">(Jul 10 2023 at 19:23)</a>:</h4>
<p><code>export name: func...</code> means that the HelloWorld struct will have a <code>run_name</code> method.</p>



<a name="374064123"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374064123" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374064123">(Jul 10 2023 at 19:24)</a>:</h4>
<p>try adding <code>import name2: func...</code> and then hopefully itll generate a trait</p>



<a name="374064457"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374064457" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374064457">(Jul 10 2023 at 19:25)</a>:</h4>
<p>wasmtime is defining the implementation of a world, so the traits provide the implementations of imports, and methods on the world struct are used to call exports, which are implemented in the Component</p>



<a name="374082423"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374082423" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374082423">(Jul 10 2023 at 20:56)</a>:</h4>
<p>Thanks, that does indeed generate the trait, in my case I want the rust to be the component and provide the method which will be called by a wasm module, at least that is what I'm trying to do.  So if I'm reading your last comment right.  I don't need the export, I just need the import.</p>



<a name="374120056"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374120056" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374120056">(Jul 11 2023 at 01:54)</a>:</h4>
<p>I'm trying something which I hope is simpler, wrapping a function in the root namespace.  I'm going to need a componet::Linker I think, but looking at <a href="https://github.com/bytecodealliance/componentize-js/blob/4afe77879cef8154f4c8671a61ffbd3d651fc251/example/src/main.rs#L27">https://github.com/bytecodealliance/componentize-js/blob/4afe77879cef8154f4c8671a61ffbd3d651fc251/example/src/main.rs#L27</a> that would seem easy, but for me I get</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">cs</span><span class="o">-</span><span class="n">runtime</span><span class="o">-</span><span class="n">example</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">1.0</span><span class="w"> </span><span class="p">(</span><span class="n">C</span>:<span class="err">\</span><span class="n">github</span><span class="err">\</span><span class="n">cs</span><span class="o">-</span><span class="n">runtime</span><span class="o">-</span><span class="n">example</span><span class="o">-</span><span class="n">wasmtime</span><span class="p">)</span>
<span class="n">error</span><span class="p">[</span><span class="n">E0282</span><span class="p">]</span>: <span class="nc">type</span><span class="w"> </span><span class="n">annotations</span><span class="w"> </span><span class="n">needed</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="err">`</span><span class="n">wasmtime</span>::<span class="n">component</span>::<span class="n">Linker</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="err">`</span>
<span class="w">  </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="err">\</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">36</span>:<span class="mi">9</span>
<span class="w">   </span><span class="o">|</span>
<span class="mi">36</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="w">   </span><span class="o">|</span><span class="w">         </span><span class="o">^^^^^^^^^^</span>
<span class="w">   </span><span class="o">|</span>
<span class="n">help</span>: <span class="nc">consider</span><span class="w"> </span><span class="n">giving</span><span class="w"> </span><span class="err">`</span><span class="n">linker</span><span class="err">`</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">explicit</span><span class="w"> </span><span class="k">type</span><span class="p">,</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">type</span> <span class="nc">for</span><span class="w"> </span><span class="k">type</span> <span class="nc">parameter</span><span class="w"> </span><span class="err">`</span><span class="n">T</span><span class="err">`</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">specified</span>
<span class="w">   </span><span class="o">|</span>
<span class="mi">36</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span>: <span class="nc">wasmtime</span>::<span class="n">component</span>::<span class="n">Linker</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="w">   </span><span class="o">|</span><span class="w">                   </span><span class="o">++++++++++++++++++++++++++++++++</span>

<span class="n">For</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">information</span><span class="w"> </span><span class="n">about</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="kr">try</span><span class="w"> </span><span class="err">`</span><span class="n">rustc</span><span class="w"> </span><span class="o">--</span><span class="n">explain</span><span class="w"> </span><span class="n">E0282</span><span class="err">`</span><span class="p">.</span>
</code></pre></div>
<p>What type should be given to the variable?</p>



<a name="374129547"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374129547" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374129547">(Jul 11 2023 at 03:27)</a>:</h4>
<p>Maybe I dont need that looking at other examples.  I now have</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">world</span><span class="w"> </span><span class="n">hello</span><span class="o">-</span><span class="n">world</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">import</span><span class="w"> </span><span class="n">name2</span>: <span class="nc">func</span><span class="w"> </span><span class="p">(</span><span class="n">f</span>: <span class="nc">float32</span><span class="p">)</span>
<span class="w">    </span><span class="n">export</span><span class="w"> </span><span class="n">name</span>: <span class="nc">func</span><span class="p">(</span><span class="n">f</span>: <span class="nc">float32</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>and</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">wasmtime</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Configure an `Engine` and compile the `Component` that is being run for</span>
<span class="w">    </span><span class="c1">// the application.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">wasm_component_model</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span>::<span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="s">"./cswasi.wasm"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="w"> </span>:<span class="nc">MyState</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span>
<span class="w">        </span><span class="n">state</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="n">HelloWorld</span>::<span class="n">add_to_linker</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">x</span><span class="o">|</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</code></pre></div>
<p><code>|x| x</code> seems to be a common way to call <code>add_to_linker</code>, but I get</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">cs</span><span class="o">-</span><span class="n">runtime</span><span class="o">-</span><span class="n">example</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">1.0</span><span class="w"> </span><span class="p">(</span><span class="n">C</span>:<span class="err">\</span><span class="n">github</span><span class="err">\</span><span class="n">cs</span><span class="o">-</span><span class="n">runtime</span><span class="o">-</span><span class="n">example</span><span class="o">-</span><span class="n">wasmtime</span><span class="p">)</span>
<span class="n">error</span><span class="p">[</span><span class="n">E0282</span><span class="p">]</span>: <span class="nc">type</span><span class="w"> </span><span class="n">annotations</span><span class="w"> </span><span class="n">needed</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="err">`</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">T</span><span class="err">`</span>
<span class="w">  </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="err">\</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">45</span>:<span class="mi">45</span>
<span class="w">   </span><span class="o">|</span>
<span class="mi">45</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">HelloWorld</span>::<span class="n">add_to_linker</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">x</span><span class="o">|</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">   </span><span class="o">|</span><span class="w">                                             </span><span class="o">^</span>
<span class="w">   </span><span class="o">|</span>
<span class="n">help</span>: <span class="nc">consider</span><span class="w"> </span><span class="n">giving</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">closure</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">explicit</span><span class="w"> </span><span class="k">type</span><span class="p">,</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">type</span> <span class="nc">for</span><span class="w"> </span><span class="k">type</span> <span class="nc">parameter</span><span class="w"> </span><span class="err">`</span><span class="n">T</span><span class="err">`</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">specified</span>
<span class="w">   </span><span class="o">|</span>
<span class="mi">45</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">HelloWorld</span>::<span class="n">add_to_linker</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">x</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">T</span><span class="o">|</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">   </span><span class="o">|</span><span class="w">                                              </span><span class="o">++++++++</span>

<span class="n">For</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">information</span><span class="w"> </span><span class="n">about</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="kr">try</span><span class="w"> </span><span class="err">`</span><span class="n">rustc</span><span class="w"> </span><span class="o">--</span><span class="n">explain</span><span class="w"> </span><span class="n">E0282</span><span class="err">`</span><span class="p">.</span>
<span class="n">error</span>: <span class="nc">could</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="err">`</span><span class="n">cs</span><span class="o">-</span><span class="n">runtime</span><span class="o">-</span><span class="n">example</span><span class="err">`</span><span class="w"> </span><span class="p">(</span><span class="n">bin</span><span class="w"> </span><span class="s">"cs-runtime-example"</span><span class="p">)</span><span class="w"> </span><span class="n">due</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">previous</span><span class="w"> </span><span class="n">error</span>
</code></pre></div>



<a name="374130305"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374130305" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Guy Bedford <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374130305">(Jul 11 2023 at 03:35)</a>:</h4>
<p>I don't think you need to call HelloWorld::add_to_linker, as long as you define the import function in the linker via eg <code>linker.root().func_wrap</code> as above</p>



<a name="374133961"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374133961" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374133961">(Jul 11 2023 at 04:12)</a>:</h4>
<p>HelloWorld::add_to_linker provides the correct func_wrap invocations that will dispatch to the Host traits</p>



<a name="374134072"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374134072" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Guy Bedford <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374134072">(Jul 11 2023 at 04:13)</a>:</h4>
<p>ah, I never figured out how to call it correctly myself :P</p>



<a name="374134081"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374134081" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374134081">(Jul 11 2023 at 04:13)</a>:</h4>
<p>the closure argument given to add_to_linker is for mapping to the particular ctx type that your Host trait uses - the idea is that you can have some <code>struct CustomCtx { wasi: WasiCtx, table: Table, hello: HelloCtx }</code></p>



<a name="374134096"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374134096" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374134096">(Jul 11 2023 at 04:13)</a>:</h4>
<p>that suits your embedding</p>



<a name="374134166"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374134166" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374134166">(Jul 11 2023 at 04:14)</a>:</h4>
<p>and then you provide an <code>impl hello_world::Host for HelloCtx { ... }</code></p>



<a name="374134180"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374134180" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374134180">(Jul 11 2023 at 04:14)</a>:</h4>
<p>and your <code>struct HelloCtx {...}</code> can have whatever members you need to implement those imports.</p>



<a name="374134263"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374134263" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374134263">(Jul 11 2023 at 04:15)</a>:</h4>
<p>the func wrapping that happens in add_to_linker is all about applying the closure you provide - in this case it would be something like <code>|ctx: &amp;mut CustomCtx| &amp;mut ctx.hello</code> - to the data (T) kept in your Store&lt;T&gt; (accessed in the func_wrap via Caller&lt;T&gt;, but if you squint Caller is just a more restricted interface to Store)</p>



<a name="374134404"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374134404" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374134404">(Jul 11 2023 at 04:16)</a>:</h4>
<p>the reason youve seen the <code>|x| x</code> pattern a bunch in components is a complication we have at the moment where we need to share the <code>Table</code> member across many different impls... in the future we're going to make Table provided directly by the component runtime instead of a plug in from wasi, and then all the WasiView nonsense will go away and you'll go back to calling <code>Wasi::add_to_linker(&amp;mut store, |ctx| &amp;mut ctx.wasi)</code></p>



<a name="374134553"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374134553" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374134553">(Jul 11 2023 at 04:18)</a>:</h4>
<p>you can ignore that explanation if you arent yet trying to do anything resource-like. proper support for resources is coming soon.</p>



<a name="374475270"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374475270" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374475270">(Jul 12 2023 at 02:52)</a>:</h4>
<p>Thanks, that is super useful and I think I now have the structs and closure set up correctly.  At <a href="https://radu-matei.com/pdf/wasm-components-host-implementations.pdf">https://radu-matei.com/pdf/wasm-components-host-implementations.pdf</a> it has <code>let instance = linker.instantiate(&amp;mut store, &amp;module)?;</code> but I suppose that is not the right way to do things now and I need a component wasm, not a module?  I.e. its not possible to link a module with a component, or at least not yet.</p>



<a name="374479749"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374479749" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374479749">(Jul 12 2023 at 03:32)</a>:</h4>
<p>Which seems to lead to the next question, how does one create a wasm component.  There is <code>wasm-tools component</code> but can it convert a module with an <code>import</code> to a component that can be instantiated using <code>wasmtime::component::from_file</code> that I could then use <code>Linker</code> to link with the rust compoent?</p>



<a name="374618200"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374618200" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374618200">(Jul 12 2023 at 13:23)</a>:</h4>
<p>I did try but get</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">C</span>:<span class="err">\</span><span class="n">github</span><span class="err">\</span><span class="n">cs</span><span class="o">-</span><span class="n">runtime</span><span class="o">-</span><span class="n">example</span><span class="o">-</span><span class="n">wasmtime</span><span class="o">&gt;</span><span class="n">wasm</span><span class="o">-</span><span class="n">tools</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">cswasi</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">cswasi</span><span class="p">.</span><span class="n">component</span><span class="p">.</span><span class="n">wasm</span>
<span class="n">error</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">encode</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">module</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="mi">0</span>: <span class="nc">module</span><span class="w"> </span><span class="n">requires</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="n">interface</span><span class="w"> </span><span class="n">named</span><span class="w"> </span><span class="err">`</span><span class="n">rust</span><span class="err">`</span>
</code></pre></div>
<p>This module does indeed have an import from <code>rust</code> as the one I am trying to satisfy from the call to <code>add_to_linker</code></p>



<a name="374620889"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374620889" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374620889">(Jul 12 2023 at 13:32)</a>:</h4>
<p>I tried <code>wasm-tools component embed --dummy -o dummy.wat -t -w hello-world wit/cswasi.wit</code> and it looks like the import name is going to be <code>$root</code>, no way to change that from the wit I suppose?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">module</span>
<span class="w">  </span><span class="p">(</span><span class="k">type</span> <span class="p">(;</span><span class="mi">0</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="kt">f32</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">type</span> <span class="p">(;</span><span class="mi">1</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="kt">i32</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">import</span><span class="w"> </span><span class="s">"$root"</span><span class="w"> </span><span class="s">"name2"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(;</span><span class="mi">0</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="k">type</span> <span class="mi">0</span><span class="p">)))</span>
</code></pre></div>



<a name="374624687"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374624687" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374624687">(Jul 12 2023 at 13:44)</a>:</h4>
<p>Having aligned the module name it <code>wasm-tools component new</code> now seems to want to know where the import is coming from which seems counter intuitive</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">C</span>:<span class="err">\</span><span class="n">github</span><span class="err">\</span><span class="n">cs</span><span class="o">-</span><span class="n">runtime</span><span class="o">-</span><span class="n">example</span><span class="o">-</span><span class="n">wasmtime</span><span class="o">&gt;</span><span class="n">wasm</span><span class="o">-</span><span class="n">tools</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">cswasi</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">cswasi</span><span class="p">.</span><span class="n">component</span><span class="p">.</span><span class="n">wasm</span>
<span class="n">error</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">encode</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">module</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="mi">0</span>: <span class="nc">no</span><span class="w"> </span><span class="n">top</span><span class="o">-</span><span class="n">level</span><span class="w"> </span><span class="n">imported</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="err">`</span><span class="n">wasmImportFloat32Param</span><span class="err">`</span><span class="w"> </span><span class="n">specified</span>
</code></pre></div>



<a name="374624999"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374624999" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374624999">(Jul 12 2023 at 13:45)</a>:</h4>
<p>I changed my wit to use that name, but as the wit is not an import to <code>wasm-tools component new</code> that seems irrelevant for this step.</p>



<a name="374658334"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374658334" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374658334">(Jul 12 2023 at 15:23)</a>:</h4>
<p>Think I will look at the source code for <code>linker.instantiate</code> to see what is uses to determine if a wasm file is a component or module</p>



<a name="374683298"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374683298" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374683298">(Jul 12 2023 at 16:43)</a>:</h4>
<p>that doc from radu is super out of date, that was using machinery for components that was basically just a prototype for what ended up becoming the implementation today.</p>



<a name="374684173"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374684173" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374684173">(Jul 12 2023 at 16:46)</a>:</h4>
<p>you want to use <code>wasmtime::component::Linker</code> for all your linking. that will only accept a <code>Component</code> in instantiate: <a href="https://docs.rs/wasmtime/latest/wasmtime/component/struct.Linker.html#method.instantiate">https://docs.rs/wasmtime/latest/wasmtime/component/struct.Linker.html#method.instantiate</a></p>



<a name="374684511"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374684511" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374684511">(Jul 12 2023 at 16:47)</a>:</h4>
<p><code>wasm-tools component new</code> creates a component from a module. to do so, it needs to map all of the module's imports and exports (we often call these the core wasm imports and exports) to component imports and exports. to do so, it needs all of the component type information</p>



<a name="374685243"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374685243" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374685243">(Jul 12 2023 at 16:50)</a>:</h4>
<p>it can get that type information from one of two places: special custom sections in the wasm module, or from special adapter arguments (this is really just used to map wasi preview 1 to wasi preview 2, and i would recommend not using it for anything else)</p>



<a name="374685590"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374685590" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374685590">(Jul 12 2023 at 16:51)</a>:</h4>
<p>if you are creating your wasm module using one of the various wit-bindgen language implementations, it will stick the special custom sections into your linked executable for you (exception being the C backend, where it emits an object file that you need to manually pass into your linking step, but thats really just a C-specific detail)</p>



<a name="374685806"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374685806" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374685806">(Jul 12 2023 at 16:52)</a>:</h4>
<p>if you are not using wit-bindgen, then you have to replicate that behavior on your own somehow, and that is a whole can of worms, but for now i'll assume you are indeed using wit-bindgen - is that correct?</p>



<a name="374717732"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374717732" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374717732">(Jul 12 2023 at 19:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="253992">Pat Hickey</span> <a href="#narrow/stream/217126-wasmtime/topic/component.20Linker.20and.20instantiate/near/374685806">said</a>:</p>
<blockquote>
<p>wit-bindgen - is that correct?</p>
</blockquote>
<p>Not really, I(we) want to add the ability to wit-bindgen because we are using c#.  So for now we are using a mixture of a prototype <code>wit-bindgen</code> and the NativeAOT-LLVM c# compiler (which I help develop).  I assume our Wasm that we produce is lacking some info that makes the wasm file a component, and I need to understand what those "special custom sections" are to see if ideally I can coerce clang/wasm-ld to produce them or if not, create a tool using a library that Alex Crichton mentioned <code>wasm-encoder</code></p>



<a name="374718608"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374718608" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374718608">(Jul 12 2023 at 19:13)</a>:</h4>
<p>For a first cut I could just edit the wat to add them.  For my simple case, I'm guessing that is not too much.</p>



<a name="374752921"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374752921" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374752921">(Jul 12 2023 at 21:55)</a>:</h4>
<p>I think a need a <code>component-type</code> section, I'll see what the layout of that should be.</p>



<a name="374755286"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374755286" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374755286">(Jul 12 2023 at 22:11)</a>:</h4>
<p>That is not trivial: <a href="https://github.com/bytecodealliance/wasm-tools/blob/main/crates/wit-component/src/metadata.rs">https://github.com/bytecodealliance/wasm-tools/blob/main/crates/wit-component/src/metadata.rs</a></p>



<a name="374779620"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374779620" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374779620">(Jul 13 2023 at 01:17)</a>:</h4>
<p>maybe not, wasm2wat doesn't help as apparently custom sections are not defined for wat</p>



<a name="374779835"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374779835" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374779835">(Jul 13 2023 at 01:19)</a>:</h4>
<p>does look like it is text though</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Contents</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="n">Custom</span>:
<span class="mi">00</span><span class="n">b0f05</span>: <span class="mi">1363</span><span class="w"> </span><span class="mi">6</span><span class="n">f6d</span><span class="w"> </span><span class="mi">706</span><span class="n">f</span><span class="w"> </span><span class="mf">6e65</span><span class="w"> </span><span class="mf">6e74</span><span class="w"> </span><span class="mi">2</span><span class="n">d74</span><span class="w"> </span><span class="mi">7970</span><span class="w"> </span><span class="mi">653</span><span class="n">a</span><span class="w">  </span><span class="p">.</span><span class="n">component</span><span class="o">-</span><span class="k">type</span>:
<span class="mi">00</span><span class="n">b0f15</span>: <span class="mi">686</span><span class="n">f</span><span class="w"> </span><span class="mi">7374</span><span class="w"> </span><span class="mi">0300</span><span class="w"> </span><span class="mi">0468</span><span class="w"> </span><span class="mi">6</span><span class="n">f73</span><span class="w"> </span><span class="mi">7400</span><span class="w"> </span><span class="mi">6173</span><span class="w"> </span><span class="mi">6</span><span class="n">d0d</span><span class="w">  </span><span class="n">host</span><span class="o">..</span><span class="p">.</span><span class="n">host</span><span class="p">.</span><span class="n">asm</span><span class="p">.</span>
<span class="mi">00</span><span class="n">b0f25</span>: <span class="mi">0001</span><span class="w"> </span><span class="mi">0007</span><span class="w"> </span><span class="mi">3</span><span class="n">d01</span><span class="w"> </span><span class="mi">4102</span><span class="w"> </span><span class="mi">0141</span><span class="w"> </span><span class="mi">0401</span><span class="w"> </span><span class="mi">4001</span><span class="w"> </span><span class="mi">036</span><span class="n">d</span><span class="w">  </span><span class="o">....=</span><span class="p">.</span><span class="n">A</span><span class="o">..</span><span class="n">A</span><span class="o">..@..</span><span class="n">m</span>
<span class="mi">00</span><span class="n">b0f35</span>: <span class="mi">7367</span><span class="w"> </span><span class="mi">7301</span><span class="w"> </span><span class="mi">0003</span><span class="w"> </span><span class="mi">0005</span><span class="w"> </span><span class="mi">7072</span><span class="w"> </span><span class="mi">696</span><span class="n">e</span><span class="w"> </span><span class="mi">7401</span><span class="w"> </span><span class="mi">0001</span><span class="w">  </span><span class="n">sgs</span><span class="o">....</span><span class="p">.</span><span class="n">print</span><span class="o">..</span><span class="p">.</span>
<span class="mi">00</span><span class="n">b0f45</span>: <span class="mi">4000</span><span class="w"> </span><span class="mi">0100</span><span class="w"> </span><span class="mi">0400</span><span class="w"> </span><span class="mi">0372</span><span class="w"> </span><span class="mi">756</span><span class="n">e</span><span class="w"> </span><span class="mi">0101</span><span class="w"> </span><span class="mi">0401</span><span class="w"> </span><span class="mi">1165</span><span class="w">  </span><span class="o">@......</span><span class="n">run</span><span class="o">....</span><span class="p">.</span><span class="n">e</span>
<span class="mi">00</span><span class="n">b0f55</span>: <span class="mi">7861</span><span class="w"> </span><span class="mi">6</span><span class="n">d70</span><span class="w"> </span><span class="mi">6</span><span class="n">c65</span><span class="w"> </span><span class="mi">3</span><span class="n">a68</span><span class="w"> </span><span class="mi">6</span><span class="n">f73</span><span class="w"> </span><span class="mi">742</span><span class="n">f</span><span class="w"> </span><span class="mi">686</span><span class="n">f</span><span class="w"> </span><span class="mi">7374</span><span class="w">  </span><span class="n">xample</span>:<span class="nc">host</span><span class="o">/</span><span class="n">host</span>
<span class="mi">00</span><span class="n">b0f65</span>: <span class="mi">0400</span><span class="w"> </span><span class="mi">0045</span><span class="w"> </span><span class="mi">0970</span><span class="w"> </span><span class="mi">726</span><span class="n">f</span><span class="w"> </span><span class="mi">6475</span><span class="w"> </span><span class="mi">6365</span><span class="w"> </span><span class="mi">7273</span><span class="w"> </span><span class="mi">010</span><span class="n">c</span><span class="w">  </span><span class="o">..</span><span class="p">.</span><span class="n">E</span><span class="p">.</span><span class="n">producers</span><span class="o">..</span>
<span class="mi">00</span><span class="n">b0f75</span>: <span class="mi">7072</span><span class="w"> </span><span class="mi">6</span><span class="n">f63</span><span class="w"> </span><span class="mi">6573</span><span class="w"> </span><span class="mi">7365</span><span class="w"> </span><span class="mi">642</span><span class="n">d</span><span class="w"> </span><span class="mi">6279</span><span class="w"> </span><span class="mi">020</span><span class="n">d</span><span class="w"> </span><span class="mi">7769</span><span class="w">  </span><span class="n">processed</span><span class="o">-</span><span class="n">by</span><span class="o">..</span><span class="n">wi</span>
<span class="mi">00</span><span class="n">b0f85</span>: <span class="mi">742</span><span class="n">d</span><span class="w"> </span><span class="mi">636</span><span class="n">f</span><span class="w"> </span><span class="mi">6</span><span class="n">d70</span><span class="w"> </span><span class="mi">6</span><span class="n">f6e</span><span class="w"> </span><span class="mi">656</span><span class="n">e</span><span class="w"> </span><span class="mi">7406</span><span class="w"> </span><span class="mi">302</span><span class="n">e</span><span class="w"> </span><span class="mi">3131</span><span class="w">  </span><span class="n">t</span><span class="o">-</span><span class="n">component</span><span class="p">.</span><span class="mf">0.11</span>
<span class="mi">00</span><span class="n">b0f95</span>: <span class="mf">2e30</span><span class="w"> </span><span class="mi">1077</span><span class="w"> </span><span class="mi">6974</span><span class="w"> </span><span class="mi">2</span><span class="n">d62</span><span class="w"> </span><span class="mi">696</span><span class="n">e</span><span class="w"> </span><span class="mi">6467</span><span class="w"> </span><span class="mi">656</span><span class="n">e</span><span class="w"> </span><span class="mi">2</span><span class="n">d72</span><span class="w">  </span><span class="p">.</span><span class="mf">0.</span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="o">-</span><span class="n">r</span>
<span class="mi">00</span><span class="n">b0fa5</span>: <span class="mi">7573</span><span class="w"> </span><span class="mi">7405</span><span class="w"> </span><span class="mi">302</span><span class="n">e</span><span class="w"> </span><span class="mi">382</span><span class="n">e</span><span class="w"> </span><span class="mi">300</span><span class="n">b</span><span class="w"> </span><span class="mi">1601</span><span class="w"> </span><span class="mi">0110</span><span class="w"> </span><span class="mi">6578</span><span class="w">  </span><span class="n">ust</span><span class="p">.</span><span class="mf">0.8.</span><span class="mi">0</span><span class="o">....</span><span class="p">.</span><span class="n">ex</span>
<span class="mi">00</span><span class="n">b0fb5</span>: <span class="mi">616</span><span class="n">d</span><span class="w"> </span><span class="mi">706</span><span class="n">c</span><span class="w"> </span><span class="mi">653</span><span class="n">a</span><span class="w"> </span><span class="mi">686</span><span class="n">f</span><span class="w"> </span><span class="mi">7374</span><span class="w"> </span><span class="mi">2</span><span class="n">f77</span><span class="w"> </span><span class="mi">6974</span><span class="w"> </span><span class="mi">0300</span><span class="w">  </span><span class="n">ample</span>:<span class="nc">host</span><span class="o">/</span><span class="n">wit</span><span class="p">.</span>
</code></pre></div>



<a name="374787584"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374787584" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374787584">(Jul 13 2023 at 02:30)</a>:</h4>
<p>Will try to reuse <a href="https://github.com/bytecodealliance/wit-bindgen/blob/main/crates/c/src/component_type_object.rs">https://github.com/bytecodealliance/wit-bindgen/blob/main/crates/c/src/component_type_object.rs</a>  Seems like the sensible path</p>



<a name="374992436"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374992436" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374992436">(Jul 13 2023 at 16:29)</a>:</h4>
<p>a component type section contains a wasm component</p>



<a name="374993176"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/374993176" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#374993176">(Jul 13 2023 at 16:32)</a>:</h4>
<p>so, to parse it, you need to use wasmparser again</p>



<a name="375822263"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/375822263" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#375822263">(Jul 16 2023 at 19:04)</a>:</h4>
<p>I've produced a component section, but for this error</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">C</span>:<span class="err">\</span><span class="n">github</span><span class="err">\</span><span class="n">cs</span><span class="o">-</span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="o">&gt;</span><span class="n">wasm</span><span class="o">-</span><span class="n">tools</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">bin</span><span class="err">\</span><span class="n">Release</span><span class="err">\</span><span class="n">net8</span><span class="p">.</span><span class="mi">0</span><span class="err">\</span><span class="n">wasi</span><span class="o">-</span><span class="n">wasm</span><span class="err">\</span><span class="n">native</span><span class="err">\</span><span class="n">cswasi</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">my</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">cs</span><span class="p">.</span><span class="n">wasm</span><span class="w">  </span><span class="o">--</span><span class="n">adapt</span><span class="w"> </span><span class="n">wasi_snapshot_preview1</span><span class="o">=</span><span class="n">c</span>:<span class="err">\</span><span class="n">github</span><span class="err">\</span><span class="n">rust_wit</span><span class="err">\</span><span class="n">host</span><span class="err">\</span><span class="n">wasi_snapshot_preview1</span><span class="p">.</span><span class="n">reactor</span><span class="p">.</span><span class="n">wasm</span>
<span class="n">error</span>: <span class="nc">decoding</span><span class="w"> </span><span class="n">custom</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="n">component</span><span class="o">-</span><span class="k">type</span>:<span class="nc">the</span><span class="o">-</span><span class="n">world</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="mi">0</span>: <span class="nc">component</span><span class="o">-</span><span class="k">type</span> <span class="nc">version</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">supported</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="mi">3</span>
</code></pre></div>
<p>I suppose this is because the wasm-tools is newer than than the version specified in the custom section and I should merge the latest wit-bindgen</p>



<a name="375874404"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/375874404" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#375874404">(Jul 17 2023 at 02:52)</a>:</h4>
<p>Looks like upgrading solved the version porblem.  I'm not sure about the naming conventions here, when i get the error</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">C</span>:<span class="err">\</span><span class="n">github</span><span class="err">\</span><span class="n">cs</span><span class="o">-</span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="o">&gt;</span><span class="n">wasm</span><span class="o">-</span><span class="n">tools</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">bin</span><span class="err">\</span><span class="n">Release</span><span class="err">\</span><span class="n">net8</span><span class="p">.</span><span class="mi">0</span><span class="err">\</span><span class="n">wasi</span><span class="o">-</span><span class="n">wasm</span><span class="err">\</span><span class="n">native</span><span class="err">\</span><span class="n">cswasi</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">my</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">cs</span><span class="p">.</span><span class="n">wasm</span><span class="w">  </span><span class="o">--</span><span class="n">adapt</span><span class="w"> </span><span class="n">wasi_snapshot_preview1</span><span class="o">=</span><span class="n">c</span>:<span class="err">\</span><span class="n">github</span><span class="err">\</span><span class="n">rust_wit</span><span class="err">\</span><span class="n">host</span><span class="err">\</span><span class="n">wasi_snapshot_preview1</span><span class="p">.</span><span class="n">reactor</span><span class="p">.</span><span class="n">wasm</span>
<span class="n">error</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">encode</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">module</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="mi">0</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">validate</span><span class="w"> </span><span class="n">exported</span><span class="w"> </span><span class="n">interface</span><span class="w"> </span><span class="err">`</span><span class="n">foo</span>:<span class="nc">foo</span><span class="o">/</span><span class="n">floats</span><span class="err">`</span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">module</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">export</span><span class="w"> </span><span class="n">required</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="err">`</span><span class="n">foo</span>:<span class="nc">foo</span><span class="o">/</span><span class="n">floats</span>#<span class="n">float32</span><span class="o">-</span><span class="n">param</span><span class="err">`</span>
</code></pre></div>
<p>Should I have a function in my wasm module with that exact name: <code>foo:foo/floats#float32-param</code> ?</p>



<a name="376046216"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/376046216" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#376046216">(Jul 17 2023 at 14:31)</a>:</h4>
<p>yes this is an error where a core wasm being lifted into a component doesn't export the function of that name, and that symbol (with <code>:</code> and <code>/</code> and <code>#</code>) is the name that's expected</p>



<a name="376714334"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/376714334" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#376714334">(Jul 19 2023 at 15:49)</a>:</h4>
<p>Many thanks, I now have a componet from C# which feels like a decent step forward.  I'm following <a href="https://github.com/bytecodealliance/wasmtime/issues/6523">https://github.com/bytecodealliance/wasmtime/issues/6523</a> for ideas and have the following error at runtime</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">C</span>:<span class="err">\</span><span class="n">github</span><span class="err">\</span><span class="n">cs</span><span class="o">-</span><span class="n">runtime</span><span class="o">-</span><span class="n">example</span><span class="o">-</span><span class="n">wasmtime</span><span class="err">\</span><span class="n">target</span><span class="err">\</span><span class="n">debug</span><span class="err">\</span><span class="n">cs</span><span class="o">-</span><span class="n">runtime</span><span class="o">-</span><span class="n">example</span><span class="p">.</span><span class="n">exe</span><span class="err">`</span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">cannot</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="err">`</span><span class="n">func_wrap_async</span><span class="err">`</span><span class="w"> </span><span class="n">without</span><span class="w"> </span><span class="n">enabling</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">support</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">config</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">C</span>:<span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">scott</span><span class="err">\</span><span class="p">.</span><span class="n">cargo</span><span class="err">\</span><span class="n">registry</span><span class="err">\</span><span class="n">src</span><span class="err">\</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="err">\</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">10.0.1</span><span class="err">\</span><span class="n">src</span><span class="err">\</span><span class="n">component</span><span class="err">\</span><span class="n">linker</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">287</span>:<span class="mi">9</span>
</code></pre></div>
<p>Is this a simple one?  Sorry I'm a rust newbie.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/issues/6523" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/eff28184cdd3682e605928b2e939439b6308e8c8\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f396161643533353031633834373233393038323331333038346265336630356231353738653864616233303136383261353062323239616237396436636331352f62797465636f6465616c6c69616e63652f7761736d74696d652f6973737565732f36353233)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/issues/6523" title="import `wasi:clocks/wall-clock` has the wrong type when instantiating component · Issue #6523 · bytecodealliance/wasmtime">import `wasi:clocks/wall-clock` has the wrong type when instantiating component · Issue #6523 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">Hi, I'm trying to instantiate a component compiled using tinygo from wasmtime in rust The components implements the following WIT interface package producer:host world producer-interface { export h...</div></div></div>



<a name="376719135"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/376719135" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#376719135">(Jul 19 2023 at 16:04)</a>:</h4>
<p>in my <code>toml</code> I have</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">wasmtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="o">=</span><span class="w"> </span><span class="s">"10.0.1"</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"component-model"</span><span class="p">,</span><span class="w"> </span><span class="s">"async"</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>



<a name="376722391"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/376722391" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jamey Sharp <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#376722391">(Jul 19 2023 at 16:15)</a>:</h4>
<p>I believe you need to use <a href="https://docs.rs/wasmtime/latest/wasmtime/struct.Config.html#method.async_support">https://docs.rs/wasmtime/latest/wasmtime/struct.Config.html#method.async_support</a> to fix that error.</p>



<a name="376725715"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/376725715" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#376725715">(Jul 19 2023 at 16:27)</a>:</h4>
<p>Thanks, that did fix it.  I missed that from the other example :-O</p>



<a name="376729600"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/376729600" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#376729600">(Jul 19 2023 at 16:40)</a>:</h4>
<p>Feels close</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">customCtx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CustomCtx</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">state</span>: <span class="nc">state</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="p">};</span>

<span class="w">    </span><span class="n">wasmtime_wasi</span>::<span class="n">preview2</span>::<span class="n">wasi</span>::<span class="n">command</span>::<span class="n">add_to_linker</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span>: <span class="nc">Store</span><span class="o">&lt;</span><span class="n">CustomCtx</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span>
<span class="w">        </span><span class="n">customCtx</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="n">TheWorld</span>::<span class="n">add_to_linker</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">ctx</span><span class="w"> </span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">CustomCtx</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">state</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linker</span><span class="p">.</span><span class="n">instantiate_async</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">component</span><span class="p">.</span><span class="n">unwrap</span><span class="p">()).</span><span class="k">await</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">instance</span><span class="p">.</span><span class="n">unwrap</span><span class="p">().</span><span class="n">get_func</span><span class="p">(</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"_start"</span><span class="p">)).</span><span class="n">expect</span><span class="p">(</span><span class="s">"export wasnt a function"</span><span class="p">);</span>

<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">start</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[],</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="nb">Err</span><span class="p">(</span><span class="n">trap</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="fm">panic!</span><span class="p">(</span><span class="s">"execution of _start failed {}"</span><span class="p">,</span><span class="w"> </span><span class="n">trap</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p>complains</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span><span class="p">[</span><span class="n">E0382</span><span class="p">]</span>: <span class="nc">borrow</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">moved</span><span class="w"> </span><span class="n">value</span>: <span class="err">`</span><span class="n">store</span><span class="err">`</span>
<span class="w">  </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="err">\</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">91</span>:<span class="mi">22</span>
<span class="w">   </span><span class="o">|</span>
<span class="mi">81</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span>: <span class="nc">Store</span><span class="o">&lt;</span><span class="n">CustomCtx</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span>
<span class="w">   </span><span class="o">|</span><span class="w">         </span><span class="o">---------</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="n">occurs</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="err">`</span><span class="n">store</span><span class="err">`</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="k">type</span> <span class="err">`</span><span class="n">Store</span><span class="o">&lt;</span><span class="n">CustomCtx</span><span class="o">&gt;</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">implement</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">`</span><span class="nb">Copy</span><span class="err">`</span><span class="w"> </span><span class="k">trait</span>
<span class="o">..</span><span class="p">.</span>
<span class="mi">89</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">instance</span><span class="p">.</span><span class="n">unwrap</span><span class="p">().</span><span class="n">get_func</span><span class="p">(</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"_start"</span><span class="p">)).</span><span class="n">expect</span><span class="p">(</span><span class="s">"export wasnt a function"</span><span class="p">);</span>
<span class="w">   </span><span class="o">|</span><span class="w">                                             </span><span class="o">-----</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">moved</span><span class="w"> </span><span class="n">here</span>
<span class="mi">90</span><span class="w"> </span><span class="o">|</span>
<span class="mi">91</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="k">match</span><span class="w"> </span><span class="n">start</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[],</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="o">|</span><span class="w">                      </span><span class="o">^^^^^^^^^^</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">borrowed</span><span class="w"> </span><span class="n">here</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="k">move</span>
</code></pre></div>
<p>Have a got something wrong with the store creation?</p>



<a name="376730796"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/376730796" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#376730796">(Jul 19 2023 at 16:44)</a>:</h4>
<p>nvm more RTFM required between keyboard and chair</p>



<a name="377113283"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377113283" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377113283">(Jul 20 2023 at 21:16)</a>:</h4>
<p>Can <code>WasiCtxBuilder</code> and <code>inherit_stdout</code> be used to make <code>printf</code> out put to stdout from <code>cargo run</code>? <br>
 I'm trying to do some low level debugging</p>



<a name="377113484"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377113484" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377113484">(Jul 20 2023 at 21:17)</a>:</h4>
<p>Currently my printfs seems to go nowhere</p>



<a name="377116485"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377116485" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377116485">(Jul 20 2023 at 21:34)</a>:</h4>
<p>Maybe a simpler question is in order.  If my component includes static global c++ constructors e.g.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="k">struct</span> <span class="nc">InitializeRuntimePointerHelper</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">InitializeRuntimePointerHelper</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">RhSetRuntimeInitializationCallback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">InitializeRuntime</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span><span class="w"> </span><span class="n">initializeRuntimePointerHelper</span><span class="p">;</span>
</code></pre></div>
<p>Is wasmtime going to run them ?</p>



<a name="377122713"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377122713" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377122713">(Jul 20 2023 at 22:10)</a>:</h4>
<p>I'm guessing it wont.  So I'm trying to initialize things myself by calling <code>__wasm_call_ctors</code> which is a function that I've exported before creating the component:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"__wasm_call_ctors"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$__wasm_call_ctors</span><span class="p">))</span>
</code></pre></div>
<p>However from rust</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">bindings</span><span class="p">,</span><span class="w"> </span><span class="n">instance</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TheWorld</span>::<span class="n">instantiate_async</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">component</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">linker</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="kd">let</span><span class="w"> </span><span class="n">init_func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"__wasm_call_ctors"</span><span class="p">).</span><span class="n">expect</span><span class="p">(</span><span class="s">"__wasm_call_ctors not found"</span><span class="p">);</span>
</code></pre></div>
<p>panics</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="nb">__</span><span class="na">wasm_call_ctors</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">found</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">src</span><span class="err">\</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">105</span>:<span class="mi">72</span>
</code></pre></div>
<p>Is this possible or is <code>wasm-tools component new</code> going to remove my exports?</p>



<a name="377135032"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377135032" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377135032">(Jul 20 2023 at 23:51)</a>:</h4>
<p>wasm and ctors is a sticky subject. when we last were having problems with it, here is where i wrote up everything i was able to learn from talking to joel, dan, and others <a href="https://github.com/bytecodealliance/preview2-prototyping/issues/99">https://github.com/bytecodealliance/preview2-prototyping/issues/99</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/preview2-prototyping/issues/99" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/65d2c7c142cc9263b0fa7e7c85d5e770e56e4f54\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f326535623563633934316636663531633065336561633932643161353863656538333238363361346433303762333965303631323533363831666365666430382f62797465636f6465616c6c69616e63652f70726576696577322d70726f746f747970696e672f6973737565732f3939)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/preview2-prototyping/issues/99" title="Tooling issue: Components and Constructors · Issue #99 · bytecodealliance/preview2-prototyping">Tooling issue: Components and Constructors · Issue #99 · bytecodealliance/preview2-prototyping</a></div><div class="message_embed_description">Components and Constructors Pat Hickey, 28 Feb 2023 Presently, there are some major problems using C/C++ constructors (ctors) with the component model. Rust and C/C++ guests need to define a cabi_r...</div></div></div>



<a name="377135143"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377135143" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377135143">(Jul 20 2023 at 23:52)</a>:</h4>
<p><code> preview 1 adapter short-circuits import function calls in ctors</code> this fix is done but it isnt actually relevant to you i dont think</p>



<a name="377135184"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377135184" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377135184">(Jul 20 2023 at 23:52)</a>:</h4>
<p><code>guest bindgen behavior eliminates ctor calls in cabi_realloc</code> this change was done in the rust bindgen. if you're using a c bindgen, you may need to do it yourself.</p>



<a name="377135261"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377135261" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377135261">(Jul 20 2023 at 23:53)</a>:</h4>
<p>wasi-libc still uses ctors, and the long-term goal of straitening out the whole ctors story by way of tool-conventions and canonical ABI support is kicked off but nowhere near done afaik</p>



<a name="377135368"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377135368" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377135368">(Jul 20 2023 at 23:54)</a>:</h4>
<p>the simpler question might be what happens with your printfs. WasiCtxBuilder by default will not do anything with the stdout and stderr coming from your wasi program. if you <code>inherit_stdout</code> and <code>inherit_stderr</code> it will forward them to your host process's stdout and stderr.</p>



<a name="377135384"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377135384" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377135384">(Jul 20 2023 at 23:55)</a>:</h4>
<p>so please do give that a try</p>



<a name="377135524"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377135524" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377135524">(Jul 20 2023 at 23:56)</a>:</h4>
<p>the behavior you're seeing with <code>export "__wasm_call_ctors"</code> being inside your component, but not available via instance.get_func, is that the export you are seeing is actually a core wasm module export</p>



<a name="377135588"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377135588" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377135588">(Jul 20 2023 at 23:57)</a>:</h4>
<p>core wasm modules are present inside components, but only functions that are part of your wit definition's exports will get turned into component exports.</p>



<a name="377135684"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377135684" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377135684">(Jul 20 2023 at 23:58)</a>:</h4>
<p>the core wasm modules and their exports inside a component are totally opaque, so you'll never be able to call __wasm_call_ctors from the wasmtime component apis.</p>



<a name="377157738"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377157738" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377157738">(Jul 21 2023 at 02:32)</a>:</h4>
<p>Thanks. So it seems that if I want <code>__wasm_call_ctors</code> to be called I'm going to have to do it myself, which might be possible - I'll need to try a few things.  Regards the printf, I'll take a closer look at what I've done.</p>



<a name="377442210"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377442210" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377442210">(Jul 21 2023 at 22:37)</a>:</h4>
<p>not quite - if you dont ever call __wasm_call_ctors yourself, lld will put calls to it in on each export function from your module</p>



<a name="377442239"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377442239" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377442239">(Jul 21 2023 at 22:37)</a>:</h4>
<p>if you use __wasm_call_ctors even once in your code, then lld will not have that behavior</p>



<a name="377442360"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377442360" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377442360">(Jul 21 2023 at 22:38)</a>:</h4>
<p>we suggest you invoke them manually so that it does not get inserted by lld before the invocation of cabi_realloc.</p>



<a name="377442436"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377442436" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377442436">(Jul 21 2023 at 22:39)</a>:</h4>
<p>because during calls into cabi_realloc, the component is not allowed to call any export functions, and sometimes ctors can call export functions (e.g. the ctors in wasi-libc may end up initializing the env variables, for older wasi-libcs)</p>



<a name="377442549"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377442549" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377442549">(Jul 21 2023 at 22:40)</a>:</h4>
<p>hope that makes sense. like i said before, the ctors story is tricky :)</p>



<a name="377447748"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377447748" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377447748">(Jul 21 2023 at 23:22)</a>:</h4>
<p>Yes, thanks that does makes sense.  I seem to have <code>_start</code> which is stopping lld inserting the calls, I must have invoked <code>lld</code> badly.  If the only exports I have are those from the wit, I suppose I'll have to do it via a wit export</p>



<a name="377609506"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377609506" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377609506">(Jul 22 2023 at 14:01)</a>:</h4>
<p><a href="https://github.com/WebAssembly/wasi-sdk/issues/110#issuecomment-1185582357">https://github.com/WebAssembly/wasi-sdk/issues/110#issuecomment-1185582357</a> I'll give this a try.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/wasi-sdk/issues/110#issuecomment-1185582357" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/c51e5557697ccc3b20349df90f631dc59116ccfe\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f623162306437356230663464303532366461346334626134623931343230666330646165343033633739323264306437646630393534613465646363663963372f576562417373656d626c792f776173692d73646b2f6973737565732f313130)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/wasi-sdk/issues/110#issuecomment-1185582357" title="Question: The correct way to compile without main function · Issue #110 · WebAssembly/wasi-sdk">Question: The correct way to compile without main function · Issue #110 · WebAssembly/wasi-sdk</a></div><div class="message_embed_description">Hi guys, I would like to create a WASM file from the following C file: int total_count = 0; // Modules can have state int count() { return ++total_count; } // They can do work int add(int a, int b)...</div></div></div>



<a name="377641753"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377641753" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377641753">(Jul 22 2023 at 16:29)</a>:</h4>
<p>Is <code>_initialize</code> executed by reactor components after instansiation ?</p>



<a name="377649542"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377649542" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377649542">(Jul 22 2023 at 17:11)</a>:</h4>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasmtime/src/linker.rs">https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasmtime/src/linker.rs</a> looks like it should</p>



<a name="377672846"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377672846" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377672846">(Jul 22 2023 at 19:56)</a>:</h4>
<p>What I'e found is that <code>_initialize</code> would work and be called if it was exported but it is not.   Maybe while there appears to be no solution at present I can fork wasm-tools and change <code>component new</code> to re-export.</p>



<a name="377721578"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377721578" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377721578">(Jul 23 2023 at 03:00)</a>:</h4>
<p>I have a workaround for <code>_intiialize</code> and I have got so far as the host calling the component.  Now I want to call back to the host from the component, but I don't know what the wasm symbol should be for the instantiation to link the component back to the host.  I.e. <code>float32_param</code> here</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">foo</span>::<span class="n">foo</span>::<span class="n">floats</span>::<span class="n">Host</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime_wasi</span>::<span class="n">preview2</span>::<span class="p">{</span><span class="n">WasiCtx</span><span class="p">,</span><span class="w"> </span><span class="n">Table</span><span class="p">,</span><span class="w"> </span><span class="n">WasiView</span><span class="p">,</span><span class="w"> </span><span class="n">WasiCtxBuilder</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">};</span>

<span class="n">bindgen</span><span class="o">!</span><span class="p">({</span><span class="n">world</span>:<span class="s">"the-world"</span><span class="p">,</span><span class="k">async</span>: <span class="nc">true</span><span class="p">});</span>

<span class="k">struct</span> <span class="nc">MyCtx</span><span class="w"> </span><span class="p">{</span>
<span class="p">}</span>


<span class="c1">// Imports into the world, like the `name` import for this world, are satisfied</span>
<span class="c1">// through traits.</span>
<span class="cp">#[async_trait]</span>
<span class="k">impl</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyCtx</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Note the `Result` return value here where `Ok` is returned back to</span>
<span class="w">    </span><span class="c1">// the component and `Err` will raise a trap.S</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">float32_param</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="n">x</span>:<span class="kt">f32</span><span class="p">,)</span><span class="w"> </span>-&gt; <span class="nc">wasmtime</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Hello from rust {}"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>



<a name="377873191"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377873191" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377873191">(Jul 23 2023 at 16:13)</a>:</h4>
<p>Something that is not clear to me from <a href="#narrow/stream/217126-wasmtime/topic/component.20Linker.20and.20instantiate/near/376046216">https://bytecodealliance.zulipchat.com/#narrow/stream/217126-wasmtime/topic/component.20Linker.20and.20instantiate/near/376046216</a> is if a world imports and exports the same interface how are the import names differentiated from the export names in the module before conversion to a component?</p>



<a name="377878146"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377878146" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377878146">(Jul 23 2023 at 16:37)</a>:</h4>
<p>Components cannot import and export the same name</p>



<a name="377878317"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377878317" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377878317">(Jul 23 2023 at 16:38)</a>:</h4>
<p>(deleted)</p>



<a name="377878684"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377878684" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377878684">(Jul 23 2023 at 16:40)</a>:</h4>
<blockquote>
<p>Kebab names are required to be unique between all the imports and exports in a single component definition, component type or instance type, so that a single kebab-name uniquely identifies one import or export.</p>
</blockquote>



<a name="377878745"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377878745" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377878745">(Jul 23 2023 at 16:40)</a>:</h4>
<p>(<a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/Explainer.md#import-and-export-definitions">https://github.com/WebAssembly/component-model/blob/main/design/mvp/Explainer.md#import-and-export-definitions</a>)</p>



<a name="377921578"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377921578" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377921578">(Jul 23 2023 at 19:56)</a>:</h4>
<p>But it's valid to import and export the same interface like <a href="https://github.com/bytecodealliance/wit-bindgen/blob/main/tests/codegen/floats.wit">https://github.com/bytecodealliance/wit-bindgen/blob/main/tests/codegen/floats.wit</a> isn't it?</p>



<a name="377921714"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377921714" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377921714">(Jul 23 2023 at 19:57)</a>:</h4>
<p>These are not kebab names as I understand it</p>



<a name="377974619"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377974619" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377974619">(Jul 24 2023 at 03:08)</a>:</h4>
<p>the _initialize logic you see is in wasmtimes core wasm module linker, but support for that is not part of the component model</p>



<a name="377974790"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377974790" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377974790">(Jul 24 2023 at 03:09)</a>:</h4>
<p>if you need to call a function to initialize your component, you'll need to add a function for that as an export in your component's world. it will need a kebab-name so you cant call it _initialize, but plain initialize should work</p>



<a name="377975012"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/377975012" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#377975012">(Jul 24 2023 at 03:11)</a>:</h4>
<p>for your component to be able to call into the trait defined by bindgen, you need to use the <code>add_to_linker(&amp;mut wasmtime::component::Linker, ...)</code> function that is created by bindgen. it will be in the same rust module as the Host trait is defined.</p>



<a name="378148390"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/378148390" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#378148390">(Jul 24 2023 at 13:44)</a>:</h4>
<p>Thanks, for the .Net CoreCLR runtime, that approach would be complicated as the transition from unmanaged to managed code (which occurs on a WIT call to .Net) expects the runtime to already be initialised so it's a bit of a chicken and egg.  I can implement something in the runtime to get round this utilizing the fact that webassembly memory content is zero bytes upon creation.</p>



<a name="378983580"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/378983580" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#378983580">(Jul 27 2023 at 02:27)</a>:</h4>
<p>I think I see how <code>wit-bindgen</code> is doing the import and export of the same interface.  It prefixes the exports with <code>exports</code>resolving the conflicts (if there was a moduled named <code>exports_foo</code>, that might be a problem I suppose, not sure about the mangling rules:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="c1">// Imported Functions from `foo:foo/floats`</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">foo_foo_floats_float32_param</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>

<span class="c1">// Exported Functions from `foo:foo/floats`</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">exports_foo_foo_floats_float32_param</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>
</code></pre></div>



<a name="379934660"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/379934660" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#379934660">(Jul 30 2023 at 04:34)</a>:</h4>
<p>Thanks all who commented to my wanderings here, I have it working now so can continue on wit-&gt;c#.</p>



<a name="379934718"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/379934718" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#379934718">(Jul 30 2023 at 04:34)</a>:</h4>
<p>I can't close this due to it being &gt; 7 days old, but please can a moderator close it?  THanks</p>



<a name="380006672"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20component%20Linker%20and%20instantiate/near/380006672" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20component.20Linker.20and.20instantiate.html#380006672">(Jul 30 2023 at 11:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="234973">Till Schneidereit</span> has marked this topic as resolved.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>