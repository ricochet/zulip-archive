<html>
<head><meta charset="utf-8"><title>Owned vs Borrowed resources on the host · wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/index.html">wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Owned.20vs.20Borrowed.20resources.20on.20the.20host.html">Owned vs Borrowed resources on the host</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="437870601"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Owned%20vs%20Borrowed%20resources%20on%20the%20host/near/437870601" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Karel Hrkal (kajacx) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Owned.20vs.20Borrowed.20resources.20on.20the.20host.html#437870601">(May 09 2024 at 19:03)</a>:</h4>
<p>Ok, I've tried to work with both owned and borrowed resources, here is my (simplified) wit file:</p>
<div class="spoiler-block"><div class="spoiler-header">
<p>Wit file</p>
</div><div class="spoiler-content" aria-hidden="true">
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>package component-test:wit-protocol;

interface companies {
  resource company-res {
    constructor(name: string, max-salary: u32);
    get-name: func() -&gt; string;
    set-name: func(name: string);
    get-max-salary: func() -&gt; u32;
  }
}

interface host-fns {
  use companies.{company-res};

  company-roundtrip: func(company: company-res) -&gt; company-res;

  company-borrow-roundtrip: func(company: borrow&lt;company-res&gt;);
}

interface guest-fns {
  use companies.{company-res};

  company-roundtrip: func(company: company-res) -&gt; company-res;

  company-borrow-roundtrip: func(company: borrow&lt;company-res&gt;);
}

world resources {
  import companies;
  import host-fns;

  export guest-fns;
}
</code></pre></div>
</div></div>
<p>But work with the "Company" resource on the host is kind of strange. First, there is no distinction between owned and borrowed resource at the type level, so you can accidentally pass a borrowed resource where an owned one is expected or vise versa.</p>
<p>And second, I'm not sure if I know how to create a borrowed resource, I am using <code>Resource::new_borrow(company.rep())</code> which works, but it looks kind of hacky.</p>
<p>I would expect that the <code>OwnedResource</code> type would have a <code>borrow</code> method (or <code>borrow_resource</code> if you don't want to confuse it with the <code>Borrow</code> trait) that would return a <code>BorrowedResource</code>. You can even use Rust's lifetime checking to make sure that the borrowed resource does not outlive the owned resource with a signature like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">OwnedResource</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// the 'a lifetime is added here for explicitly</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">borrow_resource</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">BorrowedResource</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>This feels like the most idiomatic solution in Rust, as it would make sure that you are not passing a borrowed resource into a method that wants a owned one (or vice versa) nor that the borrowed resource will be used after the owned resource is deleted.</p>
<p>There is one last thing - dropping the <code>Resource&lt;T&gt;</code> on the host does not delete the resource from the resource table, which is kind of strange, it definitely feels like it <em>should</em> delete the resource, but I don't know if that is feasible since the user is expected to manage the resources themself.</p>
<p>Edit:</p>
<p>This is my host file, there is just a little bit more going on than in the simplified wit file</p>
<div class="spoiler-block"><div class="spoiler-header">
<p>host file</p>
</div><div class="spoiler-content" aria-hidden="true">
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">wasm_bridge</span>::<span class="p">{</span>

<span class="w">    </span><span class="n">component</span>::<span class="p">{</span><span class="n">Component</span><span class="p">,</span><span class="w"> </span><span class="n">Linker</span><span class="p">,</span><span class="w"> </span><span class="n">Resource</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceTable</span><span class="p">},</span>

<span class="w">    </span><span class="n">Config</span><span class="p">,</span><span class="w"> </span><span class="n">Engine</span><span class="p">,</span><span class="w"> </span><span class="nb">Result</span><span class="p">,</span><span class="w"> </span><span class="n">Store</span><span class="p">,</span>

<span class="p">};</span>

<span class="n">wasm_bridge</span>::<span class="n">component</span>::<span class="n">bindgen</span><span class="o">!</span><span class="p">({</span>

<span class="w">    </span><span class="n">path</span>: <span class="s">"../protocol.wit"</span><span class="p">,</span>

<span class="w">    </span><span class="n">world</span>: <span class="s">"resources"</span><span class="p">,</span>

<span class="w">    </span><span class="n">with</span>: <span class="p">{</span>

<span class="w">        </span><span class="s">"component-test:wit-protocol/companies/company-res"</span>: <span class="nc">MyCompany</span>

<span class="w">    </span><span class="p">}</span>

<span class="p">});</span>

<span class="cp">#[derive(Default, Clone, Debug, PartialEq)]</span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">MyCompany</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">name</span>: <span class="nb">String</span><span class="p">,</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">max_salary</span>: <span class="kt">u32</span><span class="p">,</span>

<span class="p">}</span>

<span class="cp">#[derive(Default)]</span>

<span class="k">struct</span> <span class="nc">State</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="n">resources</span>: <span class="nc">ResourceTable</span><span class="p">,</span>

<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">State</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">new_company</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">company</span>: <span class="nc">MyCompany</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Resource</span><span class="o">&lt;</span><span class="n">MyCompany</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">resources</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">company</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span>

<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">get_company</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">company</span>: <span class="kp">&amp;</span><span class="nc">Resource</span><span class="o">&lt;</span><span class="n">MyCompany</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">MyCompany</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">resources</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">company</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span>

<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">get_company_mut</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">company</span>: <span class="kp">&amp;</span><span class="nc">Resource</span><span class="o">&lt;</span><span class="n">MyCompany</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">MyCompany</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">resources</span><span class="p">.</span><span class="n">get_mut</span><span class="p">(</span><span class="n">company</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span>

<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">drop_company</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">company</span>: <span class="nc">Resource</span><span class="o">&lt;</span><span class="n">MyCompany</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">resources</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="n">company</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">component_test</span>::<span class="n">wit_protocol</span>::<span class="n">companies</span>::<span class="n">HostCompanyRes</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">State</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">name</span>: <span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">max_salary</span>: <span class="kt">u32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Resource</span><span class="o">&lt;</span><span class="n">MyCompany</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">new_company</span><span class="p">(</span><span class="n">MyCompany</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">max_salary</span><span class="w"> </span><span class="p">}))</span>

<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">get_name</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">self_</span>: <span class="nc">Resource</span><span class="o">&lt;</span><span class="n">MyCompany</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">get_company</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self_</span><span class="p">).</span><span class="n">name</span><span class="p">.</span><span class="n">clone</span><span class="p">())</span>

<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">self_</span>: <span class="nc">Resource</span><span class="o">&lt;</span><span class="n">MyCompany</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span>: <span class="nb">String</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">get_company_mut</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self_</span><span class="p">).</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>

<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">get_max_salary</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">self_</span>: <span class="nc">Resource</span><span class="o">&lt;</span><span class="n">MyCompany</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">get_company</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self_</span><span class="p">).</span><span class="n">max_salary</span><span class="p">)</span>

<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">drop</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">rep</span>: <span class="nc">Resource</span><span class="o">&lt;</span><span class="n">MyCompany</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">drop_company</span><span class="p">(</span><span class="n">rep</span><span class="p">))</span>

<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">component_test</span>::<span class="n">wit_protocol</span>::<span class="n">companies</span>::<span class="n">Host</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">State</span><span class="w"> </span><span class="p">{}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">component_test</span>::<span class="n">wit_protocol</span>::<span class="n">host_fns</span>::<span class="n">Host</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">State</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">company_roundtrip</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">company</span>: <span class="nc">Resource</span><span class="o">&lt;</span><span class="n">MyCompany</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Resource</span><span class="o">&lt;</span><span class="n">MyCompany</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">company</span><span class="p">);</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">get_company_mut</span><span class="p">(</span><span class="o">&amp;</span><span class="n">company</span><span class="p">).</span><span class="n">name</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s">" trip"</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">company</span><span class="p">)</span>

<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">company_borrow_roundtrip</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">company</span>: <span class="nc">Resource</span><span class="o">&lt;</span><span class="n">MyCompany</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">company</span><span class="p">);</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">get_company_mut</span><span class="p">(</span><span class="o">&amp;</span><span class="n">company</span><span class="p">).</span><span class="n">name</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s">" trip"</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>

<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">ResourcesImports</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">State</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">log</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">message</span>: <span class="nb">String</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="n">wasm_bridge</span>::<span class="n">helpers</span>::<span class="n">println</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span><span class="s">"GUEST SAYS: {message}"</span><span class="p">));</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>

<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">run_test</span><span class="p">(</span><span class="n">component_bytes</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">wasm_component_model</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">State</span>::<span class="n">default</span><span class="p">());</span>

<span class="w">    </span><span class="cp">#[allow(deprecated)]</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Component</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">.</span><span class="n">engine</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">component_bytes</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">engine</span><span class="p">());</span>

<span class="w">    </span><span class="n">Resources</span>::<span class="n">add_to_linker</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">state</span><span class="o">|</span><span class="w"> </span><span class="n">state</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="cp">#[allow(deprecated)]</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">instance</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Resources</span>::<span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">component</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">linker</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="n">instance</span><span class="p">.</span><span class="n">call_simple</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span>

<span class="w">        </span><span class="p">.</span><span class="n">component_test_wit_protocol_employees</span><span class="p">()</span>

<span class="w">        </span><span class="p">.</span><span class="n">employee_res</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">guest_fns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span><span class="p">.</span><span class="n">component_test_wit_protocol_guest_fns</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Company roundtrip</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">company</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">store</span><span class="p">.</span><span class="n">data_mut</span><span class="p">().</span><span class="n">new_company</span><span class="p">(</span><span class="n">MyCompany</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="n">name</span>: <span class="s">"CompanyName"</span><span class="p">.</span><span class="n">into</span><span class="p">(),</span>

<span class="w">        </span><span class="n">max_salary</span>: <span class="mi">30_000</span><span class="p">,</span>

<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// We are dropping the Resource handle but the resource still exists!</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">company</span><span class="p">.</span><span class="n">rep</span><span class="p">();</span>

<span class="w">    </span><span class="nb">drop</span><span class="p">(</span><span class="n">company</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">company</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Resource</span>::<span class="n">new_own</span><span class="p">(</span><span class="n">rep</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">guest_fns</span>

<span class="w">        </span><span class="p">.</span><span class="n">call_company_roundtrip</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">company</span><span class="p">)</span>

<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span>

<span class="w">        </span><span class="n">store</span><span class="p">.</span><span class="n">data</span><span class="p">().</span><span class="n">get_company</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">).</span><span class="n">name</span><span class="p">,</span>

<span class="w">        </span><span class="s">"CompanyName round trip"</span>

<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="c1">// store.data_mut().drop_company(result);</span>

<span class="w">    </span><span class="c1">// Employee borrow roundtrip</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">employee</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">employees</span>

<span class="w">        </span><span class="p">.</span><span class="n">call_constructor</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"EmployeeBorrow"</span><span class="p">.</span><span class="n">into</span><span class="p">(),</span><span class="w"> </span><span class="mi">50_000</span><span class="p">)</span>

<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="n">guest_fns</span>

<span class="w">        </span><span class="p">.</span><span class="n">call_employee_borrow_roundtrip</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">employee</span><span class="p">)</span>

<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span>

<span class="w">        </span><span class="n">employees</span><span class="p">.</span><span class="n">call_get_name</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">employee</span><span class="p">).</span><span class="n">unwrap</span><span class="p">(),</span>

<span class="w">        </span><span class="s">"EmployeeBorrow round trip"</span>

<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Company roundtrip</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">company</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">store</span><span class="p">.</span><span class="n">data_mut</span><span class="p">().</span><span class="n">new_company</span><span class="p">(</span><span class="n">MyCompany</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="n">name</span>: <span class="s">"CompanyBorrow"</span><span class="p">.</span><span class="n">into</span><span class="p">(),</span>

<span class="w">        </span><span class="n">max_salary</span>: <span class="mi">30_000</span><span class="p">,</span>

<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="n">guest_fns</span>

<span class="w">        </span><span class="p">.</span><span class="n">call_company_borrow_roundtrip</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">Resource</span>::<span class="n">new_borrow</span><span class="p">(</span><span class="n">company</span><span class="p">.</span><span class="n">rep</span><span class="p">()))</span>

<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span>

<span class="w">        </span><span class="n">store</span><span class="p">.</span><span class="n">data</span><span class="p">().</span><span class="n">get_company</span><span class="p">(</span><span class="o">&amp;</span><span class="n">company</span><span class="p">).</span><span class="n">name</span><span class="p">,</span>

<span class="w">        </span><span class="s">"CompanyBorrow round trip"</span>

<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="c1">// store.data_mut().drop_company(result);</span>

<span class="w">    </span><span class="c1">// Employee roundtrip</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">employee</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">employees</span>

<span class="w">        </span><span class="p">.</span><span class="n">call_constructor</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"EmployeeName"</span><span class="p">.</span><span class="n">into</span><span class="p">(),</span><span class="w"> </span><span class="mi">50_000</span><span class="p">)</span>

<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">guest_fns</span>

<span class="w">        </span><span class="p">.</span><span class="n">call_employee_roundtrip</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">employee</span><span class="p">)</span>

<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span>

<span class="w">        </span><span class="n">employees</span><span class="p">.</span><span class="n">call_get_name</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">).</span><span class="n">unwrap</span><span class="p">(),</span>

<span class="w">        </span><span class="s">"EmployeeName round trip"</span>

<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Find job - no job found</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">employee</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">employees</span>

<span class="w">        </span><span class="p">.</span><span class="n">call_constructor</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"Mike"</span><span class="p">.</span><span class="n">into</span><span class="p">(),</span><span class="w"> </span><span class="mi">50_000</span><span class="p">)</span>

<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span>

<span class="w">        </span><span class="n">employees</span><span class="p">.</span><span class="n">call_get_name</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">employee</span><span class="p">).</span><span class="n">unwrap</span><span class="p">(),</span>

<span class="w">        </span><span class="s">"Mike"</span>

<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">company1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">store</span><span class="p">.</span><span class="n">data_mut</span><span class="p">().</span><span class="n">new_company</span><span class="p">(</span><span class="n">MyCompany</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="n">name</span>: <span class="s">"Company1"</span><span class="p">.</span><span class="n">into</span><span class="p">(),</span>

<span class="w">        </span><span class="n">max_salary</span>: <span class="mi">30_000</span><span class="p">,</span>

<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">guest_fns</span>

<span class="w">        </span><span class="p">.</span><span class="n">call_method_find_job</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">employee</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">company1</span><span class="p">])</span>

<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">is_none</span><span class="p">());</span>

<span class="w">    </span><span class="c1">// Find job - job found</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">employee</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">employees</span>

<span class="w">        </span><span class="p">.</span><span class="n">call_constructor</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"Mike"</span><span class="p">.</span><span class="n">into</span><span class="p">(),</span><span class="w"> </span><span class="mi">50_000</span><span class="p">)</span>

<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">company1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">store</span><span class="p">.</span><span class="n">data_mut</span><span class="p">().</span><span class="n">new_company</span><span class="p">(</span><span class="n">MyCompany</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="n">name</span>: <span class="s">"Company1"</span><span class="p">.</span><span class="n">into</span><span class="p">(),</span>

<span class="w">        </span><span class="n">max_salary</span>: <span class="mi">30_000</span><span class="p">,</span>

<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">company2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">store</span><span class="p">.</span><span class="n">data_mut</span><span class="p">().</span><span class="n">new_company</span><span class="p">(</span><span class="n">MyCompany</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="n">name</span>: <span class="s">"Company2"</span><span class="p">.</span><span class="n">into</span><span class="p">(),</span>

<span class="w">        </span><span class="n">max_salary</span>: <span class="mi">60_000</span><span class="p">,</span>

<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">guest_fns</span>

<span class="w">        </span><span class="p">.</span><span class="n">call_method_find_job</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">employee</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">company1</span><span class="p">,</span><span class="w"> </span><span class="n">company2</span><span class="p">])</span>

<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="w"> </span><span class="c1">// WASM call</span>

<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span><span class="w"> </span><span class="c1">// Option return type</span>

<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">data</span><span class="p">().</span><span class="n">get_company</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">).</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">"Company2"</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// store.data_mut().drop_company(result);</span>

<span class="w">    </span><span class="c1">// TODO: assert that all resources have been deleted</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>

<span class="p">}</span>
</code></pre></div>
</div></div>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>