<html>
<head><meta charset="utf-8"><title>Error &quot;assertion `left == right` failed&quot; on Wasm module init 路 wasmtime 路 Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/index.html">wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Error.20.22assertion.20.60left.20.3D.3D.20right.60.20failed.22.20on.20Wasm.20module.20init.html">Error &quot;assertion `left == right` failed&quot; on Wasm module init</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="485601882"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Error%20%22assertion%20%60left%20%3D%3D%20right%60%20failed%22%20on%20Wasm%20module%20init/near/485601882" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Error.20.22assertion.20.60left.20.3D.3D.20right.60.20failed.22.20on.20Wasm.20module.20init.html#485601882">(Dec 02 2024 at 11:25)</a>:</h4>
<p>I'm trying to run a Kotlin-produced Wasm module in Rust-embedded Wasmtime. Kotlin requires Wasm GC proposal support from the runtime which Wasmtime officially has now since version 27.0.0. </p>
<p>Unfortunately it fails at module init. I'm new to Rust and maybe I'm making some obvious mistake so I would appreciate any pointers on how to debug/fix this issue.</p>
<p>Actually I am able to run the Kotlin-produced guest when Wasmtime is embedded in Go with wasmtime-go bindings (manually updated to use Wasmtime 27.0.0). There are some issues with that too (<a class="stream-topic" data-stream-id="217126" href="/#narrow/channel/217126-wasmtime/topic/How.20to.20deal.20with.20.22GC.20heap.20out.20of.20memory.22.20errors.3F">#wasmtime &gt; How to deal with "GC heap out of memory" errors?</a> ) but at least it doesn't fail on module init so I assume it should work when Wasmtime is embedded in Rust too.</p>
<p>I've removed almost everything from the Kotlin guest, it only contains this now:</p>
<div class="codehilite" data-code-language="Kotlin"><pre><span></span><code><span class="kd">fun</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>
</code></pre></div>
<p>And this is the host code, taken from the docs with very few modifications:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasi_common</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">WasiCtxBuilder</span><span class="p">;</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">config</span>
<span class="w">        </span><span class="p">.</span><span class="n">wasm_gc</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">wasm_function_references</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasi_common</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">add_to_linker</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">s</span><span class="o">|</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasiCtxBuilder</span><span class="p">::</span><span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">inherit_stderr</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">inherit_stdout</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">build</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">wasi</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span><span class="p">::</span><span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="s">"kotlin.wasm"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">linker</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<p>This fails at <code>linker.instantiate</code> call with an error:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">~/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">27.0.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">type_registry</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">271</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span>
<span class="nc">assertion</span><span class="w"> </span><span class="err">`</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="err">`</span><span class="w"> </span><span class="n">failed</span>
<span class="w">  </span><span class="n">left</span><span class="p">:</span><span class="w"> </span><span class="nc">WasmSubType</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">is_final</span><span class="p">:</span><span class="w"> </span><span class="nc">true</span><span class="p">,</span><span class="w"> </span><span class="n">supertype</span><span class="p">:</span><span class="w"> </span><span class="nb">None</span><span class="p">,</span><span class="w"> </span><span class="n">composite_type</span><span class="p">:</span><span class="w"> </span><span class="nc">WasmCompositeType</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">inner</span><span class="p">:</span><span class="w"> </span><span class="nc">Struct</span><span class="p">(</span><span class="n">WasmStructType</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">fields</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">}),</span><span class="w"> </span><span class="n">shared</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w"> </span><span class="n">right</span><span class="p">:</span><span class="w"> </span><span class="nc">WasmSubType</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">is_final</span><span class="p">:</span><span class="w"> </span><span class="nc">true</span><span class="p">,</span><span class="w"> </span><span class="n">supertype</span><span class="p">:</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">Engine</span><span class="p">(</span><span class="n">VMSharedTypeIndex</span><span class="p">(</span><span class="mi">19</span><span class="p">))),</span><span class="w"> </span><span class="n">composite_type</span><span class="p">:</span><span class="w"> </span><span class="nc">WasmCompositeType</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">inner</span><span class="p">:</span><span class="w"> </span><span class="nc">Struct</span><span class="p">(</span><span class="n">WasmStructType</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">fields</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">}),</span><span class="w"> </span><span class="n">shared</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>

<span class="n">stack</span><span class="w"> </span><span class="n">backtrace</span><span class="p">:</span>
<span class="w">   </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="nc">rust_begin_unwind</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">f6e511eec7342f59a25f7c0534f1dbea00d01b14</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">662</span><span class="p">:</span><span class="mi">5</span>
<span class="w">   </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">panic_fmt</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">f6e511eec7342f59a25f7c0534f1dbea00d01b14</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">74</span><span class="p">:</span><span class="mi">14</span>
<span class="w">   </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">assert_failed_inner</span>
<span class="w">   </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">assert_failed</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">f6e511eec7342f59a25f7c0534f1dbea00d01b14</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">367</span><span class="p">:</span><span class="mi">5</span>
<span class="w">   </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">type_registry</span><span class="p">::</span><span class="n">RegisteredType</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">cmp</span><span class="p">::</span><span class="nb">PartialEq</span><span class="o">&gt;</span><span class="p">::</span><span class="n">eq</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">~/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">27.0.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">type_registry</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">271</span><span class="p">:</span><span class="mi">17</span>
<span class="w">   </span><span class="mi">5</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">cmp</span><span class="p">::</span><span class="n">impls</span><span class="p">::</span><span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">cmp</span><span class="p">::</span><span class="nb">PartialEq</span><span class="o">&lt;&amp;</span><span class="n">B</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">&amp;</span><span class="n">A</span><span class="o">&gt;</span><span class="p">::</span><span class="n">eq</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">f6e511eec7342f59a25f7c0534f1dbea00d01b14</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">cmp</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">1661</span><span class="p">:</span><span class="mi">13</span>
<span class="w">   </span><span class="mi">6</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">Q</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">hashbrown</span><span class="p">::</span><span class="n">Equivalent</span><span class="o">&lt;</span><span class="n">K</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">equivalent</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">~/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">hashbrown</span><span class="o">-</span><span class="mf">0.14.5</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">172</span><span class="p">:</span><span class="mi">9</span>
<span class="w">   </span><span class="mi">7</span><span class="p">:</span><span class="w"> </span><span class="nc">hashbrown</span><span class="p">::</span><span class="n">map</span><span class="p">::</span><span class="n">equivalent_key</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">~/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">hashbrown</span><span class="o">-</span><span class="mf">0.14.5</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">map</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">229</span><span class="p">:</span><span class="mi">14</span>
<span class="w">   </span><span class="mi">8</span><span class="p">:</span><span class="w"> </span><span class="nc">hashbrown</span><span class="p">::</span><span class="n">raw</span><span class="p">::</span><span class="n">inner</span><span class="p">::</span><span class="n">RawTable</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">A</span><span class="o">&gt;</span><span class="p">::</span><span class="n">find_or_find_insert_slot</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">~/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">hashbrown</span><span class="o">-</span><span class="mf">0.14.5</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">raw</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">1425</span><span class="p">:</span><span class="mi">68</span>
<span class="w">   </span><span class="mi">9</span><span class="p">:</span><span class="w"> </span><span class="nc">hashbrown</span><span class="p">::</span><span class="n">raw</span><span class="p">::</span><span class="n">inner</span><span class="p">::</span><span class="n">RawTableInner</span><span class="p">::</span><span class="n">find_or_find_insert_slot_inner</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">~/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">hashbrown</span><span class="o">-</span><span class="mf">0.14.5</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">raw</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">1983</span><span class="p">:</span><span class="mi">27</span>
<span class="w">  </span><span class="mi">10</span><span class="p">:</span><span class="w"> </span><span class="nc">hashbrown</span><span class="p">::</span><span class="n">raw</span><span class="p">::</span><span class="n">inner</span><span class="p">::</span><span class="n">RawTable</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">A</span><span class="o">&gt;</span><span class="p">::</span><span class="n">find_or_find_insert_slot</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">~/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">hashbrown</span><span class="o">-</span><span class="mf">0.14.5</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">raw</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">1423</span><span class="p">:</span><span class="mi">19</span>
<span class="w">  </span><span class="mi">11</span><span class="p">:</span><span class="w"> </span><span class="nc">hashbrown</span><span class="p">::</span><span class="n">map</span><span class="p">::</span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="n">V</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">A</span><span class="o">&gt;</span><span class="p">::</span><span class="n">insert</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">~/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">hashbrown</span><span class="o">-</span><span class="mf">0.14.5</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">map</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">1754</span><span class="p">:</span><span class="mi">15</span>
<span class="w">  </span><span class="mi">12</span><span class="p">:</span><span class="w"> </span><span class="nc">hashbrown</span><span class="p">::</span><span class="n">set</span><span class="p">::</span><span class="n">HashSet</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">A</span><span class="o">&gt;</span><span class="p">::</span><span class="n">insert</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">~/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">hashbrown</span><span class="o">-</span><span class="mf">0.14.5</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">set</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">1115</span><span class="p">:</span><span class="mi">9</span>
<span class="w">  </span><span class="mi">13</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">store</span><span class="p">::</span><span class="n">StoreOpaque</span><span class="p">::</span><span class="n">insert_gc_host_alloc_type</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">~/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">27.0.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">store</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">1797</span><span class="p">:</span><span class="mi">9</span>
<span class="w">  </span><span class="mi">14</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">gc</span><span class="p">::</span><span class="n">enabled</span><span class="p">::</span><span class="n">structref</span><span class="p">::</span><span class="n">StructRefPre</span><span class="p">::</span><span class="n">_new</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">~/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">27.0.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">gc</span><span class="o">/</span><span class="n">enabled</span><span class="o">/</span><span class="n">structref</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">74</span><span class="p">:</span><span class="mi">9</span>
<span class="w">  </span><span class="mi">15</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">vm</span><span class="p">::</span><span class="n">const_expr</span><span class="p">::</span><span class="n">ConstEvalContext</span><span class="p">::</span><span class="n">struct_new</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">~/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">27.0.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">const_expr</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">93</span><span class="p">:</span><span class="mi">25</span>
<span class="w">  </span><span class="mi">16</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">vm</span><span class="p">::</span><span class="n">const_expr</span><span class="p">::</span><span class="n">ConstEvalContext</span><span class="p">::</span><span class="n">struct_new_default</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">~/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">27.0.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">const_expr</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">153</span><span class="p">:</span><span class="mi">18</span>
<span class="w">  </span><span class="mi">17</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">vm</span><span class="p">::</span><span class="n">const_expr</span><span class="p">::</span><span class="n">ConstExprEvaluator</span><span class="p">::</span><span class="n">eval</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">~/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">27.0.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">const_expr</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">278</span><span class="p">:</span><span class="mi">31</span>
<span class="w">  </span><span class="mi">18</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">vm</span><span class="p">::</span><span class="n">instance</span><span class="p">::</span><span class="n">allocator</span><span class="p">::</span><span class="n">initialize_globals</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">~/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">27.0.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">instance</span><span class="o">/</span><span class="n">allocator</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">779</span><span class="p">:</span><span class="mi">13</span>
<span class="w">  </span><span class="mi">19</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">vm</span><span class="p">::</span><span class="n">instance</span><span class="p">::</span><span class="n">allocator</span><span class="p">::</span><span class="n">initialize_instance</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">~/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">27.0.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">instance</span><span class="o">/</span><span class="n">allocator</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">826</span><span class="p">:</span><span class="mi">5</span>
<span class="w">  </span><span class="mi">20</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">vm</span><span class="p">::</span><span class="n">instance</span><span class="p">::</span><span class="n">InstanceHandle</span><span class="p">::</span><span class="n">initialize</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">~/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">27.0.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">instance</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">1541</span><span class="p">:</span><span class="mi">9</span>
<span class="w">  </span><span class="mi">21</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">instance</span><span class="p">::</span><span class="n">Instance</span><span class="p">::</span><span class="n">new_raw</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">~/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">27.0.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">instance</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">343</span><span class="p">:</span><span class="mi">9</span>
<span class="w">  </span><span class="mi">22</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">instance</span><span class="p">::</span><span class="n">Instance</span><span class="p">::</span><span class="n">new_started_impl</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">~/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">27.0.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">instance</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">206</span><span class="p">:</span><span class="mi">33</span>
<span class="w">  </span><span class="mi">23</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">instance</span><span class="p">::</span><span class="n">Instance</span><span class="p">::</span><span class="n">new_started</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">~/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">27.0.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">instance</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">194</span><span class="p">:</span><span class="mi">9</span>
<span class="w">  </span><span class="mi">24</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">instance</span><span class="p">::</span><span class="n">InstancePre</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">instantiate</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">~/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">27.0.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">instance</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">876</span><span class="p">:</span><span class="mi">18</span>
<span class="w">  </span><span class="mi">25</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">linker</span><span class="p">::</span><span class="n">Linker</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">instantiate</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">~/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">27.0.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">linker</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">1112</span><span class="p">:</span><span class="mi">9</span>
<span class="w">  </span><span class="mi">26</span><span class="p">:</span><span class="w"> </span><span class="nc">jobexecutor</span><span class="p">::</span><span class="n">main</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">5</span>
<span class="w">  </span><span class="mi">27</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">ops</span><span class="p">::</span><span class="n">function</span><span class="p">::</span><span class="nb">FnOnce</span><span class="p">::</span><span class="n">call_once</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">f6e511eec7342f59a25f7c0534f1dbea00d01b14</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ops</span><span class="o">/</span><span class="n">function</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">250</span><span class="p">:</span><span class="mi">5</span>
</code></pre></div>
<p>It seems to be Wasm GC-related, it could have been some incompatibility between Wasmtime and Kotlin-produced Wasm but then it is not clear how is it possible that Go-embedded Wasmtime is able to init the module without issues.</p>



<a name="485611524"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Error%20%22assertion%20%60left%20%3D%3D%20right%60%20failed%22%20on%20Wasm%20module%20init/near/485611524" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Error.20.22assertion.20.60left.20.3D.3D.20right.60.20failed.22.20on.20Wasm.20module.20init.html#485611524">(Dec 02 2024 at 12:18)</a>:</h4>
<p>The same Wasm file can be executed successfully in the standalone mode with <code>wasmtime -W function-references,gc</code>.</p>



<a name="485680928"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Error%20%22assertion%20%60left%20%3D%3D%20right%60%20failed%22%20on%20Wasm%20module%20init/near/485680928" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Error.20.22assertion.20.60left.20.3D.3D.20right.60.20failed.22.20on.20Wasm.20module.20init.html#485680928">(Dec 02 2024 at 18:02)</a>:</h4>
<p>Thanks for the report! Could you file an issue in the Wasmtime repository for this?</p>



<a name="485766032"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Error%20%22assertion%20%60left%20%3D%3D%20right%60%20failed%22%20on%20Wasm%20module%20init/near/485766032" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Error.20.22assertion.20.60left.20.3D.3D.20right.60.20failed.22.20on.20Wasm.20module.20init.html#485766032">(Dec 03 2024 at 06:29)</a>:</h4>
<p>Sure, created a Github issue: <a href="https://github.com/bytecodealliance/wasmtime/issues/9714">https://github.com/bytecodealliance/wasmtime/issues/9714</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/issues/9714" style="background-image: url(&quot;https://uploads.zulipusercontent.net/595e3d1f06b86f53234585c68eb99872487a3a52/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f393835346438353862303339393361353931396434373039346330343936653864373632336433313662356263303739376162663636306236396563626534652f62797465636f6465616c6c69616e63652f7761736d74696d652f6973737565732f39373134&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/issues/9714" title="Error `assertion left == right failed` on Wasm module init in Rust-embedded Wasmtime 路 Issue #9714 路 bytecodealliance/wasmtime">Error `assertion left == right failed` on Wasm module init in Rust-embedded Wasmtime 路 Issue #9714 路 bytecodealliance/wasmtime</a></div><div class="message_embed_description">Test Case I'm trying to run a Kotlin-produced Wasm module in Rust-embedded Wasmtime. Kotlin requires support for the Wasm GC proposal, which Wasmtime officially has since version 27.0.0. Unfortunat...</div></div></div>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>