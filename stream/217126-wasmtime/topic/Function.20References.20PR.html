<html>
<head><meta charset="utf-8"><title>Function References PR · wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/index.html">wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html">Function References PR</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="348792818"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/348792818" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ivan Mikushin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#348792818">(Apr 12 2023 at 17:28)</a>:</h4>
<p>I've noticed this PR (<a href="https://github.com/bytecodealliance/wasmtime/pull/5288">https://github.com/bytecodealliance/wasmtime/pull/5288</a>) hasn't had any activity since Mar 3. Function references is listed as a pre-requisite to Wasm GC, so seems pretty important to get this in. Is anybody working on this? Any idea if this is still getting merged any time soon?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/5288" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/ae4a338a4c24965312c95e4b642e7aa5ce797b5c\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f633238343461646465353133386139396437623539636463616666323366616165316366393233623239666538363966383565613030626130666135653562342f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f35323838)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/5288" title="Function references by CosineP · Pull Request #5288 · bytecodealliance/wasmtime">Function references by CosineP · Pull Request #5288 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">This patch, written by @dhil and I, implements the (complete) function references proposal, forming the wasmtime side of the existing pull request bytecodealliance/wasm-tools#701.   It is missing s...</div></div></div>



<a name="348798993"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/348798993" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#348798993">(Apr 12 2023 at 17:58)</a>:</h4>
<p><span class="user-mention" data-user-id="500234">@Luna Phipps-Costin</span> <span class="user-mention" data-user-id="500204">@Daniel Hillerström</span>: are you still working on that pull request? anything we can do to unblock you?</p>



<a name="348813492"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/348813492" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Hillerström <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#348813492">(Apr 12 2023 at 19:11)</a>:</h4>
<p><span class="user-mention" data-user-id="253990">@fitzgen (he/him)</span> yes, I am actively working on it. I am currently blocked on a paper deadline this Saturday :-)) I think what I need help with addressing is where to add the error paths for the embedder side of things (c.f. <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#discussion_r1126569577">https://github.com/bytecodealliance/wasmtime/pull/5288#discussion_r1126569577</a>). I am quite eager to land the patch as it will make it much easier for me to keep up with changes to wasmtime on my continuations branch</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/5288#discussion_r1126569577" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/6290460d4b234e3d9e1cda399acd215d5c15409e\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f626436656339623833626336346565336433316164353365616132356662373634343431663564653833626163353863363536306336343637343830383536302f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f35323838)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/5288#discussion_r1126569577" title="Function references by CosineP · Pull Request #5288 · bytecodealliance/wasmtime">Function references by CosineP · Pull Request #5288 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">This patch, written by @dhil and I, implements the (complete) function references proposal, forming the wasmtime side of the existing pull request bytecodealliance/wasm-tools#701.   It is missing s...</div></div></div>



<a name="348827169"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/348827169" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#348827169">(Apr 12 2023 at 20:28)</a>:</h4>
<p>I've been thinking a lot about the embedder API side of things as I work on the RFC for wasm-gc, will share more soon</p>
<p>unfortunately, I don't think Alex's suggestion to skip the embedder API as a temporary stopgap to unblock other work is actually feasible since we will need the embedder API to get <code>.wast</code> tests running</p>



<a name="348828033"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/348828033" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Hillerström <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#348828033">(Apr 12 2023 at 20:33)</a>:</h4>
<p>OK, what path forward do you suggest?</p>



<a name="348834881"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/348834881" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#348834881">(Apr 12 2023 at 21:18)</a>:</h4>
<p>I think we will need to properly address the embedder API, I have a couple ideas, but need to talk it over with folks to decide which path is best. should have more guidance by the time you're done with your paper deadline :)</p>



<a name="349022346"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/349022346" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Hillerström <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#349022346">(Apr 13 2023 at 07:29)</a>:</h4>
<p>Excellent thanks! Maybe we can meet at the end of next week, or the week after, such that I can learn more about your ideas?</p>



<a name="349150031"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/349150031" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#349150031">(Apr 13 2023 at 15:53)</a>:</h4>
<p>how would monday at 11:30am pacific work?</p>



<a name="349208558"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/349208558" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Hillerström <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#349208558">(Apr 13 2023 at 20:43)</a>:</h4>
<p><span class="user-mention" data-user-id="253990">@fitzgen (he/him)</span> that ought to work for me, thanks! (Monday April 17)</p>



<a name="349224165"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/349224165" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ivan Mikushin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#349224165">(Apr 13 2023 at 22:34)</a>:</h4>
<p>(deleted)</p>



<a name="421902333"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421902333" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421902333">(Feb 16 2024 at 17:08)</a>:</h4>
<p><span class="user-mention" data-user-id="253990">@fitzgen (he/him)</span> re <a href="https://github.com/bytecodealliance/wasmtime/pull/7943">https://github.com/bytecodealliance/wasmtime/pull/7943</a> and the <code>FuncType</code> field of <code>TypedFunc</code>, might be faster to do this here -- two comments of yours indicate we can remove it via <code>WasmTy for TypedFunc&lt;...&gt;</code>, but isn't the type still needed to thread through to <code>call_raw</code>?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/7943" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/4bca56426f2f782603b379ec3867380e680bf7fd\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f373931633465316661386331623938333433396534376635333266303934626436313633346237353531653236663731613836636436643937643362653635652f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f37393433)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/7943" title="Wasmtime: Finish support for the typed function references proposal by fitzgen · Pull Request #7943 · bytecodealliance/wasmtime">Wasmtime: Finish support for the typed function references proposal by fitzgen · Pull Request #7943 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">While we supported the function references proposal inside Wasm, we didn't support it on the "outside" in the Wasmtime embedder APIs. So much of the work here is exposing typed function references,...</div></div></div>



<a name="421902410"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421902410" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421902410">(Feb 16 2024 at 17:09)</a>:</h4>
<p>e.g. somehow I thought we needed to have type information to flow into the runtime type-checks of the arguments</p>



<a name="421902552"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421902552" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421902552">(Feb 16 2024 at 17:10)</a>:</h4>
<p>the only reason the type is needed to thread through to <code>call_raw</code> is for runtime checks, which would no longer be needed if we stop doing runtime checks :)</p>
<p>and we could stop doing runtime checks, but still allow static typing of functions that use concrete type refernces via <code>impl WasmTy for TypedFunc</code></p>



<a name="421902688"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421902688" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421902688">(Feb 16 2024 at 17:10)</a>:</h4>
<p>we'll still need runtime checks for gc types though right?</p>



<a name="421902705"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421902705" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421902705">(Feb 16 2024 at 17:10)</a>:</h4>
<p>e.g. <code>(ref $struct_type)</code></p>



<a name="421902729"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421902729" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421902729">(Feb 16 2024 at 17:10)</a>:</h4>
<p>so not for anything currently but needed in the future soon</p>



<a name="421902741"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421902741" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421902741">(Feb 16 2024 at 17:10)</a>:</h4>
<p>I think we could have <code>TypedStruct&lt;(...)&gt;</code></p>



<a name="421902776"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421902776" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421902776">(Feb 16 2024 at 17:11)</a>:</h4>
<p>oh you're thinking we can skip the derive?</p>



<a name="421902782"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421902782" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421902782">(Feb 16 2024 at 17:11)</a>:</h4>
<p>or make it much simpler?</p>



<a name="421902912"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421902912" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421902912">(Feb 16 2024 at 17:12)</a>:</h4>
<p>I suppose you're thinking like <code>TypedStruct&lt;(i32, Mut&lt;i32&gt;)&gt;</code> for mutable fields?</p>



<a name="421902973"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421902973" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421902973">(Feb 16 2024 at 17:12)</a>:</h4>
<p>yeah, it would <em>not</em> be turning <code>repr(C)</code> rust structs into GC types and vice versa</p>
<p>it would be "I have type checked that the instance of this struct has the type parameters fields"</p>



<a name="421902982"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421902982" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421902982">(Feb 16 2024 at 17:12)</a>:</h4>
<p>something like that</p>



<a name="421903033"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421903033" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421903033">(Feb 16 2024 at 17:12)</a>:</h4>
<p>unclear what to do wrt recursion groups and nominal types</p>



<a name="421903052"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421903052" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421903052">(Feb 16 2024 at 17:12)</a>:</h4>
<p>I was just thinking that heh</p>



<a name="421903100"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421903100" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421903100">(Feb 16 2024 at 17:12)</a>:</h4>
<p>e.g. all the canonicalization that wasm-gc does</p>



<a name="421903114"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421903114" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421903114">(Feb 16 2024 at 17:13)</a>:</h4>
<p>that'd be hard to reflect into Rust</p>



<a name="421903223"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421903223" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421903223">(Feb 16 2024 at 17:13)</a>:</h4>
<p>I guess even if we restricted it to structural stuff, and had cyclic edges be supertypes, which would allow reading offsets of the underlying object directly, we would still need a dynamic type check when passing into a typed function</p>



<a name="421903350"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421903350" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421903350">(Feb 16 2024 at 17:14)</a>:</h4>
<p>ok so maybe this isn't worth pursuing</p>



<a name="421903387"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421903387" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421903387">(Feb 16 2024 at 17:14)</a>:</h4>
<p>or at least, not worth undoing what we have now</p>



<a name="421903423"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421903423" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421903423">(Feb 16 2024 at 17:14)</a>:</h4>
<p>so while <code>TypedFunc</code> typechecks could go away we'll still need  the type information in the future</p>



<a name="421903434"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421903434" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421903434">(Feb 16 2024 at 17:14)</a>:</h4>
<p>might still be worth it even if it doesn't 100% solve the problem</p>



<a name="421903448"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421903448" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421903448">(Feb 16 2024 at 17:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="253994">Alex Crichton</span> <a href="#narrow/stream/217126-wasmtime/topic/Function.20References.20PR/near/421903423">said</a>:</p>
<blockquote>
<p>so while <code>TypedFunc</code> typechecks could go away we'll still need  the type information in the future</p>
</blockquote>
<p>right</p>



<a name="421903460"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421903460" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421903460">(Feb 16 2024 at 17:14)</a>:</h4>
<p>it might be useful to have it available for simple cases yeah</p>



<a name="421903498"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421903498" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421903498">(Feb 16 2024 at 17:15)</a>:</h4>
<p>right, but we can cross that bridge when we get to it</p>



<a name="421903511"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421903511" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421903511">(Feb 16 2024 at 17:15)</a>:</h4>
<p>so back to this PR</p>



<a name="421903553"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421903553" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421903553">(Feb 16 2024 at 17:15)</a>:</h4>
<p><code>realloc</code> doesn't have an <code>Instance</code></p>



<a name="421903559"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421903559" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421903559">(Feb 16 2024 at 17:15)</a>:</h4>
<p>do you think there's any way we could like pass around the type index and then lazily turn that into a whole function type?</p>



<a name="421903590"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421903590" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421903590">(Feb 16 2024 at 17:15)</a>:</h4>
<p>I should go look at realloc again</p>



<a name="421903618"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421903618" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421903618">(Feb 16 2024 at 17:15)</a>:</h4>
<p>it has a <code>*mut wasmtime_runtime::ComponentInstance</code></p>



<a name="421903645"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421903645" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421903645">(Feb 16 2024 at 17:15)</a>:</h4>
<p>oh wait though realloc is a vmfuncref?</p>



<a name="421903654"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421903654" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421903654">(Feb 16 2024 at 17:16)</a>:</h4>
<p>so there's a type in there?</p>



<a name="421903704"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421903704" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421903704">(Feb 16 2024 at 17:16)</a>:</h4>
<p>we could stash the raw <code>u32</code> of the <code>VMSharedTypeIndex</code> in there</p>



<a name="421903753"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421903753" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421903753">(Feb 16 2024 at 17:16)</a>:</h4>
<p>oh is it?</p>



<a name="421903763"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421903763" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421903763">(Feb 16 2024 at 17:16)</a>:</h4>
<p>checking</p>



<a name="421903766"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421903766" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421903766">(Feb 16 2024 at 17:16)</a>:</h4>
<p>er wait hang on</p>



<a name="421903773"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421903773" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421903773">(Feb 16 2024 at 17:16)</a>:</h4>
<p>this is true of all <code>call_raw</code></p>



<a name="421903804"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421903804" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421903804">(Feb 16 2024 at 17:16)</a>:</h4>
<p>we pass in vmfuncref so we can probably drop the <code>&amp;FuncType</code> parameter</p>



<a name="421903817"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421903817" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421903817">(Feb 16 2024 at 17:16)</a>:</h4>
<p>b/c we can load it lazily?</p>



<a name="421903975"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421903975" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421903975">(Feb 16 2024 at 17:17)</a>:</h4>
<p>well going from <code>VMSharedTypeIndex</code> to <code>FuncType</code> still involves locking</p>



<a name="421904047"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421904047" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421904047">(Feb 16 2024 at 17:17)</a>:</h4>
<p>I wonder if that may be the way to go though so long as it's lazy</p>



<a name="421904054"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421904054" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421904054">(Feb 16 2024 at 17:17)</a>:</h4>
<p>to increment the associated registered reference count</p>



<a name="421904060"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421904060" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421904060">(Feb 16 2024 at 17:18)</a>:</h4>
<p>keep integers/etc on the fast path</p>



<a name="421904272"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421904272" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421904272">(Feb 16 2024 at 17:19)</a>:</h4>
<p>it is really annoying that <code>wasmtime::FuncType</code> and <code>wasmtime_types::WasmFuncType</code> are not the same thing</p>



<a name="421904317"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421904317" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421904317">(Feb 16 2024 at 17:19)</a>:</h4>
<p>is there anything actually preventing them from being the sa,me?</p>



<a name="421904336"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421904336" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421904336">(Feb 16 2024 at 17:19)</a>:</h4>
<p>we could probably make them the same at this point</p>



<a name="421904357"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421904357" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421904357">(Feb 16 2024 at 17:19)</a>:</h4>
<p>or well</p>



<a name="421904389"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421904389" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421904389">(Feb 16 2024 at 17:19)</a>:</h4>
<p>I think <code>ValType</code> and <code>WasmValType</code> would still have to be different</p>



<a name="421904394"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421904394" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421904394">(Feb 16 2024 at 17:19)</a>:</h4>
<p><code>FuncType</code> has <code>ValType</code> which recursively includes <code>FuncType</code></p>



<a name="421904407"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421904407" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421904407">(Feb 16 2024 at 17:19)</a>:</h4>
<p>yeah</p>



<a name="421904433"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421904433" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421904433">(Feb 16 2024 at 17:20)</a>:</h4>
<p>time to whip out <code>ValType&lt;T&gt;</code> again</p>



<a name="421904478"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421904478" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421904478">(Feb 16 2024 at 17:20)</a>:</h4>
<p>but that's okay because we only expose params/returns publicly via <code>impl ExactSizeIterator</code></p>



<a name="421904517"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421904517" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421904517">(Feb 16 2024 at 17:20)</a>:</h4>
<p>so we could lazily do the translation at that level</p>



<a name="421904604"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421904604" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421904604">(Feb 16 2024 at 17:20)</a>:</h4>
<p>I'm always down for merging the layers of abstration</p>



<a name="421904621"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421904621" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421904621">(Feb 16 2024 at 17:20)</a>:</h4>
<p>it always feels like we have too many</p>



<a name="421904680"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421904680" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421904680">(Feb 16 2024 at 17:21)</a>:</h4>
<p>(also it is annoying that we don't have <code>VMSharedTypeIndex</code> in the <code>wasm_types</code> crate for use in <code>EngineOrModuleInternalIndex</code></p>



<a name="421904689"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421904689" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421904689">(Feb 16 2024 at 17:21)</a>:</h4>
<p>)</p>



<a name="421904716"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421904716" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421904716">(Feb 16 2024 at 17:21)</a>:</h4>
<p>okay, I agree this should be explored, but</p>



<a name="421904724"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421904724" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421904724">(Feb 16 2024 at 17:21)</a>:</h4>
<p>we could move that though?</p>



<a name="421904731"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421904731" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421904731">(Feb 16 2024 at 17:21)</a>:</h4>
<p>that one's easy to move</p>



<a name="421904745"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421904745" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421904745">(Feb 16 2024 at 17:21)</a>:</h4>
<p>I don't really want to do that in this PR</p>



<a name="421904774"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421904774" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421904774">(Feb 16 2024 at 17:21)</a>:</h4>
<p>true</p>



<a name="421904783"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421904783" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421904783">(Feb 16 2024 at 17:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="253994">Alex Crichton</span> <a href="#narrow/stream/217126-wasmtime/topic/Function.20References.20PR/near/421904724">said</a>:</p>
<blockquote>
<p>we could move that though?</p>
</blockquote>
<p>Yeah I think so</p>



<a name="421904843"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421904843" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421904843">(Feb 16 2024 at 17:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="253990">fitzgen (he/him)</span> <a href="#narrow/stream/217126-wasmtime/topic/Function.20References.20PR/near/421904517">said</a>:</p>
<blockquote>
<p>so we could lazily do the translation at that level</p>
</blockquote>
<p>lmao we already do this lazily</p>



<a name="421904931"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421904931" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421904931">(Feb 16 2024 at 17:22)</a>:</h4>
<p>we get the referenced <code>WasmFuncType</code> via our <code>Arc</code> and then lazily translate</p>



<a name="421905146"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421905146" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421905146">(Feb 16 2024 at 17:23)</a>:</h4>
<p>so if it works for this PR I think it would be best to drop the <code>&amp;FuncType</code> from <code>call_raw</code></p>



<a name="421905176"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421905176" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421905176">(Feb 16 2024 at 17:23)</a>:</h4>
<p>and somehow lazily load the type info from <code>Engine</code> if needed</p>



<a name="421905233"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421905233" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421905233">(Feb 16 2024 at 17:24)</a>:</h4>
<p>alternatively you could eagerly load and see if you can measure a perf hit</p>



<a name="421905262"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421905262" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421905262">(Feb 16 2024 at 17:24)</a>:</h4>
<p>okay so maybe I can:</p>
<ul>
<li>In this PR, refactor to make dynamic checks take a <code>WasmFuncType</code> instead of <code>FuncType</code></li>
<li>in a follow up PR, make them literally the same type?</li>
</ul>



<a name="421905322"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421905322" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421905322">(Feb 16 2024 at 17:24)</a>:</h4>
<p>or your idea, but:</p>



<a name="421905386"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421905386" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421905386">(Feb 16 2024 at 17:24)</a>:</h4>
<p>do we have a script or something for measuring RPS of <code>wasmtime serve</code>?</p>



<a name="421905405"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421905405" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421905405">(Feb 16 2024 at 17:24)</a>:</h4>
<p>nah</p>



<a name="421905410"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421905410" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421905410">(Feb 16 2024 at 17:24)</a>:</h4>
<p>I've never acrtually done that</p>



<a name="421905431"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421905431" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421905431">(Feb 16 2024 at 17:24)</a>:</h4>
<p>"pick your favorite benchmarking tool"</p>



<a name="421905470"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421905470" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421905470">(Feb 16 2024 at 17:25)</a>:</h4>
<p>you could also measure the <code>call</code> benchmark here too</p>



<a name="421905512"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421905512" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421905512">(Feb 16 2024 at 17:25)</a>:</h4>
<p>that will probably show it being disproportionately bad though given how streamlined it is today</p>



<a name="421905546"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421905546" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421905546">(Feb 16 2024 at 17:25)</a>:</h4>
<p>yeah, should do that either way (I suspect the way I implemented the dynamic checks could be improved to help the compiler boil some stuff away)</p>



<a name="421905646"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421905646" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421905646">(Feb 16 2024 at 17:26)</a>:</h4>
<p>I think the <code>call</code> benchmarks aren't sufficient here tho</p>



<a name="421905652"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421905652" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421905652">(Feb 16 2024 at 17:26)</a>:</h4>
<p>I feel like it's best though that we start with an index+engine combo and then derive info from there</p>



<a name="421905665"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421905665" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421905665">(Feb 16 2024 at 17:26)</a>:</h4>
<p>because they are single threaded</p>



<a name="421905694"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421905694" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421905694">(Feb 16 2024 at 17:26)</a>:</h4>
<p>oh you'd be surprised</p>



<a name="421905726"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421905726" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421905726">(Feb 16 2024 at 17:26)</a>:</h4>
<p>uncontended locks are surprisingly expensive in that context</p>



<a name="421905737"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421905737" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421905737">(Feb 16 2024 at 17:26)</a>:</h4>
<p>and if we are lazily constructing <code>FuncType</code>s from <code>VMSharedTypeIndex</code>s that involves locking at the engine level</p>



<a name="421905790"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421905790" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421905790">(Feb 16 2024 at 17:26)</a>:</h4>
<p>"how good is your rwlock with only readers"</p>



<a name="421905848"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421905848" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421905848">(Feb 16 2024 at 17:27)</a>:</h4>
<p>right, it might show some overhead, but not the "full" overhead</p>



<a name="421905870"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421905870" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421905870">(Feb 16 2024 at 17:27)</a>:</h4>
<p>agreed</p>



<a name="421905942"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421905942" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421905942">(Feb 16 2024 at 17:27)</a>:</h4>
<p>we could in theory build a fancier data structure though</p>



<a name="421905971"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421905971" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421905971">(Feb 16 2024 at 17:28)</a>:</h4>
<p>e.g. <code>VMSharedTypeIndex</code> could be proof of "this slot in this data structure is unchanging"</p>



<a name="421906041"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421906041" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421906041">(Feb 16 2024 at 17:28)</a>:</h4>
<p>and then we could go from <code>&amp;Engine</code> to <code>&amp;Slot</code> via that proof</p>



<a name="421906071"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421906071" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421906071">(Feb 16 2024 at 17:28)</a>:</h4>
<p>so with some elbow grease I think we could get the locks out of the way</p>



<a name="421906096"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421906096" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421906096">(Feb 16 2024 at 17:28)</a>:</h4>
<p>I don't think so: that would require RAII which isn't possible with integrating with JIT code</p>



<a name="421906145"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421906145" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421906145">(Feb 16 2024 at 17:28)</a>:</h4>
<p>I'm thinking the <code>Module</code> is "the RAII"</p>



<a name="421906166"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421906166" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421906166">(Feb 16 2024 at 17:29)</a>:</h4>
<p>where e.g. we keep <code>Module</code> in a <code>Store</code> to keep it alive today</p>



<a name="421906233"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421906233" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421906233">(Feb 16 2024 at 17:29)</a>:</h4>
<p>we could remove the locking by putting the registration count behind the <code>Arc</code>, and then having some other thing sweep the registry's hash consing map</p>



<a name="421906295"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421906295" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421906295">(Feb 16 2024 at 17:29)</a>:</h4>
<p>(remove the locking for cloning and dropping and such, at least)</p>



<a name="421906319"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421906319" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421906319">(Feb 16 2024 at 17:29)</a>:</h4>
<p>ish</p>



<a name="421906329"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421906329" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421906329">(Feb 16 2024 at 17:30)</a>:</h4>
<p>not look up</p>



<a name="421906354"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421906354" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421906354">(Feb 16 2024 at 17:30)</a>:</h4>
<p>I haven't thought this through fully</p>



<a name="421906448"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421906448" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421906448">(Feb 16 2024 at 17:30)</a>:</h4>
<p>but like if we allowed 1K types maximum we could just have a <code>Vec</code> preallocated and you index into that</p>



<a name="421906494"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421906494" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421906494">(Feb 16 2024 at 17:30)</a>:</h4>
<p>obviously not suitable but ... hm...</p>



<a name="421906516"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421906516" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421906516">(Feb 16 2024 at 17:30)</a>:</h4>
<p>well anyway I think we should try the route of "don't pass in type info"</p>



<a name="421906531"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421906531" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421906531">(Feb 16 2024 at 17:30)</a>:</h4>
<p>and see how that fares perf-wise</p>



<a name="421906558"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421906558" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421906558">(Feb 16 2024 at 17:31)</a>:</h4>
<p>we can at least be perf-neutral with scalars</p>



<a name="421906561"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421906561" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421906561">(Feb 16 2024 at 17:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="253994">Alex Crichton</span> <a href="#narrow/stream/217126-wasmtime/topic/Function.20References.20PR/near/421906145">said</a>:</p>
<blockquote>
<p>I'm thinking the <code>Module</code> is "the RAII"</p>
</blockquote>
<p>but then <code>VMSharedTypeIndex</code> itself isn't proof of anything, re are relying on the module existing and that uses have an associated module or whatever, which is pretty much teh situation we are already in</p>



<a name="421906681"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421906681" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421906681">(Feb 16 2024 at 17:31)</a>:</h4>
<p>well I don't want to get too distracted with a half-baked idea I have</p>



<a name="421906756"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421906756" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421906756">(Feb 16 2024 at 17:32)</a>:</h4>
<p>brb</p>



<a name="421906789"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421906789" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421906789">(Feb 16 2024 at 17:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="253994">Alex Crichton</span> <a href="#narrow/stream/217126-wasmtime/topic/Function.20References.20PR/near/421906558">said</a>:</p>
<blockquote>
<p>we can at least be perf-neutral with scalars</p>
</blockquote>
<p>we do have to call <code>.next()</code> on the param types iter for every param, so to be actually neutral it would require LLVM to be able to boil that away, which I am not sure it can or not</p>



<a name="421907314"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421907314" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421907314">(Feb 16 2024 at 17:34)</a>:</h4>
<p>okay well lets start with looking up the funcref's <code>FuncType</code> and doing the read lock and measuring perf of that</p>



<a name="421907330"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421907330" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421907330">(Feb 16 2024 at 17:34)</a>:</h4>
<p>and then we can decide what to do from there</p>



<a name="421907760"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421907760" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421907760">(Feb 16 2024 at 17:37)</a>:</h4>
<p>(and I'm not gonna get to the benchmarking until after I finish writing these missing embedder API subtyping tests)</p>



<a name="421908911"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421908911" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421908911">(Feb 16 2024 at 17:44)</a>:</h4>
<p>I'm imagining we'd pass in <code>&amp;LazyParam</code> which has <code>&amp;Engine</code>, <code>usize</code>, and <code>VMSharedTypeIndex</code> and then <code>.get()</code> loads everything</p>



<a name="421908987"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421908987" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421908987">(Feb 16 2024 at 17:44)</a>:</h4>
<p>so that way outside the loop is "just" bumping <code>usize</code></p>



<a name="421909099"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Function%20References%20PR/near/421909099" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Function.20References.20PR.html#421909099">(Feb 16 2024 at 17:45)</a>:</h4>
<p>yeah that makes sense</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>