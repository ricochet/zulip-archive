<html>
<head><meta charset="utf-8"><title>Copy on write memory for the Component Model? · wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/index.html">wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Copy.20on.20write.20memory.20for.20the.20Component.20Model.3F.html">Copy on write memory for the Component Model?</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="476458675"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Copy%20on%20write%20memory%20for%20the%20Component%20Model%3F/near/476458675" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Piotr Sarnacki <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Copy.20on.20write.20memory.20for.20the.20Component.20Model.3F.html#476458675">(Oct 11 2024 at 21:03)</a>:</h4>
<p>I found an excellent blog post by Lin Clark on <a href="https://bytecodealliance.org/articles/making-javascript-run-fast-on-webassembly">running JS in WASM</a>. Module linking is mentioned there as a potential way to lower the memory usage of JS interpreters. The module linking repo is inactive, though, as per the note in <a href="https://github.com/WebAssembly/module-linking/blob/main/proposals/module-linking/Explainer.md">the proposal</a>, which mentions the focus shifted towards the component model.</p>
<p>In recent weeks I've been experimenting with running JavaScript code as WASM modules and memory is one of the limits for many use cases. As an example 5000 of SpiderMonkey WASM instances takes about 20-25GBs of RAM and even a smaller interpreter like QuickJS is at 2GBs.</p>
<p>It would be a game changer if an interpreter could be loaded to memory as a component and shared between a number of instances running other components with memory being copied on write as needed. Is anything like that planned? Is it even feasible? Unfortunately I don't know much about WASM internals (I'm learning, though!), so I'm not sure if it's not a silly question.</p>
<div class="message_embed"><a class="message_embed_image" href="https://bytecodealliance.org/articles/making-javascript-run-fast-on-webassembly" style="background-image: url(&quot;https://uploads.zulipusercontent.net/b0cea62b89ccf6d34ec3a4a8d45332741ed2f3f8/68747470733a2f2f62797465636f6465616c6c69616e63652e6f72672f61727469636c65732f696d672f323032312d30362d30322d6a732d6f6e2d7761736d2f66656174757265645f696d6167652e706e67&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://bytecodealliance.org/articles/making-javascript-run-fast-on-webassembly" title="Making JavaScript run fast on WebAssembly">Making JavaScript run fast on WebAssembly</a></div><div class="message_embed_description">JavaScript in the browser runs many times faster than it did two decades ago. And that happened because the browser vendors spent that time working on intensive performance optimizations.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/module-linking/blob/main/proposals/module-linking/Explainer.md" style="background-image: url(&quot;https://uploads.zulipusercontent.net/7457c98cdf1b93f9a5ce6158f79736a799491f7e/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f356434666661313830346531326235343466346430626266333264643235363935333633346635313937333863633037386432303637353030663562393439662f576562417373656d626c792f6d6f64756c652d6c696e6b696e67&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/module-linking/blob/main/proposals/module-linking/Explainer.md" title="module-linking/proposals/module-linking/Explainer.md at main · WebAssembly/module-linking">module-linking/proposals/module-linking/Explainer.md at main · WebAssembly/module-linking</a></div><div class="message_embed_description">Proposal for allowing modules to define, import and export modules and instances - WebAssembly/module-linking</div></div></div>



<a name="476460701"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Copy%20on%20write%20memory%20for%20the%20Component%20Model%3F/near/476460701" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Copy.20on.20write.20memory.20for.20the.20Component.20Model.3F.html#476460701">(Oct 11 2024 at 21:21)</a>:</h4>
<p>That's a great question.  There are two aspects to this:</p>
<ul>
<li>Code reuse, e.g. compiling <code>libstarlingmonkey.so</code>, a JS interpreter, to a .cwasm file once and reusing it.  Code is immutable, so reuse is pretty trivial -- no CoW needed.</li>
<li>Instance reuse, i.e. reusing the linear memory, globals, etc. of a live interpreter across multiple component instances</li>
</ul>
<p>The latter raises questions about reentrance, multithreading, CoW, etc., but the former is reasonably straightforward, as described in <a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/Linking.md">Linking.md</a>. </p>
<p>Specifically, what we'd want is to create JS components which <em>import</em> e.g. <code>libstarlingmonkey.so</code> rather than bundle it.  That would give Wasmtime a chance to compile <code>libstarlingmonkey.so</code> to a cwasm file once, load it once, and reuse it across an arbitrary number of components.  AFAIK, Wasmtime has all the bits in place to support this; the blocker is shipping <code>libstarlingmonkey.so</code> and teaching <code>componentize-js</code> to emit components that import it.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/Linking.md" style="background-image: url(&quot;https://uploads.zulipusercontent.net/dd9bd5d0fab18d13fd7b165d36998051bd8f012a/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613539326337343063666139313864653962343565636263623834666434303634356233343964343433373734333734333264363032636661306562386464302f576562417373656d626c792f636f6d706f6e656e742d6d6f64656c&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/Linking.md" title="component-model/design/mvp/Linking.md at main · WebAssembly/component-model">component-model/design/mvp/Linking.md at main · WebAssembly/component-model</a></div><div class="message_embed_description">Repository for design and specification of the Component Model - WebAssembly/component-model</div></div></div>



<a name="476472254"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Copy%20on%20write%20memory%20for%20the%20Component%20Model%3F/near/476472254" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Piotr Sarnacki <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Copy.20on.20write.20memory.20for.20the.20Component.20Model.3F.html#476472254">(Oct 11 2024 at 23:24)</a>:</h4>
<p><span class="user-mention" data-user-id="509936">@Joel Dice</span> thanks so much for the explanation and the link! I'll read more about it. As a side note, I feel like search engines are less and less useful as I've been searching for info on component model and also specifically linking quite a lot today and this page never came up <span aria-label="see no evil" class="emoji emoji-1f648" role="img" title="see no evil">:see_no_evil:</span></p>



<a name="476478157"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Copy%20on%20write%20memory%20for%20the%20Component%20Model%3F/near/476478157" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jeff Parsons <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Copy.20on.20write.20memory.20for.20the.20Component.20Model.3F.html#476478157">(Oct 12 2024 at 00:56)</a>:</h4>
<p>Re search engines becoming less useful: a lot of folks feel that way, and there's good reason to believe it's only going to get worse. This article has done the rounds on popular link aggregators: <a href="https://docs.sendwithses.com/random-stuff/the-internet-is-an-seo-landfill">https://docs.sendwithses.com/random-stuff/the-internet-is-an-seo-landfill</a></p>
<p>OTOH ChatGPT et al. keep getting better at doing what I used to use search engines for. E.g. I can paste in some convoluted regex I find in my codebase and it will do a fantastic job of explaining it in plain language. I haven't tried asking ChatGPT about Wasm-related topics. If you're interested in trying it instead of Google next time, I'd love to know how your experience compares!</p>
<div class="message_embed"><a class="message_embed_image" href="https://docs.sendwithses.com/random-stuff/the-internet-is-an-seo-landfill" style="background-image: url(&quot;https://uploads.zulipusercontent.net/8a56c2ef2bc4536727ebee4cc8fe9f67ec5cdd44/68747470733a2f2f646f63732e73656e64776974687365732e636f6d2f7e676974626f6f6b2f6f67696d6167652f2d4c69335f77666159534e6f76694556566d7278&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://docs.sendwithses.com/random-stuff/the-internet-is-an-seo-landfill" title="The internet is an SEO landfill | Send With SES">The internet is an SEO landfill | Send With SES</a></div><div class="message_embed_description">I have a product that can be explained in one or two sentences. It is fairly well documented. Yet i’m being asked to write 4,000 word articles describing and comparing my product with the competition. Why? Because SEO.</div></div></div>



<a name="476615906"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Copy%20on%20write%20memory%20for%20the%20Component%20Model%3F/near/476615906" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Piotr Sarnacki <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Copy.20on.20write.20memory.20for.20the.20Component.20Model.3F.html#476615906">(Oct 13 2024 at 15:49)</a>:</h4>
<p><span class="user-mention" data-user-id="509936">@Joel Dice</span> I've read through the docs you linked and some other resources I could find. You mentioned that the blocker is compiling Starling Monkey to a shared library, but I'm not sure if you mean that compiling to shared libraries is a blocker or that compiling Starling Monkey to a shared library is a blocker. I assume the former, but not sure.</p>
<p>Do you know if there are any resources outlining what is needed to do so? It's extremely hard for me to find anything concrete. I mean, it doesn't have to be necessarily in context of StarlingMonkey/SpiderMonkey, I would like to first experiment with smaller examples. Then there is also componentize-js changes, but I guess figuring out this part will be easier if I know exactly how it should work.</p>



<a name="476635000"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Copy%20on%20write%20memory%20for%20the%20Component%20Model%3F/near/476635000" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Copy.20on.20write.20memory.20for.20the.20Component.20Model.3F.html#476635000">(Oct 13 2024 at 20:22)</a>:</h4>
<blockquote>
<p>You mentioned that the blocker is compiling Starling Monkey to a shared library, but I'm not sure if you mean that compiling to shared libraries is a blocker or that compiling Starling Monkey to a shared library is a blocker.</p>
</blockquote>
<p>The latter.  <a href="https://github.com/WebAssembly/tool-conventions/blob/main/DynamicLinking.md">DynamicLinking.md</a> describes the convention for building and linking Wasm shared libraries, and Emscripten has been using that for many years.  We've been using the same convention to link arbitrary numbers of shared libraries together using <code>wasm-tools component link</code>, and <code>componentize-py</code> relies on that (plus <code>dlopen</code> emulation) to support Python native extensions as .so files.</p>
<p>In fact, if you use <code>wasm-tools print</code> to look at a component built by <code>componentize-py</code>, you'll see it is composed of several .so files, including <code>libc.so</code>, <code>libc++.so</code>, <code>libpython312.so</code>, etc.  -- all of which follow the <code>DynamicLinking.md</code> convention.  There's no reason why <code>componentize-js</code> could not do the same thing -- it just hasn't been a priority yet.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/tool-conventions/blob/main/DynamicLinking.md" style="background-image: url(&quot;https://uploads.zulipusercontent.net/abd65e8ef59f4ffc7b79fba48dbf49cc34c33e8c/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f663466356666363465363832646330373731653938343763643365613762313264386431303236373362663331323166646439373933393865613164623762392f576562417373656d626c792f746f6f6c2d636f6e76656e74696f6e73&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/tool-conventions/blob/main/DynamicLinking.md" title="tool-conventions/DynamicLinking.md at main · WebAssembly/tool-conventions">tool-conventions/DynamicLinking.md at main · WebAssembly/tool-conventions</a></div><div class="message_embed_description">Conventions supporting interoperatibility between tools working with WebAssembly. - WebAssembly/tool-conventions</div></div></div>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>