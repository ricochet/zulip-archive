<html>
<head><meta charset="utf-8"><title>Source generated WASI types from another crate · wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/index.html">wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Source.20generated.20WASI.20types.20from.20another.20crate.html">Source generated WASI types from another crate</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="420361352"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Source%20generated%20WASI%20types%20from%20another%20crate/near/420361352" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rohan Krishnaswamy <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Source.20generated.20WASI.20types.20from.20another.20crate.html#420361352">(Feb 07 2024 at 23:36)</a>:</h4>
<p>Hello!</p>
<p>I'm trying to source WASI types generated by <code>wit_bindgen</code> from another crate, but I'm running into problems. To clarify, the WIT world for my component depends on some WASI types, e.g.:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">world</span><span class="w"> </span><span class="n">my</span><span class="o">-</span><span class="n">world</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">other</span><span class="o">-</span><span class="n">types</span><span class="p">.{</span><span class="n">outcome</span><span class="p">};</span>

<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">wasi</span>:<span class="nc">http</span><span class="o">/</span><span class="n">types</span><span class="o">@</span><span class="mf">0.2.0.</span><span class="p">{</span><span class="n">incoming</span><span class="o">-</span><span class="n">request</span><span class="p">};</span>

<span class="w">    </span><span class="n">import</span><span class="w"> </span><span class="n">wasi</span>:<span class="nc">http</span><span class="o">/</span><span class="n">outgoing</span><span class="o">-</span><span class="n">handler</span><span class="o">@</span><span class="mf">0.2.0</span><span class="p">;</span>

<span class="w">    </span><span class="n">export</span><span class="w"> </span><span class="n">handle</span>: <span class="nc">func</span><span class="p">(</span><span class="n">incoming</span>: <span class="nc">incoming</span><span class="o">-</span><span class="n">request</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">outcome</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>When I run <code>wit_bindgen</code> on this world, the generated code includes code for the WASI types/handler. Instead, I'd like to be able to generate the WASI-specific code needed for the component in another crate, and have the component reference it.</p>
<p>A naive approach I took, removing the WASI implementations from the generate code for <code>my-world</code>, and replacing them with references to the corresponding types generated in the dependent crate. This ended up failing with the error when encoding the component: </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="n">xxx</span>: <span class="nc">updating</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="n">component</span><span class="o">-</span><span class="k">type</span>:<span class="nc">internal</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="mi">0</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">merge</span><span class="w"> </span><span class="n">worlds</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">two</span><span class="w"> </span><span class="n">documents</span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">duplicate</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">interface</span><span class="w"> </span><span class="err">`</span><span class="n">incoming</span><span class="o">-</span><span class="n">request</span><span class="err">`</span>
</code></pre></div>
<p>For context, the world <code>internal</code> only includes the necessary WASI types (the outgoing-handler, and incoming-request type)</p>
<p>Is there another approach I can take? Is this possible?</p>
<p>Thank you!</p>



<a name="420379284"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Source%20generated%20WASI%20types%20from%20another%20crate/near/420379284" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Source.20generated.20WASI.20types.20from.20another.20crate.html#420379284">(Feb 08 2024 at 02:52)</a>:</h4>
<p>What guest language are you using? (assuming guest here because <code>wit_bindgen</code> is being used, but if a host is being used please correct me). If you're using Rust the <code>with</code> option is intended to solve this use case, although it may not be fully complete yet.</p>
<p>Also, if you can, can you capture the inputs to generate that error and file an issue if you get a chance? That's not a great error message and something we should improve</p>



<a name="420384216"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Source%20generated%20WASI%20types%20from%20another%20crate/near/420384216" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rohan Krishnaswamy <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Source.20generated.20WASI.20types.20from.20another.20crate.html#420384216">(Feb 08 2024 at 04:02)</a>:</h4>
<p>Sorry, forgot to mention that my guest language is Rust! Yes, I tried using <code>with</code> but unfortunately I still found that <code>wasi</code> code was still generated. Do you know if there's a workaround in the meantime? FYI, <code>with</code> works as expected in my Rust host environment when using <code>wasmtime::component::bindgen!</code>.</p>
<p>And yes, will definitely file an issue with code to repro!</p>



<a name="420385766"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Source%20generated%20WASI%20types%20from%20another%20crate/near/420385766" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Source.20generated.20WASI.20types.20from.20another.20crate.html#420385766">(Feb 08 2024 at 04:26)</a>:</h4>
<p>I'm not aware of a workaround myself, but please feel free to file an issue for this as well</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>