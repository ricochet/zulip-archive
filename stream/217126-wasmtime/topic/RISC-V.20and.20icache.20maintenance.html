<html>
<head><meta charset="utf-8"><title>RISC-V and icache maintenance · wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/index.html">wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/RISC-V.20and.20icache.20maintenance.html">RISC-V and icache maintenance</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="442591258"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/RISC-V%20and%20icache%20maintenance/near/442591258" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/RISC-V.20and.20icache.20maintenance.html#442591258">(Jun 04 2024 at 17:59)</a>:</h4>
<p>I'm curious if <span class="user-mention" data-user-id="410955">@Afonso Bordado</span> or others perhaps know what's going on here. At the CG meeting right now <a href="https://github.com/spinkube/containerd-shim-spin/issues/128">https://github.com/spinkube/containerd-shim-spin/issues/128</a> was brought up during a presentation as a blocker for running Wasmtime on riscv64 which boils down to:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'&lt;</span><span class="n">unnamed</span><span class="o">&gt;'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/..</span><span class="p">.</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">18.0.4</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">code_memory</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">254</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span>
<span class="nc">Failed</span><span class="w"> </span><span class="n">cache</span><span class="w"> </span><span class="n">clear</span><span class="p">:</span><span class="w"> </span><span class="nc">Os</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">code</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kind</span><span class="p">:</span><span class="w"> </span><span class="nc">PermissionDenied</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">:</span><span class="w"> </span><span class="s">"Operation not permitted"</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>
<p>which corresponds to <a href="https://github.com/bytecodealliance/wasmtime/blob/f54c2aa8657fbf983c2627abc528fc6ef8d15531/crates/jit-icache-coherence/src/libc.rs#L94-L133">this part of the code</a> I believe, specifically the risc-v-specific syscalls to manage the icache. That was originally added long ago and it's using syscalls that I don't personally know anything about, but Afonso (or others) do y'all know more to know why EPERM might be popping out?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/spinkube/containerd-shim-spin/issues/128" style="background-image: url(&quot;https://uploads.zulipusercontent.net/2e88e168fd700904b76759b791dac7e9b1a2f507/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f333930643365386661333963636331613562356630633134343533356439633932316536633664633732393537353537326261313033383564333531643635662f7370696e6b7562652f636f6e7461696e6572642d7368696d2d7370696e2f6973737565732f313238&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/spinkube/containerd-shim-spin/issues/128" title="Issue when running a spin image in docker/containerd on RISCV64 · Issue #128 · spinkube/containerd-shim-spin">Issue when running a spin image in docker/containerd on RISCV64 · Issue #128 · spinkube/containerd-shim-spin</a></div><div class="message_embed_description">I am trying to get containerd (through docker) to run wasm-files on my VisionFive 2 board which has a RISCV64 processor. Here are the platform details: $ lsb_release -a No LSB modules are available...</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/f54c2aa8657fbf983c2627abc528fc6ef8d15531/crates/jit-icache-coherence/src/libc.rs#L94-L133" style="background-image: url(&quot;https://uploads.zulipusercontent.net/443059b9f512b901600a62b45508bf5f1d320184/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f373431303334646533363939623961666161316563666362613263343839333665353031623030343565343834643938373763646130326662356632633037662f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/f54c2aa8657fbf983c2627abc528fc6ef8d15531/crates/jit-icache-coherence/src/libc.rs#L94-L133" title="wasmtime/crates/jit-icache-coherence/src/libc.rs at f54c2aa8657fbf983c2627abc528fc6ef8d15531 · bytecodealliance/wasmtime">wasmtime/crates/jit-icache-coherence/src/libc.rs at f54c2aa8657fbf983c2627abc528fc6ef8d15531 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">A fast and secure runtime for WebAssembly. Contribute to bytecodealliance/wasmtime development by creating an account on GitHub.</div></div></div>



<a name="442592417"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/RISC-V%20and%20icache%20maintenance/near/442592417" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Afonso Bordado <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/RISC-V.20and.20icache.20maintenance.html#442592417">(Jun 04 2024 at 18:04)</a>:</h4>
<p>I'm not entirely sure what is going on there. IIRC I tested that code on a VisionFive 2 as well, but with a super old kernel, so something might have changed.</p>
<p>If I'm not mistaken docker filters the allowed syscalls, and it might be that that one isn't allowed. (This is just a wild guess)</p>
<p>I'll try to reproduce that locally</p>



<a name="442592509"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/RISC-V%20and%20icache%20maintenance/near/442592509" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/RISC-V.20and.20icache.20maintenance.html#442592509">(Jun 04 2024 at 18:05)</a>:</h4>
<p>good point, looking <a href="https://github.com/torvalds/linux/blob/master/arch/riscv/kernel/sys_riscv.c#L59-L61">at the syscall itself</a> it looks like EPERM isn't ever returned</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/torvalds/linux/blob/master/arch/riscv/kernel/sys_riscv.c#L59-L61" style="background-image: url(&quot;https://uploads.zulipusercontent.net/3fc392e426162a1981f93e31aee559513a6008ab/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f313339326135346437656531306231323361353363646365623366333932376430326339656431326137313263346431643664366662356261316636633936372f746f7276616c64732f6c696e7578&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/torvalds/linux/blob/master/arch/riscv/kernel/sys_riscv.c#L59-L61" title="linux/arch/riscv/kernel/sys_riscv.c at master · torvalds/linux">linux/arch/riscv/kernel/sys_riscv.c at master · torvalds/linux</a></div><div class="message_embed_description">Linux kernel source tree. Contribute to torvalds/linux development by creating an account on GitHub.</div></div></div>



<a name="442592537"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/RISC-V%20and%20icache%20maintenance/near/442592537" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/RISC-V.20and.20icache.20maintenance.html#442592537">(Jun 04 2024 at 18:05)</a>:</h4>
<p>so a syscall filter sounds pretty likely</p>



<a name="442593620"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/RISC-V%20and%20icache%20maintenance/near/442593620" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Afonso Bordado <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/RISC-V.20and.20icache.20maintenance.html#442593620">(Jun 04 2024 at 18:11)</a>:</h4>
<p>It looks like some other projects have had similar issues with the JRE:<br>
<a href="https://github.com/adoptium/adoptium-support/issues/697#issuecomment-1600734899">https://github.com/adoptium/adoptium-support/issues/697#issuecomment-1600734899</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/adoptium/adoptium-support/issues/697#issuecomment-1600734899" style="background-image: url(&quot;https://uploads.zulipusercontent.net/1dfef595bf4b6fbd9babf7f952a1d25f84d689e6/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f646335376566643634363636393134623064393136643365303762636237333434323365383631313164653338336661313465363566323235373964363734312f61646f707469756d2f61646f707469756d2d737570706f72742f6973737565732f363937&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/adoptium/adoptium-support/issues/697#issuecomment-1600734899" title="A fatal error has been detected by the Java Runtime Environment inside docker riscv64 · Issue #697 · adoptium/adoptium-support">A fatal error has been detected by the Java Runtime Environment inside docker riscv64 · Issue #697 · adoptium/adoptium-support</a></div><div class="message_embed_description">Error inside riscv64 docker container. on host javac works. ./jdk/bin/java --version # # A fatal error has been detected by the Java Runtime Environment: # # SIGILL (0x4) at pc=0x0000003f78361a88, ...</div></div></div>



<a name="442593742"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/RISC-V%20and%20icache%20maintenance/near/442593742" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/RISC-V.20and.20icache.20maintenance.html#442593742">(Jun 04 2024 at 18:11)</a>:</h4>
<p>aha excellent thanks!</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>