<html>
<head><meta charset="utf-8"><title>Optimizing Pulley execution time · wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/index.html">wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html">Optimizing Pulley execution time</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="494416348"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494416348" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494416348">(Jan 17 2025 at 18:27)</a>:</h4>
<p>In the wasmtime meeting yesterday we dove a bit into pulley and some theoretical optimizations. One thing <span class="user-mention" data-user-id="254389">@Chris Fallin</span> you mentioned was reducing the number of loads per instruction where currently the load-per-instruction-operand might be overly punishing us by saturating load/store ports in a cpu</p>
<p>I was thinking about that last night and this morning I implemented a strategy where whenever we decode an instruction the decoder unconditionally loads a pointer's worth of bytes (e.g. 8 bytes on x64). Operands are then decoded from that via bit shifts. If the instruction is longer than 8 bytes it'll continue to load more afterwards. Basically I didn't change the pulley bytecode format at all, but I optimized the loads such that on average, on x64, there's only a single 64-bit load per instruction.</p>
<p>For the tail-call interpreter loop this meant that at the end of an instruction handler you'd load 64-bits for the next instruction. The low 8 bits are used for a dynamic dispatch and the upper 56 bits are passed in a register to the next opcode. The next opcode then uses these 56 bits to decode the operands.</p>
<p>I've confirmed looking at the disassembly of the tail-call interpreter that everything looks as expected. There's bit-twiddling where I'd expect, no extra overhead from the abstractions I'm using, and there's only a single load at the end of most handlers of data for the next instruction.</p>
<p>So despite all this, the performance has relatively mixed results. For example this is a performance comparison of the "mach loop" interpreter with this load-64-bits trick vs the previous commit on <code>main</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">execution</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">cycles</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">42746797.10</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">4341093.72</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.06</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.07</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">pulley</span><span class="o">-</span><span class="n">less</span><span class="o">-</span><span class="n">instruction</span><span class="o">-</span><span class="n">loads</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">645100214</span><span class="w"> </span><span class="mf">648469690.10</span><span class="w"> </span><span class="mi">653317578</span><span class="p">]</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">687997108</span><span class="w"> </span><span class="mf">691216487.20</span><span class="w"> </span><span class="mi">698783018</span><span class="p">]</span><span class="w"> </span><span class="n">pulley</span><span class="o">-</span><span class="n">less</span><span class="o">-</span><span class="n">instruction</span><span class="o">-</span><span class="n">loads</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">cycles</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">899905066.70</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">26179495.28</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="n">pulley</span><span class="o">-</span><span class="n">less</span><span class="o">-</span><span class="n">instruction</span><span class="o">-</span><span class="n">loads</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.05</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.05</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">20179755580</span><span class="w"> </span><span class="mf">20198967934.80</span><span class="w"> </span><span class="mi">20236773749</span><span class="p">]</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">19278160035</span><span class="w"> </span><span class="mf">19299062868.10</span><span class="w"> </span><span class="mi">19355235070</span><span class="p">]</span><span class="w"> </span><span class="n">pulley</span><span class="o">-</span><span class="n">less</span><span class="o">-</span><span class="n">instruction</span><span class="o">-</span><span class="n">loads</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">cycles</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3095623.30</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">2128376.59</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="n">pulley</span><span class="o">-</span><span class="n">less</span><span class="o">-</span><span class="n">instruction</span><span class="o">-</span><span class="n">loads</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.01</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.07</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">81785649</span><span class="w"> </span><span class="mf">83368590.70</span><span class="w"> </span><span class="mi">87006738</span><span class="p">]</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">79519941</span><span class="w"> </span><span class="mf">80272967.40</span><span class="w"> </span><span class="mi">84093446</span><span class="p">]</span><span class="w"> </span><span class="n">pulley</span><span class="o">-</span><span class="n">less</span><span class="o">-</span><span class="n">instruction</span><span class="o">-</span><span class="n">loads</span><span class="p">.</span><span class="n">so</span>
</code></pre></div>
<p>and this is a performance comparison of the tail-call-based interpreter loop:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">execution</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">cycles</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">85980346.40</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">4256370.91</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="n">main</span><span class="o">-</span><span class="n">tai</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.08</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.09</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">pulley</span><span class="o">-</span><span class="n">less</span><span class="o">-</span><span class="n">instruction</span><span class="o">-</span><span class="n">loads</span><span class="o">-</span><span class="n">tai</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">979172509</span><span class="w"> </span><span class="mf">982182980.40</span><span class="w"> </span><span class="mi">991260483</span><span class="p">]</span><span class="w"> </span><span class="n">main</span><span class="o">-</span><span class="n">tai</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">1067376846</span><span class="w"> </span><span class="mf">1068163326.80</span><span class="w"> </span><span class="mi">1071737075</span><span class="p">]</span><span class="w"> </span><span class="n">pulley</span><span class="o">-</span><span class="n">less</span><span class="o">-</span><span class="n">instruction</span><span class="o">-</span><span class="n">loads</span><span class="o">-</span><span class="n">tai</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">cycles</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">6865385.20</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">2141737.48</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="n">main</span><span class="o">-</span><span class="n">tai</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.05</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.09</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">pulley</span><span class="o">-</span><span class="n">less</span><span class="o">-</span><span class="n">instruction</span><span class="o">-</span><span class="n">loads</span><span class="o">-</span><span class="n">tai</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">100417359</span><span class="w"> </span><span class="mf">101239118.00</span><span class="w"> </span><span class="mi">106632440</span><span class="p">]</span><span class="w"> </span><span class="n">main</span><span class="o">-</span><span class="n">tai</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">107581286</span><span class="w"> </span><span class="mf">108104503.20</span><span class="w"> </span><span class="mi">111904624</span><span class="p">]</span><span class="w"> </span><span class="n">pulley</span><span class="o">-</span><span class="n">less</span><span class="o">-</span><span class="n">instruction</span><span class="o">-</span><span class="n">loads</span><span class="o">-</span><span class="n">tai</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">cycles</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">741291892.60</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">11310370.33</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="n">main</span><span class="o">-</span><span class="n">tai</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.03</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.04</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">pulley</span><span class="o">-</span><span class="n">less</span><span class="o">-</span><span class="n">instruction</span><span class="o">-</span><span class="n">loads</span><span class="o">-</span><span class="n">tai</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">20890036242</span><span class="w"> </span><span class="mf">20898157837.90</span><span class="w"> </span><span class="mi">20915333190</span><span class="p">]</span><span class="w"> </span><span class="n">main</span><span class="o">-</span><span class="n">tai</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">21632673509</span><span class="w"> </span><span class="mf">21639449730.50</span><span class="w"> </span><span class="mi">21660859731</span><span class="p">]</span><span class="w"> </span><span class="n">pulley</span><span class="o">-</span><span class="n">less</span><span class="o">-</span><span class="n">instruction</span><span class="o">-</span><span class="n">loads</span><span class="o">-</span><span class="n">tai</span><span class="p">.</span><span class="n">so</span>
</code></pre></div>
<p>the tl;dr; here being that this is a universal loss for the tail-call-dispatch interpreter loop and for the "mach loop" dispatch it's not always a win.</p>
<p>I wanted to confirm though, <span class="user-mention" data-user-id="254389">@Chris Fallin</span> is this the sort of optimization you were imagining?</p>



<a name="494416815"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494416815" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494416815">(Jan 17 2025 at 18:30)</a>:</h4>
<p>As an example, this is the disassembly of <code>xmov</code> after the optimization I applied</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">0000000001</span><span class="n">ffb110</span><span class="w"> </span><span class="o">&lt;</span><span class="n">pulley_interpreter</span><span class="p">::</span><span class="n">interp</span><span class="p">::</span><span class="n">tail_loop</span><span class="p">::</span><span class="n">xmov</span><span class="o">&gt;</span><span class="p">:</span>
<span class="w">  </span><span class="nc">push</span><span class="w">   </span><span class="o">%</span><span class="n">rbp</span>
<span class="w">  </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="o">%</span><span class="n">rbp</span>
<span class="w">  </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">edx</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span><span class="w">                      </span><span class="p">;;</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="n">our</span><span class="w"> </span><span class="n">own</span><span class="w"> </span><span class="n">instructions</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">eax</span>
<span class="w">  </span><span class="n">shr</span><span class="w">    </span><span class="cp">$</span><span class="mh">0x5</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
<span class="w">  </span><span class="n">and</span><span class="w">    </span><span class="cp">$</span><span class="mh">0xf8</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
<span class="w">  </span><span class="n">mov</span><span class="w">    </span><span class="mh">0x200</span><span class="p">(</span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="o">%</span><span class="n">rax</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="o">%</span><span class="n">rax</span><span class="w">        </span><span class="p">;;</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">tricks</span><span class="o">/</span><span class="n">load</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">src</span><span class="w"> </span><span class="n">register</span><span class="w"> </span><span class="n">indexed</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="err">`</span><span class="n">eax</span><span class="err">`</span>
<span class="w">  </span><span class="n">and</span><span class="w">    </span><span class="cp">$</span><span class="mh">0x1f</span><span class="p">,</span><span class="o">%</span><span class="n">edx</span>
<span class="w">  </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rax</span><span class="p">,</span><span class="mh">0x200</span><span class="p">(</span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="o">%</span><span class="n">rdx</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="w">        </span><span class="p">;;</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">tricks</span><span class="o">/</span><span class="n">store</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">dst</span><span class="w"> </span><span class="n">register</span><span class="w"> </span><span class="n">indexed</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="err">`</span><span class="n">edx</span><span class="err">`</span>
<span class="w">  </span><span class="n">mov</span><span class="w">    </span><span class="o">-</span><span class="mh">0x5</span><span class="p">(</span><span class="o">%</span><span class="n">rsi</span><span class="p">),</span><span class="o">%</span><span class="n">rdx</span><span class="w">                </span><span class="p">;;</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="n">instruction</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bytes</span><span class="p">)</span>
<span class="w">  </span><span class="n">add</span><span class="w">    </span><span class="cp">$</span><span class="mh">0x3</span><span class="p">,</span><span class="o">%</span><span class="n">rsi</span>
<span class="w">  </span><span class="n">movzbl</span><span class="w"> </span><span class="o">%</span><span class="n">dl</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span><span class="w">                       </span><span class="p">;;</span><span class="w"> </span><span class="n">extract</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">on</span>
<span class="w">  </span><span class="n">shr</span><span class="w">    </span><span class="cp">$</span><span class="mh">0x8</span><span class="p">,</span><span class="o">%</span><span class="n">rdx</span>
<span class="w">  </span><span class="n">lea</span><span class="w">    </span><span class="n">pulley_interpreter</span><span class="p">::</span><span class="n">interp</span><span class="p">::</span><span class="n">tail_loop</span><span class="p">::</span><span class="n">OPCODE_HANDLER_TABLE</span><span class="p">,</span><span class="o">%</span><span class="n">rcx</span>
<span class="w">  </span><span class="n">pop</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span>
<span class="err">→</span><span class="w"> </span><span class="n">jmp</span><span class="w">    </span><span class="o">*</span><span class="p">(</span><span class="o">%</span><span class="n">rcx</span><span class="p">,</span><span class="o">%</span><span class="n">rax</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="w">                 </span><span class="p">;;</span><span class="w"> </span><span class="n">tail</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">dispatch</span>
</code></pre></div>



<a name="494418492"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494418492" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494418492">(Jan 17 2025 at 18:41)</a>:</h4>
<p>basically yeah that's it; so this data point shows that the loads aren't the bottleneck -- interesting!</p>



<a name="494418615"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494418615" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494418615">(Jan 17 2025 at 18:42)</a>:</h4>
<p>at this point looking at uarch perf counters to see what is the bottleneck seems worthwhile; but honestly the biggest lever is probably reducing opcode count with macro-ops, exactly as you've been doing...</p>



<a name="494418709"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494418709" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494418709">(Jan 17 2025 at 18:43)</a>:</h4>
<p>alas, well I might try to land this work behind a #[cfg] since it might end up helping in the future</p>



<a name="494419281"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494419281" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494419281">(Jan 17 2025 at 18:46)</a>:</h4>
<p>oh, one more optimization I didn't mention yesterday: there's the concept of a "threaded interpreter" (name predates threads-as-parallelism-primitives) where you build a table of function pointers as a translation of the bytecode; that would replace the movzbl/shr/lea/jmp dispatching through the opcode table with probably an <code>add $8, %ptr; jmp *(%ptr)</code>. a little tricky to do control flow (have to translate the dests to indices in the handler-func-table) but possible. I'd check how much time is spent on the last 5 instructions first before pursuing of course</p>



<a name="494419422"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494419422" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494419422">(Jan 17 2025 at 18:47)</a>:</h4>
<p>so sort of like a relocation pass after we've loaded the bytecode?</p>



<a name="494419557"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494419557" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494419557">(Jan 17 2025 at 18:48)</a>:</h4>
<p>yeah, I suppose you would want to build the whole thing as a side-table computation after loading bytecode, since it depends on runtime func-pointer values</p>



<a name="494421013"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494421013" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494421013">(Jan 17 2025 at 18:57)</a>:</h4>
<p>apparently vtune says:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Microarchitecture</span><span class="w"> </span><span class="n">Usage</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Pipeline</span><span class="w"> </span><span class="n">Slots</span>
<span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">You</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">efficiency</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">platform</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">too</span><span class="w"> </span><span class="n">low</span><span class="p">.</span>
<span class="w"> </span><span class="o">|</span>
<span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Possible</span><span class="w"> </span><span class="n">cause</span><span class="p">:</span><span class="w"> </span><span class="nc">memory</span><span class="w"> </span><span class="n">stalls</span><span class="p">,</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="n">starvation</span><span class="p">,</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="n">misprediction</span>
<span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">long</span><span class="w"> </span><span class="n">latency</span><span class="w"> </span><span class="n">instructions</span><span class="p">.</span>
<span class="w"> </span><span class="o">|</span>
<span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Next</span><span class="w"> </span><span class="n">steps</span><span class="p">:</span><span class="w"> </span><span class="nc">Run</span><span class="w"> </span><span class="n">Microarchitecture</span><span class="w"> </span><span class="n">Exploration</span><span class="w"> </span><span class="n">analysis</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">identify</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">cause</span>
<span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">low</span><span class="w"> </span><span class="n">microarchitecture</span><span class="w"> </span><span class="n">usage</span><span class="w"> </span><span class="n">efficiency</span><span class="p">.</span>
<span class="w"> </span><span class="o">|</span>
<span class="w">    </span><span class="n">Performance</span><span class="o">-</span><span class="n">core</span><span class="w"> </span><span class="p">(</span><span class="n">P</span><span class="o">-</span><span class="n">core</span><span class="p">)</span>
<span class="w">        </span><span class="n">Retiring</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Pipeline</span><span class="w"> </span><span class="n">Slots</span>
<span class="w">        </span><span class="n">Front</span><span class="o">-</span><span class="n">End</span><span class="w"> </span><span class="n">Bound</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Pipeline</span><span class="w"> </span><span class="n">Slots</span>
<span class="w">        </span><span class="n">Bad</span><span class="w"> </span><span class="n">Speculation</span><span class="p">:</span><span class="w"> </span><span class="mf">100.0</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Pipeline</span><span class="w"> </span><span class="n">Slots</span>
<span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">significant</span><span class="w"> </span><span class="n">proportion</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">pipeline</span><span class="w"> </span><span class="n">slots</span><span class="w"> </span><span class="n">containing</span><span class="w"> </span><span class="n">useful</span><span class="w"> </span><span class="n">work</span><span class="w"> </span><span class="n">are</span>
<span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">being</span><span class="w"> </span><span class="n">cancelled</span><span class="p">.</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">caused</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">mispredicting</span><span class="w"> </span><span class="n">branches</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">by</span>
<span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">machine</span><span class="w"> </span><span class="n">clears</span><span class="p">.</span><span class="w"> </span><span class="n">Note</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">metric</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">highlighted</span><span class="w"> </span><span class="n">due</span><span class="w"> </span><span class="n">to</span>
<span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">Branch</span><span class="w"> </span><span class="n">Resteers</span><span class="w"> </span><span class="n">issue</span><span class="p">.</span>
<span class="w">         </span><span class="o">|</span>
</code></pre></div>



<a name="494422497"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494422497" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494422497">(Jan 17 2025 at 19:05)</a>:</h4>
<p>"you are using 0.0% of your CPU, try harder"</p>



<a name="494422547"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494422547" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494422547">(Jan 17 2025 at 19:05)</a>:</h4>
<p>mispredicts from the indirect predictor don't surprise me but 100% is very weird.</p>



<a name="494422589"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494422589" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494422589">(Jan 17 2025 at 19:05)</a>:</h4>
<p>Spectre mitigations turning off indirect predictor entirely?</p>



<a name="494422631"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494422631" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494422631">(Jan 17 2025 at 19:05)</a>:</h4>
<p>(I'd try <code>perf</code> too, fwiw)</p>



<a name="494422638"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494422638" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494422638">(Jan 17 2025 at 19:05)</a>:</h4>
<p>this is the uarch-exploration report I think <a href="https://gist.github.com/alexcrichton/75eca31603706054fb2dcc83a7c0b5be">https://gist.github.com/alexcrichton/75eca31603706054fb2dcc83a7c0b5be</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://gist.github.com/alexcrichton/75eca31603706054fb2dcc83a7c0b5be" style="background-image: url(&quot;https://uploads.zulipusercontent.net/91f9baed8f4fc08c462d1a4de5a8c23942d45e97/68747470733a2f2f6769746875622e6769746875626173736574732e636f6d2f6173736574732f676973742d6f672d696d6167652d3534666437646330373133652e706e67&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://gist.github.com/alexcrichton/75eca31603706054fb2dcc83a7c0b5be" title="foo.txt">foo.txt</a></div><div class="message_embed_description">GitHub Gist: instantly share code, notes, and snippets.</div></div></div>



<a name="494422703"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494422703" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494422703">(Jan 17 2025 at 19:06)</a>:</h4>
<p>but I can't really make heads or tails of this</p>



<a name="494422784"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494422784" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494422784">(Jan 17 2025 at 19:06)</a>:</h4>
<p>I've only ever really done perf sampling, is there like a general "perf show me a uarch summary" command?</p>



<a name="494422876"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494422876" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494422876">(Jan 17 2025 at 19:07)</a>:</h4>
<p><code>perf list</code> shows all the events, then <code>perf stat -e EVENT ...</code> to count it (multiple <code>-e</code> supported, I usually do cycles, instructions, and whatever events of interest)</p>



<a name="494422945"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494422945" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494422945">(Jan 17 2025 at 19:07)</a>:</h4>
<p>heh <code>perf list</code> has 6500 events</p>



<a name="494423037"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494423037" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494423037">(Jan 17 2025 at 19:08)</a>:</h4>
<p>go Intel perf counter team! 10k is close, you can do it</p>



<a name="494423363"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494423363" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494423363">(Jan 17 2025 at 19:10)</a>:</h4>
<p>the summary above doesn't tell me too much but does have some high-level data points: issue port utilization is low, so we're not bottlenecked on, say, too many ALU instructions; L1 stalls 16% of the time; running out of the DSB (predecoded cache) most of the time so not an L1i / too much code issue</p>



<a name="494423405"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494423405" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494423405">(Jan 17 2025 at 19:10)</a>:</h4>
<p>main thing is that IPC is &gt; 2, so this is really a "too many instructions" kind of issue I think</p>



<a name="494423429"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494423429" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494423429">(Jan 17 2025 at 19:10)</a>:</h4>
<p>in other words, main remedy is fewer bytecode ops, since each bytecode op body is pretty minimal</p>



<a name="494423495"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494423495" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494423495">(Jan 17 2025 at 19:11)</a>:</h4>
<p>hm ok that makes sense to me yeah</p>



<a name="494423541"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494423541" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494423541">(Jan 17 2025 at 19:11)</a>:</h4>
<p>with <code>perf stat</code> I got:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">     </span><span class="o">&lt;</span><span class="n">not</span><span class="w"> </span><span class="n">counted</span><span class="o">&gt;</span><span class="w">      </span><span class="n">cpu_atom</span><span class="o">/</span><span class="n">br_misp_retired</span><span class="p">.</span><span class="n">all_branches</span><span class="o">/</span><span class="w">                                        </span><span class="p">(</span><span class="mf">0.00</span><span class="o">%</span><span class="p">)</span>
<span class="w">       </span><span class="mi">202</span><span class="p">,</span><span class="mi">601</span><span class="p">,</span><span class="mi">699</span><span class="w">      </span><span class="n">cpu_core</span><span class="o">/</span><span class="n">br_misp_retired</span><span class="p">.</span><span class="n">all_branches</span><span class="o">/</span>
<span class="w">     </span><span class="o">&lt;</span><span class="n">not</span><span class="w"> </span><span class="n">counted</span><span class="o">&gt;</span><span class="w">      </span><span class="n">cpu_atom</span><span class="o">/</span><span class="n">br_inst_retired</span><span class="p">.</span><span class="n">all_branches</span><span class="o">/</span><span class="w">                                        </span><span class="p">(</span><span class="mf">0.00</span><span class="o">%</span><span class="p">)</span>
<span class="w">    </span><span class="mi">21</span><span class="p">,</span><span class="mi">691</span><span class="p">,</span><span class="mi">599</span><span class="p">,</span><span class="mi">697</span><span class="w">      </span><span class="n">cpu_core</span><span class="o">/</span><span class="n">br_inst_retired</span><span class="p">.</span><span class="n">all_branches</span><span class="o">/</span>
</code></pre></div>



<a name="494423568"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494423568" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494423568">(Jan 17 2025 at 19:11)</a>:</h4>
<p>which doesn't look like ~90% misprediction rate</p>



<a name="494423680"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494423680" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494423680">(Jan 17 2025 at 19:12)</a>:</h4>
<p>I suppose 10% mispredict is a high enough rate to consume 90% of pipeline slots</p>



<a name="494423685"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494423685" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494423685">(Jan 17 2025 at 19:12)</a>:</h4>
<p>10 MPKI (misses per thousand instructions) is somewhat high when one has giant instruction windows of today but doesn't scream "major problem" to me</p>



<a name="494423790"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494423790" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494423790">(Jan 17 2025 at 19:13)</a>:</h4>
<p>right, I think it's about as good as one can hope for: not pathological (every indirect missing for some reason), predictor is doing its job, it's just hard to predict a bunch of indirects in sequence</p>



<a name="494423835"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494423835" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494423835">(Jan 17 2025 at 19:13)</a>:</h4>
<p>can wasm switch to an opcode-per-program</p>



<a name="494423846"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494423846" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494423846">(Jan 17 2025 at 19:14)</a>:</h4>
<p>like can my wasm module just be one opcode</p>



<a name="494423913"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494423913" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494423913">(Jan 17 2025 at 19:14)</a>:</h4>
<p><code>(func $fib (param i32) (result i32) fib</code></p>



<a name="494423919"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494423919" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494423919">(Jan 17 2025 at 19:14)</a>:</h4>
<p>pulley op <code>serve_http_request_using_program1.wasm</code></p>



<a name="494423977"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494423977" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494423977">(Jan 17 2025 at 19:14)</a>:</h4>
<p>in any case fun exploration!</p>



<a name="494424058"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494424058" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494424058">(Jan 17 2025 at 19:15)</a>:</h4>
<p>yeah, good to confirm nothing too wonky going on</p>



<a name="494441011"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494441011" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robin Freyler <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494441011">(Jan 17 2025 at 21:12)</a>:</h4>
<p>Have you done the <code>perf</code> instrumentation on <code>switch</code> or <code>tail-call</code> based dispatch? Would be kinda interesting to know if they differ with respect to branch mispredictions. At least in theory <code>tail-call</code> dispatch should be simpler for a branch predictor to predict. 90% branch hit rate is low but also kinda normal for an interpreter.</p>



<a name="494443130"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494443130" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494443130">(Jan 17 2025 at 21:27)</a>:</h4>
<p>not yet, no, but so far most of benchmarking hasn't shown either as a clear winner, sometimes one is faster and sometimes the other is</p>



<a name="494443150"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Optimizing%20Pulley%20execution%20time/near/494443150" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Optimizing.20Pulley.20execution.20time.html#494443150">(Jan 17 2025 at 21:27)</a>:</h4>
<p>which might just mean that something else is the bigger bottleneck right now</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>