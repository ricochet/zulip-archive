<html>
<head><meta charset="utf-8"><title>`Func::new` and externref · wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/index.html">wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html">`Func::new` and externref</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="204222713"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204222713" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204222713">(Jul 17 2020 at 15:49)</a>:</h4>
<p><span class="user-mention" data-user-id="253990">@fitzgen (he/him)</span> filling out some Go bindings I found an issue where <code>Func::new</code> will panic if it's created with externef types and the <code>Config</code> doesn't have reference types enabled</p>



<a name="204222731"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204222731" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204222731">(Jul 17 2020 at 15:49)</a>:</h4>
<p>I'm a bit stuck thinking about this, though, as I'm not entirely sure how best to handle this</p>



<a name="204222802"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204222802" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204222802">(Jul 17 2020 at 15:49)</a>:</h4>
<p>the problem is that the trampoline generated by the <code>wasmtime</code> crate is attempting to use stack maps but cranelift's stack map support is not enabled so the register allocator naturally panics (as expected)</p>



<a name="204222895"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204222895" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204222895">(Jul 17 2020 at 15:50)</a>:</h4>
<p>I think we may want to avoid stack maps entirely for trampolines? I don't think they actually serve any purpose</p>



<a name="204224587"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204224587" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204224587">(Jul 17 2020 at 16:01)</a>:</h4>
<p>Can we assert in <code>Func::new</code> et al that reference types are enabled in the config if they're being used?</p>



<a name="204224623"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204224623" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204224623">(Jul 17 2020 at 16:01)</a>:</h4>
<p>that would at least be something we could document and have good assertion messages for</p>



<a name="204224812"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204224812" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204224812">(Jul 17 2020 at 16:02)</a>:</h4>
<p>hm so an assert isn't quite what would work for the bindings though</p>



<a name="204224839"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204224839" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204224839">(Jul 17 2020 at 16:02)</a>:</h4>
<p><code>wasm_func_new</code> panicking brings down the process most of the time</p>



<a name="204224859"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204224859" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204224859">(Jul 17 2020 at 16:03)</a>:</h4>
<p>(that's what's happening right now)</p>



<a name="204224898"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204224898" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204224898">(Jul 17 2020 at 16:03)</a>:</h4>
<p>I guess we would have to duplicate the check in a <code>wasmtime_func_new</code> :-/</p>



<a name="204224951"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204224951" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204224951">(Jul 17 2020 at 16:03)</a>:</h4>
<p>yay for <code>wasmtime_</code> prefixed functions</p>



<a name="204225071"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204225071" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204225071">(Jul 17 2020 at 16:04)</a>:</h4>
<p>I think you are technically correct that the trampolines don't need stack maps, but it is fairly subtle.</p>



<a name="204225112"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204225112" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204225112">(Jul 17 2020 at 16:04)</a>:</h4>
<p>we could do some nasty <code>r64</code> -&gt; <code>i64</code> hacks</p>



<a name="204225122"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204225122" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204225122">(Jul 17 2020 at 16:04)</a>:</h4>
<p>that's what I'm thinking yeah</p>



<a name="204225128"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204225128" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204225128">(Jul 17 2020 at 16:04)</a>:</h4>
<p>make it always work basically</p>



<a name="204225166"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204225166" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204225166">(Jul 17 2020 at 16:05)</a>:</h4>
<p>definitely not worth it as a perf optimization, but to work around this issue, maybe</p>



<a name="204225178"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204225178" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204225178">(Jul 17 2020 at 16:05)</a>:</h4>
<p>or alternatively</p>



<a name="204225201"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204225201" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204225201">(Jul 17 2020 at 16:05)</a>:</h4>
<p>we can always enable reference types in the trampolines</p>



<a name="204225214"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204225214" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204225214">(Jul 17 2020 at 16:05)</a>:</h4>
<p>that feels safer to me</p>



<a name="204225221"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204225221" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204225221">(Jul 17 2020 at 16:05)</a>:</h4>
<p>yeah that was my other thought</p>



<a name="204225268"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204225268" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204225268">(Jul 17 2020 at 16:05)</a>:</h4>
<p>I'll see if I can do that I think</p>



<a name="204225293"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204225293" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204225293">(Jul 17 2020 at 16:05)</a>:</h4>
<p>cool, let me know how it goes</p>



<a name="204225367"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204225367" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204225367">(Jul 17 2020 at 16:06)</a>:</h4>
<p>maybe we could have caught this if we extended the API call fuzzer</p>



<a name="204225392"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204225392" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204225392">(Jul 17 2020 at 16:06)</a>:</h4>
<p>with reference types and instructions to create funcs</p>



<a name="204225450"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204225450" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204225450">(Jul 17 2020 at 16:06)</a>:</h4>
<p>I wish the API call fuzzer was easier to extend, it is a little bit of a pain with all the scope stuff</p>



<a name="204225559"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204225559" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204225559">(Jul 17 2020 at 16:07)</a>:</h4>
<p>ok well that at least removes the panics</p>



<a name="204225563"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204225563" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204225563">(Jul 17 2020 at 16:07)</a>:</h4>
<p>seems fine for now!</p>



<a name="204225888"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204225888" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204225888">(Jul 17 2020 at 16:10)</a>:</h4>
<p>I have no idea if stack maps from trampolines even make their way into the <code>Store</code></p>



<a name="204225902"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204225902" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204225902">(Jul 17 2020 at 16:10)</a>:</h4>
<p>I feel like our management of trampolines is very ad-hoc</p>



<a name="204225967"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204225967" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204225967">(Jul 17 2020 at 16:11)</a>:</h4>
<p><a href="https://github.com/bytecodealliance/wasmtime/pull/2039">https://github.com/bytecodealliance/wasmtime/pull/2039</a></p>



<a name="204226468"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%60Func%3A%3Anew%60%20and%20externref/near/204226468" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.60Func.3A.3Anew.60.20and.20externref.html#204226468">(Jul 17 2020 at 16:15)</a>:</h4>
<p>I <em>think</em> they will make their way into the store's stack map registry, I vaguely remember a common code path here</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>