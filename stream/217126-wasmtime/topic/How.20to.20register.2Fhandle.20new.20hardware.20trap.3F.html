<html>
<head><meta charset="utf-8"><title>How to register/handle new hardware trap? · wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/index.html">wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html">How to register/handle new hardware trap?</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="374377523"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374377523" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fritz Rehde <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374377523">(Jul 11 2023 at 20:14)</a>:</h4>
<p>Can someone explain the general approach I would have to follow if I wanted to add a Trap to wasmtime that should/would be "triggered" by a runtime trap coming from ARM hardware extensions (this is not that important). I am interested in which sections in wasmtime I would have to add code. Thanks!</p>



<a name="374380299"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374380299" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374380299">(Jul 11 2023 at 20:30)</a>:</h4>
<p>so the hardware extension would deliver a signal of some sort that you want to turn into a wasm trap?</p>
<p>is this a fast path for an existing kind of check/trap that wasm already raises?</p>
<p>You want the <code>traphandlers</code> module in the <code>wasmtime-runtime</code> crate:</p>
<ul>
<li><a href="https://github.com/bytecodealliance/wasmtime/blob/80e68c336ba53f75146f2cb3920338155a2c7430/crates/runtime/src/traphandlers.rs#L4">https://github.com/bytecodealliance/wasmtime/blob/80e68c336ba53f75146f2cb3920338155a2c7430/crates/runtime/src/traphandlers.rs#L4</a></li>
<li>and then this has platform specific bits, eg <a href="https://github.com/bytecodealliance/wasmtime/blob/80e68c336ba53f75146f2cb3920338155a2c7430/crates/runtime/src/traphandlers/unix.rs#L67">https://github.com/bytecodealliance/wasmtime/blob/80e68c336ba53f75146f2cb3920338155a2c7430/crates/runtime/src/traphandlers/unix.rs#L67</a></li>
</ul>



<a name="374381499"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374381499" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fritz Rehde <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374381499">(Jul 11 2023 at 20:36)</a>:</h4>
<p>Thanks for the help! It's regarding <a href="https://www.kernel.org/doc/html/v5.12/arm64/memory-tagging-extension.html">https://www.kernel.org/doc/html/v5.12/arm64/memory-tagging-extension.html</a>, which we are trying to add support for in wasmtime (it's part of a larger stack, probably not something that could be merged into wasmtime itself for now, it's more of an experiment/research project). I think wasmtime already supports arm64's pointer authentication instructions at least for preventing ROP-oriented attacks. Do you know if a special trap handler for whatever signal/trap PAC instructions "send" to wasmtime exists already? Maybe that could help in my implementation</p>



<a name="374381681"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374381681" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374381681">(Jul 11 2023 at 20:38)</a>:</h4>
<p>I don't think we have anything to handle, it just falls into the "SIGSEGV turns into a wasm trap" bucket probably</p>



<a name="374381729"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374381729" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374381729">(Jul 11 2023 at 20:38)</a>:</h4>
<p>(I'm assuming it sends SEGV but SIGBUS would do similar)</p>



<a name="374387531"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374387531" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fritz Rehde <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374387531">(Jul 11 2023 at 21:11)</a>:</h4>
<p>Yep, right now our MTE is also just falling into the SIGSEGV bucket and it's being labeled as a memory out of bounds access</p>



<a name="374640347"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374640347" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fritz Rehde <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374640347">(Jul 12 2023 at 14:28)</a>:</h4>
<p>I am able to recognize when the MTE (hardware) trap occurs, by adding this code to <code>traphandlers/unix.rs</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">faulting_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">signum</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">libc</span>::<span class="n">SIGSEGV</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">libc</span>::<span class="n">SIGBUS</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Some</span><span class="p">((</span><span class="o">*</span><span class="n">siginfo</span><span class="p">).</span><span class="n">si_addr</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">),</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">None</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="c1">// end of previous code, beginning of my code</span>

<span class="w">        </span><span class="c1">// Add MTE error handling</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">signum</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">libc</span>::<span class="n">SIGSEGV</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">siginfo</span><span class="p">).</span><span class="n">si_code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SEGV_MTESERR</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// raise_lib_trap(Trap::MemoryTaggingExtensionFault);</span>
<span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">"found mte bug"</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
</code></pre></div>
<p>but I am not sure how to pass this information onto the the trap handler. I have extended <code>trap_encoding::Trap</code> and <code>TrapCode</code> for the MTE fault, but I'm not sure how to pass instances of these to the respective handler. Any ideas/help?</p>



<a name="374640782"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374640782" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fritz Rehde <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374640782">(Jul 12 2023 at 14:30)</a>:</h4>
<p>Ah you can see, I tried manually raising a lib trap, but that caused a seg fault, probably because the method is marked as highly unsafe and it doesn't "clean up" after itself, as stated in its documentation. So that is probably the wrong way to go.</p>



<a name="374660115"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374660115" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374660115">(Jul 12 2023 at 15:28)</a>:</h4>
<p>Is the goal to get wasm opcodes that have a new <code>Trap</code> designation? If that's the case then that's done via other means, but yeah <code>raise_lib_trap</code> won't work in the signal handler</p>



<a name="374660377"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374660377" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374660377">(Jul 12 2023 at 15:29)</a>:</h4>
<p>Cranelift emits metadata for all instructions in the form of "if this instruction traps it's this trap opcode", so it your goal is to get a new trap opcode then that's part of the compilation pipeline when generating the instruction that might trap</p>



<a name="374660423"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374660423" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374660423">(Jul 12 2023 at 15:29)</a>:</h4>
<p>and that shouldn't actually need any handling in the signal handler itself</p>



<a name="374660515"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374660515" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374660515">(Jul 12 2023 at 15:29)</a>:</h4>
<p>(e.g. it's already sigsegv and it'd be caught and recognized through normal conditions)</p>



<a name="374663934"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374663934" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fritz Rehde <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374663934">(Jul 12 2023 at 15:39)</a>:</h4>
<p>My goal is to somehow signal to the user of wasmtime that an mte fault occurred (note that mte already works as expected, it's just the error message that this is about), instead of wasmtime printing <code>wasm trap: out of bounds memory access</code>. Instead, I would like it to say something like "an mte fault occured". As I mentionned in my previous message, I have been able to identify the MTE trap in <code>traphandlers/unix.rs</code> with the <code>if signum == libc::SIGSEGV &amp;&amp; (*siginfo).si_code == SEGV_MTESERR {</code> line, but I'm not sure where I now need to add more code to get the user-facing error message I want. If I read your message correctly, do I have to add something to cranelift (as well)? Could you maybe point me to some locations where modifications would be necessary? Thanks for the help!</p>



<a name="374664082"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374664082" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374664082">(Jul 12 2023 at 15:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="254389">Chris Fallin</span> <a href="#narrow/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F/near/374381681">said</a>:</p>
<blockquote>
<p>I don't think we have anything to handle, it just falls into the "SIGSEGV turns into a wasm trap" bucket probably</p>
</blockquote>
<p>FWIW, we pass unknown signals along to the next signal handler if we don't recognize it as originating from within wasm, we don't have an indiscriminate bucket per se.</p>



<a name="374664442"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374664442" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374664442">(Jul 12 2023 at 15:40)</a>:</h4>
<p>How is this trap generated? For example what instruction generates it? </p>
<p>If a single instruction can generate two kinds of traps then what you wrote in the signal handler will be required. If you're adding new instructions which only have one kind of trap, then this'll be done win Cranelift by registering traps at the right time during instruction emission</p>



<a name="374664764"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374664764" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374664764">(Jul 12 2023 at 15:41)</a>:</h4>
<p>If threading things around is required you can follow the flow of <code>fault_addr</code> as it goes throughout the system and that could turn into something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">enum</span> <span class="nc">TrapAux</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Segv</span><span class="p">(</span><span class="kt">usize</span><span class="p">),</span>
<span class="w">    </span><span class="n">Mte</span><span class="p">,</span>
<span class="w">    </span><span class="nb">None</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<p>(or something like that)</p>



<a name="374675946"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374675946" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fritz Rehde <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374675946">(Jul 12 2023 at 16:16)</a>:</h4>
<p>That's the tricky part, the MTE traps aren't generated by just one specific instruction. MTE works by tagging memory regions and pointers, and trapping if some memory access is performed where the tag of the pointer doesn't match the tag of the region. So it could be loads, stores etc. From <a href="https://www.kernel.org/doc/html/v5.12/arm64/memory-tagging-extension.html">https://www.kernel.org/doc/html/v5.12/arm64/memory-tagging-extension.html</a>, I found <code>The kernel raises a SIGSEGV synchronously, with .si_code = SEGV_MTESERR and .si_addr = &lt;fault-address&gt;. The memory access is not performed.</code>, so I assumed the way to handle the MTE trap was to watch for a SIGSEGV and compare the si_code, which I did in the code snippet above. So basically I am trying to handle this MTE trap, and display a new, custom Trap to the user. My though process was: In the <code>traphandlers/unix.rs</code>, I can identify the MTE trap, so now I want to somehow "send" a custom <code>Trap</code> type to the whatever handler handles this kind of stuff. Is this possible?</p>



<a name="374676547"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374676547" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fritz Rehde <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374676547">(Jul 12 2023 at 16:18)</a>:</h4>
<p>I thought the <code>runtime</code> was best suited to make my additions to the code, because the MTE trap only occurs at runtime, and can't be identified at compile time. Maybe I am wrong in that.</p>



<a name="374677397"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374677397" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374677397">(Jul 12 2023 at 16:21)</a>:</h4>
<p>Ok that makes sense. In that case you'll want to, in the signal handling context as you are, determine that this is an MTE trap and then thread that through with the <code>faulting_addr</code> that's currently threaded everywhere.  Then <a href="https://github.com/bytecodealliance/wasmtime/blob/80e68c336ba53f75146f2cb3920338155a2c7430/crates/wasmtime/src/trap.rs#L106-L121">here</a> you can process <code>faulting_addr</code> (which would be renamed to handle MTE stuff) in conjunction with the trap opcode. For example if the opcode says <code>Trap::MemoryOutOfBounds</code> but MTE was detected you'd change that to <code>Trap::YourNewCustomTrapCode</code> or something like that</p>



<a name="374677694"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374677694" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374677694">(Jul 12 2023 at 16:22)</a>:</h4>
<p>the code I linked represents that a trap at a particular native code address was caught and the <code>faulting_addr</code> is sort of "optional context" form the original trap. That's then processed via cranelift-generated lookup tables to convert the pc to an opcode, and you'll be updating that to generate a new opcode</p>



<a name="374678297"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374678297" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fritz Rehde <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374678297">(Jul 12 2023 at 16:24)</a>:</h4>
<p>I guess the part I am unclear about is <code>then thread that through with the faulting_addr that's currently threaded everywhere</code>. What do you mean with this? What does "threading" mean in this context?</p>



<a name="374678335"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374678335" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374678335">(Jul 12 2023 at 16:24)</a>:</h4>
<p>Another way to put all this I think is that we're already catching MTE traps and what's necessary next is to plumb the metadata around to classify the trap as an MTE-related trap rather than an out of bounds trap because, by default, all memory-related instructions assume that a signal must mean the access was out of bounds (which is no longer true with MTE)</p>



<a name="374678471"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374678471" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374678471">(Jul 12 2023 at 16:25)</a>:</h4>
<p>wait but would these MTE traps get raised because a correctly implemented Wasm program attempted to do something it shouldn't do? (like access OOB memory for example) or would the trap get raised because of a bug in the runtime/compiler? If the latter then this should just hard kill wasmtime and we shouldn't generate custom Trap types and pass them around</p>
<p>maybe I am misunderstanding something...</p>



<a name="374678542"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374678542" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374678542">(Jul 12 2023 at 16:25)</a>:</h4>
<p>oh so right now we record on segfaults not only the address of the faulting instruction but the address that was faulted on (e.g. you loaded from 0x000f00 or something like that -- this "context" of the <code>faulting_addr</code> needs to make its way from the signal handler into the rest of Wasmtime, and you'll need to shepherd along the MTE information alongside this other information</p>



<a name="374679271"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374679271" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fritz Rehde <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374679271">(Jul 12 2023 at 16:28)</a>:</h4>
<p><span class="user-mention" data-user-id="253990">@fitzgen (he/him)</span> Ah, my bad for not clarifying earlier. The MTE-functionality we added is to increase memory safety of the wasm program we are executing with wasmtime. If we have a wasm program (that might have been compiled from unsafe C), then we want to use MTE to detect memory unsafe things like use-after-free or other memory-related bugs.</p>



<a name="374679375"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374679375" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374679375">(Jul 12 2023 at 16:28)</a>:</h4>
<p>UAF within the Wasm guest?</p>



<a name="374680221"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374680221" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fritz Rehde <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374680221">(Jul 12 2023 at 16:31)</a>:</h4>
<p>Yes, or OOB like you mentionned</p>



<a name="374680583"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374680583" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374680583">(Jul 12 2023 at 16:32)</a>:</h4>
<p>okay yeah then you'd want to recognize when you get an MTE signal that is indeed from within Wasm and not because some other part of the host is also using MTE (can look at the offending PC) and then do all the stuff that Alex has been saying</p>



<a name="374680766"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374680766" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374680766">(Jul 12 2023 at 16:33)</a>:</h4>
<p>that part I think is already handled because wasmtime only catches signals for instructions which are reigstered as being able to trap</p>



<a name="374680843"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374680843" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374680843">(Jul 12 2023 at 16:33)</a>:</h4>
<p>ah is that part generic over all signals? great!</p>



<a name="374681030"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374681030" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374681030">(Jul 12 2023 at 16:34)</a>:</h4>
<p>yeah that's <a href="https://github.com/bytecodealliance/wasmtime/blob/80e68c336ba53f75146f2cb3920338155a2c7430/crates/runtime/src/traphandlers.rs#L464">this check</a></p>



<a name="374681046"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374681046" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374681046">(Jul 12 2023 at 16:34)</a>:</h4>
<p>which gets executed on all signals</p>



<a name="374681119"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374681119" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374681119">(Jul 12 2023 at 16:34)</a>:</h4>
<p>perfect, sorry for the noise</p>



<a name="374685268"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374685268" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fritz Rehde <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374685268">(Jul 12 2023 at 16:50)</a>:</h4>
<p><span class="user-mention" data-user-id="253994">@Alex Crichton</span> So, you're saying I should pass along ("thread") the MTE Trap as a <code>TrapReason::Jit</code> (I originally thought <code>TrapReason::Wasm</code> sounded more fitting, but not sure) by calling <code>info.set_jit_trap(pc, fp, faulting_addr);</code>, with the difference that I have to add my MTE information to that somehow (probably just adding a boolean argument)? Or do you mean I shouldn't change anything in <code>traphandlers/unix.rs</code> and just insert my MTE check in the <code>from_runtime_box</code> snippet you posted? Also, with opcode, you don't mean <code>(*siginfo).si_code</code>, which is what I need to check whether it's an MTE trap, right?</p>



<a name="374686144"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374686144" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374686144">(Jul 12 2023 at 16:53)</a>:</h4>
<p>More-or-less, yes. You're right in that you're going to want to modify <code>TrapReason::Jit</code>. Currently that only has <code>faulting_addr: Option&lt;usize&gt;</code> and yeah you may want to add <code>is_mte_fault: bool</code> or something like that (sorry I don't know anything about MTE so I don't know what would be appropriate here). That would then make its way to <code>from_runtime_box</code> where you can convert a <code>MemoryOutOfBounds</code> trap into an MTE-specific trap depending on the state in <code>TrapReason::Jit</code>.</p>



<a name="374686185"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374686185" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374686185">(Jul 12 2023 at 16:53)</a>:</h4>
<p>You'll need to inspect <code>si_code</code> to determine how to construct <code>TrapReason::Jit</code> still</p>



<a name="374689148"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374689148" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fritz Rehde <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374689148">(Jul 12 2023 at 17:04)</a>:</h4>
<p>Ok, that makes sense, thank you for the help and time! One more thing: I'm looking at <code>from_runtime_box</code> right now, and I don't see any mention of anything related to <code>MemoryOutOfBounds</code>. Which enum that contains <code>MemoryOutOfBounds</code> do you mean? I'm not sure how to return my MTE trap error message to the user here. Is that done by returning a type <code>Error</code> here?</p>



<a name="374689693"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374689693" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374689693">(Jul 12 2023 at 17:07)</a>:</h4>
<p>The <code>code</code> variable has type <code>Trap</code> which is likely storing <code>Trap::MemoryOutOfBounds</code> today for your MTE traps. This <code>code</code> is what you'll want to change to something MTE-related. By default all memory accesses, if they fault, report "memory out of bounds", which is why that's the case today</p>



<a name="374702305"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374702305" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fritz Rehde <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374702305">(Jul 12 2023 at 17:59)</a>:</h4>
<p>Thanks a lot for your help! It's working as expected now!</p>



<a name="374729544"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374729544" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fritz Rehde <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374729544">(Jul 12 2023 at 20:05)</a>:</h4>
<p>Follow-up: I know wasmtime already uses ARM's Pointer Authentication (PAC) for preventing ROP-oriented attacks. Do you "throw custom error messages", like I implemented for MTE, for PAC?</p>



<a name="374729832"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374729832" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374729832">(Jul 12 2023 at 20:06)</a>:</h4>
<p>Not currently no because if a PAC error trips that's a critical compiler error which should take down the entire process. It's a defense-in-depth mechanism as opposed to a feature given to content to detect issues in-content</p>



<a name="374736678"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374736678" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fritz Rehde <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374736678">(Jul 12 2023 at 20:20)</a>:</h4>
<p>I don't quite understand. Wasmtime's PAC support is for wasm guests/programs that wasmtime executes, right? PAC is also a runtime error that wasmtime might encounter/have to handle, similar to MTE. Which process do you mean when you say "taking down the process"? Wasmtime itself or the wasm guest?</p>



<a name="374737472"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374737472" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jamey Sharp <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374737472">(Jul 12 2023 at 20:24)</a>:</h4>
<p>Since a wasm guest can only make calls and branches to safe targets, enforced during wasm validation, pointer authentication checks "can't" fail. If they fail anyway, that indicates we screwed up in the compiler, at which point all our safety guarantees are shot and we should fail really noisily. That's why Alex says the entire Wasmtime process should abort at that point.</p>



<a name="374739010"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374739010" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fritz Rehde <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374739010">(Jul 12 2023 at 20:31)</a>:</h4>
<p>I am still slightly confused. Are pointer auth checks only done during compilation (or validation, though I'm not entirely sure what that is) in wasmtime? I don't understand why a PAC error/trap is a critical compiler error. In my understanding, the PAC instructions are for instance inserted to protect the return address. If this is somehow (some other vulnerability in the wasm code) overwritten by an attacker, then the PAC instruction would fail to authenticate the address, and, I think, crash/trap somehow. Are you saying the wasmtime process noisily aborts when encountering such PAC crashs/traps?</p>



<a name="374739265"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374739265" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374739265">(Jul 12 2023 at 20:32)</a>:</h4>
<p>it means the compiler successfully produced code, but by having a PAC failure, we determined that code was incorrect at runtime</p>



<a name="374739302"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374739302" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374739302">(Jul 12 2023 at 20:33)</a>:</h4>
<p>ie there was a miscompile / compiler bug</p>



<a name="374739387"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374739387" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fritz Rehde <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374739387">(Jul 12 2023 at 20:33)</a>:</h4>
<p>Does this have something to do with Linux sending a SIGILL signal instead of SIGSEGV?</p>



<a name="374739537"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374739537" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374739537">(Jul 12 2023 at 20:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="625009">Fritz Rehde</span> <a href="#narrow/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F/near/374739010">said</a>:</p>
<blockquote>
<p>If this is somehow (some other vulnerability in the wasm code) overwritten by an attacker, then the PAC instruction would fail to authenticate the address, and, I think, crash/trap somehow. Are you saying the wasmtime process noisily aborts when encountering such PAC crashs/traps?</p>
</blockquote>
<p>correct</p>
<p>the return address could be wrong either because of an attacker trying to do ROP (by leveraging a compiler or runtime bug) or because of a general bug with our compiler and the code it generates (as discussed above)</p>



<a name="374739702"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374739702" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jamey Sharp <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374739702">(Jul 12 2023 at 20:34)</a>:</h4>
<p>A wasm guest should not be able to write anywhere that we have a pointer to code, such as writing to the native stack; if we allowed a stray write like that then we've already lost and the PAC failure is just detecting the bug sometime later.</p>



<a name="374739861"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374739861" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374739861">(Jul 12 2023 at 20:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="625009">Fritz Rehde</span> <a href="#narrow/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F/near/374739387">said</a>:</p>
<blockquote>
<p>Does this have something to do with Linux sending a SIGILL signal instead of SIGSEGV?</p>
</blockquote>
<p>I personally have no idea why certain hardware features map to certain signals vs other signals. seems semi-arbitrary.</p>



<a name="374741004"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374741004" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fritz Rehde <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374741004">(Jul 12 2023 at 20:41)</a>:</h4>
<p>Ok, thanks for the explanations. But how does it work in practice? Do you actually identify PAC errors/traps, and, when aborting wasmtime, provide some sort of error message to users? Or is such a PAC trap not identified by itself, and belongs to a larger group of traps/signals, that might all lead to aborting wasmtime?</p>



<a name="374741207"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374741207" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374741207">(Jul 12 2023 at 20:42)</a>:</h4>
<p>The latter; we don't catch SIGSEGVs that do not map to expected points where wasm could semantically hit an error (e.g. out-of-bounds)</p>



<a name="374741225"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374741225" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374741225">(Jul 12 2023 at 20:42)</a>:</h4>
<p>so it will pass through and Linux will kill the process</p>



<a name="374741425"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374741425" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374741425">(Jul 12 2023 at 20:43)</a>:</h4>
<p><span class="user-mention" data-user-id="625009">@Fritz Rehde</span> to tie the above to some good search-phrases, Wasm has "CFI" (control-flow integrity); this is what implies the property that Jamey describes above, and makes PAC purely a defense-in-depth thing</p>



<a name="374741456"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374741456" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374741456">(Jul 12 2023 at 20:43)</a>:</h4>
<p>we are able to guarantee CFI even on platforms without PAC (because Wasm semantics require it)</p>



<a name="374748300"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/How%20to%20register/handle%20new%20hardware%20trap%3F/near/374748300" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fritz Rehde <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/How.20to.20register.2Fhandle.20new.20hardware.20trap.3F.html#374748300">(Jul 12 2023 at 21:25)</a>:</h4>
<p>Ok, interesting.<br>
Say I wanted to/have added pointer authentication for a different purpose into wasmtime as well, not just preventing ROP attacks like wasmtime currently does. In my case, I wouldn't exactly consider a situation where a PAC trap is encountered at runtime to be a fault in cranelift itself, I would consider it a bug in the wasm guest code, just like MTE prevents buffer overflows, use after frees, which I also consider wasm guest errors, not errors in the cranelift compiler. <br>
In this situation, if I possibly can, I would like to exit with an error similar to how I implemented with MTE. MTE was quite simple, I just had to compare a linux constant (<code>SEGV_MTESERR</code>) with the si_code. But I think/read online that identifying PAC traps/exceptions is more complicated. In my understanding, a PAC trap would cause a <code>SIGILL</code>, but that can mean many different problems, not necessarily a PAC error. However, I am not sure how I could continue from there. I read that PAC traps are asynchronous, meaning that by the time the signal handler receives the <code>SIGILL</code> signal, the program might have advanced beyond where the PAC error actually occured. So maybe an analysis to detect whether the encountered trap is a PAC trap is non-deterministic at best, and probably quite hard to implement.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>