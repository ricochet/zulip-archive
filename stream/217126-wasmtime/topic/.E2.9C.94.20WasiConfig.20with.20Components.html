<html>
<head><meta charset="utf-8"><title>✔ WasiConfig with Components · wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/index.html">wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html">✔ WasiConfig with Components</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="311654746"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311654746" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bailey Hayes <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311654746">(Nov 22 2022 at 16:13)</a>:</h4>
<p>How do you see the WasiCtx and WasiConfig idioms changing with the component model? If I build for components, the current tuple doesn't reflect whether I built for wasi. The component storedata doesn't appear to integrate with a WasiCtx.</p>



<a name="311655484"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311655484" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311655484">(Nov 22 2022 at 16:17)</a>:</h4>
<p>For wasi integration with the e.g. Rust stdlib it would have to be part of the target tuple</p>



<a name="311655678"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311655678" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311655678">(Nov 22 2022 at 16:18)</a>:</h4>
<p><a href="https://github.com/bytecodealliance/cargo-component#wasi-support">https://github.com/bytecodealliance/cargo-component#wasi-support</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/cargo-component#wasi-support" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/1a852932f44bd6bac0011dfad9b093e60805fc89\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f396133396162363337363564316335306663383261633334626431306265616662616236333037316163326364393239353235616362396232613638633236612f62797465636f6465616c6c69616e63652f636172676f2d636f6d706f6e656e74)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/cargo-component#wasi-support" title="GitHub - bytecodealliance/cargo-component: A Cargo subcommand for creating WebAssembly components based on the component model proposal.">GitHub - bytecodealliance/cargo-component: A Cargo subcommand for creating WebAssembly components based on the component model proposal.</a></div><div class="message_embed_description">A Cargo subcommand for creating WebAssembly components based on the component model proposal. - GitHub - bytecodealliance/cargo-component: A Cargo subcommand for creating WebAssembly components bas...</div></div></div>



<a name="311655827"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311655827" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bailey Hayes <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311655827">(Nov 22 2022 at 16:18)</a>:</h4>
<p>Most of the examples and tests I've seen so far don't use WASI if built with components. WASI isn't mentioned in the tracking issue: <a href="https://github.com/bytecodealliance/wasmtime/issues/4185">https://github.com/bytecodealliance/wasmtime/issues/4185</a>. I'm looking at lower layers than cargo-component and I'm wondering if there's a gap we missed here?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/issues/4185" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/113dd67cd412a13af342cdd5d9deaea39f103426\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f373135343832343937333762363265623630353439333865363863633136366631303062396639666362653037666535373031343533613933333663383865342f62797465636f6465616c6c69616e63652f7761736d74696d652f6973737565732f34313835)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/issues/4185" title="Tracking issue for implementing the component model · Issue #4185 · bytecodealliance/wasmtime">Tracking issue for implementing the component model · Issue #4185 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">This is intended to be a tracking issue for the implementation of the component model proposal of WebAssembly. I&#39;m in the progress of implementing this with work in Wasmtime starting at #4005 a...</div></div></div>



<a name="311656427"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311656427" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311656427">(Nov 22 2022 at 16:22)</a>:</h4>
<p>I think the gap is just "WASI for components", which is in progress</p>



<a name="311656855"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311656855" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bailey Hayes <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311656855">(Nov 22 2022 at 16:24)</a>:</h4>
<p>I'm looking for the design or tracking doc for how WASI is supposed to work with components.</p>



<a name="311658459"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311658459" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311658459">(Nov 22 2022 at 16:32)</a>:</h4>
<p>I see. I think WASI component support doesn't really fall "under" the component model work, it just depends on it. I haven't seen any formal tracking of work on it.</p>



<a name="311659329"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311659329" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bailey Hayes <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311659329">(Nov 22 2022 at 16:36)</a>:</h4>
<p><span class="user-mention" data-user-id="253998">@Luke Wagner</span> or <span class="user-mention" data-user-id="253994">@Alex Crichton</span> I'm writing out an elixir OTP host that embeds wasmtime. The last part that's fuzzy for me is around how the component model will work with WASI. Is WASI optional? The way I understand things, it should be optional. Earlier versions of this host created a module and inspected for WASI imports and then built up a wasi store if the module was wasi enabled. This is a little awkward with the component-model feature enabled. I want this host to work with wasm32-unknown-unknown ABI, wasm32-wasi-unknown, and wasm32-&lt;to be decided component triple&gt;.  Right now I'm building out the API to compile and instantiate a module or component (even if the API is just stubs). I have a component OR module working, just not WASI enabled. I'm not sure how and where I should pass around the WasiCtx in the component case. If that's going to be part of the StoreData for the component, easy-peasy.</p>



<a name="311659900"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311659900" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311659900">(Nov 22 2022 at 16:39)</a>:</h4>
<p>The current thinking, which isn't well-written down and is still being figured out, is:</p>
<ul>
<li>We'll still use <code>wasm32-wasi</code></li>
<li>An "adapter" such as <a href="https://github.com/sunfishcode/preview1.wasm">this</a> will convert old-style <code>*.witx</code> to new-style component model</li>
<li>In tandem wasi-preview2 will be evolved to be described with <code>*.wit</code> files</li>
<li>Eventually when wasi-preview2 and the component model have settled then preview2 is stabilized</li>
<li>Once runtimes have caught up toolchains will update their WASI ABI to preview2</li>
<li>Once preview1 has faded away enough runtimes will remove support for preview1</li>
</ul>
<p>Does that make sense?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/sunfishcode/preview1.wasm" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/7b4e4d0a83f160d2b61f61c0d802b7efabd6852c\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f373239366232303062343535353834353335336665366239343032396236616164323961376265656663396138323935353233643738656533636232396630352f73756e66697368636f64652f70726576696577312e7761736d)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/sunfishcode/preview1.wasm" title="GitHub - sunfishcode/preview1.wasm: Experimental experiments">GitHub - sunfishcode/preview1.wasm: Experimental experiments</a></div><div class="message_embed_description">Experimental experiments. Contribute to sunfishcode/preview1.wasm development by creating an account on GitHub.</div></div></div>



<a name="311660995"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311660995" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Wagner <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311660995">(Nov 22 2022 at 16:45)</a>:</h4>
<p>I agree that conceptually "WASI" should be optional to use when building a component (just like when using a core module).  I would even hope that, in the final goal state, there is need for a "WASI store", which was in earlier times necessitated by the magical nature of WASI which, with the component model, should cease to be magical at all (as a consequence of being virtualizable).  But I can't speak to whether there are any (perhaps temporary) limitations that tie the two together atm.</p>



<a name="311661170"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311661170" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bailey Hayes <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311661170">(Nov 22 2022 at 16:46)</a>:</h4>
<p>wasi-preview2 has worlds and wit which is good and I'm following. But even if it defines wit, I haven't seen a sketch for how to pass around environment variables, stdin, etc specific to non-core components. I don't think we want the same wasictx for a component and all of its dependencies. I'm really asking for what the union between how a component imports wasi ctx's.</p>
<p>A possible answer is: from the wasmtime API, we expect every ComponentStore to optionally have a WasiCtx. Some external definition like from a world file would make it so that you can recurse through the components and populate these. But the reason I ask, is that I'm wondering if instead we could do away with the WasiCtx. This seems like info that we could embed within each component dynamically as part of the composition against a world file.</p>



<a name="311661755"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311661755" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bailey Hayes <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311661755">(Nov 22 2022 at 16:49)</a>:</h4>
<p>Heh and <span class="user-mention" data-user-id="253998">@Luke Wagner</span> already thinking around what I was asking. Yes, it seems like the idea of a WasiCtx is a thing that's grafted on and not integrated with components (and should be done away with in API's like wasmtime).</p>



<a name="311662046"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311662046" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311662046">(Nov 22 2022 at 16:51)</a>:</h4>
<p>For things like env vars and such it's a work-in-progress still, dan/pat are working actively on this and should have more to show soon</p>



<a name="311662125"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311662125" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311662125">(Nov 22 2022 at 16:51)</a>:</h4>
<p>They're out this week but I'd recommend reaching out to them for more information</p>



<a name="311662236"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311662236" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bailey Hayes <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311662236">(Nov 22 2022 at 16:52)</a>:</h4>
<p>and to be clear, I don't expect working code or even code to exist. I'm really just thinking around my high-level stubs so that I can publish an alpha and iterate as the implementations roll out</p>



<a name="311662558"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311662558" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311662558">(Nov 22 2022 at 16:53)</a>:</h4>
<p>There is nothing in the current wasmtime component implementation that would get rid of <code>WasiCtx</code> (or something just like it)</p>



<a name="311662710"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311662710" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bailey Hayes <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311662710">(Nov 22 2022 at 16:54)</a>:</h4>
<p>it also doesn't add it</p>



<a name="311662979"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311662979" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311662979">(Nov 22 2022 at 16:55)</a>:</h4>
<p>Well, if you have a host implementation of wasi (like <code>wasmtime-wasi</code> today), that implementation is going to have state associated with it, and that state has to be part of the <code>Store</code> data. I haven't seen anything about changing that general model, and wasmtime's component Linker still works that way</p>



<a name="311663336"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311663336" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311663336">(Nov 22 2022 at 16:57)</a>:</h4>
<p>That isn't intrinsic to WASI, but to any host implementation of any interface</p>



<a name="311663560"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311663560" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bailey Hayes <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311663560">(Nov 22 2022 at 16:58)</a>:</h4>
<p>If I have a composed component, then in the imports it should have all of the information needed about what would have previously been in a WasiCtx. As a host implementer, those details are likely no longer needed in the API, hence the original question, how are we expecting those idioms to change.</p>
<p>The best I can find for what is planned here is: <a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/examples/SharedEverythingDynamicLinking.md#runtime-dynamic-linking">https://github.com/WebAssembly/component-model/blob/main/design/mvp/examples/SharedEverythingDynamicLinking.md#runtime-dynamic-linking</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/examples/SharedEverythingDynamicLinking.md#runtime-dynamic-linking" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/559af6aa83496a41f2415142bdfa1daeb2aeac52\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f633935393433323036663066633931626237383236386132306165666462333365343337623166323961613433656230363465616235653463333462313031362f576562417373656d626c792f636f6d706f6e656e742d6d6f64656c)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/examples/SharedEverythingDynamicLinking.md#runtime-dynamic-linking" title="component-model/SharedEverythingDynamicLinking.md at main · WebAssembly/component-model">component-model/SharedEverythingDynamicLinking.md at main · WebAssembly/component-model</a></div><div class="message_embed_description">Repository for design and specification of the Component Model - component-model/SharedEverythingDynamicLinking.md at main · WebAssembly/component-model</div></div></div>



<a name="311663730"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311663730" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311663730">(Nov 22 2022 at 16:59)</a>:</h4>
<p>Hm sorry I'm getting a bit lost in what you're asking about, it seems you're asking about both how embeddings will work and how guests are generated and how guests will work?</p>



<a name="311663797"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311663797" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311663797">(Nov 22 2022 at 16:59)</a>:</h4>
<p>The <code>WasiCtx</code> state isn't going away, the idea it is "just picks up new trait impls" for wit-bindgen-generated traits for the wasi-preview2 interfaces</p>



<a name="311663932"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311663932" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311663932">(Nov 22 2022 at 17:00)</a>:</h4>
<p>The <code>wasm32-wasi</code> target is not expected to go away and it's not planned at this time to add a new component target, instead the existing target will be used with an adapter, under development, to transform compiler output to a component</p>



<a name="311664016"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311664016" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311664016">(Nov 22 2022 at 17:00)</a>:</h4>
<p>The difference between core-wasm-wasi and component-wasi is the output artifact, whether it's a module or a component</p>



<a name="311664109"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311664109" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311664109">(Nov 22 2022 at 17:00)</a>:</h4>
<p>In that the embedder APIs for instantiating components are also completely different than those of modules -- similar in nature but different entrypoints.</p>



<a name="311664983"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311664983" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bailey Hayes <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311664983">(Nov 22 2022 at 17:05)</a>:</h4>
<p>Say I compose a component with a world for wasi-cloud. Will the imports in the component-wasi artifact include additional information like "envVars" for a sub-component?</p>



<a name="311665104"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311665104" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311665104">(Nov 22 2022 at 17:05)</a>:</h4>
<p>I don't have a great way to answer that I think, I can talk about various layers  but I don't know if that's what you're looking for</p>



<a name="311665197"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311665197" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311665197">(Nov 22 2022 at 17:06)</a>:</h4>
<p>the current rough plan is that a wasi command takes env vars as a parameter to the "start" function more or less</p>



<a name="311665335"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311665335" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311665335">(Nov 22 2022 at 17:07)</a>:</h4>
<p>That would be for preview2, right?</p>



<a name="311665636"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311665636" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311665636">(Nov 22 2022 at 17:08)</a>:</h4>
<p><span class="user-mention" data-user-id="421591">@Bailey Hayes</span> I have to do this same work for Spin. I've just been putting it off <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="311665784"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311665784" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bailey Hayes <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311665784">(Nov 22 2022 at 17:09)</a>:</h4>
<p>I'm looking to get fully plugged in so that I can contribute better to upstream</p>



<a name="311665925"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311665925" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311665925">(Nov 22 2022 at 17:09)</a>:</h4>
<p>Yeah passing env vars as an argument would be a preview2 thing</p>



<a name="311665942"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311665942" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311665942">(Nov 22 2022 at 17:09)</a>:</h4>
<p>(if that's what's settled on)</p>



<a name="311666683"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311666683" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bailey Hayes <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311666683">(Nov 22 2022 at 17:13)</a>:</h4>
<p>preview2 or hypothetical world of ideal component support, I have still only seen how we think reactors will work, e.g. like stdin/stdout being passed around starting with the core module acting as a CLI. In that case you'd have a full WasiCtx to instantiate the component. Instead, in this future world, I want to see that the composed component has all of the right information, e.g. the blobstore component only has the ctx needed for connecting to the blobstore. This can be specified as part of the world file so that it's clear what WASI ctx goes where. Then the question for a host implementer using Wasmtime is why would I instantiate the WasiCtx and store with that information when this is something that should come from parsing a component?</p>



<a name="311667445"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311667445" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311667445">(Nov 22 2022 at 17:17)</a>:</h4>
<p>You still need state for wasi to track e.g. open files. That state has to be reachable from the <code>Store</code> data. You could potentially replace some of what WasiCtxBuilder does with magical import-based config but you can't remove WasiCtx</p>



<a name="311668587"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311668587" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bailey Hayes <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311668587">(Nov 22 2022 at 17:22)</a>:</h4>
<p>Yeah I think a magic WasiCtxBuilder is what I'm looking for. Other constraints is that we may want to be able to change connection strings or other data at runtime. I don't want it locked into something after calling the <code>start</code> function (fine for instantiation, but needs to be mutable).</p>



<a name="311671945"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311671945" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bailey Hayes <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311671945">(Nov 22 2022 at 17:40)</a>:</h4>
<p>I think I landed on what I needed. I'm not going to expose a WasiCtx to mix-in for components since that appears to be a [future] anti-pattern. A world file is a safer and idiomatic way to initialize a component's WasiCtx. WasiCtx's can be attached to an individual component's store using a utility like WasiCtxBuilder. The populated Store will have a list (tree?) of components, each with a WasiCtx that the caller can add in overrides. <strong>hand waves</strong></p>
<p>module API: <code>WasmRuntime.Wasmtime.start_link(%{module: module, wasi: wasi})</code></p>
<p>component API: </p>
<div class="codehilite" data-code-language="Elixir"><pre><span></span><code><span class="nc">WasmRuntime.Wasmtime</span><span class="o">.</span><span class="n">build_store</span><span class="p">(</span><span class="n">component</span><span class="p">)</span><span class="w"> </span><span class="c1"># calls WasiCtxBuilder</span><span class="w"></span>
<span class="c1"># mixin wasi opts, then compile and instantiate</span><span class="w"></span>
<span class="nc">WasmRuntime.Wasmtime</span><span class="o">.</span><span class="n">start_link</span><span class="p">(%{</span><span class="ss">component</span><span class="p">:</span><span class="w"> </span><span class="n">component</span><span class="p">})</span><span class="w"></span>
</code></pre></div>



<a name="311672263"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311672263" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311672263">(Nov 22 2022 at 17:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="421591">Bailey Hayes</span> has marked this topic as resolved.</p>



<a name="311675515"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20WasiConfig%20with%20Components/near/311675515" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20WasiConfig.20with.20Components.html#311675515">(Nov 22 2022 at 17:58)</a>:</h4>
<p>The <code>Store</code>-specific state is disconnected sort of from WASI and how a component looks internally. The <code>Store</code> state is just used to satisfy the how imports of the final component, and whatever is used internally within the component is unknown to the store/embedder</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>