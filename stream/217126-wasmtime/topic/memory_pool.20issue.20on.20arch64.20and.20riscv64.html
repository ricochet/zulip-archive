<html>
<head><meta charset="utf-8"><title>memory_pool issue on arch64 and riscv64 · wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/index.html">wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html">memory_pool issue on arch64 and riscv64</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="438362358"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438362358" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mats Brorsson <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438362358">(May 13 2024 at 13:26)</a>:</h4>
<p>I have an issue with wasmtime on both aarch64 (nvidia jetson nano) and riscv64 (VisionFive 2). I have tried both the Hello WASI HTTP example and a simple spin app with the same result on both platforms. I get a panic when wasmtime tries to mmap:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">2024</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">13</span><span class="n">T13</span>:<span class="mi">17</span>:<span class="mf">20.823024</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_runtime</span>::<span class="n">instance</span>::<span class="n">allocator</span>::<span class="n">pooling</span>::<span class="n">memory_pool</span>: <span class="nc">creating</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">pool</span>: <span class="nc">SlabConstraints</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">expected_slot_bytes</span>: <span class="mi">4294967296</span><span class="p">,</span><span class="w"> </span><span class="n">max_memory_bytes</span>: <span class="mi">4294967296</span><span class="p">,</span><span class="w"> </span><span class="n">num_slots</span>: <span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="n">num_pkeys_available</span>: <span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">guard_bytes</span>: <span class="mi">2147483648</span><span class="p">,</span><span class="w"> </span><span class="n">guard_before_slots</span>: <span class="nc">true</span><span class="w"> </span><span class="p">}</span><span class="w"> </span>-&gt;
<span class="nc">SlabLayout</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">num_slots</span>: <span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="n">slot_bytes</span>: <span class="mi">6442450944</span><span class="p">,</span><span class="w"> </span><span class="n">max_memory_bytes</span>: <span class="mi">4294967296</span><span class="p">,</span><span class="w"> </span><span class="n">pre_slab_guard_bytes</span>: <span class="mi">2147483648</span><span class="p">,</span><span class="w"> </span><span class="n">post_slab_guard_bytes</span>: <span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">num_stripes</span>: <span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">(</span><span class="n">total</span>: <span class="mi">6444598427648</span><span class="p">)</span>
<span class="n">Error</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">pool</span><span class="w"> </span><span class="n">mapping</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
   <span class="mi">0</span>: <span class="nc">mmap</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">reserve</span><span class="w"> </span><span class="mh">0x5dc80000000</span><span class="w"> </span><span class="n">bytes</span>
<span class="w">   </span><span class="mi">1</span>: <span class="nc">Cannot</span><span class="w"> </span><span class="n">allocate</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="p">(</span><span class="n">os</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span>
</code></pre></div>
<p>aarch64 environment:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">jetson</span><span class="o">@</span><span class="mi">360</span><span class="n">lab</span><span class="o">-</span><span class="n">nano2</span>:<span class="o">~/</span><span class="n">docker</span><span class="o">/</span><span class="n">dockercon</span><span class="cp">$</span><span class="w"> </span><span class="n">lsb_release</span><span class="w"> </span><span class="o">-</span><span class="n">a</span>
<span class="n">No</span><span class="w"> </span><span class="n">LSB</span><span class="w"> </span><span class="n">modules</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">available</span><span class="p">.</span>
<span class="n">Distributor</span><span class="w"> </span><span class="n">ID</span>: <span class="nc">Ubuntu</span>
<span class="n">Description</span>:    <span class="nc">Ubuntu</span><span class="w"> </span><span class="mf">18.04.6</span><span class="w"> </span><span class="n">LTS</span>
<span class="n">Release</span>:        <span class="mf">18.04</span>
<span class="n">Codename</span>:       <span class="nc">bionic</span>
<span class="n">jetson</span><span class="o">@</span><span class="mi">360</span><span class="n">lab</span><span class="o">-</span><span class="n">nano2</span>:<span class="o">~/</span><span class="n">docker</span><span class="o">/</span><span class="n">dockercon</span><span class="cp">$</span><span class="w"> </span><span class="n">uname</span><span class="w"> </span><span class="o">-</span><span class="n">a</span>
<span class="n">Linux</span><span class="w"> </span><span class="mi">360</span><span class="n">lab</span><span class="o">-</span><span class="n">nano2</span><span class="w"> </span><span class="mf">4.9.337</span><span class="o">-</span><span class="n">tegra</span><span class="w"> </span>#<span class="mi">1</span><span class="w"> </span><span class="n">SMP</span><span class="w"> </span><span class="n">PREEMPT</span><span class="w"> </span><span class="n">Thu</span><span class="w"> </span><span class="n">Jun</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="mi">21</span>:<span class="mi">19</span>:<span class="mi">14</span><span class="w"> </span><span class="n">PDT</span><span class="w"> </span><span class="mi">2023</span><span class="w"> </span><span class="n">aarch64</span><span class="w"> </span><span class="n">aarch64</span><span class="w"> </span><span class="n">aarch64</span><span class="w"> </span><span class="n">GNU</span><span class="o">/</span><span class="n">Linux</span>
</code></pre></div>
<p>riscv64 environment:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">ubuntu</span><span class="o">@</span><span class="n">ubuntu</span>:<span class="o">~/</span><span class="n">src</span><span class="cp">$</span><span class="w"> </span><span class="n">lsb_release</span><span class="w"> </span><span class="o">-</span><span class="n">a</span>
<span class="n">No</span><span class="w"> </span><span class="n">LSB</span><span class="w"> </span><span class="n">modules</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">available</span><span class="p">.</span>
<span class="n">Distributor</span><span class="w"> </span><span class="n">ID</span>: <span class="nc">Ubuntu</span>
<span class="n">Description</span>:    <span class="nc">Ubuntu</span><span class="w"> </span><span class="mf">24.04</span><span class="w"> </span><span class="n">LTS</span>
<span class="n">Release</span>:        <span class="mf">24.04</span>
<span class="n">Codename</span>:       <span class="nc">noble</span>
<span class="n">ubuntu</span><span class="o">@</span><span class="n">ubuntu</span>:<span class="o">~/</span><span class="n">src</span><span class="cp">$</span><span class="w"> </span><span class="n">uname</span><span class="w"> </span><span class="o">-</span><span class="n">a</span>
<span class="n">Linux</span><span class="w"> </span><span class="n">ubuntu</span><span class="w"> </span><span class="mf">6.8.0</span><span class="o">-</span><span class="mi">31</span><span class="o">-</span><span class="n">generic</span><span class="w"> </span>#<span class="mf">31.1</span><span class="o">-</span><span class="n">Ubuntu</span><span class="w"> </span><span class="n">SMP</span><span class="w"> </span><span class="n">PREEMPT_DYNAMIC</span><span class="w"> </span><span class="n">Sun</span><span class="w"> </span><span class="n">Apr</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="mi">01</span>:<span class="mi">12</span>:<span class="mi">53</span><span class="w"> </span><span class="n">UTC</span><span class="w"> </span><span class="mi">2024</span><span class="w"> </span><span class="n">riscv64</span><span class="w"> </span><span class="n">riscv64</span><span class="w"> </span><span class="n">riscv64</span><span class="w"> </span><span class="n">GNU</span><span class="o">/</span><span class="n">Linux</span>
</code></pre></div>
<p>For me the huge mmap seems strange, but it happens also on x86_64, and there it seems to work.</p>
<p>Any help is appreciated.</p>



<a name="438380763"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438380763" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438380763">(May 13 2024 at 14:45)</a>:</h4>
<p>Is overcommit on the aarch64/riscv64 systems turned off perhaps?</p>



<a name="438381811"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438381811" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438381811">(May 13 2024 at 14:49)</a>:</h4>
<p>The default overcommit heuristic isn't really documented either: <a href="https://www.kernel.org/doc/html/v5.1/vm/overcommit-accounting.html">https://www.kernel.org/doc/html/v5.1/vm/overcommit-accounting.html</a></p>
<blockquote>
<p>It ensures a seriously wild allocation fails</p>
</blockquote>



<a name="438382200"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438382200" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438382200">(May 13 2024 at 14:51)</a>:</h4>
<p><code>sysctl vm.overcommit_memory=1</code> might fix it but seems like a oversized hammer</p>



<a name="438382674"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438382674" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mats Brorsson <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438382674">(May 13 2024 at 14:53)</a>:</h4>
<p><code>sysctl vm.overcommit_memory</code> shows 0 in all the machines I am working on. Also on the x86_64-machine where this works.<br>
But I will try setting it to 1. It didn't alter the behaviour.</p>



<a name="438414729"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438414729" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mats Brorsson <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438414729">(May 13 2024 at 17:37)</a>:</h4>
<p>But what is the reason for allocating 6000 GB address space?</p>



<a name="438415024"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438415024" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438415024">(May 13 2024 at 17:39)</a>:</h4>
<p>Oh if overcommit_memory doesn't work then I'm not sure what's going on in the kernels here. </p>
<p>If you're doing <code>wasmtime serve</code>, can you try passing <code>-O pooling-allocator=n</code> and see if that works? The 6T address space reservation is the default settings of the pooling allocator. It's not actually allocating that much memory, it's just allocating that much virtual memory</p>



<a name="438415367"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438415367" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438415367">(May 13 2024 at 17:41)</a>:</h4>
<blockquote>
<p><code>-O pooling-allocator=n</code></p>
</blockquote>
<p>Only works on recent <code>main</code> right?</p>



<a name="438415448"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438415448" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mats Brorsson <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438415448">(May 13 2024 at 17:42)</a>:</h4>
<p>That works <span class="user-mention" data-user-id="253994">@Alex Crichton</span> !</p>



<a name="438415524"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438415524" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mats Brorsson <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438415524">(May 13 2024 at 17:42)</a>:</h4>
<p>I am on version 21.0</p>



<a name="438415529"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438415529" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438415529">(May 13 2024 at 17:42)</a>:</h4>
<p><span class="user-mention" data-user-id="480579">@Lann Martin</span> configuring the options without <code>-O pooling-allocator[=y/n]</code> only works on <code>main</code>, but disabling it or passing the <code>-O pooling-allocator</code> option explicitly should work</p>



<a name="438415631"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438415631" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438415631">(May 13 2024 at 17:43)</a>:</h4>
<p><span class="user-mention" data-user-id="506554">@Mats Brorsson</span> are you able to share how you installed the aarch64/riscv64 versions of Linux? Are they stock versions of an OS for example? I'd be curious to try to dig in more why this isn't working on those platforms</p>



<a name="438415977"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438415977" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mats Brorsson <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438415977">(May 13 2024 at 17:45)</a>:</h4>
<p>For the aarch64 I used nvidias image for the Jetson nano which is now very old. It comes from this site: <a href="https://developer.nvidia.com/embedded/learn/get-started-jetson-nano-devkit#write">https://developer.nvidia.com/embedded/learn/get-started-jetson-nano-devkit#write</a></p>
<p>For riscv64, I got the image directly from this page: <a href="https://ubuntu.com/download/risc-v">https://ubuntu.com/download/risc-v</a> (select VisionFive 2)</p>
<div class="message_embed"><a class="message_embed_image" href="https://developer.nvidia.com/embedded/learn/get-started-jetson-nano-devkit#write" style="background-image: url(&quot;https://uploads.zulipusercontent.net/e315420bb87d12e187705613061a7446422685b1/68747470733a2f2f64323967346732647971763434332e636c6f756466726f6e742e6e65742f73697465732f64656661756c742f66696c65732f616b616d61692f656d6265646465642f696d616765732f6a6574736f6e2d646576656c6f7065722d6b69742d383530783438302e6a7067&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://developer.nvidia.com/embedded/learn/get-started-jetson-nano-devkit#write" title="Get Started With Jetson Nano Developer Kit">Get Started With Jetson Nano Developer Kit</a></div><div class="message_embed_description">Build practical AI applications, AI robots, and more.</div></div></div>



<a name="438416320"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438416320" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mats Brorsson <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438416320">(May 13 2024 at 17:47)</a>:</h4>
<p>Is there a way to control the allocator used when wasmtime is used as a library, from, e.g. environment variables?</p>
<p>BTW: where are wasmtime's cli options documented? They are not here: <a href="https://docs.wasmtime.dev/cli-options.html">https://docs.wasmtime.dev/cli-options.html</a></p>



<a name="438416545"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438416545" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438416545">(May 13 2024 at 17:48)</a>:</h4>
<p><code>wasmtime -O help</code></p>



<a name="438416562"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438416562" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438416562">(May 13 2024 at 17:48)</a>:</h4>
<p>Currently there's not an env var for this, no, but it can be programmatically controlled if you're working with an embedding (<code>Config::allocation_strategy</code>).</p>
<p>For the CLI options they're currently only documented through the CLI itself as Lann said</p>



<a name="438416827"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438416827" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438416827">(May 13 2024 at 17:50)</a>:</h4>
<p>If you're able, can you try running <code>-O pooling-allocator-y -O pooling-total-memories=N</code> with a few versions of N?</p>



<a name="438416843"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438416843" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438416843">(May 13 2024 at 17:50)</a>:</h4>
<p>I'm curious what fails and what doesn't</p>



<a name="438416893"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438416893" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438416893">(May 13 2024 at 17:50)</a>:</h4>
<p>the default is 1000 which is the 6T reservation, but I'm curious if, for example, 100 works or even 10</p>



<a name="438417614"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438417614" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mats Brorsson <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438417614">(May 13 2024 at 17:54)</a>:</h4>
<p>It works for N up to 56 but fails at 57</p>



<a name="438417767"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438417767" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438417767">(May 13 2024 at 17:55)</a>:</h4>
<p>ah yes the well-known 360GB limit <span aria-label="neutral" class="emoji emoji-1f610" role="img" title="neutral">:neutral:</span></p>



<a name="438417776"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438417776" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mats Brorsson <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438417776">(May 13 2024 at 17:55)</a>:</h4>
<p>I do not have access to my RISCV-board from home (forgot its IP-address :-) so this is for the Jetson nano board</p>



<a name="438417880"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438417880" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438417880">(May 13 2024 at 17:56)</a>:</h4>
<p>interesting, thanks for testing!</p>



<a name="438418334"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438418334" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438418334">(May 13 2024 at 17:58)</a>:</h4>
<p>there is apparently a 39-bit virtual address configuration for aarch64</p>



<a name="438425277"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438425277" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mats Brorsson <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438425277">(May 13 2024 at 18:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="480579">Lann Martin</span> <a href="#narrow/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64/near/438418334">said</a>:</p>
<blockquote>
<p>there is apparently a 39-bit virtual address configuration for aarch64</p>
</blockquote>
<p>Indeed, and for RISCV64 it seems to be 48 or 39 bits. <a href="https://www.kernel.org/doc/html/v6.4/riscv/vm-layout.html">https://www.kernel.org/doc/html/v6.4/riscv/vm-layout.html</a></p>
<p>Is there a way to programmatically find this out?</p>
<p>Also, what can happen if I do not use the  pooling-allocator? Is it a performance or a correctness issue?</p>



<a name="438425584"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438425584" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438425584">(May 13 2024 at 18:45)</a>:</h4>
<p>Pooling allocator vs. not is purely a performance question: every feature is supported with the "on-demand" allocator as well</p>



<a name="438426733"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438426733" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mats Brorsson <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438426733">(May 13 2024 at 18:52)</a>:</h4>
<p>Maybe this from <code>/proc/meminfo</code>:<br>
Aarch64: VmallocTotal:   263061440 kB<br>
x86_64: VmallocTotal:   34359738367 kB</p>



<a name="438429588"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438429588" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438429588">(May 13 2024 at 19:09)</a>:</h4>
<p>Hmm well I'm not sure exactly how that relates to the 360GB limit you found in practice, but I guess its...<em>suspiciously close</em>?</p>



<a name="438432835"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438432835" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438432835">(May 13 2024 at 19:30)</a>:</h4>
<p>Try: <code>grep 'address sizes' /proc/cpuinfo | uniq</code></p>



<a name="438445599"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438445599" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438445599">(May 13 2024 at 20:50)</a>:</h4>
<p><span class="user-mention" data-user-id="506554">@Mats Brorsson</span> would you be able to confirm that <a href="https://github.com/bytecodealliance/wasmtime/pull/8610">https://github.com/bytecodealliance/wasmtime/pull/8610</a> works on the systems that <code>wasmtime serve</code> doesn't currently work on?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/8610" style="background-image: url(&quot;https://uploads.zulipusercontent.net/523d20d18f0b4431979f2480f1529e3c96a2bb2b/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f343436333939373530353864376230616135306636383463383131353034386531666231376435643661393437373265313033393764393238383363386130342f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f38363130&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/8610" title="Dynamically determine whether to pool for `wasmtime serve` by alexcrichton · Pull Request #8610 · bytecodealliance/wasmtime">Dynamically determine whether to pool for `wasmtime serve` by alexcrichton · Pull Request #8610 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">This commit aims to address #8607 by dynamically determining whether the pooling allocator should be used rather than unconditionally using it. It looks like some systems don't have enough virtual ...</div></div></div>



<a name="438445618"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438445618" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438445618">(May 13 2024 at 20:50)</a>:</h4>
<p>I'd like to double-check before merging that to confirm</p>



<a name="438500373"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438500373" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mats Brorsson <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438500373">(May 14 2024 at 04:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="480579">Lann Martin</span> <a href="#narrow/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64/near/438432835">said</a>:</p>
<blockquote>
<p>Try: <code>grep 'address sizes' /proc/cpuinfo | uniq</code></p>
</blockquote>
<p>That doesn't work universally. For instance on my aarch64-board, it only shows this for each processor:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">processor</span><span class="w">       </span>: <span class="mi">0</span>
<span class="n">model</span><span class="w"> </span><span class="n">name</span><span class="w">      </span>: <span class="nc">ARMv8</span><span class="w"> </span><span class="n">Processor</span><span class="w"> </span><span class="n">rev</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">v8l</span><span class="p">)</span>
<span class="n">BogoMIPS</span><span class="w">        </span>: <span class="mf">38.40</span>
<span class="n">Features</span><span class="w">        </span>: <span class="nc">fp</span><span class="w"> </span><span class="n">asimd</span><span class="w"> </span><span class="n">evtstrm</span><span class="w"> </span><span class="n">aes</span><span class="w"> </span><span class="n">pmull</span><span class="w"> </span><span class="n">sha1</span><span class="w"> </span><span class="n">sha2</span><span class="w"> </span><span class="n">crc32</span>
<span class="n">CPU</span><span class="w"> </span><span class="n">implementer</span><span class="w"> </span>: <span class="mh">0x41</span>
<span class="n">CPU</span><span class="w"> </span><span class="n">architecture</span>: <span class="mi">8</span>
<span class="n">CPU</span><span class="w"> </span><span class="n">variant</span><span class="w">     </span>: <span class="mh">0x1</span>
<span class="n">CPU</span><span class="w"> </span><span class="n">part</span><span class="w">        </span>: <span class="mh">0xd07</span>
<span class="n">CPU</span><span class="w"> </span><span class="n">revision</span><span class="w">    </span>: <span class="mi">1</span>
</code></pre></div>



<a name="438574422"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438574422" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mats Brorsson <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438574422">(May 14 2024 at 13:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="253994">Alex Crichton</span> <a href="#narrow/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64/near/438445599">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="506554">Mats Brorsson</span> would you be able to confirm that <a href="https://github.com/bytecodealliance/wasmtime/pull/8610">https://github.com/bytecodealliance/wasmtime/pull/8610</a> works on the systems that <code>wasmtime serve</code> doesn't currently work on?</p>
</blockquote>
<p>I can confirm that this fix works on both the Aarch64 board and the RISCV64 board that I use. However, I will try to see how spin (and the spin shim for containerd) uses the library to see if a similar fix can be introduced there.</p>



<a name="438574937"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438574937" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438574937">(May 14 2024 at 13:20)</a>:</h4>
<p>Thanks! That ought to fix <a href="https://github.com/fermyon/spin/issues/2343">https://github.com/fermyon/spin/issues/2343</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/fermyon/spin/issues/2343" style="background-image: url(&quot;https://uploads.zulipusercontent.net/90e6b94bee9fd7d53647fffa1f1b7d8c12022a81/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f643536646432336236613465306531353261653662633461306535613062373865363932623333353933303037326534326536646131323139666331326334362f6665726d796f6e2f7370696e2f6973737565732f32333433&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/fermyon/spin/issues/2343" title="Disable pooling allocator automatically in environments where it will fail · Issue #2343 · fermyon/spin">Disable pooling allocator automatically in environments where it will fail · Issue #2343 · fermyon/spin</a></div><div class="message_embed_description">There are (at least) two environments where the Wasmtime pooling allocator is known to fail with Spin's default settings: QEMU: #1785 Systems with &lt;2GB (?) RAM: #2119 Under spin up we should try to...</div></div></div>



<a name="438575181"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438575181" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438575181">(May 14 2024 at 13:20)</a>:</h4>
<p>I wasn't sure what "some operation known to fail with pooling" before, but it seems like that PR does the trick</p>



<a name="438575499"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438575499" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mats Brorsson <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438575499">(May 14 2024 at 13:22)</a>:</h4>
<p>However, I am not sure that when the serve option of wasmtime is used from the library instead of the cli goes through this same code?</p>



<a name="438575640"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438575640" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438575640">(May 14 2024 at 13:22)</a>:</h4>
<p><code>wasmtime serve</code> is not a library feature; Spin is an entirely separate implementation of the same basic idea</p>



<a name="438575909"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438575909" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mats Brorsson <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438575909">(May 14 2024 at 13:23)</a>:</h4>
<p>ok, but I get the same error with the 6T memory allocation in wasmtime so the fix may need to be somewhere else then, or in an additional place.</p>



<a name="438576382"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438576382" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438576382">(May 14 2024 at 13:26)</a>:</h4>
<p>Ah, yes, the PR above only fixes <code>wasmtime serve</code>. It would be possible to add "should this host use pooling" auto-detection to the wasmtime lib, but that may be a bit more "opinionated" than the lib usually is.</p>



<a name="438577092"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory_pool%20issue%20on%20arch64%20and%20riscv64/near/438577092" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory_pool.20issue.20on.20arch64.20and.20riscv64.html#438577092">(May 14 2024 at 13:28)</a>:</h4>
<p>It would probably be worth at least a note somewhere in the <a href="https://docs.rs/wasmtime/20.0.2/wasmtime/struct.PoolingAllocationConfig.html">pooling docs</a></p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>