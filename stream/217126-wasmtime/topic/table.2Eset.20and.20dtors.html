<html>
<head><meta charset="utf-8"><title>table.set and dtors · wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/index.html">wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html">table.set and dtors</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="202023682"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202023682" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202023682">(Jun 25 2020 at 20:55)</a>:</h4>
<p><span class="user-mention" data-user-id="253990">@fitzgen (he/him)</span> hm I'm not entirely sure what you mean by RefCell and deferred destruction?</p>



<a name="202023726"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202023726" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202023726">(Jun 25 2020 at 20:55)</a>:</h4>
<p><code>TableElements</code> has a <code>RefCell&lt;Vec&lt;VMExternRef&gt;&gt;</code></p>



<a name="202023830"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202023830" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202023830">(Jun 25 2020 at 20:56)</a>:</h4>
<p>and deferred destruction would be just saving all the <code>ref_count == 0</code> references in a side table, and running their dtors at a known-safe point in time</p>



<a name="202023874"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202023874" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202023874">(Jun 25 2020 at 20:56)</a>:</h4>
<p>I like your (more obvious) idea of just swapping it out of the table first. don't know why I didn't think of that &gt;.&lt;</p>



<a name="202023913"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202023913" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202023913">(Jun 25 2020 at 20:56)</a>:</h4>
<p>although it is one more basic block. I don't think thats a big deal tho</p>



<a name="202023914"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202023914" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202023914">(Jun 25 2020 at 20:56)</a>:</h4>
<p>ah ok</p>



<a name="202023934"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202023934" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202023934">(Jun 25 2020 at 20:57)</a>:</h4>
<p>to be clear, this is what I'm thinking -- <a href="https://gist.github.com/alexcrichton/fe9a5aff25cdcf943234f433babbb55e">https://gist.github.com/alexcrichton/fe9a5aff25cdcf943234f433babbb55e</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://gist.github.com/alexcrichton/fe9a5aff25cdcf943234f433babbb55e" style="background-image: url(https://github.githubassets.com/images/modules/gists/gist-og-image.png)"></a><div class="data-container"><div class="message_embed_title"><a href="https://gist.github.com/alexcrichton/fe9a5aff25cdcf943234f433babbb55e" title="foo.diff">foo.diff</a></div><div class="message_embed_description">GitHub Gist: instantly share code, notes, and snippets.</div></div></div>



<a name="202023940"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202023940" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202023940">(Jun 25 2020 at 20:57)</a>:</h4>
<p>using your pseudocode</p>



<a name="202023962"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202023962" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202023962">(Jun 25 2020 at 20:57)</a>:</h4>
<p>if that makes sense</p>



<a name="202023980"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202023980" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202023980">(Jun 25 2020 at 20:57)</a>:</h4>
<p>so we shouldn't need deferred destruction or need to worry about ref cells and such</p>



<a name="202023998"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202023998" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202023998">(Jun 25 2020 at 20:57)</a>:</h4>
<p>ah nice, yeah that doesn't need a new basic block either</p>



<a name="202024023"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202024023" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202024023">(Jun 25 2020 at 20:57)</a>:</h4>
<p>also, out of curiosity, does cranelift still do the ebb thing?</p>



<a name="202024055"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202024055" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202024055">(Jun 25 2020 at 20:58)</a>:</h4>
<p>where you can have multiple exits from a block?</p>



<a name="202024079"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202024079" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202024079">(Jun 25 2020 at 20:58)</a>:</h4>
<p>not anymore</p>



<a name="202024080"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202024080" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202024080">(Jun 25 2020 at 20:58)</a>:</h4>
<p>b/c that could simplify the blocks in a few places I think</p>



<a name="202024088"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202024088" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202024088">(Jun 25 2020 at 20:58)</a>:</h4>
<p>ah ok, that makes more sense</p>



<a name="202024161"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202024161" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202024161">(Jun 25 2020 at 20:59)</a>:</h4>
<p>fwiw, I was adding <code>fallthrough</code>s manually, instead of <code>jump</code>s, but</p>
<ol>
<li>sometimes blocks get shuffled around, and these would break</li>
<li>there is eventually a pass that turns <code>jump</code>s to the next block into a <code>fallthrough</code>, and it works well</li>
</ol>



<a name="202024224"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202024224" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202024224">(Jun 25 2020 at 20:59)</a>:</h4>
<p>so I think we don't need to worry much about "lots of little blocks with many jumps between them" as long as we insert them into the layout in the right order</p>



<a name="202024400"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202024400" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202024400">(Jun 25 2020 at 21:01)</a>:</h4>
<p>makes sense</p>



<a name="202024414"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202024414" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202024414">(Jun 25 2020 at 21:01)</a>:</h4>
<p>I should learn more about what optimizations cranelift does</p>



<a name="202024458"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202024458" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202024458">(Jun 25 2020 at 21:01)</a>:</h4>
<p><span class="user-mention" data-user-id="253990">@fitzgen (he/him)</span> so the frob-the-refcount, does that turn into one <code>add</code> instruction on x86 with addressing modes?</p>



<a name="202024472"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202024472" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202024472">(Jun 25 2020 at 21:01)</a>:</h4>
<p>is that an optimization that cranelift does?</p>



<a name="202024549"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202024549" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202024549">(Jun 25 2020 at 21:02)</a>:</h4>
<p>it <em>should</em> be, but I'm not sure it does</p>



<a name="202024565"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202024565" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202024565">(Jun 25 2020 at 21:02)</a>:</h4>
<p>ah ok, wasn't sure if we needed to represent that in IR or not</p>



<a name="202024585"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202024585" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202024585">(Jun 25 2020 at 21:02)</a>:</h4>
<p>I should dig in at some point in the future, just not now lol</p>



<a name="202024707"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202024707" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202024707">(Jun 25 2020 at 21:04)</a>:</h4>
<p><span class="user-mention" data-user-id="253990">@fitzgen (he/him)</span> so here's another question, I don't know how stackmaps work, so I'm unsure. So the gist I sent, what happens if the dtor calls <code>Store::gc</code>?</p>



<a name="202024760"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202024760" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202024760">(Jun 25 2020 at 21:04)</a>:</h4>
<p>we loaded the pointer to drop from the table</p>



<a name="202024764"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202024764" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202024764">(Jun 25 2020 at 21:04)</a>:</h4>
<p>which presumably has the r64 type</p>



<a name="202024777"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202024777" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202024777">(Jun 25 2020 at 21:04)</a>:</h4>
<p>but we're dropping it so it shouldn't be traced</p>



<a name="202024785"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202024785" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202024785">(Jun 25 2020 at 21:04)</a>:</h4>
<p>even though it's "live" as a function argument</p>



<a name="202024820"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202024820" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202024820">(Jun 25 2020 at 21:04)</a>:</h4>
<p>because it's a function argument does that mean it's not included in the stack map?</p>



<a name="202024980"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202024980" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202024980">(Jun 25 2020 at 21:06)</a>:</h4>
<p>with the modified barrier pseudocode?</p>



<a name="202025024"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202025024" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202025024">(Jun 25 2020 at 21:06)</a>:</h4>
<p>yeah</p>



<a name="202025039"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202025039" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202025039">(Jun 25 2020 at 21:06)</a>:</h4>
<p>so like if cranelift sees <code>function_call(some_r64_type)</code></p>



<a name="202025054"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202025054" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202025054">(Jun 25 2020 at 21:07)</a>:</h4>
<p>does the stack map at that function call include <code>some_r64_type</code>?</p>



<a name="202025117"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202025117" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202025117">(Jun 25 2020 at 21:07)</a>:</h4>
<p>it would, yes</p>



<a name="202025191"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202025191" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202025191">(Jun 25 2020 at 21:08)</a>:</h4>
<p>hm that may also be problematic</p>



<a name="202025207"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202025207" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202025207">(Jun 25 2020 at 21:08)</a>:</h4>
<p>this may mean we have to do deffered destruction</p>



<a name="202025213"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202025213" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202025213">(Jun 25 2020 at 21:08)</a>:</h4>
<p>and means we'll need to cast to i64 to call the drop intrinsic I think?</p>



<a name="202025233"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202025233" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202025233">(Jun 25 2020 at 21:08)</a>:</h4>
<p>or could we load the pointer as i64 instead?</p>



<a name="202025264"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202025264" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202025264">(Jun 25 2020 at 21:08)</a>:</h4>
<p>perhaps</p>



<a name="202025275"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202025275" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202025275">(Jun 25 2020 at 21:08)</a>:</h4>
<p>this may also be an issue for table.get where we're manually frobbing the reference count</p>



<a name="202025350"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202025350" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202025350">(Jun 25 2020 at 21:09)</a>:</h4>
<p>not sure I follow</p>



<a name="202025453"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202025453" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202025453">(Jun 25 2020 at 21:10)</a>:</h4>
<p>I sort of forget how the reference counts work out during gc</p>



<a name="202025467"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202025467" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202025467">(Jun 25 2020 at 21:10)</a>:</h4>
<p>er wait</p>



<a name="202025470"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202025470" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202025470">(Jun 25 2020 at 21:10)</a>:</h4>
<p>nevermind</p>



<a name="202025478"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202025478" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202025478">(Jun 25 2020 at 21:10)</a>:</h4>
<p>I'm worried about <code>call activations_table_insert_with_gc(elem)</code> but that's guaranteed to not call user code</p>



<a name="202025503"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202025503" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202025503">(Jun 25 2020 at 21:11)</a>:</h4>
<p>so we're ok there, it's just <code>call drop_externref_in_place(current_elem)</code> I'm worried about in terms of stack maps</p>



<a name="202025535"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202025535" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202025535">(Jun 25 2020 at 21:11)</a>:</h4>
<p>er, no, scratch that too, <code>activations_table_insert_with_gc</code> will do a GC</p>



<a name="202025610"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202025610" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202025610">(Jun 25 2020 at 21:12)</a>:</h4>
<p>it's at least something to consider, what happens when we gc during that call and we insert it from the stack plus manually</p>



<a name="202025634"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202025634" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202025634">(Jun 25 2020 at 21:12)</a>:</h4>
<p>and same thing for the drop, what happens if we gc while dropping, making sure we don't accidentally try to keep it in the activations table</p>



<a name="202025694"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202025694" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202025694">(Jun 25 2020 at 21:13)</a>:</h4>
<p>we should be fine with <code>activations_table_insert_with_gc</code>, since both the reference will be in the stack maps, and the first thing we do is in the impl is <code>VMExternRef::clone_from_raw</code></p>



<a name="202025718"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202025718" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202025718">(Jun 25 2020 at 21:13)</a>:</h4>
<p>but yeah, asking these questions is great, and has already found a few bugs (thanks!)</p>



<a name="202025745"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202025745" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202025745">(Jun 25 2020 at 21:13)</a>:</h4>
<p>the wonders of code review :P</p>



<a name="202025847"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202025847" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202025847">(Jun 25 2020 at 21:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="253994">Alex Crichton</span> <a href="#narrow/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors/near/202024458">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="253990">fitzgen (he/him)</span> so the frob-the-refcount, does that turn into one <code>add</code> instruction on x86 with addressing modes?</p>
</blockquote>
<p>on x86 we would want to turn this into an <code>xadd</code> right?</p>
<p>I don't see any mention of <code>xadd</code> in the codebase</p>



<a name="202025873"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202025873" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202025873">(Jun 25 2020 at 21:14)</a>:</h4>
<p><code>xadd</code> I thought was <code>atomic_add</code></p>



<a name="202025883"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202025883" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202025883">(Jun 25 2020 at 21:14)</a>:</h4>
<p>and I don't remember it from when I ported <code>simple_preopt</code> to <code>peepmatic</code></p>



<a name="202025903"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202025903" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202025903">(Jun 25 2020 at 21:15)</a>:</h4>
<p>its atomic if it is prefixed with <code>lock</code></p>



<a name="202025917"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202025917" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202025917">(Jun 25 2020 at 21:15)</a>:</h4>
<p>I'm thinking of <code>   addl    $1, (%rdi)</code></p>



<a name="202025928"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202025928" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202025928">(Jun 25 2020 at 21:15)</a>:</h4>
<p><a href="https://play.rust-lang.org/?version=stable&amp;mode=release&amp;edition=2018&amp;gist=e8f2c6373f89f7cf087e973544b598f3">https://play.rust-lang.org/?version=stable&amp;mode=release&amp;edition=2018&amp;gist=e8f2c6373f89f7cf087e973544b598f3</a></p>



<a name="202026036"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202026036" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202026036">(Jun 25 2020 at 21:16)</a>:</h4>
<p>hmm....</p>



<a name="202026325"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202026325" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202026325">(Jun 25 2020 at 21:18)</a>:</h4>
<p>I think you're right about <code>activations_table_insert_with_gc</code> as well, that'll <code>clone_from_raw</code> the pointer it reads from the stack and shove it in a set. The intrinsic also <code>clone_from_raw</code>s, however, and since the ownership is in the original table anyway I think that all works out just fine</p>



<a name="202026559"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202026559" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202026559">(Jun 25 2020 at 21:21)</a>:</h4>
<p>&lt;removed&gt;</p>



<a name="202026596"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202026596" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202026596">(Jun 25 2020 at 21:21)</a>:</h4>
<p>wait I forgot to enable opts</p>



<a name="202026645"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202026645" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202026645">(Jun 25 2020 at 21:21)</a>:</h4>
<div class="codehilite"><pre><span></span><code>$ cat ~/scratch/add.clif; cargo run --manifest-path cranelift/Cargo.toml -- compile --target x86_64 -dp ~/scratch/add.clif -D --set opt_level=speed
function %add(i64) {
    block0(v0: i64):
        v1 = load.i32 aligned notrap v0
        v2 = iadd_imm v1, 1
        store aligned notrap v2, v1
        return
}
    Finished dev [unoptimized + debuginfo] target(s) in 0.08s
     Running `target/debug/clif-util compile --target x86_64 -dp /home/fitzgen/scratch/add.clif -D --set opt_level=speed`
function %add(i64 [%rdi], i64 fp [%rbp]) -&gt; i64 fp [%rbp] fast {
    ss0 = incoming_arg 16, offset -16

                                block0(v0: i64 [%rdi], v4: i64 [%rbp]):
[RexOp1pushq#50]                    x86_push v4
[RexOp1copysp#8089]                 copy_special %rsp -&gt; %rbp
[RexOp1ld#8b,%rax]                  v1 = load.i32 notrap aligned v0
[DynRexOp1umr#89,%rcx]              v3 = copy v1
[DynRexOp1r_ib#83,%rcx]             v2 = iadd_imm v3, 1
[RexOp1st#89]                       store notrap aligned v2, v1
[RexOp1popq#58,%rbp]                v5 = x86_pop.i64
[Op1ret#c3]                         return v5
}

.byte 64, 85, 72, 137, 229, 64, 139, 7, 137, 193, 131, 193, 1, 64, 137, 8, 64, 93, 195

Disassembly of 19 bytes:
   0:   40 55                   push    rbp
   2:   48 89 e5                mov rbp, rsp
   5:   40 8b 07                mov eax, dword ptr [rdi]
   8:   89 c1                   mov ecx, eax
   a:   83 c1 01                add ecx, 1
   d:   40 89 08                mov dword ptr [rax], ecx
  10:   40 5d                   pop rbp
  12:   c3                      ret


trap: stk_ovf at 0
</code></pre></div>



<a name="202026741"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202026741" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202026741">(Jun 25 2020 at 21:22)</a>:</h4>
<p><span class="user-mention" data-user-id="253994">@Alex Crichton</span> looks like cranelift can't do it</p>



<a name="202026827"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202026827" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202026827">(Jun 25 2020 at 21:23)</a>:</h4>
<p>aww :(</p>



<a name="202026855"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202026855" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202026855">(Jun 25 2020 at 21:23)</a>:</h4>
<p>it'd be neat if we could easily look at the asm for wasm modules too at some point</p>



<a name="202027417"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202027417" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202027417">(Jun 25 2020 at 21:28)</a>:</h4>
<p>filed <a href="https://github.com/bytecodealliance/wasmtime/issues/1925">https://github.com/bytecodealliance/wasmtime/issues/1925</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/issues/1925" style="background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/issues/1925" title="Collapse `load; add; store` into a single `add` on x86-64 · Issue #1925 · bytecodealliance/wasmtime">Collapse `load; add; store` into a single `add` on x86-64 · Issue #1925 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">Right now, this function %add(i64) { block0(v0: i64): v1 = load.i32 aligned notrap v0 v2 = iadd_imm v1, 1 store aligned notrap v2, v1 return } compiles down into Disassembly of 19 bytes: 0: 40 55 p...</div></div></div>



<a name="202034071"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202034071" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202034071">(Jun 25 2020 at 22:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="253994">Alex Crichton</span> <a href="#narrow/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors/near/202026855">said</a>:</p>
<blockquote>
<p>it'd be neat if we could easily look at the asm for wasm modules too at some point</p>
</blockquote>
<p>Will <code>wasmtime wasm2obj ..</code> + <code>objdump -d ...</code> work?</p>



<a name="202094236"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202094236" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202094236">(Jun 26 2020 at 14:03)</a>:</h4>
<p><span class="user-mention" data-user-id="253991">@Yury Delendik</span> I haven't used that too too much but it probably works just fine, that's a good poitn!</p>



<a name="202094500"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202094500" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202094500">(Jun 26 2020 at 14:05)</a>:</h4>
<p>I'm trying to move compiler to emit ELF image directly, that's will improve wasm2obj further. (I'm using objdump regularly)</p>



<a name="202095427"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202095427" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202095427">(Jun 26 2020 at 14:12)</a>:</h4>
<p>oh nice</p>



<a name="202110234"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202110234" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202110234">(Jun 26 2020 at 16:10)</a>:</h4>
<p>FWIW, <code>RUST_LOG=debug</code> dumps a bunch of cranelift ir too, but not the final disassembly</p>



<a name="202691771"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202691771" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202691771">(Jul 02 2020 at 13:59)</a>:</h4>
<p><span class="user-mention" data-user-id="253990">@fitzgen (he/him)</span> I think the fuzz corpus may need to be updated for the new tables ops fuzz test? -- <a href="https://oss-fuzz-build-logs.storage.googleapis.com/log-5a0b58fe-4a35-46d5-b4d2-221905e7d208.txt">https://oss-fuzz-build-logs.storage.googleapis.com/log-5a0b58fe-4a35-46d5-b4d2-221905e7d208.txt</a></p>



<a name="202708985"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202708985" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202708985">(Jul 02 2020 at 16:06)</a>:</h4>
<p>we should fix the build to not require a corpus ahead of time, and just make an empty one if necessary; I'll make a PR</p>



<a name="202709933"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/table.set%20and%20dtors/near/202709933" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/table.2Eset.20and.20dtors.html#202709933">(Jul 02 2020 at 16:15)</a>:</h4>
<p><a href="https://github.com/google/oss-fuzz/pull/4065">https://github.com/google/oss-fuzz/pull/4065</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/google/oss-fuzz/pull/4065" style="background-image: url(https://avatars0.githubusercontent.com/u/1342004?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/google/oss-fuzz/pull/4065" title="wasmtime: Create an empty corpus for newly-defined fuzz targets by fitzgen · Pull Request #4065 · google/oss-fuzz">wasmtime: Create an empty corpus for newly-defined fuzz targets by fitzgen · Pull Request #4065 · google/oss-fuzz</a></div><div class="message_embed_description">This will prevent build failures like
https://oss-fuzz-build-logs.storage.googleapis.com/log-5a0b58fe-4a35-46d5-b4d2-221905e7d208.txt
in the future.</div></div></div>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>