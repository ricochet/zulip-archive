<html>
<head><meta charset="utf-8"><title>verify BTI bits in binary · wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/index.html">wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html">verify BTI bits in binary</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="287209760"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/verify%20BTI%20bits%20in%20binary/near/287209760" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html#287209760">(Jun 23 2022 at 15:50)</a>:</h4>
<p><span class="user-mention" data-user-id="300050">@Anton Kirilov</span> I'm in the process of trying to move our <code>aarch64.S</code> file to a <code>global_asm!</code> block in Rust to avoid the need for an external asssembler, and I wanted to see at the same time if we could drop some bits and pieces from the file in case LLVM provides them by default. The appending to <code>.note.gnu.property</code> you recently added I'm not sure if LLVM handles or not. Is there a CLI command I can verify that the final binary has "BIT bits enabled"? I'd like to see if I drop the block what the difference in the final binary is</p>



<a name="287228644"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/verify%20BTI%20bits%20in%20binary/near/287228644" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html#287228644">(Jun 23 2022 at 18:14)</a>:</h4>
<p>apologies for the extra ping but I left a comment here as well -- <a href="https://github.com/bytecodealliance/wasmtime/pull/4306#discussion_r905321213">https://github.com/bytecodealliance/wasmtime/pull/4306#discussion_r905321213</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/4306#discussion_r905321213" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/ffe3faba2fcae2c0db1a445bdd91dbf148011f14\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f383034343233636462666664626336303730363563356334323263333639333538383261373238373432393834633430323239316664393135346632333263612f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f34333036)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/4306#discussion_r905321213" title="Use `global_asm!` instead of external assembly files by alexcrichton · Pull Request #4306 · bytecodealliance/wasmtime">Use `global_asm!` instead of external assembly files by alexcrichton · Pull Request #4306 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">This commit moves the external assembly files of the wasmtime-fiber
crate into global_asm! blocks defined in Rust. The motivation for
doing this is not very strong at this time, but the points in f...</div></div></div>



<a name="287229013"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/verify%20BTI%20bits%20in%20binary/near/287229013" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton Kirilov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html#287229013">(Jun 23 2022 at 18:17)</a>:</h4>
<p>I was just about to answer <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span>.</p>



<a name="287229198"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/verify%20BTI%20bits%20in%20binary/near/287229198" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton Kirilov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html#287229198">(Jun 23 2022 at 18:19)</a>:</h4>
<p>I think that <code>readelf -n</code> should answer your question.</p>



<a name="287229315"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/verify%20BTI%20bits%20in%20binary/near/287229315" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton Kirilov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html#287229315">(Jun 23 2022 at 18:20)</a>:</h4>
<p>However, note that with respect to (static) linking BTI support is an all-or-nothing affair.</p>



<a name="287229525"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/verify%20BTI%20bits%20in%20binary/near/287229525" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html#287229525">(Jun 23 2022 at 18:21)</a>:</h4>
<p>ah ok so on <code>main</code> if I <code>cargo test -p wasmtime-fiber</code> which forces inclusion of the aarch64 bits the resulting binary shows:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">readelf</span><span class="w"> </span><span class="o">-</span><span class="n">n</span><span class="w"> </span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">deps</span><span class="o">/</span><span class="n">wasmtime_fiber</span><span class="o">-</span><span class="mi">0</span><span class="n">da0f8ddb3bb19e6</span><span class="w"></span>

<span class="n">Displaying</span><span class="w"> </span><span class="n">notes</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="k">in</span>: <span class="p">.</span><span class="n">note</span><span class="p">.</span><span class="n">gnu</span><span class="p">.</span><span class="n">build</span><span class="o">-</span><span class="n">id</span><span class="w"></span>
<span class="w">  </span><span class="n">Owner</span><span class="w">                </span><span class="n">Data</span><span class="w"> </span><span class="n">size</span><span class="w">        </span><span class="n">Description</span><span class="w"></span>
<span class="w">  </span><span class="n">GNU</span><span class="w">                  </span><span class="mh">0x00000014</span><span class="w">       </span><span class="n">NT_GNU_BUILD_ID</span><span class="w"> </span><span class="p">(</span><span class="n">unique</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="n">bitstring</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">Build</span><span class="w"> </span><span class="n">ID</span>: <span class="mi">5</span><span class="n">b8f1f636ce7db50b76cdd2f613d24f9ed007c60</span><span class="w"></span>

<span class="n">Displaying</span><span class="w"> </span><span class="n">notes</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="k">in</span>: <span class="p">.</span><span class="n">note</span><span class="p">.</span><span class="n">ABI</span><span class="o">-</span><span class="n">tag</span><span class="w"></span>
<span class="w">  </span><span class="n">Owner</span><span class="w">                </span><span class="n">Data</span><span class="w"> </span><span class="n">size</span><span class="w">        </span><span class="n">Description</span><span class="w"></span>
<span class="w">  </span><span class="n">GNU</span><span class="w">                  </span><span class="mh">0x00000010</span><span class="w">       </span><span class="n">NT_GNU_ABI_TAG</span><span class="w"> </span><span class="p">(</span><span class="n">ABI</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="n">tag</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">OS</span>: <span class="nc">Linux</span><span class="p">,</span><span class="w"> </span><span class="n">ABI</span>: <span class="mf">3.7.0</span><span class="w"></span>
</code></pre></div>
<p>which I think is missing? But I think that's expected where I didn't build the Rust code with bti support?</p>



<a name="287229597"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/verify%20BTI%20bits%20in%20binary/near/287229597" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton Kirilov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html#287229597">(Jun 23 2022 at 18:22)</a>:</h4>
<p>That is, if at least one of the object files that are linked into the final executable lacks the ELF note, then the linker is not going to annotate the executable (and will print a warning, I believe), thus disabling BTI.</p>



<a name="287229753"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/verify%20BTI%20bits%20in%20binary/near/287229753" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html#287229753">(Jun 23 2022 at 18:23)</a>:</h4>
<p>hm so if I build with <code>RUSTFLAGS='-Zbranch-protection=bti' cargo +nightly test -p wasmtime-fiber</code> it also doesn't have anything other than the above</p>



<a name="287229889"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/verify%20BTI%20bits%20in%20binary/near/287229889" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html#287229889">(Jun 23 2022 at 18:24)</a>:</h4>
<p>ah I think the <code>-Z</code> flag may not work because even an empty <code>main.rs</code> doesn't get anything else</p>



<a name="287229890"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/verify%20BTI%20bits%20in%20binary/near/287229890" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton Kirilov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html#287229890">(Jun 23 2022 at 18:24)</a>:</h4>
<p>Is that the original code or the one in the PR?</p>



<a name="287229914"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/verify%20BTI%20bits%20in%20binary/near/287229914" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html#287229914">(Jun 23 2022 at 18:24)</a>:</h4>
<p>the original code for the test above</p>



<a name="287229988"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/verify%20BTI%20bits%20in%20binary/near/287229988" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton Kirilov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html#287229988">(Jun 23 2022 at 18:25)</a>:</h4>
<p>OK, one more thing - could you try <code>-mmark-bti-property</code>?</p>



<a name="287230095"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/verify%20BTI%20bits%20in%20binary/near/287230095" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html#287230095">(Jun 23 2022 at 18:26)</a>:</h4>
<p>I think that's probably a clang/gcc flag, right? (if so I dunno the rustc equivalent)</p>



<a name="287230099"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/verify%20BTI%20bits%20in%20binary/near/287230099" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton Kirilov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html#287230099">(Jun 23 2022 at 18:26)</a>:</h4>
<p>This flag is supposed to instruct LLVM to add the note to all object files, including the ones generated from assembly code.</p>



<a name="287230152"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/verify%20BTI%20bits%20in%20binary/near/287230152" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html#287230152">(Jun 23 2022 at 18:26)</a>:</h4>
<p>I can confirm the LLVM-generated object files show:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">File</span>: <span class="nc">main</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="mi">84</span><span class="n">aa171d</span><span class="o">-</span><span class="n">cgu</span><span class="p">.</span><span class="mf">6.</span><span class="n">rcgu</span><span class="p">.</span><span class="n">o</span><span class="w"></span>

<span class="n">Displaying</span><span class="w"> </span><span class="n">notes</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="k">in</span>: <span class="p">.</span><span class="n">note</span><span class="p">.</span><span class="n">gnu</span><span class="p">.</span><span class="n">property</span><span class="w"></span>
<span class="w">  </span><span class="n">Owner</span><span class="w">                </span><span class="n">Data</span><span class="w"> </span><span class="n">size</span><span class="w">        </span><span class="n">Description</span><span class="w"></span>
<span class="w">  </span><span class="n">GNU</span><span class="w">                  </span><span class="mh">0x00000010</span><span class="w">       </span><span class="n">NT_GNU_PROPERTY_TYPE_0</span><span class="w"></span>
<span class="w">      </span><span class="n">Properties</span>: <span class="nc">AArch64</span><span class="w"> </span><span class="n">feature</span>: <span class="nc">BTI</span><span class="w"></span>
</code></pre></div>



<a name="287230153"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/verify%20BTI%20bits%20in%20binary/near/287230153" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton Kirilov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html#287230153">(Jun 23 2022 at 18:26)</a>:</h4>
<p>I think it is a LLVM one.</p>



<a name="287230192"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/verify%20BTI%20bits%20in%20binary/near/287230192" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html#287230192">(Jun 23 2022 at 18:27)</a>:</h4>
<p>I suspect that rustc is passing the right flags to LLVM, but there's probably some C dependency in libstd or something which is disabling things by accident</p>



<a name="287230234"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/verify%20BTI%20bits%20in%20binary/near/287230234" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton Kirilov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html#287230234">(Jun 23 2022 at 18:27)</a>:</h4>
<p>Yes, a single object file that lacks the note is going to "contaminate" everything.</p>



<a name="287230282"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/verify%20BTI%20bits%20in%20binary/near/287230282" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton Kirilov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html#287230282">(Jun 23 2022 at 18:28)</a>:</h4>
<p>I believe you are supposed to see a warning from LLVM.</p>



<a name="287230457"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/verify%20BTI%20bits%20in%20binary/near/287230457" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton Kirilov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html#287230457">(Jun 23 2022 at 18:29)</a>:</h4>
<p>BTW:<br>
<span class="user-mention silent" data-user-id="300050">Anton Kirilov</span> <a href="#narrow/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary/near/287230099">said</a>:</p>
<blockquote>
<p>This flag is supposed to instruct LLVM to add the note to all object files, including the ones generated from assembly code.</p>
</blockquote>
<p>This is only going to add the ELF note, though, not the BTI landing pads (i.e. instructions) themselves (critical for assembly files).</p>



<a name="287230493"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/verify%20BTI%20bits%20in%20binary/near/287230493" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html#287230493">(Jun 23 2022 at 18:29)</a>:</h4>
<p>for sure yeah I left in all the actual instructions</p>



<a name="287230733"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/verify%20BTI%20bits%20in%20binary/near/287230733" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton Kirilov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html#287230733">(Jun 23 2022 at 18:31)</a>:</h4>
<p>I can also check with our Rust team (that is, the people who added BTI support to the Rust compiler) tomorrow - it is quite late in the UK right now.</p>



<a name="287230772"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/verify%20BTI%20bits%20in%20binary/near/287230772" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html#287230772">(Jun 23 2022 at 18:31)</a>:</h4>
<p>oh no worries!</p>



<a name="287230791"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/verify%20BTI%20bits%20in%20binary/near/287230791" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html#287230791">(Jun 23 2022 at 18:32)</a>:</h4>
<p>sorry this is not urgent at all</p>



<a name="287231067"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/verify%20BTI%20bits%20in%20binary/near/287231067" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton Kirilov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html#287231067">(Jun 23 2022 at 18:34)</a>:</h4>
<p>No problem!</p>



<a name="287232881"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/verify%20BTI%20bits%20in%20binary/near/287232881" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html#287232881">(Jun 23 2022 at 18:50)</a>:</h4>
<p>Some other things I've tested. First <code>rustc +nightly empty-main.rs -Z branch-protection=bti</code> does not have the bti note, but the reason for this is that it's linked against the standard library which is precompiled and doesn't have bti notes.</p>
<p>Second I tried using <code>cargo</code>'s <code>-Zbuild-std</code> to recompile the standard library. For unknown symbol-related reasons this also required <code>-Ctarget-feature=+lse</code>. The resulting binary still didn't have the bti note.</p>
<p>Next I passed <code> -mmark-bti-property</code> via <code>CFLAGS</code> during the build-std building-the-standard-library step because I know there's C code in the <code>compiler-builtins</code> crate. That still didn't have the bti note in the final binary.</p>
<p>One object file on the command line which doesn't have the note section is <code>/tmp/rustcc7t9zx/symbols.o</code> which I think was a relatively recent addition to rustc (used to force symbols to show up in the final binary if they're even not referenced from other files). All <code>lib.rmeta</code> files in rlibs also don't have the bti note but they also should never be read by the linker.</p>



<a name="287232953"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/verify%20BTI%20bits%20in%20binary/near/287232953" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html#287232953">(Jun 23 2022 at 18:50)</a>:</h4>
<p>Turns out that was all a red herring. I found the <code>-z force-bti</code> option to the linker and if I pass that it helpfully prints:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">acrichto</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ld</span>: <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="mi">8</span><span class="o">/../../../</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">Scrt1</span><span class="p">.</span><span class="n">o</span>: <span class="nc">warning</span>: <span class="nc">BTI</span><span class="w"> </span><span class="n">turned</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">-</span><span class="n">z</span><span class="w"> </span><span class="n">force</span><span class="o">-</span><span class="n">bti</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">inputs</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">BTI</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">NOTE</span><span class="w"> </span><span class="n">section</span><span class="p">.</span><span class="w"></span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">acrichto</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ld</span>: <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="mi">8</span><span class="o">/../../../</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">crti</span><span class="p">.</span><span class="n">o</span>: <span class="nc">warning</span>: <span class="nc">BTI</span><span class="w"> </span><span class="n">turned</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">-</span><span class="n">z</span><span class="w"> </span><span class="n">force</span><span class="o">-</span><span class="n">bti</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">inputs</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">BTI</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">NOTE</span><span class="w"> </span><span class="n">section</span><span class="p">.</span><span class="w"></span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">acrichto</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ld</span>: <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="n">crtbeginS</span><span class="p">.</span><span class="n">o</span>: <span class="nc">warning</span>: <span class="nc">BTI</span><span class="w"> </span><span class="n">turned</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">-</span><span class="n">z</span><span class="w"> </span><span class="n">force</span><span class="o">-</span><span class="n">bti</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">inputs</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">BTI</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">NOTE</span><span class="w"> </span><span class="n">section</span><span class="p">.</span><span class="w"></span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">acrichto</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ld</span>: <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">libc_nonshared</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">elf</span><span class="o">-</span><span class="n">init</span><span class="p">.</span><span class="n">oS</span><span class="p">)</span>: <span class="nc">warning</span>: <span class="nc">BTI</span><span class="w"> </span><span class="n">turned</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">-</span><span class="n">z</span><span class="w"> </span><span class="n">force</span><span class="o">-</span><span class="n">bti</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">inputs</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">BTI</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">NOTE</span><span class="w"> </span><span class="n">section</span><span class="p">.</span><span class="w"></span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">acrichto</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ld</span>: <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">libc_nonshared</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">stat64</span><span class="p">.</span><span class="n">oS</span><span class="p">)</span>: <span class="nc">warning</span>: <span class="nc">BTI</span><span class="w"> </span><span class="n">turned</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">-</span><span class="n">z</span><span class="w"> </span><span class="n">force</span><span class="o">-</span><span class="n">bti</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">inputs</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">BTI</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">NOTE</span><span class="w"> </span><span class="n">section</span><span class="p">.</span><span class="w"></span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">acrichto</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ld</span>: <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">libc_nonshared</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">fstat64</span><span class="p">.</span><span class="n">oS</span><span class="p">)</span>: <span class="nc">warning</span>: <span class="nc">BTI</span><span class="w"> </span><span class="n">turned</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">-</span><span class="n">z</span><span class="w"> </span><span class="n">force</span><span class="o">-</span><span class="n">bti</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">inputs</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">BTI</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">NOTE</span><span class="w"> </span><span class="n">section</span><span class="p">.</span><span class="w"></span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">acrichto</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ld</span>: <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">libc_nonshared</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">lstat64</span><span class="p">.</span><span class="n">oS</span><span class="p">)</span>: <span class="nc">warning</span>: <span class="nc">BTI</span><span class="w"> </span><span class="n">turned</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">-</span><span class="n">z</span><span class="w"> </span><span class="n">force</span><span class="o">-</span><span class="n">bti</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">inputs</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">BTI</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">NOTE</span><span class="w"> </span><span class="n">section</span><span class="p">.</span><span class="w"></span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">acrichto</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ld</span>: <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">libc_nonshared</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">fstatat64</span><span class="p">.</span><span class="n">oS</span><span class="p">)</span>: <span class="nc">warning</span>: <span class="nc">BTI</span><span class="w"> </span><span class="n">turned</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">-</span><span class="n">z</span><span class="w"> </span><span class="n">force</span><span class="o">-</span><span class="n">bti</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">inputs</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">BTI</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">NOTE</span><span class="w"> </span><span class="n">section</span><span class="p">.</span><span class="w"></span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">acrichto</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ld</span>: <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="n">crtendS</span><span class="p">.</span><span class="n">o</span>: <span class="nc">warning</span>: <span class="nc">BTI</span><span class="w"> </span><span class="n">turned</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">-</span><span class="n">z</span><span class="w"> </span><span class="n">force</span><span class="o">-</span><span class="n">bti</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">inputs</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">BTI</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">NOTE</span><span class="w"> </span><span class="n">section</span><span class="p">.</span><span class="w"></span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">acrichto</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ld</span>: <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="mi">8</span><span class="o">/../../../</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">crtn</span><span class="p">.</span><span class="n">o</span>: <span class="nc">warning</span>: <span class="nc">BTI</span><span class="w"> </span><span class="n">turned</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">-</span><span class="n">z</span><span class="w"> </span><span class="n">force</span><span class="o">-</span><span class="n">bti</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">inputs</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">BTI</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">NOTE</span><span class="w"> </span><span class="n">section</span><span class="p">.</span><span class="w"></span>
</code></pre></div>
<p>so my local toolchain is at fault (somewhat predictably now that I think about it)</p>



<a name="287233164"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/verify%20BTI%20bits%20in%20binary/near/287233164" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html#287233164">(Jun 23 2022 at 18:52)</a>:</h4>
<p>in any case this is all moot for my original question, I can confirm that <code>-Z branch-protection=bti</code> sets the note even in objects with <code>global_asm!</code></p>



<a name="287316834"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/verify%20BTI%20bits%20in%20binary/near/287316834" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton Kirilov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/verify.20BTI.20bits.20in.20binary.html#287316834">(Jun 24 2022 at 11:02)</a>:</h4>
<p>Thanks a lot for this investigation, I'll pass this on to our Rust team because they wanted to do wider verification of the BTI support in Rust.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>