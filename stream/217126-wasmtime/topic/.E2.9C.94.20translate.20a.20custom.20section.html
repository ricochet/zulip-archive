<html>
<head><meta charset="utf-8"><title>✔ translate a custom section · wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/index.html">wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html">✔ translate a custom section</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="305947476"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/305947476" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> julia <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#305947476">(Oct 25 2022 at 02:55)</a>:</h4>
<p>I have added a custom section in my module using below code:</p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="c1">#[link_section = "my-data"]</span>
    <span class="n">pub</span> <span class="n">static</span> <span class="n">FIRST</span><span class="p">:</span> <span class="p">[</span><span class="n">u8</span><span class="p">;</span> <span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="sa">b</span><span class="s2">"Hello, World!"</span><span class="p">;</span>
</code></pre></div>
<p>Also, in translate_payload function in <a href="https://github.com/bytecodealliance/wasmtime/blob/097d1087e02e5e4b6a03289aae760948ae55de69/crates/environ/src/module_environ.rs#L181">module_environ</a> module, I've added the below code to translate the custom header. </p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code> <span class="n">Payload</span><span class="p">::</span><span class="n">CustomSection</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"my-data"</span> <span class="o">=&gt;</span> <span class="p">{</span>
               <span class="n">let</span> <span class="n">result</span> <span class="o">=</span> <span class="n">NameSectionReader</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">s</span><span class="o">.</span><span class="n">data_offset</span><span class="p">())</span>
                <span class="o">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">e</span><span class="o">.</span><span class="n">into</span><span class="p">())</span>
                <span class="o">.</span><span class="n">and_then</span><span class="p">(</span><span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_section</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
                <span class="n">println</span><span class="err">!</span><span class="p">(</span><span class="s2">"read custom section error {:?}"</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
                 <span class="k">if</span> <span class="n">let</span> <span class="n">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">=</span> <span class="n">result</span> <span class="p">{</span>
                    <span class="n">log</span><span class="p">::</span><span class="n">warn</span><span class="err">!</span><span class="p">(</span><span class="s2">"failed to parse name section {:?}"</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
            <span class="p">}</span>
</code></pre></div>
<p>However, I got the bellow error and couldn't fix it.</p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="n">error</span> <span class="n">Err</span><span class="p">(</span><span class="n">InvalidWebAssembly</span> <span class="p">{</span> <span class="n">message</span><span class="p">:</span> <span class="s2">"name entry extends past end of the code section"</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="mi">1124882</span> <span class="p">})</span>
</code></pre></div>
<p>Can you please help me how I can parse this new header?<br>
 Because I need to get the custom data during this step and change it.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/097d1087e02e5e4b6a03289aae760948ae55de69/crates/environ/src/module_environ.rs#L181" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/9bc608ef983f19dab7e8e9810f307c2c532fb145\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f333430303837303439653230663632376538383761333033643862666237306534666536393938633432633366396531386634386662376538623666643662312f62797465636f6465616c6c69616e63652f7761736d74696d65)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/097d1087e02e5e4b6a03289aae760948ae55de69/crates/environ/src/module_environ.rs#L181" title="wasmtime/module_environ.rs at 097d1087e02e5e4b6a03289aae760948ae55de69 · bytecodealliance/wasmtime">wasmtime/module_environ.rs at 097d1087e02e5e4b6a03289aae760948ae55de69 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">A fast and secure runtime for WebAssembly. Contribute to bytecodealliance/wasmtime development by creating an account on GitHub.</div></div></div>



<a name="305971725"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/305971725" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#305971725">(Oct 25 2022 at 07:34)</a>:</h4>
<p>I'm pretty sure the data you wrote is put directly in the custom section, so simply look at <code>s.data()</code> without doing anything with the NameSectionReader parser <a href="http://fot.name">fot.name</a> sections.</p>



<a name="306060427"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306060427" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> julia <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306060427">(Oct 25 2022 at 15:58)</a>:</h4>
<p>Thanks, but how can I change it? my goal is to change this data when module is compiling and loading into the memory.<br>
Is it possible to do that?</p>



<a name="306103827"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306103827" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306103827">(Oct 25 2022 at 19:13)</a>:</h4>
<p>Custom sections are not loaded at runtime. If you want to change the size of the data you are out of luck unless you ship the unlinked wasm files and then when you want to change the data change the wasm file containing the data and link everything again. If you don't need to change the data, you can use <code>#[no_mangle]</code> and then get the address of the data by loading the value of the exported global with the same name as the static and then change the data segment at this address (make sure to account for the fact that a data segment can specify a non-zero load address)</p>



<a name="306107006"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306107006" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> julia <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306107006">(Oct 25 2022 at 19:33)</a>:</h4>
<p>I only want to change the content not the size of data ( like Hello --&gt;Secret). <br>
Is it possible to apply this changes right after loading data from binary file in from_binary <a href="https://github.com/bytecodealliance/wasmtime/blob/b61e6783094996b2fa62d7132c6a068b30437ad7/crates/wasmtime/src/module.rs#L283">function</a> ? I applied this change, but it didn't work, the final data which is shown during execution is still <strong>Hello</strong>.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/b61e6783094996b2fa62d7132c6a068b30437ad7/crates/wasmtime/src/module.rs#L283" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/7c66b161e1b1a1b50720c2f7b21d5850d493b662\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f326534663865643632323839306362303934626631363234353933303935633033356262343733396135646464623332396239396231653162303461656666652f62797465636f6465616c6c69616e63652f7761736d74696d65)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/b61e6783094996b2fa62d7132c6a068b30437ad7/crates/wasmtime/src/module.rs#L283" title="wasmtime/module.rs at b61e6783094996b2fa62d7132c6a068b30437ad7 · bytecodealliance/wasmtime">wasmtime/module.rs at b61e6783094996b2fa62d7132c6a068b30437ad7 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">A fast and secure runtime for WebAssembly. Contribute to bytecodealliance/wasmtime development by creating an account on GitHub.</div></div></div>



<a name="306117929"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306117929" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306117929">(Oct 25 2022 at 20:39)</a>:</h4>
<p>yes, one could load the bytes of the module into memory, use a parser like the <code>wasmparser</code> crate to discover where the section resides in memory, mutate it as you describe (which shouldn't change how the module validates), and then load the module from the slice using <code>from_binary</code> if desired.</p>



<a name="306118225"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306118225" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306118225">(Oct 25 2022 at 20:41)</a>:</h4>
<p>Note that the data in the custom section is otherwise ignored by wasmtime, so I'm not sure what that would accomplish</p>



<a name="306118544"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306118544" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306118544">(Oct 25 2022 at 20:43)</a>:</h4>
<p>if you're using a data segment instead of a custom section, you could also locate and mutate it before <code>from_binary</code> (provided you don't change the size or offset) which would have an observable effect within the guest program</p>



<a name="306120408"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306120408" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> julia <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306120408">(Oct 25 2022 at 20:57)</a>:</h4>
<p><span class="user-mention" data-user-id="253989">@Peter Huene</span> Thanks for your reply.<br>
This <a href="https://users.rust-lang.org/t/variable-annotation/83147">link</a> is the real issue that I have.  I have asked and they gave me this offer.<br>
 I want to annotate a string in my rust code, and change it during loading time.  However,  I changed the value before calling <strong> from_binary</strong> but It didn't work.  Do you know what is the reason? <br>
What did you mean about this  sentence <strong>the custom section is otherwise ignored by wasmtime</strong>? Do you mean it put the data into data section? </p>
<p>If I sue data section, is there any automate way to locate the data in the data segment with annotation it in the high-level code?</p>
<div class="message_embed"><a class="message_embed_image" href="https://users.rust-lang.org/t/variable-annotation/83147" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/24a198d4f61f8267000f767f0c08153c080d1f37\/68747470733a2f2f676c6f62616c2e646973636f757273652d63646e2e636f6d2f627573696e657373352f75706c6f6164732f727573745f6c616e672f6f726967696e616c2f32582f382f383365343139353665636366643637616436666637366631356132633232653538646233316434662e737667)"></a><div class="data-container"><div class="message_embed_title"><a href="https://users.rust-lang.org/t/variable-annotation/83147" title="Variable annotation">Variable annotation</a></div><div class="message_embed_description">I want to annotate some strings (mark them with specific name) in Rust code and compile the code to wasm code using wasm32-wasi target option. I need to know the offsets that show where they store in the data section.  I know that clang has annotation capability like the below code:  __attribute__((annotate("fff"))) void foo() {}  Is there similar solution which gives me the capability to extract the offsets using annotation?  Thanks.</div></div></div>



<a name="306120845"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306120845" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306120845">(Oct 25 2022 at 21:00)</a>:</h4>
<p>the data in a custom section not otherwise known to wasmtime ahead of time (i.e. the name or debug sections) are simply skipped over when parsing the module and aren't loaded into memory, so they have no impact on a guest program's execution</p>



<a name="306120953"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306120953" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306120953">(Oct 25 2022 at 21:00)</a>:</h4>
<p>if the data is in the data section, you need a mechanism to locate it, so i don't know if you can put the address of the string in a custom section easily (haven't tried)</p>



<a name="306123876"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306123876" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> julia <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306123876">(Oct 25 2022 at 21:16)</a>:</h4>
<p>Sorry I got confused. You said wasmtime skips the data in a custom section. If it does that, why can I use this data in my code (like printing the value of string)?</p>
<p>I have checked the wat format of wasm module, I could find the string in .rodata section. <br>
However, I examined the bytes slice which contains the loaded bytes, the offset of my data showed it put in the custom section.</p>



<a name="306124360"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306124360" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306124360">(Oct 25 2022 at 21:18)</a>:</h4>
<p>i'd have to see your guest program, but if you're printing a string in a guest program, it must be in linear memory; for a static string to be initialized, the initial value must be in a data segment from a data section (in wat, a <code>(data ...)</code> expression)</p>



<a name="306124516"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306124516" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306124516">(Oct 25 2022 at 21:19)</a>:</h4>
<p>custom sections (should) never have any influence on the guest program execution and should be strippable with no observable change in behavior</p>



<a name="306124575"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306124575" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306124575">(Oct 25 2022 at 21:19)</a>:</h4>
<p>so i suspect in your setup you have two copies of the "hello world" string data: one in a data section which is what gets put in linear memory and one in a custom section</p>



<a name="306124644"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306124644" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306124644">(Oct 25 2022 at 21:19)</a>:</h4>
<p>and your modification to the copy in the custom section has no effect</p>



<a name="306125046"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306125046" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> julia <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306125046">(Oct 25 2022 at 21:21)</a>:</h4>
<p>I use spin and this is my simple code that returns string in the body. </p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="n">use</span> <span class="n">anyhow</span><span class="p">::</span><span class="n">Result</span><span class="p">;</span>
<span class="n">use</span> <span class="n">std</span><span class="p">::</span><span class="nb">str</span><span class="p">::</span><span class="n">from_utf8</span><span class="p">;</span>
<span class="n">use</span> <span class="n">spin_sdk</span><span class="p">::{</span>
    <span class="n">http</span><span class="p">::{</span><span class="n">Request</span><span class="p">,</span> <span class="n">Response</span><span class="p">},</span>
    <span class="n">http_component</span><span class="p">,</span>
<span class="p">};</span>

<span class="o">///</span> <span class="n">A</span> <span class="n">simple</span> <span class="n">Spin</span> <span class="n">HTTP</span> <span class="n">component</span><span class="o">.</span>
<span class="c1">#[http_component]</span>
<span class="n">fn</span> <span class="n">hello_world</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">Response</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">#[link_section = "my-data"]</span>
    <span class="n">pub</span> <span class="n">static</span> <span class="n">FIRST</span><span class="p">:</span> <span class="p">[</span><span class="n">u8</span><span class="p">;</span> <span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="sa">b</span><span class="s2">"Hello, World!"</span><span class="p">;</span>


    <span class="n">Ok</span><span class="p">(</span><span class="n">http</span><span class="p">::</span><span class="n">Response</span><span class="p">::</span><span class="n">builder</span><span class="p">()</span>
        <span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">"foo"</span><span class="p">,</span>  <span class="s2">"bar"</span><span class="p">)</span>
        <span class="o">.</span><span class="n">body</span><span class="p">(</span><span class="n">Some</span><span class="p">(</span><span class="n">from_utf8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FIRST</span><span class="p">)</span><span class="err">?</span><span class="o">.</span><span class="n">into</span><span class="p">()))</span><span class="err">?</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>



<a name="306125479"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306125479" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> julia <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306125479">(Oct 25 2022 at 21:23)</a>:</h4>
<p>I examined the <strong>bytes</strong> slice, there are only on copy of <strong>Hello, World!</strong> in it. I know that it is weird but mad me also confused.</p>



<a name="306125835"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306125835" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306125835">(Oct 25 2022 at 21:24)</a>:</h4>
<p>yeah, it should have two copies: one from the data section (the same as if you omitted the <code>#[link_section]</code> directive) and then another copy in the custom section that the linker splatted the  same bytes</p>



<a name="306126001"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306126001" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306126001">(Oct 25 2022 at 21:25)</a>:</h4>
<p>for runtime behavior, only the former is respected</p>



<a name="306126392"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306126392" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> julia <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306126392">(Oct 25 2022 at 21:27)</a>:</h4>
<p>makes sense, but why there are only one Hello, World!  in the bytes buffer? in the same offset with custom section.</p>



<a name="306126677"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306126677" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306126677">(Oct 25 2022 at 21:28)</a>:</h4>
<p>the <code>#[link_section]</code> directive on the static has no impact on how its data ends up in the data section</p>



<a name="306126768"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306126768" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jamey Sharp <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306126768">(Oct 25 2022 at 21:28)</a>:</h4>
<p>it may be worth stepping back to discuss what you're trying to do, then figure out whether a custom section is the best way to do it. it sounds to me like you want to have a wasm module providing an HTTP component, where the runtime environment that loads the wasm module can push some data into it before it starts handing HTTP requests off. is that right?</p>



<a name="306126993"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306126993" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306126993">(Oct 25 2022 at 21:30)</a>:</h4>
<p>a simple (naive) way to make what you want work would be to prefix the string with something easily identifiable so that you could just look through every data segment for the prefix (note: data segments may be disjoint, but probably aren't in your case) and then change the postfix bytes to what you want (the guest program would have to skip the prefix bytes); then feed the modified module in memory to Wasmtime</p>



<a name="306127780"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306127780" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306127780">(Oct 25 2022 at 21:33)</a>:</h4>
<p>unfortunately rust prohibits casting a pointer in a constant expression, so i don't think you'll get data into a custom section that helps locate the relevant bytes faster</p>



<a name="306127929"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306127929" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> julia <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306127929">(Oct 25 2022 at 21:33)</a>:</h4>
<p><span class="user-mention" data-user-id="504918">@Jamey Sharp</span>  This is a simple example only. as I mentioned before, I want to annotate some data in high-level and change it during load time. it is important to me to do that Because the previous version should not be presented in the memory during the execution. I need the address of annotated string in the buffer.</p>



<a name="306128343"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306128343" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jamey Sharp <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306128343">(Oct 25 2022 at 21:35)</a>:</h4>
<p>so far it sounds to me like you just need the data to be a wasm export, so its offset in linear memory is stored somewhere that you can read it out of the binary</p>



<a name="306128848"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306128848" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> julia <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306128848">(Oct 25 2022 at 21:37)</a>:</h4>
<p><span class="user-mention" data-user-id="253989">@Peter Huene</span> thanks for the nice idea!<br>
<span class="user-mention" data-user-id="504918">@Jamey Sharp</span> You're right, Thanks!</p>



<a name="306128935"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306128935" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306128935">(Oct 25 2022 at 21:38)</a>:</h4>
<p>indeed, one could have a function export that returns the offset in linear memory for the host to write the bytes to, then call that and modify the guest's linear memory before anything else that depends on the data is called</p>



<a name="306129410"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306129410" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jamey Sharp <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306129410">(Oct 25 2022 at 21:40)</a>:</h4>
<p><span class="user-mention" data-user-id="253989">@Peter Huene</span>, does it need to be a _function_ export? isn't a global export okay? I'm not clear on this part of the wasm spec.<br>
<span class="user-mention" data-user-id="525366">@julia</span>, if you can wait to overwrite memory until the module is instantiated (but still before you call any functions exported from the module), then I think you should be able to do that using only existing wasmtime APIs. if you want to write out a new .wasm file with the modified data, I suspect it's a little more tedious, but certainly feasible</p>



<a name="306129550"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306129550" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306129550">(Oct 25 2022 at 21:41)</a>:</h4>
<p>yeah that'd work better, need to slap an export directive on the static</p>



<a name="306129724"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306129724" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306129724">(Oct 25 2022 at 21:41)</a>:</h4>
<p>jamey's suggestion should work great for your use case</p>



<a name="306129845"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306129845" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306129845">(Oct 25 2022 at 21:42)</a>:</h4>
<p>if you slap <code>#[export_name = "foo"]</code> on your static there, you'll see a global with the address exported</p>



<a name="306129905"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306129905" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306129905">(Oct 25 2022 at 21:42)</a>:</h4>
<p>which actually you could just statically read if you want to, don't have to use the export</p>



<a name="306129925"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306129925" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306129925">(Oct 25 2022 at 21:42)</a>:</h4>
<p>now that i think about it</p>



<a name="306130081"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306130081" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306130081">(Oct 25 2022 at 21:43)</a>:</h4>
<p>so can still modify the module before compilation, just need to parse the exports, find the expected export for the index of the global, find the global and look at its initial value</p>



<a name="306131704"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306131704" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306131704">(Oct 25 2022 at 21:50)</a>:</h4>
<p>once you know the string offset in linear memory, then you need to find the data segment(s) that initializes that offset and mutate the segment bytes (at the relative offset) before loading the module in Wasmtime; should be relatively straightforward to accomplish with <code>wasmparser</code></p>



<a name="306134032"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306134032" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> julia <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306134032">(Oct 25 2022 at 22:07)</a>:</h4>
<p>Thanks a lot!<br>
I should read more to get the details of the idea and understand where I can apply the changes to modify the data.</p>



<a name="306582172"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306582172" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> julia <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306582172">(Oct 28 2022 at 04:42)</a>:</h4>
<p>I wanted to say thank you, I implemented the idea using wasmparser functions and modified the module before compilation. Thanks a lot!</p>



<a name="306582180"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20translate%20a%20custom%20section/near/306582180" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20translate.20a.20custom.20section.html#306582180">(Oct 28 2022 at 04:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="525366">julia</span> has marked this topic as resolved.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>