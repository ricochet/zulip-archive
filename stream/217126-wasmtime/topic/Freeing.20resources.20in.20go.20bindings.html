<html>
<head><meta charset="utf-8"><title>Freeing resources in go bindings · wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/index.html">wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html">Freeing resources in go bindings</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="421702002"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421702002" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421702002">(Feb 15 2024 at 17:08)</a>:</h4>
<p>I tried doing a simple POC with the golang wasmtime bindings. The idea was that I would isolate a workload on a per-request basis. To accomplish this, I had a single engine and was creating per-request stores, linkers and instances. The instances were based on a pre-compiled WASM module.</p>
<p>I noticed that I quickly OOM'd. Also didn't see obvious ways to explicitly free up those ephemeral objects.</p>
<p>My guess is that I'm probably holding it wrong but wanted to know if others have seen such issues and how they got around them.</p>



<a name="421705956"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421705956" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421705956">(Feb 15 2024 at 17:29)</a>:</h4>
<p>We do per-request isolation in Spin using <code>InstancePre</code> to make a new Instance (with a new <code>Store</code>) for each request with a variety of languages (including (Tiny)Go) and haven't had such issues.  Can you verify that you're definitely dropping the instance and store after each request?</p>



<a name="421709729"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421709729" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421709729">(Feb 15 2024 at 17:51)</a>:</h4>
<p><span class="user-mention" data-user-id="509936">@Joel Dice</span> I'm embedding wasmtime in a go project, not running go as a guest language. I'm NOT explicitly dropping the instance and store because I couldn't find any way to do so.</p>



<a name="421709980"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421709980" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421709980">(Feb 15 2024 at 17:53)</a>:</h4>
<p>It might be a gap in the bindings or just some trickery with Contexts that I didn't figure out.</p>



<a name="421710113"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421710113" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421710113">(Feb 15 2024 at 17:54)</a>:</h4>
<p>Ah, I see.  Yeah, I don't have experience with <code>wasmtime-go</code> myself.  I'm guessing it's based on Wasmtime's C bindings, which presumably has a way to dispose of such resources.  Might be worth looking through the <code>wasmtime-go</code> source code and/or opening an issue on that repo.</p>



<a name="421710201"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421710201" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421710201">(Feb 15 2024 at 17:55)</a>:</h4>
<p>Ah, let me see if I can find out the c api.</p>



<a name="421710589"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421710589" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421710589">(Feb 15 2024 at 17:57)</a>:</h4>
<p>OK, found them so it looks like the c bindings don't expose an explicit <code>drop()</code> or <code>free()</code> method. It seems like they expect a finalizer. Is that like a destructor?</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/83a5a1a607f5609249e451cbadd38827140bb7eb/crates/c-api/src/store.rs#L88-L93">https://github.com/bytecodealliance/wasmtime/blob/83a5a1a607f5609249e451cbadd38827140bb7eb/crates/c-api/src/store.rs#L88-L93</a></p>



<a name="421710729"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421710729" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421710729">(Feb 15 2024 at 17:58)</a>:</h4>
<p>A finalizer is a Go runtime feature that frees resources once a particular object gets garbage collected</p>



<a name="421710874"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421710874" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421710874">(Feb 15 2024 at 17:59)</a>:</h4>
<p>So you'd need to remove any references to the store, including any "child" objects that might refer to it</p>



<a name="421711370"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421711370" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421711370">(Feb 15 2024 at 18:02)</a>:</h4>
<p>In my little POC, the only long-lived references are these:</p>
<div class="codehilite" data-code-language="Go"><pre><span></span><code><span class="w">    </span><span class="nx">engine</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">wasmtime</span><span class="p">.</span><span class="nx">NewEngine</span><span class="p">()</span>

<span class="w">    </span><span class="nx">mod</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">wasmtime</span><span class="p">.</span><span class="nx">NewModule</span><span class="p">(</span><span class="nx">engine</span><span class="p">,</span><span class="w"> </span><span class="nx">quickjsWasmBytes</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">slog</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="s">"Error instantiating module: %e"</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">        </span><span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p>Beyond that, everything is assigned in the request handler and _should_ only have 1-way references back to the shared <code>engine</code>.</p>
<p>Perhaps I'm making a mistake w/ per-request linkers?</p>



<a name="421711497"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421711497" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421711497">(Feb 15 2024 at 18:02)</a>:</h4>
<p><span class="user-mention" data-user-id="480579">@Lann Martin</span>  But it's not an reference-counting GC, is it?  So it won't be collected until there's Go-visible memory pressure, which C and Rust allocations won't necessarily contribute to.  I think we'll want to have a pro-active way of disposing these things without leaning on the GC.</p>



<a name="421711639"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421711639" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421711639">(Feb 15 2024 at 18:03)</a>:</h4>
<p>You'd hope GC would run before OOM but yeah it isn't deterministic</p>



<a name="421711704"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421711704" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421711704">(Feb 15 2024 at 18:03)</a>:</h4>
<p>agree there should probably be a way to explicitly deallocate</p>



<a name="421711844"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421711844" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421711844">(Feb 15 2024 at 18:04)</a>:</h4>
<p>I think the idiomatic trick in go would be:</p>
<div class="codehilite" data-code-language="Go"><pre><span></span><code><span class="w">        </span><span class="nx">store</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">wasmtime</span><span class="p">.</span><span class="nx">NewStore</span><span class="p">(</span><span class="nx">engine</span><span class="p">)</span>
<span class="w">        </span><span class="k">defer</span><span class="w"> </span><span class="nx">store</span><span class="p">.</span><span class="nx">Drop</span><span class="p">()</span>
</code></pre></div>



<a name="421711871"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421711871" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421711871">(Feb 15 2024 at 18:04)</a>:</h4>
<p>I can almost guarantee it won't run before OOM if it thinks each of these Instance and Store objects are tiny and doesn't even see the C/Rust objects they point to as being part of the heap it is managing.</p>



<a name="421711933"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421711933" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421711933">(Feb 15 2024 at 18:05)</a>:</h4>
<p><span class="user-mention" data-user-id="680230">@Geoff Goodman</span>  You'd maybe call it <code>store.Close()</code> in go, but yes</p>



<a name="421712000"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421712000" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421712000">(Feb 15 2024 at 18:05)</a>:</h4>
<p>I'm neither a rustacean nor gopher so I defer to the experts :D</p>



<a name="421712654"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421712654" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421712654">(Feb 15 2024 at 18:09)</a>:</h4>
<p>How does that passed-in finalizer work in the c bindings?</p>



<a name="421712783"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421712783" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421712783">(Feb 15 2024 at 18:10)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[no_mangle]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">wasmtime_store_new</span><span class="p">(</span>
<span class="w">    </span><span class="n">engine</span>: <span class="kp">&amp;</span><span class="nc">wasm_engine_t</span><span class="p">,</span>
<span class="w">    </span><span class="n">data</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">c_void</span><span class="p">,</span>
<span class="w">    </span><span class="n">finalizer</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">c_void</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Box</span><span class="o">&lt;</span><span class="n">wasmtime_store_t</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</code></pre></div>
<p>For reference: <a href="https://github.com/bytecodealliance/wasmtime/blob/83a5a1a607f5609249e451cbadd38827140bb7eb/crates/c-api/src/store.rs#L88-L93">https://github.com/bytecodealliance/wasmtime/blob/83a5a1a607f5609249e451cbadd38827140bb7eb/crates/c-api/src/store.rs#L88-L93</a></p>



<a name="421712814"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421712814" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421712814">(Feb 15 2024 at 18:10)</a>:</h4>
<p>finalizers are a feature of the Go garbage collector; they have nothing to do with wasmtime or C</p>



<a name="421712871"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421712871" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421712871">(Feb 15 2024 at 18:11)</a>:</h4>
<p>Looks like he's referring to a Wasmtime C API thing independent of Go, though</p>



<a name="421712980"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421712980" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421712980">(Feb 15 2024 at 18:11)</a>:</h4>
<p>ohh sorry; maybe an unfortunate terminology collision?</p>



<a name="421713052"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421713052" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421713052">(Feb 15 2024 at 18:12)</a>:</h4>
<p>Looks to me like the <code>finalizer</code> param is in case the <code>data</code> param needs to be disposed with custom code supplied by the embedder</p>



<a name="421713183"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421713183" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421713183">(Feb 15 2024 at 18:13)</a>:</h4>
<p>If someone is using the c bindings, how does one drop a store?</p>



<a name="421713325"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421713325" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421713325">(Feb 15 2024 at 18:14)</a>:</h4>
<p><code>wasmtime_store_delete</code>: <a href="https://github.com/bytecodealliance/wasmtime-go/blob/v1.0.0/store.go#L72">https://github.com/bytecodealliance/wasmtime-go/blob/v1.0.0/store.go#L72</a></p>



<a name="421713508"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421713508" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421713508">(Feb 15 2024 at 18:15)</a>:</h4>
<p>Nice. Missed that in the header. Seems like that offers a nice path to opt into explicit resource management.</p>



<a name="421713678"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421713678" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421713678">(Feb 15 2024 at 18:16)</a>:</h4>
<p>It would probably require some more changes to the Go API to coexist with the Go finalizer</p>



<a name="421713687"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421713687" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421713687">(Feb 15 2024 at 18:16)</a>:</h4>
<p>You'll want to set <code>store._ptr</code> to null after you delete it (and not call <code>wasmtime_store_delete</code> if it's already null) so it doesn't get deleted twice in the finalizer.</p>



<a name="421713783"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421713783" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421713783">(Feb 15 2024 at 18:17)</a>:</h4>
<p>And check for null in all the methods.</p>



<a name="421713831"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421713831" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421713831">(Feb 15 2024 at 18:17)</a>:</h4>
<p>yeah really needs to be an issue on the wasmtime-go repo for discussion</p>



<a name="421713865"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421713865" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421713865">(Feb 15 2024 at 18:17)</a>:</h4>
<p>I can kick that off.</p>



<a name="421713889"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421713889" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421713889">(Feb 15 2024 at 18:17)</a>:</h4>
<p>Thanks!</p>



<a name="421713891"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421713891" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421713891">(Feb 15 2024 at 18:17)</a>:</h4>
<p>When I originally wrote the Go bindings I was hoping to lean heavily on the Go GC to clean things up to avoid the need for <code>.Drop()</code> everywhere since sometimes the lifetimes can be pretty tricky, but I do agree that we should add an explicit <code>Drop</code> method where needed!</p>
<p>Is it possible to get a snapshot of the heap when OOM was triggered? There may also be a bug in the wasmtime-go bindings that is leaking something by accident</p>



<a name="421713969"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421713969" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421713969">(Feb 15 2024 at 18:18)</a>:</h4>
<p>(also agreed an issue would be good to track as well)</p>



<a name="421715248"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421715248" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421715248">(Feb 15 2024 at 18:26)</a>:</h4>
<p>To reiterate (since this is kind of a pet peeve of mine): whenever a GC-allocated object points to resources outside the GC-managed heap (e.g. sockets, malloc'd buffers, graphics contexts, file descriptors, mmap'd regions, etc.) and the only way to clean them up is via GC-triggered finalizers, you're going to have a bad time eventually.  The GC doesn't see any of those external resources as contributing to memory pressure <em>for</em> <em>the</em> <em>GC-managed</em> <em>heap</em>, so you can easily run out of those resources before the next GC cycle.</p>
<p>Which isn't to criticize use of finalizers to dispose of such things as a good (and ergonomic) first step, but there's a reason why e.g. Python got a <code>with</code> statement, Java got <code>try-with-resources</code>, and Go has <code>defer</code> -- they all acknowledge that some resources need to be cleaned up independently of GC.</p>



<a name="421715359"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421715359" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421715359">(Feb 15 2024 at 18:27)</a>:</h4>
<p>Even JavaScript is getting <code>using</code> and <code>await using</code>.</p>



<a name="421715769"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421715769" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421715769">(Feb 15 2024 at 18:29)</a>:</h4>
<p>fwiw, using finalizers is quite rare in Go; people expect to manually clean up unmanaged resources</p>



<a name="421717166"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421717166" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421717166">(Feb 15 2024 at 18:37)</a>:</h4>
<p>Issue created, thanks for the insight folks: <a href="https://github.com/bytecodealliance/wasmtime-go/issues/209">https://github.com/bytecodealliance/wasmtime-go/issues/209</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime-go/issues/209" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/2c6fda941c71c3f35a46cb7d44f25e0182f30666\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613234663662313337626364313230306339353239613831366637396230623430323236653938613666386361383061346333306132343361343337336133392f62797465636f6465616c6c69616e63652f7761736d74696d652d676f2f6973737565732f323039)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime-go/issues/209" title="Feature request: support manual freeing of resources · Issue #209 · bytecodealliance/wasmtime-go">Feature request: support manual freeing of resources · Issue #209 · bytecodealliance/wasmtime-go</a></div><div class="message_embed_description">In a use-case that creates ephemeral stores and instances at high volume, such as on a per-request basis, it is easy to exhaust available memory. Currently, it appears that the go bindings rely on ...</div></div></div>



<a name="421717425"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421717425" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421717425">(Feb 15 2024 at 18:39)</a>:</h4>
<p>This is a bit orthogonal at this point, but are y'all saying that wasmtime-go shouldn't have any finalizers at all? I agree it should have the option to explicitly finalize, but it'd be surprising to me if it's recommended to remove all finalizers</p>



<a name="421717494"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421717494" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421717494">(Feb 15 2024 at 18:40)</a>:</h4>
<p>insofar as I'd expect a managed language like Go to not have memory leaks by default, but if finalizers were removed then the wasmtime bindings would have memory leaks by default</p>



<a name="421717655"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421717655" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421717655">(Feb 15 2024 at 18:40)</a>:</h4>
<p>go finalizers have pretty weak guarantees, even in practice</p>



<a name="421717697"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421717697" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421717697">(Feb 15 2024 at 18:41)</a>:</h4>
<p>I don't know what's idiomatic in Go, so no opinion on that from me, but you could equally say the C ABI has memory leaks by default (i.e. you have to explicitly call <code>wasmtime_store_delete</code> to avoid them).</p>



<a name="421717791"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421717791" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421717791">(Feb 15 2024 at 18:41)</a>:</h4>
<p>Well no one expects C to manage memory for you, but I figured that users of Python and Go for example expect to not have memory leaks by default</p>



<a name="421717825"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421717825" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421717825">(Feb 15 2024 at 18:41)</a>:</h4>
<p>e.g. if I open a file in Python I'd expect that it'd eventually get closed when I stop referring to it</p>



<a name="421717967"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421717967" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421717967">(Feb 15 2024 at 18:42)</a>:</h4>
<p>like I understand nothing is deterministic about finalizers and it's a good point that finalizers hide the "true cost" of an object, but despite all that I was always under the impression that finalizers are exactly intended for this sort of use case of C ffi bindings cleanup</p>



<a name="421717971"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421717971" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421717971">(Feb 15 2024 at 18:42)</a>:</h4>
<p>Python is interesting because it has a reference-counting+plus-cycle-collector GC, so it tends to be more deterministic in practice (and thus maybe lean more heavily on finalizers).</p>



<a name="421718001"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421718001" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421718001">(Feb 15 2024 at 18:42)</a>:</h4>
<p>(again not saying explicit finalizers shouldn't exist, that unambiguously is a good idea)</p>



<a name="421718079"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421718079" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421718079">(Feb 15 2024 at 18:43)</a>:</h4>
<p>I'm also asking b/c this would be a major change to the python/go bindings to remove finalizers</p>



<a name="421718109"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421718109" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421718109">(Feb 15 2024 at 18:43)</a>:</h4>
<p>FWIW, I think using finalizers as "a backup" for explicit disposal makes sense, and is common in Java at least.  I just don't know what's right for Go.</p>



<a name="421718117"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421718117" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421718117">(Feb 15 2024 at 18:43)</a>:</h4>
<p>(I understand that the issue isn't saying remove finalizers, so talking about something somewhat orthogonal now)</p>



<a name="421718204"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421718204" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421718204">(Feb 15 2024 at 18:44)</a>:</h4>
<p>Another option would be to print a warning in the finalizer.</p>



<a name="421718253"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421718253" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421718253">(Feb 15 2024 at 18:44)</a>:</h4>
<p>Which I've seen in Python.</p>



<a name="421718271"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421718271" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421718271">(Feb 15 2024 at 18:44)</a>:</h4>
<p>yeah that makes sense to me, but it from</p>
<blockquote>
<p>fwiw, using finalizers is quite rare in Go; people expect to manually clean up unmanaged resources</p>
</blockquote>
<p>it sounded like <span class="user-mention" data-user-id="480579">@Lann Martin</span> was saying we should remove the current finalizers</p>



<a name="421718320"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421718320" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421718320">(Feb 15 2024 at 18:44)</a>:</h4>
<p>oh interesting (about warnings)</p>



<a name="421718428"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421718428" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421718428">(Feb 15 2024 at 18:45)</a>:</h4>
<p>that was more a response to <span class="user-mention" data-user-id="509936">@Joel Dice</span>'s micro-rant <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="421718481"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421718481" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421718481">(Feb 15 2024 at 18:46)</a>:</h4>
<p>I would agree that using a finalizer as backup to an explicit close makes sense</p>



<a name="421718557"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421718557" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421718557">(Feb 15 2024 at 18:46)</a>:</h4>
<p>We should print a warning in the finalizers that includes a link to my micro-rant on Zulip.</p>



<a name="421718589"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421718589" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421718589">(Feb 15 2024 at 18:46)</a>:</h4>
<p>can I include your email in the warning?</p>



<a name="421718818"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421718818" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421718818">(Feb 15 2024 at 18:47)</a>:</h4>
<p>thanks Geoff for opening <a href="https://github.com/bytecodealliance/wasmtime-go/issues/209">https://github.com/bytecodealliance/wasmtime-go/issues/209</a>! would you be interested in helping to implement that? I'd be happy to review!</p>
<p>It also sounds like we should mirror that in the wasmtime-py Python bindings</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime-go/issues/209" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/2c6fda941c71c3f35a46cb7d44f25e0182f30666\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613234663662313337626364313230306339353239613831366637396230623430323236653938613666386361383061346333306132343361343337336133392f62797465636f6465616c6c69616e63652f7761736d74696d652d676f2f6973737565732f323039)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime-go/issues/209" title="Feature request: support manual freeing of resources · Issue #209 · bytecodealliance/wasmtime-go">Feature request: support manual freeing of resources · Issue #209 · bytecodealliance/wasmtime-go</a></div><div class="message_embed_description">In a use-case that creates ephemeral stores and instances at high volume, such as on a per-request basis, it is easy to exhaust available memory. Currently, it appears that the go bindings rely on ...</div></div></div>



<a name="421719169"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421719169" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421719169">(Feb 15 2024 at 18:49)</a>:</h4>
<p>FWIW, on the Python guest side we make <code>resource</code> handles implement <code>ContextManager</code>, allowing them to be used in <code>with</code> statements.  I'm guessing we'll want to do something similar on the host side.</p>
<p>Likewise, it might be worth looking at how the folks building guest tooling for Go are handling <code>resource</code> handles.</p>



<a name="421719352"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421719352" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421719352">(Feb 15 2024 at 18:50)</a>:</h4>
<p><code>resource</code> handle lifetimes really have to be managed explicitly due to parent-child relationships</p>



<a name="421719387"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421719387" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421719387">(Feb 15 2024 at 18:50)</a>:</h4>
<p>for sure yeah</p>



<a name="421719422"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421719422" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421719422">(Feb 15 2024 at 18:51)</a>:</h4>
<p>this really shows that someone other than me, who knows very little of Python and Go, should be primarily maintaining wasmtime-{go,py}</p>



<a name="421719637"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421719637" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421719637">(Feb 15 2024 at 18:52)</a>:</h4>
<p>(the silence you're hearing is the sound of nobody volunteering)</p>



<a name="421719703"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421719703" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421719703">(Feb 15 2024 at 18:53)</a>:</h4>
<p>it's ok issues are enough of a signal for now :)</p>



<a name="421719741"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421719741" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421719741">(Feb 15 2024 at 18:53)</a>:</h4>
<p>Sorry, in a 1:1</p>



<a name="421724333"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421724333" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421724333">(Feb 15 2024 at 19:21)</a>:</h4>
<p>I'd be interested in the work but I can't realistically commit to the undertaking without setting folks (and myself) up for disappointment. I'm still in the exploratory phase in seeing if WASM might form a strategic investment for us. I'm personally very bullish about the tech but there are quite a few more stakeholders.</p>



<a name="421724838"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421724838" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421724838">(Feb 15 2024 at 19:24)</a>:</h4>
<p>I didn't mean to imply that you should volunteer to be the new <code>wasmtime-{go,py}</code> maintainer, FWIW.  What you're saying is totally reasonable.</p>



<a name="421724936"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421724936" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421724936">(Feb 15 2024 at 19:25)</a>:</h4>
<p>I was just teasing Alex since he's maintainer of half the projects on the Internet.</p>



<a name="421725027"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421725027" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421725027">(Feb 15 2024 at 19:26)</a>:</h4>
<p>only 40%</p>



<a name="421731356"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421731356" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Guy Bedford <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421731356">(Feb 15 2024 at 20:03)</a>:</h4>
<blockquote>
<p><code>resource</code> handle lifetimes really have to be managed explicitly due to parent-child relationships</p>
</blockquote>
<p>FWIW in JS we got around this by having the finalizer function closure itself maintain a strong GC link to the parent resource, so the GC can still work despite these, as suggested by <span class="user-mention" data-user-id="253994">@Alex Crichton</span></p>



<a name="421733393"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421733393" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421733393">(Feb 15 2024 at 20:17)</a>:</h4>
<p>This seems very tricky since dropping a resource is sometimes a positive signal in e.g. wasi-http</p>



<a name="421733844"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421733844" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Guy Bedford <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421733844">(Feb 15 2024 at 20:20)</a>:</h4>
<p>(yeah, we support GC as the backup, with explicit resource management as the first line approach (ready for the soon to be shipped <code>using</code>)) I don't think there's any disagreement here just noting that GC isn't inhibited by child resource relations</p>



<a name="421741558"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421741558" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421741558">(Feb 15 2024 at 21:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="553681">Guy Bedford</span> <a href="#narrow/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings/near/421731356">said</a>:</p>
<blockquote>
<p>FWIW in JS we got around this by having the finalizer function closure itself maintain a strong GC link to the parent resource, so the GC can still work despite these, as suggested by <span class="user-mention silent" data-user-id="253994">Alex Crichton</span></p>
</blockquote>
<p>That's a cool trick.  I should do that in <code>componentize-py</code>, too.</p>



<a name="421767725"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/421767725" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#421767725">(Feb 16 2024 at 00:49)</a>:</h4>
<p><span class="user-mention" data-user-id="553681">@Guy Bedford</span> any chance you could point me to where you are employing that trick?</p>



<a name="422485610"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/422485610" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mossaka (Joe) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#422485610">(Feb 20 2024 at 19:15)</a>:</h4>
<blockquote>
<p>this really shows that someone other than me, who knows very little of Python and Go, should be primarily maintaining wasmtime-{go,py}</p>
</blockquote>
<p>I will discuss this in the sig go subgroup to check interests for maintaining the wasmtime-go sdk.</p>



<a name="422708927"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/422708927" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#422708927">(Feb 21 2024 at 21:38)</a>:</h4>
<p><span class="user-mention" data-user-id="253994">@Alex Crichton</span> a big thank you. Testing now.</p>



<a name="422727983"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Freeing%20resources%20in%20go%20bindings/near/422727983" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Freeing.20resources.20in.20go.20bindings.html#422727983">(Feb 22 2024 at 00:48)</a>:</h4>
<p>No more memory exhaustion AFAICT. <span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span></p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>