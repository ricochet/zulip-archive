<html>
<head><meta charset="utf-8"><title>Performance regression since rust 1.65 · wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/index.html">wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html">Performance regression since rust 1.65</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="443622031"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/443622031" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dennis Ranke <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#443622031">(Jun 09 2024 at 18:31)</a>:</h4>
<p>I am the developer of a simple fantasy console called MicroW8 based on WASM which is mostly used for sizecoding (for example creating visual effects in 256 bytes of code), which uses wasmtime for the native runner.</p>
<p>Recently, I got reports that that recent releases have much worse performance on windows than releases build two years ago. I'm still trying to reduce this to a minimal test case, but from what I can see, something changed going from rust 1.64 to 1.65, dropping the wasmtime performance on windows by about 30%.</p>
<p>You can find my ongoing test here: <a href="https://github.com/exoticorn/wt-regression">https://github.com/exoticorn/wt-regression</a></p>
<p>For me, I get the following results (on commit 9197048):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="o">+</span><span class="mf">1.64</span><span class="w"> </span><span class="n">bench</span>

<span class="n">technotunnel_upd</span><span class="w">        </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">3.9256</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">3.9273</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">3.9291</span><span class="w"> </span><span class="n">ms</span><span class="p">]</span>

<span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="o">+</span><span class="mf">1.65</span><span class="w"> </span><span class="n">bench</span>

<span class="n">technotunnel_upd</span><span class="w">        </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">5.1347</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">5.1365</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">5.1385</span><span class="w"> </span><span class="n">ms</span><span class="p">]</span>
<span class="w">                        </span><span class="n">change</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="o">+</span><span class="mf">30.715</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">30.791</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">30.869</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
</code></pre></div>
<p>I didn't see a performance regression on linux. But on windows, the dropped performance appears to be the same with newer versions of both wasmtime and rust.</p>
<p>Does anyone have any idea about this? Maybe there is a simple tweak somewhere I'm missing to regain the lost performance?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/exoticorn/wt-regression" style="background-image: url(&quot;https://uploads.zulipusercontent.net/0ac2152d9792170c6ac27f5962e4344aa4ff98aa/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f393533626237656131316139386563346339623932666661383836666638663135623565363331303139663864616231666238623563613364373437386431322f65786f7469636f726e2f77742d72656772657373696f6e&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/exoticorn/wt-regression" title="GitHub - exoticorn/wt-regression: Investigating a wasmtime preformance regression on win32 since rust 1.65">GitHub - exoticorn/wt-regression: Investigating a wasmtime preformance regression on win32 since rust 1.65</a></div><div class="message_embed_description">Investigating a wasmtime preformance regression on win32 since rust 1.65 - exoticorn/wt-regression</div></div></div>



<a name="443642959"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/443642959" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dennis Ranke <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#443642959">(Jun 09 2024 at 21:22)</a>:</h4>
<p>Ok, I simplified the test a bit further. I could still make the actual WASM code smaller, but it seems very much the case that calls to the <code>sin</code> function defined with <code>linker.func_wrap("env", "sin", |v: f32| v)?;</code>(yes, that's no longer a <code>sin</code> call in the performance test) have gotten a lot slower with rust 1.65 on windows.</p>
<p>Would a function defined with <code>func_new</code> or <code>func_new_unchecked</code> be likely faster?</p>



<a name="443700752"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/443700752" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dennis Ranke <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#443700752">(Jun 10 2024 at 07:30)</a>:</h4>
<p>While I didn't notice any regression in the linux builds of the original application, now that I'm running the performance test on linux, I also see a bit of a slowdown with rust 1.65.</p>
<p>So the call overhead to those provided functions probably increased across platforms.</p>



<a name="443802222"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/443802222" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#443802222">(Jun 10 2024 at 15:45)</a>:</h4>
<p>Thanks for all the information here! Would you be up for filing an issue on the Wasmtime repo for this? This looks like something to bottom out and I want to make sure we don't lose track of it</p>



<a name="443802758"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/443802758" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#443802758">(Jun 10 2024 at 15:48)</a>:</h4>
<p>To dig in a bit more though:</p>
<ul>
<li>The only change in the benchmark is rustc? Wasmtime is constant on 1.64 and 1.65?</li>
<li>No <code>func_new_unchecked</code> is in theory slower than <code>func_wrap</code>, and <code>func_new</code> should be even slower</li>
</ul>
<p>And you're saying that the <code>env::sin</code> function there is what's slower? (e.g. even without <code>v.sin()</code>, it's slower as a noop?)</p>



<a name="443818620"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/443818620" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#443818620">(Jun 10 2024 at 17:03)</a>:</h4>
<p>I also notice that this is using wasmtime 0.37, if you update wasmtime do you see the same performance regression? That would require using a newer rustc, however</p>



<a name="443819891"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/443819891" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#443819891">(Jun 10 2024 at 17:10)</a>:</h4>
<p>also: are you recompiling the wasm and the wasmtime with the different rustc versions, or just wasmtime?</p>



<a name="443820029"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/443820029" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#443820029">(Jun 10 2024 at 17:11)</a>:</h4>
<p>looking at the benchmarking repo it looks like rustc version was all that's changing, it's the same wasm and the same weasmtime, and the wasm looks like it's coming from a custom language</p>



<a name="443820062"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/443820062" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#443820062">(Jun 10 2024 at 17:11)</a>:</h4>
<p>I was able to reproduce locally on Windows but wasn't able to figure out how to use a profiler so couldn't go further</p>



<a name="443820182"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/443820182" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#443820182">(Jun 10 2024 at 17:11)</a>:</h4>
<p>the same wasm as in not being recompiled, and is literally the same wasm binary?</p>



<a name="443820245"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/443820245" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#443820245">(Jun 10 2024 at 17:12)</a>:</h4>
<p>correct</p>



<a name="443820269"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/443820269" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#443820269">(Jun 10 2024 at 17:12)</a>:</h4>
<p>the only variable was rustc</p>



<a name="443820353"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/443820353" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#443820353">(Jun 10 2024 at 17:12)</a>:</h4>
<p>and recompiling wasmtime with that rustc right? (while leaving the wasm binary as-is)</p>



<a name="443820735"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/443820735" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#443820735">(Jun 10 2024 at 17:15)</a>:</h4>
<p>yeah</p>



<a name="443820740"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/443820740" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dennis Ranke <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#443820740">(Jun 10 2024 at 17:15)</a>:</h4>
<p>Yes, the wasm is an unchanged binary blob. I'm using wasmtime 0.37 to compare the old rust versions. With MicroW8, newer rustc and wasmtime versions did not to make a measurable performance difference, but I will do an updated version of the benchmark to verify.</p>



<a name="443820846"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/443820846" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#443820846">(Jun 10 2024 at 17:15)</a>:</h4>
<p>nah that's ok I was just curious, it didn't look like much major in this area had changed since Wasmtime 0.37 to Wasmtime 21</p>



<a name="443820888"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/443820888" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#443820888">(Jun 10 2024 at 17:15)</a>:</h4>
<p>Wasmtime 22 (only a release branch not published yet) may be worth testing though since the host ABI is changing</p>



<a name="443820977"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/443820977" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#443820977">(Jun 10 2024 at 17:16)</a>:</h4>
<p>but that'll just behave similarly to <code>func_new_unchecked</code> in terms of performance</p>



<a name="443821129"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/443821129" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dennis Ranke <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#443821129">(Jun 10 2024 at 17:16)</a>:</h4>
<p>I'll also fill an issue soon, just wanted to see whether this is already known while I collect a little more info.</p>



<a name="443821758"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/443821758" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#443821758">(Jun 10 2024 at 17:19)</a>:</h4>
<p>Not known yet as far as I know, but if you can I'd also test with the <code>release-22.0.0</code> branch of Wasmtime and see if that makes a difference</p>



<a name="443821917"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/443821917" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#443821917">(Jun 10 2024 at 17:20)</a>:</h4>
<p>regardless this is probably a rustc/llvm thing and the best we can do in Wasmtime is figure out what's going wrong and tweak <code>#[inline]</code> and/or code structure, we probably can't fix the underlying issue (but I could be wrong too!)</p>



<a name="443865594"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/443865594" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dennis Ranke <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#443865594">(Jun 10 2024 at 21:15)</a>:</h4>
<p>I was on my mobile phone before, so I might flesh out a few replies now:</p>
<p><span class="user-mention silent" data-user-id="253994">Alex Crichton</span> <a href="#narrow/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65/near/443802758">said</a>:</p>
<blockquote>
<p>And you're saying that the <code>env::sin</code> function there is what's slower? (e.g. even without <code>v.sin()</code>, it's slower as a noop?)</p>
</blockquote>
<p>The current version of the benchmark runs two different wasm binaries: <code>technotunnel.wasm</code> and <code>technotunnel_nosin.wasm</code>. The former shows a performance regression while the latter doesn't. The only difference between the two is that the latter locally defines</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span><span class="w"> </span><span class="nf">sin</span><span class="p">(</span><span class="n">v</span><span class="p">:</span><span class="w"> </span><span class="kt">f32</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">v</span>
<span class="p">}</span>
</code></pre></div>
<p>in WASM instead of importing the same function defined in rust. I put the source in the repository as a reference, it is indeed a custom language which essentially maps 1:1 to  wasm instructions (<a href="https://github.com/exoticorn/curlywas">https://github.com/exoticorn/curlywas</a>).</p>
<p>And I removed the actual call to <code>v.sin()</code> on the rust side and just returned <code>v</code> to make sure it's not that math function that's gotten slower.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/exoticorn/curlywas" style="background-image: url(&quot;https://uploads.zulipusercontent.net/5bb0f75fbc900fb4fa82bb8c9af0103cdac69db8/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f326634363334343537383630623739336633643539363133376232666266653535383736316239303333383363646366616235633336366133323265383531312f65786f7469636f726e2f6375726c79776173&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/exoticorn/curlywas" title="GitHub - exoticorn/curlywas: A curly-braces infix language that compiles to WebAssembly">GitHub - exoticorn/curlywas: A curly-braces infix language that compiles to WebAssembly</a></div><div class="message_embed_description">A curly-braces infix language that compiles to WebAssembly - exoticorn/curlywas</div></div></div>



<a name="443866833"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/443866833" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dennis Ranke <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#443866833">(Jun 10 2024 at 21:24)</a>:</h4>
<p>I added a small wasm binary to the benchmark which just calls the identity <code>env.sin</code> in a loop and sums up the return values. This is obviously very artificial, but shows the changes performance much clearer. I also quickly updated to wasmtime 21.0.1 in the <code>latest</code> branch.</p>
<p>On this windows pc, I got the following results:</p>
<p>wasmtime 0.37, rust 1.64:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">technotunnel_upd</span><span class="w">        </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">2.5457</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">2.5474</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">2.5491</span><span class="w"> </span><span class="n">ms</span><span class="p">]</span>

<span class="n">technotunnel_nosin_upd</span><span class="w">  </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">2.7231</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">2.7244</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">2.7261</span><span class="w"> </span><span class="n">ms</span><span class="p">]</span>

<span class="n">simple_loop_upd</span><span class="w">         </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">537.40</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="mf">537.78</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="mf">538.22</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="p">]</span>
</code></pre></div>
<p>wasmtime 0.37, rust 1.65:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">technotunnel_upd</span><span class="w">        </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">3.4619</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">3.4669</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">3.4729</span><span class="w"> </span><span class="n">ms</span><span class="p">]</span>
<span class="w">                        </span><span class="n">change</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="o">+</span><span class="mf">35.869</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">36.093</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">36.352</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>

<span class="n">technotunnel_nosin_upd</span><span class="w">  </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">2.7043</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">2.7063</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">2.7083</span><span class="w"> </span><span class="n">ms</span><span class="p">]</span>
<span class="w">                        </span><span class="n">change</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mf">0.7590</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">0.6630</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">0.5724</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>

<span class="n">simple_loop_upd</span><span class="w">         </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">1.0879</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">1.0891</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">1.0900</span><span class="w"> </span><span class="n">ms</span><span class="p">]</span>
<span class="w">                        </span><span class="n">change</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="o">+</span><span class="mf">101.98</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">102.69</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">103.61</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
</code></pre></div>
<p>wasmtime 0.37, rust 1.78:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">technotunnel_upd</span><span class="w">        </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">3.7467</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">3.7499</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">3.7528</span><span class="w"> </span><span class="n">ms</span><span class="p">]</span>
<span class="w">                        </span><span class="n">change</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="o">+</span><span class="mf">7.9532</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">8.1630</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">8.3516</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>

<span class="n">technotunnel_nosin_upd</span><span class="w">  </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">2.7039</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">2.7059</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">2.7080</span><span class="w"> </span><span class="n">ms</span><span class="p">]</span>
<span class="w">                        </span><span class="n">change</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mf">0.1189</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">0.0136</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">0.0930</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.81</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>

<span class="n">simple_loop_upd</span><span class="w">         </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">1.4500</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">1.4505</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">1.4510</span><span class="w"> </span><span class="n">ms</span><span class="p">]</span>
<span class="w">                        </span><span class="n">change</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="o">+</span><span class="mf">32.539</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">33.312</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">34.042</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
</code></pre></div>
<p>wasmtime 21.0.1, rust 1.78</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">technotunnel_upd</span><span class="w">        </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">3.8879</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">3.8960</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">3.9051</span><span class="w"> </span><span class="n">ms</span><span class="p">]</span>
<span class="w">                        </span><span class="n">change</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="o">+</span><span class="mf">3.6712</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">3.8957</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">4.1466</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>

<span class="n">technotunnel_nosin_upd</span><span class="w">  </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">1.9664</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">1.9669</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">1.9676</span><span class="w"> </span><span class="n">ms</span><span class="p">]</span>
<span class="w">                        </span><span class="n">change</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mf">27.352</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">27.286</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">27.221</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>

<span class="n">simple_loop_upd</span><span class="w">         </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">1.7066</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">1.7082</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">1.7097</span><span class="w"> </span><span class="n">ms</span><span class="p">]</span>
<span class="w">                        </span><span class="n">change</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="o">+</span><span class="mf">17.088</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">17.555</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">17.855</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
</code></pre></div>
<p>So for the tests that are calling the imported <code>env.sin</code> function, each of these steps was a performance regression. Overall, the simple loop is more than 3x slower with the latest versions than on rust 1.64 + wasmtime 0.37. (I'll try out wasmtime 22 tomorrow)</p>
<p>For the test without import, changing rustc versions had no influence, while the wasmtime update improved performance.</p>



<a name="443868032"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/443868032" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#443868032">(Jun 10 2024 at 21:33)</a>:</h4>
<p>wow interesting!</p>



<a name="443868058"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/443868058" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#443868058">(Jun 10 2024 at 21:33)</a>:</h4>
<p>And unexpected... Thanks for gathering the data though!</p>



<a name="443868978"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/443868978" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dennis Ranke <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#443868978">(Jun 10 2024 at 21:41)</a>:</h4>
<p>I just ran the benchmarks on linux on the same pc and got very similar numbers, so it's probably not platform dependent. (Maybe CPU dependent, if it is indeed caused by changes in LLVM (rust 1.65 did update to a newer LLVM version).)</p>



<a name="443869103"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/443869103" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#443869103">(Jun 10 2024 at 21:42)</a>:</h4>
<p>oh nice, if it reproduces on Linux that'll make it much easier to investigate on our end</p>



<a name="444107484"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444107484" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dennis Ranke <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444107484">(Jun 11 2024 at 21:57)</a>:</h4>
<p>I have simplified the benchmark some more, putting the wasm code right into the rust source. While doing so I noticed that there was no regression when calling a <code>(i32) -&gt; i32</code> function like there was for a <code>(f32) -&gt; f32</code> function.</p>
<p>wasmtime 22.0.0 gains back a little bit of performance compared to 21.0.1, but not that much.</p>
<p>Another round of measurements with the latest benchmark, this time on a linux pc:</p>
<p>wasmtime 0.37, rust 1.64</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">calling</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">defined</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasm</span>
<span class="w">                        </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">2.2450</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">2.2456</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">2.2462</span><span class="w"> </span><span class="n">ms</span><span class="p">]</span>

<span class="n">calling</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">defined</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">rust</span>
<span class="w">                        </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">3.1960</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">3.1972</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">3.1991</span><span class="w"> </span><span class="n">ms</span><span class="p">]</span>
</code></pre></div>
<p>Back then, there was not too much overhead calling the function defined in rust vs. defined in wasm.</p>
<p>wasmtime 0.37, rust 1.78</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">calling</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">defined</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">rust</span>
<span class="w">                        </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">7.1093</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">7.1108</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">7.1125</span><span class="w"> </span><span class="n">ms</span><span class="p">]</span>
<span class="w">                        </span><span class="n">change</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="o">+</span><span class="mf">122.27</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">122.40</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">122.51</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
</code></pre></div>
<p>wasmtime 21.0.1, rust 1.78 (branch <code>latest</code>)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">calling</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">defined</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">rust</span>
<span class="w">                        </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">11.948</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">11.953</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">11.959</span><span class="w"> </span><span class="n">ms</span><span class="p">]</span>
<span class="w">                        </span><span class="n">change</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="o">+</span><span class="mf">68.017</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">68.102</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">68.198</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
</code></pre></div>
<p>wasmtime 22.0.0, rust 1.78 (branch <code>22.0</code>)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">calling</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">defined</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">rust</span>
<span class="w">                        </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">9.4459</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">9.4482</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">9.4510</span><span class="w"> </span><span class="n">ms</span><span class="p">]</span>
<span class="w">                        </span><span class="n">change</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mf">21.000</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">20.957</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">20.916</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
</code></pre></div>
<p>(the wasm-&gt;wasm performance was constant over all versions)</p>



<a name="444111393"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444111393" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444111393">(Jun 11 2024 at 22:27)</a>:</h4>
<p>i have no real insight into this but i did find that the transition from rust 1.64 -&gt; rust 1.65 was when LLVM 15 was introduced. id be suspicious that the change is down in there somewhere, but i haven't looked deeper. <a href="https://github.com/rust-lang/rust/blob/stable/RELEASES.md#version-1650-2022-11-03">https://github.com/rust-lang/rust/blob/stable/RELEASES.md#version-1650-2022-11-03</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/rust-lang/rust/blob/stable/RELEASES.md#version-1650-2022-11-03" style="background-image: url(&quot;https://uploads.zulipusercontent.net/fded933f7af9d281abb7f5e09ce86c2bf41eb0db/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f366366383561363934316634643930666364663166613164613162353433313264393966616332646333393130663434643861306136396663366437396137382f727573742d6c616e672f72757374&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/rust-lang/rust/blob/stable/RELEASES.md#version-1650-2022-11-03" title="rust/RELEASES.md at stable · rust-lang/rust">rust/RELEASES.md at stable · rust-lang/rust</a></div><div class="message_embed_description">Empowering everyone to build reliable and efficient software. - rust-lang/rust</div></div></div>



<a name="444114405"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444114405" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444114405">(Jun 11 2024 at 22:55)</a>:</h4>
<p>I was doing some investigation of this last night (sorry should have posted earlier) and there a huge number of inefficiences we've introduced in the wasm-&gt;host call path since 0.37, the hot functions are littered with dozens of indirect calls which all end up being noops. There's definitely work to do in wasmtime orthogonal to LLVM.</p>
<p>I also suspect that the LLVM upgrade is what "broke" the performance here originally. My best guess is that it has to do with the <code>catch_unwind</code> as there seemed to be more stack movement somewhat related to that. Optimizing that is theoretically possible in Rust but will require the <code>c_unwind</code> feature to stabilize, and that's actually looking like it'll stabilize in the next nightly or so of Rust</p>



<a name="444114586"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444114586" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444114586">(Jun 11 2024 at 22:56)</a>:</h4>
<p>but cc <span class="user-mention" data-user-id="253990">@fitzgen (he/him)</span> since in profiling I saw that the GC hooks were a huge source of slowdowns. I compared Rust 1.64.0/1.65.0 with Wasmtime 0.37 to Rust 1.78 with Wasmtime 22 (on <code>main</code>) and adding a single <code>#[cfg(feature = "gc")]</code> reduced the slowdown by 150%: Rust 1.65 was 30% slower than Rust 1.64, Wasmtime 22 was ~200% slower than Rust 1.64, and Wasmtime 22 with a small patch was ~40% slower than Rust 1.64.</p>



<a name="444114678"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444114678" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444114678">(Jun 11 2024 at 22:57)</a>:</h4>
<p>basically I don't think we've been studiously watching the perf of wasm-&gt;host calls and we've got a lot of trait objects which can't be optimized out, especially GC-related ones, and in this case there was no GC bits anyway so it's sort of a bummer it was causing a slowdown (to recover perf I was disabling the whole <code>gc</code> feature at compile time which isn't a great solution)</p>



<a name="444114688"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444114688" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444114688">(Jun 11 2024 at 22:57)</a>:</h4>
<p>I also wanted to open a more official issue for this but... busy!</p>



<a name="444116743"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444116743" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444116743">(Jun 11 2024 at 23:15)</a>:</h4>
<p>hm I'm not totally surprised, but also thought we had been trying to avoid these things except for when actually using GC stuff. happy to work on tweaks and brainstorm designs when we have a concrete example of a call/branch/path that was fast before but slow now.</p>
<p>Unfortunately, I similarly don't have the cycles to do top-level investigations to chase down and discover those concrete things myself at the moment</p>



<a name="444143984"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444143984" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444143984">(Jun 12 2024 at 04:18)</a>:</h4>
<p>With a combination of <a href="https://github.com/bytecodealliance/wasmtime/pull/8779">https://github.com/bytecodealliance/wasmtime/pull/8779</a>, <a href="https://github.com/bytecodealliance/wasmtime/pull/8780">https://github.com/bytecodealliance/wasmtime/pull/8780</a>, <a href="https://github.com/bytecodealliance/wasmtime/pull/8778">https://github.com/bytecodealliance/wasmtime/pull/8778</a>, and disabling the <code>gc</code> of the wasmtime crate I'm currently seeing ~10% better performance than Rust 1.64 with wasmtime 0.37.</p>
<p>With this diff</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/crates/wasmtime/src/runtime/store.rs b/crates/wasmtime/src/runtime/store.rs</span>
<span class="gh">index e66f383251..72a929e10d 100644</span>
<span class="gd">--- a/crates/wasmtime/src/runtime/store.rs</span>
<span class="gi">+++ b/crates/wasmtime/src/runtime/store.rs</span>
<span class="gu">@@ -1125,13 +1125,14 @@ impl&lt;T&gt; StoreInner&lt;T&gt; {</span>

<span class="w"> </span>    #[inline]
<span class="w"> </span>    pub fn call_hook(&amp;mut self, s: CallHook) -&gt; Result&lt;()&gt; {
<span class="gd">-        if self.inner.pkey.is_none() &amp;&amp; self.call_hook.is_none() {</span>
<span class="gd">-            Ok(())</span>
<span class="gd">-        } else {</span>
<span class="gd">-            self.call_hook_slow_path(s)</span>
<span class="gd">-        }</span>
<span class="gi">+        // if self.inner.pkey.is_none() &amp;&amp; self.call_hook.is_none() {</span>
<span class="gi">+        Ok(())</span>
<span class="gi">+        // } else {</span>
<span class="gi">+        //     self.call_hook_slow_path(s)</span>
<span class="gi">+        // }</span>
<span class="w"> </span>    }

<span class="gi">+    #[inline(never)]</span>
<span class="w"> </span>    fn call_hook_slow_path(&amp;mut self, s: CallHook) -&gt; Result&lt;()&gt; {
<span class="w"> </span>        if let Some(pkey) = &amp;self.inner.pkey {
<span class="w"> </span>            let allocator = self.engine().allocator();
</code></pre></div>
<p>the number goes down to 50% faster than before.</p>
<p>This final diff is possible to apply but a bit more difficult. <span class="user-mention" data-user-id="727476">@Dennis Ranke</span> is it reasonable to disable the <code>gc</code> feature for you? Also is on-par performance the goal here or were you looking to optimize the wasm-&gt;host path even further?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/8779" style="background-image: url(&quot;https://uploads.zulipusercontent.net/4269461a051317cc3d345448eac925cd170408c2/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f363566303736316665363937393738386330383866653261376634353365303731646238633237313739373166333733316336323338303433343131636462382f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f38373739&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/8779" title="Switch some asserts to debug asserts by alexcrichton · Pull Request #8779 · bytecodealliance/wasmtime">Switch some asserts to debug asserts by alexcrichton · Pull Request #8779 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">These are on the critical path of calling from wasm to the host and while minor helps clean up the path.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/8780" style="background-image: url(&quot;https://uploads.zulipusercontent.net/a25d7e4747b0503525ddf13845921c8560e6f86e/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f323932313563356635353331316236636439396137613862323230633261313433656432393339316462383461343635353538376233396435626366663739342f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f38373830&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/8780" title="Disable `AutoAssertNoGc` when `gc` is disabled by alexcrichton · Pull Request #8780 · bytecodealliance/wasmtime">Disable `AutoAssertNoGc` when `gc` is disabled by alexcrichton · Pull Request #8780 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">Statically avoids various assertions/checks when this feature is disabled.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/8778" style="background-image: url(&quot;https://uploads.zulipusercontent.net/ed5223c19e73389d43cccfa33e2aa64b6a8f194b/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f633830363965333863613237343130653834363535383238633339343963353066363733316333373438616633313262393535666332333962613239316136332f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f38373738&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/8778" title="Remove the `ModuleRuntimeInfo` trait by alexcrichton · Pull Request #8778 · bytecodealliance/wasmtime">Remove the `ModuleRuntimeInfo` trait by alexcrichton · Pull Request #8778 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">Replace it with an enum of the two possibilities that it can be. This removes the need to have a trait dispatch indirection in the vm module. Previously this was required as wasmtime-runtime was a ...</div></div></div>



<a name="444163461"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444163461" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444163461">(Jun 12 2024 at 07:13)</a>:</h4>
<blockquote>
<p>Optimizing that is theoretically possible in Rust but will require the <code>c_unwind</code> feature to stabilize, and that's actually looking like it'll stabilize in the next nightly or so of Rust</p>
</blockquote>
<p><code>extern "C-unwind"</code> has been stable for a while now. What isn't stable yet is the behavior of unwinding out of an <code>extern "C"</code> function aborting the process.</p>



<a name="444168245"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444168245" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dennis Ranke <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444168245">(Jun 12 2024 at 07:39)</a>:</h4>
<p>Oh, that sounds pretty good, thanks for looking into it!</p>
<p>Disabling <code>gc</code> is totally fine for my use-case. I'll try your patches myself this evening.</p>
<p>On-par performance sounds good enough for me. This use-case is A) the demo scene (ie. realtime animated graphical effects), so people are very sensitive to performance regression, as it impacts how smooth their effects run, but B) it's the sizecoding niche inside the demo scene, so people will happily inline complex expressions with many trigonometry host calls into their inner loop to save the 4 bytes of a <code>local.set</code>, <code>local.get</code> pair.</p>
<p>All this to say: This is a very niche use-case in the WASM world, and while we appreciate any performance wins we can get, this is maybe not enough motivation for more difficult changes that gain a few more percent.</p>



<a name="444300664"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444300664" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444300664">(Jun 12 2024 at 18:13)</a>:</h4>
<p><span class="user-mention" data-user-id="264278">@bjorn3</span> true! I was seeing unwind edges and cleanups which in theory shouldn't be there so I was considering using <code>extern "C"</code> for "hey llvm this function won't unwind don't try to add cleanups around this" for internal hooks in wasmtime that should never unwind (e.g. weren't getting inlined), so yeah I was needing the abort-on-unwind behavior of <code>extern "C"</code> which is gated behind <code>c_unwind</code> (or more specifically I was interested in <code>nounwind</code> in the LLVM IR)</p>



<a name="444300724"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444300724" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444300724">(Jun 12 2024 at 18:13)</a>:</h4>
<p><span class="user-mention" data-user-id="727476">@Dennis Ranke</span> the patches have landed on <code>main</code> now so if you can kick the tires there and see how it is that should work well! (while ensuring to disable the <code>gc</code> feature)</p>



<a name="444300950"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444300950" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444300950">(Jun 12 2024 at 18:15)</a>:</h4>
<p>I should also clarify I didn't actually get to the point of testing <code>nounwind</code> and its effects on perf, it was just a theory I had and couldn't bottom out</p>



<a name="444405320"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444405320" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dennis Ranke <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444405320">(Jun 13 2024 at 07:54)</a>:</h4>
<p><span class="user-mention" data-user-id="253994">@Alex Crichton</span> I just tried <code>main</code> without <code>gc</code>. Did you mean 10% faster than wasmtime 0.37 with rust 1.64 or 1.65? I'm getting 10% faster than 1.65, which is already really cool, but still some way of the 1.64 performance.</p>



<a name="444483256"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444483256" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444483256">(Jun 13 2024 at 14:47)</a>:</h4>
<p>Just confirmed, but locally on Linux I see that when comparing Rust 1.64 and Wasmtime 0.37 with Rust 1.78 with Wasmtime <code>main</code>:</p>
<ul>
<li><code>technotunnel_upd</code> - improved 23%</li>
<li><code>technotunnel_nosin_upd</code> - improved 50%</li>
<li><code>simple_loop_upd</code> - regressed 141%</li>
</ul>
<p>I was only looking at <code>technotunnel_upd</code> numbers the other night, is your regression based on <code>simple_loop_upd</code>?</p>



<a name="444483796"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444483796" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444483796">(Jun 13 2024 at 14:49)</a>:</h4>
<p>Er apologies the numbers I just gave were with wasmtime with default features enabled, after disabling default features I get</p>
<ul>
<li><code>technotunnel_upd</code> - improved 43%</li>
<li><code>technotunnel_nosin_upd</code> - improved 52%</li>
<li><code>simple_loop_upd</code> - improved 3%</li>
</ul>



<a name="444483915"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444483915" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444483915">(Jun 13 2024 at 14:50)</a>:</h4>
<p>You mentioned earlier you're on Windows so this could also be a Windows/Linux difference</p>



<a name="444483988"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444483988" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dennis Ranke <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444483988">(Jun 13 2024 at 14:50)</a>:</h4>
<p>Essentially, yes. I simplified the benchmark further, which only kept the simple_loop version.</p>



<a name="444484071"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444484071" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444484071">(Jun 13 2024 at 14:51)</a>:</h4>
<p>But to clarify locally I'm measuring a speedup in <code>simple_loop_upd</code> on Rust 1.78 with the <code>main</code> branch relative to Rust 1.64</p>



<a name="444484434"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444484434" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444484434">(Jun 13 2024 at 14:52)</a>:</h4>
<p>I can try to poke around on Windows later and see if I can reproduce Rust 1.64 still being slower than <code>main</code></p>



<a name="444484458"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444484458" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444484458">(Jun 13 2024 at 14:52)</a>:</h4>
<p>er, other way around, <code>main</code> still being slower than Rust 1.64</p>



<a name="444485107"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444485107" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dennis Ranke <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444485107">(Jun 13 2024 at 14:55)</a>:</h4>
<p>I can recheck with the older benchmark. I did run the performance test on Linux, too, though. (I'm not actually much of a Windows user myself, after I got the reports of regressions on Windows, I first had to spend (what felt like) multiple hours to update my windows install since I hadn't booted into it in more than a year... ;) )</p>



<a name="444485156"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444485156" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444485156">(Jun 13 2024 at 14:56)</a>:</h4>
<p>Heh I know what you mean :)</p>



<a name="444485329"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444485329" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dennis Ranke <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444485329">(Jun 13 2024 at 14:56)</a>:</h4>
<p>Does this dependency line look correct?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">wasmtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"https://github.com/bytecodealliance/wasmtime"</span><span class="p">,</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"main"</span><span class="p">,</span><span class="w"> </span><span class="n">default</span><span class="o">-</span><span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"wat"</span><span class="p">,</span><span class="w"> </span><span class="s">"cranelift"</span><span class="p">,</span><span class="w"> </span><span class="s">"runtime"</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>



<a name="444485489"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444485489" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444485489">(Jun 13 2024 at 14:57)</a>:</h4>
<p>To clarify what I did I'm on <code>4dc3dc13871f7a3b66bb6732c4f381e0aa876410</code> of the <code>wt-regression</code> repository. I first ran <code>cargo +1.64.0 bench --bench wasmtime_benchmark -- --save-baseline original</code>. Then I applied this diff</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/Cargo.toml b/Cargo.toml</span>
<span class="gh">index db47927..2b1c0ca 100644</span>
<span class="gd">--- a/Cargo.toml</span>
<span class="gi">+++ b/Cargo.toml</span>
<span class="gu">@@ -5,7 +5,8 @@ edition = "2021"</span>

<span class="w"> </span>[dependencies]
<span class="w"> </span>criterion = { version = "0.3.0", default-features = false }
<span class="gd">-wasmtime = "0.37.0"</span>
<span class="gi">+#wasmtime = "0.37.0"</span>
<span class="gi">+wasmtime = { path = '../wasmtime/crates/wasmtime', default-features = false, features = ['cranelift', 'runtime'] }</span>
<span class="w"> </span>anyhow = "1"

<span class="w"> </span>[[bench]]
<span class="gh">diff --git a/benches/wasmtime_benchmark.rs b/benches/wasmtime_benchmark.rs</span>
<span class="gh">index 024854c..5535ce9 100644</span>
<span class="gd">--- a/benches/wasmtime_benchmark.rs</span>
<span class="gi">+++ b/benches/wasmtime_benchmark.rs</span>
<span class="gu">@@ -6,6 +6,7 @@ fn benchmark_frame(c: &amp;mut Criterion) {</span>
<span class="w"> </span>    fn inner(c: &amp;mut Criterion, wasm: &amp;[u8], id: &amp;str) -&gt; Result&lt;()&gt; {
<span class="w"> </span>        let mut config = wasmtime::Config::new();
<span class="w"> </span>        config.cranelift_opt_level(wasmtime::OptLevel::Speed);
<span class="gi">+        // config.profiler(wasmtime::ProfilingStrategy::JitDump);</span>
<span class="w"> </span>        let engine = wasmtime::Engine::new(&amp;config)?;

<span class="w"> </span>        let mut store = wasmtime::Store::new(&amp;engine, ());
<span class="gu">@@ -13,7 +14,7 @@ fn benchmark_frame(c: &amp;mut Criterion) {</span>
<span class="w"> </span>        let memory = wasmtime::Memory::new(&amp;mut store, MemoryType::new(4, Some(4)))?;

<span class="w"> </span>        let mut linker = wasmtime::Linker::new(&amp;engine);
<span class="gd">-        linker.define("env", "memory", memory)?;</span>
<span class="gi">+        linker.define(&amp;mut store, "env", "memory", memory)?;</span>

<span class="w"> </span>        let module = wasmtime::Module::new(&amp;engine, wasm)?;

<span class="gu">@@ -21,7 +22,7 @@ fn benchmark_frame(c: &amp;mut Criterion) {</span>

<span class="w"> </span>        let instance = linker.instantiate(&amp;mut store, &amp;module)?;

<span class="gd">-        let update = instance.get_typed_func::&lt;(), (), _&gt;(&amp;mut store, "upd")?;</span>
<span class="gi">+        let update = instance.get_typed_func::&lt;(), ()&gt;(&amp;mut store, "upd")?;</span>

<span class="w"> </span>        c.bench_function(id, |b| {
<span class="w"> </span>            b.iter(|| {
<span class="gu">@@ -32,7 +33,12 @@ fn benchmark_frame(c: &amp;mut Criterion) {</span>
<span class="w"> </span>        Ok(())
<span class="w"> </span>    }
<span class="w"> </span>    inner(c, include_bytes!("technotunnel.wasm"), "technotunnel_upd").unwrap();
<span class="gd">-    inner(c, include_bytes!("technotunnel_nosin.wasm"), "technotunnel_nosin_upd").unwrap();</span>
<span class="gi">+    inner(</span>
<span class="gi">+        c,</span>
<span class="gi">+        include_bytes!("technotunnel_nosin.wasm"),</span>
<span class="gi">+        "technotunnel_nosin_upd",</span>
<span class="gi">+    )</span>
<span class="gi">+    .unwrap();</span>
<span class="w"> </span>    inner(c, include_bytes!("simple_loop.wasm"), "simple_loop_upd").unwrap();
<span class="w"> </span>}
</code></pre></div>
<p>and ran <code>cargo bench --bench wasmtime_benchmark -- --baseline original</code></p>



<a name="444485566"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444485566" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444485566">(Jun 13 2024 at 14:57)</a>:</h4>
<p>Yes that features-line looks correct</p>



<a name="444491831"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444491831" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444491831">(Jun 13 2024 at 15:21)</a>:</h4>
<p>Actually with <a href="https://github.com/bytecodealliance/wasmtime/pull/8794">https://github.com/bytecodealliance/wasmtime/pull/8794</a> I'm seeing a 36% improvement on <code>main</code> relative to 1.64, an improvement over the 3% above</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/8794" style="background-image: url(&quot;https://uploads.zulipusercontent.net/c977a3ee6c493f6671c3aeea42b3194b571d0fa7/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f326433356439643561373036386635316432366636313538663632623634313065386135323162376362633430636363316331623131346465303863626533662f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f38373934&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/8794" title="Statically disable MPK without the pooling allocator by alexcrichton · Pull Request #8794 · bytecodealliance/wasmtime">Statically disable MPK without the pooling allocator by alexcrichton · Pull Request #8794 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">When the pooling allocator is itself disabled then there's no use for enabling MPK so this commit switches the implementation to all of the disabled versions of the primitives. This notably makes P...</div></div></div>



<a name="444502803"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444502803" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dennis Ranke <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444502803">(Jun 13 2024 at 16:04)</a>:</h4>
<p>Hm, I followed the same steps, just with a <code>git = "https://github.com/bytecodealliance/wasmtime.git"</code> dependency instead of the <code>path</code> one + I had to do a <code>cargo update</code>. With that I got the result that <code>simple_loop_upd</code> regressed by 64.694%.</p>



<a name="444502974"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444502974" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444502974">(Jun 13 2024 at 16:05)</a>:</h4>
<p>Mind pushing up the state of the repo to the wt-regression repo?</p>



<a name="444503041"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444503041" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444503041">(Jun 13 2024 at 16:05)</a>:</h4>
<p>That way we can compare two commits of wt-regression and try to make sure we're all sync'd up</p>



<a name="444504795"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444504795" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dennis Ranke <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444504795">(Jun 13 2024 at 16:12)</a>:</h4>
<p>sure, one second, I'll re-run it here.</p>



<a name="444505371"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444505371" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dennis Ranke <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444505371">(Jun 13 2024 at 16:15)</a>:</h4>
<p>Branch name is <code>simple-loop-main</code>, but I'll just use commit ids below:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="n">checkout</span><span class="w"> </span><span class="mi">4</span><span class="n">dc3dc13871f7a3b66bb6732c4f381e0aa876410</span>
<span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="o">+</span><span class="mf">1.64</span><span class="w"> </span><span class="n">bench</span><span class="w"> </span><span class="o">--</span><span class="n">bench</span><span class="w"> </span><span class="n">wasmtime_benchmark</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="o">--</span><span class="n">save</span><span class="o">-</span><span class="n">baseline</span><span class="w"> </span><span class="n">original</span>
<span class="cp">$</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="n">checkout</span><span class="w"> </span><span class="mi">529</span><span class="n">af46497eb61787dd4204577831b2169efe486</span>
<span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">bench</span><span class="w"> </span><span class="o">--</span><span class="n">bench</span><span class="w"> </span><span class="n">wasmtime_benchmark</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="o">--</span><span class="n">baseline</span><span class="w"> </span><span class="n">original</span>

<span class="n">simple_loop_upd</span><span class="w">         </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">636.11</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="mf">636.17</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="mf">636.27</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="p">]</span>
<span class="w">                        </span><span class="n">change</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="o">+</span><span class="mf">69.564</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">69.720</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">69.850</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">regressed</span><span class="p">.</span>
</code></pre></div>



<a name="444505571"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444505571" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444505571">(Jun 13 2024 at 16:16)</a>:</h4>
<p>nice, I'll poke around later</p>



<a name="444521311"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444521311" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444521311">(Jun 13 2024 at 17:32)</a>:</h4>
<p>with those instructions I get an 87% slowdown on <code>simple_loop_upd</code>, meaning <code>main</code> is slower. </p>
<p>Looks like we're catching things at the wrong time though:</p>
<ul>
<li>A - <code>c65666c50a231bf4998419f6306e87b1fb18d586</code>, the commit used by wt-regression, is 87% slower than 1.64</li>
<li>B - <code>9f29c6e92629a8552f57fa6b2cec1371bc34f9e8</code>, the commit before A, is 12% faster than 1.64</li>
<li>C - <code>515fa4de012591e4edbc2548870ad377d0b5f3bc</code>, the commit after A, is 37% faster than 1.64</li>
</ul>
<p>Can you try re-updating to current <code>main</code>? (which is C, one commit after the one you're using). Basically this is all boiling down to <code>Store::call_hook</code> and the performance impact of that feature. It may point towards needing a Cargo feature to disable it (but on-by-default like gc)</p>



<a name="444521820"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444521820" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444521820">(Jun 13 2024 at 17:34)</a>:</h4>
<p>(sorry sent a message soon so I just updated my prior message)</p>



<a name="444531056"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444531056" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dennis Ranke <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444531056">(Jun 13 2024 at 18:21)</a>:</h4>
<p>I <em>can</em> confirm that B (<code>9f29c6e92629a8552f57fa6b2cec1371bc34f9e8</code>) is indeed a little faster than 1.64, which is amazing! However, C (<code>515fa4de012591e4edbc2548870ad377d0b5f3bc</code>) is still 64% slower than 1.64 for me.</p>
<p>I updated the branch to C.</p>



<a name="444544242"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444544242" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444544242">(Jun 13 2024 at 19:24)</a>:</h4>
<p>Interesting! Using <code>d58b3b730c4e2ae71ee708304a2574a97f770e1f</code> which is the latest commit of the wt-regression repository I see a 36% improvement over Rust 1.64, and looks like you're seeing a 64% slowdown. My guess is it may have to do with CPU differences? Are you on x64 or arm64?</p>



<a name="444544291"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444544291" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444544291">(Jun 13 2024 at 19:25)</a>:</h4>
<p>Also you're testing on Linux, not macos?</p>



<a name="444544735"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444544735" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dennis Ranke <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444544735">(Jun 13 2024 at 19:26)</a>:</h4>
<p>Yes, this is all on Linux.</p>



<a name="444544796"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444544796" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444544796">(Jun 13 2024 at 19:26)</a>:</h4>
<p>x64?</p>



<a name="444544875"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444544875" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dennis Ranke <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444544875">(Jun 13 2024 at 19:26)</a>:</h4>
<p>yes</p>



<a name="444544904"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444544904" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444544904">(Jun 13 2024 at 19:27)</a>:</h4>
<p>what cpu?</p>



<a name="444544961"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444544961" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444544961">(Jun 13 2024 at 19:27)</a>:</h4>
<p>I'm testing on <code>Intel(R) Core(TM) i9-14900K</code> myself</p>



<a name="444545062"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444545062" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dennis Ranke <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444545062">(Jun 13 2024 at 19:27)</a>:</h4>
<p>AMD Ryzen 7 7700</p>



<a name="444545188"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444545188" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444545188">(Jun 13 2024 at 19:27)</a>:</h4>
<p>mk I think this may just be cpu differences then and how good branch predictors and caches and such are</p>



<a name="444545284"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444545284" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444545284">(Jun 13 2024 at 19:28)</a>:</h4>
<p>nevertheless I'll land something on <code>main</code> to remove all the call hook things</p>



<a name="444546963"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444546963" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dennis Ranke <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444546963">(Jun 13 2024 at 19:37)</a>:</h4>
<p>Oh look at that: On  a i5-9400F I indeed see a 30% improvement over 1.64. Benchmarking is hard.</p>



<a name="444547286"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444547286" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444547286">(Jun 13 2024 at 19:39)</a>:</h4>
<p>with <a href="https://github.com/bytecodealliance/wasmtime/pull/8795">https://github.com/bytecodealliance/wasmtime/pull/8795</a> the AMD performance should improve, although I'm not sure if it will return to being on-part with 1.64</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/8795" style="background-image: url(&quot;https://uploads.zulipusercontent.net/1d1ada315af9155e41347270320390adddaf6377/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f396632373837333630646132356530393630373532666436346638346630383832376166656134613732366130396131323733376131326531306438393634622f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f38373935&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/8795" title="Add a compile-time feature for call hooks by alexcrichton · Pull Request #8795 · bytecodealliance/wasmtime">Add a compile-time feature for call hooks by alexcrichton · Pull Request #8795 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">This commit moves the Store::call_hook API behind a Cargo feature named call-hook. This helps speed up the path from wasm into the host by avoiding branches at the start and the end of the executio...</div></div></div>



<a name="444547323"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444547323" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444547323">(Jun 13 2024 at 19:39)</a>:</h4>
<p>it's basically another crate feature for you to disable, but with <code>default-features = false</code> you'll already have it disabled</p>



<a name="444548255"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444548255" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dennis Ranke <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444548255">(Jun 13 2024 at 19:44)</a>:</h4>
<p>It's -33.333% on AMD with that commit!</p>
<p>This is really amazing, given that I was fully prepared to accept "It's some change in LLVM, there's not much we can do." :)</p>



<a name="444548362"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444548362" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444548362">(Jun 13 2024 at 19:45)</a>:</h4>
<p>nice!</p>



<a name="444548418"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444548418" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444548418">(Jun 13 2024 at 19:45)</a>:</h4>
<p>sometimes a change in a different part of the system is the final motivation you need to change parts of your own system :)</p>



<a name="444548498"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444548498" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444548498">(Jun 13 2024 at 19:46)</a>:</h4>
<p>this helps fix a lot of cruft which accidentally snuck in on this path over the releases</p>



<a name="444548508"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/444548508" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#444548508">(Jun 13 2024 at 19:46)</a>:</h4>
<p>so great fixes to have regardless</p>



<a name="445024180"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Performance%20regression%20since%20rust%201.65/near/445024180" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Performance.20regression.20since.20rust.201.2E65.html#445024180">(Jun 16 2024 at 21:59)</a>:</h4>
<p>One thing I'll note on this as well now is that after some follow-up fixes it's no longer necessary to disable default features to get the perf improvements here, they're now present in builds by default</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>