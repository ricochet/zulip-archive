<html>
<head><meta charset="utf-8"><title>redfine/shadow wasi functions · wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/index.html">wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html">redfine/shadow wasi functions</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="417488976"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/417488976" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#417488976">(Jan 23 2024 at 16:59)</a>:</h4>
<p>hey all,</p>
<p>i'm messing around and wanted to see if it'd be possible to redefine an existing wasi function. I don't really have a goal in mind, but thought it'd be neat to define my own behavior for a small subset of existing wasi functions. :)</p>
<p>the tutorial and docs made it really easy to get up and running (thanks!) but I'm getting an error about memory exports I don't really understand. </p>
<p>my little snippet so far is this code, shoved into the middle of the <a href="https://docs.wasmtime.dev/examples-rust-wasi.html">example from 2.3.4 in the guide</a>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">original_env_get</span>: <span class="nc">TypedFunc</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">),</span><span class="w"> </span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">wasmtime</span>::<span class="n">Extern</span>::<span class="n">Func</span><span class="p">(</span><span class="n">env_get</span><span class="p">))</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">linker</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"wasi_snapshot_preview1"</span><span class="p">,</span><span class="w"> </span><span class="s">"environ_get"</span><span class="p">)</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">anyhow</span>::<span class="n">bail</span><span class="o">!</span><span class="p">(</span><span class="s">"missing environ_get"</span><span class="p">);</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="n">env_get</span><span class="p">.</span><span class="n">typed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">linker</span><span class="p">.</span><span class="n">allow_shadowing</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="n">linker</span><span class="p">.</span><span class="n">func_wrap</span><span class="p">(</span>
<span class="w">        </span><span class="s">"wasi_snapshot_preview1"</span><span class="p">,</span>
<span class="w">        </span><span class="s">"environ_get"</span><span class="p">,</span>
<span class="w">        </span><span class="k">move</span><span class="w"> </span><span class="o">|</span><span class="n">caller</span>: <span class="nc">Caller</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">a</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="kt">i32</span><span class="o">|</span><span class="w"> </span><span class="n">original_env_get</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)),</span>
<span class="w"> </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</code></pre></div>
<p>when I run it with a guest that actually tries to get an env var, I get a backtrace that looks like this. I'm not sure what to make of it - am I accidentally clobbering other parts of the wasi component by shadowing? any tips for reading this error better?</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>$ cargo run -p host -- ./target/wasm32-wasi/debug/guest.wasm
   Compiling host v0.1.0 (/Users/benl/src/hello-wasmtime/host)
    Finished dev [unoptimized + debuginfo] target(s) in 0.88s
     Running `target/debug/host ./target/wasm32-wasi/debug/guest.wasm`
Error: error while executing at wasm backtrace:
    0: 0x9b66 - &lt;unknown&gt;!__wasi_environ_get
    1: 0x9b24 - &lt;unknown&gt;!__wasilibc_initialize_environ
    2: 0x9a96 - &lt;unknown&gt;!__wasilibc_ensure_environ
    3: 0x9c4d - &lt;unknown&gt;!getenv
    4: 0x3b2a - &lt;unknown&gt;!std::env::_var_os::ha6d753b2be7fe17f
    5: 0x3c99 - &lt;unknown&gt;!std::env::_var::hd7c38fcd0ed4a72d
    6: 0x1829 - &lt;unknown&gt;!std::env::var::hd342252c7c9996f3
    7: 0x14f4 - &lt;unknown&gt;!guest::main::hb3d545227282da60
    8:  0xac4 - &lt;unknown&gt;!core::ops::function::FnOnce::call_once::hdf6e14f7ebde9f53
    9:  0xf43 - &lt;unknown&gt;!std::sys_common::backtrace::__rust_begin_short_backtrace::ha23fe57107e63372
   10:  0xecb - &lt;unknown&gt;!std::rt::lang_start::{{closure}}::h919e8dda9de0d648
   11: 0x3807 - &lt;unknown&gt;!std::rt::lang_start_internal::h409072ad2c29d9a2
   12:  0xe68 - &lt;unknown&gt;!std::rt::lang_start::ha5e1690a3bb184c3
   13: 0x160e - &lt;unknown&gt;!__main_void
   14:  0x2f6 - &lt;unknown&gt;!_start
   15: 0x9b66 - &lt;unknown&gt;!__wasi_environ_get
   16: 0x9b24 - &lt;unknown&gt;!__wasilibc_initialize_environ
   17: 0x9a96 - &lt;unknown&gt;!__wasilibc_ensure_environ
   18: 0x9c4d - &lt;unknown&gt;!getenv
   19: 0x3b2a - &lt;unknown&gt;!std::env::_var_os::ha6d753b2be7fe17f
   20: 0x3c99 - &lt;unknown&gt;!std::env::_var::hd7c38fcd0ed4a72d
   21: 0x1829 - &lt;unknown&gt;!std::env::var::hd342252c7c9996f3
   22: 0x14f4 - &lt;unknown&gt;!guest::main::hb3d545227282da60
   23:  0xac4 - &lt;unknown&gt;!core::ops::function::FnOnce::call_once::hdf6e14f7ebde9f53
   24:  0xf43 - &lt;unknown&gt;!std::sys_common::backtrace::__rust_begin_short_backtrace::ha23fe57107e63372
   25:  0xecb - &lt;unknown&gt;!std::rt::lang_start::{{closure}}::h919e8dda9de0d648
   26: 0x3807 - &lt;unknown&gt;!std::rt::lang_start_internal::h409072ad2c29d9a2
   27:  0xe68 - &lt;unknown&gt;!std::rt::lang_start::ha5e1690a3bb184c3
   28: 0x160e - &lt;unknown&gt;!__main_void
   29:  0x2f6 - &lt;unknown&gt;!_start
note: using the `WASMTIME_BACKTRACE_DETAILS=1` environment variable may show more debugging information

Caused by:
    missing required memory export
</code></pre></div>



<a name="417492333"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/417492333" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#417492333">(Jan 23 2024 at 17:16)</a>:</h4>
<p>the original env get function is accessing the wasm module's memory, which is required to be an export named <code>memory</code></p>



<a name="417492579"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/417492579" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#417492579">(Jan 23 2024 at 17:17)</a>:</h4>
<p>so, whatever module you are running needs to provide one of those</p>



<a name="417493198"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/417493198" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#417493198">(Jan 23 2024 at 17:20)</a>:</h4>
<p>I think it does? </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"exports:"</span><span class="p">);</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">export</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">module</span><span class="p">.</span><span class="n">exports</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">"  {}"</span><span class="p">,</span><span class="w"> </span><span class="n">export</span><span class="p">.</span><span class="n">name</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>
</code></pre></div>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>exports:
  memory
  _start
  __main_void
</code></pre></div>



<a name="417493335"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/417493335" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#417493335">(Jan 23 2024 at 17:21)</a>:</h4>
<p>do I need to redeclare that the wrapped function needs <code>memory</code> somehow?</p>



<a name="417493574"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/417493574" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#417493574">(Jan 23 2024 at 17:22)</a>:</h4>
<p>my guest program is pretty close to hello world: </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">env</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">env</span>::<span class="n">var</span><span class="p">(</span><span class="s">"TERM"</span><span class="p">).</span><span class="n">unwrap_or_else</span><span class="p">(</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="s">"unknown"</span><span class="p">.</span><span class="n">to_string</span><span class="p">());</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"hello from wasm guest! your terminal is: {term}"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>built with <code>cargo build --target wasm32-wasi</code></p>



<a name="417493666"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/417493666" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#417493666">(Jan 23 2024 at 17:22)</a>:</h4>
<p>oh, hmm</p>



<a name="417493726"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/417493726" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#417493726">(Jan 23 2024 at 17:23)</a>:</h4>
<p>instead of passing <code>env_get.typed(...)</code> a &amp;mut Store, can you pass it the Caller?</p>



<a name="417493872"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/417493872" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#417493872">(Jan 23 2024 at 17:24)</a>:</h4>
<p>oh, generate the typed wrapper on every call?</p>



<a name="417493964"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/417493964" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#417493964">(Jan 23 2024 at 17:24)</a>:</h4>
<p>not sure how else to get a Caller</p>



<a name="417494302"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/417494302" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#417494302">(Jan 23 2024 at 17:26)</a>:</h4>
<p>looks like the same error/stack trace: </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">original_env_get</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">wasmtime</span>::<span class="n">Extern</span>::<span class="n">Func</span><span class="p">(</span><span class="n">env_get</span><span class="p">))</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">linker</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"wasi_snapshot_preview1"</span><span class="p">,</span><span class="w"> </span><span class="s">"environ_get"</span><span class="p">)</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">anyhow</span>::<span class="n">bail</span><span class="o">!</span><span class="p">(</span><span class="s">"missing environ_get"</span><span class="p">);</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="n">env_get</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">linker</span><span class="p">.</span><span class="n">allow_shadowing</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="n">linker</span><span class="p">.</span><span class="n">func_wrap</span><span class="p">(</span>
<span class="w">        </span><span class="s">"wasi_snapshot_preview1"</span><span class="p">,</span>
<span class="w">        </span><span class="s">"environ_get"</span><span class="p">,</span>
<span class="w">        </span><span class="k">move</span><span class="w"> </span><span class="o">|</span><span class="k">mut</span><span class="w"> </span><span class="n">caller</span>: <span class="nc">Caller</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">a</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="kt">i32</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">typed</span>: <span class="nc">TypedFunc</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">),</span><span class="w"> </span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">original_env_get</span><span class="p">.</span><span class="n">typed</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">caller</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">            </span><span class="n">typed</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</code></pre></div>



<a name="417494313"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/417494313" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#417494313">(Jan 23 2024 at 17:26)</a>:</h4>
<p>yeah what if you make original_env_get bind to jut <code>env_get</code> instead of <code>env_get.typed(store).unwrap</code></p>



<a name="417494369"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/417494369" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#417494369">(Jan 23 2024 at 17:26)</a>:</h4>
<p>hmm</p>



<a name="417494410"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/417494410" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#417494410">(Jan 23 2024 at 17:26)</a>:</h4>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>$ cargo run -p host -- ./target/wasm32-wasi/debug/guest.wasm
   Compiling host v0.1.0 (/Users/benl/src/hello-wasmtime/host)
    Finished dev [unoptimized + debuginfo] target(s) in 1.53s
     Running `target/debug/host ./target/wasm32-wasi/debug/guest.wasm`
exports:
  memory
  _start
  __main_void
Error: error while executing at wasm backtrace:
    0: 0x9b66 - &lt;unknown&gt;!__wasi_environ_get
    1: 0x9b24 - &lt;unknown&gt;!__wasilibc_initialize_environ
    2: 0x9a96 - &lt;unknown&gt;!__wasilibc_ensure_environ
    3: 0x9c4d - &lt;unknown&gt;!getenv
    4: 0x3b2a - &lt;unknown&gt;!std::env::_var_os::ha6d753b2be7fe17f
    5: 0x3c99 - &lt;unknown&gt;!std::env::_var::hd7c38fcd0ed4a72d
    6: 0x1829 - &lt;unknown&gt;!std::env::var::hd342252c7c9996f3
    7: 0x14f4 - &lt;unknown&gt;!guest::main::hb3d545227282da60
    8:  0xac4 - &lt;unknown&gt;!core::ops::function::FnOnce::call_once::hdf6e14f7ebde9f53
    9:  0xf43 - &lt;unknown&gt;!std::sys_common::backtrace::__rust_begin_short_backtrace::ha23fe57107e63372
   10:  0xecb - &lt;unknown&gt;!std::rt::lang_start::{{closure}}::h919e8dda9de0d648
   11: 0x3807 - &lt;unknown&gt;!std::rt::lang_start_internal::h409072ad2c29d9a2
   12:  0xe68 - &lt;unknown&gt;!std::rt::lang_start::ha5e1690a3bb184c3
   13: 0x160e - &lt;unknown&gt;!__main_void
   14:  0x2f6 - &lt;unknown&gt;!_start
   15: 0x9b66 - &lt;unknown&gt;!__wasi_environ_get
   16: 0x9b24 - &lt;unknown&gt;!__wasilibc_initialize_environ
   17: 0x9a96 - &lt;unknown&gt;!__wasilibc_ensure_environ
   18: 0x9c4d - &lt;unknown&gt;!getenv
   19: 0x3b2a - &lt;unknown&gt;!std::env::_var_os::ha6d753b2be7fe17f
   20: 0x3c99 - &lt;unknown&gt;!std::env::_var::hd7c38fcd0ed4a72d
   21: 0x1829 - &lt;unknown&gt;!std::env::var::hd342252c7c9996f3
   22: 0x14f4 - &lt;unknown&gt;!guest::main::hb3d545227282da60
   23:  0xac4 - &lt;unknown&gt;!core::ops::function::FnOnce::call_once::hdf6e14f7ebde9f53
   24:  0xf43 - &lt;unknown&gt;!std::sys_common::backtrace::__rust_begin_short_backtrace::ha23fe57107e63372
   25:  0xecb - &lt;unknown&gt;!std::rt::lang_start::{{closure}}::h919e8dda9de0d648
   26: 0x3807 - &lt;unknown&gt;!std::rt::lang_start_internal::h409072ad2c29d9a2
   27:  0xe68 - &lt;unknown&gt;!std::rt::lang_start::ha5e1690a3bb184c3
   28: 0x160e - &lt;unknown&gt;!__main_void
   29:  0x2f6 - &lt;unknown&gt;!_start

Caused by:
    missing required memory export
</code></pre></div>



<a name="417494446"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/417494446" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#417494446">(Jan 23 2024 at 17:27)</a>:</h4>
<p>just in case you can see something interesting in the stack trace, there it is :)</p>



<a name="417494724"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/417494724" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#417494724">(Jan 23 2024 at 17:28)</a>:</h4>
<p>would you mind adding the RUST_BACKTRACE=1? thats the wasm backtrace, which is helpful, but not the native frames</p>



<a name="417494814"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/417494814" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#417494814">(Jan 23 2024 at 17:29)</a>:</h4>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>Stack backtrace:
   0: std::backtrace_rs::backtrace::libunwind::trace
             at /rustc/79e9716c980570bfd1f666e3b16ac583f0168962/library/std/src/../../backtrace/src/backtrace/libunwind.rs:93:5
   1: std::backtrace_rs::backtrace::trace_unsynchronized
             at /rustc/79e9716c980570bfd1f666e3b16ac583f0168962/library/std/src/../../backtrace/src/backtrace/mod.rs:66:5
   2: std::backtrace::Backtrace::create
             at /rustc/79e9716c980570bfd1f666e3b16ac583f0168962/library/std/src/backtrace.rs:331:13
   3: anyhow::error::&lt;impl anyhow::Error&gt;::msg
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/anyhow-1.0.79/src/error.rs:83:36
   4: anyhow::__private::format_err
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/anyhow-1.0.79/src/lib.rs:684:13
   5: wasmtime_wasi::sync::snapshots::preview_1::add_wasi_snapshot_preview1_to_linker::{{closure}}::{{closure}}
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wasmtime-wasi-16.0.0/src/lib.rs:66:9
   6: wiggle::run_in_dummy_executor
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wiggle-16.0.0/src/lib.rs:1171:11
   7: wasmtime_wasi::sync::snapshots::preview_1::add_wasi_snapshot_preview1_to_linker::{{closure}}
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wasmtime-wasi-16.0.0/src/lib.rs:66:9
   8: &lt;F as wasmtime::func::IntoFunc&lt;T,(wasmtime::func::Caller&lt;T&gt;,A1,A2),R&gt;&gt;::into_func::native_call_shim::{{closure}}::{{closure}}
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wasmtime-16.0.0/src/func.rs:1974:41
   9: core::ops::function::FnOnce::call_once
             at /rustc/79e9716c980570bfd1f666e3b16ac583f0168962/library/core/src/ops/function.rs:250:5
  10: &lt;core::panic::unwind_safe::AssertUnwindSafe&lt;F&gt; as core::ops::function::FnOnce&lt;()&gt;&gt;::call_once
             at /rustc/79e9716c980570bfd1f666e3b16ac583f0168962/library/core/src/panic/unwind_safe.rs:271:9
  11: std::panicking::try::do_call
             at /rustc/79e9716c980570bfd1f666e3b16ac583f0168962/library/std/src/panicking.rs:504:40
  12: ___rust_try
  13: std::panicking::try
             at /rustc/79e9716c980570bfd1f666e3b16ac583f0168962/library/std/src/panicking.rs:468:19
  14: std::panic::catch_unwind
             at /rustc/79e9716c980570bfd1f666e3b16ac583f0168962/library/std/src/panic.rs:142:14
  15: &lt;F as wasmtime::func::IntoFunc&lt;T,(wasmtime::func::Caller&lt;T&gt;,A1,A2),R&gt;&gt;::into_func::native_call_shim::{{closure}}
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wasmtime-16.0.0/src/func.rs:1969:29
  16: wasmtime::func::Caller&lt;T&gt;::with::{{closure}}
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wasmtime-16.0.0/src/func.rs:1786:13
  17: wasmtime_runtime::instance::Instance::from_vmctx
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wasmtime-runtime-16.0.0/src/instance.rs:240:9
  18: wasmtime::func::Caller&lt;T&gt;::with
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wasmtime-16.0.0/src/func.rs:1784:9
  19: &lt;F as wasmtime::func::IntoFunc&lt;T,(wasmtime::func::Caller&lt;T&gt;,A1,A2),R&gt;&gt;::into_func::native_call_shim
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wasmtime-16.0.0/src/func.rs:1958:34
  20: &lt;(A1,A2) as wasmtime::func::typed::WasmParams&gt;::invoke::{{closure}}
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wasmtime-16.0.0/src/func/typed.rs:587:21
  21: &lt;(A1,) as wasmtime::func::HostAbi&gt;::call
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wasmtime-16.0.0/src/func.rs:1693:18
  22: &lt;(A1,A2) as wasmtime::func::typed::WasmParams&gt;::invoke
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wasmtime-16.0.0/src/func/typed.rs:586:17
  23: wasmtime::func::typed::TypedFunc&lt;Params,Results&gt;::call_raw::{{closure}}
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wasmtime-16.0.0/src/func/typed.rs:181:17
  24: wasmtime_runtime::traphandlers::catch_traps::call_closure
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wasmtime-runtime-16.0.0/src/traphandlers.rs:241:18
  25: wasmtime_setjmp_16_0_0
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wasmtime-runtime-16.0.0/src/helpers.c:66:3
  26: wasmtime_runtime::traphandlers::catch_traps::{{closure}}
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wasmtime-runtime-16.0.0/src/traphandlers.rs:219:13
  27: wasmtime_runtime::traphandlers::&lt;impl wasmtime_runtime::traphandlers::call_thread_state::CallThreadState&gt;::with::{{closure}}
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wasmtime-runtime-16.0.0/src/traphandlers.rs:353:44
  28: wasmtime_runtime::traphandlers::tls::set
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wasmtime-runtime-16.0.0/src/traphandlers.rs:724:13
  29: wasmtime_runtime::traphandlers::&lt;impl wasmtime_runtime::traphandlers::call_thread_state::CallThreadState&gt;::with
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wasmtime-runtime-16.0.0/src/traphandlers.rs:353:19
  30: wasmtime_runtime::traphandlers::catch_traps
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wasmtime-runtime-16.0.0/src/traphandlers.rs:217:18
  31: wasmtime::func::invoke_wasm_and_catch_traps
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wasmtime-16.0.0/src/func.rs:1371:22
  32: wasmtime::func::typed::TypedFunc&lt;Params,Results&gt;::call_raw
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wasmtime-16.0.0/src/func/typed.rs:177:22
  33: wasmtime::func::typed::TypedFunc&lt;Params,Results&gt;::call
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wasmtime-16.0.0/src/func/typed.rs:88:18
  34: host::main::{{closure}}
             at ./host/src/main.rs:37:13
  35: &lt;F as wasmtime::func::IntoFunc&lt;T,(wasmtime::func::Caller&lt;T&gt;,A1,A2),R&gt;&gt;::into_func::native_call_shim::{{closure}}::{{closure}}
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wasmtime-16.0.0/src/func.rs:1974:41
  36: core::ops::function::FnOnce::call_once
             at /rustc/79e9716c980570bfd1f666e3b16ac583f0168962/library/core/src/ops/function.rs:250:5
  37: &lt;core::panic::unwind_safe::AssertUnwindSafe&lt;F&gt; as core::ops::function::FnOnce&lt;()&gt;&gt;::call_once
             at /rustc/79e9716c980570bfd1f666e3b16ac583f0168962/library/core/src/panic/unwind_safe.rs:271:9
  38: std::panicking::try::do_call
             at /rustc/79e9716c980570bfd1f666e3b16ac583f0168962/library/std/src/panicking.rs:504:40
  39: ___rust_try
  40: std::panicking::try
             at /rustc/79e9716c980570bfd1f666e3b16ac583f0168962/library/std/src/panicking.rs:468:19
  41: std::panic::catch_unwind
             at /rustc/79e9716c980570bfd1f666e3b16ac583f0168962/library/std/src/panic.rs:142:14
  42: &lt;F as wasmtime::func::IntoFunc&lt;T,(wasmtime::func::Caller&lt;T&gt;,A1,A2),R&gt;&gt;::into_func::native_call_shim::{{closure}}
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wasmtime-16.0.0/src/func.rs:1969:29
  43: wasmtime::func::Caller&lt;T&gt;::with::{{closure}}
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wasmtime-16.0.0/src/func.rs:1786:13
  44: wasmtime_runtime::instance::Instance::from_vmctx
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wasmtime-runtime-16.0.0/src/instance.rs:240:9
  45: wasmtime::func::Caller&lt;T&gt;::with
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wasmtime-16.0.0/src/func.rs:1784:9
  46: &lt;F as wasmtime::func::IntoFunc&lt;T,(wasmtime::func::Caller&lt;T&gt;,A1,A2),R&gt;&gt;::into_func::native_call_shim
             at /Users/benl/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wasmtime-16.0.0/src/func.rs:1958:34
  47: &lt;unknown&gt;
</code></pre></div>



<a name="417495175"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/417495175" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#417495175">(Jan 23 2024 at 17:30)</a>:</h4>
<p>hmm, yeah, thats where id expect it to come from, so im stumped at the moment and i need to run. ill see if i can get back to this later</p>



<a name="417495210"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/417495210" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#417495210">(Jan 23 2024 at 17:30)</a>:</h4>
<p>appreciate it! thanks!</p>



<a name="418146755"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418146755" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418146755">(Jan 25 2024 at 19:07)</a>:</h4>
<p><span class="user-mention" data-user-id="253992">@Pat Hickey</span> hey, have you had a chance to take another look? no rush, and if you want to just drop it, nbd :)</p>



<a name="418194149"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418194149" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418194149">(Jan 26 2024 at 01:51)</a>:</h4>
<p>sorry, been busy with getting preview 2 out the door. if you can upload a reasonably small reproduction, i'll take a look tomorrow</p>



<a name="418196370"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418196370" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418196370">(Jan 26 2024 at 02:23)</a>:</h4>
<p>congrats and no worries!</p>
<p>here's a gist: <a href="https://gist.github.com/blinsay/e9571a15fc1f59a355858cdba307946f">https://gist.github.com/blinsay/e9571a15fc1f59a355858cdba307946f</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://gist.github.com/blinsay/e9571a15fc1f59a355858cdba307946f" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/91f9baed8f4fc08c462d1a4de5a8c23942d45e97\/68747470733a2f2f6769746875622e6769746875626173736574732e636f6d2f6173736574732f676973742d6f672d696d6167652d3534666437646330373133652e706e67)"></a><div class="data-container"><div class="message_embed_title"><a href="https://gist.github.com/blinsay/e9571a15fc1f59a355858cdba307946f" title="guest.rs">guest.rs</a></div><div class="message_embed_description">GitHub Gist: instantly share code, notes, and snippets.</div></div></div>



<a name="418706753"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418706753" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418706753">(Jan 29 2024 at 19:37)</a>:</h4>
<p>hi, i finally got time to look at the reproduction, thanks for waiting</p>



<a name="418706989"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418706989" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418706989">(Jan 29 2024 at 19:38)</a>:</h4>
<p>i believe what is going on here is that you have called a method in your linker without first creating an instance of the module</p>



<a name="418707121"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418707121" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418707121">(Jan 29 2024 at 19:39)</a>:</h4>
<p>or creating any instance at all, basically</p>



<a name="418707171"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418707171" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418707171">(Jan 29 2024 at 19:40)</a>:</h4>
<p>you still need to call <code>linker.instantiate</code> somewhere</p>



<a name="418707218"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418707218" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418707218">(Jan 29 2024 at 19:40)</a>:</h4>
<p>otherwise, wasmtime tries to be helpful about calling Funcs from the "host context" where there is essentially just an empty instance</p>



<a name="418707227"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418707227" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418707227">(Jan 29 2024 at 19:40)</a>:</h4>
<p>and that empty instance doesnt have a memory</p>



<a name="418708012"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418708012" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418708012">(Jan 29 2024 at 19:46)</a>:</h4>
<p>actually, nevermind that explanation, I changed it to how it "should" work and its still broken</p>



<a name="418708093"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418708093" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418708093">(Jan 29 2024 at 19:46)</a>:</h4>
<p>which was, for reference, </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="c1">// shadowing stuff ends</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span>::<span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">prog_path</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linker</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">inst</span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"_start"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">ok_or_else</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="n">anyhow</span>::<span class="n">anyhow</span><span class="o">!</span><span class="p">(</span><span class="s">"_start export required"</span><span class="p">))</span><span class="o">?</span>
<span class="w">        </span><span class="p">.</span><span class="n">typed</span>::<span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">)</span><span class="o">?</span>
<span class="w">        </span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="p">())</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>



<a name="418708999"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418708999" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418708999">(Jan 29 2024 at 19:51)</a>:</h4>
<p><span class="user-mention" data-user-id="253994">@Alex Crichton</span> can you help me understand why this line uses the closure captured <code>vmctx</code> and not one belonging to the caller <a href="https://github.com/bytecodealliance/wasmtime/blob/ab5a4484ebac8d1f08f773d244baedb09b90a29b/crates/wasmtime/src/func.rs#L1959">https://github.com/bytecodealliance/wasmtime/blob/ab5a4484ebac8d1f08f773d244baedb09b90a29b/crates/wasmtime/src/func.rs#L1959</a></p>



<a name="418709237"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418709237" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418709237">(Jan 29 2024 at 19:53)</a>:</h4>
<p>im trying to reason about why there are two different host states for those vmctxs</p>



<a name="418709503"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418709503" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418709503">(Jan 29 2024 at 19:55)</a>:</h4>
<p>basically, the behavior of the host-to-host call of func isnt retaining the exports id expect to be present in the store</p>



<a name="418710386"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418710386" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418710386">(Jan 29 2024 at 20:01)</a>:</h4>
<p><span class="user-mention" data-user-id="685497">@Ben Linsay</span> from the above questions to alex i am actually pretty stumped on whats causing this behavior. maybe alex will be able to help me understand whats up here</p>



<a name="418710826"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418710826" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418710826">(Jan 29 2024 at 20:04)</a>:</h4>
<p>hm the answer to that is basically "it'll be memory unsafe if we didn't" in the sense that each vmctx has slightly different host state, and the closure-captured one there has the closure specified to the linker as its state and that's what's being loaded and called. The <code>caller</code>'s <code>host_state</code> I don't think corresponds to <code>T</code> in <code>Store&lt;T&gt;</code> and most of this level of detail is divorced from the overall embedding API.</p>



<a name="418710857"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418710857" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418710857">(Jan 29 2024 at 20:04)</a>:</h4>
<p>so I might need to understand more what's going on here to answer better</p>



<a name="418712859"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418712859" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418712859">(Jan 29 2024 at 20:17)</a>:</h4>
<p>oh I think I see what you're getting at, and this is indeed confusing to me as well. I'll need to puzzle this out a bit</p>



<a name="418713354"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418713354" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418713354">(Jan 29 2024 at 20:20)</a>:</h4>
<p>So I think it makes sense that this doesn't work right now. I think it's fine to consider that a bug, however.</p>
<p>The problem is that this has to do with how WASI finds the exported <code>memory</code>. When you work with WASI as it's set up by default with preview1 you never actually configure what memory to use, so each function has to look up on the caller what the memory export is. In this case though the "caller" is Rust host code itself, which means the "caller" doesn't have a memory export</p>



<a name="418713443"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418713443" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418713443">(Jan 29 2024 at 20:21)</a>:</h4>
<p>right now there's no way to fake "as if this was called by wasm", so I don't think that there's a way around this right now unfortunately.</p>



<a name="418715926"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418715926" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418715926">(Jan 29 2024 at 20:35)</a>:</h4>
<p>Yeah I thought the Caller would transfer that information but it is more subtle than that</p>



<a name="418715955"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418715955" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418715955">(Jan 29 2024 at 20:35)</a>:</h4>
<p>Anyway, ok, thanks for your help Alex</p>



<a name="418716178"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418716178" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418716178">(Jan 29 2024 at 20:36)</a>:</h4>
<p><span class="user-mention" data-user-id="685497">@Ben Linsay</span> I bet if you were using components and wasi preview 2 you wouldn’t have this problem. Want to try that instead? The distinction of being called from wasm goes away with components, and in general a lot of the complexity of an implementation of get environment is abstracted away</p>



<a name="418716399"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418716399" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418716399">(Jan 29 2024 at 20:38)</a>:</h4>
<p>If you do indeed need the wasi-common preview 1 implementation we could get you dispatching to the wiggle trait function in your func_wrap, which won’t have the same problems with caller as getting it from the linker</p>



<a name="418716496"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418716496" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418716496">(Jan 29 2024 at 20:39)</a>:</h4>
<p>But, I’m biased but if I had to recommend anything to authors of new systems, just use components! They solve tons of problems you may not even know you have yet :)</p>



<a name="418844675"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418844675" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418844675">(Jan 30 2024 at 14:18)</a>:</h4>
<p>thanks for taking a look!</p>



<a name="418845151"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418845151" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418845151">(Jan 30 2024 at 14:20)</a>:</h4>
<p>sure, components sound great. where do I find docs/examples?</p>



<a name="418849236"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418849236" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418849236">(Jan 30 2024 at 14:39)</a>:</h4>
<p>I'd recommend starting at <a href="https://component-model.bytecodealliance.org/">https://component-model.bytecodealliance.org/</a> for components</p>



<a name="418869202"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418869202" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418869202">(Jan 30 2024 at 15:57)</a>:</h4>
<p>ty!</p>
<p>just took a quick skim and it's not immediately obvious to me how i'd use this to change the behavior of a specific wasi function. would I have to re-declare the entire wasi component and forward everything else along?</p>



<a name="418870052"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418870052" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418870052">(Jan 30 2024 at 16:01)</a>:</h4>
<p>There’s a lot of ways. You could do it entirely with component composition - make a component that imports get-environment and exports the same, and use wasm-tools compose to interpose it</p>



<a name="418870175"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418870175" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418870175">(Jan 30 2024 at 16:01)</a>:</h4>
<p>You can also use the host, like you were trying before, but with a wasmtime::component::Linker</p>



<a name="418870435"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418870435" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418870435">(Jan 30 2024 at 16:03)</a>:</h4>
<p>oh interesting</p>



<a name="418870446"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418870446" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418870446">(Jan 30 2024 at 16:03)</a>:</h4>
<p>If you do that you should consider using wasmtime::component::bindgen! to generate the bindings for the cli environment interface, and then add it to the linker</p>



<a name="418870575"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418870575" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418870575">(Jan 30 2024 at 16:03)</a>:</h4>
<p>which way would you recommend?</p>



<a name="418870729"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418870729" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418870729">(Jan 30 2024 at 16:04)</a>:</h4>
<p>Start with just the host, it’s easier I thibk</p>



<a name="418870800"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418870800" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418870800">(Jan 30 2024 at 16:04)</a>:</h4>
<p>that checks out</p>



<a name="418871023"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418871023" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418871023">(Jan 30 2024 at 16:05)</a>:</h4>
<p>do I still grab a reference to <code>environ_get</code> the same way I was doing before?</p>



<a name="418871232"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418871232" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418871232">(Jan 30 2024 at 16:06)</a>:</h4>
<p>or is that going to come through the bingen! thing you're suggesting?</p>



<a name="418871359"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418871359" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418871359">(Jan 30 2024 at 16:07)</a>:</h4>
<p>No, I don’t think so, you’ll call it by rust symbol instead of getting it from the Linker in components. We don’t have allow_shadowing on the component::Linker to my knowledge so, until we get around to adding it, copy the implementation of wasmtime_wasi::preview2::command::add_to_linker and then substitute just your cli::environment add_to_linker in there</p>



<a name="418871472"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/418871472" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#418871472">(Jan 30 2024 at 16:07)</a>:</h4>
<p>cool, will sit down this afternoon and give it a whirl. thanks dude!</p>



<a name="419557330"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/419557330" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#419557330">(Feb 03 2024 at 00:25)</a>:</h4>
<p>came back to this a few days later than I meant to, and I'm still a bit lost. I read through the docs for the <code>bindgen!</code> macro (which are nice and detailed, ty!) and tried to copy what was going on there just to get started.</p>
<p>I got bindings by copying the <code>wit</code> directory from <a href="https://github.com/WebAssembly/wasi-cli/blob/main/wit/">wasi-cli</a> into a local directory and I can get the bindgen macro making bindings for it  with: </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">bindgen</span><span class="o">!</span><span class="p">({</span>
<span class="w">    </span><span class="n">world</span>: <span class="s">"imports"</span>
<span class="p">});</span>
</code></pre></div>
<p>That seems really reasonable, and I can <code>struct MyEnv; impl Host for MyEnv {...}</code> now, which is great, but I have no idea how to find the symbol for the original implementation of <code>get-environment</code>. Any suggestions on where to find it?</p>
<p>I did go digging into the docs for <code>wasmtime-wasi</code> and found out that <a href="https://docs.rs/wasmtime-wasi/17.0.0/wasmtime_wasi/preview2/bindings/wasi/cli/environment/trait.Host.html">the Host trait is already generated there</a>. Do I need to do the bindgen dance at all?</p>



<a name="419557470"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/419557470" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#419557470">(Feb 03 2024 at 00:27)</a>:</h4>
<p>I did notice that <code>component::Linker</code> has an <code>allow_shadowing</code> method btw :)</p>
<p><a href="https://docs.rs/wasmtime/latest/wasmtime/component/struct.Linker.html#method.allow_shadowing">https://docs.rs/wasmtime/latest/wasmtime/component/struct.Linker.html#method.allow_shadowing</a></p>



<a name="419557580"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/419557580" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#419557580">(Feb 03 2024 at 00:28)</a>:</h4>
<p>kinda dead-ended on the host approach right now. I'll go try the component composition approach later this weekend too.</p>



<a name="419628638"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/419628638" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#419628638">(Feb 03 2024 at 18:02)</a>:</h4>
<p>If your goal is to override a small handful of WASI methods then you can probably skip the bindgen yeah. All the types you need are in the <code>wasmtime-wasi</code> crate and with <code>allow_shadowing</code> you can basically redefine an existing wasi function with your own custom closure (using the same signature as before). Accessing the previous implementation can be done by calling the <code>Host</code> trait method directly (e.g. <code>wasmtime_wasi::preview2::bindings::wasi::cli::environment::Host::get_environment(...)</code>)</p>



<a name="419639705"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/419639705" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#419639705">(Feb 03 2024 at 20:38)</a>:</h4>
<p><span class="user-mention" data-user-id="253994">@Alex Crichton</span> dumb question, what do I pass as <code>self</code> if I call <code>Host</code> methods directly? I don't see anything that actually implements the trait</p>



<a name="419641770"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/419641770" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#419641770">(Feb 03 2024 at 21:11)</a>:</h4>
<p>The <code>self</code> argument is anything that implements the <code>WasiView</code> trait which is typically the <code>T</code> in <code>Store&lt;T&gt;</code></p>



<a name="419649229"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/419649229" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#419649229">(Feb 03 2024 at 22:56)</a>:</h4>
<p>okay, I'm still completely lost. I'm trying to mirror what I had originally but I haven't gotten anything involving wasmtime::component to compile. :(</p>
<p>Definitely feels like I'd benefit from doing the basic stuff first, so I'm going to go play with components and composing them before coming back to this. Thanks for all your help so far.</p>



<a name="419906302"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/419906302" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#419906302">(Feb 05 2024 at 18:49)</a>:</h4>
<p>our tutorials and docs for this whole category are not as polished as they need to be, but we're going to work on it :)</p>



<a name="419906457"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/419906457" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#419906457">(Feb 05 2024 at 18:50)</a>:</h4>
<p><a href="https://component-model.bytecodealliance.org/">https://component-model.bytecodealliance.org/</a> is a great start. please do report here (or file at <a href="https://github.com/bytecodealliance/component-docs">https://github.com/bytecodealliance/component-docs</a>) if anything in there isnt correct / doesnt work</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/component-docs" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/8df96f000eab8dc947698a10edbaf27dabfe9732\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f323439636462633661636466343631363631613433643636313537363663313064303036313135306664623636333166613561326631613163316532663865352f62797465636f6465616c6c69616e63652f636f6d706f6e656e742d646f6373)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/component-docs" title="GitHub - bytecodealliance/component-docs: Documentation around creating and using WebAssembly Components">GitHub - bytecodealliance/component-docs: Documentation around creating and using WebAssembly Components</a></div><div class="message_embed_description">Documentation around creating and using WebAssembly Components - GitHub - bytecodealliance/component-docs: Documentation around creating and using WebAssembly Components</div></div></div>



<a name="420093453"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/420093453" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#420093453">(Feb 06 2024 at 17:03)</a>:</h4>
<p>the docs definitely got me started! I managed to understand what a component was, run through the examples, and get my own host program running a command component fairly easily. thanks :D</p>
<p>I'm back to trying to shadow get-environment. I can't figure out how to inspect the linker/components to see if I've actually gotten the right instance and redefined the right thing. any tips on where to go from here?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">anyhow</span>::<span class="n">Context</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">env</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">component</span>::<span class="n">Component</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="p">{</span><span class="n">Config</span><span class="p">,</span><span class="w"> </span><span class="n">Engine</span><span class="p">,</span><span class="w"> </span><span class="n">Store</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime_wasi</span>::<span class="n">preview2</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">anyhow</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">env</span>::<span class="n">args</span><span class="p">().</span><span class="n">skip</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">next</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="fm">eprintln!</span><span class="p">(</span><span class="s">"starting"</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span>::<span class="n">default</span><span class="p">();</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">wasm_component_model</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasi_view</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ServerWasiView</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">wasi_view</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span>: <span class="nc">wasmtime</span>::<span class="n">component</span>::<span class="n">Linker</span><span class="o">&lt;</span><span class="n">ServerWasiView</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">wasmtime</span>::<span class="n">component</span>::<span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="w">    </span><span class="n">preview2</span>::<span class="n">command</span>::<span class="n">sync</span>::<span class="n">add_to_linker</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">).</span><span class="n">context</span><span class="p">(</span><span class="s">"failed to link command world"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// --- shadowing stuff: nothing here seems to get called ----</span>
<span class="w">    </span><span class="n">linker</span><span class="p">.</span><span class="n">allow_shadowing</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linker</span>
<span class="w">        </span><span class="p">.</span><span class="n">instance</span><span class="p">(</span><span class="s">"wasi/cli:environment"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">context</span><span class="p">(</span><span class="s">"getting the wasi/cli:environment instance"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">instance</span>
<span class="w">        </span><span class="p">.</span><span class="n">func_wrap</span><span class="p">(</span><span class="s">"get-environment"</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="k">mut</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="fm">eprintln!</span><span class="p">(</span><span class="s">"called from the host wrapper"</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// NOTE: this is terribly janky</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_wasi</span>::<span class="n">preview2</span>::<span class="n">bindings</span>::<span class="n">cli</span>::<span class="n">environment</span>::<span class="n">Host</span>::<span class="n">get_environment</span><span class="p">(</span>
<span class="w">                </span><span class="n">ctx</span><span class="p">.</span><span class="n">data_mut</span><span class="p">(),</span>
<span class="w">            </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">first</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">clone</span><span class="p">())</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">        </span><span class="p">.</span><span class="n">context</span><span class="p">(</span><span class="s">"overriding get-environment"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// --- end shadowing stuff</span>

<span class="w">    </span><span class="fm">eprintln!</span><span class="p">(</span><span class="s">"loading component"</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Component</span>::<span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">).</span><span class="n">context</span><span class="p">(</span><span class="s">"loading component failed"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">instance</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_wasi</span>::<span class="n">preview2</span>::<span class="n">command</span>::<span class="n">sync</span>::<span class="n">Command</span>::<span class="n">instantiate</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">component</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">context</span><span class="p">(</span><span class="s">"failed to instantiate Command"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span><span class="p">.</span><span class="n">wasi_cli_run</span><span class="p">().</span><span class="n">call_run</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">);</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"run -&gt; {res:?}"</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>



<a name="420103794"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/420103794" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#420103794">(Feb 06 2024 at 17:58)</a>:</h4>
<p>syntax is a little off and you'll need to add the version number to the package- so <code>wasi:cli@0.2.0/environment</code></p>



<a name="420103856"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/420103856" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#420103856">(Feb 06 2024 at 17:59)</a>:</h4>
<p>we could add a getter to linker that fails if the thing isnt there</p>



<a name="420106466"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/420106466" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#420106466">(Feb 06 2024 at 18:14)</a>:</h4>
<p>ahhhh that'd be really nice :)</p>



<a name="420106689"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/420106689" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Linsay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#420106689">(Feb 06 2024 at 18:15)</a>:</h4>
<p>it was really nice to be able to list imports/exports with modules. i don't see a way to do that with the component APIs. am I missing something or do those not exist (yet)?</p>



<a name="420107899"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/420107899" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#420107899">(Feb 06 2024 at 18:22)</a>:</h4>
<p>nope, doesnt exist</p>



<a name="420108262"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/redfine/shadow%20wasi%20functions/near/420108262" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/redfine.2Fshadow.20wasi.20functions.html#420108262">(Feb 06 2024 at 18:25)</a>:</h4>
<p>agree that it should, we can add it</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>