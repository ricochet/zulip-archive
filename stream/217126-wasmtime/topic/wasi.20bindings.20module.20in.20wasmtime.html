<html>
<head><meta charset="utf-8"><title>wasi bindings module in wasmtime · wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/index.html">wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html">wasi bindings module in wasmtime</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="391018953"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391018953" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391018953">(Sep 14 2023 at 21:12)</a>:</h4>
<p>Is anyone around who can explain how the <code>bindings</code> module in crates/wasi/src/preview2/mod.rs works?</p>



<a name="391019586"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391019586" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391019586">(Sep 14 2023 at 21:18)</a>:</h4>
<p>I can try giving it a stab!</p>



<a name="391019737"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391019737" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391019737">(Sep 14 2023 at 21:19)</a>:</h4>
<p>although as I read it now I fear I may not be of much help</p>



<a name="391019889"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391019889" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391019889">(Sep 14 2023 at 21:20)</a>:</h4>
<p>oh now I'm thinking it may be to have only some methods async</p>



<a name="391019898"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391019898" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391019898">(Sep 14 2023 at 21:20)</a>:</h4>
<p>I'm gonna fiddle</p>



<a name="391021743"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391021743" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391021743">(Sep 14 2023 at 21:36)</a>:</h4>
<p>i could explain it, but im not really around</p>



<a name="391021751"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391021751" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391021751">(Sep 14 2023 at 21:36)</a>:</h4>
<p>but i can be around :)</p>



<a name="391021791"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391021791" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391021791">(Sep 14 2023 at 21:36)</a>:</h4>
<p>its convoluted, because when i wrote it we didn't have a way to say "just make some of these generated bindings async, keep the rest sync". i think alex did actually add that recently</p>



<a name="391021886"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391021886" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391021886">(Sep 14 2023 at 21:37)</a>:</h4>
<p>I got some errors where I needed to use <code>_internal_clocks::wasi::io::poll::Pollable</code> insteaed of <code>_internal_io::wasi::io::poll::Pollable</code>.</p>



<a name="391021889"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391021889" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391021889">(Sep 14 2023 at 21:38)</a>:</h4>
<p>but basically: for the poll, stream, and filesystem interfaces, we do actually need to do tokio-async things in the methods. (we shouldn't in filesystem, but we do for tokio implementation reasons, to move the blocking calls to a worker thread while the thread running the host call itself can yield)</p>



<a name="391021941"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391021941" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391021941">(Sep 14 2023 at 21:38)</a>:</h4>
<p>oh</p>



<a name="391021961"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391021961" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391021961">(Sep 14 2023 at 21:38)</a>:</h4>
<p>hmm.</p>



<a name="391021981"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391021981" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391021981">(Sep 14 2023 at 21:38)</a>:</h4>
<p>i think this is probably something about that approach that broke when we moved to resources.</p>



<a name="391022019"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391022019" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391022019">(Sep 14 2023 at 21:38)</a>:</h4>
<p>it used to be those types were "the same" because they were <code>type Pollable = u32</code> in both modules.</p>



<a name="391022028"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391022028" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391022028">(Sep 14 2023 at 21:38)</a>:</h4>
<p>I've tried to clean this up a bit in <a href="https://github.com/bytecodealliance/wasmtime/pull/7044">this PR</a> (sorry just came back here)</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/7044" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/929efca91ae51f7c96b5d927447269f8a27aaed2\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f313766363535343735343537643066376132626565393239356262623563396531613830393938336439363862643937666136353662626664343265303033632f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f37303434)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/7044" title="Simplify bindings generation for preview2 WASI by alexcrichton · Pull Request #7044 · bytecodealliance/wasmtime">Simplify bindings generation for preview2 WASI by alexcrichton · Pull Request #7044 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">This commit attempts to simplify the preview2::bindings module by consolidating everything into a single invocation of bindgen!. Previously this was separated out (I think) to handle some methods b...</div></div></div>



<a name="391022030"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391022030" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391022030">(Sep 14 2023 at 21:38)</a>:</h4>
<p>but now theyre unique t ypes in each position</p>



<a name="391022051"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391022051" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391022051">(Sep 14 2023 at 21:39)</a>:</h4>
<p>ah, that makes sense</p>



<a name="391022087"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391022087" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391022087">(Sep 14 2023 at 21:39)</a>:</h4>
<p>I think that can be fixed with more stuff specified in <code>with: { ... }</code></p>



<a name="391022094"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391022094" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391022094">(Sep 14 2023 at 21:39)</a>:</h4>
<p>the idea is that <code>with</code> should allow you to redirect any types you are <code>use</code> ing</p>



<a name="391022102"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391022102" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391022102">(Sep 14 2023 at 21:39)</a>:</h4>
<p>yeah</p>



<a name="391022131"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391022131" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391022131">(Sep 14 2023 at 21:40)</a>:</h4>
<p>my above PR should also fix it since there's only one invocation of <code>bindgen!</code></p>



<a name="391022180"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391022180" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391022180">(Sep 14 2023 at 21:40)</a>:</h4>
<p>modulo the sync bits which may need a <code>with: { ... }</code></p>



<a name="391022285"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391022285" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391022285">(Sep 14 2023 at 21:41)</a>:</h4>
<p>yes, so the other thing going on in there is we need sync interfaces that dispatch to the async interfaces via preview2's private tokio runtime, in order to support users of wasmtime who are in synchronous rust</p>



<a name="391022291"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391022291" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391022291">(Sep 14 2023 at 21:41)</a>:</h4>
<p>those should be able to use <code>with</code></p>



<a name="391022323"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391022323" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391022323">(Sep 14 2023 at 21:41)</a>:</h4>
<p>thanks for the cleanup PR alex</p>



<a name="391022332"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391022332" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391022332">(Sep 14 2023 at 21:41)</a>:</h4>
<p>Should <code>read</code> and <code>write</code> be sync, since they're non-blocking?</p>



<a name="391022500"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391022500" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391022500">(Sep 14 2023 at 21:43)</a>:</h4>
<p>i think <code>read</code> still is technically async for filesystem reads</p>



<a name="391022521"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391022521" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391022521">(Sep 14 2023 at 21:43)</a>:</h4>
<p>but <code>write</code> can maybe be sync now?</p>



<a name="391022598"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391022598" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391022598">(Sep 14 2023 at 21:44)</a>:</h4>
<p>filesystem writes got taken care of by the flush changes, but theres still a special case for reads where they need to be done with a blocking syscall because epoll cant do files</p>



<a name="391022608"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391022608" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391022608">(Sep 14 2023 at 21:44)</a>:</h4>
<p>so they need to get moved to the blocking thread (spawn_blocking)</p>



<a name="391022624"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391022624" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391022624">(Sep 14 2023 at 21:44)</a>:</h4>
<p>I was under the impression that even <code>read</code> was non-blocking because tokio would read into a buffer on another thread</p>



<a name="391022642"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391022642" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391022642">(Sep 14 2023 at 21:44)</a>:</h4>
<p>we cant do things that way for... reasons</p>



<a name="391022661"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391022661" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391022661">(Sep 14 2023 at 21:44)</a>:</h4>
<p>i forget what they are, precisely, at this exact moment</p>



<a name="391022705"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391022705" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391022705">(Sep 14 2023 at 21:45)</a>:</h4>
<p>but i remember alex and i scratched our heads pretty hard about this earlier this summer and we decided we cant do it</p>



<a name="391022720"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391022720" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391022720">(Sep 14 2023 at 21:45)</a>:</h4>
<p>it's probably worth revisiting now yeah though</p>



<a name="391022731"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391022731" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391022731">(Sep 14 2023 at 21:45)</a>:</h4>
<p>in theory I think read/write should be able to be sync methods in rust since they can't block in rust</p>



<a name="391022748"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391022748" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391022748">(Sep 14 2023 at 21:45)</a>:</h4>
<p>might require some fiddling in the source since I think I just saw an <code>.await</code> in there</p>



<a name="391022829"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391022829" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391022829">(Sep 14 2023 at 21:46)</a>:</h4>
<p>ok. im gonna step away and let you two take care of revisiting that for now, and go back to http streams</p>



<a name="391022934"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391022934" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391022934">(Sep 14 2023 at 21:47)</a>:</h4>
<p>but first ill sign off that PR above</p>



<a name="391025220"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391025220" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391025220">(Sep 14 2023 at 22:09)</a>:</h4>
<p>I cherry-picked that PR into my local branch and it's Working For Me</p>



<a name="391025474"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391025474" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391025474">(Sep 14 2023 at 22:11)</a>:</h4>
<p>Oh, also, the reason <code>read</code> and <code>write</code> need be async is that those are the <em>file</em> read and write methods, which are basically <code>pread</code> and <code>pwrite</code>, so yeah, they're doing I/O, and should be async in the bindings.</p>



<a name="391025559"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391025559" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391025559">(Sep 14 2023 at 22:12)</a>:</h4>
<p>So it's all good.</p>



<a name="391025575"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391025575" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391025575">(Sep 14 2023 at 22:12)</a>:</h4>
<p>I've got a follow-up commit though to remove async from <code>check-write</code>, <code>flush</code>, and <code>write-zeros</code></p>



<a name="391025616"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391025616" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391025616">(Sep 14 2023 at 22:13)</a>:</h4>
<p>technically we could make <code>write</code> non-async too but right now bindgen can't differentiate between the fs <code>write</code> function and the io <code>write</code> function</p>



<a name="391025675"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391025675" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391025675">(Sep 14 2023 at 22:13)</a>:</h4>
<p>ah, I was just figuring that out. These names aren't qualified, so we have some collisions.</p>



<a name="391025815"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391025815" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391025815">(Sep 14 2023 at 22:14)</a>:</h4>
<p>I can work on improving that tomorrow</p>



<a name="391026575"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391026575" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391026575">(Sep 14 2023 at 22:22)</a>:</h4>
<p>As a quick heads up, with the bindings cleanup patch, and moving filesystem functions into the resource impl:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span><span class="p">[</span><span class="n">E0195</span><span class="p">]</span>: <span class="nc">lifetime</span><span class="w"> </span><span class="n">parameters</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">bounds</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="err">`</span><span class="n">advise</span><span class="err">`</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">declaration</span>
<span class="w">   </span><span class="o">-</span>-&gt; <span class="nc">crates</span><span class="o">/</span><span class="n">wasi</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">preview2</span><span class="o">/</span><span class="n">host</span><span class="o">/</span><span class="n">filesystem</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">33</span>:<span class="mi">18</span>
<span class="w">    </span><span class="o">|</span>
<span class="mi">31</span><span class="w">  </span><span class="o">|</span><span class="w">   </span><span class="cp">#[async_trait::async_trait]</span>
<span class="w">    </span><span class="o">|</span><span class="w">   </span><span class="o">---------------------------</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="err">`</span><span class="k">where</span><span class="err">`</span><span class="w"> </span><span class="n">clause</span><span class="w"> </span><span class="n">might</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">trait</span>
<span class="mi">32</span><span class="w">  </span><span class="o">|</span><span class="w">   </span><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">WasiView</span><span class="o">&gt;</span><span class="w"> </span><span class="n">HostDescriptor</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{</span>
<span class="mi">33</span><span class="w">  </span><span class="o">|</span><span class="w">           </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">advise</span><span class="p">(</span>
<span class="w">    </span><span class="o">|</span><span class="w">  </span><span class="n">__________________</span><span class="o">^</span>
<span class="mi">34</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="mi">35</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="n">fd</span>: <span class="nc">Resource</span><span class="o">&lt;</span><span class="n">types</span>::<span class="n">Descriptor</span><span class="o">&gt;</span><span class="p">,</span>
<span class="mi">36</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="n">offset</span>: <span class="nc">types</span>::<span class="n">Filesize</span><span class="p">,</span>
<span class="mi">37</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="n">len</span>: <span class="nc">types</span>::<span class="n">Filesize</span><span class="p">,</span>
<span class="mi">38</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="n">advice</span>: <span class="nc">types</span>::<span class="n">Advice</span><span class="p">,</span>
<span class="mi">39</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">types</span>::<span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="n">_________</span><span class="o">^</span><span class="w"> </span><span class="n">lifetimes</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">trait</span>
<span class="w">    </span><span class="o">|</span>
<span class="w">   </span>::: <span class="nc">crates</span><span class="o">/</span><span class="n">wasi</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">preview2</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">143</span>:<span class="mi">7</span>
<span class="w">    </span><span class="o">|</span>
<span class="mi">143</span><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="p">});</span>
<span class="w">    </span><span class="o">|</span><span class="w">         </span><span class="o">-</span><span class="w"> </span><span class="n">lifetimes</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">trait</span>
</code></pre></div>



<a name="391026615"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391026615" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391026615">(Sep 14 2023 at 22:22)</a>:</h4>
<p>It seems to be expecting <code>advise</code> and all the other functions to be sync, even though they're in the list of async fns</p>



<a name="391027503"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391027503" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391027503">(Sep 14 2023 at 22:31)</a>:</h4>
<p>oh I think it's because the methods changed</p>



<a name="391027514"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391027514" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391027514">(Sep 14 2023 at 22:31)</a>:</h4>
<p>you'll probably need them to be <code>[method]descriptor.advise</code></p>



<a name="391027524"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391027524" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391027524">(Sep 14 2023 at 22:31)</a>:</h4>
<p>e.g. <code>"[method]descriptor.advise"</code></p>



<a name="391028491"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391028491" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391028491">(Sep 14 2023 at 22:40)</a>:</h4>
<p>Where do I use that syntax?</p>



<a name="391028695"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391028695" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391028695">(Sep 14 2023 at 22:42)</a>:</h4>
<p>Oh, in the <code>only_imports</code> list. That works.</p>



<a name="391028709"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391028709" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391028709">(Sep 14 2023 at 22:42)</a>:</h4>
<p>ah yeah</p>



<a name="391028720"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391028720" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391028720">(Sep 14 2023 at 22:42)</a>:</h4>
<p>oh hey that'd solve the namespacing issue too heh</p>



<a name="391028722"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391028722" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391028722">(Sep 14 2023 at 22:42)</a>:</h4>
<p>albeit indirectly</p>



<a name="391029084"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391029084" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391029084">(Sep 14 2023 at 22:47)</a>:</h4>
<p>sweet, I got all of the <code>HostDescriptor</code> impl compiling</p>



<a name="391233653"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391233653" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391233653">(Sep 15 2023 at 18:07)</a>:</h4>
<p>All of wasmtime-wasi now compiles!</p>



<a name="391233929"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391233929" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391233929">(Sep 15 2023 at 18:09)</a>:</h4>
<p>It appears that wasmtime-wasi-http is pulling in the wasmtime-wasi bindings for polling and streams. Does it make sense for me to jump in and port that code to the new poll interfaces?</p>



<a name="391236687"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391236687" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391236687">(Sep 15 2023 at 18:23)</a>:</h4>
<p>I'd naively say that whatever passes CI and gets WASI on resources is good enough for now</p>



<a name="391236716"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391236716" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391236716">(Sep 15 2023 at 18:23)</a>:</h4>
<p>but that's without knowing many specifics</p>



<a name="391238699"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391238699" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391238699">(Sep 15 2023 at 18:30)</a>:</h4>
<p>wasmtime-wasi-http doesn't compile right now and it looks like the easiest thing might be for me to just upgrade its poll and streams to resources too, so I'm now doing that</p>



<a name="391238799"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391238799" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391238799">(Sep 15 2023 at 18:31)</a>:</h4>
<p>I'm reading over the PR to early-review</p>



<a name="391239343"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391239343" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391239343">(Sep 15 2023 at 18:33)</a>:</h4>
<p>I want to make a cleanup pass and hopefully find some way to factor out all those <code>Resource::new_borrow(fd.rep())</code> things, but it should be in a readable state.</p>



<a name="391239598"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391239598" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391239598">(Sep 15 2023 at 18:35)</a>:</h4>
<p>yeah I was seeing that -- that's because there's two <code>Descriptor</code> types for example, right?</p>



<a name="391239605"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391239605" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391239605">(Sep 15 2023 at 18:35)</a>:</h4>
<p>one async and one sync?</p>



<a name="391239650"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391239650" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391239650">(Sep 15 2023 at 18:35)</a>:</h4>
<p>Yeah, that's one big source of them</p>



<a name="391239712"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391239712" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391239712">(Sep 15 2023 at 18:36)</a>:</h4>
<p>kk I can try to fix that with more features in <code>bindgen!</code></p>



<a name="391239751"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391239751" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391239751">(Sep 15 2023 at 18:36)</a>:</h4>
<p>The other is that <code>Resource</code> doesn't have <code>Clone</code> and sometimes we need to pass the same borrowed resource to multiple calls that need <code>Resource</code></p>



<a name="391239761"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391239761" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391239761">(Sep 15 2023 at 18:36)</a>:</h4>
<p>(not for this PR but for later)</p>



<a name="391239874"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391239874" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391239874">(Sep 15 2023 at 18:36)</a>:</h4>
<p>ok intersting, I hesitate to add <code>Clone</code> as it doesn't seem obviously correct, but it also doesn't seem obviously wrong</p>



<a name="391239891"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391239891" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391239891">(Sep 15 2023 at 18:36)</a>:</h4>
<p>Yeah, same</p>



<a name="391239939"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391239939" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391239939">(Sep 15 2023 at 18:37)</a>:</h4>
<p>This is an example of that right?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">input_stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span>
<span class="w">            </span><span class="p">.</span><span class="n">table_mut</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">push_input_stream_child</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">Resource</span>::<span class="o">&lt;</span><span class="n">tcp</span>::<span class="n">TcpSocket</span><span class="o">&gt;</span>::<span class="n">new_borrow</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">rep</span><span class="p">()))</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">output_stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span>
<span class="w">            </span><span class="p">.</span><span class="n">table_mut</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">push_output_stream_child</span><span class="p">(</span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">Resource</span>::<span class="o">&lt;</span><span class="n">tcp</span>::<span class="n">TcpSocket</span><span class="o">&gt;</span>::<span class="n">new_borrow</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">rep</span><span class="p">()))</span><span class="o">?</span><span class="p">;</span>
</code></pre></div>



<a name="391239981"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391239981" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391239981">(Sep 15 2023 at 18:37)</a>:</h4>
<p>yeah</p>



<a name="391240015"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391240015" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391240015">(Sep 15 2023 at 18:37)</a>:</h4>
<p>kk</p>



<a name="391240121"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391240121" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391240121">(Sep 15 2023 at 18:38)</a>:</h4>
<p>that's tricky b/c we're probably not managing the actual table entry there?</p>



<a name="391240189"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391240189" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391240189">(Sep 15 2023 at 18:38)</a>:</h4>
<p>actually, lemme read up a bit on this</p>



<a name="391240372"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391240372" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391240372">(Sep 15 2023 at 18:40)</a>:</h4>
<p>so question for you, <code>finish-connect: func() -&gt; result&lt;tuple&lt;input-stream, output-stream&gt;, error-code&gt;</code> -- is the intent that <code>finish-connect</code> sort of "consumes self"?</p>



<a name="391240483"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391240483" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391240483">(Sep 15 2023 at 18:40)</a>:</h4>
<p>No, the socket handle remains live after <code>finish-connect</code>, users need it to do getsockopt/setsockopt-like things</p>



<a name="391240547"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391240547" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391240547">(Sep 15 2023 at 18:41)</a>:</h4>
<p>mk, but I think it may be a bug still then, where if you call that and then close the original socket?</p>



<a name="391240594"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391240594" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391240594">(Sep 15 2023 at 18:41)</a>:</h4>
<p>hm I need to read more on <code>.push_input_stream_child</code></p>



<a name="391240792"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391240792" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391240792">(Sep 15 2023 at 18:42)</a>:</h4>
<p>hm ok this may need to get updated over time</p>



<a name="391240819"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391240819" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391240819">(Sep 15 2023 at 18:42)</a>:</h4>
<p>this is the child/parent relationships where you can't destroy the parent if the child is still alive</p>



<a name="391240959"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391240959" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391240959">(Sep 15 2023 at 18:43)</a>:</h4>
<p>I know we intentionally did this for <code>pollable</code> which is more-or-less a child-like resource though</p>



<a name="391241049"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391241049" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391241049">(Sep 15 2023 at 18:44)</a>:</h4>
<p>it's sort of beyond component-model semantics but that's not the end of the world</p>



<a name="391241489"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391241489" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391241489">(Sep 15 2023 at 18:47)</a>:</h4>
<p>When we designed the API, we imagined they'd have reference-counting-like behavior, where you could drop the socket handle and keep the streams live.</p>



<a name="391241712"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391241712" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391241712">(Sep 15 2023 at 18:49)</a>:</h4>
<p>yeah that seems more appropriate for sockets</p>



<a name="391241715"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391241715" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391241715">(Sep 15 2023 at 18:49)</a>:</h4>
<p>But right now I'm just trying to work within the existing <code>push_input_stream_child</code> behavior.</p>



<a name="391241742"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391241742" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391241742">(Sep 15 2023 at 18:49)</a>:</h4>
<p>nah yeah that's fine</p>



<a name="391241778"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391241778" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391241778">(Sep 15 2023 at 18:49)</a>:</h4>
<p>we may want to change the <code>drop_*</code> methods which delete from the table to reference count in the table itself</p>



<a name="391241823"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391241823" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391241823">(Sep 15 2023 at 18:49)</a>:</h4>
<p>so for example if you connect and then drop the socket that's ok, but the table entry is kept alive until the two other streams are also dropped and then it's finally actually removed from the table</p>



<a name="391241851"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391241851" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391241851">(Sep 15 2023 at 18:49)</a>:</h4>
<p>I think we have all the hooks to implement that and shouldn't be too bad (no need to do it in this PR of course)</p>



<a name="391251867"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391251867" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391251867">(Sep 15 2023 at 19:53)</a>:</h4>
<p>Ok, I did some porting of wasi-http but I'm encountering stuff that I don't know what to do with, so I'm going to ask around for help on those parts.</p>



<a name="391252754"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391252754" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eduardo Rodrigues <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391252754">(Sep 15 2023 at 19:59)</a>:</h4>
<p><span class="user-mention" data-user-id="254083">@Dan Gohman</span> , i believe you can ignore error coming from the legacy modules (<a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-http/src/component_impl.rs">this file</a>) as those will be completely removed really soon.</p>



<a name="391252815"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391252815" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391252815">(Sep 15 2023 at 19:59)</a>:</h4>
<p>Oh, awesome. That should clear up a lot of it.</p>



<a name="391262735"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391262735" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391262735">(Sep 15 2023 at 21:01)</a>:</h4>
<p>this change looks really great so far, all of the host changes are really simple and mechanical</p>



<a name="391279783"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391279783" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391279783">(Sep 15 2023 at 23:01)</a>:</h4>
<p>updating the preview1 adapter is... complex. Handles aren't cloneable or even dupable, so a lot of adapter code that just throws around <code>u32</code> code needs to be restructured</p>



<a name="391280394"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391280394" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391280394">(Sep 15 2023 at 23:03)</a>:</h4>
<p>One option could be to add an off-by-default option to the rust generator to add <code>Copy</code> and remove the <code>Drop</code> implementation to assist with this</p>



<a name="391296934"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391296934" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391296934">(Sep 16 2023 at 01:00)</a>:</h4>
<p>arg, so close</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
      <span class="nc">unsupported</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">adapter</span><span class="w"> </span><span class="n">module</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">programs</span><span class="o">/</span><span class="n">build</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">232</span>:<span class="mi">10</span>
</code></pre></div>
<p><span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="391718275"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391718275" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391718275">(Sep 18 2023 at 14:55)</a>:</h4>
<p><span class="user-mention" data-user-id="253994">@Alex Crichton</span> I'm seeing crates/test-programs/wasi-tests/src/bin/sleep.rs fail with "unknown handle index 1048096', crates/test-programs/tests/wasi-preview2-components.rs:284:30". 1048096 happens to be the address of the <code>Pollable</code>  in the guest. It looks like a disagreement about the lowering of <code>list&lt;borrow&lt;Pollable&gt;&gt;</code> between the Rust guest bindings where it's an array of <code>&amp;Pollable</code> and the host bindings which appear to want an array of <code>Pollable</code>.</p>



<a name="391718762"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391718762" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391718762">(Sep 18 2023 at 14:57)</a>:</h4>
<p>got a command to repro?</p>



<a name="391718778"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391718778" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391718778">(Sep 18 2023 at 14:57)</a>:</h4>
<p>definitely sounds like a bindgen issue</p>



<a name="391718867"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391718867" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391718867">(Sep 18 2023 at 14:58)</a>:</h4>
<p>on the PR branch, <code>cargo test --features "test-programs/test_programs" --package test-programs sleep</code></p>



<a name="391719590"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391719590" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391719590">(Sep 18 2023 at 15:01)</a>:</h4>
<p>hm ok I get a failure</p>



<a name="391719683"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391719683" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391719683">(Sep 18 2023 at 15:01)</a>:</h4>
<p>not <code>unknown handle index</code> though</p>



<a name="391719880"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391719880" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391719880">(Sep 18 2023 at 15:02)</a>:</h4>
<p>Do you have my latest branch changes?</p>



<a name="391719992"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391719992" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391719992">(Sep 18 2023 at 15:03)</a>:</h4>
<p>yeah</p>



<a name="391720026"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391720026" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391720026">(Sep 18 2023 at 15:03)</a>:</h4>
<p>er, 6dea64a708b25bb1c29216e050ddfeb512d3af29</p>



<a name="391720167"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391720167" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391720167">(Sep 18 2023 at 15:04)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">running</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">test</span>
<span class="n">calling</span><span class="w"> </span><span class="n">subscribe</span>
<span class="p">[</span><span class="n">crates</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">programs</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sleep</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">14</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x000ffe20</span>
<span class="p">[</span><span class="n">crates</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">programs</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sleep</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">16</span><span class="p">]</span><span class="w"> </span><span class="n">list</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x000ffea8</span>
<span class="n">calling</span><span class="w"> </span><span class="n">poll</span>
<span class="n">test</span><span class="w"> </span><span class="n">sleep</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">FAILED</span>

<span class="n">failures</span>:

<span class="o">----</span><span class="w"> </span><span class="n">sleep</span><span class="w"> </span><span class="n">stdout</span><span class="w"> </span><span class="o">----</span>
<span class="n">preopen</span>: <span class="nc">TempDir</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">path</span>: <span class="s">"/var/folders/70/cx6_8hz93jz7kj_km0_5c9_40000gn/T/wasi_components_sleep_ZBEXxT"</span><span class="w"> </span><span class="p">}</span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">sleep</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Result</span>::<span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="nb">Err</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>: <span class="nc">error</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">executing</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span>:
    <span class="mi">0</span>: <span class="mh">0x217824</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wit</span><span class="o">-</span><span class="n">component</span>:<span class="nc">shim</span><span class="o">!</span><span class="n">indirect</span><span class="o">-</span><span class="n">wasi</span>:<span class="nc">io</span><span class="o">/</span><span class="n">poll</span><span class="o">-</span><span class="n">poll</span><span class="o">-</span><span class="n">list</span>
<span class="w">    </span><span class="mi">1</span>: <span class="mh">0x137a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sleep</span>::<span class="n">wasi</span>::<span class="n">io</span>::<span class="n">poll</span>::<span class="n">poll_list</span>::<span class="n">h0c3ff0fbc74b0bb0</span>
<span class="w">                    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">alex</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">programs</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sleep</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">3</span>:<span class="mi">1</span>
<span class="w">    </span><span class="mi">2</span>: <span class="mh">0x1a68</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sleep</span>::<span class="n">main</span>::<span class="n">h05f297b3af9f1f16</span>
<span class="w">                    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">alex</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">programs</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sleep</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">18</span>:<span class="mi">5</span>
<span class="w">    </span><span class="mi">3</span>: <span class="mh">0x1ce4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">ops</span>::<span class="n">function</span>::<span class="nb">FnOnce</span>::<span class="n">call_once</span>::<span class="n">h59e587ee50bf110f</span>
<span class="w">                    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">5680</span><span class="n">fa18feaa87f3ff04063800aec256c3d4b4be</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ops</span><span class="o">/</span><span class="n">function</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">250</span>:<span class="mi">5</span>
<span class="w">    </span><span class="mi">4</span>: <span class="mh">0x1110</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">__rust_begin_short_backtrace</span>::<span class="n">h68fc03414118ad34</span>
<span class="w">                    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">5680</span><span class="n">fa18feaa87f3ff04063800aec256c3d4b4be</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sys_common</span><span class="o">/</span><span class="n">backtrace</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">135</span>:<span class="mi">18</span>
<span class="w">    </span><span class="mi">5</span>:  <span class="mh">0xefe</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h30274f7edf3867b2</span>
<span class="w">                    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">5680</span><span class="n">fa18feaa87f3ff04063800aec256c3d4b4be</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rt</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">166</span>:<span class="mi">18</span>
<span class="w">    </span><span class="mi">6</span>: <span class="mh">0x3b3b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">ops</span>::<span class="n">function</span>::<span class="n">impls</span>::<span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">core</span>::<span class="n">ops</span>::<span class="n">function</span>::<span class="nb">FnOnce</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">&amp;</span><span class="n">F</span><span class="o">&gt;</span>::<span class="n">call_once</span>::<span class="n">h644be9b9b3cfec3d</span>
<span class="w">                    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">5680</span><span class="n">fa18feaa87f3ff04063800aec256c3d4b4be</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ops</span><span class="o">/</span><span class="n">function</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">284</span>:<span class="mi">13</span><span class="w">              </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">panicking</span>::<span class="kr">try</span>::<span class="n">do_call</span>::<span class="n">h1664f3cfdc3cc4ba</span>
<span class="w">                    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">5680</span><span class="n">fa18feaa87f3ff04063800aec256c3d4b4be</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">500</span>:<span class="mi">40</span><span class="w">              </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">panicking</span>::<span class="kr">try</span>::<span class="n">h92522218794dbe07</span>
<span class="w">                    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">5680</span><span class="n">fa18feaa87f3ff04063800aec256c3d4b4be</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">464</span>:<span class="mi">19</span><span class="w">              </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">panic</span>::<span class="n">catch_unwind</span>::<span class="n">h09082efce4044946</span>
<span class="w">                    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">5680</span><span class="n">fa18feaa87f3ff04063800aec256c3d4b4be</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panic</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">142</span>:<span class="mi">14</span><span class="w">              </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start_internal</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h96d2e1cd5d5fb964</span>
<span class="n">error</span>: <span class="nc">test</span><span class="w"> </span><span class="n">failed</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">rerun</span><span class="w"> </span><span class="n">pass</span><span class="w"> </span><span class="err">`</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">test</span><span class="o">-</span><span class="n">programs</span><span class="w"> </span><span class="o">--</span><span class="n">test</span><span class="w"> </span><span class="n">wasi</span><span class="o">-</span><span class="n">preview2</span><span class="o">-</span><span class="n">components</span><span class="err">`</span>
</code></pre></div>



<a name="391720183"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391720183" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391720183">(Sep 18 2023 at 15:04)</a>:</h4>
<p>that's all I'm seeing</p>



<a name="391720255"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391720255" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391720255">(Sep 18 2023 at 15:04)</a>:</h4>
<p>something looks suppressed by accident</p>



<a name="391720361"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391720361" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391720361">(Sep 18 2023 at 15:04)</a>:</h4>
<p>I think stdout is being switched to nonblocking</p>



<a name="391720370"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391720370" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391720370">(Sep 18 2023 at 15:04)</a>:</h4>
<p>b/c I saw a panic about that</p>



<a name="391720717"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391720717" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391720717">(Sep 18 2023 at 15:06)</a>:</h4>
<p>huh, I'm not sure what's happening</p>



<a name="391720855"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391720855" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391720855">(Sep 18 2023 at 15:07)</a>:</h4>
<p>intermittently I see </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">running</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">test</span>
<span class="n">calling</span><span class="w"> </span><span class="n">subscribe</span>
<span class="p">[</span><span class="n">crates</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">programs</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sleep</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">14</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x000ffe20</span>
<span class="p">[</span><span class="n">crates</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">programs</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sleep</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">16</span><span class="p">]</span><span class="w"> </span><span class="n">list</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x000ffea8</span>
<span class="n">calling</span><span class="w"> </span><span class="n">poll</span>
<span class="n">test</span><span class="w"> </span><span class="n">sleep</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">FAILED</span>

<span class="n">failures</span>:

<span class="o">----</span><span class="w"> </span><span class="n">sleep</span><span class="w"> </span><span class="n">stdout</span><span class="w"> </span><span class="o">----</span>
<span class="n">preopen</span>: <span class="nc">TempDir</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">path</span>: <span class="s">"/var/folders/70/cx6_8hz93jz7kj_km0_5c9_40000gn/T/wasi_components_sleep_7s0B4k"</span><span class="w"> </span><span class="p">}</span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">sleep</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Result</span>::<span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="nb">Err</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>: <span class="nc">error</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">executing</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span>:
    <span class="mi">0</span>: <span class="mh">0x217824</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wit</span><span class="o">-</span><span class="n">component</span>:<span class="nc">shim</span><span class="o">!</span><span class="n">indirect</span><span class="o">-</span><span class="n">wasi</span>:<span class="nc">io</span><span class="o">/</span><span class="n">poll</span><span class="o">-</span><span class="n">poll</span><span class="o">-</span><span class="n">list</span>
<span class="w">    </span><span class="mi">1</span>: <span class="mh">0x137a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sleep</span>::<span class="n">wasi</span>::<span class="n">io</span>::<span class="n">poll</span>::<span class="n">poll_list</span>::<span class="n">h0c3ff0fbc74b0bb0</span>
<span class="w">                    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">alex</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">programs</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sleep</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">3</span>:<span class="mi">1</span>
<span class="w">    </span><span class="mi">2</span>: <span class="mh">0x1a68</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sleep</span>::<span class="n">main</span>::<span class="n">h05f297b3af9f1f16</span>
<span class="w">                    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">alex</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">programs</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sleep</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">18</span>:<span class="mi">5</span>
<span class="w">    </span><span class="mi">3</span>: <span class="mh">0x1ce4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">ops</span>::<span class="n">function</span>::<span class="nb">FnOnce</span>::<span class="n">call_once</span>::<span class="n">h59e587ee50bf110f</span>
<span class="w">                    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">5680</span><span class="n">fa18feaa87f3ff04063800aec256c3d4b4be</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ops</span><span class="o">/</span><span class="n">function</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">250</span>:<span class="mi">5</span>
<span class="w">    </span><span class="mi">4</span>: <span class="mh">0x1110</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">__rust_begin_short_backtrace</span>::<span class="n">h68fc03414118ad34</span>
<span class="w">                    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">5680</span><span class="n">fa18feaa87f3ff04063800aec256c3d4b4be</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sys_common</span><span class="o">/</span><span class="n">backerror</span>: <span class="nc">io</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">listing</span><span class="w"> </span><span class="n">tests</span>: <span class="nc">Os</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">code</span>: <span class="mi">35</span><span class="p">,</span><span class="w"> </span><span class="n">kind</span>: <span class="nc">WouldBlock</span><span class="p">,</span><span class="w"> </span><span class="n">message</span>: <span class="s">"Resource temporarily unavailable"</span><span class="w"> </span><span class="p">}</span>
<span class="n">trace</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">135</span>:<span class="mi">18</span>
<span class="w">    </span><span class="mi">5</span>:  <span class="mh">0xefe</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h30274f7edf3867b2</span>
<span class="w">                    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">5680</span><span class="n">fa18feaa87f3ff04063800aec256c3d4b4be</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rt</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">166</span>:<span class="mi">18</span>
<span class="w">    </span><span class="mi">6</span>: <span class="mh">0x3b3b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">ops</span>::<span class="n">function</span>::<span class="n">impls</span>::<span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">core</span>::<span class="n">ops</span>::<span class="n">function</span>::<span class="nb">FnOnce</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">&amp;</span><span class="n">F</span><span class="o">&gt;</span>::<span class="n">call_once</span>::<span class="n">h644be9b9b3cfec3d</span>
<span class="w">                    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">5680</span><span class="n">fa18feaa87f3ff04063800aec256c3d4b4be</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ops</span><span class="o">/</span><span class="n">function</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">284</span>:<span class="mi">13</span><span class="w">              </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">panicking</span>::<span class="kr">try</span>::<span class="n">do_call</span>::<span class="n">h1664f3cfdc3cc4ba</span>
<span class="w">                    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">5680</span><span class="n">fa18feaa87f3ff04063800aec256c3d4b4be</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">500</span>:<span class="mi">40</span><span class="w">              </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">panicking</span>::<span class="kr">try</span>::<span class="n">h92522218794dbe07</span>
<span class="w">                    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">5680</span><span class="n">fa18feaa87f3ff04063800aec256c3d4b4be</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">464</span>:<span class="mi">19</span><span class="w">              </span><span class="o">-</span><span class="w"> </span><span class="n">std</span>::<span class="n">panic</span>::<span class="n">catch_unwind</span>::<span class="n">h09082efce4044946</span>
<span class="w">                    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">5680</span><span class="n">fa18feaa87f3ff04063800aec256c3d4b4be</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panic</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1</span><span class="n">error</span>: <span class="nc">test</span><span class="w"> </span><span class="n">failed</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">rerun</span><span class="w"> </span><span class="n">pass</span><span class="w"> </span><span class="err">`</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">test</span><span class="o">-</span><span class="n">programs</span><span class="w"> </span><span class="o">--</span><span class="n">test</span><span class="w"> </span><span class="n">wasi</span><span class="o">-</span><span class="n">preview2</span><span class="o">-</span><span class="n">components</span><span class="err">`</span>
</code></pre></div>



<a name="391720885"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391720885" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391720885">(Sep 18 2023 at 15:07)</a>:</h4>
<p>which is rust panicking about stdout being nonblocking I think</p>



<a name="391720919"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391720919" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391720919">(Sep 18 2023 at 15:07)</a>:</h4>
<p>which would also explain the truncated error</p>



<a name="391721191"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391721191" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391721191">(Sep 18 2023 at 15:09)</a>:</h4>
<p>I have enabled <code>inherit_stdout</code> and <code>inherit_stderr</code> for that test, just to be able to see the debug prints. Maybe the test is consuming the host process stdout and stderr.</p>



<a name="391721314"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391721314" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391721314">(Sep 18 2023 at 15:09)</a>:</h4>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/crates/test-programs/tests/wasi-preview2-components.rs b/crates/test-programs/tes</span>
ts/wasi-preview2-components.rs
<span class="gh">index 7834562b6..1ff6a6ff5 100644</span>
<span class="gd">--- a/crates/test-programs/tests/wasi-preview2-components.rs</span>
<span class="gi">+++ b/crates/test-programs/tests/wasi-preview2-components.rs</span>
<span class="gu">@@ -281,7 +281,7 @@ async fn sched_yield() {</span>
<span class="w"> </span>}
<span class="w"> </span>#[test_log::test(tokio::test(flavor = "multi_thread"))]
<span class="w"> </span>async fn sleep() {
<span class="gd">-    run("sleep", false).await.unwrap()</span>
<span class="gi">+    run("sleep", true).await.unwrap() // FIXME: temporarily enable stdio for debugging</span>
<span class="w"> </span>}
<span class="w"> </span>#[test_log::test(tokio::test(flavor = "multi_thread"))]
<span class="w"> </span>async fn stdio() {
</code></pre></div>



<a name="391721472"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391721472" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391721472">(Sep 18 2023 at 15:10)</a>:</h4>
<p>Maybe revert that part, and see if it fixes the test harness stdio?</p>



<a name="391721556"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391721556" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391721556">(Sep 18 2023 at 15:10)</a>:</h4>
<p>hm no this appears to be macos specific</p>



<a name="391721590"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391721590" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391721590">(Sep 18 2023 at 15:10)</a>:</h4>
<p>on Linux I get the full error with an unknown handle</p>



<a name="391721622"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391721622" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391721622">(Sep 18 2023 at 15:11)</a>:</h4>
<p>I'll hunt down the macos bug later</p>



<a name="391722382"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391722382" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391722382">(Sep 18 2023 at 15:14)</a>:</h4>
<p>ok yeah definitely a bug in bindgen</p>



<a name="391722502"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391722502" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391722502">(Sep 18 2023 at 15:15)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">package</span><span class="w"> </span><span class="n">foo</span>:<span class="nc">bar</span>
<span class="n">world</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">resource</span><span class="w"> </span><span class="n">x</span>
<span class="w">  </span><span class="n">import</span><span class="w"> </span><span class="n">y</span>: <span class="nc">func</span><span class="p">(</span><span class="n">a</span>: <span class="nc">list</span><span class="o">&lt;</span><span class="n">borrow</span><span class="o">&lt;</span><span class="n">x</span><span class="o">&gt;&gt;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>generates:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">y</span><span class="p">(</span><span class="n">a</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="o">&amp;</span><span class="n">X</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cp">#[allow(unused_imports)]</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">wit_bindgen</span>::<span class="n">rt</span>::<span class="p">{</span><span class="n">alloc</span><span class="p">,</span><span class="w"> </span><span class="n">string</span>::<span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">vec</span>::<span class="nb">Vec</span><span class="p">};</span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">vec0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">ptr0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec0</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">len0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec0</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span>

<span class="w">        </span><span class="cp">#[cfg(target_arch = </span><span class="s">"wasm32"</span><span class="cp">)]</span>
<span class="w">        </span><span class="cp">#[link(wasm_import_module = </span><span class="s">"$root"</span><span class="cp">)]</span>
<span class="w">        </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="cp">#[link_name = </span><span class="s">"y"</span><span class="cp">]</span>
<span class="w">            </span><span class="k">fn</span> <span class="nf">wit_import</span><span class="p">(</span><span class="n">_</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_</span>: <span class="kt">i32</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="cp">#[cfg(not(target_arch = </span><span class="s">"wasm32"</span><span class="cp">))]</span>
<span class="w">        </span><span class="k">fn</span> <span class="nf">wit_import</span><span class="p">(</span><span class="n">_</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="fm">unreachable!</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">wit_import</span><span class="p">(</span><span class="n">ptr0</span><span class="p">,</span><span class="w"> </span><span class="n">len0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>



<a name="391722733"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391722733" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391722733">(Sep 18 2023 at 15:16)</a>:</h4>
<p>I'd hand-write the bindings for <code>poll_list</code> for now instead</p>



<a name="391722743"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391722743" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391722743">(Sep 18 2023 at 15:16)</a>:</h4>
<p>while I work on this</p>



<a name="391722859"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391722859" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391722859">(Sep 18 2023 at 15:17)</a>:</h4>
<p>Ok, I can do that. The adapter already does this, so it's straightforward.</p>



<a name="391724956"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391724956" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391724956">(Sep 18 2023 at 15:27)</a>:</h4>
<p>mind giving a thumbs up on <a href="https://github.com/bytecodealliance/wit-bindgen/pull/669">https://github.com/bytecodealliance/wit-bindgen/pull/669</a>? The fix for this will use some bits there</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/pull/669" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/40821a8e72f91f58ecf329b3d324b7afe49680a1\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f346531303461323666356664343965323561343462373133366638383830353865363631383432313935336361303733356666643937396562373563363764662f62797465636f6465616c6c69616e63652f7769742d62696e6467656e2f70756c6c2f363639)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/pull/669" title="Fix taking owned resource handles in Rust imports by alexcrichton · Pull Request #669 · bytecodealliance/wit-bindgen">Fix taking owned resource handles in Rust imports by alexcrichton · Pull Request #669 · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">I went ahead and did a bit more refactoring at the logic here since I think the old conditions aren't as applicable any more (they haven't aged well)
Closes #668</div></div></div>



<a name="391725200"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391725200" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391725200">(Sep 18 2023 at 15:28)</a>:</h4>
<p>/me looks</p>



<a name="391725686"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391725686" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391725686">(Sep 18 2023 at 15:31)</a>:</h4>
<p><span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span></p>



<a name="391747487"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391747487" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391747487">(Sep 18 2023 at 17:38)</a>:</h4>
<p>ok I think <a href="https://github.com/bytecodealliance/wit-bindgen/pull/670">https://github.com/bytecodealliance/wit-bindgen/pull/670</a> fixes the issue here</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/pull/670" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/53eef245871098589d0d23f7e2ef5706fd3ffcd9\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f306236353933623730333332666335616565636536353863356331613861646135396138666637643832663536626538303733306536353337326135653835612f62797465636f6465616c6c69616e63652f7769742d62696e6467656e2f70756c6c2f363730)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/pull/670" title="Fix generated bindings for list-of-borrows by alexcrichton · Pull Request #670 · bytecodealliance/wit-bindgen">Fix generated bindings for list-of-borrows by alexcrichton · Pull Request #670 · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">This commit fixes an issue for imported functions taking list&lt;borrow&lt;T&gt;&gt; arguments. Previously they were erroneously passed through as lists-of-pointers and now they're correctly mapped to list-of-...</div></div></div>



<a name="391747514"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391747514" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391747514">(Sep 18 2023 at 17:39)</a>:</h4>
<p>although if possible I'd still recommend decoupling that PR from yours</p>



<a name="391747540"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391747540" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391747540">(Sep 18 2023 at 17:39)</a>:</h4>
<p>and just leave a comment for it to get cleaned up later</p>



<a name="391748169"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391748169" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391748169">(Sep 18 2023 at 17:42)</a>:</h4>
<p>Thanks!</p>



<a name="391748552"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391748552" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391748552">(Sep 18 2023 at 17:44)</a>:</h4>
<p>Did you mention earlier that it might be possible to unify the resource types between the sync and async bindings? Right now, running commands on the wasmtime CLI on my branch fails because the stdio stream types now involve resources, and the wasmtime CLI uses the sync bindings, so it's expecting different resource types.</p>



<a name="391753368"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391753368" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391753368">(Sep 18 2023 at 18:19)</a>:</h4>
<p>can't do that yet but I'm going to work on that next</p>



<a name="391753629"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391753629" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391753629">(Sep 18 2023 at 18:20)</a>:</h4>
<p>ok, cool, yeah, no rush there</p>



<a name="391767746"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391767746" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391767746">(Sep 18 2023 at 20:11)</a>:</h4>
<p>ok my truncated error message this morning was <a href="https://github.com/bytecodealliance/wasmtime/pull/7058">https://github.com/bytecodealliance/wasmtime/pull/7058</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/7058" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/082060a7c643f5f5a42db3eaf29c80cad462793a\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f313330363864323137333334613235363636316433323763333266663865613530313736363064333938343764623364616134643865666161633339323166622f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f37303538)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/7058" title="Force usage of a worker thread for stdin on all platforms by alexcrichton · Pull Request #7058 · bytecodealliance/wasmtime">Force usage of a worker thread for stdin on all platforms by alexcrichton · Pull Request #7058 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">This commit is a follow-up to #6833 to remove the unix module for handling stdio which sets stdin to nonblocking mode. I've just now discovered that on macOS at least configuring O_NONBLOCK for std...</div></div></div>



<a name="391778942"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391778942" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391778942">(Sep 18 2023 at 21:36)</a>:</h4>
<p>With my latest push, all of test-programs passes!</p>



<a name="391779417"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391779417" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391779417">(Sep 18 2023 at 21:40)</a>:</h4>
<p>I compiled a wit-bindgen with <a href="https://github.com/bytecodealliance/wit-bindgen/issues/670">bytecodealliance/wit-bindgen#670</a> and copied in the bindings, so I can confirm that that fixes the problem I was seeing.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/issues/670" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/c84c950e12b6e2f993db60a6aba471a11edb043a\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f363862333065663863306564656461653438373834666333353630393665643637383537343662336331303862373334633930316263613864346635333535352f62797465636f6465616c6c69616e63652f7769742d62696e6467656e2f70756c6c2f363730)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/issues/670" title="Fix generated bindings for list-of-borrows by alexcrichton · Pull Request #670 · bytecodealliance/wit-bindgen">Fix generated bindings for list-of-borrows by alexcrichton · Pull Request #670 · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">This commit fixes an issue for imported functions taking list&lt;borrow&lt;T&gt;&gt; arguments. Previously they were erroneously passed through as lists-of-pointers and now they're correctly mapped to list-of-...</div></div></div>



<a name="391779520"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391779520" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391779520">(Sep 18 2023 at 21:41)</a>:</h4>
<p>nice</p>



<a name="391779550"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391779550" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391779550">(Sep 18 2023 at 21:41)</a>:</h4>
<p>once that's in I can publish so it can get pulled in</p>



<a name="391783717"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391783717" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391783717">(Sep 18 2023 at 22:16)</a>:</h4>
<p>ok wit-bindgen is now published</p>



<a name="391958987"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391958987" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391958987">(Sep 19 2023 at 17:14)</a>:</h4>
<p><span class="user-mention" data-user-id="254083">@Dan Gohman</span> I've got some cleanups and various changes to the preview1 adapter, would you like me to PR them or would it be ok to push up to the PR?</p>



<a name="391959008"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391959008" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391959008">(Sep 19 2023 at 17:14)</a>:</h4>
<p>or alternatively if you're working on this area I'll let you go gangbuster</p>



<a name="391959085"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391959085" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391959085">(Sep 19 2023 at 17:15)</a>:</h4>
<p>I'm in the middle of trying to reorganize things to fix the <code>&amp;mut Descriptors</code> problem</p>



<a name="391959127"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391959127" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391959127">(Sep 19 2023 at 17:15)</a>:</h4>
<p>ok I'll wait for that</p>



<a name="391959219"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391959219" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391959219">(Sep 19 2023 at 17:16)</a>:</h4>
<p>I had a rough idea there which was to use <code>&amp;[RefCell&lt;Descriptor&gt;]</code></p>



<a name="391959255"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391959255" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391959255">(Sep 19 2023 at 17:16)</a>:</h4>
<p>and then <code>get_file</code> etc methods would return <code>Result&lt;Ref&lt;'_, File&gt;&gt;</code></p>



<a name="391959277"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391959277" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391959277">(Sep 19 2023 at 17:16)</a>:</h4>
<p>I didn't actually implement it fully though</p>



<a name="391959476"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391959476" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391959476">(Sep 19 2023 at 17:17)</a>:</h4>
<p>Oh, interesting. That might be better than my idea, which was to make <code>descriptors()</code> and <code>descriptors_mut()</code> take a closure that gets passed the <code>Descriptors</code> object.</p>



<a name="391959777"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391959777" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391959777">(Sep 19 2023 at 17:19)</a>:</h4>
<p>yeah my thinking was that ideally we shy away from all <code>unsafe</code> code and stick to libstd/libcore primitives if possible</p>



<a name="391959950"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391959950" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391959950">(Sep 19 2023 at 17:20)</a>:</h4>
<p>That's obviously good in theory, but I keep trying to use <code>RefCell</code> in various ways and it keeps not working :-}.</p>



<a name="391959987"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391959987" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391959987">(Sep 19 2023 at 17:20)</a>:</h4>
<p>But your idea of pushing it down into the array might work out better.</p>



<a name="391959993"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391959993" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391959993">(Sep 19 2023 at 17:20)</a>:</h4>
<p>nah yeah I know what you mean</p>



<a name="391960299"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391960299" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391960299">(Sep 19 2023 at 17:22)</a>:</h4>
<p>How would the <code>&amp;[RefCell&lt;Descriptor&gt;]</code> case handle adding a new descriptor to the table?</p>



<a name="391960441"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391960441" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391960441">(Sep 19 2023 at 17:23)</a>:</h4>
<p>oh I thought we already had unsafe bits for that</p>



<a name="391960469"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391960469" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391960469">(Sep 19 2023 at 17:23)</a>:</h4>
<p>like a cap pointer which we bumped and <code>ptr::write</code>-ed the new value into</p>



<a name="391960588"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/391960588" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#391960588">(Sep 19 2023 at 17:24)</a>:</h4>
<p>ah yeah <code>push</code> is already unsafe in that regard which I think is fine to keep</p>



<a name="392172976"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/wasi%20bindings%20module%20in%20wasmtime/near/392172976" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/wasi.20bindings.20module.20in.20wasmtime.html#392172976">(Sep 20 2023 at 18:30)</a>:</h4>
<p>ok I've pushed up configuration of resources in <a href="https://github.com/bytecodealliance/wasmtime/pull/7069">https://github.com/bytecodealliance/wasmtime/pull/7069</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/7069" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/36fc2332cf4b7f18b5949e9a2b1ebb9ba49366b9\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f646630353661336431343137663361313731393534316562346536323736383262303038353539393264333966636431646234363966333139396535356366382f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f37303639)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/7069" title="Support resource maps in `component::bindgen!` by alexcrichton · Pull Request #7069 · bytecodealliance/wasmtime">Support resource maps in `component::bindgen!` by alexcrichton · Pull Request #7069 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">This commit adds support to component::bindgen! to specify resource types using the with key of the macro. This can be used to configure the T of Resource&lt;T&gt; to use a preexisting type rather than u...</div></div></div>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>