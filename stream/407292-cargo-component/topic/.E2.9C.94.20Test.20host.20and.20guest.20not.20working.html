<html>
<head><meta charset="utf-8"><title>✔ Test host and guest not working · cargo-component · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/index.html">cargo-component</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html">✔ Test host and guest not working</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="430585705"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430585705" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alen <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430585705">(Apr 01 2024 at 12:32)</a>:</h4>
<p>I've created a test wasmtime host and a test guest with cargo component. The world definition is as follows:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">package</span><span class="w"> </span><span class="n">local</span>:<span class="nc">test</span><span class="o">-</span><span class="n">guest</span><span class="p">;</span>

<span class="n">interface</span><span class="w"> </span><span class="n">string</span><span class="o">-</span><span class="n">modifier</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">edit</span><span class="o">-</span><span class="n">string</span>: <span class="nc">func</span><span class="p">(</span><span class="n">input</span><span class="o">-</span><span class="n">string</span>: <span class="nc">string</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">interface</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">name</span>: <span class="nc">func</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="sd">/// An example world for the component to target.</span>
<span class="n">world</span><span class="w"> </span><span class="n">test</span><span class="o">-</span><span class="n">world</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">import</span><span class="w"> </span><span class="n">host</span><span class="p">;</span>
<span class="w">    </span><span class="n">export</span><span class="w"> </span><span class="n">string</span><span class="o">-</span><span class="n">modifier</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>The host code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">component</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="p">{</span><span class="n">Config</span><span class="p">,</span><span class="w"> </span><span class="n">Engine</span><span class="p">,</span><span class="w"> </span><span class="n">Store</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">local</span>::<span class="n">test_guest</span>::<span class="n">host</span>::<span class="n">Host</span><span class="p">;</span>

<span class="n">component</span>::<span class="n">bindgen</span><span class="o">!</span><span class="p">();</span>

<span class="k">struct</span> <span class="nc">MyState</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">name</span>: <span class="nb">String</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyState</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">name</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">wasmtime</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">clone</span><span class="p">())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">wasmtime</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">wasm_component_model</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">component</span>::<span class="n">Component</span>::<span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="s">"./test_guest.wasm"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">component</span>::<span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="w">    </span><span class="n">TestWorld</span>::<span class="n">add_to_linker</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">state</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">MyState</span><span class="o">|</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span>
<span class="w">        </span><span class="n">MyState</span><span class="p">{</span>
<span class="w">            </span><span class="n">name</span>: <span class="s">"TestHost"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">bindings</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestWorld</span>::<span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">component</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">linker</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bindings</span><span class="p">.</span><span class="n">local_test_guest_string_modifier</span><span class="p">().</span><span class="n">call_edit_string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="s">"Hello test"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="n">output</span><span class="p">);</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<p>The guest code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[allow(warnings)]</span>
<span class="k">mod</span> <span class="nn">bindings</span><span class="p">;</span>

<span class="k">use</span><span class="w"> </span><span class="n">bindings</span>::<span class="n">exports</span>::<span class="n">local</span>::<span class="n">test_guest</span>::<span class="n">string_modifier</span>::<span class="n">Guest</span><span class="p">;</span>

<span class="k">struct</span> <span class="nc">Component</span><span class="p">;</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Guest</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Component</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">edit_string</span><span class="p">(</span><span class="n">s</span>: <span class="nb">String</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{</span>
<span class="w">        </span><span class="n">s</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"test"</span><span class="p">,</span><span class="w"> </span><span class="s">"World"</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">bindings</span>::<span class="n">export</span><span class="o">!</span><span class="p">(</span><span class="n">Component</span><span class="w"> </span><span class="n">with_types_in</span><span class="w"> </span><span class="n">bindings</span><span class="p">);</span>
</code></pre></div>
<p>When I generate the .wasm file with <code>cargo component build -r</code>, <code>wasm-tools component wit target/wasm32-wasi/release/test_guest.wasm</code> reveals the following world:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">package</span><span class="w"> </span><span class="n">root</span>:<span class="nc">component</span><span class="p">;</span>

<span class="n">world</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">import</span><span class="w"> </span><span class="n">wasi</span>:<span class="nc">cli</span><span class="o">/</span><span class="n">environment</span><span class="o">@</span><span class="mf">0.2.0</span><span class="p">;</span>
<span class="w">  </span><span class="n">import</span><span class="w"> </span><span class="n">wasi</span>:<span class="nc">cli</span><span class="o">/</span><span class="n">exit</span><span class="o">@</span><span class="mf">0.2.0</span><span class="p">;</span>
<span class="w">  </span><span class="n">import</span><span class="w"> </span><span class="n">wasi</span>:<span class="nc">io</span><span class="o">/</span><span class="n">error</span><span class="o">@</span><span class="mf">0.2.0</span><span class="p">;</span>
<span class="w">  </span><span class="n">import</span><span class="w"> </span><span class="n">wasi</span>:<span class="nc">io</span><span class="o">/</span><span class="n">streams</span><span class="o">@</span><span class="mf">0.2.0</span><span class="p">;</span>
<span class="w">  </span><span class="n">import</span><span class="w"> </span><span class="n">wasi</span>:<span class="nc">cli</span><span class="o">/</span><span class="n">stdin</span><span class="o">@</span><span class="mf">0.2.0</span><span class="p">;</span>
<span class="w">  </span><span class="n">import</span><span class="w"> </span><span class="n">wasi</span>:<span class="nc">cli</span><span class="o">/</span><span class="n">stdout</span><span class="o">@</span><span class="mf">0.2.0</span><span class="p">;</span>
<span class="w">  </span><span class="n">import</span><span class="w"> </span><span class="n">wasi</span>:<span class="nc">cli</span><span class="o">/</span><span class="n">stderr</span><span class="o">@</span><span class="mf">0.2.0</span><span class="p">;</span>
<span class="w">  </span><span class="n">import</span><span class="w"> </span><span class="n">wasi</span>:<span class="nc">clocks</span><span class="o">/</span><span class="n">wall</span><span class="o">-</span><span class="n">clock</span><span class="o">@</span><span class="mf">0.2.0</span><span class="p">;</span>
<span class="w">  </span><span class="n">import</span><span class="w"> </span><span class="n">wasi</span>:<span class="nc">filesystem</span><span class="o">/</span><span class="n">types</span><span class="o">@</span><span class="mf">0.2.0</span><span class="p">;</span>
<span class="w">  </span><span class="n">import</span><span class="w"> </span><span class="n">wasi</span>:<span class="nc">filesystem</span><span class="o">/</span><span class="n">preopens</span><span class="o">@</span><span class="mf">0.2.0</span><span class="p">;</span>

<span class="w">  </span><span class="n">export</span><span class="w"> </span><span class="n">local</span>:<span class="nc">test</span><span class="o">-</span><span class="n">guest</span><span class="o">/</span><span class="n">string</span><span class="o">-</span><span class="n">modifier</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>For some reason, the wasi imports don't seem to be pruned despite not being used. From what I understand, cargo component is supposed to remove them?<br>
When I try to run the resulting component with the test host, it throws the following error:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Error</span>: <span class="nc">import</span><span class="w"> </span><span class="err">`</span><span class="n">wasi</span>:<span class="nc">cli</span><span class="o">/</span><span class="n">environment</span><span class="o">@</span><span class="mf">0.2.0</span><span class="err">`</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">wrong</span><span class="w"> </span><span class="k">type</span>

<span class="nc">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="mi">0</span>: <span class="nc">instance</span><span class="w"> </span><span class="n">export</span><span class="w"> </span><span class="err">`</span><span class="n">get</span><span class="o">-</span><span class="n">environment</span><span class="err">`</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">wrong</span><span class="w"> </span><span class="k">type</span>
    <span class="mi">1</span>: <span class="nc">expected</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="n">nothing</span>
</code></pre></div>
<p>So, it seems that the component wants to import wasi interfaces that the host doesn't provide, even though the wasi imports are unused. I've tried manually specifying the wasi_snapshot_preview1.reactor.wasm adapter, but that didn't change anything. Is this a bug or am I missing something?<br>
Versions:</p>
<ul>
<li>wasmtime 19.0.0</li>
<li>cargo-component-component 0.10.1 (wasi:ab5a448)</li>
</ul>



<a name="430596073"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430596073" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sekhar Ravinutala <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430596073">(Apr 01 2024 at 13:53)</a>:</h4>
<p>This happened to me too. You need to also add command to the linker.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">wasmtime_wasi</span>::<span class="n">command</span>::<span class="n">sync</span>::<span class="n">add_to_linker</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</code></pre></div>



<a name="430597716"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430597716" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alen <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430597716">(Apr 01 2024 at 14:05)</a>:</h4>
<p><span class="user-mention" data-user-id="704210">@Sekhar Ravinutala</span> Wouldn't that effectively break guest isolation? Also, in the project I want to use the component model in, I'll be using a custom state and implementing multiple function imports. That seems to clash with wasi because the <code>add_to_linker</code> you refer to expects state to implement <code>WasiView</code> trait and I'm guessing it's not meant to be implemented manually...</p>



<a name="430601868"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430601868" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sekhar Ravinutala <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430601868">(Apr 01 2024 at 14:32)</a>:</h4>
<p><span class="user-mention" data-user-id="705894">@Alen</span> Yeah, that's the other thing that threw me off, and I ended up implementing WasiView for it. Fortunately, it's simple if you just use the defaults, as below. The extra command link need is coming from the wrapper preview1 code that is componentizing the module as I understand, check out the tool at at <a href="http://wa2.dev">wa2.dev</a> to examine your component (or use wasm-tools CLI).</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">WasiView</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">HostComponent</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">ctx</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">WasiCtx</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">table</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">ResourceTable</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">table</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">HostComponent</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">new</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasiCtxBuilder</span>::<span class="n">new</span><span class="p">().</span><span class="n">build</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ResourceTable</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="o">..</span><span class="p">.</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>



<a name="430607726"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430607726" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alen <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430607726">(Apr 01 2024 at 15:02)</a>:</h4>
<p>The wasi imports do seem to get pruned in the example <a href="https://github.com/bytecodealliance/cargo-component/tree/main/example">https://github.com/bytecodealliance/cargo-component/tree/main/example</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/cargo-component/tree/main/example" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/c6d4641080d262506e6a64f093f010f751494de6\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f616633646335393664393661623866653635633936626537373664383037633239373964393039346433326564356338616639313961336364373666383235612f62797465636f6465616c6c69616e63652f636172676f2d636f6d706f6e656e74)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/cargo-component/tree/main/example" title="cargo-component/example at main · bytecodealliance/cargo-component">cargo-component/example at main · bytecodealliance/cargo-component</a></div><div class="message_embed_description">A Cargo subcommand for creating WebAssembly components based on the component model proposal. - bytecodealliance/cargo-component</div></div></div>



<a name="430613485"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430613485" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alen <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430613485">(Apr 01 2024 at 15:38)</a>:</h4>
<p>Not sure what significant differences there are between the example code and the code I'm testing that makes <code>cargo component</code> prune wasi from the example, but not from the test.</p>



<a name="430623468"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430623468" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430623468">(Apr 01 2024 at 16:30)</a>:</h4>
<p>When you run <code>wasm-tools component wit</code> on a <em>module</em> (which is what <code>rustc</code> itself currently emits) you get the entire input world with nothing pruned. When you run it against a <em>component</em> (which <code>cargo component</code> emits) you see the actual world after dead code elimination.</p>



<a name="430624012"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430624012" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alen <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430624012">(Apr 01 2024 at 16:33)</a>:</h4>
<p><span class="user-mention" data-user-id="480579">@Lann Martin</span> I'm using exactly the same command in both the example and the test directories: <code>cargo component build -r</code>. Am I supposed to do something to the .wasm file cargo component produces? I thought it already does composition.</p>



<a name="430624238"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430624238" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430624238">(Apr 01 2024 at 16:34)</a>:</h4>
<p>it's technically <code>wit-component</code> that's eliding the imports as it isn't finding any matching imports in the core module (output of rustc) it's componentizing</p>



<a name="430624242"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430624242" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430624242">(Apr 01 2024 at 16:34)</a>:</h4>
<p>Did you create your project with <code>cargo component new</code>?</p>



<a name="430624655"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430624655" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alen <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430624655">(Apr 01 2024 at 16:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="480579">Lann Martin</span> <a href="#narrow/stream/407292-cargo-component/topic/Test.20host.20and.20guest.20not.20working/near/430624242">said</a>:</p>
<blockquote>
<p>Did you create your project with <code>cargo component new</code>?</p>
</blockquote>
<p>I did. Here's the contents of Cargo.toml:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">[</span><span class="n">package</span><span class="p">]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"test_guest"</span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"0.1.0"</span>
<span class="n">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"2021"</span>

<span class="p">[</span><span class="n">lib</span><span class="p">]</span>
<span class="k">crate</span><span class="o">-</span><span class="k">type</span> <span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"cdylib"</span><span class="p">]</span>

<span class="p">[</span><span class="n">dependencies</span><span class="p">]</span>
<span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="o">-</span><span class="n">rt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"0.23.0"</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"bitflags"</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>

<span class="p">[</span><span class="n">package</span><span class="p">.</span><span class="n">metadata</span><span class="p">.</span><span class="n">component</span><span class="p">]</span>
<span class="n">package</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"local:test-guest"</span>

<span class="p">[</span><span class="n">package</span><span class="p">.</span><span class="n">metadata</span><span class="p">.</span><span class="n">component</span><span class="p">.</span><span class="n">dependencies</span><span class="p">]</span>

<span class="p">[</span><span class="n">workspace</span><span class="p">]</span>
</code></pre></div>
<p>cargo component new did produce a slightly different file, but I edited it to match the example as much as possible.</p>



<a name="430625146"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430625146" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430625146">(Apr 01 2024 at 16:38)</a>:</h4>
<p>Ohhh I see; I misunderstood your question. You are seeing wasi imports because the Rust stdlib uses wasi via wasi-libc.</p>



<a name="430625203"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430625203" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430625203">(Apr 01 2024 at 16:39)</a>:</h4>
<p>most likely because of the panic machinery</p>



<a name="430625388"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430625388" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430625388">(Apr 01 2024 at 16:40)</a>:</h4>
<p>which the generated bindings make use of between your code and the raw imports / exports</p>



<a name="430625609"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430625609" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alen <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430625609">(Apr 01 2024 at 16:41)</a>:</h4>
<p>Ah, so, if I want to remove wasi, I need to remove any dependency on stdlib?</p>



<a name="430625681"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430625681" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alen <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430625681">(Apr 01 2024 at 16:41)</a>:</h4>
<p>Or link it like Sekhar suggested</p>



<a name="430625789"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430625789" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430625789">(Apr 01 2024 at 16:42)</a>:</h4>
<p>Not necessarily <em>any</em> dependency on stdlib but it can be tricky to avoid e.g. <code>wasi:clocks/wall-clock@0.2.0;</code>. And you might need to change the panic behavior as <span class="user-mention" data-user-id="253989">@Peter Huene</span> mentions.</p>



<a name="430625854"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430625854" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430625854">(Apr 01 2024 at 16:42)</a>:</h4>
<p>you can technically target <code>wasm32-unknown-unknown</code> (<code>--target wasm32-unknown-unknown</code>), but it's not a properly supported target</p>



<a name="430626136"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430626136" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430626136">(Apr 01 2024 at 16:44)</a>:</h4>
<p><a href="https://doc.rust-lang.org/stable/nightly-rustc/rustc_target/spec/targets/wasm32_unknown_unknown/index.html">https://doc.rust-lang.org/stable/nightly-rustc/rustc_target/spec/targets/wasm32_unknown_unknown/index.html</a></p>
<blockquote>
<p>Although the standard library is available, most of it returns an error immediately</p>
</blockquote>



<a name="430626241"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430626241" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430626241">(Apr 01 2024 at 16:45)</a>:</h4>
<p>there is that; if you're absolutely not using the stdlib, i'd go <code>no_std</code></p>



<a name="430626355"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430626355" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430626355">(Apr 01 2024 at 16:45)</a>:</h4>
<p>but generally i'd advocate for your host to support WASI, even if you give it a WASI context that gives the program access to nothing at all</p>



<a name="430626434"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430626434" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430626434">(Apr 01 2024 at 16:45)</a>:</h4>
<p>Yeah, by default (?) wasmtime-wasi should still be isolated.</p>



<a name="430626517"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430626517" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alen <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430626517">(Apr 01 2024 at 16:46)</a>:</h4>
<p>I see. Thank you. Does linking wasi provide an escape route from the guest?</p>



<a name="430626604"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430626604" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430626604">(Apr 01 2024 at 16:46)</a>:</h4>
<p>for my understanding, what do you mean by "escape route"?</p>



<a name="430626648"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430626648" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430626648">(Apr 01 2024 at 16:46)</a>:</h4>
<p>Take a look at the documented defaults:<br>
<a href="https://docs.rs/wasmtime-wasi/19.0.0/wasmtime_wasi/struct.WasiCtxBuilder.html#method.new">https://docs.rs/wasmtime-wasi/19.0.0/wasmtime_wasi/struct.WasiCtxBuilder.html#method.new</a></p>



<a name="430626797"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430626797" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430626797">(Apr 01 2024 at 16:47)</a>:</h4>
<p>i.e. host clocks may count as an "escape" depending on your requirements</p>



<a name="430626805"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430626805" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alen <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430626805">(Apr 01 2024 at 16:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="253989">Peter Huene</span> <a href="#narrow/stream/407292-cargo-component/topic/Test.20host.20and.20guest.20not.20working/near/430626604">said</a>:</p>
<blockquote>
<p>for my understanding, what do you mean by "escape route"?</p>
</blockquote>
<p>If the wasm code is untrusted, would it be able to use wasi to break out of the isolated memory?</p>



<a name="430626888"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430626888" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alen <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430626888">(Apr 01 2024 at 16:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="480579">Lann Martin</span> <a href="#narrow/stream/407292-cargo-component/topic/Test.20host.20and.20guest.20not.20working/near/430626648">said</a>:</p>
<blockquote>
<p>Take a look at the documented defaults:<br>
<a href="https://docs.rs/wasmtime-wasi/19.0.0/wasmtime_wasi/struct.WasiCtxBuilder.html#method.new">https://docs.rs/wasmtime-wasi/19.0.0/wasmtime_wasi/struct.WasiCtxBuilder.html#method.new</a></p>
</blockquote>
<p>Ah, got it. Thank you.</p>



<a name="430626931"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430626931" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430626931">(Apr 01 2024 at 16:48)</a>:</h4>
<p>Alen, it definitely should not be able to; we would consider it a critical security issue if so</p>



<a name="430631114"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430631114" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alen <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430631114">(Apr 01 2024 at 17:10)</a>:</h4>
<p>Everything works now! My misunderstanding was that wasi was permissive by default and that it had to be avoided. The issue is resolved.</p>



<a name="430631123"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407292-cargo-component/topic/%E2%9C%94%20Test%20host%20and%20guest%20not%20working/near/430631123" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/407292-cargo-component/topic/.E2.9C.94.20Test.20host.20and.20guest.20not.20working.html#430631123">(Apr 01 2024 at 17:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="705894">Alen</span> has marked this topic as resolved.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>