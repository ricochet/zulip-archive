<html>
<head><meta charset="utf-8"><title>How to share (WIT) resources in Wasmtime across components? · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/index.html">general</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/How.20to.20share.20.28WIT.29.20resources.20in.20Wasmtime.20across.20components.3F.html">How to share (WIT) resources in Wasmtime across components?</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="471370214"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/How%20to%20share%20%28WIT%29%20resources%20in%20Wasmtime%20across%20components%3F/near/471370214" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Troy Edwards <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/How.20to.20share.20.28WIT.29.20resources.20in.20Wasmtime.20across.20components.3F.html#471370214">(Sep 19 2024 at 00:12)</a>:</h4>
<p>I'm importing and exporting the same WIT API. How do I plug these things together in Wasmtime for host / cross-component references to resources? </p>
<p>Here I'm trying to coerce the resource type from one component that exports the resource into the type of the component that imports that same resource type definition, using the <code>bindgen!()</code> macro generated API for the host implementation of the resource's constructor: <br>
<a href="https://github.com/toxoidengine/toxoidv2_experiments/blob/806920a9924108181ce2740e7ae4d264d0d40b5d/crates/toxoid_wasm_runtime/src/main.rs#L53">https://github.com/toxoidengine/toxoidv2_experiments/blob/806920a9924108181ce2740e7ae4d264d0d40b5d/crates/toxoid_wasm_runtime/src/main.rs#L53</a></p>
<p>The constructor does not like the type, and I'm wondering how "automagically" this would work or where I can provide the host shim to be able to manage a reference to the resource in the second / importing component, and be able to call the methods on that resource from the other component, as I try to do here with the host bindings in the component code: <a href="https://github.com/toxoidengine/toxoidv2_experiments/blob/806920a9924108181ce2740e7ae4d264d0d40b5d/crates/toxoid_wasm_component/src/lib.rs#L10">https://github.com/toxoidengine/toxoidv2_experiments/blob/806920a9924108181ce2740e7ae4d264d0d40b5d/crates/toxoid_wasm_component/src/lib.rs#L10</a></p>
<p>WIT files:<br>
<a href="https://github.com/toxoidengine/toxoidv2_experiments/blob/806920a9924108181ce2740e7ae4d264d0d40b5d/crates/toxoid_wasm_component/wit/world.wit">https://github.com/toxoidengine/toxoidv2_experiments/blob/806920a9924108181ce2740e7ae4d264d0d40b5d/crates/toxoid_wasm_component/wit/world.wit</a><br>
<a href="https://github.com/toxoidengine/toxoidv2_experiments/blob/806920a9924108181ce2740e7ae4d264d0d40b5d/crates/toxoid_api/wit/world.wit">https://github.com/toxoidengine/toxoidv2_experiments/blob/806920a9924108181ce2740e7ae4d264d0d40b5d/crates/toxoid_api/wit/world.wit</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/toxoidengine/toxoidv2_experiments/blob/806920a9924108181ce2740e7ae4d264d0d40b5d/crates/toxoid_wasm_runtime/src/main.rs#L53" style="background-image: url(&quot;https://uploads.zulipusercontent.net/777ee31ff9d76b5dbcb726a1336bb49ff315b726/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f616361366631653566383965646165316533656165353233336432646366663639613939313636363537326235326663623461356361396332636439636131302f746f786f6964656e67696e652f746f786f696476325f6578706572696d656e7473&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/toxoidengine/toxoidv2_experiments/blob/806920a9924108181ce2740e7ae4d264d0d40b5d/crates/toxoid_wasm_runtime/src/main.rs#L53" title="toxoidv2_experiments/crates/toxoid_wasm_runtime/src/main.rs at 806920a9924108181ce2740e7ae4d264d0d40b5d · toxoidengine/toxoidv2_experiments">toxoidv2_experiments/crates/toxoid_wasm_runtime/src/main.rs at 806920a9924108181ce2740e7ae4d264d0d40b5d · toxoidengine/toxoidv2_experiments</a></div><div class="message_embed_description">Experimenting with a cleaner, refactored version of Toxoid Engine based on 2024 / modern standards for WASM. - toxoidengine/toxoidv2_experiments</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/toxoidengine/toxoidv2_experiments/blob/806920a9924108181ce2740e7ae4d264d0d40b5d/crates/toxoid_wasm_component/src/lib.rs#L10" style="background-image: url(&quot;https://uploads.zulipusercontent.net/777ee31ff9d76b5dbcb726a1336bb49ff315b726/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f616361366631653566383965646165316533656165353233336432646366663639613939313636363537326235326663623461356361396332636439636131302f746f786f6964656e67696e652f746f786f696476325f6578706572696d656e7473&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/toxoidengine/toxoidv2_experiments/blob/806920a9924108181ce2740e7ae4d264d0d40b5d/crates/toxoid_wasm_component/src/lib.rs#L10" title="toxoidv2_experiments/crates/toxoid_wasm_component/src/lib.rs at 806920a9924108181ce2740e7ae4d264d0d40b5d · toxoidengine/toxoidv2_experiments">toxoidv2_experiments/crates/toxoid_wasm_component/src/lib.rs at 806920a9924108181ce2740e7ae4d264d0d40b5d · toxoidengine/toxoidv2_experiments</a></div><div class="message_embed_description">Experimenting with a cleaner, refactored version of Toxoid Engine based on 2024 / modern standards for WASM. - toxoidengine/toxoidv2_experiments</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/toxoidengine/toxoidv2_experiments/blob/806920a9924108181ce2740e7ae4d264d0d40b5d/crates/toxoid_wasm_component/wit/world.wit" style="background-image: url(&quot;https://uploads.zulipusercontent.net/777ee31ff9d76b5dbcb726a1336bb49ff315b726/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f616361366631653566383965646165316533656165353233336432646366663639613939313636363537326235326663623461356361396332636439636131302f746f786f6964656e67696e652f746f786f696476325f6578706572696d656e7473&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/toxoidengine/toxoidv2_experiments/blob/806920a9924108181ce2740e7ae4d264d0d40b5d/crates/toxoid_wasm_component/wit/world.wit" title="toxoidv2_experiments/crates/toxoid_wasm_component/wit/world.wit at 806920a9924108181ce2740e7ae4d264d0d40b5d · toxoidengine/toxoidv2_experiments">toxoidv2_experiments/crates/toxoid_wasm_component/wit/world.wit at 806920a9924108181ce2740e7ae4d264d0d40b5d · toxoidengine/toxoidv2_experiments</a></div><div class="message_embed_description">Experimenting with a cleaner, refactored version of Toxoid Engine based on 2024 / modern standards for WASM. - toxoidengine/toxoidv2_experiments</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/toxoidengine/toxoidv2_experiments/blob/806920a9924108181ce2740e7ae4d264d0d40b5d/crates/toxoid_api/wit/world.wit" style="background-image: url(&quot;https://uploads.zulipusercontent.net/777ee31ff9d76b5dbcb726a1336bb49ff315b726/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f616361366631653566383965646165316533656165353233336432646366663639613939313636363537326235326663623461356361396332636439636131302f746f786f6964656e67696e652f746f786f696476325f6578706572696d656e7473&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/toxoidengine/toxoidv2_experiments/blob/806920a9924108181ce2740e7ae4d264d0d40b5d/crates/toxoid_api/wit/world.wit" title="toxoidv2_experiments/crates/toxoid_api/wit/world.wit at 806920a9924108181ce2740e7ae4d264d0d40b5d · toxoidengine/toxoidv2_experiments">toxoidv2_experiments/crates/toxoid_api/wit/world.wit at 806920a9924108181ce2740e7ae4d264d0d40b5d · toxoidengine/toxoidv2_experiments</a></div><div class="message_embed_description">Experimenting with a cleaner, refactored version of Toxoid Engine based on 2024 / modern standards for WASM. - toxoidengine/toxoidv2_experiments</div></div></div>



<a name="471442931"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/How%20to%20share%20%28WIT%29%20resources%20in%20Wasmtime%20across%20components%3F/near/471442931" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Troy Edwards <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/How.20to.20share.20.28WIT.29.20resources.20in.20Wasmtime.20across.20components.3F.html#471442931">(Sep 19 2024 at 09:17)</a>:</h4>
<p>Ended up creating a host resource proxy struct. Please let me know if this is the wrong approach / if there is a way to reduce indirection / overhead mapping these resources. </p>
<p><a href="https://github.com/toxoidengine/toxoidv2_experiments/blob/7b35f19ae9617df6223823dfc8e338c7ce13b191/crates/toxoid_wasm_runtime/src/main.rs#L80">https://github.com/toxoidengine/toxoidv2_experiments/blob/7b35f19ae9617df6223823dfc8e338c7ce13b191/crates/toxoid_wasm_runtime/src/main.rs#L80</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/toxoidengine/toxoidv2_experiments/blob/7b35f19ae9617df6223823dfc8e338c7ce13b191/crates/toxoid_wasm_runtime/src/main.rs#L80" style="background-image: url(&quot;https://uploads.zulipusercontent.net/e244709410e2b2176c47b51923ca681146c50e20/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f663933323937663366366662316365363633666436363633373561303739636638356433653361353362633733386366326136363430663566303335363638392f746f786f6964656e67696e652f746f786f696476325f6578706572696d656e7473&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/toxoidengine/toxoidv2_experiments/blob/7b35f19ae9617df6223823dfc8e338c7ce13b191/crates/toxoid_wasm_runtime/src/main.rs#L80" title="toxoidv2_experiments/crates/toxoid_wasm_runtime/src/main.rs at 7b35f19ae9617df6223823dfc8e338c7ce13b191 · toxoidengine/toxoidv2_experiments">toxoidv2_experiments/crates/toxoid_wasm_runtime/src/main.rs at 7b35f19ae9617df6223823dfc8e338c7ce13b191 · toxoidengine/toxoidv2_experiments</a></div><div class="message_embed_description">Experimenting with a cleaner, refactored version of Toxoid Engine based on 2024 / modern standards for WASM. - toxoidengine/toxoidv2_experiments</div></div></div>



<a name="471802636"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/How%20to%20share%20%28WIT%29%20resources%20in%20Wasmtime%20across%20components%3F/near/471802636" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/How.20to.20share.20.28WIT.29.20resources.20in.20Wasmtime.20across.20components.3F.html#471802636">(Sep 20 2024 at 18:30)</a>:</h4>
<p>I probbaly don't have the complete and total context here to help precisely how you might want, but what I can say is that <code>bindgen!</code> should be able to "hook up" resource type bindings from one to another. There's also a bit of a difference in how resource types work at the component model level vs the generated bindings level in that some confusion may be coming from that too?</p>
<p>In any case though it looks like you've got it working for now?</p>



<a name="471867934"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/How%20to%20share%20%28WIT%29%20resources%20in%20Wasmtime%20across%20components%3F/near/471867934" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Troy Edwards <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/How.20to.20share.20.28WIT.29.20resources.20in.20Wasmtime.20across.20components.3F.html#471867934">(Sep 21 2024 at 02:28)</a>:</h4>
<p><span class="user-mention" data-user-id="253994">@Alex Crichton</span> It's working yes, with a proxy struct for the host resource that has a pointer to the instantiated resource from the other component, and manually defining the methods for the imports by grabbing the resource from the resource table in the (shared?) store. This looks like it involves a lot of indirection and probably isn't the correct way to link ("hook up" / "plug") the two I imagine.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">ResourceAnyPtr</span><span class="p">(</span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">ResourceAny</span><span class="p">);</span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">ResourceAnyPtr</span><span class="w"> </span><span class="p">{}</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">ComponentProxy</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="n">ptr</span><span class="p">:</span><span class="w"> </span><span class="nc">Arc</span><span class="o">&lt;</span><span class="n">Mutex</span><span class="o">&lt;</span><span class="n">ResourceAnyPtr</span><span class="o">&gt;&gt;</span>
<span class="p">}</span>
</code></pre></div>



<a name="472259819"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/How%20to%20share%20%28WIT%29%20resources%20in%20Wasmtime%20across%20components%3F/near/472259819" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/How.20to.20share.20.28WIT.29.20resources.20in.20Wasmtime.20across.20components.3F.html#472259819">(Sep 23 2024 at 15:12)</a>:</h4>
<p>Ah ok, yeah you definitely shouldn't have to resort to <code>unsafe</code> code at the very least.  Since <code>ResourceAny</code> implements <code>Clone</code> and doesn't actually represent ownership would it be possible to do that instead of having <code>Arc</code>/<code>Mutex</code> and unsafe?</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>