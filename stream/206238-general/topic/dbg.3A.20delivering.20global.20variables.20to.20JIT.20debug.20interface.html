<html>
<head><meta charset="utf-8"><title>dbg: delivering global variables to JIT debug interface · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/index.html">general</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html">dbg: delivering global variables to JIT debug interface</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="257698640"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/257698640" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#257698640">(Oct 15 2021 at 13:39)</a>:</h4>
<p>so, from dwarf dump., our test float is at 0x26 which is here :</p>
<p>translations[0x00000000].debuginfo.dwarf.debug_info.debug_info_section.slice[0x00000026]</p>
<p>quick inspect of that &amp; it looks right. might hardwire pull that one through as a means of figuring out what issues we have before nailing it more generically.</p>



<a name="257698675"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/257698675" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#257698675">(Oct 15 2021 at 13:39)</a>:</h4>
<p>0x00000026:   DW_TAG_variable [2]  <br>
                DW_AT_name [DW_FORM_strp]   ( .debug_str[0x00000078] = "my_global")<br>
                DW_AT_type [DW_FORM_ref4]   (cu + 0x0037 =&gt; {0x00000037} "float")<br>
                DW_AT_external [DW_FORM_flag_present]   (true)<br>
                DW_AT_decl_file [DW_FORM_data1] ("g:\dev\test\.\test.c")<br>
                DW_AT_decl_line [DW_FORM_data1] (1)<br>
                DW_AT_location [DW_FORM_exprloc]    (DW_OP_addr 0x400)</p>



<a name="257699860"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/257699860" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#257699860">(Oct 15 2021 at 13:47)</a>:</h4>
<p>so we just verbatim dump that out &amp; guess ends up at  same address (0x400), which can inspect once it shows up in debugger.<br>
if that's wrong, second pass over it to figure out where it gets mapped to.</p>



<a name="257700253"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/257700253" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#257700253">(Oct 15 2021 at 13:49)</a>:</h4>
<p>&amp; can run </p>
<p>float *wheres_my_global = &amp;my_global;</p>
<p>... in the C. to check / figure out where it is for verification.</p>



<a name="257913955"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/257913955" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#257913955">(Oct 17 2021 at 12:12)</a>:</h4>
<p>Some code at last :)</p>
<p><a href="https://github.com/adv-sw/wasmtime/blob/c7d257dbc36ffa1d5462afff7f37f1d08d853af3/crates/wasmtime/src/module.rs#L388">https://github.com/adv-sw/wasmtime/blob/c7d257dbc36ffa1d5462afff7f37f1d08d853af3/crates/wasmtime/src/module.rs#L388</a></p>
<p>Just grabs the globals thus far. Not suggesting a merge yet unless you want to help deliver this.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/adv-sw/wasmtime/blob/c7d257dbc36ffa1d5462afff7f37f1d08d853af3/crates/wasmtime/src/module.rs#L388" style="background-image: url(https://opengraph.githubassets.com/d274259bcbd8b34166734c63efd7e3ece973f6cfeb4447996fa276b389c15698/adv-sw/wasmtime)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/adv-sw/wasmtime/blob/c7d257dbc36ffa1d5462afff7f37f1d08d853af3/crates/wasmtime/src/module.rs#L388" title="wasmtime/module.rs at c7d257dbc36ffa1d5462afff7f37f1d08d853af3 · adv-sw/wasmtime">wasmtime/module.rs at c7d257dbc36ffa1d5462afff7f37f1d08d853af3 · adv-sw/wasmtime</a></div><div class="message_embed_description">Standalone JIT-style runtime for WebAssembly, using Cranelift - wasmtime/module.rs at c7d257dbc36ffa1d5462afff7f37f1d08d853af3 · adv-sw/wasmtime</div></div></div>



<a name="257914023"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/257914023" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#257914023">(Oct 17 2021 at 12:13)</a>:</h4>
<p>Need that &amp; the toml in that module to add gimli dependency.</p>



<a name="257914705"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/257914705" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#257914705">(Oct 17 2021 at 12:24)</a>:</h4>
<p>its not a straight verbatim dump as you have to grab the string identifier &amp; add it to the destination string table, amending index accordingly.</p>



<a name="257914732"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/257914732" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#257914732">(Oct 17 2021 at 12:24)</a>:</h4>
<p>&amp; whatever needs doing with the address.</p>



<a name="258001912"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258001912" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258001912">(Oct 18 2021 at 09:42)</a>:</h4>
<p>looking at clone_unit in <a href="http://unit.rs">unit.rs</a> - does most of what we want, just for functions, not global variables.</p>



<a name="258018300"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258018300" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258018300">(Oct 18 2021 at 12:10)</a>:</h4>
<p>looks like finish_compile is where we should emit this stuff.</p>



<a name="258021516"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258021516" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258021516">(Oct 18 2021 at 12:38)</a>:</h4>
<p>going just above that as too much rust weirdness to resolve dropping it in there. still not a fan. bit too "clever".</p>



<a name="258028423"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258028423" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258028423">(Oct 18 2021 at 13:27)</a>:</h4>
<p>moved it here.</p>
<p><a href="https://github.com/adv-sw/wasmtime/blob/95efcd83e0b3865df4306ee65e6a75b25f20bf21/crates/cranelift/src/debug/transform/mod.rs#L135">https://github.com/adv-sw/wasmtime/blob/95efcd83e0b3865df4306ee65e6a75b25f20bf21/crates/cranelift/src/debug/transform/mod.rs#L135</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/adv-sw/wasmtime/blob/95efcd83e0b3865df4306ee65e6a75b25f20bf21/crates/cranelift/src/debug/transform/mod.rs#L135" style="background-image: url(https://opengraph.githubassets.com/672350d618c94abdedad26199ac52f15bf09407b253bd2b8594d902834dc7801/adv-sw/wasmtime)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/adv-sw/wasmtime/blob/95efcd83e0b3865df4306ee65e6a75b25f20bf21/crates/cranelift/src/debug/transform/mod.rs#L135" title="wasmtime/mod.rs at 95efcd83e0b3865df4306ee65e6a75b25f20bf21 · adv-sw/wasmtime">wasmtime/mod.rs at 95efcd83e0b3865df4306ee65e6a75b25f20bf21 · adv-sw/wasmtime</a></div><div class="message_embed_description">Standalone JIT-style runtime for WebAssembly, using Cranelift - wasmtime/mod.rs at 95efcd83e0b3865df4306ee65e6a75b25f20bf21 · adv-sw/wasmtime</div></div></div>



<a name="258043355"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258043355" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258043355">(Oct 18 2021 at 15:06)</a>:</h4>
<p>clone_unit - clones a compile unit. each compile unit (equivalent of a source file) holds its own globals<br>
that calls clone_die_attributes. unsure why we don't just get globals.<br>
processing ...</p>



<a name="258050796"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258050796" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258050796">(Oct 18 2021 at 15:51)</a>:</h4>
<p>clone_die_attributes is parsing the globals. so we don't get them because they're either filtered out or broken in some way.<br>
need to visualize what we're actually getting for insight.</p>



<a name="258055711"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258055711" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258055711">(Oct 18 2021 at 16:19)</a>:</h4>
<p>pending_die_refs &amp; pending_di_refs from clone_die_attributes should contain our global.</p>



<a name="258057379"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258057379" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258057379">(Oct 18 2021 at 16:28)</a>:</h4>
<p>Here's where we come out the other side after processing the die.<br>
<a href="https://github.com/adv-sw/wasmtime/blob/95efcd83e0b3865df4306ee65e6a75b25f20bf21/crates/cranelift/src/debug/transform/unit.rs#L374">https://github.com/adv-sw/wasmtime/blob/95efcd83e0b3865df4306ee65e6a75b25f20bf21/crates/cranelift/src/debug/transform/unit.rs#L374</a></p>
<p>Sub-programs - processed.<br>
Global variable isn't a DW_TAG_subprogram - ends up doing nothing here :<br>
<a href="https://github.com/adv-sw/wasmtime/blob/95efcd83e0b3865df4306ee65e6a75b25f20bf21/crates/cranelift/src/debug/transform/unit.rs#L399">https://github.com/adv-sw/wasmtime/blob/95efcd83e0b3865df4306ee65e6a75b25f20bf21/crates/cranelift/src/debug/transform/unit.rs#L399</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/adv-sw/wasmtime/blob/95efcd83e0b3865df4306ee65e6a75b25f20bf21/crates/cranelift/src/debug/transform/unit.rs#L374" style="background-image: url(https://opengraph.githubassets.com/672350d618c94abdedad26199ac52f15bf09407b253bd2b8594d902834dc7801/adv-sw/wasmtime)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/adv-sw/wasmtime/blob/95efcd83e0b3865df4306ee65e6a75b25f20bf21/crates/cranelift/src/debug/transform/unit.rs#L374" title="wasmtime/unit.rs at 95efcd83e0b3865df4306ee65e6a75b25f20bf21 · adv-sw/wasmtime">wasmtime/unit.rs at 95efcd83e0b3865df4306ee65e6a75b25f20bf21 · adv-sw/wasmtime</a></div><div class="message_embed_description">Standalone JIT-style runtime for WebAssembly, using Cranelift - wasmtime/unit.rs at 95efcd83e0b3865df4306ee65e6a75b25f20bf21 · adv-sw/wasmtime</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/adv-sw/wasmtime/blob/95efcd83e0b3865df4306ee65e6a75b25f20bf21/crates/cranelift/src/debug/transform/unit.rs#L399" style="background-image: url(https://opengraph.githubassets.com/672350d618c94abdedad26199ac52f15bf09407b253bd2b8594d902834dc7801/adv-sw/wasmtime)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/adv-sw/wasmtime/blob/95efcd83e0b3865df4306ee65e6a75b25f20bf21/crates/cranelift/src/debug/transform/unit.rs#L399" title="wasmtime/unit.rs at 95efcd83e0b3865df4306ee65e6a75b25f20bf21 · adv-sw/wasmtime">wasmtime/unit.rs at 95efcd83e0b3865df4306ee65e6a75b25f20bf21 · adv-sw/wasmtime</a></div><div class="message_embed_description">Standalone JIT-style runtime for WebAssembly, using Cranelift - wasmtime/unit.rs at 95efcd83e0b3865df4306ee65e6a75b25f20bf21 · adv-sw/wasmtime</div></div></div>



<a name="258058098"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258058098" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258058098">(Oct 18 2021 at 16:32)</a>:</h4>
<p>&amp; that's all recursive. fun times :)</p>



<a name="258059938"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258059938" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258059938">(Oct 18 2021 at 16:43)</a>:</h4>
<p>then into generate_simulated_dwarf where I can see what it gets. can quit whining now &amp; just work thru it. sorry all :)</p>



<a name="258060125"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258060125" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258060125">(Oct 18 2021 at 16:44)</a>:</h4>
<p>think it just needs peppering with diagnostics until its obvious what's missing, or if nothing's missing look elsewhere for clues.</p>



<a name="258070794"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258070794" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258070794">(Oct 18 2021 at 17:52)</a>:</h4>
<p>generate_simulated_dwarf is writing header then functions. so gotta figure out how to pull globals into that.</p>



<a name="258080581"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258080581" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258080581">(Oct 18 2021 at 18:55)</a>:</h4>
<p>I also don't want to work on this  but the fundamentals need to be solid for this to be an effective internet scale project.</p>



<a name="258080675"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258080675" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258080675">(Oct 18 2021 at 18:55)</a>:</h4>
<p>windows users are used to quality debugging experiences. others seem to settle for less. lets get it right :)</p>



<a name="258083774"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258083774" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258083774">(Oct 18 2021 at 19:15)</a>:</h4>
<p>summary: cranelift bug.</p>



<a name="258087184"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258087184" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258087184">(Oct 18 2021 at 19:39)</a>:</h4>
<p>Added</p>
<p>log_globals(&amp;di)?;</p>
<p>to start of generate_simulated_dwarf. </p>
<p>log_globals defined below. seems to indicate global coming thru, so that function at fault with valid data. I say valid, its there, whether correct or not, don't yet know.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">log_globals</span><span class="p">(</span><span class="w"></span>
<span class="w">   </span><span class="n">di</span>: <span class="kp">&amp;</span><span class="nc">DebugInfoData</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="c1">// Scan .debuginfo for global variables which we'll record &amp; translate to JIT sink.</span>
<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">count</span><span class="w"> </span>: <span class="kt">i32</span>  <span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="n">dwarf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">di</span><span class="p">.</span><span class="n">dwarf</span><span class="p">;</span><span class="w"></span>

<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dwarf</span><span class="p">.</span><span class="n">units</span><span class="p">();</span><span class="w"></span>

<span class="w">   </span><span class="c1">// Iterate over the compilation units.</span>

<span class="w">   </span><span class="k">while</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">header</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iter</span><span class="p">.</span><span class="n">next</span><span class="p">()</span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="fm">println!</span><span class="p">(</span><span class="w"></span>
<span class="w">         </span><span class="s">"Unit at &lt;.debug_info+0x{:x}&gt;"</span><span class="p">,</span><span class="w"></span>
<span class="w">         </span><span class="n">header</span><span class="p">.</span><span class="n">offset</span><span class="p">().</span><span class="n">as_debug_info_offset</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="mi">0</span><span class="w"></span>
<span class="w">      </span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="n">unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dwarf</span><span class="p">.</span><span class="n">unit</span><span class="p">(</span><span class="n">header</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Iterate over the Debugging Information Entries (DIEs) in the unit.</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">entries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unit</span><span class="p">.</span><span class="n">entries</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">((</span><span class="n">delta_depth</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entries</span><span class="p">.</span><span class="n">next_dfs</span><span class="p">()</span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">         </span><span class="n">depth</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">delta_depth</span><span class="p">;</span><span class="w"></span>

<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="n">tag</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">gimli</span>::<span class="n">DW_TAG_variable</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">         </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">"GLOBAL_{} &lt;0x{:x}&gt;  {}"</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="n">offset</span><span class="p">().</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="n">tag</span><span class="p">());</span><span class="w"></span>

<span class="w">            </span><span class="c1">// Iterate over the attributes in the DIE.</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">attrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="n">attrs</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">attrs</span><span class="p">.</span><span class="n">next</span><span class="p">()</span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="fm">println!</span><span class="p">(</span><span class="s">"   {}: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">attr</span><span class="p">.</span><span class="n">name</span><span class="p">(),</span><span class="w"> </span><span class="n">attr</span><span class="p">.</span><span class="n">value</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">         </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>

<span class="w">   </span><span class="nb">Ok</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="err">```</span><span class="w"></span>
</code></pre></div>



<a name="258224714"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258224714" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258224714">(Oct 19 2021 at 16:17)</a>:</h4>
<p>think we need to create a gimli unit with a null line program, implicitly globals unit. tried that, needs gimli mods so just figured out how to override with local crate. compiles, so into it.   not the ideal first rust project, but hey :)</p>
<p>one trivial fix to run with gimli trunk.</p>



<a name="258224869"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258224869" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258224869">(Oct 19 2021 at 16:18)</a>:</h4>
<p>is a nice structure for collab work &amp; the syntax isn't terrible. might even start to like it.</p>



<a name="258520858"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258520858" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258520858">(Oct 21 2021 at 10:24)</a>:</h4>
<p>Early approximation - work in progress : <a href="https://github.com/adv-sw/wasmtime">https://github.com/adv-sw/wasmtime</a></p>
<p>clone_globals in wasmtime\crates\cranelift\src\debug\transform\unit.rs</p>
<p>Applied in wasmtime\crates\cranelift\src\debug\transform\mod.rs</p>
<p>Traverses cleanly, not yet working code. Got some placeholders in there whilst we figure out what goes where.</p>
<p>Corrections / refinements welcome.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/adv-sw/wasmtime" style="background-image: url(https://opengraph.githubassets.com/e4acd5e1f9c65b29f79cfd63eb36be45837742fc80a604f1424811531234dd1e/adv-sw/wasmtime)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/adv-sw/wasmtime" title="GitHub - adv-sw/wasmtime: Standalone JIT-style runtime for WebAssembly, using Cranelift">GitHub - adv-sw/wasmtime: Standalone JIT-style runtime for WebAssembly, using Cranelift</a></div><div class="message_embed_description">Standalone JIT-style runtime for WebAssembly, using Cranelift - GitHub - adv-sw/wasmtime: Standalone JIT-style runtime for WebAssembly, using Cranelift</div></div></div>



<a name="258521450"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258521450" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258521450">(Oct 21 2021 at 10:30)</a>:</h4>
<p>Requires some minor gimli tweaks : <a href="https://github.com/adv-sw/gimli">https://github.com/adv-sw/gimli</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/adv-sw/gimli" style="background-image: url(https://opengraph.githubassets.com/422e098eab1dce5c41ae67f80aae90e60ab33be2372d4293b137f2393acac483/adv-sw/gimli)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/adv-sw/gimli" title="GitHub - adv-sw/gimli: A blazing fast library for consuming the DWARF debugging format">GitHub - adv-sw/gimli: A blazing fast library for consuming the DWARF debugging format</a></div><div class="message_embed_description">A blazing fast library for consuming the DWARF debugging format - GitHub - adv-sw/gimli: A blazing fast library for consuming the DWARF debugging format</div></div></div>



<a name="258545834"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258545834" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258545834">(Oct 21 2021 at 13:34)</a>:</h4>
<p>dropping log_globals back into generate_simulated_dwarf, we get one - so +ve change in behaviour.<br>
next to decode that as it comes out to figure out if its correct.</p>



<a name="258695343"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258695343" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258695343">(Oct 22 2021 at 10:59)</a>:</h4>
<p>Extracted generated ELF that's sent to LLDB to a file for inspection via the following.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">register_debug_and_profiling</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">profiler</span>: <span class="kp">&amp;</span><span class="nc">dyn</span><span class="w"> </span><span class="n">ProfilingAgent</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Register GDB JIT images; initialize profiler and load the wasm module.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">meta</span><span class="p">.</span><span class="n">native_debug_info_present</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">code</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_gdbjit_image</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">mmap</span><span class="p">().</span><span class="n">to_vec</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="n">code</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">(),</span><span class="w"> </span><span class="n">code</span><span class="p">.</span><span class="n">len</span><span class="p">()))</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="n">SetupError</span>::<span class="n">DebugInfo</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">               </span><span class="c1">// ADV_SW_DEBUG : save for inspection.</span>
<span class="w">               </span><span class="kd">let</span><span class="w"> </span><span class="n">path</span>: <span class="kp">&amp;</span><span class="nc">Path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span>::<span class="n">new</span><span class="p">(</span><span class="s">"g:</span><span class="se">\\</span><span class="s">dev</span><span class="se">\\</span><span class="s">test</span><span class="se">\\</span><span class="s">emit.elf"</span><span class="p">);</span><span class="w"></span>
<span class="w">               </span><span class="n">fs</span>::<span class="n">write</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bytes</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">               </span><span class="c1">// ADV_SW_DEBUG[END]</span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="n">profiler</span><span class="p">.</span><span class="n">module_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bytes</span><span class="p">));</span><span class="w"></span>
</code></pre></div>
<p>Looks less wrong than I expected, but not quite there yet.</p>
<p><a href="https://pastebin.com/ZfLYhm2R">https://pastebin.com/ZfLYhm2R</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://pastebin.com/ZfLYhm2R" style="background-image: url(https://pastebin.com/i/facebook.png)"></a><div class="data-container"><div class="message_embed_title"><a href="https://pastebin.com/ZfLYhm2R" title=".\emit.elf:	file format elf64-x86-64.debug_info contents:0x00000000: Compi - Pastebin.com">.\emit.elf:	file format elf64-x86-64.debug_info contents:0x00000000: Compi - Pastebin.com</a></div><div class="message_embed_description">Pastebin.com is the number one paste tool since 2002. Pastebin is a website where you can store text online for a set period of time.</div></div></div>



<a name="258700853"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258700853" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258700853">(Oct 22 2021 at 11:57)</a>:</h4>
<p>with my nonsense turned off, the global does appear to come thru.<br>
<a href="https://pastebin.com/ZsTK8De1">https://pastebin.com/ZsTK8De1</a><br>
should have done this bit first :)</p>
<p>... but we don't see it. so another verify on that then into lldb to see why it's not registered.</p>
<div class="message_embed"><a class="message_embed_image" href="https://pastebin.com/ZsTK8De1" style="background-image: url(https://pastebin.com/i/facebook.png)"></a><div class="data-container"><div class="message_embed_title"><a href="https://pastebin.com/ZsTK8De1" title=".\emit.elf:	file format elf64-x86-64.debug_info contents:0x00000000: Compi - Pastebin.com">.\emit.elf:	file format elf64-x86-64.debug_info contents:0x00000000: Compi - Pastebin.com</a></div><div class="message_embed_description">Pastebin.com is the number one paste tool since 2002. Pastebin is a website where you can store text online for a set period of time.</div></div></div>



<a name="258704905"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258704905" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258704905">(Oct 22 2021 at 12:35)</a>:</h4>
<p>comparing emitted dwarf vs. native equivalent, we spot some differences.</p>
<p>native </p>
<p>&lt; 1&gt;&lt;0x0000002a&gt;    DW_TAG_variable<br>
                      DW_AT_name                  my_global<br>
                      DW_AT_type                  &lt;0x0000003f&gt;<br>
                      DW_AT_external              yes(1)<br>
                      DW_AT_decl_file             0x00000001 /media/x/DEV_LLVM/dev/test/./test.c<br>
                      DW_AT_decl_line             0x00000001<br>
                      DW_AT_location              len 0x0009: 0x032840400000000000: <br>
                              DW_OP_addr 0x00404028</p>
<p>wasmtime emit</p>
<p>&lt; 1&gt;&lt;0x00000073&gt;    DW_TAG_variable<br>
                     DW_AT_name                  my_global<br>
            DW_AT_type                  &lt;0x0000002f&gt;                      <br>
           DW_AT_external              yes(1)<br>
                     DW_AT_decl_file             0x00000001<br>
                     DW_AT_decl_line             0x00000001</p>



<a name="258706136"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258706136" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258706136">(Oct 22 2021 at 12:45)</a>:</h4>
<p>specifically,  DW_AT_location isn't coming thru, so debugger doesn't know where it is &amp; that's likely the reason for reject.</p>



<a name="258717041"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258717041" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258717041">(Oct 22 2021 at 14:11)</a>:</h4>
<p>that DW_AT_location is skipped bcoz hitting  "// FIXME _expr contains invalid expression"</p>
<p>in wasmtime\crates\cranelift\src\debug\transform\attr.rs</p>



<a name="258719284"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258719284" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258719284">(Oct 22 2021 at 14:27)</a>:</h4>
<p>operation Address is causing compile_expression to fail. have no idea what should be going on in there :)</p>



<a name="258720837"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258720837" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258720837">(Oct 22 2021 at 14:39)</a>:</h4>
<p>not having a clue what I'm doing in there, I forced Address to pass &amp; got the desired attribute</p>
<p>DW_TAG_variable<br>
                DW_AT_name  ("my_global")<br>
                DW_AT_external  (0x01)<br>
                DW_AT_decl_file ("g:\dev\test\.\test.c")<br>
                DW_AT_decl_line (1)<br>
                DW_AT_location  (DW_OP_addr 0x0, &lt;decoding error&gt; 00 04 00 00)<br>
                DW_AT_type  (0x0000002f "float")</p>
<p>value is incorrect but its there. next to figure out what its supposed to be &amp; how to get it.</p>



<a name="258721932"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258721932" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258721932">(Oct 22 2021 at 14:47)</a>:</h4>
<p>DW_AT_location does come through for locals, which will be on the stack rather than fixed location, but perhaps can look at what's going on there for clues.</p>



<a name="258737009"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258737009" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258737009">(Oct 22 2021 at 16:33)</a>:</h4>
<p>trying this in <a href="http://attr.rs">attr.rs</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">            </span><span class="c1">// ADV_SW_PATCH: DW_AT_location is defined by global variables.</span>
<span class="w">            </span><span class="c1">// We process directly as compile_expression doesn't like them for some reason.</span>

<span class="w">            </span><span class="n">AttributeValue</span>::<span class="n">Exprloc</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="n">expr</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">attr</span><span class="p">.</span><span class="n">name</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">gimli</span>::<span class="n">DW_AT_location</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expr</span><span class="p">.</span><span class="mf">0.</span><span class="n">to_slice</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">                </span><span class="c1">// TODO1: Verify buf[0] == DW_OP_addr</span>

<span class="w">                </span><span class="c1">// TODO2: This is for 32 bit wasm pointers. How to detect 64 bit &amp; react accordingly ?</span>

<span class="w">                </span><span class="c1">// TODO3: Consider endian requirements.</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">u32</span>::<span class="n">from_le_bytes</span><span class="p">([</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]])</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr_tr</span><span class="p">.</span><span class="n">translate</span><span class="p">(</span><span class="n">u</span><span class="p">).</span><span class="n">unwrap_or</span><span class="p">(</span><span class="n">write</span>::<span class="n">Address</span>::<span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">                </span><span class="n">write</span>::<span class="n">AttributeValue</span>::<span class="n">Address</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>coming out as zero address, though 0x0040000 in the wasm. </p>
<p>how should I look up mapping from global's local address to target address space, please.</p>



<a name="258738483"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258738483" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258738483">(Oct 22 2021 at 16:44)</a>:</h4>
<p>wasmtime\crates\cranelift\src\debug\transform\attr.rs</p>



<a name="258740029"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258740029" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258740029">(Oct 22 2021 at 16:55)</a>:</h4>
<p>feel free to steal the thunder if you've got it from here :)</p>



<a name="258740293"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258740293" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258740293">(Oct 22 2021 at 16:57)</a>:</h4>
<p>... but that's the issue - at least one of them. might be multiple faults. </p>
<p>global variable DW_AT_location address locations are being rejected by compile_expression in trunk.</p>



<a name="258741830"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258741830" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258741830">(Oct 22 2021 at 17:07)</a>:</h4>
<p>that mapping is what resolve_vmctx_memory does. so  figure out how to run through that code, I guess.</p>



<a name="258742069"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258742069" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258742069">(Oct 22 2021 at 17:08)</a>:</h4>
<p>not sure globals end up in address translation table. hence why we're getting 0. so compute directly.</p>



<a name="258813597"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258813597" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258813597">(Oct 23 2021 at 09:28)</a>:</h4>
<p>a command line option for wasmtime app &amp; API to copy debug mode generated elf to a file for inspection once resolved so easier next time, perhaps.</p>



<a name="258813889"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258813889" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258813889">(Oct 23 2021 at 09:36)</a>:</h4>
<p>Please could master update to latest gimli. Requires stub for DebugCuIndex, DebugTuIndex</p>



<a name="258813995"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258813995" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258813995">(Oct 23 2021 at 09:39)</a>:</h4>
<div class="codehilite"><pre><span></span><code>    DebugCuIndex =&gt; &quot;.debug_cu_index&quot;,
    DebugTuIndex =&gt; &quot;.debug_tu_index&quot;,
</code></pre></div>

<p>guess. something like that.</p>



<a name="258814364"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258814364" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258814364">(Oct 23 2021 at 09:50)</a>:</h4>
<p>trunk broken for me running globals example from wasmtime rust sdk, with debug mode enabled.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">Config</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">debug_info</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">Engine</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
</code></pre></div>



<a name="258814417"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258814417" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258814417">(Oct 23 2021 at 09:50)</a>:</h4>
<p>&amp; slightly modified gimli. perhaps its that - nope, dropped regular in everywhere. still broken. back to my branch.</p>



<a name="258815660"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258815660" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258815660">(Oct 23 2021 at 10:18)</a>:</h4>
<p>regression redacted.  programming error in my new code causing panic. doh :)</p>



<a name="258818727"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258818727" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258818727">(Oct 23 2021 at 11:35)</a>:</h4>
<p>corrected that coding error. still haven't translated the address, but get wasm address coming thru (insufficient, but progress)</p>
<p><a href="https://github.com/adv-sw/wasmtime/blob/4a5fa279fa49343021cdffa2af1bade8b38b299c/crates/cranelift/src/debug/transform/attr.rs#L209">https://github.com/adv-sw/wasmtime/blob/4a5fa279fa49343021cdffa2af1bade8b38b299c/crates/cranelift/src/debug/transform/attr.rs#L209</a></p>
<p>&amp; write_expr_addr in <a href="http://expression.rs">expression.rs</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/adv-sw/wasmtime/blob/4a5fa279fa49343021cdffa2af1bade8b38b299c/crates/cranelift/src/debug/transform/attr.rs#L209" style="background-image: url(https://opengraph.githubassets.com/37b28d1f368ccc0f02874ee939e7d5a3b6e233d47f40bbf400aa2c54c0d0fb5b/adv-sw/wasmtime)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/adv-sw/wasmtime/blob/4a5fa279fa49343021cdffa2af1bade8b38b299c/crates/cranelift/src/debug/transform/attr.rs#L209" title="wasmtime/attr.rs at 4a5fa279fa49343021cdffa2af1bade8b38b299c · adv-sw/wasmtime">wasmtime/attr.rs at 4a5fa279fa49343021cdffa2af1bade8b38b299c · adv-sw/wasmtime</a></div><div class="message_embed_description">Standalone JIT-style runtime for WebAssembly, using Cranelift - wasmtime/attr.rs at 4a5fa279fa49343021cdffa2af1bade8b38b299c · adv-sw/wasmtime</div></div></div>



<a name="258825488"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258825488" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258825488">(Oct 23 2021 at 14:07)</a>:</h4>
<p>still haven't found the magic source to convert wasm pointer to runtime equivalent before instantiation.</p>
<p>found translate_raw but that just performs a function lookup which will fail coz not a function.</p>



<a name="258833871"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258833871" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258833871">(Oct 23 2021 at 17:23)</a>:</h4>
<p>how do I grab raw address from Address please.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">write_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span>: <span class="nc">gimli</span>::<span class="n">write</span>::<span class="n">Address</span><span class="p">)</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="n">addr64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">;</span><span class="w"></span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr64</span><span class="p">.</span><span class="n">to_le_bytes</span><span class="p">();</span><span class="w"></span>
<span class="w">         </span><span class="bp">self</span><span class="p">.</span><span class="n">write_u8</span><span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">         </span><span class="bp">self</span><span class="p">.</span><span class="n">write_u8</span><span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">         </span><span class="bp">self</span><span class="p">.</span><span class="n">write_u8</span><span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span><span class="w"></span>
<span class="w">         </span><span class="bp">self</span><span class="p">.</span><span class="n">write_u8</span><span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span><span class="w"></span>
<span class="w">         </span><span class="bp">self</span><span class="p">.</span><span class="n">write_u8</span><span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span><span class="w"></span>
<span class="w">         </span><span class="bp">self</span><span class="p">.</span><span class="n">write_u8</span><span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span><span class="w"></span>
<span class="w">         </span><span class="bp">self</span><span class="p">.</span><span class="n">write_u8</span><span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span><span class="w"></span>
<span class="w">         </span><span class="bp">self</span><span class="p">.</span><span class="n">write_u8</span><span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>can't do as u64 or anything else I've tried. stuck on simple stuff.</p>



<a name="258834616"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258834616" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258834616">(Oct 23 2021 at 17:40)</a>:</h4>
<p>I've got it generating an address. I can't figure out how to get the correct address or how to write it when I get it. </p>
<p>clues are welcome.</p>



<a name="258835015"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258835015" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258835015">(Oct 23 2021 at 17:51)</a>:</h4>
<p>there's this thing, but can't figure out how to use it.  </p>
<p>write_address(&amp;mut self, address: Address, size: u8)</p>
<p>if we were C, I'd just cast it or at the least be able to see what it is in debugger.</p>



<a name="258835147"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258835147" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258835147">(Oct 23 2021 at 17:54)</a>:</h4>
<p>as I don't know how to transform an address, unsure if figuring out how to serialize one of those things is way to go anyway.</p>



<a name="258835861"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258835861" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258835861">(Oct 23 2021 at 18:10)</a>:</h4>
<p>finally :)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">write_expr_addr</span><span class="p">(</span><span class="n">addr</span><span class="w"> </span>: <span class="nc">gimli</span>::<span class="n">write</span>::<span class="n">Address</span><span class="p">)</span>-&gt; <span class="nc">gimli</span>::<span class="n">write</span>::<span class="n">Expression</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ExpressionWriter</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="w">   </span><span class="n">w</span><span class="p">.</span><span class="n">write_op</span><span class="p">(</span><span class="n">gimli</span>::<span class="n">constants</span>::<span class="n">DW_OP_addr</span><span class="p">);</span><span class="w"></span>

<span class="w">   </span><span class="k">match</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">gimli</span>::<span class="n">write</span>::<span class="n">Address</span>::<span class="n">Constant</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">.</span><span class="n">to_le_bytes</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="n">w</span><span class="p">.</span><span class="n">write_u8</span><span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">          </span><span class="n">w</span><span class="p">.</span><span class="n">write_u8</span><span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">          </span><span class="n">w</span><span class="p">.</span><span class="n">write_u8</span><span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span><span class="w"></span>
<span class="w">          </span><span class="n">w</span><span class="p">.</span><span class="n">write_u8</span><span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span><span class="w"></span>
<span class="w">          </span><span class="n">w</span><span class="p">.</span><span class="n">write_u8</span><span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span><span class="w"></span>
<span class="w">          </span><span class="n">w</span><span class="p">.</span><span class="n">write_u8</span><span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span><span class="w"></span>
<span class="w">          </span><span class="n">w</span><span class="p">.</span><span class="n">write_u8</span><span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span><span class="w"></span>
<span class="w">          </span><span class="n">w</span><span class="p">.</span><span class="n">write_u8</span><span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>

<span class="w">      </span><span class="n">gimli</span>::<span class="n">write</span>::<span class="n">Address</span>::<span class="n">Symbol</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">symbol</span><span class="p">,</span><span class="w"> </span><span class="n">addend</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/*not yet supported*/</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">   </span><span class="n">gimli</span>::<span class="n">write</span>::<span class="n">Expression</span>::<span class="n">raw</span><span class="p">(</span><span class="n">w</span><span class="p">.</span><span class="n">into_vec</span><span class="p">())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="258836283"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258836283" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258836283">(Oct 23 2021 at 18:21)</a>:</h4>
<p>Got this, which at least serializes an Address now. Coming thru zero. Unsure how I should convert the address of a wasm global variable to target equivalent.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">            </span><span class="c1">// ADV_SW_PATCH: DW_AT_location is defined by global variables.</span>
<span class="w">            </span><span class="c1">// We process directly as compile_expression doesn't like them for some reason.</span>

<span class="w">            </span><span class="n">AttributeValue</span>::<span class="n">Exprloc</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="n">expr</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">attr</span><span class="p">.</span><span class="n">name</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">gimli</span>::<span class="n">DW_AT_location</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expr</span><span class="p">.</span><span class="mf">0.</span><span class="n">to_slice</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">                </span><span class="c1">// Ignore unless supported op.</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="n">gimli</span>::<span class="n">DW_OP_addr</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w">                </span><span class="c1">// TODO: Detect 64 bit wasm &amp; form source address accordingly.</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">addr_wasm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">u32</span>::<span class="n">from_le_bytes</span><span class="p">([</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]])</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">;</span><span class="w"></span>

<span class="w">                </span><span class="c1">// TODO: Translate the address.</span>
<span class="w">                </span><span class="c1">// TODO2: Ensure endian correctness - this is a target pointer.</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">addr_target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr_tr</span><span class="p">.</span><span class="n">translate</span><span class="p">(</span><span class="n">addr_wasm</span><span class="p">).</span><span class="n">unwrap_or</span><span class="p">(</span><span class="n">write</span>::<span class="n">Address</span>::<span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">                </span><span class="c1">// let addr_target = write::Address::Constant(0);</span>

<span class="w">                </span><span class="c1">// TODO: Research use of the following - might be required.</span>
<span class="w">                </span><span class="c1">// resume_with_relocated_address</span>
<span class="w">                </span><span class="c1">// evaluate_one_operation</span>
<span class="w">                </span><span class="c1">// op_wasm_global</span>

<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">expr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">write_expr_addr</span><span class="p">(</span><span class="n">addr_target</span><span class="p">);</span><span class="w"></span>

<span class="w">                </span><span class="n">write</span>::<span class="n">AttributeValue</span>::<span class="n">Exprloc</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="258836512"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258836512" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258836512">(Oct 23 2021 at 18:27)</a>:</h4>
<p>assuming no other issues, this is nailed once we have the correct address.</p>



<a name="258869995"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258869995" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258869995">(Oct 24 2021 at 09:50)</a>:</h4>
<p>hmmm ... so that code is getting called by build_artifacts whilst creating a module. don't think we can get final address there. so need to figure out a way to park the expression &amp; evaluate it in JIT callback instead of as module is built.</p>



<a name="258871046"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258871046" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258871046">(Oct 24 2021 at 10:17)</a>:</h4>
<p>create_gdbjit_image does some kind of a relocate, so need to get head around that.</p>



<a name="258876726"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258876726" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258876726">(Oct 24 2021 at 12:34)</a>:</h4>
<p>first call might result in invalid pointer if we don't have memory yet, but construction of dwarf is from jit callback, at a breakpoint, we will have an instance, so can form a valid target pointer.</p>



<a name="258881230"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258881230" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258881230">(Oct 24 2021 at 14:27)</a>:</h4>
<p>ummm from z:\dev\wasm\wasmtime\crates\cranelift\src\debug\transform\attr.rs<br>
want  </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">wasmtime_runtime</span>::<span class="p">{</span><span class="n">debug_builtins</span><span class="p">};</span><span class="w"></span>

<span class="o">....</span><span class="w"></span>

<span class="c1">// so I can do something along lines of :</span>

<span class="kd">let</span><span class="w"> </span><span class="n">addr_target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resolve_vmctx_memory</span><span class="p">(</span><span class="n">addr_wasm</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>... which is unsafe &amp; don't know how to resolve that either coz rust noob.</p>



<a name="258881286"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258881286" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258881286">(Oct 24 2021 at 14:28)</a>:</h4>
<p>someone who knows how to drive would have this done by now :)</p>



<a name="258886431"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258886431" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258886431">(Oct 24 2021 at 16:32)</a>:</h4>
<p>following example has 2 float global variables -  their   DW_AT_locations look fine. the 3 means op addresss.</p>
<p>this log from running under lldb at a breakpoint.</p>
<p>the addresses I need to remap are processed before the memory is initialized. so its not possible at that point.</p>
<p>&amp; here, I think is where the __vmctx-&gt;set() thingy comes in. so gotta figure out how this all fits in there.</p>
<p>aside: if someone could explain what a trampoline is, that'd help. might not need one, but would like to understand what they are so I know that. they seem to be something to do with functions but this is a global not a function.</p>
<p>[global_requiring_target_resolve]<br>
[global_requiring_target_resolve]<br>
Unit at &lt;.debug_info+0x0&gt;<br>
GLOBAL_1 &lt;0x26&gt;  DW_TAG_variable<br>
   DW_AT_name: DebugStrRef(DebugStrOffset(120))<br>
   DW_AT_type: UnitRef(UnitOffset(55))<br>
   DW_AT_external: Flag(true)<br>
   DW_AT_decl_file: FileIndex(1)<br>
   DW_AT_decl_line: Udata(1)<br>
   DW_AT_location: Exprloc(Expression(EndianSlice { slice: [3, 0, 4, 0, 0], endian: LittleEndian }))<br>
GLOBAL_2 &lt;0x3e&gt;  DW_TAG_variable<br>
   DW_AT_name: DebugStrRef(DebugStrOffset(136))<br>
   DW_AT_type: UnitRef(UnitOffset(55))<br>
   DW_AT_external: Flag(true)<br>
   DW_AT_decl_file: FileIndex(1)<br>
   DW_AT_decl_line: Udata(2)<br>
   DW_AT_location: Exprloc(Expression(EndianSlice { slice: [3, 4, 4, 0, 0], endian: LittleEndian }))<br>
[elf_emit]<br>
[initialize_memories]</p>



<a name="258886580"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258886580" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258886580">(Oct 24 2021 at 16:35)</a>:</h4>
<p>we're close :)</p>
<p>(lldb) p my_global<br>
error: Couldn't materialize: couldn't get the value of variable my_global: read memory from 0x0 failed (0 of 4 bytes read)</p>
<p>that's expected, it is set at 0x0 right now. we can finally "see" the global in lldb.</p>



<a name="258886713"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258886713" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258886713">(Oct 24 2021 at 16:38)</a>:</h4>
<p>(lldb) fr v -g -l<br>
(float) my_other_global = &lt;read memory from 0x0 failed (0 of 4 bytes read)&gt;<br>
(float) my_global = &lt;read memory from 0x0 failed (0 of 4 bytes read)&gt;</p>
<p>that's new. got nothing previously.</p>
<p>just that remapping to nail somehow.</p>



<a name="258887861"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258887861" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258887861">(Oct 24 2021 at 17:03)</a>:</h4>
<p>we can't encode as a DW_OP_addr as we don't know the target address at the point of query. hence looking at DW_OP_call_ref which on initial reading might work. have no clue how to use it, so figuring that out is next.</p>



<a name="258888376"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258888376" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258888376">(Oct 24 2021 at 17:14)</a>:</h4>
<p>DW_OP_call_ref (0x9a) : 1 operand :  a 4- or 8-byte offset of DIE.</p>
<p>that'll do. can encode it with the wasm pointer then run whatever function it wants to decode it.<br>
don't of course have a clue how to specify the helper function.</p>



<a name="258888410"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258888410" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258888410">(Oct 24 2021 at 17:15)</a>:</h4>
<p>that's from dwarf4 spec, p167</p>



<a name="258888492"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258888492" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258888492">(Oct 24 2021 at 17:17)</a>:</h4>
<p>p24 :  DW_OP_call_ref performs subroutine calls during evaluation of a DWARF expression or location description</p>



<a name="258888577"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258888577" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258888577">(Oct 24 2021 at 17:19)</a>:</h4>
<p>"The operand is used as the offset of a debugging information entry in a .debug_info or .debug_types section which may be contained in a shared object or executable other than that containing the operator."</p>
<p>nope, that's not it :)</p>



<a name="258889345"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258889345" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258889345">(Oct 24 2021 at 17:39)</a>:</h4>
<p>DW_OP_push_object_address perhaps. if I can push wasm addr on the stack &amp; get that as parameter to function in OP_call_ref, that'd do.</p>



<a name="258889525"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258889525" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258889525">(Oct 24 2021 at 17:43)</a>:</h4>
<p>from the spec : "Values on the stack at the time of the call may be used as parameters by the called expression and values left on the stack by the called expression may be used as return values by prior agreement between the calling and called expressions"</p>
<p>might even work.</p>



<a name="258890597"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258890597" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258890597">(Oct 24 2021 at 18:08)</a>:</h4>
<p>Got it :)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">*</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span>#<span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">stop</span><span class="w"> </span><span class="n">reason</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">breakpoint</span><span class="w"> </span><span class="mf">1.1</span><span class="w"></span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span>#<span class="mi">0</span>: <span class="mh">0x0000017f1d1b127f</span><span class="w"> </span><span class="n">JIT</span><span class="p">(</span><span class="mh">0x17f1b52f6d0</span><span class="p">)</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">test</span><span class="p">.</span><span class="n">c</span>:<span class="mi">11</span>:<span class="mi">12</span><span class="w"></span>
<span class="w">   </span><span class="mi">8</span><span class="w"></span>
<span class="w">   </span><span class="mi">9</span><span class="w">    </span><span class="n">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="mi">10</span><span class="w">       </span><span class="n">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">my_global</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">my_other_global</span><span class="p">;</span><span class="w"></span>
-&gt; <span class="mi">11</span><span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="mi">12</span><span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span><span class="w"> </span><span class="n">fr</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">-</span><span class="n">g</span><span class="w"> </span><span class="o">-</span><span class="n">l</span><span class="w"></span>
<span class="p">(</span><span class="n">float</span><span class="p">)</span><span class="w"> </span><span class="n">my_other_global</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="n">read</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="mh">0x404</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">read</span><span class="p">)</span><span class="o">&gt;</span><span class="w"></span>
<span class="p">(</span><span class="n">float</span><span class="p">)</span><span class="w"> </span><span class="n">my_global</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="n">read</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="mh">0x400</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">read</span><span class="p">)</span><span class="o">&gt;</span><span class="w"></span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">__vmctx</span>-&gt;<span class="nc">set</span><span class="p">()</span><span class="w"></span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">float</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">resolve_vmctx_memory</span><span class="p">(</span><span class="mh">0x400</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="n">float</span><span class="p">)</span><span class="w"> </span><span class="cp">$</span><span class="mi">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
</code></pre></div>



<a name="258890765"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258890765" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258890765">(Oct 24 2021 at 18:12)</a>:</h4>
<p>decided to just pass the wasm pointer &amp; fix it on the other side.<br>
can hide the pointer ops behind the lldbg gui. <br>
unsure if its safe to resolve like this. <br>
perhaps we do need to use an evaluated expression to present the correct target address .<br>
downside of that is the resolved address will be visible &amp; we don't want to show that.</p>



<a name="258891145"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258891145" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258891145">(Oct 24 2021 at 18:22)</a>:</h4>
<p>global variables delivered to JIT debug interface - going with that if it's stable, which I'll figure out when I try it on something more complex.</p>



<a name="258891539"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258891539" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258891539">(Oct 24 2021 at 18:33)</a>:</h4>
<ul>
<li>wasm address, not pointer. we could perhaps present valid target address here without breaking wasm view as that's a level of indirection behind what you see in the debugger. you see thing not address of thing.  issue is if you do &amp;thing in debugger. so perhaps some fancy tricks for those with more patience on this than me. I just wanted it working. it works.</li>
</ul>



<a name="258933980"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258933980" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258933980">(Oct 25 2021 at 09:16)</a>:</h4>
<p>Perhaps extending DWARF format (&amp; lldb) by adding support for virtual addresses is the way to do this cleanly.</p>
<p>New  DW_AT_location op DW_OP_vaddr (virtual address) which lldb could resolve by calling a method in some die like we currently do manually with resolve_vmctx_memory.</p>
<p>That's more work than I can schedule right now, but the alternative is excessive complexity to work without it.</p>



<a name="258944943"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258944943" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258944943">(Oct 25 2021 at 11:19)</a>:</h4>
<p>rust is growing on me. steep learning curve, but impressive ecosystem. apologies for foul mood - had to get this done as spotted a gap. can take a chill pill now &amp; just work through it as &amp; when. wasmtime/cranelift crazy tech too &amp; I've only scratched the surface - great work all, appreciated.</p>
<p>with greatest respect, a few more comments in the code though, plz :)</p>
<p>it aids understanding &amp; that aids tracking down bugs faster.</p>
<p>apologies to any I've offended by going at this harder than was perhaps necessary.</p>



<a name="258946518"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258946518" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258946518">(Oct 25 2021 at 11:37)</a>:</h4>
<p>done, I think. at least first pass solution. apologies for pushing too hard. I wanted it fixed, so my problem, nobody else's. <br>
some experimentation &amp; tidy up, then happy to land this if it proves to be solid. concerned a virtual address could clash with a genuine system address &amp; thus cause lldb to interpret incorrectly. ensuring sandbox memory ptr is always &gt; 4GB address resolves that 32 bit wasmtime.</p>
<p>best solution is implement virtual addresses in DWARF spec &amp; lldb then everything is clear &amp; well structured. it'll happen at some point unless there's an objection.</p>



<a name="258986804"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258986804" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258986804">(Oct 25 2021 at 16:46)</a>:</h4>
<p><a href="/user_uploads/15107/DRukXAq5Y688XgXjzny96oBa/now.png">now.png</a> </p>
<div class="message_inline_image"><a href="/user_uploads/15107/DRukXAq5Y688XgXjzny96oBa/now.png" title="now.png"><img src="/user_uploads/15107/DRukXAq5Y688XgXjzny96oBa/now.png"></a></div><p>that's better :)</p>
<p>still optimizing out all my locals but that's the compiler.  almost sane.</p>



<a name="258995823"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/dbg%3A%20delivering%20global%20variables%20to%20JIT%20debug%20interface/near/258995823" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/dbg.3A.20delivering.20global.20variables.20to.20JIT.20debug.20interface.html#258995823">(Oct 25 2021 at 17:52)</a>:</h4>
<p>the above 4GB memory pool alloc for virtual address safety point above is incorrect. we have no idea if virtual addresses also represent a valid system address. hence lldb tweak once this is solid one way or another. politics of getting it in will be more hassle than the technical work, but can patch independently for our use. so can be done.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>