<html>
<head><meta charset="utf-8"><title>About `global.xxx` in the link test case in wasm-tools · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/index.html">general</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/About.20.60global.2Exxx.60.20in.20the.20link.20test.20case.20in.20wasm-tools.html">About `global.xxx` in the link test case in wasm-tools</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="431654546"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/About%20%60global.xxx%60%20in%20the%20link%20test%20case%20in%20wasm-tools/near/431654546" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lum1n0us <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/About.20.60global.2Exxx.60.20in.20the.20link.20test.20case.20in.20wasm-tools.html#431654546">(Apr 06 2024 at 08:38)</a>:</h4>
<p>I'm not sure about that. please feel free to correct me.</p>
<p>I noticed the <code>global.get</code> in <em>lib-foo</em> in <a href="https://github.com/bytecodealliance/wasm-tools/blob/main/crates/wit-component/tests/components/link/lib-foo.wat#L36">link case</a> is:</p>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code>    <span class="nb">local.get</span> <span class="mi">0</span>
    <span class="nb">global.get</span> <span class="nv">$um</span>
    <span class="nb">i32.load</span> <span class="k">offset</span><span class="o">=</span><span class="mi">16</span>
</code></pre></div>
<p>Because <em>lib-bar</em> will be linked with other wasm modules but run with its own <em>data area</em> (<code>(data $.data (global.get $__memory_base) "\04\00\00\00")</code>). Does it mean its <code>global.get</code> should read from <code>__memory_base + $offset</code>instead of <code>$offset</code>, in this case, <code>local.get 0</code> provides <code>$offset</code>?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasm-tools/blob/main/crates/wit-component/tests/components/link/lib-foo.wat#L36" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/779d4eab32a232b1c746dc26a9c29cd9b75f7056\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f376333646638396661646261323434663862356363616133663936363130383362316334313730636137373261643935623635336235633661343135343233622f62797465636f6465616c6c69616e63652f7761736d2d746f6f6c73)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasm-tools/blob/main/crates/wit-component/tests/components/link/lib-foo.wat#L36" title="wasm-tools/crates/wit-component/tests/components/link/lib-foo.wat at main · bytecodealliance/wasm-tools">wasm-tools/crates/wit-component/tests/components/link/lib-foo.wat at main · bytecodealliance/wasm-tools</a></div><div class="message_embed_description"> CLI and Rust libraries for low-level manipulation of WebAssembly modules  - bytecodealliance/wasm-tools</div></div></div>



<a name="431683581"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/About%20%60global.xxx%60%20in%20the%20link%20test%20case%20in%20wasm-tools/near/431683581" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/About.20.60global.2Exxx.60.20in.20the.20link.20test.20case.20in.20wasm-tools.html#431683581">(Apr 06 2024 at 15:47)</a>:</h4>
<p><code>wasm-tools component link</code> will synthesize an "init" module which is responsible for initializing all <code>GOT.mem</code> global variables based on the computed memory offsets, which means that by the time the <code>global.get</code> and <code>i32.load</code> instructions you linked to are run, the <code>$um</code> global variable has already been updated to point to the correct place in memory.  See <a href="https://github.com/WebAssembly/tool-conventions/blob/main/DynamicLinking.md#imports">https://github.com/WebAssembly/tool-conventions/blob/main/DynamicLinking.md#imports</a> for more details.  See also <a href="https://github.com/bytecodealliance/wasm-tools/blob/c85632b22db1fd7a6b9b7146fc1df204e19d5afb/crates/wit-component/src/linking.rs#L675-L697">https://github.com/bytecodealliance/wasm-tools/blob/c85632b22db1fd7a6b9b7146fc1df204e19d5afb/crates/wit-component/src/linking.rs#L675-L697</a> for where the code initializes the <code>GOT.mem</code> global variables based on the appropriate <code>__memory_base</code> value.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/tool-conventions/blob/main/DynamicLinking.md#imports" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/2004e71472b8f330dedabd13dba60ccb6c23726c\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f666632333738663231626664393164353663343366383837613738303164626237373435353230353263356464383939346432393839633764356338613862362f576562417373656d626c792f746f6f6c2d636f6e76656e74696f6e73)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/tool-conventions/blob/main/DynamicLinking.md#imports" title="tool-conventions/DynamicLinking.md at main · WebAssembly/tool-conventions">tool-conventions/DynamicLinking.md at main · WebAssembly/tool-conventions</a></div><div class="message_embed_description">Conventions supporting interoperatibility between tools working with WebAssembly. - WebAssembly/tool-conventions</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasm-tools/blob/c85632b22db1fd7a6b9b7146fc1df204e19d5afb/crates/wit-component/src/linking.rs#L675-L697" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/919cb119ed848642c856f50f89f87ee72e95bcd8\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f366666633431306238613364623331663063313964343335363031303739313131333964616638653939383736326230366165336237376339313333326530622f62797465636f6465616c6c69616e63652f7761736d2d746f6f6c73)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasm-tools/blob/c85632b22db1fd7a6b9b7146fc1df204e19d5afb/crates/wit-component/src/linking.rs#L675-L697" title="wasm-tools/crates/wit-component/src/linking.rs at c85632b22db1fd7a6b9b7146fc1df204e19d5afb · bytecodealliance/wasm-tools">wasm-tools/crates/wit-component/src/linking.rs at c85632b22db1fd7a6b9b7146fc1df204e19d5afb · bytecodealliance/wasm-tools</a></div><div class="message_embed_description"> CLI and Rust libraries for low-level manipulation of WebAssembly modules  - bytecodealliance/wasm-tools</div></div></div>



<a name="431683946"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/About%20%60global.xxx%60%20in%20the%20link%20test%20case%20in%20wasm-tools/near/431683946" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/About.20.60global.2Exxx.60.20in.20the.20link.20test.20case.20in.20wasm-tools.html#431683946">(Apr 06 2024 at 15:52)</a>:</h4>
<p>Also, here's the "init" module produced for the test case you linked to above: <a href="https://github.com/bytecodealliance/wasm-tools/blob/c85632b22db1fd7a6b9b7146fc1df204e19d5afb/crates/wit-component/tests/components/link/component.wat#L146-L182">https://github.com/bytecodealliance/wasm-tools/blob/c85632b22db1fd7a6b9b7146fc1df204e19d5afb/crates/wit-component/tests/components/link/component.wat#L146-L182</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasm-tools/blob/c85632b22db1fd7a6b9b7146fc1df204e19d5afb/crates/wit-component/tests/components/link/component.wat#L146-L182" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/919cb119ed848642c856f50f89f87ee72e95bcd8\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f366666633431306238613364623331663063313964343335363031303739313131333964616638653939383736326230366165336237376339313333326530622f62797465636f6465616c6c69616e63652f7761736d2d746f6f6c73)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasm-tools/blob/c85632b22db1fd7a6b9b7146fc1df204e19d5afb/crates/wit-component/tests/components/link/component.wat#L146-L182" title="wasm-tools/crates/wit-component/tests/components/link/component.wat at c85632b22db1fd7a6b9b7146fc1df204e19d5afb · bytecodealliance/wasm-tools">wasm-tools/crates/wit-component/tests/components/link/component.wat at c85632b22db1fd7a6b9b7146fc1df204e19d5afb · bytecodealliance/wasm-tools</a></div><div class="message_embed_description"> CLI and Rust libraries for low-level manipulation of WebAssembly modules  - bytecodealliance/wasm-tools</div></div></div>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>