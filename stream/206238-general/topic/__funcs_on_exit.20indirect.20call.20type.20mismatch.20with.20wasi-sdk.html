<html>
<head><meta charset="utf-8"><title>__funcs_on_exit indirect call type mismatch with wasi-sdk · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/index.html">general</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html">__funcs_on_exit indirect call type mismatch with wasi-sdk</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="195589833"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195589833" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195589833">(Apr 28 2020 at 16:29)</a>:</h4>
<p>Howdy!  I'm trying to run a fairly large C/C++ test suite built on top of Catch2, compiled with wasi-sdk v10 and running with wasmtime.  I'm getting a fail on exit:</p>
<div class="codehilite"><pre><span></span><code>===============================================================================
All tests passed (142033 assertions in 116 test cases)
Error: failed to run main module `/var/folders/zs/m4nj7dw15v54xf284j66fbth0000gp/T/Pram_IfXpoFVmPpbidgbO9vvp/g==/WasiRunner/16149EC0-pram-baselib-tests-debug.wasm/app/baselib-tests-debug.wasm`

Caused by:
    0: failed to invoke `_start`
    1: wasm trap: indirect call type mismatch, source location: @9e416a
       wasm backtrace:
         0: &lt;unknown&gt;!__funcs_on_exit
         1: &lt;unknown&gt;!__prepare_for_exit
         2: &lt;unknown&gt;!_start
</code></pre></div>


<p>There's no call to atexit in the code, so I'm guessing it's due to some generated __cxa_atexit with the wrong function signature.  Is there any reasonable way for me to figure out which function has the wrong signature?</p>



<a name="195591373"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195591373" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195591373">(Apr 28 2020 at 16:39)</a>:</h4>
<p>Is it possible to recompile the test suite with debug info and use a debugger with wasmtime?</p>



<a name="195591565"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195591565" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195591565">(Apr 28 2020 at 16:40)</a>:</h4>
<p>mm. Good idea; I do have debug info, I didn't actually think to use a debugger here.  Let me try that</p>



<a name="195591583"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195591583" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195591583">(Apr 28 2020 at 16:40)</a>:</h4>
<p>/me is interested in assisting with troubleshooting any problems with running that setup</p>



<a name="195591729"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195591729" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195591729">(Apr 28 2020 at 16:41)</a>:</h4>
<p>wasmtime transforms wasm DWARF if <code>-g</code> is provided (works by default with lldb/linux, though there is a PR for gdb)</p>



<a name="195591907"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195591907" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195591907">(Apr 28 2020 at 16:43)</a>:</h4>
<p>do I just lldb on wasmtime itself, or is there a gdbserver-like thing to attach to?  Also running with <code>-g</code>, I'm getting:</p>
<div class="codehilite"><pre><span></span><code>Error: failed to run main module `...`
Caused by:
    0: Debug information error
    1: Invalid opcode in DWARF expression
</code></pre></div>



<a name="195591975"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195591975" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195591975">(Apr 28 2020 at 16:44)</a>:</h4>
<p>okay, looks like an old wasmtime</p>



<a name="195592037"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195592037" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195592037">(Apr 28 2020 at 16:44)</a>:</h4>
<p>yeah, it's 0.15 -- I'm building from git right now</p>



<a name="195592071"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195592071" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195592071">(Apr 28 2020 at 16:44)</a>:</h4>
<p>I recommend ;) <a href="https://github.com/bytecodealliance/wasmtime/pull/1572" title="https://github.com/bytecodealliance/wasmtime/pull/1572">https://github.com/bytecodealliance/wasmtime/pull/1572</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/1572" style="background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/1572" title="Fix value label ranges resolution by yurydelendik · Pull Request #1572 · bytecodealliance/wasmtime">Fix value label ranges resolution by yurydelendik · Pull Request #1572 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">There was a bug how value labels were resolved, which caused some DWARF expressions not be transformed, e.g. those are in the registers.

Patch built on top of #1542
Documentation for ValueLocRange...</div></div></div>



<a name="195592241"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195592241" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195592241">(Apr 28 2020 at 16:45)</a>:</h4>
<p>do I want your branch, or master -- or merge of the two?</p>



<a name="195592354"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195592354" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195592354">(Apr 28 2020 at 16:46)</a>:</h4>
<p>I rebased on top of master today</p>



<a name="195592544"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195592544" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195592544">(Apr 28 2020 at 16:47)</a>:</h4>
<p>ah there's a merge conflict with master still</p>



<a name="195592730"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195592730" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195592730">(Apr 28 2020 at 16:48)</a>:</h4>
<p>right, I'll resolve that shortly, the branch can be used as is</p>



<a name="195592803"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195592803" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195592803">(Apr 28 2020 at 16:49)</a>:</h4>
<p>erm, right. sorry, operating on too little sleep :)</p>



<a name="195593770"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195593770" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195593770">(Apr 28 2020 at 16:55)</a>:</h4>
<p>/me rebased PRs just to have that clean from conflicts</p>



<a name="195598917"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195598917" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195598917">(Apr 28 2020 at 17:30)</a>:</h4>
<p>Arg, I need a newer lldb on mac</p>



<a name="195601311"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195601311" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195601311">(Apr 28 2020 at 17:47)</a>:</h4>
<p>that might be a problem, only version of brew's lldb can do it, I think</p>



<a name="195601684"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195601684" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195601684">(Apr 28 2020 at 17:49)</a>:</h4>
<p>and just for MacOSX, ".lldbinit" needs <code>settings set plugin.jit-loader.gdb.enable on</code></p>



<a name="195601774"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195601774" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195601774">(Apr 28 2020 at 17:50)</a>:</h4>
<p>/me has <code>lldb version 9.0.0</code> on mac</p>



<a name="195603944"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195603944" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195603944">(Apr 28 2020 at 18:07)</a>:</h4>
<p>ah it was the lldbinit piece I was missing!  lldb 10.0 from brew works:</p>
<div class="codehilite"><pre><span></span><code>(lldb) bt
* thread #1, queue = &#39;com.apple.main-thread&#39;, stop reason = EXC_BAD_INSTRUCTION (code=EXC_I386_INVOP, subcode=0x0)
  * frame #0: 0x000000016ec53806 JIT(0x17d700000)`__funcs_on_exit at &lt;gen-1&gt;.wasm:10371434
    frame #1: 0x000000016ec53695 JIT(0x17d700000)`__prepare_for_exit at &lt;gen-1&gt;.wasm:10371335
    frame #2: 0x000000016da007be JIT(0x17d700000)`_start at &lt;gen-1&gt;.wasm:47534
    frame #3: 0x000000016ec6ace3
    frame #4: 0x000000010013b33a wasmtime`wasmtime::func::Func::call::_$u7b$$u7b$closure$u7d$$u7d$::h519bce4b59bf0f7c at func.rs:566:20
    frame #5: 0x0000000100161ba8 wasmtime`wasmtime_runtime::traphandlers::catch_traps::call_closure::h991a454e37488ebb(payload=&quot;P\x95���&quot;) at traphandlers.rs:385:17
    frame #6: 0x00000001005d0fd6 wasmtime`RegisterSetjmp(buf_storage=0x00007ffeefbf9370, body=(wasmtime`wasmtime_runtime::traphandlers::catch_traps::call_closure::h991a454e37488ebb at traphandlers.rs:381), payload=0x00007ffeefbf9230) at helpers.c:12:3
</code></pre></div>



<a name="195604002"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195604002" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195604002">(Apr 28 2020 at 18:07)</a>:</h4>
<p>of course now I need a libc with debug info</p>



<a name="195604213"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195604213" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195604213">(Apr 28 2020 at 18:09)</a>:</h4>
<p>because it's not clear how to figure out what it's actually trying to call -- I'm guessing with debug symbols, I'll be able to inspect the actual function pointer value, which should tell me the actual bad function?</p>



<a name="195604242"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195604242" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195604242">(Apr 28 2020 at 18:09)</a>:</h4>
<p>yeah, that's a hope</p>



<a name="195604461"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195604461" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195604461">(Apr 28 2020 at 18:10)</a>:</h4>
<p>you can also <code>dis</code> and check registers: maybe some value from params will pop</p>



<a name="195604556"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195604556" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195604556">(Apr 28 2020 at 18:11)</a>:</h4>
<p>this is actually a little annoying.  cranelift knows it's a bad signature.  would be handy if it could show me what the "bad" one was (and expected, though in this case I know what's expected)</p>



<a name="195604679"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195604679" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195604679">(Apr 28 2020 at 18:12)</a>:</h4>
<p>under the hood it is just an (signature) ID</p>



<a name="195604778"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195604778" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195604778">(Apr 28 2020 at 18:13)</a>:</h4>
<p>sure, but that id is described in the wasm module</p>



<a name="195604906"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195604906" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195604906">(Apr 28 2020 at 18:14)</a>:</h4>
<p>not really, more like engine assigned id/handle</p>



<a name="195605031"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195605031" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195605031">(Apr 28 2020 at 18:15)</a>:</h4>
<p>I wonder if  frame <code>var</code>s are inspectable</p>



<a name="195605045"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195605045" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195605045">(Apr 28 2020 at 18:15)</a>:</h4>
<p>they don't seem to be</p>



<a name="195605177"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195605177" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195605177">(Apr 28 2020 at 18:16)</a>:</h4>
<p>in wasmtime you can choose cranelift optimization e.g. via <code>--opt-level 0</code></p>



<a name="195605351"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195605351" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195605351">(Apr 28 2020 at 18:18)</a>:</h4>
<p>function "pointer" indices are direct indices into a table, right?  funcptr value "1" == index 1</p>



<a name="195605373"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195605373" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195605373">(Apr 28 2020 at 18:18)</a>:</h4>
<p>I think I can use the wat output and figure out all the calls to cxa_atexit</p>



<a name="195605403"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195605403" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195605403">(Apr 28 2020 at 18:18)</a>:</h4>
<p>right</p>



<a name="195605452"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195605452" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195605452">(Apr 28 2020 at 18:19)</a>:</h4>
<p>fwiw, 10371335 is bytecode offset in wasm in <code>&lt;gen-1&gt;.wasm:10371335</code></p>



<a name="195605642"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195605642" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195605642">(Apr 28 2020 at 18:20)</a>:</h4>
<p>/me is not sure <a href="https://wasdk.github.io/wasmcodeexplorer/" title="https://wasdk.github.io/wasmcodeexplorer/">https://wasdk.github.io/wasmcodeexplorer/</a> can handle that large file though</p>



<a name="195605650"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195605650" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195605650">(Apr 28 2020 at 18:20)</a>:</h4>
<p>how do I get the wasm heap base address in lldb?</p>



<a name="195605702"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195605702" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195605702">(Apr 28 2020 at 18:21)</a>:</h4>
<p>is there __vmctx defined?</p>



<a name="195605748"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195605748" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195605748">(Apr 28 2020 at 18:21)</a>:</h4>
<p>if yes, <code>__vmctx-&gt;memory</code> shall do it</p>



<a name="195605763"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195605763" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195605763">(Apr 28 2020 at 18:21)</a>:</h4>
<p>mm I can try, I was just using wasm2wat</p>



<a name="195605803"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195605803" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195605803">(Apr 28 2020 at 18:21)</a>:</h4>
<p>__vmctx wasn't available, trying with opt-level 0 though</p>



<a name="195605875"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195605875" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195605875">(Apr 28 2020 at 18:22)</a>:</h4>
<p>(thanks for your help btw!)</p>



<a name="195606358"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195606358" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195606358">(Apr 28 2020 at 18:25)</a>:</h4>
<p>heh, <code>--opt-level 0</code> made things worse :)  (I have vmctx from a different frame turns out)  With it I lose some local vars:</p>
<div class="codehilite"><pre><span></span><code>(int) var0 = &lt;variable not available&gt;
(int) var1 = 211424
(int) var2 = &lt;variable not available&gt;
</code></pre></div>


<p>without (default):</p>
<div class="codehilite"><pre><span></span><code>(int) var0 = 52080
(int) var1 = 211424
(int) var2 = 277217280
</code></pre></div>



<a name="195606518"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195606518" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195606518">(Apr 28 2020 at 18:26)</a>:</h4>
<p>hmm... yeah... okay, I need to fix more stuff then</p>



<a name="195606740"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195606740" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195606740">(Apr 28 2020 at 18:28)</a>:</h4>
<p>you can try setting a breakpoint (on symbols?), see if non-trap will give you more info</p>



<a name="195606798"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195606798" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195606798">(Apr 28 2020 at 18:28)</a>:</h4>
<p>my strategy of "let me read ints from memory at various local var addresses (also double-dereferenced) in hopes of finding the function pointer index" did not succeed</p>



<a name="195607554"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195607554" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195607554">(Apr 28 2020 at 18:34)</a>:</h4>
<p>right, having source code / DWARF for wasi-sdk might give you more clues for its location</p>



<a name="195614769"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195614769" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195614769">(Apr 28 2020 at 19:35)</a>:</h4>
<p>I just realized I can also just.. put a printf inside funcs_atexit to print the indices as they're called</p>



<a name="195616358"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195616358" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195616358">(Apr 28 2020 at 19:47)</a>:</h4>
<p><code>printf</code>: my favourite debugging technique when debugging miscompilations of cg_clif.</p>



<a name="195622099"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195622099" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195622099">(Apr 28 2020 at 20:26)</a>:</h4>
<p>It would be _really nice_ to have some kind of wasm intrinsics for working with function signatures.  I'd love to be able to add an <code>assert(__wasm_signature_type(funcptr) == __wasm_signature_type(KnownGoodFunction))</code> in <code>__cxa_atexit</code> and give the user a good warning</p>



<a name="195624560"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195624560" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195624560">(Apr 28 2020 at 20:46)</a>:</h4>
<p>That was extremely painful, but it looks like the culprit is <code>$std::__2::vector&lt;Baselib_Memory_PageState__std::__2::allocator&lt;Baselib_Memory_PageState&gt;_&gt;::~vector__</code></p>



<a name="195624614"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195624614" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195624614">(Apr 28 2020 at 20:47)</a>:</h4>
<p>which returns an i32, instead of returning void</p>



<a name="195625887"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195625887" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195625887">(Apr 28 2020 at 20:57)</a>:</h4>
<div class="codehilite"><pre><span></span><code>   // Under some ABIs, destructors return this instead of void, and cannot be
   // passed directly to __cxa_atexit if the target does not allow this
   // mismatch.
</code></pre></div>



<a name="195626059"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195626059" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195626059">(Apr 28 2020 at 20:58)</a>:</h4>
<p>er.. this seems like a llvm bug, because <code>canCallMismatchedFunctionType</code> should definitely be false for wasm</p>



<a name="195626302"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195626302" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195626302">(Apr 28 2020 at 21:00)</a>:</h4>
<p>now I have 3hrs of meetings but I will fix this :)</p>



<a name="195626429"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195626429" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195626429">(Apr 28 2020 at 21:01)</a>:</h4>
<p><span class="user-mention" data-user-id="297507">@Vladimir Vukicevic</span> it should be returning false already: <a href="https://github.com/llvm/llvm-project/blob/master/clang/lib/CodeGen/ItaniumCXXABI.cpp#L517" title="https://github.com/llvm/llvm-project/blob/master/clang/lib/CodeGen/ItaniumCXXABI.cpp#L517">https://github.com/llvm/llvm-project/blob/master/clang/lib/CodeGen/ItaniumCXXABI.cpp#L517</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/llvm/llvm-project/blob/master/clang/lib/CodeGen/ItaniumCXXABI.cpp#L517" style="background-image: url(https://avatars2.githubusercontent.com/u/17149993?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/llvm/llvm-project/blob/master/clang/lib/CodeGen/ItaniumCXXABI.cpp#L517" title="llvm/llvm-project">llvm/llvm-project</a></div><div class="message_embed_description">The LLVM Project is a collection of modular and reusable compiler and toolchain technologies. Note: the repository does not accept github pull requests at this moment. Please submit your patches at...</div></div></div>



<a name="195631767"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195631767" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195631767">(Apr 28 2020 at 21:49)</a>:</h4>
<p>does wasm/wasi use the itanium ABI?</p>



<a name="195631912"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195631912" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195631912">(Apr 28 2020 at 21:50)</a>:</h4>
<p>i'm trying to create a small repro</p>



<a name="195631926"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195631926" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195631926">(Apr 28 2020 at 21:50)</a>:</h4>
<p>it uses a variant of the Itanium ABI</p>



<a name="195632141"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195632141" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195632141">(Apr 28 2020 at 21:52)</a>:</h4>
<p><a href="https://github.com/llvm/llvm-project/blob/master/clang/include/clang/Basic/TargetCXXABI.h#L91" title="https://github.com/llvm/llvm-project/blob/master/clang/include/clang/Basic/TargetCXXABI.h#L91">https://github.com/llvm/llvm-project/blob/master/clang/include/clang/Basic/TargetCXXABI.h#L91</a> if anyone is curious :-)</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/llvm/llvm-project/blob/master/clang/include/clang/Basic/TargetCXXABI.h#L91" style="background-image: url(https://avatars2.githubusercontent.com/u/17149993?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/llvm/llvm-project/blob/master/clang/include/clang/Basic/TargetCXXABI.h#L91" title="llvm/llvm-project">llvm/llvm-project</a></div><div class="message_embed_description">The LLVM Project is a collection of modular and reusable compiler and toolchain technologies. Note: the repository does not accept github pull requests at this moment. Please submit your patches at...</div></div></div>



<a name="195639382"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195639382" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195639382">(Apr 28 2020 at 22:58)</a>:</h4>
<p><span class="user-mention" data-user-id="254083">@Dan Gohman</span> you may know this (hi, btw!) -- in my broken case, the bad <code>__cxa_atexit</code> destructor call setup is happening from a <code>__cxx_global_var_init.77</code> function.  Does that seem sane for global_var_init to do that?</p>



<a name="195639551"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195639551" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195639551">(Apr 28 2020 at 23:00)</a>:</h4>
<p>Yeah. Wasm doesn't have an equivalent of .fini or .dtors in other platforms, so the global var inits have to register their associated destructor calls with __cxa_atexit</p>



<a name="195639570"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195639570" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195639570">(Apr 28 2020 at 23:01)</a>:</h4>
<p>Also, hi! <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span></p>



<a name="195639906"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195639906" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195639906">(Apr 28 2020 at 23:04)</a>:</h4>
<p>but I see global dtors also being called from <code>__cxx_global_array_dtor</code> functions too</p>



<a name="195640284"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195640284" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195640284">(Apr 28 2020 at 23:07)</a>:</h4>
<p>__cxx_global_array_dtor is the function that gets registered with __cxa_atexit, which calls the dtors</p>



<a name="195640663"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195640663" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195640663">(Apr 28 2020 at 23:12)</a>:</h4>
<p>well -- no, in my case I see a dtor being _directly_ registered with __cxa_atexit from a global_var_init</p>



<a name="195640708"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195640708" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195640708">(Apr 28 2020 at 23:13)</a>:</h4>
<div class="codehilite"><pre><span></span><code>  (func $__cxx_global_var_init.77 (type $t9)
    (local $l0 i32) (local $l1 i32) (local $l2 i32) (local $l3 i32) (local $l4 i32)
    i32.const 2171
    local.set $l0
    i32.const 0
    local.set $l1
    i32.const 1024
    local.set $l2
    i32.const 211420
    local.set $l3
    i32.const 151088
    local.set $l4
    local.get $l3
    local.get $l4
    call $std::__2::basic_string&lt;char__std::__2::char_traits&lt;char&gt;__std::__2::allocator&lt;char&gt;_&gt;::basic_string&lt;std::nullptr_t&gt;_char_const*_
    drop
    local.get $l0
    local.get $l1
    local.get $l2
    call $__cxa_atexit
    drop
    return)
</code></pre></div>


<p>in my case <code>$l0 = 2171</code> is the bad-signature vector dtor being passed to cxa_atexit</p>



<a name="195641004"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195641004" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195641004">(Apr 28 2020 at 23:17)</a>:</h4>
<p>Hmm. That does seem odd. wasm destructors return i32, so I wouldn't think they could be registered with __cxa_atexit like that</p>



<a name="195641012"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195641012" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195641012">(Apr 28 2020 at 23:17)</a>:</h4>
<p>yep, that's the bug :)</p>



<a name="195641142"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195641142" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195641142">(Apr 28 2020 at 23:19)</a>:</h4>
<p>Is that a std::string? When I try a simple testcase with std::string, it registers <code>__cxx_global_array_dtor</code> with <code>__cxa_atexit</code>, and <code>__cxx_global_array_dtor</code> calls the dtor</p>



<a name="195641149"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195641149" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195641149">(Apr 28 2020 at 23:19)</a>:</h4>
<p>I need to try <code>-fregister-global-dtors-with-atexit</code> but I really want to get to a small repro, this massive unified test runner is not great to work with :)</p>



<a name="195641292"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195641292" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195641292">(Apr 28 2020 at 23:21)</a>:</h4>
<p>it's also totally possible that the wrong function pointer is being used here somehow too</p>



<a name="195641453"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195641453" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195641453">(Apr 28 2020 at 23:23)</a>:</h4>
<p>Oh, awkward. It looks like -fregister-global-dtors-with-atexit does the same thing as what the wasm backend does with global dtors</p>



<a name="195641826"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195641826" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195641826">(Apr 28 2020 at 23:29)</a>:</h4>
<p>Ooh. ignore my WAT paste above, the actual number is 2170 (which is still the dtor)</p>



<a name="195641936"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195641936" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195641936">(Apr 28 2020 at 23:30)</a>:</h4>
<p>ok, 2170 is the same problem, just in a different <code>__cxx_global_var_init.5.37</code>.  the ctor right before it is <code>    call $std::__2::vector&lt;Baselib_Memory_PageState__std::__2::allocator&lt;Baselib_Memory_PageState&gt;_&gt;::vector_std::initializer_list&lt;Baselib_Memory_PageState&gt;_</code>, let me see if I can create something like this</p>



<a name="195642344"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195642344" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195642344">(Apr 28 2020 at 23:37)</a>:</h4>
<p>Baselib_Memory_PageState is just an enum, nothing crazy.</p>



<a name="195642776"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195642776" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195642776">(Apr 28 2020 at 23:44)</a>:</h4>
<p>Yeah, I can't reproduce this in a small testcase.  The thing that's wrong is the only vector dtor that's in the function ptr table (lots of other dtors, I assume due to vtables).  In a clang link command that outputs wasm, how do I get it to output bitcode or LLMV IR?</p>



<a name="195644060"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195644060" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195644060">(Apr 28 2020 at 23:58)</a>:</h4>
<p>I don't know of a way to get it to emit llvm ir when producing wasm. It doesn't produce a linked LLVM IR image unless you're using -flto</p>



<a name="195645369"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195645369" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195645369">(Apr 29 2020 at 00:15)</a>:</h4>
<p>I'm now at a bit of a loss how to proceed.  I _think_ the most useful next steps will be one of:</p>
<ol>
<li>see if I can get some kind of whole-program/LTO bitcode that I can decompile to IR, and see if the problem is visible there</li>
<li>see if I can find in one of the object files the actual issue</li>
<li>???</li>
</ol>



<a name="195645446"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195645446" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195645446">(Apr 29 2020 at 00:16)</a>:</h4>
<p>Can you determine which source file defines the object with the destructor in question?</p>



<a name="195645485"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195645485" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195645485">(Apr 29 2020 at 00:17)</a>:</h4>
<p>Yeah I'm pretty sure I can</p>



<a name="195645646"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195645646" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195645646">(Apr 29 2020 at 00:20)</a>:</h4>
<p>If you can compile that source file to .o, we could see if the problem is present there, or if it gets introduced at link time</p>



<a name="195646049"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195646049" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195646049">(Apr 29 2020 at 00:28)</a>:</h4>
<div class="codehilite"><pre><span></span><code>define internal void @__cxx_global_var_init.27() #0 !dbg !13235 {
  %1 = alloca %&quot;class.std::initializer_list&quot;, align 4
  %2 = alloca [6 x i32], align 4
  %3 = getelementptr inbounds [6 x i32], [6 x i32]* %2, i32 0, i32 0, !dbg !13236
  %4 = bitcast [6 x i32]* %2 to i8*, !dbg !13236
  call void @llvm.memcpy.p0i8.p0i8.i32(i8* align 4 %4, i8* align 4 bitcast ([6 x i32]* @constinit to i8*), i32 24, i1 false), !dbg !13236
  %5 = getelementptr inbounds %&quot;class.std::initializer_list&quot;, %&quot;class.std::initializer_list&quot;* %1, i32 0, i32 0, !dbg !13236
  %6 = getelementptr inbounds [6 x i32], [6 x i32]* %2, i32 0, i32 0, !dbg !13236
  store i32* %6, i32** %5, align 4, !dbg !13236
  %7 = getelementptr inbounds %&quot;class.std::initializer_list&quot;, %&quot;class.std::initializer_list&quot;* %1, i32 0, i32 1, !dbg !13236
  store i32 6, i32* %7, align 4, !dbg !13236
  %8 = call %&quot;class.std::__2::vector.6&quot;* @_ZNSt3__26vectorI24Baselib_Memory_PageStateNS_9allocatorIS1_EEEC2ESt16initializer_listIS1_E(%&quot;class.std::__2::vector.6&quot;* @pageStatesAll, %&quot;class.std::initializer_list&quot;* byval(%&quot;class.std::initializer_list&quot;) align 4 %1), !dbg !13236
  %9 = call i32 @__cxa_atexit(void (i8*)* @__cxx_global_array_dtor.28, i8* null, i8* @__dso_handle) #4, !dbg !13236
  ret void, !dbg !13236
}
</code></pre></div>



<a name="195646057"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195646057" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195646057">(Apr 29 2020 at 00:28)</a>:</h4>
<p>pretty sure that's it, and it looks fine :|</p>



<a name="195646106"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195646106" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195646106">(Apr 29 2020 at 00:29)</a>:</h4>
<p>Is this an optimized build?</p>



<a name="195646117"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195646117" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195646117">(Apr 29 2020 at 00:29)</a>:</h4>
<p>And if so, do you have wasm-opt in your PATH?</p>



<a name="195646126"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195646126" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195646126">(Apr 29 2020 at 00:29)</a>:</h4>
<p>debug build (-g -O0)</p>



<a name="195646181"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195646181" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195646181">(Apr 29 2020 at 00:30)</a>:</h4>
<p>Can you do <code>wasm2wat</code> on the .o file?</p>



<a name="195646185"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195646185" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195646185">(Apr 29 2020 at 00:30)</a>:</h4>
<p>tried, I get "0001e60: error: invalid section code: 12"</p>



<a name="195646198"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195646198" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195646198">(Apr 29 2020 at 00:30)</a>:</h4>
<p>(brb, meeting, sigh)</p>



<a name="195646210"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195646210" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195646210">(Apr 29 2020 at 00:30)</a>:</h4>
<p>or <code>llvm-objdump -d</code> (which works now \o/)</p>



<a name="195646304"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195646304" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195646304">(Apr 29 2020 at 00:32)</a>:</h4>
<p>I can do llvm-objdump.. but not sure how to tell if the result is useful, I don't get any symbol/function names</p>



<a name="195646330"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195646330" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195646330">(Apr 29 2020 at 00:33)</a>:</h4>
<p>wasm2wat may need --enable-bulk-memory</p>



<a name="195646398"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195646398" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195646398">(Apr 29 2020 at 00:34)</a>:</h4>
<p>Or if your wasm2wat is new enough, --enable-all should do it</p>



<a name="195646412"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195646412" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195646412">(Apr 29 2020 at 00:34)</a>:</h4>
<p>yep that worked.  let's see</p>



<a name="195646437"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195646437" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195646437">(Apr 29 2020 at 00:35)</a>:</h4>
<div class="codehilite"><pre><span></span><code>  (func $__cxx_global_var_init.27 (type $t0)
    (local $l0 i32) (local $l1 i32) (local $l2 i32) (local $l3 i32) (local $l4 i32) (local $l5 i32) (local $l6 i32) (local $l7 i32) (local $l8 i32) (local $l9 i32) (local $l10 i64) (local $l11 i32) (local $l12 i32) (local $l13 i64) (local $l14 i64) (local $l15 i64) (local $l16 i32) (local $l17 i32) (local $l18 i32) (local $l19 i32) (local $l20 i32) (local $l21 i32) (local $l22 i32) (local $l23 i32)
    global.get $env.__stack_pointer
    local.set $l0
    i32.const 48
    local.set $l1
    local.get $l0
    local.get $l1
    i32.sub
    local.set $l2
    local.get $l2
    global.set $env.__stack_pointer
    i32.const 6
    local.set $l3
    i32.const 16
    local.set $l4
    local.get $l2
    local.get $l4
    i32.add
    local.set $l5
    local.get $l5
    local.set $l6
    i32.const 16
    local.set $l7
    local.get $l6
    local.get $l7
    i32.add
    local.set $l8
    i32.const 0
    local.set $l9
    local.get $l9
    i64.load offset=648 align=4
    local.set $l10
    local.get $l8
    local.get $l10
    i64.store align=4
    i32.const 8
    local.set $l11
    local.get $l6
    local.get $l11
    i32.add
    local.set $l12
    local.get $l9
    i64.load offset=640 align=4
    local.set $l13
    local.get $l12
    local.get $l13
    i64.store align=4
    local.get $l9
    i64.load offset=632 align=4
    local.set $l14
    local.get $l6
    local.get $l14
    i64.store align=4
    local.get $l2
    local.get $l6
    i32.store offset=40
    local.get $l2
    local.get $l3
    i32.store offset=44
    local.get $l2
    i64.load offset=40
    local.set $l15
    local.get $l2
    local.get $l15
    i64.store offset=8
    i32.const 620
    local.set $l16
    i32.const 8
    local.set $l17
    local.get $l2
    local.get $l17
    i32.add
    local.set $l18
    local.get $l16
    local.get $l18
    call $_ZNSt3__26vectorI24Baselib_Memory_PageStateNS_9allocatorIS1_EEEC2ESt16initializer_listIS1_E
    drop
    i32.const 16
    local.set $l19
    i32.const 0
    local.set $l20
    i32.const 0
    local.set $l21
    i32.const 620
    drop
    local.get $l19
    local.get $l20
    local.get $l21
    call $env.__cxa_atexit
    drop
    i32.const 48
    local.set $l22
    local.get $l2
    local.get $l22
    i32.add
    local.set $l23
    local.get $l23
    global.set $env.__stack_pointer
    return)
</code></pre></div>



<a name="195646445"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195646445" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195646445">(Apr 29 2020 at 00:35)</a>:</h4>
<p>gah sorry, long paste</p>



<a name="195646463"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195646463" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195646463">(Apr 29 2020 at 00:36)</a>:</h4>
<p>ok, so it has a 0, so there's presumably a relocation to fill it iin</p>



<a name="195646513"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195646513" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195646513">(Apr 29 2020 at 00:36)</a>:</h4>
<p><code>llvm-objdump -d -r</code> on the .o file should show the relocations</p>



<a name="195649068"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195649068" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195649068">(Apr 29 2020 at 01:11)</a>:</h4>
<p>(ok meetings all done)  What am I looking for in the -d -r output?  the tail end looks like</p>
<div class="codehilite"><pre><span></span><code>    f598: 10 d4 81 80 80 00             call    212
            0000f599:  R_WASM_FUNCTION_INDEX_LEB    _ZNSt3__26vectorI24Baselib_Memory_PageStateNS_9allocatorIS1_EEEC2ESt16initializer_listIS1_E+0
    f59e: 1a                            drop
    f59f: 41 90 80 80 80 00             i32.const   16
            0000f5a0:  R_WASM_TABLE_INDEX_SLEB  __cxx_global_array_dtor.28+0
    f5a5: 21 13                         local.set   19
    f5a7: 41 00                         i32.const   0
    f5a9: 21 14                         local.set   20
    f5ab: 41 80 80 80 80 00             i32.const   0
            0000f5ac:  R_WASM_MEMORY_ADDR_SLEB  __dso_handle+0
    f5b1: 21 15                         local.set   21
    f5b3: 41 ec 84 80 80 00             i32.const   620
            0000f5b4:  R_WASM_MEMORY_ADDR_SLEB  pageStatesAll+0
    f5b9: 1a                            drop
    f5ba: 20 13                         local.get   19
    f5bc: 20 14                         local.get   20
    f5be: 20 15                         local.get   21
    f5c0: 10 80 80 80 80 00             call    0
            0000f5c1:  R_WASM_FUNCTION_INDEX_LEB    __cxa_atexit+0
    f5c6: 1a                            drop
    f5c7: 41 30                         i32.const   48
    f5c9: 21 16                         local.set   22
    f5cb: 20 02                         local.get   2
    f5cd: 20 16                         local.get   22
    f5cf: 6a                            i32.add
    f5d0: 21 17                         local.set   23
    f5d2: 20 17                         local.get   23
    f5d4: 24 80 80 80 80 00             global.set  0
            0000f5d5:  R_WASM_GLOBAL_INDEX_LEB  __stack_pointer+0
    f5da: 0f                            return
    f5db: 0b                            end
</code></pre></div>


<p>which looks correct unfortunately</p>



<a name="195649333"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195649333" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195649333">(Apr 29 2020 at 01:14)</a>:</h4>
<p>I just audited all __cxa_atexit calls in this file and everything looks fine.  This is the only file that the relevant type (the Baselib_Memory_PageState) enum/vector appears in</p>



<a name="195650618"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195650618" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195650618">(Apr 29 2020 at 01:40)</a>:</h4>
<p>Here's what I've got.  All the global_var_inits from this function set up a cxa_atexit with a global_array_dtor function, except for the bad one.  The bad one is the "right" (consistent) index:</p>
<div class="codehilite"><pre><span></span><code>(func $_GLOBAL__sub_I_Baselib_Memory_Tests_Wasi.cpp (type $t9)
    call $__cxx_global_var_init.76     -&gt; cxa_atexit with 2167      __cxx_global_array_dtor.78
    call $__cxx_global_var_init.1.46   -&gt; cxa_atexit with 2168      __cxx_global_array_dtor.2.46
    call $__cxx_global_var_init.3.46   -&gt; cxa_atexit with 2169      __cxx_global_array_dtor.4.46
    call $__cxx_global_var_init.5.37   -&gt; cxa_atexit with ... 2170  $std::__2::vector&lt;Baselib_Memory_PageState__std::__2::allocator&lt;Baselib_Memory_PageState&gt;_&gt;::~vector__
    return)
</code></pre></div>


<p>(with annotations of what funcptr index they call and what the actual thing is)</p>



<a name="195650899"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195650899" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195650899">(Apr 29 2020 at 01:46)</a>:</h4>
<p>Ok, I had the wrong things earlier.   Based on that, the issue is in <code>var_init.5</code> in that file.  The .o file indeed has the wrong thing for <code>var_init.5</code>:</p>
<div class="codehilite"><pre><span></span><code>...
     705: 41 84 80 80 80 00             i32.const   4
            00000706:  R_WASM_TABLE_INDEX_SLEB  _ZNSt3__26vectorI24Baselib_Memory_PageStateNS_9allocatorIS1_EEED2Ev+0
     70b: 21 0d                         local.set   13
     70d: 20 0d                         local.get   13
     70f: 21 0e                         local.set   14
     711: 20 0c                         local.get   12
     713: 21 0f                         local.set   15
     715: 41 80 80 80 80 00             i32.const   0
            00000716:  R_WASM_MEMORY_ADDR_SLEB  __dso_handle+0
     71b: 21 10                         local.set   16
     71d: 20 0e                         local.get   14
     71f: 20 0f                         local.get   15
     721: 20 10                         local.get   16
     723: 10 80 80 80 80 00             call    0
            00000724:  R_WASM_FUNCTION_INDEX_LEB    __cxa_atexit+0
</code></pre></div>



<a name="195651121"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195651121" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195651121">(Apr 29 2020 at 01:49)</a>:</h4>
<p>And the LLVM IR looks wrong (extra indentation in the cxa_atexit call):</p>
<div class="codehilite"><pre><span></span><code>define internal void @__cxx_global_var_init.5() #0 !dbg !3799 {
  %1 = alloca %&quot;class.std::initializer_list&quot;, align 4
  %2 = alloca [1 x i32], align 4
  %3 = getelementptr inbounds [1 x i32], [1 x i32]* %2, i32 0, i32 0, !dbg !3800
  store i32 4, i32* %3, align 4, !dbg !3800
  %4 = getelementptr inbounds %&quot;class.std::initializer_list&quot;, %&quot;class.std::initializer_list&quot;* %1, i32 0, i32 0, !dbg !3800
  %5 = getelementptr inbounds [1 x i32], [1 x i32]* %2, i32 0, i32 0, !dbg !3800
  store i32* %5, i32** %4, align 4, !dbg !3800                                                                                                      %6 = getelementptr inbounds %&quot;class.std::initializer_list&quot;, %&quot;class.std::initializer_list&quot;* %1, i32 0, i32 1, !dbg !3800
  store i32 1, i32* %6, align 4, !dbg !3800
  %7 = call %&quot;class.std::__2::vector.6&quot;* @_ZNSt3__26vectorI24Baselib_Memory_PageStateNS_9allocatorIS1_EEEC2ESt16initializer_listIS1_E(%&quot;class.std::__2::vector.6&quot;* @_ZGR39Baselib_Test_Memory_SupportedPageStates_, %&quot;class.std::initializer_list&quot;* byval(%&quot;class.std::initializer_list&quot;) align 4 %1), !dbg !3800
  %8 = call i32 @__cxa_atexit(
            void (i8*)* bitcast (%&quot;class.std::__2::vector.6&quot;* (%&quot;class.std::__2::vector.6&quot;*)* @_ZNSt3__26vectorI24Baselib_Memory_PageStateNS_9allocatorIS1_EEED2Ev to void (i8*)*),
            i8* bitcast (%&quot;class.std::__2::vector.6&quot;* @_ZGR39Baselib_Test_Memory_SupportedPageStates_ to i8*),
            i8* @__dso_handle) #4, !dbg !3800  store %&quot;class.std::__2::vector.6&quot;* @_ZGR39Baselib_Test_Memory_SupportedPageStates_, %&quot;class.std::__2::vector.6&quot;** @Baselib_Test_Memory_SupportedPageStates, align 4, !dbg !3800
  ret void, !dbg !3801
}
</code></pre></div>



<a name="195658549"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195658549" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195658549">(Apr 29 2020 at 04:15)</a>:</h4>
<p>It looks like it might be related to global reference temporaries</p>



<a name="195658691"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195658691" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195658691">(Apr 29 2020 at 04:19)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span> <span class="n">B</span> <span class="p">{</span> <span class="n">B</span><span class="p">();</span> <span class="o">~</span><span class="n">B</span><span class="p">();</span> <span class="p">};</span>
<span class="k">namespace</span> <span class="n">test</span> <span class="p">{</span>
  <span class="k">const</span> <span class="n">B</span> <span class="n">b1</span> <span class="o">=</span> <span class="n">B</span><span class="p">();</span>
  <span class="k">const</span> <span class="n">B</span> <span class="o">&amp;</span><span class="n">b2</span> <span class="o">=</span> <span class="n">B</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>


<p>shows the problem</p>



<a name="195659208"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195659208" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195659208">(Apr 29 2020 at 04:31)</a>:</h4>
<p><span class="user-mention" data-user-id="254083">@Dan Gohman</span> yep. I literally just tracked it down to here: <a href="https://github.com/llvm-mirror/clang/blob/master/lib/CodeGen/CGExpr.cpp#L347" title="https://github.com/llvm-mirror/clang/blob/master/lib/CodeGen/CGExpr.cpp#L347">https://github.com/llvm-mirror/clang/blob/master/lib/CodeGen/CGExpr.cpp#L347</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/llvm-mirror/clang/blob/master/lib/CodeGen/CGExpr.cpp#L347" style="background-image: url(https://avatars2.githubusercontent.com/u/1386314?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/llvm-mirror/clang/blob/master/lib/CodeGen/CGExpr.cpp#L347" title="llvm-mirror/clang">llvm-mirror/clang</a></div><div class="message_embed_description">Mirror kept for legacy. Moved to https://github.com/llvm/llvm-project - llvm-mirror/clang</div></div></div>



<a name="195659269"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195659269" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195659269">(Apr 29 2020 at 04:32)</a>:</h4>
<p>That call doesn't go through all the same code that happens <a href="https://github.com/llvm-mirror/clang/blob/master/lib/CodeGen/CGDeclCXX.cpp#L143" title="https://github.com/llvm-mirror/clang/blob/master/lib/CodeGen/CGDeclCXX.cpp#L143">https://github.com/llvm-mirror/clang/blob/master/lib/CodeGen/CGDeclCXX.cpp#L143</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/llvm-mirror/clang/blob/master/lib/CodeGen/CGDeclCXX.cpp#L143" style="background-image: url(https://avatars2.githubusercontent.com/u/1386314?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/llvm-mirror/clang/blob/master/lib/CodeGen/CGDeclCXX.cpp#L143" title="llvm-mirror/clang">llvm-mirror/clang</a></div><div class="message_embed_description">Mirror kept for legacy. Moved to https://github.com/llvm/llvm-project - llvm-mirror/clang</div></div></div>



<a name="195659339"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195659339" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195659339">(Apr 29 2020 at 04:34)</a>:</h4>
<p><span class="user-mention" data-user-id="254083">@Dan Gohman</span> can you fix, or want me to give it a go?</p>



<a name="195659440"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195659440" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195659440">(Apr 29 2020 at 04:36)</a>:</h4>
<p>I'm not at a computer where I can debug clang easily, so if yyou want to have a go, go for ito</p>



<a name="195659455"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195659455" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195659455">(Apr 29 2020 at 04:37)</a>:</h4>
<p>I may poke you tomorrow for help in actually getting a patch submitted <span aria-label="put litter in its place" class="emoji emoji-1f6ae" role="img" title="put litter in its place">:put_litter_in_its_place:</span></p>



<a name="195659735"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195659735" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195659735">(Apr 29 2020 at 04:42)</a>:</h4>
<p><span class="user-mention" data-user-id="254083">@Dan Gohman</span> I take it back.  I don't have anywhere near enough context to do this :)</p>



<a name="195660329"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195660329" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195660329">(Apr 29 2020 at 04:51)</a>:</h4>
<p>Yeah definitely can't do this, not without spending a large chunk of time on it that I wish I had.  Let me know if I should file it somewhere.</p>



<a name="195660807"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195660807" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195660807">(Apr 29 2020 at 04:58)</a>:</h4>
<p>And armed with all this info, I see this code in our tests:</p>
<div class="codehilite"><pre><span></span><code>const std::vector&lt;Baselib_Memory_PageState&gt;&amp; Baselib_Test_Memory_SupportedPageStates = { Baselib_Memory_PageState_ReadWrite };
</code></pre></div>


<p>which, if I explicitly declare a vector with the right value and then assign that to the reference, the problem goes away.</p>



<a name="195661550"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195661550" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195661550">(Apr 29 2020 at 05:12)</a>:</h4>
<p>Alternatively, could you just remove the <code>&amp;</code> there and create a regular global instead of a global reference to a temporary?</p>



<a name="195661630"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195661630" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195661630">(Apr 29 2020 at 05:14)</a>:</h4>
<p>not in this case, this is a thing that's an extern elsewhere and it's a per-platform vector where most other platforms are initialized from a global vector</p>



<a name="195661649"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195661649" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195661649">(Apr 29 2020 at 05:15)</a>:</h4>
<p>also, hooray for tracking down something that likely would have been a pain in the butt at some random point later on :)</p>



<a name="195661653"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195661653" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195661653">(Apr 29 2020 at 05:15)</a>:</h4>
<p>Looking at the code in clang, I have an idea of what might be wrong, but I'll need to debug more to confirm. But I'll have to pick this up tomorrow.</p>



<a name="195661662"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195661662" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195661662">(Apr 29 2020 at 05:15)</a>:</h4>
<p>Yep, no problem.  Thanks for looking into it!</p>



<a name="195850680"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195850680" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195850680">(Apr 30 2020 at 14:55)</a>:</h4>
<p><span class="user-mention" data-user-id="254083">@Dan Gohman</span> any luck on this? (I was out yesterday)</p>



<a name="195850863"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195850863" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195850863">(Apr 30 2020 at 14:56)</a>:</h4>
<p>Not yet; I got busy with other things yesterday, but I'm going to take another look soon</p>



<a name="195850916"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195850916" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195850916">(Apr 30 2020 at 14:56)</a>:</h4>
<p>np, thanks!</p>



<a name="195895984"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195895984" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195895984">(Apr 30 2020 at 20:20)</a>:</h4>
<p>The dtor bitcast is coming from here:</p>



<a name="195896002"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195896002" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195896002">(Apr 30 2020 at 20:20)</a>:</h4>
<p><a href="https://github.com/llvm/llvm-project/blob/master/clang/lib/CodeGen/ItaniumCXXABI.cpp#L2403" title="https://github.com/llvm/llvm-project/blob/master/clang/lib/CodeGen/ItaniumCXXABI.cpp#L2403">https://github.com/llvm/llvm-project/blob/master/clang/lib/CodeGen/ItaniumCXXABI.cpp#L2403</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/llvm/llvm-project/blob/master/clang/lib/CodeGen/ItaniumCXXABI.cpp#L2403" style="background-image: url(https://avatars2.githubusercontent.com/u/17149993?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/llvm/llvm-project/blob/master/clang/lib/CodeGen/ItaniumCXXABI.cpp#L2403" title="llvm/llvm-project">llvm/llvm-project</a></div><div class="message_embed_description">The LLVM Project is a collection of modular and reusable compiler and toolchain technologies. Note: the repository does not accept github pull requests at this moment. Please submit your patches at...</div></div></div>



<a name="195896020"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195896020" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195896020">(Apr 30 2020 at 20:20)</a>:</h4>
<p>So one option is to make it call <code>EmitDeclDestroy</code>, or factor out code from <code>EmitDeclDestroy</code> for it to use.</p>



<a name="195896045"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195896045" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195896045">(Apr 30 2020 at 20:21)</a>:</h4>
<p>That would let it use a <code>__cxx_global_array_dtor</code> wrapper, which should fix the problem.</p>



<a name="195896064"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195896064" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195896064">(Apr 30 2020 at 20:21)</a>:</h4>
<p>There's also a plausible workaround:</p>



<a name="195896078"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195896078" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195896078">(Apr 30 2020 at 20:21)</a>:</h4>
<p>It turns out we already have code in the LLVM wasm backend which attempts to emulate function pointer casts by inserting wrapper functions.</p>



<a name="195896085"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195896085" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195896085">(Apr 30 2020 at 20:21)</a>:</h4>
<p>The only reason that code isn't saving us here is that it's looking for casted functions which are immediately called,</p>



<a name="195896101"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195896101" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195896101">(Apr 30 2020 at 20:21)</a>:</h4>
<p>and here we have a function being casted and passed as an argument to <code>__cxa_atexit</code>.</p>



<a name="195896115"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195896115" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195896115">(Apr 30 2020 at 20:21)</a>:</h4>
<p>So we could tweak this:</p>



<a name="195896160"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195896160" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195896160">(Apr 30 2020 at 20:22)</a>:</h4>
<p><a href="https://github.com/llvm/llvm-project/blob/master/llvm/lib/Target/WebAssembly/WebAssemblyFixFunctionBitcasts.cpp#L75" title="https://github.com/llvm/llvm-project/blob/master/llvm/lib/Target/WebAssembly/WebAssemblyFixFunctionBitcasts.cpp#L75">https://github.com/llvm/llvm-project/blob/master/llvm/lib/Target/WebAssembly/WebAssemblyFixFunctionBitcasts.cpp#L75</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/llvm/llvm-project/blob/master/llvm/lib/Target/WebAssembly/WebAssemblyFixFunctionBitcasts.cpp#L75" style="background-image: url(https://avatars2.githubusercontent.com/u/17149993?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/llvm/llvm-project/blob/master/llvm/lib/Target/WebAssembly/WebAssemblyFixFunctionBitcasts.cpp#L75" title="llvm/llvm-project">llvm/llvm-project</a></div><div class="message_embed_description">The LLVM Project is a collection of modular and reusable compiler and toolchain technologies. Note: the repository does not accept github pull requests at this moment. Please submit your patches at...</div></div></div>



<a name="195896176"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195896176" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195896176">(Apr 30 2020 at 20:22)</a>:</h4>
<p>to recognize uses which are "the first operand of a <code>__cxa_atexit</code> call"</p>



<a name="195896185"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195896185" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195896185">(Apr 30 2020 at 20:22)</a>:</h4>
<p>which would then cause it to insert a wrapper, which ought to generate working code.</p>



<a name="195985189"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195985189" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195985189">(May 01 2020 at 17:21)</a>:</h4>
<p>It seems like both paths to <code>__cxa_atexit</code> should go through something common</p>



<a name="195985503"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/195985503" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#195985503">(May 01 2020 at 17:24)</a>:</h4>
<p>But maybe not.  Either one of your suggestions seems pretty reasonable, but fixing it in a non-WASM specific way seems better because this is technically a problem on any ABI that can't call mismatched functions.  Which is probably just wasm, but still.</p>



<a name="196681902"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/196681902" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#196681902">(May 06 2020 at 19:07)</a>:</h4>
<p><span class="user-mention" data-user-id="254083">@Dan Gohman</span> any luck on this?  (Or, alternatively, is there a bug filed I can track -- or do you want me to file one somewhere? :)</p>



<a name="196683708"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/196683708" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#196683708">(May 06 2020 at 19:22)</a>:</h4>
<p>No, I've not made any further progress yet.</p>



<a name="196683822"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/196683822" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#196683822">(May 06 2020 at 19:23)</a>:</h4>
<p>I poked at it a bit, but I didn't see any super easy paths here. If you wanted to file a bug with the small testcase above and the findings about it, that'd be great!</p>



<a name="196833374"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/196833374" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#196833374">(May 07 2020 at 21:36)</a>:</h4>
<p>Where's the best place to file the bug?  Against wasi-sdk or llvm?</p>



<a name="196833540"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/196833540" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#196833540">(May 07 2020 at 21:38)</a>:</h4>
<p>For <code>wasi-sdk</code>, that'd be here: <a href="https://github.com/webassembly/wasi-sdk/issues" title="https://github.com/webassembly/wasi-sdk/issues">https://github.com/webassembly/wasi-sdk/issues</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/webassembly/wasi-sdk/issues" style="background-image: url(https://avatars3.githubusercontent.com/u/11578470?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/webassembly/wasi-sdk/issues" title="WebAssembly/wasi-sdk">WebAssembly/wasi-sdk</a></div><div class="message_embed_description">WASI-enabled WebAssembly C/C++ toolchain. Contribute to WebAssembly/wasi-sdk development by creating an account on GitHub.</div></div></div>



<a name="196835352"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/196835352" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#196835352">(May 07 2020 at 21:56)</a>:</h4>
<p>Yeah, the issue is a llvm bug though for the wasm backend; wasn't sure if filing that in wasi-sdk was the right place</p>



<a name="196838094"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/196838094" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#196838094">(May 07 2020 at 22:26)</a>:</h4>
<p>For clang/llvm bugs, use the llvm tracker: <a href="https://bugs.llvm.org/" title="https://bugs.llvm.org/">https://bugs.llvm.org/</a></p>



<a name="197172971"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/__funcs_on_exit%20indirect%20call%20type%20mismatch%20with%20wasi-sdk/near/197172971" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vladimir Vukicevic <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/__funcs_on_exit.20indirect.20call.20type.20mismatch.20with.20wasi-sdk.html#197172971">(May 11 2020 at 16:44)</a>:</h4>
<p>Filed <a href="https://bugs.llvm.org/show_bug.cgi?id=45876">https://bugs.llvm.org/show_bug.cgi?id=45876</a></p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>