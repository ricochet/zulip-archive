<html>
<head><meta charset="utf-8"><title>wasm-merge with Rust tests · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/index.html">general</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasm-merge.20with.20Rust.20tests.html">wasm-merge with Rust tests</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="425065597"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasm-merge%20with%20Rust%20tests/near/425065597" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Enrico Loparco <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasm-merge.20with.20Rust.20tests.html#425065597">(Mar 06 2024 at 11:36)</a>:</h4>
<p>Hello, I have a Rust workspace with multiple packages in it, each one with its own unit and integration tests.<br>
Now, I want to have a single wasm file with all tests, how can I do it? </p>
<p>I tried using <code>wasm-merge --rename-export-conflicts</code> but, if I have two test files <code>test1.wasm</code> and <code>test2.wasm</code>, when I merge them into <code>merge.wasm</code>, only the tests in first one in the order are executed when running on a wasm runtime.</p>
<p>If I look at the wat representation, I see that both <code>test1.wasm</code> and <code>test2.wasm</code> export <code>__main_void</code> and <code>_start</code>. The <code>merge.wasm</code> that I generate also contains  <code>__main_void</code> and <code>_start</code>.<br>
Is there any workaround, like making tests export a different function name, so that I can call them directly from the runtime when running <code>merge.wasm</code>?</p>
<p>Thanks</p>



<a name="425132391"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasm-merge%20with%20Rust%20tests/near/425132391" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasm-merge.20with.20Rust.20tests.html#425132391">(Mar 06 2024 at 16:46)</a>:</h4>
<p>I think you did have to first have to rewrite all modules to rename their <code>_start</code> to unique names, then write a new module with <code>_start</code> which calls all renamed <code>_start</code> in order and then merge all these modules together. <code>__main_void</code> is generated by rustc and there is no way to make rustc use a different name. <code>__main_void</code> is called by <code>_start</code> and should never be called directly. <code>_start</code> is defined by the crt1.o of wasi-libc, which comes precompiled. Because of this all I think directly rewriting the wasm modules to change the export names is the best option you have. The alternative would be to skip rustc's testing infrastructure entirely and compile every test crate as <code>cdylib</code> and have them export a single function with a unique name which internally calls all tests.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>