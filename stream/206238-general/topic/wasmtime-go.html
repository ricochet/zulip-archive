<html>
<head><meta charset="utf-8"><title>wasmtime-go · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/index.html">general</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html">wasmtime-go</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="196809411"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/196809411" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#196809411">(May 07 2020 at 18:09)</a>:</h4>
<p>Anyone here using wasmtime-go?</p>



<a name="196971264"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/196971264" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#196971264">(May 09 2020 at 03:34)</a>:</h4>
<p>Getting an interesting issue where, having done nothing but create a store, module, and wasi instance and then starting an http server, I reliably get a segfault in 2 minutes. I'm guessing the 2 minutes is a GC pause. If I actually use an instance of the module every so often I don't get the segfault.</p>



<a name="196971417"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/196971417" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#196971417">(May 09 2020 at 03:39)</a>:</h4>
<p>Ok yeah, so the runtime forces a GC cycle every 2 minutes.</p>



<a name="196971878"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/196971878" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#196971878">(May 09 2020 at 03:52)</a>:</h4>
<p><span class="user-mention" data-user-id="300054">@Alex Vidal</span> oh dear, do you have code I could peek at? I see CI for the repo still segfaults on macOS, but I unfortunately haven't been able to track down as to why</p>



<a name="196971884"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/196971884" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#196971884">(May 09 2020 at 03:52)</a>:</h4>
<p>Also, have you tried the master branch of the git repo?</p>



<a name="196971895"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/196971895" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#196971895">(May 09 2020 at 03:53)</a>:</h4>
<p>I haven't. I'm running 0.16.0 atm. I'll see if I can get a minimal reproduction.</p>



<a name="196971948"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/196971948" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#196971948">(May 09 2020 at 03:54)</a>:</h4>
<p>Interesting...v0.16.0 isn't on the master timeline at all?</p>



<a name="196971978"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/196971978" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#196971978">(May 09 2020 at 03:55)</a>:</h4>
<p>Oh, but it's ahead of master anyway</p>



<a name="196972043"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/196972043" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#196972043">(May 09 2020 at 03:57)</a>:</h4>
<p>ah yeah it's a separate commit b/c it has binaries</p>



<a name="196972087"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/196972087" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#196972087">(May 09 2020 at 03:58)</a>:</h4>
<p>roger. let me see if i can reproduce without all my bullshit</p>



<a name="196972284"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/196972284" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#196972284">(May 09 2020 at 04:04)</a>:</h4>
<p>really annoying to iterate on this when it takes 2 minutes each time you want to reduce your test case</p>



<a name="196972362"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/196972362" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#196972362">(May 09 2020 at 04:06)</a>:</h4>
<p>ah yeah there it goes</p>



<a name="196972417"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/196972417" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#196972417">(May 09 2020 at 04:08)</a>:</h4>
<p>about to upload a gist, going to see if i can repro with an inline wat</p>



<a name="196972604"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/196972604" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#196972604">(May 09 2020 at 04:15)</a>:</h4>
<p><span class="user-mention" data-user-id="253994">@Alex Crichton</span> <a href="https://gist.github.com/avidal/4710a963fbc8a80feae84663473ea971" title="https://gist.github.com/avidal/4710a963fbc8a80feae84663473ea971">https://gist.github.com/avidal/4710a963fbc8a80feae84663473ea971</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://gist.github.com/avidal/4710a963fbc8a80feae84663473ea971" style="background-image: url(https://github.githubassets.com/images/modules/gists/gist-og-image.png)"></a><div class="data-container"><div class="message_embed_title"><a href="https://gist.github.com/avidal/4710a963fbc8a80feae84663473ea971" title="wasi_gc_crash.go">wasi_gc_crash.go</a></div><div class="message_embed_description">GitHub Gist: instantly share code, notes, and snippets.</div></div></div>



<a name="196972668"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/196972668" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#196972668">(May 09 2020 at 04:16)</a>:</h4>
<p>Running another test without the wasi instance to see if it makes a difference. Wondering if a runtime.KeepAlive is missing in one of the wasi funcs?</p>



<a name="196972718"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/196972718" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#196972718">(May 09 2020 at 04:18)</a>:</h4>
<p>Remove the wasi bits and it doesn't crash</p>



<a name="196972722"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/196972722" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#196972722">(May 09 2020 at 04:19)</a>:</h4>
<p>oh I think I see what's wrong</p>



<a name="196972749"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/196972749" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#196972749">(May 09 2020 at 04:19)</a>:</h4>
<p>ok, i can upload a segfault if you want it</p>



<a name="196972753"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/196972753" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#196972753">(May 09 2020 at 04:19)</a>:</h4>
<p>nah that's ok</p>



<a name="196972791"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/196972791" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#196972791">(May 09 2020 at 04:20)</a>:</h4>
<p>this is an ownership issue I forgot about</p>



<a name="196972793"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/196972793" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#196972793">(May 09 2020 at 04:20)</a>:</h4>
<p>and didn't see it b/c I didn't write wasi tests :(</p>



<a name="196972794"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/196972794" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#196972794">(May 09 2020 at 04:20)</a>:</h4>
<p>I noticed :)</p>



<a name="196972800"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/196972800" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#196972800">(May 09 2020 at 04:20)</a>:</h4>
<p>But it follows the rust api very well so it wasn't difficult to figure out</p>



<a name="196972868"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/196972868" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#196972868">(May 09 2020 at 04:23)</a>:</h4>
<p>Is it the wasi instance that needs a keep alive? I see that if you link the wasi instance in a linker, the linker calls keepalive on the wasi instance, but constructing the instance via <code>NewWasiInstance</code> doesn't</p>



<a name="196972890"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/196972890" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#196972890">(May 09 2020 at 04:24)</a>:</h4>
<p>(I know very little about cgo or generally about ffi stuff so this part is a bit over my head)</p>



<a name="196972928"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/196972928" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#196972928">(May 09 2020 at 04:24)</a>:</h4>
<p>ok should be fixed in <a href="https://github.com/bytecodealliance/wasmtime-go/commit/e23af2e4825f3d9c67bddc329e16c954f75620e9" title="https://github.com/bytecodealliance/wasmtime-go/commit/e23af2e4825f3d9c67bddc329e16c954f75620e9">https://github.com/bytecodealliance/wasmtime-go/commit/e23af2e4825f3d9c67bddc329e16c954f75620e9</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime-go/commit/e23af2e4825f3d9c67bddc329e16c954f75620e9" style="background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime-go/commit/e23af2e4825f3d9c67bddc329e16c954f75620e9" title="Clear finalizer for config when creating wasi instances · bytecodealliance/wasmtime-go@e23af2e">Clear finalizer for config when creating wasi instances · bytecodealliance/wasmtime-go@e23af2e</a></div><div class="message_embed_description">The `wasi_instance_new` API takes ownership of the config passed into
it, so no need to manually free it later!</div></div></div>



<a name="196972939"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/196972939" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#196972939">(May 09 2020 at 04:24)</a>:</h4>
<p>Very nice, will test it out right now</p>



<a name="196973002"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/196973002" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#196973002">(May 09 2020 at 04:26)</a>:</h4>
<p>Oh, I'll wait for the tag and then get it instead of futzing with the compile step</p>



<a name="197026354"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197026354" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197026354">(May 10 2020 at 01:54)</a>:</h4>
<p><span class="user-mention" data-user-id="253994">@Alex Crichton</span> when you get a chance could you push a v0.17.0 tag?</p>



<a name="197151514"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197151514" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197151514">(May 11 2020 at 14:17)</a>:</h4>
<p><span class="user-mention" data-user-id="300054">@Alex Vidal</span> I've published 0.16.1 now!</p>



<a name="197156689"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197156689" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197156689">(May 11 2020 at 14:53)</a>:</h4>
<p>sweet, thanks!</p>



<a name="197232009"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197232009" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197232009">(May 12 2020 at 04:02)</a>:</h4>
<p>Left my program running for 5ish hours and no segfaults :) Thanks again Alex</p>



<a name="197233253"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197233253" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197233253">(May 12 2020 at 04:32)</a>:</h4>
<p>Nice, thanks again for the report!</p>



<a name="197430932"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197430932" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197430932">(May 13 2020 at 15:39)</a>:</h4>
<p>Submitted a PR to fix a segfault in wasi...but I also realized I need to figure out how to make this work reliably on macOS since I'll be using it at work. I personally don't have a macbook, but my coworkers do..</p>



<a name="197440275"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197440275" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197440275">(May 13 2020 at 16:40)</a>:</h4>
<p><span class="user-mention" data-user-id="300054">@Alex Vidal</span> yeah I've been trying to investigate it on and off as to what's going wrong, but I can't figure anything out yet :(</p>



<a name="197440346"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197440346" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197440346">(May 13 2020 at 16:40)</a>:</h4>
<p>I can reliably reproduce the issue on macos and can't reproduce at all on linux</p>



<a name="197440353"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197440353" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197440353">(May 13 2020 at 16:40)</a>:</h4>
<p>just have no idea where to start with debugging</p>



<a name="197440443"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197440443" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197440443">(May 13 2020 at 16:41)</a>:</h4>
<p>does it reproduce in a docker container with a macos host?</p>



<a name="197440610"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197440610" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197440610">(May 13 2020 at 16:42)</a>:</h4>
<p>otherwise yeah i guess you have a non-zero chance of hitting it on every gc cycle which is a minimum of 2 minutes</p>



<a name="197440766"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197440766" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197440766">(May 13 2020 at 16:43)</a>:</h4>
<p>you can probably reproduce faster with <code>-tags debug</code> which forces a gc trigger way more often</p>



<a name="197440777"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197440777" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197440777">(May 13 2020 at 16:44)</a>:</h4>
<p>(that's how I'm reproducing in tests)</p>



<a name="197440832"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197440832" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197440832">(May 13 2020 at 16:44)</a>:</h4>
<p>and I'm not sure if docker would work b/c I don't think you virtualize macos, right?</p>



<a name="197442780"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197442780" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197442780">(May 13 2020 at 16:57)</a>:</h4>
<p>yep, i ended up changing the actions file on my fork to run three passes with debug enabled to get it to repro more often</p>



<a name="197442909"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197442909" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197442909">(May 13 2020 at 16:57)</a>:</h4>
<p>also, i'm not positive how docker for mac works. i know docker runs in a lightweight vm but past that...<span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="197454112"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197454112" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197454112">(May 13 2020 at 18:13)</a>:</h4>
<p>considering renting a mac from <a href="http://macincloud.com">macincloud.com</a> to try this out</p>



<a name="197456507"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197456507" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197456507">(May 13 2020 at 18:33)</a>:</h4>
<p>I adjusted the workflow to only run mac, skip the download steps (inlined the dependencies), and run the debug test build a bunch of times to see if i can find a pattern in the failures...but nothing so far. <a href="https://github.com/avidal/wasmtime-go/pull/1">https://github.com/avidal/wasmtime-go/pull/1</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/avidal/wasmtime-go/pull/1" style="background-image: url(https://avatars1.githubusercontent.com/u/191975?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/avidal/wasmtime-go/pull/1" title="testing workflow by avidal · Pull Request #1 · avidal/wasmtime-go">testing workflow by avidal · Pull Request #1 · avidal/wasmtime-go</a></div><div class="message_embed_description">GitHub is home to over 50 million developers working together to host and review code, manage projects, and build software together.</div></div></div>



<a name="197457445"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197457445" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197457445">(May 13 2020 at 18:39)</a>:</h4>
<p>Can you run it in lldb? <code>lldb -o run -o bt --batch -- executable arg1 arg2</code> should run it and show a backtrace when it crashes.</p>



<a name="197457494"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197457494" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197457494">(May 13 2020 at 18:39)</a>:</h4>
<p>I would but no mac on my end. Not sure what Alex has tried</p>



<a name="197457530"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197457530" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197457530">(May 13 2020 at 18:39)</a>:</h4>
<p>oh maybe i can do that in the action though</p>



<a name="197457676"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197457676" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197457676">(May 13 2020 at 18:40)</a>:</h4>
<p>yes, that was what I meant.</p>



<a name="197458552"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197458552" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197458552">(May 13 2020 at 18:47)</a>:</h4>
<p>FWIW I'm working to minimize this, so far I've got this program which will segfault:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="c1">// #cgo CFLAGS:-I${SRCDIR}/build/include</span>
<span class="c1">// #cgo LDFLAGS:-lwasmtime -lm -ldl -L${SRCDIR}/build/macos-x86_64</span>
<span class="c1">// #include &lt;shims.h&gt;</span>
<span class="kn">import</span> <span class="s">&quot;C&quot;</span>
<span class="kn">import</span> <span class="s">&quot;runtime&quot;</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">engine</span> <span class="o">:=</span> <span class="nx">C</span><span class="p">.</span><span class="nx">wasm_engine_new</span><span class="p">()</span>
        <span class="nx">store</span> <span class="o">:=</span> <span class="nx">C</span><span class="p">.</span><span class="nx">wasm_store_new</span><span class="p">(</span><span class="nx">engine</span><span class="p">)</span>
        <span class="kd">var</span> <span class="nx">tys</span> <span class="nx">C</span><span class="p">.</span><span class="nx">wasm_valtype_vec_t</span>
        <span class="nx">ty</span> <span class="o">:=</span> <span class="nx">C</span><span class="p">.</span><span class="nx">wasm_functype_new</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">tys</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">tys</span><span class="p">)</span>
        <span class="nx">f</span> <span class="o">:=</span> <span class="nx">C</span><span class="p">.</span><span class="nx">c_func_new_with_env</span><span class="p">(</span><span class="nx">store</span><span class="p">,</span> <span class="nx">ty</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="nx">C</span><span class="p">.</span><span class="nx">wasmtime_func_call</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="nx">runtime</span><span class="p">.</span><span class="nx">GC</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>



<a name="197458688"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197458688" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197458688">(May 13 2020 at 18:48)</a>:</h4>
<p>oh very nice</p>



<a name="197464289"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197464289" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197464289">(May 13 2020 at 19:30)</a>:</h4>
<p>fwiw, that minimal example segfaults for me on <code>C.wasmtime_func_call</code></p>



<a name="197464293"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197464293" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197464293">(May 13 2020 at 19:30)</a>:</h4>
<p>(on linux though)</p>



<a name="197464313"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197464313" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197464313">(May 13 2020 at 19:30)</a>:</h4>
<p>well kind of, i didn't make it exactly the same so i should just shut up</p>



<a name="197464951"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197464951" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197464951">(May 13 2020 at 19:35)</a>:</h4>
<p><span class="user-mention" data-user-id="300054">@Alex Vidal</span> I opened up <a href="https://github.com/bytecodealliance/wasmtime-go/issues/10">https://github.com/bytecodealliance/wasmtime-go/issues/10</a> as a dedicated issue for this</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime-go/issues/10" style="background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime-go/issues/10" title="Segfault on macOS · Issue #10 · bytecodealliance/wasmtime-go">Segfault on macOS · Issue #10 · bytecodealliance/wasmtime-go</a></div><div class="message_embed_description">CI has been segfaulting for some time on macOS and I&#39;ve recently tried to reduce this. I can pretty reliably reproduce this locally as well. So far I&#39;ve managed to shrink this to: package m...</div></div></div>



<a name="197465837"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197465837" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197465837">(May 13 2020 at 19:42)</a>:</h4>
<p>very nice, thanks. hopefully we can get some help!</p>



<a name="197577367"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197577367" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197577367">(May 14 2020 at 16:03)</a>:</h4>
<p>I'm going to try to run the minimal example in your ticket on MacOS but building and executing it in a docker container. I'm going to be shipping a wasmtime-go based local development proxy to my team in the next couple of weeks and it'd be nice to know I have a MacOS workaround..</p>



<a name="197589973"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197589973" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197589973">(May 14 2020 at 17:29)</a>:</h4>
<p><span class="user-mention" data-user-id="253994">@Alex Crichton</span> looks like it was a regression in Go 1.14. I can't reproduce in 1.13.10. I setup a matrix of Go versions in my fork of wasmtime-go to confirm: <a href="https://github.com/avidal/wasmtime-go/pull/2">https://github.com/avidal/wasmtime-go/pull/2</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/avidal/wasmtime-go/pull/2" style="background-image: url(https://avatars1.githubusercontent.com/u/191975?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/avidal/wasmtime-go/pull/2" title="test against go 1.13.10 by avidal · Pull Request #2 · avidal/wasmtime-go">test against go 1.13.10 by avidal · Pull Request #2 · avidal/wasmtime-go</a></div><div class="message_embed_description">GitHub is home to over 50 million developers working together to host and review code, manage projects, and build software together.</div></div></div>



<a name="197590203"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197590203" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197590203">(May 14 2020 at 17:31)</a>:</h4>
<p>nice find!</p>



<a name="197590209"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197590209" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197590209">(May 14 2020 at 17:31)</a>:</h4>
<p>I had a coworker run the test suite on MacOS Catalina (with the debug tag to trigger the GC often) using Go 1.13.10 about a hundred times and he never saw a segfault.</p>



<a name="197590225"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197590225" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197590225">(May 14 2020 at 17:31)</a>:</h4>
<p>Perhaps we could update wasmtime-go CI and also add a note to the README?</p>



<a name="197590335"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197590335" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197590335">(May 14 2020 at 17:32)</a>:</h4>
<p>I can open a PR for that. Add go 1.13.10 to CI yeah?</p>



<a name="197590365"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197590365" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197590365">(May 14 2020 at 17:32)</a>:</h4>
<p>sounds good to me yeah</p>



<a name="197591566"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197591566" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197591566">(May 14 2020 at 17:42)</a>:</h4>
<p>opened. not sure how much detail you want in the README</p>



<a name="197597576"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197597576" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197597576">(May 14 2020 at 18:26)</a>:</h4>
<p>your comment in the README is a lot better :)</p>



<a name="197598771"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197598771" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197598771">(May 14 2020 at 18:34)</a>:</h4>
<p>oh no worries just tweaking things :)</p>



<a name="197604295"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197604295" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197604295">(May 14 2020 at 19:13)</a>:</h4>
<p>This is (probably) unrelated, but if you run the test suite using go 1.14 with <code>-race</code>, it'll enable the <code>checkptr</code> feature which says that func.go#319 has unsafe pointer arithmetic (reproducible on linux)</p>



<a name="197721551"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197721551" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197721551">(May 15 2020 at 17:00)</a>:</h4>
<p>just wanted to say thanks to you <span class="user-mention" data-user-id="253994">@Alex Crichton</span> and the rest of the wasmtime team. My local proxy can trivially handle over 100 rps sustained. It takes the incoming http request, executes a wasm program which modifies the request and calls back to Go, which sends the request to another service and returns the response back into wasm which then sends it back into Go and back to the user.</p>



<a name="197721596"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197721596" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197721596">(May 15 2020 at 17:01)</a>:</h4>
<p>Effectively the Go proxy is a runtime for middleware implemented (currently) in Rust, compiled to wasm.</p>



<a name="197721654"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197721654" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197721654">(May 15 2020 at 17:01)</a>:</h4>
<p>100 rps with a 90th percentile latency of 11ms</p>



<a name="197721725"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197721725" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197721725">(May 15 2020 at 17:02)</a>:</h4>
<p>(once I put a mutex around instantiating the module that is)</p>



<a name="197721790"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197721790" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197721790">(May 15 2020 at 17:02)</a>:</h4>
<p>oh and that's with creating a new instance of the module for every single request which is how the middleware api is designed</p>



<a name="197828299"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197828299" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197828299">(May 17 2020 at 03:38)</a>:</h4>
<p>If I have Rust code that imports a function whose "extern C" decl has an arg for a <code>u32</code>, and I link that function via <code>wasmtime-go</code>, I have to provide a function that accepts an <code>int32</code>. What if, on the Rust side, I call that function with the max u32? That won't fit into the int32 on the Go side.</p>



<a name="197828891"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/197828891" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#197828891">(May 17 2020 at 03:57)</a>:</h4>
<p>Ok. I messed with this a bit more. Looks like I can just cast the param to uint32 in Go, which makes sense.</p>



<a name="199813812"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/199813812" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#199813812">(Jun 04 2020 at 21:58)</a>:</h4>
<p>Can you summarize the impact of the 0.17.0 change <span class="user-mention" data-user-id="253994">@Alex Crichton</span>? The wasmtime change indicates module can be sent across threads. Do you still need to lock the store to a single thread at a time?</p>



<a name="199813888"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/199813888" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#199813888">(Jun 04 2020 at 21:59)</a>:</h4>
<p>It <em>looks</em> like it's a change that could <em>eventually</em> unlock multiple instances on multiple threads, but we're not there yet, correct?</p>



<a name="199813897"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/199813897" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#199813897">(Jun 04 2020 at 21:59)</a>:</h4>
<p><span class="user-mention" data-user-id="300054">@Alex Vidal</span> that's been fixed now! The API hasn't been updated yet but a <code>Module</code> is tied to an <code>Engine</code> now, not a <code>Store</code></p>



<a name="199813954"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/199813954" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#199813954">(Jun 04 2020 at 22:00)</a>:</h4>
<p>and <code>Engine</code> is thread-safe (as before)</p>



<a name="199813962"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/199813962" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#199813962">(Jun 04 2020 at 22:00)</a>:</h4>
<p><code>Module</code> is now thread safe as well</p>



<a name="199813969"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/199813969" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#199813969">(Jun 04 2020 at 22:00)</a>:</h4>
<p>(I probably need to update the free code too...)</p>



<a name="199813990"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/199813990" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#199813990">(Jun 04 2020 at 22:00)</a>:</h4>
<p>modules can be shared across threads, but instances cannot</p>



<a name="199814003"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/199814003" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#199814003">(Jun 04 2020 at 22:00)</a>:</h4>
<p>instances will likely always be locked to one thread</p>



<a name="199814105"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/199814105" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#199814105">(Jun 04 2020 at 22:01)</a>:</h4>
<p>Ok, so given a triple (module, store, engine) I can create (and use) N instances on N threads?</p>



<a name="199814154"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/199814154" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#199814154">(Jun 04 2020 at 22:02)</a>:</h4>
<p>(and yeah, i don't mean to move an instance across threads)</p>



<a name="199814279"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/199814279" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#199814279">(Jun 04 2020 at 22:03)</a>:</h4>
<p>I ended up rearchitecting to having a pool of instances that each have their own context (module, store, linker) and go back into the pool once they're done. But it sounds like I could instead go back to my original design where I have a <em>single</em> (module, store, linker) and create as many new instances as I want that are used on different threads?</p>



<a name="199814307"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/199814307" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#199814307">(Jun 04 2020 at 22:03)</a>:</h4>
<p>you can have a single engine/module, but you still need a store-per-thread</p>



<a name="199814368"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/199814368" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#199814368">(Jun 04 2020 at 22:04)</a>:</h4>
<p>and store represents the lifetime of an instance as well (in terms of memory allocations), so you likely want a store to be relatively short-lived</p>



<a name="199814392"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/199814392" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#199814392">(Jun 04 2020 at 22:04)</a>:</h4>
<p>Ah, I didn't know that. I wasn't disposing the store.</p>



<a name="199814458"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/199814458" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#199814458">(Jun 04 2020 at 22:05)</a>:</h4>
<p>note that this could all use better documentation as well</p>



<a name="199814464"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/199814464" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#199814464">(Jun 04 2020 at 22:05)</a>:</h4>
<p>which is something I would like to get to!</p>



<a name="199814522"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/199814522" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#199814522">(Jun 04 2020 at 22:06)</a>:</h4>
<p>Ok so. I can construct a module given an engine. And hold onto that module (I don't need to keep the engine around). And then I can construct a store, wasi instance, linker, and then an actual wasm instance on each request, using the same module</p>



<a name="199814583"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/199814583" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#199814583">(Jun 04 2020 at 22:06)</a>:</h4>
<p>(didn't realize that about the store, probably because the module depended on it when i started, so i thought it was more of a general wasmtime context)</p>



<a name="199814779"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/199814779" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#199814779">(Jun 04 2020 at 22:08)</a>:</h4>
<p>Just looked a bit more. I didn't realize your "That's been fixed!" comment referred to something <em>past</em> 0.17.0.</p>



<a name="199815119"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/199815119" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#199815119">(Jun 04 2020 at 22:12)</a>:</h4>
<p>You may need to keep engine around to create stores though</p>



<a name="199815317"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/199815317" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#199815317">(Jun 04 2020 at 22:14)</a>:</h4>
<p>it is uncharted territory when two modules from different engines with different settings are used (might work though <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span> )</p>



<a name="199815770"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/199815770" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#199815770">(Jun 04 2020 at 22:19)</a>:</h4>
<p>Yeah. It's just a bit confusing because the c-api change from your PR didn't change the signature for <code>wasm_module_new</code>, it still takes a store, it just grabs the engine from the store and uses that instead. So I suppose that PR was internal (from the module c-api perspective).</p>



<a name="199815882"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/199815882" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#199815882">(Jun 04 2020 at 22:20)</a>:</h4>
<p>But I suppose, for my purposes, the store that I supply isn't actually important? I can just create one to use to compile the module and then throw it away after?</p>



<a name="199815905"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/199815905" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#199815905">(Jun 04 2020 at 22:20)</a>:</h4>
<p><code>wasm_module_new</code> will not change we are just API implementors, we can change <code>wasmtime_module_new</code> and I did, but last minute HostRef refactoring changed it back</p>



<a name="199816034"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/199816034" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#199816034">(Jun 04 2020 at 22:22)</a>:</h4>
<p>wasm-c-api requires usage of wasm_module_share wasm_module_obtain when transferred between stores (hence threads)</p>



<a name="199816121"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/199816121" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#199816121">(Jun 04 2020 at 22:23)</a>:</h4>
<p>see e.g. <a href="https://github.com/WebAssembly/wasm-c-api/blob/master/example/threads.c#L32">https://github.com/WebAssembly/wasm-c-api/blob/master/example/threads.c#L32</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/wasm-c-api/blob/master/example/threads.c#L32" style="background-image: url(https://avatars3.githubusercontent.com/u/11578470?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/wasm-c-api/blob/master/example/threads.c#L32" title="WebAssembly/wasm-c-api">WebAssembly/wasm-c-api</a></div><div class="message_embed_description">Wasm C API prototype. Contribute to WebAssembly/wasm-c-api development by creating an account on GitHub.</div></div></div>



<a name="199816211"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/199816211" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#199816211">(Jun 04 2020 at 22:24)</a>:</h4>
<p>but we can do whatever we want with rust api :)</p>



<a name="199816216"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/199816216" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#199816216">(Jun 04 2020 at 22:24)</a>:</h4>
<p>Roger. Getting pretty far out of my domain but let me know if there's something I can help with in the Go library <span class="user-mention" data-user-id="253994">@Alex Crichton</span></p>



<a name="199816299"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/199816299" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#199816299">(Jun 04 2020 at 22:25)</a>:</h4>
<p>Thanks for the example, that makes it a bit more clear!</p>



<a name="200746621"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime-go/near/200746621" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vidal <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime-go.html#200746621">(Jun 13 2020 at 03:23)</a>:</h4>
<p>nice work on reducing the macos bug report <span class="user-mention" data-user-id="253994">@Alex Crichton</span> !</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>