<html>
<head><meta charset="utf-8"><title>Run a C program which needs HTTP/Socket request on Wasm now · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/index.html">general</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Run.20a.20C.20program.20which.20needs.20HTTP.2FSocket.20request.20on.20Wasm.20now.html">Run a C program which needs HTTP/Socket request on Wasm now</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="453354603"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Run%20a%20C%20program%20which%20needs%20HTTP/Socket%20request%20on%20Wasm%20now/near/453354603" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ringz <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Run.20a.20C.20program.20which.20needs.20HTTP.2FSocket.20request.20on.20Wasm.20now.html#453354603">(Jul 23 2024 at 08:18)</a>:</h4>
<p>I have a C program which can send HTTP requests to other services, how can I run it on Wasm now?<br>
I found that even though WasmEdge supports most of the Socket API now, all the mainstream existing C to Wasm compiles don't support compiling Socket API, including Emscripten, Wasi-sdk.<br>
Is there any other way to achieve it? Or maybe we need to wait until the wasi-http or wasi-socket proposals are accepted and implemented in the C to Wasm compiles?<br>
Also, I found that rust compiler supports some key Socket APIs which are not in wasi-preview1, e.g., sock_setsockopt, sock_connect. So I was confused about why the toolchains for Wasm in Rust are more mature than those in C/C++. Is it related to the special features of Rust or what?</p>



<a name="453999082"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Run%20a%20C%20program%20which%20needs%20HTTP/Socket%20request%20on%20Wasm%20now/near/453999082" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Victor Adossi <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Run.20a.20C.20program.20which.20needs.20HTTP.2FSocket.20request.20on.20Wasm.20now.html#453999082">(Jul 25 2024 at 16:45)</a>:</h4>
<p>Sockets <a href="https://github.com/WebAssembly/wasi-libc/pull/477">are implemented in <code>wasi-libc</code></a>, and while there is <a href="https://github.com/WebAssembly/wasi-sdk/issues/447">a recent issue</a> with <code>wasi-sdk</code> not having the <code>wasm32-wasip2</code> target, <a href="https://github.com/WebAssembly/wasi-libc/issues/447#issuecomment-2091504421"><code>wasi-sdk</code> 22 has the target now</a>. You'll still need to do some adapting to get there it looks like but it <em>should</em> be possible.</p>
<p>Could you try targeting <code>wasm32-wasip2</code> target with <code>wasi-sdk</code> 22?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/wasi-libc/pull/477" style="background-image: url(&quot;https://uploads.zulipusercontent.net/3de89184edbbde65d44a2073e968974c843f612a/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f373032373364326636363633393465343863323061356630326238646164356364303461393564393333623661353734363863613564663334346665613330652f576562417373656d626c792f776173692d6c6962632f70756c6c2f343737&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/wasi-libc/pull/477" title="implement basic TCP/UDP client support by dicej · Pull Request #477 · WebAssembly/wasi-libc">implement basic TCP/UDP client support by dicej · Pull Request #477 · WebAssembly/wasi-libc</a></div><div class="message_embed_description">This implements socket, connect, recv, send, etc. in terms of wasi-sockets for the wasm32-wasi-preview2 target.
I've introduced a new public header file: __wasi_snapshot.h, which will define a prep...</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/wasi-sdk/issues/447" style="background-image: url(&quot;https://uploads.zulipusercontent.net/e96ba637afd710d9283f2b057e48355c6f978e8a/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f346239363965373038363063626339666565643966646336386634336137303832383566633232373136393161656563373539613134643233636661363635342f576562417373656d626c792f776173692d73646b2f6973737565732f343437&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/wasi-sdk/issues/447" title="Raise errors when compiling c socket to wasm · Issue #447 · WebAssembly/wasi-sdk">Raise errors when compiling c socket to wasm · Issue #447 · WebAssembly/wasi-sdk</a></div><div class="message_embed_description">Hi, I write a C program which will send an HTTP request to a server and it can run successfully when compiling it to machine code. When I try to use wasi-sdk to compile it, I encounter the followin...</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/wasi-libc/issues/447#issuecomment-2091504421" style="background-image: url(&quot;https://uploads.zulipusercontent.net/10663a05bd40f297a2f0907ea314560761dadd03/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613762316134343763653237356338383463613438333532393935653331666239646362396136323030623962396139356236303665376362383162656165322f576562417373656d626c792f776173692d6c6962632f6973737565732f343437&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/wasi-libc/issues/447#issuecomment-2091504421" title="Proposal: add `wasm32-wasi-preview2` target, prioritizing `wasi-sockets` support · Issue #447 · WebAssembly/wasi-libc">Proposal: add `wasm32-wasi-preview2` target, prioritizing `wasi-sockets` support · Issue #447 · WebAssembly/wasi-libc</a></div><div class="message_embed_description">Summary This is a proposal to add wasi-sockets support to wasi-libc as a first step towards full WASI Preview 2 support. This includes adding a new wasm32-wasi-preview2 build target to differentiat...</div></div></div>



<a name="454527378"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Run%20a%20C%20program%20which%20needs%20HTTP/Socket%20request%20on%20Wasm%20now/near/454527378" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> celine santosh <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Run.20a.20C.20program.20which.20needs.20HTTP.2FSocket.20request.20on.20Wasm.20now.html#454527378">(Jul 27 2024 at 20:58)</a>:</h4>
<p>Hi </p>
<p>I have a go program which makes a tcp connection <br>
<code>conn, err := net.Dial("tcp", "216.58.206.46:80")</code></p>
<p>but this is not executing successfully and I encounter some nil pointer error even though the program executes successfully separately. So is this because of the reason above, that the network calls from a Go program compiled to WebAssembly (Wasm) and executed in a WASI environment will not work because the necessary system calls are not available in WASI Preview 1. Also for compilers like tinyGo and standard Go compiler, they still have limitations to support wasi preview 2?</p>



<a name="454816943"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Run%20a%20C%20program%20which%20needs%20HTTP/Socket%20request%20on%20Wasm%20now/near/454816943" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Run.20a.20C.20program.20which.20needs.20HTTP.2FSocket.20request.20on.20Wasm.20now.html#454816943">(Jul 29 2024 at 12:17)</a>:</h4>
<p>as of july 2: "It's a milestone day for Gophers and WebAssembly: the <code>wasi-preview-2</code> feature branch of TinyGo has landed in TinyGo's <code>dev</code> branch, bringing WASI P2 support to TinyGo!"</p>



<a name="454855796"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Run%20a%20C%20program%20which%20needs%20HTTP/Socket%20request%20on%20Wasm%20now/near/454855796" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ringz <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Run.20a.20C.20program.20which.20needs.20HTTP.2FSocket.20request.20on.20Wasm.20now.html#454855796">(Jul 29 2024 at 14:42)</a>:</h4>
<p>Hi</p>
<p>I try to compile with <code>--target=wasm32-wasip2</code> option using <code>wasi-sdk</code> and successfully get the wasm code.<br>
But the compiled result cannot successfully run on the existing wasm runtimes.</p>
<p>For WasmEdge, as the HTTP requests are related to wasi-socket proposal, WasmEdge is working for it.<br>
<a href="https://github.com/WasmEdge/WasmEdge/issues/2939">https://github.com/WasmEdge/WasmEdge/issues/2939</a><br>
For Wasmtime, I open an issue about it.<br>
<a href="https://github.com/bytecodealliance/wasmtime/issues/9034">https://github.com/bytecodealliance/wasmtime/issues/9034</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/WasmEdge/WasmEdge/issues/2939" style="background-image: url(&quot;https://uploads.zulipusercontent.net/9943ee1a2349dee9ba9531f2cd229989ab5267c8/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f343265336131373030383166636366613334323366313239613433333534646264663832393834363239363030643533643865623137343839313333343935392f5761736d456467652f5761736d456467652f6973737565732f32393339&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WasmEdge/WasmEdge/issues/2939" title="WASI preview2 proposals tracking issue · Issue #2939 · WasmEdge/WasmEdge">WASI preview2 proposals tracking issue · Issue #2939 · WasmEdge/WasmEdge</a></div><div class="message_embed_description">Summary This issue replaced #2806. This issue will be marked as finished once all preview2 proposals are implemented and verified. WasmEdge would love to have native support for the WASI preview2, ...</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/issues/9034" style="background-image: url(&quot;https://uploads.zulipusercontent.net/f5102d9f58cdfe5b22c2f379ec689d014b82b5a1/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f396664396261356637643765313566343563393133663937386337393535353236623561313434376637383432373163323337646333636262643337303437302f62797465636f6465616c6c69616e63652f7761736d74696d652f6973737565732f39303334&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/issues/9034" title="Failed to run the wasm32-wasip2 code · Issue #9034 · bytecodealliance/wasmtime">Failed to run the wasm32-wasip2 code · Issue #9034 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">Hi, I have a C program which would send a HTTP request to a server, and use wasi-sdk-23 to compile it to wasm code, but fail to run it on Wasmtime, the error message is connect: Permission denied. ...</div></div></div>



<a name="455227459"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Run%20a%20C%20program%20which%20needs%20HTTP/Socket%20request%20on%20Wasm%20now/near/455227459" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> celine santosh <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Run.20a.20C.20program.20which.20needs.20HTTP.2FSocket.20request.20on.20Wasm.20now.html#455227459">(Jul 30 2024 at 21:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="268586">Ralph</span> <a href="#narrow/stream/206238-general/topic/Run.20a.20C.20program.20which.20needs.20HTTP.2FSocket.20request.20on.20Wasm.20now/near/454816943">said</a>:</p>
<blockquote>
<p>as of july 2: "It's a milestone day for Gophers and WebAssembly: the <code>wasi-preview-2</code> feature branch of TinyGo has landed in TinyGo's <code>dev</code> branch, bringing WASI P2 support to TinyGo!"</p>
</blockquote>
<p>I have checked out the dev branch of tiny go.I have a go program which attempts to make a tcp connection to an ip. I have compiled this go program to Wasm module using tinyGo (dev branch which has wasip2 support) and target as wasip2. Now I am executing this in wasmtime . But wasmtime throws an error.</p>
<p>Error: failed to parse WebAssembly module</p>
<p>Caused by:</p>
<p>expected a WebAssembly module but was given a WebAssembly component</p>
<p>I thought the problem is because of the network call, so I changed the program to a simple program which does simple file operations. This runs successfully with wasip1 and this same program gives the same error as above with target wasip2. Even though the tinyGo dev branch has wasip2 support it's not running successfully when it comes in integration with wasmtime.<br>
Any idea on this?</p>



<a name="455227680"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Run%20a%20C%20program%20which%20needs%20HTTP/Socket%20request%20on%20Wasm%20now/near/455227680" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Run.20a.20C.20program.20which.20needs.20HTTP.2FSocket.20request.20on.20Wasm.20now.html#455227680">(Jul 30 2024 at 21:50)</a>:</h4>
<p>can you show what you invoked that gave that error?</p>



<a name="455301815"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Run%20a%20C%20program%20which%20needs%20HTTP/Socket%20request%20on%20Wasm%20now/near/455301815" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> celine santosh <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Run.20a.20C.20program.20which.20needs.20HTTP.2FSocket.20request.20on.20Wasm.20now.html#455301815">(Jul 31 2024 at 07:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="253992">Pat Hickey</span> <a href="#narrow/stream/206238-general/topic/Run.20a.20C.20program.20which.20needs.20HTTP.2FSocket.20request.20on.20Wasm.20now/near/455227680">said</a>:</p>
<blockquote>
<p>can you show what you invoked that gave that error?</p>
</blockquote>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">package</span><span class="w"> </span><span class="n">main</span>

<span class="n">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">"fmt"</span>
<span class="w">    </span><span class="s">"io/ioutil"</span>
<span class="w">    </span><span class="s">"net/http"</span>
<span class="w">    </span><span class="s">"os"</span>
<span class="p">)</span>

<span class="n">func</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">fmt</span><span class="p">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"I am from Go app"</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Make a simple HTTP GET request</span>
<span class="w">    </span><span class="n">resp</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">http</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="s">"http://example.com"</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fmt</span><span class="p">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Error:"</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">)</span>
<span class="w">        </span><span class="n">os</span><span class="p">.</span><span class="n">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Read the response body</span>
<span class="w">    </span><span class="n">body</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">ioutil</span><span class="p">.</span><span class="n">ReadAll</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="n">Body</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fmt</span><span class="p">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Error reading response body:"</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">)</span>
<span class="w">        </span><span class="n">os</span><span class="p">.</span><span class="n">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">resp</span><span class="p">.</span><span class="n">Body</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>

<span class="w">    </span><span class="n">fmt</span><span class="p">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Response status: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">resp</span><span class="p">.</span><span class="n">Status</span><span class="p">)</span>
<span class="w">    </span><span class="n">fmt</span><span class="p">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Response body: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">body</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>Running this go program separately gives output. but when in conjunction with wasmtime gives error <br>
Error: failed to parse WebAssembly module</p>
<p>Caused by:</p>
<p>expected a WebAssembly module but was given a WebAssembly component</p>



<a name="455302181"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Run%20a%20C%20program%20which%20needs%20HTTP/Socket%20request%20on%20Wasm%20now/near/455302181" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Run.20a.20C.20program.20which.20needs.20HTTP.2FSocket.20request.20on.20Wasm.20now.html#455302181">(Jul 31 2024 at 07:05)</a>:</h4>
<p>I think we're asking for the wasmtime execution command line you used</p>



<a name="455302326"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Run%20a%20C%20program%20which%20needs%20HTTP/Socket%20request%20on%20Wasm%20now/near/455302326" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Run.20a.20C.20program.20which.20needs.20HTTP.2FSocket.20request.20on.20Wasm.20now.html#455302326">(Jul 31 2024 at 07:05)</a>:</h4>
<p>wasmtime serve? run? -S common or some other variation</p>



<a name="455302475"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Run%20a%20C%20program%20which%20needs%20HTTP/Socket%20request%20on%20Wasm%20now/near/455302475" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Run.20a.20C.20program.20which.20needs.20HTTP.2FSocket.20request.20on.20Wasm.20now.html#455302475">(Jul 31 2024 at 07:06)</a>:</h4>
<p>also, would love results of <code>wasmtime --version</code></p>



<a name="455302574"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Run%20a%20C%20program%20which%20needs%20HTTP/Socket%20request%20on%20Wasm%20now/near/455302574" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Run.20a.20C.20program.20which.20needs.20HTTP.2FSocket.20request.20on.20Wasm.20now.html#455302574">(Jul 31 2024 at 07:07)</a>:</h4>
<p>I'd also love the <code>tinygo</code> compilation line -- did I miss that?</p>



<a name="455306350"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Run%20a%20C%20program%20which%20needs%20HTTP/Socket%20request%20on%20Wasm%20now/near/455306350" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> celine santosh <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Run.20a.20C.20program.20which.20needs.20HTTP.2FSocket.20request.20on.20Wasm.20now.html#455306350">(Jul 31 2024 at 07:33)</a>:</h4>
<p>Actually I am not using wasmtime cli , I have pulled the latest main branch <a href="https://github.com/bytecodealliance/wasmtime">https://github.com/bytecodealliance/wasmtime</a><br>
and I am running this. because as part of my project I will have to do some modifications like overwrite wasi calls etc. <br>
So in this codebase I have added a directory under examples for my app and  ran the command <br>
cargo run</p>
<p>here is my <a href="http://main.rs">main.rs</a> file </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasi_common</span><span class="p">::</span><span class="n">WasiCtx</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasi_common</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">WasiCtxBuilder</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasi_common</span><span class="p">::</span><span class="n">sync</span><span class="p">::{</span><span class="n">ambient_authority</span><span class="p">,</span><span class="w"> </span><span class="n">Dir</span><span class="p">};</span>


<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Define the WASI functions globally on the `Config`.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span><span class="p">::</span><span class="n">default</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasi_common</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">add_to_linker</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">s</span><span class="o">|</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>



<span class="w">    </span><span class="c1">// Create a WASI context and put it in a Store; all instances in the store</span>
<span class="w">    </span><span class="c1">// share this context. `WasiCtxBuilder` provides a number of ways to</span>
<span class="w">    </span><span class="c1">// configure what the target program will have access to.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasiCtxBuilder</span><span class="p">::</span><span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">inherit_stdio</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">inherit_args</span><span class="p">()</span><span class="o">?</span>
<span class="w">        </span><span class="p">.</span><span class="n">build</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">wasi</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Load our WebAssembly modules.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module_rust_app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span><span class="p">::</span><span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="s">"/Users/celinesantosh/Desktop/sem_5/rust_app/target/wasm32-wasi/release/rust_app.wasm"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module_go_app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span><span class="p">::</span><span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="s">"/Users/celinesantosh/Desktop/sem_5/go_program/go_app.wasm"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Instantiate the Rust app module.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">instance_rust_app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linker</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module_rust_app</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Instantiate the Go app module.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">instance_go_app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linker</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module_go_app</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Get the `_start` function from the Rust app instance.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">start_rust_app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance_rust_app</span><span class="p">.</span><span class="n">get_typed_func</span><span class="p">::</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"_start"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Get the `_start` function from the Go app instance.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">start_go_app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance_go_app</span><span class="p">.</span><span class="n">get_typed_func</span><span class="p">::</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"_start"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Call the `_start` function on both modules.</span>
<span class="w">    </span><span class="n">start_rust_app</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="p">())</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">start_go_app</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="p">())</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<p>TinyGo compilation :<br>
/Users/celinesantosh/Desktop/sem_5/tinygo/build/tinygo build -o go_app.wasm -target=wasip2 main.go</p>
<p>Thanks</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime" style="background-image: url(&quot;https://uploads.zulipusercontent.net/2ddc6f94271e0956f8f9aa1cc6c7908840681163/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f393261366239363563343837363831353132626165383337366566313937383563623763383031653564626434373135376635323938343434613161343965332f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime" title="GitHub - bytecodealliance/wasmtime: A fast and secure runtime for WebAssembly">GitHub - bytecodealliance/wasmtime: A fast and secure runtime for WebAssembly</a></div><div class="message_embed_description">A fast and secure runtime for WebAssembly. Contribute to bytecodealliance/wasmtime development by creating an account on GitHub.</div></div></div>



<a name="455386157"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Run%20a%20C%20program%20which%20needs%20HTTP/Socket%20request%20on%20Wasm%20now/near/455386157" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Run.20a.20C.20program.20which.20needs.20HTTP.2FSocket.20request.20on.20Wasm.20now.html#455386157">(Jul 31 2024 at 14:21)</a>:</h4>
<p>In your <code>main.rs</code> file, you're using the Wasmtime <code>Module</code> API and the WASIp1 support in <code>wasi_common</code>.  That won't work for WASIp2 components.  Please make sure you're using a recent version of Wasmtime and use the <a href="https://docs.rs/wasmtime/latest/wasmtime/component/index.html">wasmtime::component</a> API, along with <a href="https://docs.rs/wasmtime-wasi/">wasmtime-wasi</a>, which now supports WASIp2 by default.</p>
<p>Search for <code>CliLinker::Component</code> in <a href="https://github.com/bytecodealliance/wasmtime/blob/main/src/commands/run.rs">this file</a> for an example of how to run a WASIp2 CLI component.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/main/src/commands/run.rs" style="background-image: url(&quot;https://uploads.zulipusercontent.net/3e66c3d12459d12dce66bf47446b74935a0e3069/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f623665336335653839356230633865633435343834343531623937643564306638663837643963336438653733633532616333313461303063373936653732612f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/main/src/commands/run.rs" title="wasmtime/src/commands/run.rs at main · bytecodealliance/wasmtime">wasmtime/src/commands/run.rs at main · bytecodealliance/wasmtime</a></div><div class="message_embed_description">A fast and secure runtime for WebAssembly. Contribute to bytecodealliance/wasmtime development by creating an account on GitHub.</div></div></div>



<a name="455625298"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Run%20a%20C%20program%20which%20needs%20HTTP/Socket%20request%20on%20Wasm%20now/near/455625298" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> celine santosh <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Run.20a.20C.20program.20which.20needs.20HTTP.2FSocket.20request.20on.20Wasm.20now.html#455625298">(Aug 01 2024 at 11:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="509936">Joel Dice</span> <a href="#narrow/stream/206238-general/topic/Run.20a.20C.20program.20which.20needs.20HTTP.2FSocket.20request.20on.20Wasm.20now/near/455386157">said</a>:</p>
<blockquote>
<p>In your <code>main.rs</code> file, you're using the Wasmtime <code>Module</code> API and the WASIp1 support in <code>wasi_common</code>.  That won't work for WASIp2 components.  Please make sure you're using a recent version of Wasmtime and use the <a href="https://docs.rs/wasmtime/latest/wasmtime/component/index.html">wasmtime::component</a> API, along with <a href="https://docs.rs/wasmtime-wasi/">wasmtime-wasi</a>, which now supports WASIp2 by default.</p>
<p>Search for <code>CliLinker::Component</code> in <a href="https://github.com/bytecodealliance/wasmtime/blob/main/src/commands/run.rs">this file</a> for an example of how to run a WASIp2 CLI component.</p>
</blockquote>
<p>Thanks for the explanation.<br>
Are there any examples for creating the <a href="http://main.rs">main.rs</a> file with wasi preview2?<br>
I can see a lot of examples with wasi preview1 in the repo though.</p>



<a name="455683551"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Run%20a%20C%20program%20which%20needs%20HTTP/Socket%20request%20on%20Wasm%20now/near/455683551" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Run.20a.20C.20program.20which.20needs.20HTTP.2FSocket.20request.20on.20Wasm.20now.html#455683551">(Aug 01 2024 at 15:39)</a>:</h4>
<p>Rust nightly now supports the <code>wasm32-wasip2</code> target, so you can consider using that.  For Rust stable, you can either use <a href="https://github.com/bytecodealliance/cargo-component">cargo-component</a> (although I don't know of a <code>wasi:cli</code> example for <code>cargo-component</code> offhand) or convert the WASIp1 module produced by <code>cargo build --target=wasm32-wasi</code> into a WASIp2 component using <code>wasm-tools component new --adapt wasi_snapshot_preview1.command.wasm target/wasm32-wasi/release/$APP_NAME.wasm</code> after downloading <a href="https://github.com/bytecodealliance/wasmtime/releases/download/v23.0.1/wasi_snapshot_preview1.command.wasm">wasi_snapshot_preview1.command.wasm</a>.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/cargo-component" style="background-image: url(&quot;https://uploads.zulipusercontent.net/cc32709c7360341bf8be979914a0bcddd6ddac92/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f636533626165653132616365666363343934353462613139363537616431623935373337353930323166663738623331353166613838383466356430353431612f62797465636f6465616c6c69616e63652f636172676f2d636f6d706f6e656e74&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/cargo-component" title="GitHub - bytecodealliance/cargo-component: A Cargo subcommand for creating WebAssembly components based on the component model proposal.">GitHub - bytecodealliance/cargo-component: A Cargo subcommand for creating WebAssembly components based on the component model proposal.</a></div><div class="message_embed_description">A Cargo subcommand for creating WebAssembly components based on the component model proposal. - bytecodealliance/cargo-component</div></div></div>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>