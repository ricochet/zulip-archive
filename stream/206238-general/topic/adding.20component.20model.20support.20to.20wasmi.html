<html>
<head><meta charset="utf-8"><title>adding component model support to wasmi · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/index.html">general</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html">adding component model support to wasmi</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="373920931"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/373920931" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> monkeyontheloose <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#373920931">(Jul 10 2023 at 11:14)</a>:</h4>
<p>gm, im wondering how hard it would be and what would be the best steps to add component model support to wasmi,<br>
hope this is the right place to ask this question <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span></p>
<p>Zooming out I'm trying to use this lib  <a href="https://github.com/DelphinusLab/zkWasm">https://github.com/DelphinusLab/zkWasm</a> which uses wamsi for execution traces, unfortunately wasmi doesn't support component model yet</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/DelphinusLab/zkWasm" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/79e838bc08d1e4b618c9af681439ab51dc8c4b00\/68747470733a2f2f7265706f7369746f72792d696d616765732e67697468756275736572636f6e74656e742e636f6d2f3530353332303332352f36663936633039302d353734302d343432362d616139622d386236643961613561303266)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/DelphinusLab/zkWasm" title="GitHub - DelphinusLab/zkWasm">GitHub - DelphinusLab/zkWasm</a></div><div class="message_embed_description">Contribute to DelphinusLab/zkWasm development by creating an account on GitHub.</div></div></div>



<a name="374320714"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/374320714" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#374320714">(Jul 11 2023 at 16:08)</a>:</h4>
<p>I don't know whether wasmi directly interprets wasm opcodes or translates those to its own IR that it then interprets. the approach taken might vary depending on that.</p>
<p>in general, first you'd need support for parsing the text format and decoding the binary format. I <em>think</em> wasmi uses our <code>wasm-tools</code> crates, so if that is true then this first step is already complete.</p>
<p>at the runtime level, you'd need to either interpret the lifting and lowering instructions or translate those instructions to wasm opcodes or the internal IR if it exists and then interpret that. this is where the bulk of the effort will be.</p>
<p>maybe <span class="user-mention" data-user-id="253994">@Alex Crichton</span> or others can add more details here / correct anythign I misrepresented.</p>



<a name="374326866"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/374326866" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#374326866">(Jul 11 2023 at 16:29)</a>:</h4>
<p>I would agree that the hard part here is likely going to be the lifting/lowering and all of those semantics. I've found the representation of everything to be quite difficult to pin down in Wasmtime but that's also because I'm trying to be careful about allocations/speed/etc and less-optimized solutions which are simpler to understand are probably more in the wheelhouse of wasmi which may make that part much easier</p>



<a name="374330788"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/374330788" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#374330788">(Jul 11 2023 at 16:42)</a>:</h4>
<p>right, all the work we do in FACT is basically something that an interpreter could skip</p>



<a name="374333451"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/374333451" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> monkeyontheloose <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#374333451">(Jul 11 2023 at 16:53)</a>:</h4>
<ol>
<li>how many hours of work would the take (ballpark)?</li>
<li>the zkWasm app uses wasmi to create execution traces which it then uses to create proofs, just to be sure, you can't use wasmtime which already supports CM for this, right?</li>
<li>lifting and lowering instructions are new wasm opcodes?</li>
<li>could you pls refer me to links that might be useful in understanding the work that needs to be done?</li>
</ol>



<a name="374342706"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/374342706" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#374342706">(Jul 11 2023 at 17:31)</a>:</h4>
<p>all the relevant documents are linked from the README here: <a href="https://github.com/WebAssembly/component-model/">https://github.com/WebAssembly/component-model/</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/component-model/" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/ccdbd20cd8d35357be3946839a87a872c77edefc\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f646333376161643135643061636337626635656464363565376265393134363632366133613465313233333639323036333237363966313933323832366164652f576562417373656d626c792f636f6d706f6e656e742d6d6f64656c)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/component-model/" title="GitHub - WebAssembly/component-model: Repository for design and specification of the Component Model">GitHub - WebAssembly/component-model: Repository for design and specification of the Component Model</a></div><div class="message_embed_description">Repository for design and specification of the Component Model - GitHub - WebAssembly/component-model: Repository for design and specification of the Component Model</div></div></div>



<a name="374342892"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/374342892" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#374342892">(Jul 11 2023 at 17:32)</a>:</h4>
<p>I'd estimate a month of work for someone who is familiar with wasmi and wasm</p>



<a name="374343156"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/374343156" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#374343156">(Jul 11 2023 at 17:33)</a>:</h4>
<p>the lifting and lowering instructions are at the component model level, not core wasm. they can't be interspersed with regular wasm opcodes. they statically appear within a different context.</p>



<a name="374343566"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/374343566" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#374343566">(Jul 11 2023 at 17:35)</a>:</h4>
<p>you might be able to pre-process the wasm before running it to insert instrumentation to create execution traces and then run the instrumented wasm in your wasmtime embedding that provides the hooks that the aforementioned instrumentation relies upon. I don't really know that particular domain and what kind of traces it is taking so I can't really say more than that.</p>



<a name="374755940"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/374755940" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#374755940">(Jul 12 2023 at 22:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="630754">Michelle Thalakottur</span> has marked this topic as resolved.</p>



<a name="374755957"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/374755957" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#374755957">(Jul 12 2023 at 22:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="630754">Michelle Thalakottur</span> has marked this topic as unresolved.</p>



<a name="377056144"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377056144" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377056144">(Jul 20 2023 at 17:12)</a>:</h4>
<p>this is also in my area of interest -- we're using wasmi (and have had to hand-roll an ABI) -- and I've .. struggled to understand obligations on the host and guest from the linked docs</p>



<a name="377056387"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377056387" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377056387">(Jul 20 2023 at 17:13)</a>:</h4>
<p>is it correct to understand that the "canonical ABI" is part of what's going to be standardized, or is the CM like .. parameterized by multiple possible ABIs, or something?</p>



<a name="377057897"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377057897" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377057897">(Jul 20 2023 at 17:19)</a>:</h4>
<p>The CM is designed to support many possible ABIs. And, the Canonical ABI is a particular ABI that is being developed to be standardized.</p>



<a name="377061721"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377061721" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377061721">(Jul 20 2023 at 17:33)</a>:</h4>
<p>hmm .. ok .. that's unfortunatley even less to go on. I'll keep reading! but like .. just to provide feedback as a reader: I understand the wasm 1.0 model I think fairly well at this point, and I understand how wasmi implements it / am basically comfortable with the wasmi codebase, and .. reading the above docs (which I've attempted to read several times in the past ~12 months) brings me very little clarity about what I, or the wasmi maintainer, would need to do to the wasmi codebase to make it "support the CM". like it's not at all clear where the boundaries of responsibilities are between (say) an interpreter codebase, the embedding environment using the interpreter, guest code (wasm, wit or guest source-language) that users see when working in their modules, guest toolchain features (eg. rustc features), code assumed (in perpetuity, by design) to be generated by extra tools, and polyfills.</p>



<a name="377061983"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377061983" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377061983">(Jul 20 2023 at 17:34)</a>:</h4>
<p>I get that there's a set of answers to that! but it is sure not something a non-system-designer-reader can parse from those docs, much less find a specification of.</p>



<a name="377063189"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377063189" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377063189">(Jul 20 2023 at 17:38)</a>:</h4>
<p>I can't even really figure out the dependency graph of specs, like what other post-1.0 extensions (or parts of them) it depends on a runtime having implemented (which I suspect are "more than none" and might well be "more than wasmi supports", i.e. it might be quite a ways before the starting line for "supporting the CM")</p>



<a name="377063346"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377063346" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377063346">(Jul 20 2023 at 17:39)</a>:</h4>
<p>At least personally I agree that that the docs right now could be better, and <code>CanonicalABI.md</code> is a bit dense approaching it from nothing. That being said all this is still in-development and not "finished" so to some degree this is expected. Not to say we couldn't do better!</p>
<p>From a wasmi perspective I would recommend considering CM support as roughly analagous to core wasm support. Wasmi presumably supports loading a binary-encoded wasm module and doing things with it. The component model at that high layer is the same way, you're given a binary and you enable doing things with it. What can be done is primarily different through a different set of types of values at runtime and through a different "shape" of a component (e.g. it does more than export a flat list of functions but can export bags of functions through instances and such)</p>



<a name="377063360"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377063360" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robin Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377063360">(Jul 20 2023 at 17:39)</a>:</h4>
<p>At the moment, the Canonical ABI is the only ABI you can use. It is parametric in that it can be configured using Canonical ABI options (<code>canonopts</code>) when lifting module exports to the Component level or lowering Component imports to the module level. This involves things like specifying the encoding being used for strings, the memory and allocator to use, etc.</p>



<a name="377063463"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377063463" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377063463">(Jul 20 2023 at 17:39)</a>:</h4>
<p>The CM does not depend on any core wasm features beyond the MVP, so you're safe in that regard</p>



<a name="377063789"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377063789" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377063789">(Jul 20 2023 at 17:41)</a>:</h4>
<p>One thing you might find helpful is to explore examples, which I might recommend Wasmtime's test suite for. There's <code>tests/misc_testsuite/component-model/*.wast</code> which has a lot of components of various shapes and sizes. There's also the <code>wit-bindgen</code> test suite which builds a bunch of components as part of its tests you can poke around with as well. For the "poking" I'd recommend the <code>wasm-tools</code> CLI since it's the only one I'm aware of with component model support</p>



<a name="377064719"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377064719" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377064719">(Jul 20 2023 at 17:45)</a>:</h4>
<p>it depends, surely, on extern refs, no? (luckily wasmi does seem to support those)</p>



<a name="377065219"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377065219" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377065219">(Jul 20 2023 at 17:47)</a>:</h4>
<p>If it helps, some more details on the ABI business is that on one hand there's the component model functions, aka "this function returns a string". On the other hand there's core wasm functions, aka "this function returns an integers". These two concepts are bridged through "lifting" and "lowering" where you lift a core wasm function into a component function and then you can lower a component function into a core wasm function. For example a host provides a component function, the component lowers it, then a core wasm inside the component imports it. Or alternatively a core wasm in a component exports a core wasm function, then a component lifts that, then a host calls it.</p>
<p>The lifting/lowering operations are currently only defined in the context of the "canonical ABI" which you see as <code>canon lower</code> and <code>canon lift</code>. This dictates exact ABI details such as what integer means what, how to handle many arguments, many returns, where do strings live, how do things get allocated, all that stuff. This is the main body of <code>CanonicalABI.md</code>. You might also find it useful to explore the canonical ABI through <code>*.wit</code> files and generated bindings code through <code>wit-bindgen</code>. For example this WIT file:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">package</span><span class="w"> </span><span class="n">my</span>:<span class="nc">example</span>

<span class="n">world</span><span class="w"> </span><span class="n">my</span><span class="o">-</span><span class="n">world</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">import</span><span class="w"> </span><span class="n">foo</span>: <span class="nc">func</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">string</span>
<span class="p">}</span>
</code></pre></div>
<p>you can generate Rust bindings with <code>wit-bindgen rust foo.wit</code> and see what's generated to see how the ABI details there work.</p>



<a name="377065485"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377065485" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377065485">(Jul 20 2023 at 17:48)</a>:</h4>
<blockquote>
<p>it depends, surely, on extern refs, no?</p>
</blockquote>
<p>The component model does not, no. If you're thinking that resources are connected to externrefs they're similar but not the same. Resources when lowered are an index into a component-specific table, which means that core wasm always sees resources as integers (think file descriptors)</p>



<a name="377065779"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377065779" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377065779">(Jul 20 2023 at 17:49)</a>:</h4>
<p>hmm so ok very basic baby question (which, apologies for not being able to parse out of the docs): does every module, as a wasm blob, contain its _own_ copy of lifting/lowering functions? or does the runtime provide some common set?</p>



<a name="377066560"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377066560" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377066560">(Jul 20 2023 at 17:52)</a>:</h4>
<p>On the guest (core wasm) side, lifting and lowering code is generated by wit-bindgen for the guest language. On the wasmtime host side its mostly runtime with some macro generation to make the interfaces nicer</p>



<a name="377066785"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377066785" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377066785">(Jul 20 2023 at 17:53)</a>:</h4>
<p>lifting/lowering is represented as "lift this core wasm function" or "lower this component function", so it's a function without a body sort of where the "body" is implied by the canonical ABI</p>



<a name="377066869"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377066869" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377066869">(Jul 20 2023 at 17:53)</a>:</h4>
<p>so in that sense I suppose you can think of it as runtimes provide lifting/lowering operations, and components specify what lifting/lowering they'll need</p>



<a name="377066961"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377066961" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377066961">(Jul 20 2023 at 17:54)</a>:</h4>
<p>it is the runtime's responsibility to do the lifting and lowering, and it is free to dedupe as much of them as it can</p>



<a name="377067253"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377067253" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377067253">(Jul 20 2023 at 17:55)</a>:</h4>
<p>(separately, the guest language might want to do another layer of massaging/translating/lifting/lowering from the canonical ABI into its data types, this is what <span class="user-mention" data-user-id="480579">@Lann Martin</span> was getting at, I think. eg turn a <code>(usize, usize)</code> from the canonical ABI into a <code>Box&lt;str&gt;</code> in Rust or something like that)</p>



<a name="377067596"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377067596" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377067596">(Jul 20 2023 at 17:56)</a>:</h4>
<blockquote>
<p>For example a host provides a component function, the component lowers it, then a core wasm inside the component imports it</p>
</blockquote>
<p>I'd like to understand, in detail, all the actors involved in accomplishing this sentence. my host is a rust program, it has a wasm interpreter in it, it has rust types. currently it has a rust type that's the union of all possible core wasm types (i32/i64/f32/f64) and n-ary functions taking and returning N of those union types can be registered with the wasm interpreter and dispatched-to, using a little bit of rust type system fudging, using rust dyn fn objects and such. if I have a host function that has a structured component type .. I'm using .. some code generated by another tool that's VM specific? or non-VM-specific?</p>



<a name="377067663"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377067663" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377067663">(Jul 20 2023 at 17:57)</a>:</h4>
<p>One of the documentation pieces missing is a glossary <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="377067800"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377067800" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377067800">(Jul 20 2023 at 17:57)</a>:</h4>
<blockquote>
<p>it is the runtime's responsibility to do the lifting and lowering, and it is free to dedupe as much of them as it can</p>
</blockquote>
<p>Ok so .. there's like a list stapled to the module of functions that will need the runtime to provide lift/lower wrappers, the part of the runtime's job instantiating the module is to synthesize such wrappers?</p>



<a name="377068301"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377068301" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jamey Sharp <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377068301">(Jul 20 2023 at 17:59)</a>:</h4>
<p>The list is part of the component, rather than in any core module inside the component, but yes, I think that's basically right.</p>



<a name="377068336"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377068336" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377068336">(Jul 20 2023 at 18:00)</a>:</h4>
<p>(but those are lift/lower wrappers on the runtime's side, not the guest's side? if the guest uses ABI X and the runtime uses ABI Y, they're supposed to interoperate, right? so .. the guest isn't asking the runtime to synthesize lift/lower code for ABI X and inject it into the guest's module-space, is it?)</p>



<a name="377070476"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377070476" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377070476">(Jul 20 2023 at 18:08)</a>:</h4>
<p>I'm confused by the discussion of multiple ABIs. All of the component tooling currently being worked on assumes the Canonical ABI (which itself is parameterized in a couple of very limited ways).</p>



<a name="377071799"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377071799" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377071799">(Jul 20 2023 at 18:14)</a>:</h4>
<p>well, ok, setting aside "different ABIs" (above discussion wasn't clear on how much this can vary, apparently there are parameters and _maybe_ other ABIs in the future?), even just focusing on guest-vs-host, I want to understand who generated what code and whether they did so ahead of time, or at instantiation time. and if ahead of time, if it's at module-compilation time or host-and-VM compilation time.</p>



<a name="377072142"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377072142" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377072142">(Jul 20 2023 at 18:15)</a>:</h4>
<p>wit-bindgen is going to spit out (a) some stuff that gets compiled-in to a guest module, but also (b) some stuff that gets compiled-in to a host-and-VM pair? and then there's some stuff (c) that the host-and-VM pair is supposed to synthesize on the fly when the component-and-module bundle shows up asking to be instantiated</p>



<a name="377072694"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377072694" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377072694">(Jul 20 2023 at 18:16)</a>:</h4>
<p>so I guess I'm wondering: is that correct? do (a), (b) and (c) all exist? if so I can I think ignore (a), need to teach wasmi to conform to the type signatures and expectations of (b), and need to teach wasmi to actually _do_ (c), unless it's provided by some standard crate in terms of (b)</p>



<a name="377073365"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377073365" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jamey Sharp <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377073365">(Jul 20 2023 at 18:19)</a>:</h4>
<p>fwiw I think in the context of an interpreter you won't need to "synthesize" (c), just walk over the type information you get out of the component to transform between your host-side enum variants and the core wasm types expected by the guest</p>



<a name="377074840"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377074840" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377074840">(Jul 20 2023 at 18:24)</a>:</h4>
<p>(b) is sort of true of wit-bindgen today but that's an internal detail of the current state of tooling; a runtime can get all of the type information it needs from the component binary itself</p>



<a name="377076074"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377076074" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377076074">(Jul 20 2023 at 18:30)</a>:</h4>
<p>ok but .. since the runtime needs to connect to a bunch of statically-typed embedder host functions .. I think the embedder probably wants to get a projection of the wit into a static type in the embedder language, no? or is the VM just supposed to make up a projection from the generalized component type system into type system entities in the host PL? (doing so would likely couple the embedder to a specific VM's choice of projection, much more so than currently since the current 1.0 type system is relatively simple to massage if you change VMs)</p>



<a name="377076503"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377076503" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377076503">(Jul 20 2023 at 18:32)</a>:</h4>
<p>(a long time ago I worked on CORBA systems -- some number of people in the room now have all the blood draining out of their faces in horror but I will continue -- and we used to have tools generate "stubs and skeletons", the skeletons being static types and interfaces that host-side callbacks implement and then pass into the runtime to get called-back through. I'm not clear on whether that is assumed here.)</p>



<a name="377078457"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377078457" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jamey Sharp <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377078457">(Jul 20 2023 at 18:39)</a>:</h4>
<p>my understanding is that if you specifically want static types in the embedder language then you want to use wit-bindgen to generate that glue, and that you need to teach wit-bindgen what that glue should look like for wasmi. it's also possible to introspect on an unknown component at runtime and offer the same kind of interface that you described wasmi having for core wasm ("a rust type that's the union of all possible core wasm types (i32/i64/f32/f64) and n-ary functions taking and returning N of those union types can be registered with the wasm interpreter and dispatched-to, using a little bit of rust type system fudging, using rust dyn fn objects"). both forms can be useful</p>



<a name="377079308"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377079308" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377079308">(Jul 20 2023 at 18:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="634398">Graydon Hoare</span> <a href="#narrow/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi/near/377068336">said</a>:</p>
<blockquote>
<p>(but those are lift/lower wrappers on the runtime's side, not the guest's side? if the guest uses ABI X and the runtime uses ABI Y, they're supposed to interoperate, right? so .. the guest isn't asking the runtime to synthesize lift/lower code for ABI X and inject it into the guest's module-space, is it?)</p>
</blockquote>
<p>everyone speaks the canonical ABI, if a guest wants the data in another format after it receives it in canonical abi format, then it is free to do any further transformations of the data it wants to. but when sending and receiving data, it must be in the canonical ABI.</p>
<p>the trampolines that the runtime is responsible for are for getting two (or more) components linked together: they pass a string, say, and the trampoline has to do the copy from the source to the destination. it is the runtime's responsiblity to create this trampoline (or do equivalent interpreted things) because each component is shared-nothing: they do not have access to each other's core instances' internal state.</p>
<p>backing up a bit:</p>
<ul>
<li>a component can contain zero or more core wasm instances that can all share memories and things (or not, but they have the ability to do so)</li>
<li>components have imports and exports. these are defined in terms of interface types rather than core value types</li>
<li>components cannot share state, they are "shared nothing". no sharing of memory or tables or any of that</li>
<li>components can be composed to create new components, fitting various imports and exports together. so components can contain zero or more other component instances on top of the core wasm instances mentioned earlier</li>
<li>when two components are linked together such that the export of one is the import of another, <em>this</em> is where a trampoline is required and the runtime must provide it</li>
<li>this trampoline lifts the interface values from one component and lowers them into the other. in practice, the lift and lower is pretty much always fused together such that there is one copy from src to dst, and no intermediate interface value is actually materialized</li>
</ul>
<p>for example, given:</p>
<ul>
<li>component <em>A</em> that exports a <code>string -&gt; string</code> component function where it is given a name string and returns "hello &lt;name&gt;"<ul>
<li><em>A</em> contains a core wasm instance that exports this function (taking arguments in canonical ABI format and returning results in canonical ABI format)</li>
<li><em>A</em> lifts the core wasm export function into a component function</li>
<li><em>A</em> exports this lifted component function</li>
</ul>
</li>
<li>component <em>B</em> wraps an instance of component <em>A</em> and exports a component function <code>unit -&gt; string</code><ul>
<li><em>B</em> lowers <em>A</em>'s exported component function to a core wasm function that uses the canonical ABI</li>
<li>passes that as an import to its core wasm instance</li>
<li><em>B</em>'s core wasm instance exports a core wasm function that passes a "CM" string (in canonical ABI format) to the imported function and returns the result (again in canoncial ABI format)</li>
<li><em>B</em> lifts the core wasm instance's export into a component function and exports it</li>
</ul>
</li>
</ul>
<p>this is the sequence of events when the host calls <em>B</em>'s exported component function:</p>
<ul>
<li>the host lowers its arguments to canonical ABI format (no arguments in this particular case, tho)</li>
<li>these arguments are passed to the core wasm function that <em>B</em> lifted and exported</li>
<li>this core function calls its import, which is a trampoline that the runtime provided, passing the string "CM"</li>
<li>this trampoline is the <code>lower(lift(A.export))</code> composition</li>
<li>the details vary for different types and the details should be <code>CanonicalABI.md</code>, but for strings, this effectively means that it asks <em>A</em> to malloc space for the string and then copies from <em>B</em>'s core instance's memory into <em>A</em>'s core instance's memory while simultaneously validating that the bytes are utf8</li>
<li>then the trampoline calls <em>A</em>'s core instance's function with the copied-over string (in canonical ABI format)</li>
<li><em>A</em>'s core instance's function returns "Hello CM" in the canonical ABI format</li>
<li>the trampoline does the same copying and validation in the other direction now: from <em>A</em>'s core instance's memory to <em>B</em>'s core instance's memory</li>
<li>the trampoline returns to <em>B</em>'s core instance's function</li>
<li><em>B</em>'s core instance's function returns the string (in canonical ABI form)</li>
<li>the host receives the result in canonical ABI form and can translate it into whatever representation is useful for the host</li>
</ul>
<p>fin</p>
<p>does that make sense?</p>
<p><code>wit-bindgen</code> is a bit of a distraction here. it is a tool for allowing people to write guest/host programs that talk canonical ABI. but it doesn't have any bearing on what the runtime has to do to support the component model. it is just sugar for turning <code>(u32, u32)</code> (the canonical ABI representation of a string) into <code>Box&lt;str&gt;</code> in rust and stuff like that</p>



<a name="377081409"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377081409" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377081409">(Jul 20 2023 at 18:51)</a>:</h4>
<p>Yes, you can use wit-bindgen to help generate host/embedder language bindings. <code>wasmtime-py</code> does that here: <a href="https://github.com/bytecodealliance/wasmtime-py/blob/main/rust/bindgen/src/bindgen.rs">https://github.com/bytecodealliance/wasmtime-py/blob/main/rust/bindgen/src/bindgen.rs</a></p>



<a name="377082115"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377082115" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377082115">(Jul 20 2023 at 18:53)</a>:</h4>
<p>As a warning, that tooling is probably quite unstable (moreso than the CM/CABI specs), though Alex would have the best perspective on that</p>



<a name="377085271"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377085271" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377085271">(Jul 20 2023 at 19:05)</a>:</h4>
<p>Yeah I wouldn't rely on specific details there per se, but I do think that they can be an interesting way to explore how things work. I mentioned <code>wit-bindgen rust</code> above but the wasmtime-py support, available through <code>python -m wasmtime.bindgen</code>, can be a good way to explore components from a host side. The python support is build on Wasmtime's C API which only supports core modules, so the bindings generated by <code>python -m wasmtime.bindgen</code> can perhaps be helpful to read over and see how things are hooked up. You'll find liftings/lowerings there and such</p>



<a name="377089060"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377089060" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377089060">(Jul 20 2023 at 19:20)</a>:</h4>
<blockquote>
<p>A lifts the core wasm export function into a component function</p>
</blockquote>
<p>(thanks for the details!) Can I .. dig into this point? A is a component, which is a byte blob. You're describing it doing something as a verb here: "A lifts ..". What does that mean? When does A do this? Or rather, which tool does what to accomplish this lifting? Or are you saying that the blob that is A contains a binary declaration in itself somewhere that declares a lifting-relationship between the core function and the component function?</p>



<a name="377090920"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377090920" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377090920">(Jul 20 2023 at 19:27)</a>:</h4>
<p>The latter: there are <code>canon lift</code> and <code>canon lower</code> operations which convert between core and CM functions</p>



<a name="377091415"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377091415" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377091415">(Jul 20 2023 at 19:29)</a>:</h4>
<p>e.g. (somewhat loosly): <code>(canon lift &lt;core-funcidx&gt; &lt;component-func-type&gt;)</code> produces a component function from a core function and the component function type</p>



<a name="377091829"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377091829" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jamey Sharp <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377091829">(Jul 20 2023 at 19:31)</a>:</h4>
<p>I think what you're looking for is that A contains a declaration (the textual syntax is as shown by Lann) indicating that in order to run, it needs one of its functions lifted. the host is responsible for making that actually happen</p>



<a name="377109458"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377109458" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377109458">(Jul 20 2023 at 20:55)</a>:</h4>
<p>the <em>wasm runtime</em> is responsible for making that happen</p>
<p>(I like to reserve "host" for the embedder of the runtime, and I think that's how we usually use it)</p>



<a name="377111912"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377111912" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jamey Sharp <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377111912">(Jul 20 2023 at 21:08)</a>:</h4>
<p>ah, that's a good distinction</p>



<a name="377115624"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377115624" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377115624">(Jul 20 2023 at 21:29)</a>:</h4>
<p>ok so .. just to be 100% clear (it's extremely hard for non-spec-editors to read the examples since they're full of abbreviated forms) .. the (canon ..) form is a declaration form, at the component level, and it defines .. the obligation to build a specific trampoline? or half-trampoline?</p>



<a name="377115959"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377115959" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377115959">(Jul 20 2023 at 21:31)</a>:</h4>
<p>aside, I find the textual definitions almost impossible to read due to all the abbreviations, the only way I've been able to understand wasm _at all_ is by referring to the binary structure definition of a module. like I have no idea at all -- despite staring for the past half hour -- how to parse this example:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$run</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="n">string</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="n">string</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">canon</span><span class="w"> </span><span class="n">lift</span>
<span class="w">    </span><span class="p">(</span><span class="n">core</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="cp">$main</span><span class="w"> </span><span class="s">"run"</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">memory</span><span class="w"> </span><span class="p">(</span><span class="n">core</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="cp">$libc</span><span class="w"> </span><span class="s">"mem"</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">realloc</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$libc</span><span class="w"> </span><span class="s">"realloc"</span><span class="p">))</span>
<span class="w">  </span><span class="p">))</span>
</code></pre></div>



<a name="377116664"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377116664" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377116664">(Jul 20 2023 at 21:35)</a>:</h4>
<blockquote>
<p>like I have no idea at all -- despite staring for the past half hour</p>
</blockquote>
<p>One thing that may help with this is to run the examples through <code>wasm-tools print</code>. That prints the binary form which has a lot more index annotations. Not exactly readable, but it may help perhaps</p>



<a name="377116683"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377116683" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377116683">(Jul 20 2023 at 21:35)</a>:</h4>
<p>I think that desugars to a canon definition -- desugaring the <code>(func ... (canon lift ...))</code> into a <code>(canon lift ... (func ...))</code> and then I think there's an inline-sugar declaration of a core func, maybe? and then .. I don't have any idea what the memory or realloc forms are in there, they do not look like externdescs to me through any desugaring path I can understand</p>



<a name="377117754"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377117754" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377117754">(Jul 20 2023 at 21:40)</a>:</h4>
<blockquote>
<p>One thing that may help with this is to run the examples through wasm-tools print.</p>
</blockquote>
<p><code>wasm-tools</code> I get from <code>cargo install</code> does not accept the examples in the docs. maybe there's a fresher version? or should I look instead at the examples in the repo, not the docs?</p>



<a name="377120021"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377120021" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377120021">(Jul 20 2023 at 21:54)</a>:</h4>
<p>oh, maybe the <code>(memory)</code> and <code>(realloc)</code> forms there are <code>&lt;canonopt&gt;</code> and the outer desugaring is .. somehow .. defining the lifting of the <code>(core func ...)</code> form?</p>



<a name="377122939"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377122939" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377122939">(Jul 20 2023 at 22:12)</a>:</h4>
<p>Yes, they are <code>canonopt</code>s. This syntax is defining a component function that wraps a core-wasm function, using the specified realloc and memory to communicate the string data with the core-wasm function.</p>



<a name="377124859"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377124859" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377124859">(Jul 20 2023 at 22:23)</a>:</h4>
<p>ah yeah <code>wasm-tools</code> will only work in the context of a "full component" which in this case isn't there since it's just one func. There's also a number of syntax differences/typos in the spec so you can probably disregard my suggestion (the spec examples aren't tested yet)</p>



<a name="377128210"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377128210" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377128210">(Jul 20 2023 at 22:49)</a>:</h4>
<blockquote>
<p>ah yeah wasm-tools will only work in the context of a "full component" which in this case isn't there since it's just one func.</p>
</blockquote>
<p>No I don't just mean this one func. I mean the full component example in the explainer ("we can finally write a non-trivial component"). there appear to be enough syntax differences that I can't figure out how to edit it back to being-right (especially since I am reading it to try to figure out what it means, editing it isn't something I have a lot of confidence in)</p>



<a name="377129235"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377129235" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377129235">(Jul 20 2023 at 22:58)</a>:</h4>
<p>it's ok, I can .. at least conceptually picture what this is doing, I think. to restate -- can you confirm? -- this is declaring -- entirely declaratively -- that the existing declared-earlier core func "run", in the $main instance, which had core type ((i32,i32)-&gt;i32) where it was declared, should be lifted to a CM func $run of CM type string-&gt;string, and the trampoline (or half-trampoline?) that the runtime needs to synthesize to do that should map "a CM string" conceptually to a linear-address-and-length pair in the "mem" memory of the $libc instance (itself in the $main instance), and should make allocations it needs in that instance by calling a realloc-shaped core export named "realloc" in the $libc instance.</p>



<a name="377129336"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377129336" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377129336">(Jul 20 2023 at 22:59)</a>:</h4>
<p>is that right?</p>



<a name="377129651"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377129651" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377129651">(Jul 20 2023 at 23:01)</a>:</h4>
<p>Indeed! That all sounds right to me</p>



<a name="377129705"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377129705" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377129705">(Jul 20 2023 at 23:01)</a>:</h4>
<p>Sorry we should go through the examples in the spec and validate they all use actual valid syntax -- as you have probably figured out all the examples were written before we had any parsers and we never went back and updated them.</p>



<a name="377129888"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377129888" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377129888">(Jul 20 2023 at 23:02)</a>:</h4>
<p>(if so, what's the difference between the lift and the lower applied to "log"? log is external? if it's in "CM space" already why does it need to be lowered too? just to attempt to fuse it with a lift?)</p>



<a name="377129950"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377129950" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377129950">(Jul 20 2023 at 23:03)</a>:</h4>
<p>s'ok, just  pointing it out if you're doing docs-updates at some point. I can file a bug on the repo if you want but I'm not sure this repo is the long-term home of reference material anyway?</p>



<a name="377130084"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377130084" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377130084">(Jul 20 2023 at 23:04)</a>:</h4>
<p>The one thing I might clarify is the "half-trampoline" aspect there. This is creating, as you say declaratively, a function in the component model which has type string -&gt; string. The implementation of this function is defined as the "half trampoline" you're thinking of where the function when called with a string will pass through the string as defined by the canonical ABI using the memory/realloc options. Similarly when the wasm function returns it will interpret the return values using the memory/realloc options. </p>
<p>This component model function, whether it actually concretely exists or not, sort of depends on the runtime. For example sometimes in Wasmtime it's "fused" with another component's request for the function that's where a whole-trampoline as you're thinking exists. If the host uses this function directly it's sort of a half-trampoline.</p>
<p>Basically I wanted to point out the half/whole trampoline may not be quite the right way to think about it. It sort of is and sort of isn't, but may be worthwhile understanding the context here of "it's a function in its own right" and the definition of what that function is depends on the host.</p>



<a name="377130157"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377130157" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377130157">(Jul 20 2023 at 23:05)</a>:</h4>
<blockquote>
<p>I'm not sure this repo is the long-term home of reference material anyway?</p>
</blockquote>
<p>Oh WebAssembly/component-model will probably stick around for quite a long time, so bugs are appreciated!</p>



<a name="377130409"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377130409" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377130409">(Jul 20 2023 at 23:07)</a>:</h4>
<p>the specifics of when half-trampolines exist or are fused-away is indeed something I need to get straight, glad you pointed it out. would it fuse, say, only when the canonopts match exactly, including their referents, so as to allow passing through not just an unaltered representation but crucially pointers in the same memory?</p>



<a name="377130471"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377130471" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377130471">(Jul 20 2023 at 23:07)</a>:</h4>
<p>Ah sorry I don't have the link to what you're looking at on hand (I can poke at it though to take a look), but in general you're right that there's the "CM space" and the "core space" and lift/lower go between these two. So you'll lift from core-&gt;CM and lower from CM-&gt;core. Component boundaries only support CM things, so if you want to take a core function from one component to another you'll have to lift it to the CM then lower it somewhere else. This produces the "fused" operation where a runtime can do clever things if it so desires, but the "clever things" aren't necessarily stricly spec-mandated.</p>
<p>This is where the Python bits-and-pieces of <code>CanonicalABI.md</code> show up where a lift-then-lower is sort of like a curry of the <code>canon_lift</code> and <code>canon_lower</code> functions. I think though you have to squint a bit to see it line up for sure at the current time.</p>



<a name="377130625"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377130625" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377130625">(Jul 20 2023 at 23:08)</a>:</h4>
<p>I'm looking at the example a page or two down from this anchor: <a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/Explainer.md#canonical-definitions">https://github.com/WebAssembly/component-model/blob/main/design/mvp/Explainer.md#canonical-definitions</a> -- search for "we can finally write a non-trivial component"</p>



<a name="377130673"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377130673" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377130673">(Jul 20 2023 at 23:09)</a>:</h4>
<blockquote>
<p>the specifics of when half-trampolines exist or are fused-away is indeed something I need to get straight, glad you pointed it out. would it fuse, say, only when the canonopts match exactly, including their referents, so as to allow passing through not just an unaltered representation but crucially pointers in the same memory?</p>
</blockquote>
<p>Ah specifically no! Fusing happens between entirely different components, which can't share any state. So their options fundamentally will be different (e.g. you're transferring a string from one linear memory to another). The way you can think about it is that component model values have an abstract definition of sorts, but the ABI makes it concrete on either end.</p>
<p>So for example if component A encodes strings as utf-8 but component B uses utf-16 they're both using the same concept of a "string" as a valid unicode thing (I forget the technical name) but they're represented differently. In this case the fused adapter, the lift/lower pair, would transcode from. utf-8 to utf-16 when transferring strings</p>



<a name="377130844"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377130844" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377130844">(Jul 20 2023 at 23:10)</a>:</h4>
<p>so a lift will sort of interpret all the input parameters/options/etc into an abstract set of values which may or may not get re-ified in the host itself (e.g. a simple interpreter might always create an actual <code>Val</code> representation), and then the lower translates from these abstract representations back into the destination as configured</p>



<a name="377130873"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377130873" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377130873">(Jul 20 2023 at 23:11)</a>:</h4>
<p>oh, wait, so in this case the fact that "log" and "run" are both declared to deal in the same memory "mem" is not nudging the system towards possibly fusing their lift/lower pair, because strings represented as i32,i32 pairs are literally pointing into the same memory space?</p>



<a name="377130878"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377130878" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377130878">(Jul 20 2023 at 23:11)</a>:</h4>
<p>however the host represents it is entirely up to the host, so long as it can faithfully represent all possible values</p>



<a name="377130904"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377130904" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377130904">(Jul 20 2023 at 23:11)</a>:</h4>
<p>let me look more closely at the example</p>



<a name="377130935"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377130935" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377130935">(Jul 20 2023 at 23:11)</a>:</h4>
<p>aha so there is no fusing at all in this example</p>



<a name="377130958"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377130958" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377130958">(Jul 20 2023 at 23:11)</a>:</h4>
<p>np. you also don't have to hang around here answering my questions! I know you're very busy</p>



<a name="377131025"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377131025" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377131025">(Jul 20 2023 at 23:12)</a>:</h4>
<p>The log function, a component model thing, is lowered down into a core wasm thing which goes into the "blob" of core wasm</p>



<a name="377131045"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377131045" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377131045">(Jul 20 2023 at 23:12)</a>:</h4>
<p>somehow coming out of that core wasm is a "run" function which is lifted into a separate CM thing</p>



<a name="377131053"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377131053" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377131053">(Jul 20 2023 at 23:12)</a>:</h4>
<p>log/run, however, aren't connected at all</p>



<a name="377131061"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377131061" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377131061">(Jul 20 2023 at 23:12)</a>:</h4>
<p>except well through the core wasm I suppose</p>



<a name="377131102"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377131102" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377131102">(Jul 20 2023 at 23:12)</a>:</h4>
<p>let me see if I can find a fusing example</p>



<a name="377131216"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377131216" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377131216">(Jul 20 2023 at 23:13)</a>:</h4>
<p>ah ok so here's a "hello world" of fusing -- <a href="https://github.com/bytecodealliance/wasmtime/blob/53274fefe433944964bafd3f2942a942c33bf6c1/tests/misc_testsuite/component-model/fused.wast#L2-L21">https://github.com/bytecodealliance/wasmtime/blob/53274fefe433944964bafd3f2942a942c33bf6c1/tests/misc_testsuite/component-model/fused.wast#L2-L21</a></p>



<a name="377131219"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377131219" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377131219">(Jul 20 2023 at 23:13)</a>:</h4>
<p>(I just was involved in building a wasmi-based system recently that had to roll its own ABI and everyone keeps showing up and asking "why didn't you use the wasm CM to link in definitions and allow inter-component magic?" and my answers are a bit wishy-washy somewhere between "the schedule doesn't seem to line up, it's not ready yet" and "I still actually have no idea how to adapt wasmi to support the CM, every time I try to understand that I get lost trying to understand the mechanisms implied by the CM" so I figured I might ask more about that...)</p>



<a name="377131316"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377131316" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377131316">(Jul 20 2023 at 23:14)</a>:</h4>
<p>no worries! Confusion is IMO a good way to shape how to word the docs when we get around to it :)</p>



<a name="377131404"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377131404" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377131404">(Jul 20 2023 at 23:15)</a>:</h4>
<p>but I mostly wanted to point out that everything related to adapter fusion of lift/lower pairs may have been misunderstood so far,  but it requires the same value to get lifted/lowered, not just lifts/lowers of separate values in a component</p>



<a name="377131433"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377131433" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377131433">(Jul 20 2023 at 23:15)</a>:</h4>
<p>and it also requires a component boundary, e.g. the sub-component in that example above</p>



<a name="377131442"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377131442" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377131442">(Jul 20 2023 at 23:15)</a>:</h4>
<p>(not sure if it helps to see this though)</p>



<a name="377131584"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377131584" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377131584">(Jul 20 2023 at 23:16)</a>:</h4>
<p>looking. I think I still don't quite get what a lower _is_ besides meaninglessly "the inverse of a lift". like it's declaring a CM type maps to a given core type, but .. it's a bijection right? .. can that not be _exactly_ rewritten as a lift? why give it a separate form?</p>



<a name="377131702"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377131702" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377131702">(Jul 20 2023 at 23:18)</a>:</h4>
<p>(and like what entities-with-CM-types even exist that are not, themselves, lifts of core entities? when do you have such a CM entity you need to lower, independent of a core entity you need to lift?)</p>



<a name="377131795"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377131795" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377131795">(Jul 20 2023 at 23:18)</a>:</h4>
<p>To answer the second question first which may provide more context, the biggest answer is "host things"</p>



<a name="377131808"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377131808" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377131808">(Jul 20 2023 at 23:18)</a>:</h4>
<p>aka the host has a function that returns a string and wasm wants to use it</p>



<a name="377131835"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377131835" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377131835">(Jul 20 2023 at 23:19)</a>:</h4>
<p>but the host function basically doesn't know it's being called by wasm</p>



<a name="377131896"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377131896" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377131896">(Jul 20 2023 at 23:19)</a>:</h4>
<p>lift/lower are different halves of the operation which is what makes them necessary -- perhaps it may be helpful to ignore sub-components and fusion for now?</p>



<a name="377131962"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377131962" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377131962">(Jul 20 2023 at 23:20)</a>:</h4>
<p>e.g. you get "host stuff" and you lower it, and to give functionality to the host you lift it</p>



<a name="377131991"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377131991" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377131991">(Jul 20 2023 at 23:20)</a>:</h4>
<p>ok. that's a good starting schema!</p>



<a name="377132000"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377132000" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377132000">(Jul 20 2023 at 23:20)</a>:</h4>
<p>but you can't swap those since the host stuff isn't a lift of anything, it just is host stuff</p>



<a name="377132080"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377132080" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377132080">(Jul 20 2023 at 23:21)</a>:</h4>
<p>they we just throw in separate memories and an Owens-Flatt unit linking language :P</p>



<a name="377132216"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377132216" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377132216">(Jul 20 2023 at 23:22)</a>:</h4>
<p>heh yeah it's true that much of the interesting stuff doesn't come up until there's more than one component in the system, but some of the bits and pieces I've found are more helpfully motivated if they're ignored when first learning</p>



<a name="377132219"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377132219" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377132219">(Jul 20 2023 at 23:22)</a>:</h4>
<p>hmm .. ok but the "lower" of a host function is .. uh .. in core-space?</p>



<a name="377132260"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377132260" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377132260">(Jul 20 2023 at 23:23)</a>:</h4>
<p>so the runtime has to do the lower-side just to call the host function, because it's some wild win32 or cocoa API speaking UTF-16</p>



<a name="377132277"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377132277" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377132277">(Jul 20 2023 at 23:23)</a>:</h4>
<p>this is where the runtime sort of has a lot of flexibility</p>



<a name="377132295"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377132295" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377132295">(Jul 20 2023 at 23:23)</a>:</h4>
<p>somehow it needs to produce a "core looking thing", and how to interpret the arguments to the core-looking-thing are dicated by the canonical ABI</p>



<a name="377132304"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377132304" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377132304">(Jul 20 2023 at 23:23)</a>:</h4>
<p>and then what the host does with that is up to it</p>



<a name="377132318"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377132318" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377132318">(Jul 20 2023 at 23:24)</a>:</h4>
<p>but yeah if it receives a utf-8 string and talks to a cocoa utf-16 api then the host has to transcode</p>



<a name="377132389"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377132389" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377132389">(Jul 20 2023 at 23:24)</a>:</h4>
<p>here the host has the choice of representing strings as (encoding, wasm bytes) or it could unconditionally translate everything to a utf-16 string and run with that</p>



<a name="377132456"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377132456" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377132456">(Jul 20 2023 at 23:25)</a>:</h4>
<p>if you've got some cocoa thing though and wasm wants to call it, the goop between wasm and cocoa is basically "the thing that <code>lower</code> produces"</p>



<a name="377132483"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377132483" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377132483">(Jul 20 2023 at 23:25)</a>:</h4>
<p>it's tough to point at it and say "yes it's this" since it's probably spread out a bit as it's doing type translation, crossing core wasm ABIs, etc</p>



<a name="377132495"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377132495" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Graydon Hoare <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377132495">(Jul 20 2023 at 23:25)</a>:</h4>
<p>mhm. ok, informative! it still seems to me like that lift and lower are both just "CM-to-core bijections" where sometimes the bijectee is in host-world not VM-world, but .. meh .. doesn't matter!</p>
<p>I actually have to step out for a bit, but .. uh .. it's coming more into focus, and if it's ok with you I would love to return to this and pepper you with more questions another time?</p>



<a name="377132515"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377132515" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377132515">(Jul 20 2023 at 23:25)</a>:</h4>
<p>In wasmtime for example it's a mixture of Rust-monomorphized code plus a Cranelift-generated trampoline</p>



<a name="377132581"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/adding%20component%20model%20support%20to%20wasmi/near/377132581" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/adding.20component.20model.20support.20to.20wasmi.html#377132581">(Jul 20 2023 at 23:26)</a>:</h4>
<p>Happy to help out!</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>