<html>
<head><meta charset="utf-8"><title>wasi_snapshot_preview1 imports in wasi export · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/index.html">general</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html">wasi_snapshot_preview1 imports in wasi export</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="308790909"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308790909" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ari Seyhun <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308790909">(Nov 09 2022 at 13:51)</a>:</h4>
<p>I've written a basic rust lib with an exported function, and compiled it to wasm32-wasi with crate-type set to <code>cdylib</code>.<br>
And from another Rust crate, I'm trying to load this wasm module with wasmtime, and instantiate the exported function, though it gives an error "expected 4 imports, found 0".</p>
<p>When I inspect the wasm file to wat, I see that there are 4 imports defined:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="p">(</span><span class="n">import</span><span class="w"> </span><span class="s">"wasi_snapshot_preview1"</span><span class="w"> </span><span class="s">"fd_write"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$wasi_snapshot_preview1</span><span class="p">.</span><span class="n">fd_write</span><span class="w"> </span><span class="p">(</span><span class="k">type</span> <span class="cp">$t6</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">import</span><span class="w"> </span><span class="s">"wasi_snapshot_preview1"</span><span class="w"> </span><span class="s">"environ_get"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$wasi_snapshot_preview1</span><span class="p">.</span><span class="n">environ_get</span><span class="w"> </span><span class="p">(</span><span class="k">type</span> <span class="cp">$t5</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">import</span><span class="w"> </span><span class="s">"wasi_snapshot_preview1"</span><span class="w"> </span><span class="s">"environ_sizes_get"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$wasi_snapshot_preview1</span><span class="p">.</span><span class="n">environ_sizes_get</span><span class="w"> </span><span class="p">(</span><span class="k">type</span> <span class="cp">$t5</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">import</span><span class="w"> </span><span class="s">"wasi_snapshot_preview1"</span><span class="w"> </span><span class="s">"proc_exit"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$wasi_snapshot_preview1</span><span class="p">.</span><span class="n">proc_exit</span><span class="w"> </span><span class="p">(</span><span class="k">type</span> <span class="cp">$t0</span><span class="p">)))</span><span class="w"></span>
</code></pre></div>
<p>I understand that I could define these functions and provide them as imports when instantiating the module, but I'm wondering if wasmtime provides any default imports for these common functions so I don't have to figure out the code for fd_write, environ_get, etc.?</p>



<a name="308796024"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308796024" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ari Seyhun <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308796024">(Nov 09 2022 at 14:17)</a>:</h4>
<p>Oh I just came across the wasi crate.<br>
Though, is there any examples on integrating this with wasmtime?</p>



<a name="308799578"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308799578" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ari Seyhun <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308799578">(Nov 09 2022 at 14:33)</a>:</h4>
<p>I'm almost there.<br>
I've found the <code>wasmtime_wasi::add_to_linker</code>, but I'm just trying to figure out how to make the <code>WasiCtx::new</code>. All I've managed to create is the Rng with <code>Box::new(OsRng)</code>.</p>



<a name="308799783"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308799783" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308799783">(Nov 09 2022 at 14:34)</a>:</h4>
<p>e.g. <code>WasiCtxBuilder::new().arg("&lt;wasm module&gt;")?.build()</code></p>



<a name="308800028"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308800028" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308800028">(Nov 09 2022 at 14:35)</a>:</h4>
<p>See <a href="https://docs.rs/wasmtime-wasi/2.0.1/wasmtime_wasi/sync/struct.WasiCtxBuilder.html">https://docs.rs/wasmtime-wasi/2.0.1/wasmtime_wasi/sync/struct.WasiCtxBuilder.html</a> for full docs.</p>



<a name="308800049"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308800049" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ari Seyhun <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308800049">(Nov 09 2022 at 14:35)</a>:</h4>
<p>Ohh, I didnt see that!<br>
What is <code>.arg("&lt;wasm module&gt;")</code> for examle? Is it needed?</p>



<a name="308800259"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308800259" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308800259">(Nov 09 2022 at 14:36)</a>:</h4>
<p>I just pasted that from some code I wrote a while ago.  Probably not needed unless your module expects at least one argv value.</p>



<a name="308800368"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308800368" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308800368">(Nov 09 2022 at 14:36)</a>:</h4>
<p>Doesn't look like yours uses WASI arguments at all, so not relevant.</p>



<a name="308803214"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308803214" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ari Seyhun <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308803214">(Nov 09 2022 at 14:49)</a>:</h4>
<p>This should probably be another topic post, but I'll just ask here.</p>
<p>I'm trying to define a function in my Rust wasm lib which will eventually be Vec&lt;u8&gt;, but since its wasm, I'm taking in offset and length:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">offset</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">len</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{id_offset} {id_len}"</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>And from my wasmtime, I have written to the memory some random bytes:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span><span class="p">.</span><span class="n">get_memory</span><span class="p">(</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"memory"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="n">memory</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">])</span><span class="o">?</span><span class="p">;</span><span class="w"> </span><span class="c1">// write 0, 1, 2</span>

<span class="kd">let</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span><span class="p">.</span><span class="n">get_typed_func</span>::<span class="o">&lt;</span><span class="p">(</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">),</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">_</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"new"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="n">new</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">))</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>But now my question is, how do I actually read this memory from my new fn? I can print the offset and length correctly, but I don't know how to read my own wasm memory from the Rust file which is compiled.</p>



<a name="308804446"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308804446" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308804446">(Nov 09 2022 at 14:55)</a>:</h4>
<p>I think you'll need to cast <code>offset</code> to a <code>const u8*</code> and then use e.g. <code>https://doc.rust-lang.org/std/slice/fn.from_raw_parts.html</code> to produce a <code>&amp;[u8]</code>.</p>



<a name="308804774"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308804774" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308804774">(Nov 09 2022 at 14:56)</a>:</h4>
<p>I'd be pretty nervous about writing to guest memory like that without involving the guest allocator, though.</p>



<a name="308805261"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308805261" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ari Seyhun <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308805261">(Nov 09 2022 at 14:58)</a>:</h4>
<p>Ohh, so this approach isn't really correct? I should be using some kind of allocator?<br>
I saw in the docs for wasmtime memory, the only option really is <code>.write()</code></p>



<a name="308805710"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308805710" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308805710">(Nov 09 2022 at 15:00)</a>:</h4>
<p>The usual approach is to export some equivalent of <code>malloc</code> from the guest which the host can use to allocate a destination for writes</p>



<a name="308805907"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308805907" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ari Seyhun <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308805907">(Nov 09 2022 at 15:01)</a>:</h4>
<p>Ah okay, I've just come across this:<br>
&lt;<a href="https://radu-matei.com/blog/practical-guide-to-wasm-memory/">https://radu-matei.com/blog/practical-guide-to-wasm-memory/</a>&gt;</p>
<p>I thought Rust would already export something like this for you, but I guess not</p>
<div class="message_embed"><a class="message_embed_image" href="https://radu-matei.com/blog/practical-guide-to-wasm-memory/" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/98f3a46af15d1cbb6300c1db78743909925ad753\/68747470733a2f2f7777772e67726176617461722e636f6d2f6176617461722f37623335636331653739613462353635313739313938383461396561363066323f733d323536)"></a><div class="data-container"><div class="message_embed_title"><a href="https://radu-matei.com/blog/practical-guide-to-wasm-memory/" title="A practical guide to WebAssembly memory - radu's blog">A practical guide to WebAssembly memory - radu's blog</a></div><div class="message_embed_description">Memory in WebAssembly is one of the topics that creates confusion for newcomers, particularly for those with experience in languages with memory management features like garbage collection, such as JavaScript, Go, or Java. In this article we explore using memory in WebAssembly in various scenarios - passing JavaScript arrays to Rust and AssemblyScript modules, checking for some basic memory leaks using Valgrind, or exchanging strings between runtimes and modules using Wasmtime.</div></div></div>



<a name="308806029"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308806029" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308806029">(Nov 09 2022 at 15:02)</a>:</h4>
<p>Depending on your specific situation you could possibly export some other kind of pointer from the guest like a statically allocated buffer, but then you take responsibility for managing that</p>



<a name="308809464"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308809464" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ari Seyhun <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308809464">(Nov 09 2022 at 15:19)</a>:</h4>
<p>Hmm, when I define my function to take a Rust type, such as String:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">value</span>: <span class="nb">String</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>It produces this wat code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$new</span><span class="w"> </span><span class="p">(</span><span class="k">type</span> <span class="cp">$t0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="cp">$p0</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>Is there anywhere I can read up on what this param is? Is it just a pointer to the string?</p>



<a name="308812427"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308812427" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308812427">(Nov 09 2022 at 15:33)</a>:</h4>
<p>The rust abi is unstable. If you want to export a function from the wasm module you will have to use <code>#[no_mangle] extern "C" fn new</code>. You also can't use <code>String</code> as it has an unstable layout. Using <a href="https://github.com/bytecodealliance/wit-bindgen/">wit-bindgen</a> is probably the easiest way for exporting an interface from wasm that uses non-primitive types like strings.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/401a858b8685cc69f63b2fb42d1658c4a101d43c\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f353139346266643662626366346261613965656439626262636664613735386366366532393638613962396561383832366162623336303230393139633438372f62797465636f6465616c6c69616e63652f7769742d62696e6467656e)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/" title="GitHub - bytecodealliance/wit-bindgen: A language binding generator for WebAssembly interface types">GitHub - bytecodealliance/wit-bindgen: A language binding generator for WebAssembly interface types</a></div><div class="message_embed_description">A language binding generator for WebAssembly interface types - GitHub - bytecodealliance/wit-bindgen: A language binding generator for WebAssembly interface types</div></div></div>



<a name="308813140"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308813140" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ari Seyhun <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308813140">(Nov 09 2022 at 15:36)</a>:</h4>
<p>Thanks! I'm looking into <code>&amp;str</code> now since it's just a pointer and a length.<br>
When invoking the function, I'm sending:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">128</span><span class="p">;</span><span class="w"> </span><span class="c1">// arbitrary</span>
<span class="n">memory</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="s">b"hey"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memory</span><span class="p">.</span><span class="n">data_ptr</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span><span class="p">.</span><span class="n">get_typed_func</span>::<span class="o">&lt;</span><span class="p">(</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">),</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">_</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"new"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="n">new</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">))</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>But I get an error of out of bounds memory access. </p>
<p>Is <code>memory.data_ptr()</code> the right method to get the start address of the memory?</p>



<a name="308814728"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308814728" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308814728">(Nov 09 2022 at 15:44)</a>:</h4>
<p>The guest code sees its own linear memory starting at zero</p>



<a name="308814759"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308814759" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308814759">(Nov 09 2022 at 15:44)</a>:</h4>
<p>From the guest's point of view, memory starts at zero, so <code>base</code> should be 128.  Note that since you didn't ask the guest to allocate memory you're using, you're clobbering whatever was already at that address, with unpredictable consequences.</p>



<a name="308815165"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308815165" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ari Seyhun <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308815165">(Nov 09 2022 at 15:46)</a>:</h4>
<p>I see, though I'm only calling an exported function which should have no side effects. So I'd assume the memory would be compleltely empty the first time I invoke any function <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="308815371"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308815371" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ari Seyhun <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308815371">(Nov 09 2022 at 15:47)</a>:</h4>
<p>Oh I actually got it working!</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8_</span><span class="k">i32</span><span class="p">.</span><span class="n">to_le_bytes</span><span class="p">().</span><span class="n">to_vec</span><span class="p">();</span><span class="w"></span>
<span class="n">data</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="mi">3_</span><span class="k">i32</span><span class="p">.</span><span class="n">to_le_bytes</span><span class="p">());</span><span class="w"></span>
<span class="n">data</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="s">b"Hey"</span><span class="p">);</span><span class="w"></span>
<span class="n">memory</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">data</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span><span class="p">.</span><span class="n">get_typed_func</span>::<span class="o">&lt;</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">_</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"new"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="n">new</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
</code></pre></div>



<a name="308815710"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308815710" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308815710">(Nov 09 2022 at 15:48)</a>:</h4>
<blockquote>
<p>I'd assume the memory would be compleltely empty the first time I invoke any function</p>
</blockquote>
<p>Depends on the source language/runtime. Almost all languages will stick <em>something somewhere</em> on startup, at least in some contexts</p>



<a name="308816035"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308816035" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ari Seyhun <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308816035">(Nov 09 2022 at 15:50)</a>:</h4>
<p>Since:</p>
<ul>
<li>I know exactly what functions are exported, and their types.</li>
<li>The wasm will always come from Rust (for now).<br>
I think it's worth doing this approach for the sake of avoiding having to export an allocator, and writing glue code</li>
</ul>



<a name="308816235"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308816235" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ari Seyhun <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308816235">(Nov 09 2022 at 15:51)</a>:</h4>
<p>Though, I realise Rust didn't compile for that &amp;str to be there, so when I write new memory, it could overwrite the memory of the string I guess...</p>



<a name="308816373"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308816373" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308816373">(Nov 09 2022 at 15:52)</a>:</h4>
<p>Also note that even a Rust function with no side effects and no explicit allocations may use the "shadow" stack, which lives on the heap, so you may find that whatever you write to memory gets clobbered once the function is run.</p>



<a name="308816604"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308816604" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308816604">(Nov 09 2022 at 15:53)</a>:</h4>
<p>And statically allocated data goes in the linear memory too. You really don't want to do it that way.</p>



<a name="308816913"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308816913" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308816913">(Nov 09 2022 at 15:54)</a>:</h4>
<p>It is possible to write a Rust guest that never touches memory, but it's surprisingly difficult and limiting.</p>



<a name="308817313"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308817313" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ari Seyhun <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308817313">(Nov 09 2022 at 15:57)</a>:</h4>
<p>My guest will always export only these 3 basic functions:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">name</span>: <span class="nb">String</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">apply</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">state</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">event</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">handle</span><span class="p">(</span><span class="n">state</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">command</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>What if I export some static buffers for this instead of the parameters?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">PARAM_1</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">128</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="mi">128</span><span class="p">];</span><span class="w"></span>
</code></pre></div>
<p>Would something like this work fine?</p>



<a name="308818598"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308818598" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308818598">(Nov 09 2022 at 16:03)</a>:</h4>
<p>It should. You'll have to beware buffer overflows</p>



<a name="308818801"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308818801" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ari Seyhun <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308818801">(Nov 09 2022 at 16:04)</a>:</h4>
<p>Sounds like a nice solution then!<br>
I can make some macros <code>#[new]</code>, <code>#[apply]</code>, and <code>#[handle]</code> which declare these statics and transform the bytes into the correct types.</p>



<a name="308818849"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308818849" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ramon Klass <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308818849">(Nov 09 2022 at 16:04)</a>:</h4>
<p>still it would be strongly suggested to write those 3 functions with wit files, it will continue to work if the standard evolves</p>



<a name="308822080"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308822080" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ari Seyhun <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308822080">(Nov 09 2022 at 16:21)</a>:</h4>
<p>I realised this gets complicated if I want to take a parameter of <code>state: Vec&lt;u8&gt;</code>, since state could become arbitrarily large.</p>



<a name="308916581"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308916581" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ari Seyhun <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308916581">(Nov 10 2022 at 04:14)</a>:</h4>
<p>I'm trying to use wit-bindgen to compile a gust module from Rust, and run it in a host with wasmtime.</p>
<p>My guest code uses:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">wit_bindgen_guest_rust</span>::<span class="n">generate</span><span class="o">!</span><span class="p">({</span><span class="w"></span>
<span class="w">    </span><span class="n">name</span>: <span class="s">"module"</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">export</span>: <span class="s">"module.wit"</span><span class="p">,</span><span class="w"></span>
<span class="p">});</span><span class="w"></span>

<span class="n">export_module</span><span class="o">!</span><span class="p">(</span><span class="n">MyModule</span><span class="p">);</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">MyModule</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">module</span>::<span class="n">Module</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyModule</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>And I compile it to wasm32-wasi.</p>
<p>Then on the host side, I'm trying to use:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">wit_bindgen_host_wasmtime_rust</span>::<span class="n">generate</span><span class="o">!</span><span class="p">({</span><span class="w"></span>
<span class="w">    </span><span class="n">name</span>: <span class="s">"module"</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">import</span>: <span class="s">"module.wit"</span><span class="p">,</span><span class="w"></span>
<span class="p">});</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">ModuleHandler</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">module</span>::<span class="n">Module</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">ModuleHandler</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span>::<span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="n">module</span>::<span class="n">add_to_linker</span>::<span class="o">&lt;</span><span class="n">Data</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">cx</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">cx</span><span class="p">.</span><span class="n">module_handler</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="cm">/* ... */</span><span class="w"></span>
</code></pre></div>
<p>Though my first problem came when it was complaining that my linker is from <code>wasmtime::Linker</code>, and it wanted <code>wasmtime::component::Linker</code>.</p>
<p>So I changed my items to use exports from <code>wasmtime::component::{...}</code>, but when running my code I get the error:</p>
<blockquote>
<p>Error: failed to parse WebAssembly module</p>
<p>Caused by:<br>
    attempted to parse a wasm module with a component parser</p>
</blockquote>



<a name="308917518"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308917518" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ari Seyhun <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308917518">(Nov 10 2022 at 04:25)</a>:</h4>
<p>I'm quite confused why I'd need to implement a trait when I'm importing too. I would expect it would be something just like <code>module::new(&amp;instance, "param".to_string());</code></p>



<a name="308918565"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308918565" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ari Seyhun <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308918565">(Nov 10 2022 at 04:41)</a>:</h4>
<p>Do I need to compile my guest rust to wasm in a different way to make it a "component"?<br>
Any help would be appreciated, I cant figure this out at all</p>



<a name="308919893"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308919893" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ari Seyhun <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308919893">(Nov 10 2022 at 05:00)</a>:</h4>
<p>Okay I've discovered the wit-component cli. But when trying to use it to convert my wasm file, I get this error:</p>
<blockquote>
<p>module requires an import interface named <code>wasi_snapshot_preview1</code></p>
</blockquote>



<a name="308920669"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308920669" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ari Seyhun <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308920669">(Nov 10 2022 at 05:09)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="err">❯</span><span class="w"> </span><span class="n">wit</span><span class="o">-</span><span class="n">component</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">counter</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">--</span><span class="n">adapt</span><span class="w"> </span><span class="o">../../../../</span><span class="n">bytecodealliance</span><span class="o">/</span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">wasi_snapshot_preview1</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">10</span><span class="n">T05</span>:<span class="mi">09</span>:<span class="mi">10</span><span class="n">Z</span><span class="w"> </span><span class="n">ERROR</span><span class="p">]</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">encode</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="err">`</span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">counter</span><span class="p">.</span><span class="n">wasm</span><span class="err">`</span><span class="w"></span>

<span class="w">    </span><span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
        <span class="mi">0</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">reduce</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="n">adapter</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="n">minimal</span><span class="w"> </span><span class="n">size</span><span class="w"></span>
<span class="w">        </span><span class="mi">1</span>: <span class="nc">locally</span><span class="o">-</span><span class="n">defined</span><span class="w"> </span><span class="n">memories</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">allowed</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="n">memory</span><span class="w"></span>
</code></pre></div>



<a name="308923324"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308923324" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ari Seyhun <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308923324">(Nov 10 2022 at 05:38)</a>:</h4>
<p>I got it working by compiling things with rustflags. Though now I'm trying to figure out why it says:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Error</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">parse</span><span class="w"> </span><span class="n">WebAssembly</span><span class="w"> </span><span class="n">module</span><span class="w"></span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="nc">WebAssembly</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="n">feature</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">enabled</span><span class="w"></span>
</code></pre></div>



<a name="308926684"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasi_snapshot_preview1%20imports%20in%20wasi%20export/near/308926684" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ari Seyhun <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasi_snapshot_preview1.20imports.20in.20wasi.20export.html#308926684">(Nov 10 2022 at 06:20)</a>:</h4>
<p>I got it all working in the end :)</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>