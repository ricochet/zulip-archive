<html>
<head><meta charset="utf-8"><title>wit-bindgen - rules for deallocating lists? · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/index.html">general</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html">wit-bindgen - rules for deallocating lists?</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="265623566"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265623566" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Vetere <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265623566">(Dec 20 2021 at 22:30)</a>:</h4>
<p>Hi!  I’m hoping to understand a little bit about the design choices around memory deallocation in the bindings that <em>wit-bindgen</em> creates.</p>
<p>For background, I’m working on a WASM UDF implementation for a database.  To enable this, I’ve implemented host-side support for the Canonical ABI in C++.  The idea is that the user supplies the WIT and WASM files in their <code>CREATE</code> statement, and the database then knows how to communicate with the exports contained therein.</p>
<p>In general, it all works as expected, except when passing lists through the ABI.  When the user wants to call a WASM UDF that accepts a list, I use the <code>canonical_abi_realloc</code> export to allocate some of the module’s linear memory to hold the list contents, and store the pointer in the appropriate location expected by the ABI.  The WASM code is able to receive the array correctly, but it looks like (sometimes) that the act of passing this memory through the ABI may cause it to be deallocated before it returns back.</p>
<p>Looking at the wit-bindgen code <a href="https://github.com/bytecodealliance/wit-bindgen/blob/24c102fe374b4c5698cfd4b7980f70ac2cf228fe/crates/parser/src/abi.rs#L1981">here</a>, I see that there are rules that govern whether or not incoming lists are deallocated.  It looks like the decision differs for each binding implementation.  In my case (<em>gen-rust-wasm</em>), the decision lies with <a href="https://github.com/bytecodealliance/wit-bindgen/blob/24c102fe374b4c5698cfd4b7980f70ac2cf228fe/crates/gen-rust-wasm/src/lib.rs#L937"><code>is_list_canonical</code></a>, which uses <a href="https://github.com/bytecodealliance/wit-bindgen/blob/24c102fe374b4c5698cfd4b7980f70ac2cf228fe/crates/parser/src/lib.rs#L440"><code>all_bits_valid</code></a> to make the determination.  Ultimately, it looks like it depends on the list’s element type.</p>
<p>In my host code, I need to know whether I should free the memory after the call has been made.  I can certainly code to these specific rules, but it seems awkward – and I don’t know whether the WASM module’s ABI was generated for a language that never deallocates (C, for example).  Is there some way that I can guarantee that the memory I allocate prior to the function call remains allocated when the call exits (barring any uncontrollable action taken by the WASM code itself)?</p>
<p>Thanks!<br>
Pete</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/blob/24c102fe374b4c5698cfd4b7980f70ac2cf228fe/crates/parser/src/abi.rs#L1981" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/75b6ea29fb35dcf6d93c75a80a1daff361f41346\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f313839626365376564643134393530313164623064383434393137386333386638316539633838373965353430353133626464356634343134376134363133342f62797465636f6465616c6c69616e63652f7769742d62696e6467656e)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/blob/24c102fe374b4c5698cfd4b7980f70ac2cf228fe/crates/parser/src/abi.rs#L1981" title="wit-bindgen/abi.rs at 24c102fe374b4c5698cfd4b7980f70ac2cf228fe · bytecodealliance/wit-bindgen">wit-bindgen/abi.rs at 24c102fe374b4c5698cfd4b7980f70ac2cf228fe · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">A language binding generator for WebAssembly interface types - wit-bindgen/abi.rs at 24c102fe374b4c5698cfd4b7980f70ac2cf228fe · bytecodealliance/wit-bindgen</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/blob/24c102fe374b4c5698cfd4b7980f70ac2cf228fe/crates/gen-rust-wasm/src/lib.rs#L937" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/75b6ea29fb35dcf6d93c75a80a1daff361f41346\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f313839626365376564643134393530313164623064383434393137386333386638316539633838373965353430353133626464356634343134376134363133342f62797465636f6465616c6c69616e63652f7769742d62696e6467656e)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/blob/24c102fe374b4c5698cfd4b7980f70ac2cf228fe/crates/gen-rust-wasm/src/lib.rs#L937" title="wit-bindgen/lib.rs at 24c102fe374b4c5698cfd4b7980f70ac2cf228fe · bytecodealliance/wit-bindgen">wit-bindgen/lib.rs at 24c102fe374b4c5698cfd4b7980f70ac2cf228fe · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">A language binding generator for WebAssembly interface types - wit-bindgen/lib.rs at 24c102fe374b4c5698cfd4b7980f70ac2cf228fe · bytecodealliance/wit-bindgen</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/blob/24c102fe374b4c5698cfd4b7980f70ac2cf228fe/crates/parser/src/lib.rs#L440" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/75b6ea29fb35dcf6d93c75a80a1daff361f41346\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f313839626365376564643134393530313164623064383434393137386333386638316539633838373965353430353133626464356634343134376134363133342f62797465636f6465616c6c69616e63652f7769742d62696e6467656e)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/blob/24c102fe374b4c5698cfd4b7980f70ac2cf228fe/crates/parser/src/lib.rs#L440" title="wit-bindgen/lib.rs at 24c102fe374b4c5698cfd4b7980f70ac2cf228fe · bytecodealliance/wit-bindgen">wit-bindgen/lib.rs at 24c102fe374b4c5698cfd4b7980f70ac2cf228fe · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">A language binding generator for WebAssembly interface types - wit-bindgen/lib.rs at 24c102fe374b4c5698cfd4b7980f70ac2cf228fe · bytecodealliance/wit-bindgen</div></div></div>



<a name="265624595"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265624595" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265624595">(Dec 20 2021 at 22:43)</a>:</h4>
<p>Hm <span class="user-mention" data-user-id="465662">@Peter Vetere</span> ownership shouldn't depend on the type of the list being sent, it should always be uniform. This may indicate a bug? Can you share the <code>*.wit</code> file that you're using?</p>



<a name="265629539"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265629539" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Vetere <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265629539">(Dec 20 2021 at 23:44)</a>:</h4>
<p>Hi Alex.  I've attached two wit files, and the .rs bindings generated from them.  The command I used was like this:</p>
<p><code>wit-bindgen rust-wasm --export ./dealloc-list.wit</code></p>
<p>In particular, notice how, in <em>dealloc-list.rs</em>, a <code>dealloc</code> call is added to the <code>test</code> export that frees the memory pointed to by the first argument.  I believe this is because the list contains a record with a string type, which fails the <code>all_bits_valid</code> check.  Conversely, there is no <code>dealloc</code> generated in <em>no-dealloc-list.rs</em>, even though a list is also at play.  In this case, however, the list contains a record with only i32 fields.</p>
<p><a href="/user_uploads/15107/2FFG2vyS0E7fhkeF8SDsK9KF/dealloc-list.rs">dealloc-list.rs</a> <br>
<a href="/user_uploads/15107/nvG_7zz5dJ1Fx_YCOBFu_1nH/dealloc-list.wit">dealloc-list.wit</a><br>
<a href="/user_uploads/15107/U2dk_Kzy8VDFJV6hAW4RuUyd/no-dealloc-list.rs">no-dealloc-list.rs</a><br>
<a href="/user_uploads/15107/BiUCyB3bZ3V4CppDAEjg-mZj/no-dealloc-list.wit">no-dealloc-list.wit</a></p>



<a name="265629783"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265629783" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265629783">(Dec 20 2021 at 23:47)</a>:</h4>
<p>What a good idea.  Which database is it?</p>



<a name="265630547"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265630547" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265630547">(Dec 20 2021 at 23:59)</a>:</h4>
<p><span class="user-mention" data-user-id="465662">@Peter Vetere</span> cool thanks! sorry ran out of time today but I'll poke at this tomorrow</p>



<a name="265630909"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265630909" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pete Vetere <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265630909">(Dec 21 2021 at 00:03)</a>:</h4>
<p><span class="user-mention" data-user-id="395878">@Scott Waye</span> The company I work for is called SingleStore.  We’re adding WASM support to the database engine.  I agree — it’s a neat idea!</p>



<a name="265697119"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265697119" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265697119">(Dec 21 2021 at 15:24)</a>:</h4>
<p><span class="user-mention" data-user-id="440835">@Pete Vetere</span> oh the behavior you're seeing here is the API in Rust itself, it's not actually affecting the canonical abi itself</p>



<a name="265697148"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265697148" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265697148">(Dec 21 2021 at 15:24)</a>:</h4>
<p>the API in Rust is generated differently depending on the types, but the canonical abi has one notion of ownership</p>



<a name="265700629"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265700629" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Vetere <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265700629">(Dec 21 2021 at 15:53)</a>:</h4>
<p>Thanks for taking a look.  It sounds I was conflating the ABI with the API a bit -- sorry about that.  However, the rules for generating the API code this way are still a bit confusing to me.  I'd ideally like to tell the user "build your WASM module using the bindings that wit-bindgen creates and we'll be able to consume it as a UDF."  </p>
<p>With the current approach, I'm not sure how to tell whether lists that I pass into a WASM function will be deallocated by the generated binding code.  For example, the "rust-wasm" generator seems like it will deallocate incoming lists automatically if the elements are of certain types, whereas the generated C bindings look like they will never attempt to dealloc the incoming memory.  Am I misunderstanding, or approaching this from the wrong angle?</p>



<a name="265701260"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265701260" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265701260">(Dec 21 2021 at 15:58)</a>:</h4>
<p>From a wasm-boundary perspective the asnwer is always fixed</p>



<a name="265701302"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265701302" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265701302">(Dec 21 2021 at 15:58)</a>:</h4>
<p>from an API-of-the-language-bindings it's variable based on the type, due to how the natural representation of the type in the language differs from the canonical ABI</p>



<a name="265701344"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265701344" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265701344">(Dec 21 2021 at 15:58)</a>:</h4>
<p>but as an interface between the db and the wasm module there is a fixed answer of "lists always allocated"  or not, depending on whether the wasm is exporting a function or importing a function</p>



<a name="265701355"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265701355" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265701355">(Dec 21 2021 at 15:58)</a>:</h4>
<p>allocation is irrespective of the type of the list</p>



<a name="265721614"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265721614" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bailey Hayes <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265721614">(Dec 21 2021 at 18:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="395878">Scott Waye</span> <a href="#narrow/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F/near/265629783">said</a>:</p>
<blockquote>
<p>What a good idea.  Which database is it?</p>
</blockquote>
<p>(shameless plug <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> ) Checkout our Wasm day talk: <a href="https://www.youtube.com/watch?v=TqZsbrvhD54&amp;t=1294s">YouTube - Distributed Computation with WASM and WASI - Bailey Hayes &amp; Carl Sverre, SingleStore</a></p>
<div class="youtube-video message_inline_image"><a data-id="TqZsbrvhD54" href="https://www.youtube.com/watch?v=TqZsbrvhD54&amp;t=1294s"><img src="https://uploads.zulipusercontent.net/040e5645e2e228fb3ba8624c8736c8a5984ce0ca/68747470733a2f2f692e7974696d672e636f6d2f76692f54715a73627276684435342f64656661756c742e6a7067"></a></div>



<a name="265723697"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265723697" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bailey Hayes <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265723697">(Dec 21 2021 at 19:14)</a>:</h4>
<p>This seems like a bug in the bindings generated for c vs rust. From what <span class="user-mention" data-user-id="465662">@Peter Vetere</span> is seeing, wasm modules created with the canonical ABI behave differently across the wasm module boundary depending on if it was generated with rust or c.</p>
<p>Wasm modules created from rust (with wit-bindgen) deallocs a string list. If the host attempts to free the list, it will receive an exception.<br>
c wasm modules do not dealloc a string list. The host must free this list or there is a leak. The host shouldn't need to know how a wasm module was created only match the canonical ABI.</p>



<a name="265724544"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265724544" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265724544">(Dec 21 2021 at 19:23)</a>:</h4>
<p>The Rust/C APIs generated are indeed different, but that's because the native type representations are different (in C everything matches the canonical ABI). For Rust when an allocation is performed in the generated code it should also be deallocated in the generated code (or in C the API given expects everything to be allocated)</p>



<a name="265724597"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265724597" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265724597">(Dec 21 2021 at 19:23)</a>:</h4>
<p>In the wit gisted here so far I don't think there's a bug but I can try to answer more specific questions about specific code if that would help</p>



<a name="265725515"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265725515" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bailey Hayes <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265725515">(Dec 21 2021 at 19:32)</a>:</h4>
<p>This might not be clear, the issue is with API's that are generated and compiled into the wasm module and not the ones generated for the host. So if we're sent a random wasm module and wit file, we don't know when to dealloc because we need to know whether the original program was written in rust or C.</p>



<a name="265726174"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265726174" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265726174">(Dec 21 2021 at 19:38)</a>:</h4>
<p>right yeah if that were the case that's bad, but that should not be the case. The ownership semantics are driven by the canonical ABI, no the language-of-wasm</p>



<a name="265726197"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265726197" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265726197">(Dec 21 2021 at 19:38)</a>:</h4>
<p>The source of truth of what to deallocate on the host and such and what's owned by wasm is the canonical abi itself</p>



<a name="265726219"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265726219" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265726219">(Dec 21 2021 at 19:39)</a>:</h4>
<p>there's not a formal spec right now though so it's mostly "what the code does", but the code should do something that I think is in a PR to the interface-types repo at least</p>



<a name="265726344"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265726344" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265726344">(Dec 21 2021 at 19:40)</a>:</h4>
<p>I think what I'm trying to say is that ownership semantics are driven by the <code>*.wit</code> file independent of the language the wasm was written in (or the language of the host). I believe that's true today for all <code>wit-bindgen</code>-generated things, but if you think that it's not I can dig in more</p>



<a name="265726380"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265726380" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Vetere <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265726380">(Dec 21 2021 at 19:40)</a>:</h4>
<p>In order for me (as the host) to pass a list into a WASM function, I allocate memory in the guest space (using canonical_abi_realloc), write to it, and pass the guest-relative address in.  I can do this consistently regardless of whether the guest is implemented in C or Rust because the canonical_abi_realloc is exported by the bindgen regardless.  The problem occurs when the function returns back to the host -- I don't know whether or not to deallocate the memory I passed in (using canonical_abi_free).  To help illustrate, I've attached a wit file and both the generated Rust and C bindings.  Notice how the C code does not generate a free() call for the "test" routine right now, but the Rust code does.</p>
<p><a href="/user_uploads/15107/c3HYEn2bmimfb3wO15lzszgQ/foo.c">foo.c</a> <br>
<a href="/user_uploads/15107/LQNfffJ_Qh-c6siP4k-7w6Yc/foo.rs">foo.rs</a> <br>
<a href="/user_uploads/15107/fe64OuHjsLiWMWNNtEhmg5tu/foo.wit">foo.wit</a></p>



<a name="265727093"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265727093" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265727093">(Dec 21 2021 at 19:49)</a>:</h4>
<p>it needs deallocation in both cases</p>



<a name="265727100"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265727100" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265727100">(Dec 21 2021 at 19:49)</a>:</h4>
<p>it's just implicit in C that you must do that</p>



<a name="265727102"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265727102" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265727102">(Dec 21 2021 at 19:49)</a>:</h4>
<p>and it's automatically done for you in Rust</p>



<a name="265727116"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265727116" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265727116">(Dec 21 2021 at 19:49)</a>:</h4>
<p>if C doesn't free it then it's a memory leak</p>



<a name="265729124"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265729124" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Vetere <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265729124">(Dec 21 2021 at 20:11)</a>:</h4>
<p>Ok, so just to verify:  Authors wanting to create WASM modules compatible with the canonical ABI must free any and all lists they receive from the host before returning from their function.  Is that correct?</p>



<a name="265729159"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265729159" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Vetere <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265729159">(Dec 21 2021 at 20:11)</a>:</h4>
<p>(or ensure that they are freed)</p>



<a name="265729241"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265729241" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265729241">(Dec 21 2021 at 20:12)</a>:</h4>
<p>correct yeah</p>



<a name="265729785"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265729785" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Vetere <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265729785">(Dec 21 2021 at 20:18)</a>:</h4>
<p>Ok.  That's very helpful.  The rule limits the amount of optimization the host can do around memory allocation (i.e. the host wouldn't be able to allocate one large block that is the sum total of all lists and then sub-divide it as separate pointers), but on the other hand it implies that if the guest wants faster memory allocation, it can provide its own optimizations to this effect.</p>



<a name="265730136"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265730136" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265730136">(Dec 21 2021 at 20:22)</a>:</h4>
<p>indeed yeah, this is also part of the canonical abi itself where in the far future wasm modules can customize it all they want</p>



<a name="265730175"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265730175" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Vetere <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265730175">(Dec 21 2021 at 20:22)</a>:</h4>
<p>Thank you so much for helping me understand, Alex.  Appreciate it.</p>



<a name="265860808"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265860808" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265860808">(Dec 22 2021 at 22:22)</a>:</h4>
<p>hello folks!<br>
i was wondering if it's possible to return arbitrarily sized opaque types from within wasm, to store and be able to pass back into wasm functions.</p>



<a name="265861012"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265861012" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265861012">(Dec 22 2021 at 22:24)</a>:</h4>
<p>i'd have a WASM function that returns a value of that type, with an initial state, i'd probably need to store that function as a Vec&lt;u8&gt; (can't be an array since i don't know it's value beforehand), and i'd pass it back as a &amp;mut [u8]</p>



<a name="265861112"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265861112" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265861112">(Dec 22 2021 at 22:25)</a>:</h4>
<p>i'd prefer to not do sizeof in wasm, but that's completely ok if there's no other option available</p>



<a name="265861162"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265861162" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265861162">(Dec 22 2021 at 22:26)</a>:</h4>
<p>When you say "opaque", do mean opaque to the outside world?</p>



<a name="265861193"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265861193" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265861193">(Dec 22 2021 at 22:26)</a>:</h4>
<p>yes, i don't care what's in it, i just need to be able to clone it</p>



<a name="265861253"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265861253" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265861253">(Dec 22 2021 at 22:27)</a>:</h4>
<p>The outside world needs to be able to clone it?</p>



<a name="265861268"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265861268" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265861268">(Dec 22 2021 at 22:27)</a>:</h4>
<p>yes</p>



<a name="265861378"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265861378" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265861378">(Dec 22 2021 at 22:28)</a>:</h4>
<p>One option would be to keep the bytes inside the wasm, and return a handle representing those bytes. To clone them, you could export a <code>clone</code> function which takes a handle and returns a new handle.</p>



<a name="265861412"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265861412" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265861412">(Dec 22 2021 at 22:28)</a>:</h4>
<p>Another option would be to simply return a <code>list&lt;u8&gt;</code>, which can have a dynamic size.</p>



<a name="265861473"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265861473" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265861473">(Dec 22 2021 at 22:29)</a>:</h4>
<p>Though you can't get a <code>list&lt;u8&gt;</code> passed back in as a <code>&amp;mut [u8]</code>, so if you want updates like that, the handle approach tends to be better</p>



<a name="265861475"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265861475" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265861475">(Dec 22 2021 at 22:29)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">Script</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">State</span>: <span class="nb">Clone</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">init</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">State</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">tick</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">state</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="bp">Self</span>::<span class="n">State</span><span class="p">,</span><span class="w"> </span><span class="n">candle</span>: <span class="kp">&amp;</span><span class="nc">Candle</span><span class="p">,</span><span class="w"> </span><span class="n">history</span>: <span class="kp">&amp;</span><span class="nc">History</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">State</span><span class="o">&gt;</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>i'm basically trying to implement this trait using WASM</p>



<a name="265861545"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265861545" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265861545">(Dec 22 2021 at 22:29)</a>:</h4>
<p>i'm talking about the state parameter</p>



<a name="265861643"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265861643" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265861643">(Dec 22 2021 at 22:30)</a>:</h4>
<p>My first idea would be to use a resource, and return and pass handles.</p>



<a name="265861788"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265861788" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265861788">(Dec 22 2021 at 22:32)</a>:</h4>
<p>a resource? so basically a memory region that WASM controlls, and gives me access to?</p>



<a name="265861854"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265861854" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265861854">(Dec 22 2021 at 22:32)</a>:</h4>
<p>thing is, i'd also need to be able to store it, and provide its previous values through the History parameters</p>



<a name="265861863"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265861863" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265861863">(Dec 22 2021 at 22:33)</a>:</h4>
<p>that's why i'd need to clone it</p>



<a name="265861928"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265861928" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265861928">(Dec 22 2021 at 22:33)</a>:</h4>
<p>Cloning can be done with a <code>clone</code> function</p>



<a name="265862047"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265862047" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265862047">(Dec 22 2021 at 22:34)</a>:</h4>
<p>and that would mean all cloned values would need to be stored in WASM?</p>



<a name="265862093"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265862093" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265862093">(Dec 22 2021 at 22:34)</a>:</h4>
<p>It depends on which way the API goes. The outside world is the one calling <code>tick</code>?</p>



<a name="265862119"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265862119" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265862119">(Dec 22 2021 at 22:35)</a>:</h4>
<p>yes</p>



<a name="265862180"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265862180" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265862180">(Dec 22 2021 at 22:35)</a>:</h4>
<p>Then I think what you'd really want here is for the outside world to define the resource.</p>



<a name="265862225"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265862225" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265862225">(Dec 22 2021 at 22:36)</a>:</h4>
<p>But I expect that will hit a present limitation: <a href="https://github.com/bytecodealliance/wit-bindgen/issues/120">https://github.com/bytecodealliance/wit-bindgen/issues/120</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/issues/120" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/db41416699a78ec108b747785f1290bb6c30fd35\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f653365643364303532643033303936623566383533613034346361393838653436333964343135653732363635393730633035616433336633643533653437332f62797465636f6465616c6c69616e63652f7769742d62696e6467656e2f6973737565732f313230)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/issues/120" title="rust-wasm export cannot find imported handle types · Issue #120 · bytecodealliance/wit-bindgen">rust-wasm export cannot find imported handle types · Issue #120 · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">This repository: https://github.com/sunfishcode/import-export-demo contains a wit-bindgen project which imports provider.wit: resource thing { frob: function() } and exports runner.wit: use { thing...</div></div></div>



<a name="265862634"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265862634" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265862634">(Dec 22 2021 at 22:40)</a>:</h4>
<p>i would prefer not to require access to the WASM file during compile time</p>



<a name="265862661"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265862661" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265862661">(Dec 22 2021 at 22:41)</a>:</h4>
<p>it appears that's necessary for what you linked</p>



<a name="265862743"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265862743" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265862743">(Dec 22 2021 at 22:42)</a>:</h4>
<p>I'm not sure what you mean by access to the wasm</p>



<a name="265862842"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265862842" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265862842">(Dec 22 2021 at 22:43)</a>:</h4>
<p>i load the WASM at my programs runtime, not during compile time</p>



<a name="265862901"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265862901" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265862901">(Dec 22 2021 at 22:44)</a>:</h4>
<p>so, i'm not sure wit_bindgen_rust is usable in this case</p>



<a name="265862962"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265862962" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265862962">(Dec 22 2021 at 22:45)</a>:</h4>
<p>I'm still not clear on what you're referring to. wit_bindgen_rust is fine with modules being loaded at runtime</p>



<a name="265862971"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265862971" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265862971">(Dec 22 2021 at 22:45)</a>:</h4>
<p>sorry, i'm new to WASM and wasmtime, i'm not sure I understand everything just yet</p>



<a name="265863038"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265863038" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265863038">(Dec 22 2021 at 22:46)</a>:</h4>
<p>The main thing going on in #120 is that there are two wit files, rather than one</p>



<a name="265863050"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265863050" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265863050">(Dec 22 2021 at 22:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="254083">Dan Gohman</span> <a href="#narrow/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F/near/265862962">said</a>:</p>
<blockquote>
<p>I'm still not clear on what you're referring to. wit_bindgen_rust is fine with modules being loaded at runtime</p>
</blockquote>
<p>yes, but does that not require access to the wasm file during my programs compilation?</p>



<a name="265863088"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265863088" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265863088">(Dec 22 2021 at 22:47)</a>:</h4>
<p>Ah, no, that's what the wit IDL does. Your program gets everything it needs to know from wit file; it doesn't need to see the actual wasm</p>



<a name="265863139"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265863139" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265863139">(Dec 22 2021 at 22:47)</a>:</h4>
<p>ah, ok, still, each WASM script has a different state type</p>



<a name="265863189"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265863189" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265863189">(Dec 22 2021 at 22:48)</a>:</h4>
<p>there is no commonality there</p>



<a name="265863244"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265863244" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265863244">(Dec 22 2021 at 22:48)</a>:</h4>
<p>and, from what i can understand, wit files are like an interface to define common things (?), in this case, probably a resource for my type, or the type itself</p>



<a name="265863575"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265863575" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265863575">(Dec 22 2021 at 22:53)</a>:</h4>
<p>Interface types isn't really built to represent this kind of polymorphism directly.</p>



<a name="265863663"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265863663" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265863663">(Dec 22 2021 at 22:54)</a>:</h4>
<p>So there are no variable-size types that would be needed to model this directly.</p>



<a name="265863708"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265863708" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265863708">(Dec 22 2021 at 22:55)</a>:</h4>
<p>My suggestion to use a handle would involve adding a layer of indirection. Instead of literally returning the <code>State</code> value, there'd be a way to create state values, and you could use handles to reference them in opaque ways.</p>



<a name="265863918"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265863918" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265863918">(Dec 22 2021 at 22:58)</a>:</h4>
<p>Handles would also allow the state to be mutated.</p>



<a name="265864205"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265864205" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265864205">(Dec 22 2021 at 23:01)</a>:</h4>
<p>if i'd implement this in C, id would probably be something along these lines:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="k">struct</span> <span class="nc">InitState</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">State</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">foo</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">InitState</span><span class="w"> </span><span class="n">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">struct</span> <span class="nc">State</span><span class="w"> </span><span class="n">state</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">state</span><span class="p">.</span><span class="n">foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">struct</span> <span class="nc">InitState</span><span class="w"> </span><span class="n">res</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">res</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="n">state</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">res</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="w"> </span><span class="n">state</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">memcpy</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="n">state</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">Candle</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">History</span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span> <span class="nc">State</span><span class="w"> </span><span class="o">*</span><span class="n">states</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">tick</span><span class="p">(</span><span class="n">State</span><span class="w"> </span><span class="o">*</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Candle</span><span class="w"> </span><span class="o">*</span><span class="n">candle</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span> <span class="nc">History</span><span class="w"> </span><span class="o">*</span><span class="n">history</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">state</span><span class="p">.</span><span class="n">foo</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="265864220"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265864220" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265864220">(Dec 22 2021 at 23:01)</a>:</h4>
<p>that C is probably broken, it's just there as an example</p>



<a name="265864509"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265864509" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265864509">(Dec 22 2021 at 23:05)</a>:</h4>
<p>i also don't mind receiving State as an *uint8_t in tick</p>



<a name="265864775"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265864775" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265864775">(Dec 22 2021 at 23:09)</a>:</h4>
<p>or, maybe this:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="k">struct</span> <span class="nc">State</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">foo</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="kt">size_t</span><span class="w"> </span><span class="nf">state_size</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span> <span class="nc">State</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">struct</span> <span class="nc">State</span><span class="w"> </span><span class="o">*</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buf</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">state</span><span class="o">-&gt;</span><span class="n">foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">Candle</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">History</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="n">state_bufs</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">tick</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">state_buf</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Candle</span><span class="w"> </span><span class="o">*</span><span class="n">candle</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span> <span class="nc">History</span><span class="w"> </span><span class="o">*</span><span class="n">history</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">struct</span> <span class="nc">State</span><span class="w"> </span><span class="o">*</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state_buf</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">state</span><span class="o">-&gt;</span><span class="n">foo</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="265865034"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265865034" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265865034">(Dec 22 2021 at 23:13)</a>:</h4>
<p>compiling on <a href="https://webassembly.studio/">https://webassembly.studio/</a>: that code seems to generate the following .wat:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">module</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k">type</span> <span class="cp">$t0</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k">type</span> <span class="cp">$t1</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="kt">i32</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k">type</span> <span class="cp">$t2</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="kt">i32</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k">type</span> <span class="cp">$t3</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="kt">i32</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$__wasm_call_ctors</span><span class="w"> </span><span class="p">(</span><span class="k">type</span> <span class="cp">$t0</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$state_size</span><span class="w"> </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"state_size"</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">type</span> <span class="cp">$t1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$init</span><span class="w"> </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"init"</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">type</span> <span class="cp">$t2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="cp">$p0</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">get_local</span><span class="w"> </span><span class="cp">$p0</span><span class="w"></span>
<span class="w">    </span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">42</span><span class="w"></span>
<span class="w">    </span><span class="kt">i32</span><span class="p">.</span><span class="n">store</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$tick</span><span class="w"> </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"tick"</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">type</span> <span class="cp">$t3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="cp">$p0</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="cp">$p1</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="cp">$p2</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">get_local</span><span class="w"> </span><span class="cp">$p0</span><span class="w"></span>
<span class="w">    </span><span class="n">get_local</span><span class="w"> </span><span class="cp">$p0</span><span class="w"></span>
<span class="w">    </span><span class="kt">i32</span><span class="p">.</span><span class="n">load</span><span class="w"></span>
<span class="w">    </span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="kt">i32</span><span class="p">.</span><span class="n">add</span><span class="w"></span>
<span class="w">    </span><span class="kt">i32</span><span class="p">.</span><span class="n">store</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">table</span><span class="w"> </span><span class="cp">$T0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">anyfunc</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">memory</span><span class="w"> </span><span class="cp">$memory</span><span class="w"> </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"memory"</span><span class="p">)</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">global</span><span class="w"> </span><span class="cp">$g0</span><span class="w"> </span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">66560</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">global</span><span class="w"> </span><span class="cp">$__heap_base</span><span class="w"> </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"__heap_base"</span><span class="p">)</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">66560</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">global</span><span class="w"> </span><span class="cp">$__data_end</span><span class="w"> </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"__data_end"</span><span class="p">)</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">1024</span><span class="p">)))</span><span class="w"></span>
</code></pre></div>



<a name="265865226"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265865226" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265865226">(Dec 22 2021 at 23:15)</a>:</h4>
<p>If the outside world is calling <code>tick</code> here, then this looks like the <code>State</code> resource should be defined on the wasm side.</p>



<a name="265865239"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265865239" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265865239">(Dec 22 2021 at 23:15)</a>:</h4>
<p>yes</p>



<a name="265865243"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265865243" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265865243">(Dec 22 2021 at 23:15)</a>:</h4>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>
</code></pre></div>



<a name="265865253"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265865253" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265865253">(Dec 22 2021 at 23:15)</a>:</h4>
<p>the problem is that History also contains a history of previous States from each tick</p>



<a name="265865255"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265865255" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265865255">(Dec 22 2021 at 23:15)</a>:</h4>
<p>oops</p>



<a name="265865310"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265865310" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265865310">(Dec 22 2021 at 23:16)</a>:</h4>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>
</code></pre></div>



<a name="265865536"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265865536" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265865536">(Dec 22 2021 at 23:19)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">resource</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">init</span>: <span class="nc">function</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">handle</span><span class="o">&lt;</span><span class="n">state</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="n">tick</span>: <span class="nc">function</span><span class="p">(</span><span class="n">candle</span>: <span class="nc">candle</span><span class="p">,</span><span class="w"> </span><span class="n">history</span>: <span class="nc">handle</span><span class="o">&lt;</span><span class="n">state</span><span class="o">&gt;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">clone</span>: <span class="nc">function</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">handle</span><span class="o">&lt;</span><span class="n">state</span><span class="o">&gt;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="265865691"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265865691" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265865691">(Dec 22 2021 at 23:21)</a>:</h4>
<p>since history should be a list of previous states, should it not be list&lt;handle&lt;state&gt;&gt;?</p>



<a name="265865732"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265865732" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265865732">(Dec 22 2021 at 23:21)</a>:</h4>
<p>yeah</p>



<a name="265865995"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265865995" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265865995">(Dec 22 2021 at 23:25)</a>:</h4>
<p>i see. that sounds good enough. however, in case i'd need to store/restore the states, is there a way of doing that?</p>



<a name="265866096"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265866096" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265866096">(Dec 22 2021 at 23:26)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">serialize</span>: <span class="nc">function</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">list</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="w"></span>
<span class="k">static</span><span class="w">  </span><span class="n">deserialize</span>: <span class="nc">function</span><span class="p">(</span><span class="n">bytes</span>: <span class="nc">list</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">handle</span><span class="o">&lt;</span><span class="n">state</span><span class="o">&gt;</span><span class="w"></span>
</code></pre></div>
<p>would be one approach.</p>



<a name="265866115"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265866115" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265866115">(Dec 22 2021 at 23:26)</a>:</h4>
<p>awesome!</p>



<a name="265866143"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265866143" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265866143">(Dec 22 2021 at 23:27)</a>:</h4>
<p>what's a resource? i'm trying to find more documentation, but searching for "wasm resource" doesn't yield very good results</p>



<a name="265866225"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265866225" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265866225">(Dec 22 2021 at 23:28)</a>:</h4>
<p>There's unfortunately not a lot of docs right now. This will eventually be answered by the interface-types docs. But for now:</p>



<a name="265866260"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265866260" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265866260">(Dec 22 2021 at 23:28)</a>:</h4>
<p>A resource is just a type for opaque objects that can be pointed to by handle types.</p>



<a name="265866313"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265866313" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265866313">(Dec 22 2021 at 23:29)</a>:</h4>
<p>are there code examples that  use resources with wasmtime (preferably with rust)?</p>



<a name="265866390"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265866390" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265866390">(Dec 22 2021 at 23:30)</a>:</h4>
<p>The wasi-filesystem API rewritten into wit has a resource: <a href="https://github.com/WebAssembly/wasi-filesystem/blob/main/wasi-filesystem.wit.md">https://github.com/WebAssembly/wasi-filesystem/blob/main/wasi-filesystem.wit.md</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/wasi-filesystem/blob/main/wasi-filesystem.wit.md" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/bf78931f0309360bf15e8993dfe846c6628d58ad\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613833333863303332313633376134646535323132646632646261393233623537383432666264663861663535623365623232666332313731373638353462362f576562417373656d626c792f776173692d66696c6573797374656d)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/wasi-filesystem/blob/main/wasi-filesystem.wit.md" title="wasi-filesystem/wasi-filesystem.wit.md at main · WebAssembly/wasi-filesystem">wasi-filesystem/wasi-filesystem.wit.md at main · WebAssembly/wasi-filesystem</a></div><div class="message_embed_description">Filesystem API for WASI. Contribute to WebAssembly/wasi-filesystem development by creating an account on GitHub.</div></div></div>



<a name="265866447"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265866447" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265866447">(Dec 22 2021 at 23:31)</a>:</h4>
<p><code>descriptor</code> is a resource which one can think of as "the thing referenced by a file descriptor", with handles being the actual file descriptors</p>



<a name="265866891"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265866891" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265866891">(Dec 22 2021 at 23:36)</a>:</h4>
<p>hmm, is there actual code?</p>



<a name="265867037"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265867037" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265867037">(Dec 22 2021 at 23:39)</a>:</h4>
<p>The rust-wasm side is in-progress here: <a href="https://github.com/bytecodealliance/rustix/tree/wasi/src/imp/wasi">https://github.com/bytecodealliance/rustix/tree/wasi/src/imp/wasi</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/rustix/tree/wasi/src/imp/wasi" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/49285f34b43cba104b390cc5c29bdc6bba356603\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f343365313830323430353366616161333235313332303265623736343833386532653965663731303437616362333438336335636464653161373133363765652f62797465636f6465616c6c69616e63652f727573746978)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/rustix/tree/wasi/src/imp/wasi" title="rustix/src/imp/wasi at wasi · bytecodealliance/rustix">rustix/src/imp/wasi at wasi · bytecodealliance/rustix</a></div><div class="message_embed_description">Safe Rust bindings to POSIX-ish APIs. Contribute to bytecodealliance/rustix development by creating an account on GitHub.</div></div></div>



<a name="265867206"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265867206" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265867206">(Dec 22 2021 at 23:41)</a>:</h4>
<p>hmm, from what i can tell, resources are basically just something that one can get a handle&lt;T&gt; to, and handle&lt;T&gt; is basically a pointer to T</p>



<a name="265867343"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265867343" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265867343">(Dec 22 2021 at 23:43)</a>:</h4>
<p>That's the gist of it. <code>handle</code> is a smart pointer, so it won't dangle, and it promptly deallocates the resource when dropped.</p>



<a name="265867872"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265867872" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265867872">(Dec 22 2021 at 23:51)</a>:</h4>
<p>i think i understand now why i'd need the WASM code to do its own allocation</p>



<a name="265867992"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265867992" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265867992">(Dec 22 2021 at 23:53)</a>:</h4>
<p>from what i can tell, if i don't do this, i'd have to make sure that if i allocate memory outside of the wasm code, it doesn't interfere with what WASM does with the memory (since it doesn't know there is anything allocated)</p>



<a name="265868604"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265868604" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265868604">(Dec 23 2021 at 00:01)</a>:</h4>
<p>Yeah. With wit-bindgen and interface-types in general, code on the outside of a wasm component doesn't have access to the linear-memory address space on the inside.</p>



<a name="265869511"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265869511" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265869511">(Dec 23 2021 at 00:13)</a>:</h4>
<p>so, from what I can tell, i basically need</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">resource</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// create an initial state</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">init</span>: <span class="nc">function</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">handle</span><span class="o">&lt;</span><span class="n">state</span><span class="o">&gt;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// clone a state, so we can provide tick with a previous state</span>
<span class="w">    </span><span class="n">clone</span>: <span class="nc">function</span><span class="p">(</span><span class="n">state</span>: <span class="nc">handle</span><span class="o">&lt;</span><span class="n">state</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">handle</span><span class="o">&lt;</span><span class="n">state</span><span class="o">&gt;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// serialize state for storage</span>
<span class="w">    </span><span class="n">serialize</span>: <span class="nc">function</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">list</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">deserialize</span>: <span class="nc">function</span><span class="p">(</span><span class="n">bytes</span>: <span class="nc">list</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">handle</span><span class="o">&lt;</span><span class="n">state</span><span class="o">&gt;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// tick has access to a mutable state (usually a clone of the last state in history)</span>
<span class="w">    </span><span class="c1">// after the tick is done, the modified state might get stored in the history</span>
<span class="w">    </span><span class="n">tick</span>: <span class="nc">function</span><span class="p">(</span><span class="n">state</span>: <span class="nc">handle</span><span class="o">&lt;</span><span class="n">state</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">candle</span>: <span class="nc">candle</span><span class="p">,</span><span class="w"> </span><span class="n">history</span>: <span class="nc">list</span><span class="o">&lt;</span><span class="n">handle</span><span class="o">&lt;</span><span class="n">state</span><span class="o">&gt;&gt;</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="265869533"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265869533" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265869533">(Dec 23 2021 at 00:13)</a>:</h4>
<p>then, i use wit-bindgen in my rust-&gt;wasm program to provide those functions</p>



<a name="265869595"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265869595" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265869595">(Dec 23 2021 at 00:14)</a>:</h4>
<p>however, in my host rust program, where wasmtime is run, i'm guessing handle&lt;state&gt; is just an i32</p>



<a name="265869662"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265869662" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265869662">(Dec 23 2021 at 00:15)</a>:</h4>
<p>Yeah. The canonical ABI manages tables of handles, and provides Rust code with <code>i32</code> indices into those tables.</p>



<a name="265869686"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265869686" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265869686">(Dec 23 2021 at 00:15)</a>:</h4>
<p>awesome</p>



<a name="265869735"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265869735" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265869735">(Dec 23 2021 at 00:16)</a>:</h4>
<p>also, i'm guessing since i don't have multiple wit modules, i won't hit the issue you linked</p>



<a name="265869827"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265869827" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265869827">(Dec 23 2021 at 00:17)</a>:</h4>
<p>Yeah, with the wasm module defining the resource, you should be good</p>



<a name="265869960"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265869960" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265869960">(Dec 23 2021 at 00:19)</a>:</h4>
<p>will this work?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">resource</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// clone a state, so we can provide tick with a previous state</span>
<span class="w">    </span><span class="n">clone</span>: <span class="nc">function</span><span class="p">(</span><span class="n">state</span>: <span class="nc">handle</span><span class="o">&lt;</span><span class="n">state</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">handle</span><span class="o">&lt;</span><span class="n">state</span><span class="o">&gt;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// serialize state for storage</span>
<span class="w">    </span><span class="n">serialize</span>: <span class="nc">function</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">list</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">deserialize</span>: <span class="nc">function</span><span class="p">(</span><span class="n">bytes</span>: <span class="nc">list</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">handle</span><span class="o">&lt;</span><span class="n">state</span><span class="o">&gt;</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>

<span class="c1">// create an initial state</span>
<span class="k">static</span><span class="w"> </span><span class="n">init</span>: <span class="nc">function</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">handle</span><span class="o">&lt;</span><span class="n">state</span><span class="o">&gt;</span><span class="w"></span>

<span class="c1">// tick has access to a mutable state (usually a clone of the last state in history)</span>
<span class="c1">// after the tick is done, the modified state might get stored in the history</span>
<span class="n">tick</span>: <span class="nc">function</span><span class="p">(</span><span class="n">state</span>: <span class="nc">handle</span><span class="o">&lt;</span><span class="n">state</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">candle</span>: <span class="nc">candle</span><span class="p">,</span><span class="w"> </span><span class="n">history</span>: <span class="nc">list</span><span class="o">&lt;</span><span class="n">handle</span><span class="o">&lt;</span><span class="n">state</span><span class="o">&gt;&gt;</span><span class="p">)</span><span class="w"></span>
</code></pre></div>



<a name="265870034"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265870034" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265870034">(Dec 23 2021 at 00:20)</a>:</h4>
<p>also, i can't seem to be able to use <a href="https://bytecodealliance.github.io/wit-bindgen/">https://bytecodealliance.github.io/wit-bindgen/</a> with handle&lt;state&gt;</p>



<a name="265870085"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265870085" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265870085">(Dec 23 2021 at 00:21)</a>:</h4>
<p>ah, i'm probably misusing that page</p>



<a name="265870192"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265870192" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265870192">(Dec 23 2021 at 00:23)</a>:</h4>
<p>hmm, or not? i'm not exactly sure</p>



<a name="265870215"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265870215" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265870215">(Dec 23 2021 at 00:24)</a>:</h4>
<p>I'm not sure offhand how up to date that page is. wit-bindgen has been changing pretty rapidly</p>



<a name="265870352"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265870352" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265870352">(Dec 23 2021 at 00:25)</a>:</h4>
<p>Hmm, I was mistaken. It looks like it's current.</p>



<a name="265870762"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265870762" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265870762">(Dec 23 2021 at 00:29)</a>:</h4>
<p>Ah, right. It's <code>handle state</code> rather than <code>handle&lt;state&gt;</code></p>



<a name="265870794"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265870794" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265870794">(Dec 23 2021 at 00:30)</a>:</h4>
<p>Also, the <code>static init</code> function needs to be declared inside the resource</p>



<a name="265870874"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265870874" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265870874">(Dec 23 2021 at 00:30)</a>:</h4>
<p>can I ask why that is?</p>



<a name="265870975"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265870975" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265870975">(Dec 23 2021 at 00:31)</a>:</h4>
<p>I think you could define it outside too, but then you'd omit the <code>static</code> keyword</p>



<a name="265870987"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265870987" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265870987">(Dec 23 2021 at 00:31)</a>:</h4>
<p><code>static</code> means "don't add a self parameter"</p>



<a name="265870999"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265870999" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265870999">(Dec 23 2021 at 00:31)</a>:</h4>
<p>ah, i see, that makes sense!</p>



<a name="265871803"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265871803" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265871803">(Dec 23 2021 at 00:45)</a>:</h4>
<p>can *.wit files have parameterized types (generics)?</p>



<a name="265872094"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265872094" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265872094">(Dec 23 2021 at 00:50)</a>:</h4>
<p>no</p>



<a name="265872113"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265872113" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265872113">(Dec 23 2021 at 00:51)</a>:</h4>
<p>Some builtin types are parameterized, like <code>list&lt;T&gt;</code>, but no user-defined types are.</p>



<a name="265872114"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265872114" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265872114">(Dec 23 2021 at 00:51)</a>:</h4>
<p>i see. are there methods?</p>



<a name="265872126"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265872126" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265872126">(Dec 23 2021 at 00:51)</a>:</h4>
<p>Functions defined in resources are effectively methods</p>



<a name="265872196"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265872196" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265872196">(Dec 23 2021 at 00:52)</a>:</h4>
<p>other than that, "methods" are just prefixed functions i'm guessing</p>



<a name="265872234"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265872234" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265872234">(Dec 23 2021 at 00:53)</a>:</h4>
<p>where the first parameter is the receiver</p>



<a name="265872300"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265872300" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265872300">(Dec 23 2021 at 00:54)</a>:</h4>
<p>Yeah. In some langauge bindings, such as JS, having the concept of a receiver is useful to make the code more ergonomic.</p>



<a name="265872722"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265872722" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> noonien <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265872722">(Dec 23 2021 at 01:01)</a>:</h4>
<p>thanks for the help <span class="user-mention" data-user-id="254083">@Dan Gohman</span>! i would have been aimlessly lost without it! i really appreciate it</p>



<a name="265872790"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/265872790" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#265872790">(Dec 23 2021 at 01:02)</a>:</h4>
<p>You're welcome!</p>



<a name="267208022"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/267208022" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Vetere <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#267208022">(Jan 07 2022 at 16:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="465662">Peter Vetere</span> <a href="#narrow/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F/near/265729124">said</a>:</p>
<blockquote>
<p>Ok, so just to verify:  Authors wanting to create WASM modules compatible with the canonical ABI must free any and all lists they receive from the host before returning from their function.  Is that correct?</p>
</blockquote>
<p><span class="user-mention" data-user-id="253994">@Alex Crichton</span>  Just a quick follow-up on this:   when a Wasm function returns a list result to the host, is the host then responsible for calling <code>canonical_abi_free</code> on the linear memory offset it receives?  Or is that memory lifetime also assumed to be managed by the guest?</p>



<a name="267209244"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/267209244" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#267209244">(Jan 07 2022 at 16:26)</a>:</h4>
<p><span class="user-mention" data-user-id="465662">@Peter Vetere</span> correct yeah, the host takes "ownership" of the memory and must free it</p>



<a name="267209260"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/267209260" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Vetere <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#267209260">(Jan 07 2022 at 16:26)</a>:</h4>
<p>Excellent.  Thank you!</p>



<a name="267209261"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wit-bindgen%20-%20rules%20for%20deallocating%20lists%3F/near/267209261" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wit-bindgen.20-.20rules.20for.20deallocating.20lists.3F.html#267209261">(Jan 07 2022 at 16:26)</a>:</h4>
<p>(this is where we need to more thoroughly document the canonical ABI)</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>