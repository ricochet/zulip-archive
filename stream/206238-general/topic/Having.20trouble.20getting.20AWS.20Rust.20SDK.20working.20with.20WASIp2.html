<html>
<head><meta charset="utf-8"><title>Having trouble getting AWS Rust SDK working with WASIp2 · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/index.html">general</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Having.20trouble.20getting.20AWS.20Rust.20SDK.20working.20with.20WASIp2.html">Having trouble getting AWS Rust SDK working with WASIp2</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="433438448"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Having%20trouble%20getting%20AWS%20Rust%20SDK%20working%20with%20WASIp2/near/433438448" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jeff Parsons <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Having.20trouble.20getting.20AWS.20Rust.20SDK.20working.20with.20WASIp2.html#433438448">(Apr 16 2024 at 04:08)</a>:</h4>
<p>I originally mentioned this <a href="https://github.com/awslabs/aws-sdk-rust/issues/59#issuecomment-2055873631">over on the aws-sdk-rust issue tracker</a> and <span class="user-mention" data-user-id="678052">@Landon James</span> suggested moving the conversation over here.</p>
<p>When I add <code>aws-smithy-wasm</code> as a dependency I end up with this output in <code>cargo-component build</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">~/</span><span class="n">Projects</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">aws</span><span class="o">-</span><span class="n">sdk</span><span class="o">/</span><span class="n">aws</span><span class="o">-</span><span class="n">sdk</span><span class="o">-</span><span class="n">ec2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cargo</span><span class="o">-</span><span class="n">component</span><span class="w"> </span><span class="n">build</span>
<span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.03</span><span class="n">s</span>
<span class="n">error</span>: <span class="nc">module</span><span class="w"> </span><span class="n">requires</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="n">interface</span><span class="w"> </span><span class="n">named</span><span class="w"> </span><span class="err">`</span><span class="n">env</span><span class="err">`</span>

<span class="n">Stack</span><span class="w"> </span><span class="n">backtrace</span>:
   <span class="mi">0</span>: <span class="nc">anyhow</span>::<span class="n">error</span>::<span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">anyhow</span>::<span class="n">Error</span><span class="o">&gt;</span>::<span class="n">msg</span>
<span class="w">   </span><span class="mi">1</span>: <span class="nc">anyhow</span>::<span class="n">__private</span>::<span class="n">format_err</span><span class="p">.</span><span class="mi">6620</span>
<span class="w">   </span><span class="mi">2</span>: <span class="nc">wit_component</span>::<span class="n">encoding</span>::<span class="n">world</span>::<span class="n">ComponentWorld</span>::<span class="n">new</span>
<span class="w">   </span><span class="mi">3</span>: <span class="nc">wit_component</span>::<span class="n">encoding</span>::<span class="n">ComponentEncoder</span>::<span class="n">encode</span>
<span class="w">   </span><span class="mi">4</span>: <span class="nc">cargo_component</span>::<span class="n">run_cargo_command</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">   </span><span class="mi">5</span>: <span class="nc">cargo_component</span>::<span class="n">main</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">   </span><span class="mi">6</span>: <span class="nc">cargo_component</span>::<span class="n">main</span>
<span class="w">   </span><span class="mi">7</span>: <span class="nc">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">__rust_begin_short_backtrace</span>
<span class="w">   </span><span class="mi">8</span>: <span class="nc">main</span>
<span class="w">   </span><span class="mi">9</span>: <span class="nc">__libc_start_call_main</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">csu</span><span class="o">/../</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">nptl</span><span class="o">/</span><span class="n">libc_start_call_main</span><span class="p">.</span><span class="n">h</span>:<span class="mi">58</span>:<span class="mi">16</span>
<span class="w">  </span><span class="mi">10</span>: <span class="nc">__libc_start_main_impl</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">csu</span><span class="o">/../</span><span class="n">csu</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="n">start</span><span class="p">.</span><span class="n">c</span>:<span class="mi">392</span>:<span class="mi">3</span>
<span class="w">  </span><span class="mi">11</span>: <span class="nc">_start</span>
</code></pre></div>
<p>I have to admit I don't entirely understand how feature selection works, but the output of <code>cargo-tree</code> looks slightly suspicious to me:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="err">├──</span><span class="w"> </span><span class="n">aws</span><span class="o">-</span><span class="n">smithy</span><span class="o">-</span><span class="n">wasm</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">1.2</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">aws</span><span class="o">-</span><span class="n">smithy</span><span class="o">-</span><span class="n">runtime</span><span class="o">-</span><span class="n">api</span><span class="w"> </span><span class="n">feature</span><span class="w"> </span><span class="s">"default"</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">aws</span><span class="o">-</span><span class="n">smithy</span><span class="o">-</span><span class="n">runtime</span><span class="o">-</span><span class="n">api</span><span class="w"> </span><span class="n">feature</span><span class="w"> </span><span class="s">"http-1x"</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">aws</span><span class="o">-</span><span class="n">smithy</span><span class="o">-</span><span class="n">types</span><span class="w"> </span><span class="n">feature</span><span class="w"> </span><span class="s">"default"</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">feature</span><span class="w"> </span><span class="s">"default"</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">http</span><span class="w"> </span><span class="n">feature</span><span class="w"> </span><span class="s">"default"</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">tracing</span><span class="w"> </span><span class="n">feature</span><span class="w"> </span><span class="s">"default"</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">aws</span><span class="o">-</span><span class="n">smithy</span><span class="o">-</span><span class="n">http</span><span class="w"> </span><span class="n">feature</span><span class="w"> </span><span class="s">"default"</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="n">feature</span><span class="w"> </span><span class="s">"default"</span>
<span class="err">│</span><span class="w">       </span><span class="err">├──</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">12.1</span><span class="o">+</span><span class="n">wasi</span><span class="o">-</span><span class="mf">0.2.0</span>
<span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="w"> </span><span class="n">feature</span><span class="w"> </span><span class="s">"realloc"</span>
<span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">       </span><span class="err">└──</span><span class="w"> </span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">19.2</span>
<span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">           </span><span class="err">└──</span><span class="w"> </span><span class="n">bitflags</span><span class="w"> </span><span class="n">feature</span><span class="w"> </span><span class="s">"default"</span>
<span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">               </span><span class="err">└──</span><span class="w"> </span><span class="n">bitflags</span><span class="w"> </span><span class="n">v2</span><span class="p">.</span><span class="mf">5.0</span>
<span class="err">│</span><span class="w">       </span><span class="err">└──</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="n">feature</span><span class="w"> </span><span class="s">"std"</span>
<span class="err">│</span><span class="w">           </span><span class="err">└──</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">12.1</span><span class="o">+</span><span class="n">wasi</span><span class="o">-</span><span class="mf">0.2.0</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
</code></pre></div>
<p>And <a href="https://github.com/smithy-lang/smithy-rs/blob/5f7113f506f301296311ef637e40d226e0a6e548/rust-runtime/aws-smithy-wasm/Cargo.toml"><code>aws-smithy-wasm</code>'s <code>Cargo.toml</code></a> looks like it's pulling in various other crates with their default features enabled... which might not be intended?</p>
<p>Here are my versions of things:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">~/</span><span class="n">Projects</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">aws</span><span class="o">-</span><span class="n">sdk</span><span class="o">/</span><span class="n">aws</span><span class="o">-</span><span class="n">sdk</span><span class="o">-</span><span class="n">ec2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">--</span><span class="n">version</span>
<span class="n">cargo</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">component</span><span class="w"> </span><span class="mf">0.11.0</span><span class="w"> </span><span class="p">(</span><span class="mi">40320</span><span class="n">a9</span><span class="w"> </span><span class="mi">2024</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">15</span><span class="w"> </span><span class="n">wasi</span>:<span class="mi">040</span><span class="n">ec92</span><span class="p">)</span>
<span class="o">~/</span><span class="n">Projects</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">aws</span><span class="o">-</span><span class="n">sdk</span><span class="o">/</span><span class="n">aws</span><span class="o">-</span><span class="n">sdk</span><span class="o">-</span><span class="n">ec2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">rustc</span><span class="w"> </span><span class="o">--</span><span class="n">version</span>
<span class="n">rustc</span><span class="w"> </span><span class="mf">1.76.0</span><span class="w"> </span><span class="p">(</span><span class="mi">07</span><span class="n">dca489a</span><span class="w"> </span><span class="mi">2024</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">04</span><span class="p">)</span>
</code></pre></div>
<p>Am I just holding it wrong?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/awslabs/aws-sdk-rust/issues/59#issuecomment-2055873631" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/003493a83577662ca3c1ac3b51834519eb3b98f5\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f656433636263643666653338376337313262653439353330363537636134363831623638376134396435626533356366356336376536396634306161383233302f6177736c6162732f6177732d73646b2d727573742f6973737565732f3539)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/awslabs/aws-sdk-rust/issues/59#issuecomment-2055873631" title="WebAssembly support · Issue #59 · awslabs/aws-sdk-rust">WebAssembly support · Issue #59 · awslabs/aws-sdk-rust</a></div><div class="message_embed_description">❗ Are you interested in using the Rust SDK in Web Assembly? Please comment on this issue with more details about your potential use case! ❗ Community Note Please vote on this issue by adding a 👍 re...</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/smithy-lang/smithy-rs/blob/5f7113f506f301296311ef637e40d226e0a6e548/rust-runtime/aws-smithy-wasm/Cargo.toml" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/e80a1632c048e4b806f7197f1460f6441d001368\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613237396632653934623566653366363532626362616564386135316166663461336234303061346132333736373331666661373631346436653437643136632f736d697468792d6c616e672f736d697468792d7273)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/smithy-lang/smithy-rs/blob/5f7113f506f301296311ef637e40d226e0a6e548/rust-runtime/aws-smithy-wasm/Cargo.toml" title="smithy-rs/rust-runtime/aws-smithy-wasm/Cargo.toml at 5f7113f506f301296311ef637e40d226e0a6e548 · smithy-lang/smithy-rs">smithy-rs/rust-runtime/aws-smithy-wasm/Cargo.toml at 5f7113f506f301296311ef637e40d226e0a6e548 · smithy-lang/smithy-rs</a></div><div class="message_embed_description">Code generation for the AWS SDK for Rust, as well as server and generic smithy client generation. - smithy-lang/smithy-rs</div></div></div>



<a name="433438629"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Having%20trouble%20getting%20AWS%20Rust%20SDK%20working%20with%20WASIp2/near/433438629" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jeff Parsons <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Having.20trouble.20getting.20AWS.20Rust.20SDK.20working.20with.20WASIp2.html#433438629">(Apr 16 2024 at 04:11)</a>:</h4>
<p>Full repro:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">/</span><span class="n">tmp</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">bar</span>
<span class="w">     </span><span class="n">Created</span><span class="w"> </span><span class="n">binary</span><span class="w"> </span><span class="p">(</span><span class="n">application</span><span class="p">)</span><span class="w"> </span><span class="err">`</span><span class="n">bar</span><span class="err">`</span><span class="w"> </span><span class="n">package</span>
<span class="w">     </span><span class="n">Updated</span><span class="w"> </span><span class="n">manifest</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">package</span><span class="w"> </span><span class="err">`</span><span class="n">bar</span><span class="err">`</span>
<span class="w">   </span><span class="n">Generated</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="err">`</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span><span class="err">`</span>
<span class="o">/</span><span class="n">tmp</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cd</span><span class="w"> </span><span class="n">bar</span><span class="o">/</span>
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">bar</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">default</span><span class="o">-</span><span class="n">features</span><span class="w"> </span><span class="n">aws</span><span class="o">-</span><span class="n">smithy</span><span class="o">-</span><span class="n">wasm</span>
<span class="w">    </span><span class="n">Updating</span><span class="w"> </span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="w"> </span><span class="n">index</span>
<span class="w">      </span><span class="n">Adding</span><span class="w"> </span><span class="n">aws</span><span class="o">-</span><span class="n">smithy</span><span class="o">-</span><span class="n">wasm</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">1.2</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">dependencies</span><span class="p">.</span>
<span class="w">    </span><span class="n">Updating</span><span class="w"> </span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="w"> </span><span class="n">index</span>
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">bar</span><span class="w"> </span><span class="n">took</span><span class="w"> </span><span class="mi">3</span><span class="n">s</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="n">build</span>
<span class="w">  </span><span class="n">Generating</span><span class="w"> </span><span class="n">bindings</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">bar</span><span class="w"> </span><span class="p">(</span><span class="n">src</span><span class="o">/</span><span class="n">bindings</span><span class="p">.</span><span class="n">rs</span><span class="p">)</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">proc</span><span class="o">-</span><span class="n">macro2</span><span class="w"> </span><span class="n">v1</span><span class="p">.</span><span class="mf">0.80</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">pin</span><span class="o">-</span><span class="n">project</span><span class="o">-</span><span class="n">lite</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">2.14</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">unicode</span><span class="o">-</span><span class="n">ident</span><span class="w"> </span><span class="n">v1</span><span class="p">.</span><span class="mf">0.12</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">v1</span><span class="p">.</span><span class="mf">6.0</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">autocfg</span><span class="w"> </span><span class="n">v1</span><span class="p">.</span><span class="mf">2.0</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">itoa</span><span class="w"> </span><span class="n">v1</span><span class="p">.</span><span class="mf">0.11</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">fnv</span><span class="w"> </span><span class="n">v1</span><span class="p">.</span><span class="mf">0.7</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">powerfmt</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">2.0</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">pin</span><span class="o">-</span><span class="n">utils</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">1.0</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">futures</span><span class="o">-</span><span class="n">core</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">3.30</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">futures</span><span class="o">-</span><span class="n">task</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">3.30</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">either</span><span class="w"> </span><span class="n">v1</span><span class="p">.</span><span class="mf">11.0</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">outref</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">5.1</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">once_cell</span><span class="w"> </span><span class="n">v1</span><span class="p">.</span><span class="mf">19.0</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">num</span><span class="o">-</span><span class="n">conv</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">1.0</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">time</span><span class="o">-</span><span class="n">core</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">1.2</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">vsimd</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">8.0</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">tokio</span><span class="w"> </span><span class="n">v1</span><span class="p">.</span><span class="mf">37.0</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">ryu</span><span class="w"> </span><span class="n">v1</span><span class="p">.</span><span class="mf">0.17</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">19.2</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">futures</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">3.30</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">bitflags</span><span class="w"> </span><span class="n">v2</span><span class="p">.</span><span class="mf">5.0</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="o">-</span><span class="n">rt</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">24.0</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">percent</span><span class="o">-</span><span class="n">encoding</span><span class="w"> </span><span class="n">v2</span><span class="p">.</span><span class="mf">3.1</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">deranged</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">3.11</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">tracing</span><span class="o">-</span><span class="n">core</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">1.32</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">num</span><span class="o">-</span><span class="n">traits</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">2.18</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">12.1</span><span class="o">+</span><span class="n">wasi</span><span class="o">-</span><span class="mf">0.2.0</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">base64</span><span class="o">-</span><span class="n">simd</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">8.0</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">http</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">2.12</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">bytes</span><span class="o">-</span><span class="n">utils</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">1.4</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">http</span><span class="w"> </span><span class="n">v1</span><span class="p">.</span><span class="mf">1.0</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">quote</span><span class="w"> </span><span class="n">v1</span><span class="p">.</span><span class="mf">0.36</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">syn</span><span class="w"> </span><span class="n">v2</span><span class="p">.</span><span class="mf">0.59</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">3.36</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">http</span><span class="o">-</span><span class="n">body</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">4.6</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">num</span><span class="o">-</span><span class="n">integer</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">1.46</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">aws</span><span class="o">-</span><span class="n">smithy</span><span class="o">-</span><span class="k">async</span><span class="w"> </span><span class="n">v1</span><span class="p">.</span><span class="mf">2.1</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">aws</span><span class="o">-</span><span class="n">smithy</span><span class="o">-</span><span class="n">types</span><span class="w"> </span><span class="n">v1</span><span class="p">.</span><span class="mf">1.8</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">tracing</span><span class="o">-</span><span class="n">attributes</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">1.27</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">tracing</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">1.40</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">aws</span><span class="o">-</span><span class="n">smithy</span><span class="o">-</span><span class="n">runtime</span><span class="o">-</span><span class="n">api</span><span class="w"> </span><span class="n">v1</span><span class="p">.</span><span class="mf">4.0</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">aws</span><span class="o">-</span><span class="n">smithy</span><span class="o">-</span><span class="n">http</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">60.7</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">aws</span><span class="o">-</span><span class="n">smithy</span><span class="o">-</span><span class="n">wasm</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">1.2</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">bar</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">1.0</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">bar</span><span class="p">)</span>
<span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">4.97</span><span class="n">s</span>
<span class="w">    </span><span class="n">Creating</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="n">target</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">bar</span><span class="p">.</span><span class="n">wasm</span>
<span class="n">error</span>: <span class="nc">module</span><span class="w"> </span><span class="n">requires</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="n">interface</span><span class="w"> </span><span class="n">named</span><span class="w"> </span><span class="err">`</span><span class="n">env</span><span class="err">`</span>

<span class="n">Stack</span><span class="w"> </span><span class="n">backtrace</span>:
   <span class="mi">0</span>: <span class="nc">anyhow</span>::<span class="n">error</span>::<span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">anyhow</span>::<span class="n">Error</span><span class="o">&gt;</span>::<span class="n">msg</span>
<span class="w">   </span><span class="mi">1</span>: <span class="nc">anyhow</span>::<span class="n">__private</span>::<span class="n">format_err</span><span class="p">.</span><span class="mi">6620</span>
<span class="w">   </span><span class="mi">2</span>: <span class="nc">wit_component</span>::<span class="n">encoding</span>::<span class="n">world</span>::<span class="n">ComponentWorld</span>::<span class="n">new</span>
<span class="w">   </span><span class="mi">3</span>: <span class="nc">wit_component</span>::<span class="n">encoding</span>::<span class="n">ComponentEncoder</span>::<span class="n">encode</span>
<span class="w">   </span><span class="mi">4</span>: <span class="nc">cargo_component</span>::<span class="n">run_cargo_command</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">   </span><span class="mi">5</span>: <span class="nc">cargo_component</span>::<span class="n">main</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">   </span><span class="mi">6</span>: <span class="nc">cargo_component</span>::<span class="n">main</span>
<span class="w">   </span><span class="mi">7</span>: <span class="nc">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">__rust_begin_short_backtrace</span>
<span class="w">   </span><span class="mi">8</span>: <span class="nc">main</span>
<span class="w">   </span><span class="mi">9</span>: <span class="nc">__libc_start_call_main</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">csu</span><span class="o">/../</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">nptl</span><span class="o">/</span><span class="n">libc_start_call_main</span><span class="p">.</span><span class="n">h</span>:<span class="mi">58</span>:<span class="mi">16</span>
<span class="w">  </span><span class="mi">10</span>: <span class="nc">__libc_start_main_impl</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">csu</span><span class="o">/../</span><span class="n">csu</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="n">start</span><span class="p">.</span><span class="n">c</span>:<span class="mi">392</span>:<span class="mi">3</span>
<span class="w">  </span><span class="mi">11</span>: <span class="nc">_start</span>
</code></pre></div>



<a name="433439289"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Having%20trouble%20getting%20AWS%20Rust%20SDK%20working%20with%20WASIp2/near/433439289" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Landon James <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Having.20trouble.20getting.20AWS.20Rust.20SDK.20working.20with.20WASIp2.html#433439289">(Apr 16 2024 at 04:18)</a>:</h4>
<p>This chunk:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Finished</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">4.97</span><span class="n">s</span>
<span class="w">    </span><span class="n">Creating</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="n">target</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">bar</span><span class="p">.</span><span class="n">wasm</span>
<span class="n">error</span>: <span class="nc">module</span><span class="w"> </span><span class="n">requires</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="n">interface</span><span class="w"> </span><span class="n">named</span><span class="w"> </span><span class="err">`</span><span class="n">env</span><span class="err">`</span>
</code></pre></div>
<p>Makes it seem like the failure is in embedding the component metadata rather than compiling the project, so I don't think that the issue has to do with un-needed features in the dependencies of <code>aws-smithy-wasm</code>. </p>
<p>I'm wondering what version of <code>cargo-component</code> you are using and if that might be older? Or potentially the smithy crate's dependency on the <code>wasi</code> crate is out of date? I'll try to do some more digging into this tomorrow.</p>



<a name="433439427"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Having%20trouble%20getting%20AWS%20Rust%20SDK%20working%20with%20WASIp2/near/433439427" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Landon James <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Having.20trouble.20getting.20AWS.20Rust.20SDK.20working.20with.20WASIp2.html#433439427">(Apr 16 2024 at 04:20)</a>:</h4>
<p>In the meantime, there is a working example of this buried deep in the Rust SDK's canary package. <a href="https://github.com/smithy-lang/smithy-rs/tree/main/tools/ci-cdk/canary-wasm">https://github.com/smithy-lang/smithy-rs/tree/main/tools/ci-cdk/canary-wasm</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/smithy-lang/smithy-rs/tree/main/tools/ci-cdk/canary-wasm" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/e80a1632c048e4b806f7197f1460f6441d001368\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613237396632653934623566653366363532626362616564386135316166663461336234303061346132333736373331666661373631346436653437643136632f736d697468792d6c616e672f736d697468792d7273)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/smithy-lang/smithy-rs/tree/main/tools/ci-cdk/canary-wasm" title="smithy-rs/tools/ci-cdk/canary-wasm at main · smithy-lang/smithy-rs">smithy-rs/tools/ci-cdk/canary-wasm at main · smithy-lang/smithy-rs</a></div><div class="message_embed_description">Code generation for the AWS SDK for Rust, as well as server and generic smithy client generation. - smithy-lang/smithy-rs</div></div></div>



<a name="433440963"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Having%20trouble%20getting%20AWS%20Rust%20SDK%20working%20with%20WASIp2/near/433440963" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Landon James <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Having.20trouble.20getting.20AWS.20Rust.20SDK.20working.20with.20WASIp2.html#433440963">(Apr 16 2024 at 04:40)</a>:</h4>
<p>Weird, I am able to repro your issue, but I can also build<br>
one of my projects  using it just fine and I’m not sure what the difference is. The SDK does rely on env to work in WASI (mostly to load credentials from environment variables), but I don’t think you should have to do anything to link it in</p>



<a name="433533034"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Having%20trouble%20getting%20AWS%20Rust%20SDK%20working%20with%20WASIp2/near/433533034" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Having.20trouble.20getting.20AWS.20Rust.20SDK.20working.20with.20WASIp2.html#433533034">(Apr 16 2024 at 14:16)</a>:</h4>
<p>Ah the <code>env</code> module is the default module emitted by LLD for unresolved symbols, so what you're hitting is something that should be a link-time error but ends up getting papered over for tooling to fail later down the road. I'd recomend <code>wasm-tools print</code>-ing the file and looking at what the symbol is under the <code>env</code> module as that'll help provide a clue as to what library is pulling in a symbol that needs adjusting.</p>
<p>Orthogonally and independently it'd probably be good to improve the error message here to say more than just <code>env</code> as well!</p>



<a name="433556691"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Having%20trouble%20getting%20AWS%20Rust%20SDK%20working%20with%20WASIp2/near/433556691" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Landon James <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Having.20trouble.20getting.20AWS.20Rust.20SDK.20working.20with.20WASIp2.html#433556691">(Apr 16 2024 at 15:58)</a>:</h4>
<p>Printing the <code>cargo-component</code> init (with the <code>aws-smithy-wasm</code> import) file shows the below:</p>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code>  <span class="p">(</span><span class="k">import</span> <span class="s2">"env"</span> <span class="s2">"cabi_realloc_wit_bindgen_0_19_2"</span> <span class="p">(</span><span class="k">func</span> <span class="nv">$cabi_realloc_wit_bindgen_0_19_2</span> <span class="cm">(;4;)</span> <span class="p">(</span><span class="k">type</span> <span class="mi">7</span><span class="p">)))</span>
</code></pre></div>
<p>So it seems like it should be getting <code>env</code> from <code>wit-bindgen</code>? Full wat file included if it helps.</p>
<p><a href="/user_uploads/15107/8RrO1cbIu97oWhxM5fGCoITE/bar.wat">bar.wat</a></p>



<a name="433557529"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Having%20trouble%20getting%20AWS%20Rust%20SDK%20working%20with%20WASIp2/near/433557529" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Having.20trouble.20getting.20AWS.20Rust.20SDK.20working.20with.20WASIp2.html#433557529">(Apr 16 2024 at 16:02)</a>:</h4>
<p>Do you have a dep on <code>wit-bindgen</code> somewhere? <code>cargo-component</code> projects currently should only have a dep on <code>wit-bindgen-rt</code></p>



<a name="433557942"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Having%20trouble%20getting%20AWS%20Rust%20SDK%20working%20with%20WASIp2/near/433557942" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Landon James <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Having.20trouble.20getting.20AWS.20Rust.20SDK.20working.20with.20WASIp2.html#433557942">(Apr 16 2024 at 16:04)</a>:</h4>
<p><code>aws-smithy-wasm</code> depends on the <code>wasi</code> crate which depends directly on <code>wit-bindgen</code>, so it is in there transitively, but not directly</p>



<a name="433558118"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Having%20trouble%20getting%20AWS%20Rust%20SDK%20working%20with%20WASIp2/near/433558118" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Having.20trouble.20getting.20AWS.20Rust.20SDK.20working.20with.20WASIp2.html#433558118">(Apr 16 2024 at 16:05)</a>:</h4>
<p>that should be fine then, not sure why it isn't linking in realloc though</p>



<a name="433558406"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Having%20trouble%20getting%20AWS%20Rust%20SDK%20working%20with%20WASIp2/near/433558406" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Having.20trouble.20getting.20AWS.20Rust.20SDK.20working.20with.20WASIp2.html#433558406">(Apr 16 2024 at 16:06)</a>:</h4>
<p>Possibly-unrelated, what's up with <code>cabi_realloc_wit_bindgen_0_19_2</code>? I saw this the other day and didn't recognize the suffix.</p>



<a name="433558824"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Having%20trouble%20getting%20AWS%20Rust%20SDK%20working%20with%20WASIp2/near/433558824" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Landon James <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Having.20trouble.20getting.20AWS.20Rust.20SDK.20working.20with.20WASIp2.html#433558824">(Apr 16 2024 at 16:08)</a>:</h4>
<p>I think that suffix is due to another issue I encountered a few weeks ago:<br>
issue: <a href="https://github.com/bytecodealliance/wit-bindgen/issues/849">https://github.com/bytecodealliance/wit-bindgen/issues/849</a><br>
fix: <a href="https://github.com/bytecodealliance/wit-bindgen/pull/851">https://github.com/bytecodealliance/wit-bindgen/pull/851</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/issues/849" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/6876d0efae67dfa572efa6c9423a7228f7849884\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f653939353864666462656138383964656531633239303862386465663634373632623832396431363637383537346633616630353665333963613666653834302f62797465636f6465616c6c69616e63652f7769742d62696e6467656e2f6973737565732f383439)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/issues/849" title="Compilation error when multiple versions of `wit-bindgen` present in project · Issue #849 · bytecodealliance/wit-bindgen">Compilation error when multiple versions of `wit-bindgen` present in project · Issue #849 · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">When there are multiple versions of wit-bindgen present in a project compilation fails with an error like: = note: rust-lld: error: duplicate symbol: cabi_realloc &gt;&gt;&gt; defined in /Volumes/workplace/...</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/pull/851" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/fd6f3ab87ad13a4ef82d961e97947008e62b4c38\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f663863346539613061326361626131613763323562393161306630376635623435363963613436616166373239323565626137393239643232353931306138352f62797465636f6465616c6c69616e63652f7769742d62696e6467656e2f70756c6c2f383531)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/pull/851" title="rust: Define `cabi_realloc` as a weak symbol by alexcrichton · Pull Request #851 · bytecodealliance/wit-bindgen">rust: Define `cabi_realloc` as a weak symbol by alexcrichton · Pull Request #851 · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">This commit updates the wit-bindgen Rust crate to define the cabi_realloc symbol as a weak symbol. This is not easy because Rust does not offer a stable means by which to do this. Despite this thro...</div></div></div>



<a name="433558825"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Having%20trouble%20getting%20AWS%20Rust%20SDK%20working%20with%20WASIp2/near/433558825" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Having.20trouble.20getting.20AWS.20Rust.20SDK.20working.20with.20WASIp2.html#433558825">(Apr 16 2024 at 16:08)</a>:</h4>
<p>i think it is an attempt to allow linkage against multiple wit-bindgen deps of differing versions; alex or dan have the context there iirc</p>



<a name="433571635"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Having%20trouble%20getting%20AWS%20Rust%20SDK%20working%20with%20WASIp2/near/433571635" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Having.20trouble.20getting.20AWS.20Rust.20SDK.20working.20with.20WASIp2.html#433571635">(Apr 16 2024 at 17:16)</a>:</h4>
<p>Yeah. When you have multiple expansions of the wit-bindgen bindings linked into the same program, it's a way to make their <code>cabi_realloc</code>s not collide.</p>



<a name="433575705"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Having%20trouble%20getting%20AWS%20Rust%20SDK%20working%20with%20WASIp2/near/433575705" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Having.20trouble.20getting.20AWS.20Rust.20SDK.20working.20with.20WASIp2.html#433575705">(Apr 16 2024 at 17:44)</a>:</h4>
<p>hm the fact that this symbol is imported indicates a bug in something in wit-bindgen/wasi/etc for sure</p>



<a name="433575825"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Having%20trouble%20getting%20AWS%20Rust%20SDK%20working%20with%20WASIp2/near/433575825" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Having.20trouble.20getting.20AWS.20Rust.20SDK.20working.20with.20WASIp2.html#433575825">(Apr 16 2024 at 17:45)</a>:</h4>
<p>Given the repro here I'll try to dig into this this week and see if I can't figure out what's going wrong</p>



<a name="433577203"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Having%20trouble%20getting%20AWS%20Rust%20SDK%20working%20with%20WASIp2/near/433577203" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Landon James <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Having.20trouble.20getting.20AWS.20Rust.20SDK.20working.20with.20WASIp2.html#433577203">(Apr 16 2024 at 17:55)</a>:</h4>
<p>I just blew out my Cargo.lock and rebuilt my previously working project and hit the same error, so this is likely something fairly new. I think I first built that project about 2 weeks ago, so probably something in that timeframe?</p>



<a name="433616966"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Having%20trouble%20getting%20AWS%20Rust%20SDK%20working%20with%20WASIp2/near/433616966" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Having.20trouble.20getting.20AWS.20Rust.20SDK.20working.20with.20WASIp2.html#433616966">(Apr 16 2024 at 22:26)</a>:</h4>
<p>I've reduced this to:</p>
<div class="codehilite" data-code-language="TOML"><pre><span></span><code><span class="k">[package]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"bar"</span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0.1.0"</span>
<span class="n">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"2021"</span>

<span class="k">[dependencies]</span>
<span class="n">wit-bindgen-rt1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"0.24.0"</span><span class="p">,</span><span class="w"> </span><span class="n">package</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s1">'wit-bindgen-rt'</span><span class="w"> </span><span class="p">}</span>
<span class="n">wit-bindgen-rt2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"0.23.0"</span><span class="p">,</span><span class="w"> </span><span class="n">package</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s1">'wit-bindgen-rt'</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>
<p>and </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">wit_bindgen_rt1</span>::<span class="n">maybe_link_cabi_realloc</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>My current suspicion is that both versions of wit-bindgen use <code>libwit_bindgen_cabi_realloc.a</code> as a library name. Still digging though</p>



<a name="433620709"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Having%20trouble%20getting%20AWS%20Rust%20SDK%20working%20with%20WASIp2/near/433620709" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Having.20trouble.20getting.20AWS.20Rust.20SDK.20working.20with.20WASIp2.html#433620709">(Apr 16 2024 at 23:00)</a>:</h4>
<p><span class="user-mention" data-user-id="470250">@Jeff Parsons</span> do you have a larger reproduction of this issue?</p>
<p>I ask because your current issue as-stated above can be fixed with:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">echo</span><span class="w"> </span><span class="o">'</span><span class="na">extern</span><span class="w"> </span><span class="k">crate</span><span class="w"> </span><span class="n">aws_smithy_wasm</span><span class="p">;</span><span class="o">'</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>
</code></pre></div>
<p>I opened <a href="https://github.com/bytecodealliance/wit-bindgen/pull/928">https://github.com/bytecodealliance/wit-bindgen/pull/928</a> to fix that specific issue, but linking is often weird and surprising. If you have a larger reproduction I'd like to test that the fix in that PR fixes the issue as well in case there's something else I'm missing</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/pull/928" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/7bd55dbed8d970755b3753aa27f8fe1b4aa3d0db\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f393430336230376239343966353937346664393834663864613035393161653134613339383765363831653137333337633935336265666238653166363033382f62797465636f6465616c6c69616e63652f7769742d62696e6467656e2f70756c6c2f393238)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/pull/928" title="Use a unique name for `libwit_bindgen_cabi_realloc.a` per-crate-version by alexcrichton · Pull Request #928 · bytecodealliance/wit-bindgen">Use a unique name for `libwit_bindgen_cabi_realloc.a` per-crate-version by alexcrichton · Pull Request #928 · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">This commit updates how the weak cabi_realloc symbol is linked. Previously rustc was told to use -lwit_bindgen_cabi_realloc with a -L pointing to the source directory of the crate which has a preco...</div></div></div>



<a name="433620744"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Having%20trouble%20getting%20AWS%20Rust%20SDK%20working%20with%20WASIp2/near/433620744" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Having.20trouble.20getting.20AWS.20Rust.20SDK.20working.20with.20WASIp2.html#433620744">(Apr 16 2024 at 23:00)</a>:</h4>
<p>b/c the fix I have relies on a crate not actually being used, which seems unlikely in a larger reproduction situation</p>



<a name="433621753"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Having%20trouble%20getting%20AWS%20Rust%20SDK%20working%20with%20WASIp2/near/433621753" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jeff Parsons <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Having.20trouble.20getting.20AWS.20Rust.20SDK.20working.20with.20WASIp2.html#433621753">(Apr 16 2024 at 23:09)</a>:</h4>
<p>Wow, that is wild. I don't have one at hand, but when I get a chance I will try to make a "realistic use" repro.</p>
<p>BTW, the context for all this was roughly:</p>
<ul>
<li>OMG, <code>aws-sdk-ec2</code> builds are killing me (and my machine, and my colleagues).</li>
<li>I know: I'll wrap it up in a Wasm Component, and then I can just build it on CI. (We don't have Mac CI workers, but all dev machines are MacBooks.)</li>
<li>This issue. </li>
</ul>
<p>I'm unlikely to be near a computer today, but when I am I will push that "realistic use" repro somewhere and link it here. </p>
<p>Thanks, y'all! <span aria-label="sparkling heart" class="emoji emoji-1f496" role="img" title="sparkling heart">:sparkling_heart:</span></p>



<a name="433622132"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Having%20trouble%20getting%20AWS%20Rust%20SDK%20working%20with%20WASIp2/near/433622132" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jeff Parsons <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Having.20trouble.20getting.20AWS.20Rust.20SDK.20working.20with.20WASIp2.html#433622132">(Apr 16 2024 at 23:13)</a>:</h4>
<p>(Also, this feels like a great excuse to sneak Wasm in the door at work. <span aria-label="wink" class="emoji emoji-1f609" role="img" title="wink">:wink:</span>)</p>



<a name="433622901"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Having%20trouble%20getting%20AWS%20Rust%20SDK%20working%20with%20WASIp2/near/433622901" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Having.20trouble.20getting.20AWS.20Rust.20SDK.20working.20with.20WASIp2.html#433622901">(Apr 16 2024 at 23:22)</a>:</h4>
<p>no worries! This may not actually reproduce in a larger context which in that case I'll publish a fix once it's merged</p>



<a name="433623490"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Having%20trouble%20getting%20AWS%20Rust%20SDK%20working%20with%20WASIp2/near/433623490" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Landon James <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Having.20trouble.20getting.20AWS.20Rust.20SDK.20working.20with.20WASIp2.html#433623490">(Apr 16 2024 at 23:29)</a>:</h4>
<p>Sweet, once you do get around to having it work on your machine feel free to reach out if you have anymore questions about the AWS Rust SDK with wasm bits! As far as I know I'm the only one using it so far so would love to get some extra eyes on it and find any lingering bugs I might have missed.</p>



<a name="433633280"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Having%20trouble%20getting%20AWS%20Rust%20SDK%20working%20with%20WASIp2/near/433633280" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jeff Parsons <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Having.20trouble.20getting.20AWS.20Rust.20SDK.20working.20with.20WASIp2.html#433633280">(Apr 17 2024 at 01:39)</a>:</h4>
<p>I can confirm that</p>
<ol>
<li>If I actually _use_ something from the crate, e.g., <code>let wasi_http_client = aws_smithy_wasm::wasi::WasiHttpClientBuilder::new().build();</code> then this error no longer occurs.</li>
<li>Adding <code>extern crate aws_smithy_wasm;</code>also makes it go away.</li>
</ol>
<p>I guess I hit this one when nobody else did because... I work in a strange way sometimes. :)</p>
<p>Working-ish code is here: <a href="https://github.com/jeffparsons/aws-wasm-components">https://github.com/jeffparsons/aws-wasm-components</a>. It can talk to an AWS server! <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> (Haven't gotten auth working yet, but that's off-topic.)</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/jeffparsons/aws-wasm-components" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/5a6c271700a18d9a0ba8059105ca71a92220ed27\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f306234373838343837313334663863626266353462643063313931323736373730326538393332333365373961636139323530343838633638343264346662612f6a656666706172736f6e732f6177732d7761736d2d636f6d706f6e656e7473)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/jeffparsons/aws-wasm-components" title="GitHub - jeffparsons/aws-wasm-components">GitHub - jeffparsons/aws-wasm-components</a></div><div class="message_embed_description">Contribute to jeffparsons/aws-wasm-components development by creating an account on GitHub.</div></div></div>



<a name="433634456"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Having%20trouble%20getting%20AWS%20Rust%20SDK%20working%20with%20WASIp2/near/433634456" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Having.20trouble.20getting.20AWS.20Rust.20SDK.20working.20with.20WASIp2.html#433634456">(Apr 17 2024 at 01:56)</a>:</h4>
<p>Ok sounds good, and thanks regardless for the report!</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>