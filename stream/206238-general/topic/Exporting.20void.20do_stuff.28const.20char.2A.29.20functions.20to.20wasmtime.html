<html>
<head><meta charset="utf-8"><title>Exporting void do_stuff(const char*) functions to wasmtime · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/index.html">general</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html">Exporting void do_stuff(const char*) functions to wasmtime</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="204793518"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204793518" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexandru Ene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204793518">(Jul 23 2020 at 13:03)</a>:</h4>
<p>For various _reasons_ I recently needed to link some host functions to a few wasm VMs. WASMTime to me seems to be the outlier here on how bindings work. (my experience is between wamr, wasm3, wasmtime). The other two engines allow to some degree exposing a function that takes a const char* or any pointer to some data as long as there's a size also involved (wamr enforces this).</p>
<p>But, in wasmtime, I was looking at the arguments and found AnyRef (behind a flag - <code>wasmtime_config_wasm_reference_types_set</code>).<br>
The rest of accepted values are i32/i64,f32,f64 and func_ref. </p>
<p>I couldn't find an example on how to correctly use anyref, and exporting a function as taking <code>anyref</code> as a <code>const char *</code> seems to trigger a link_error in <code>linker.compute_imports</code>. I almost wanted to give up and cast a pointer to i64 and pass that to the host vm, grab the memory from wasmtime and then re-create the memory location to that offset as a workaround, but that is semi-hard in the bindings as they don't depend on an engine context (like it's readily available wasm3/wamr) and just the params/results arrays. This makes for some really ugly solutions.</p>
<p>What is the correct way to expose a method that takes a const char* to wasmtime?<br>
My question would be, is there an example that I could reuse for anyref?</p>



<a name="204801123"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204801123" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204801123">(Jul 23 2020 at 14:04)</a>:</h4>
<p><span class="user-mention" data-user-id="298375">@Alexandru Ene</span> hm I'm not quite sure I understand what the functionality is that you're asking for, can you elaborate on what this <code>const char*</code> is in wamr/wasm3? Perhaps there's some example code I could poke around?</p>



<a name="204801912"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204801912" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexandru Ene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204801912">(Jul 23 2020 at 14:10)</a>:</h4>
<p>So for example you can expose a host VM function that's basically: <code>void PrintMeThisStuff(const char* stuff) { printf("%s\n", stuff); }</code><br>
In WASM3 you need to export it by wrapping it as (it's basically a static function with these params: </p>
<div class="codehilite"><pre><span></span><code>const void* PrintMeThisStuffWrapper(IM3Runtime runtime, uint64_t* _sp, void* _mem) {
   m3ApiGetArgMem(const char*, msg);
   PrintMeThisStuff(msg); //real method called here
}
</code></pre></div>


<p>Then you bind it like so:</p>
<div class="codehilite"><pre><span></span><code>m3_LinkRawFunction(io_module, i_moduleName, i_functionName, &quot;v(*)&quot;, &amp;PrintMeThisStuffWrapper);
</code></pre></div>


<p>WAMR has docs on how to do this: <a href="https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/doc/export_native_api.md">https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/doc/export_native_api.md</a></p>
<p>But for wasmtime, i can't figure out what the equivalent of that would be</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/doc/export_native_api.md" style="background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/doc/export_native_api.md" title="bytecodealliance/wasm-micro-runtime">bytecodealliance/wasm-micro-runtime</a></div><div class="message_embed_description">WebAssembly Micro Runtime (WAMR). Contribute to bytecodealliance/wasm-micro-runtime development by creating an account on GitHub.</div></div></div>



<a name="204802041"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204802041" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204802041">(Jul 23 2020 at 14:11)</a>:</h4>
<p>FWIW those examples look extremely dangerous because they're not doing any validation of the arguments given from wasm</p>



<a name="204802091"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204802091" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexandru Ene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204802091">(Jul 23 2020 at 14:11)</a>:</h4>
<p>WAMR does some, as it forces the size parameter on the pointers</p>



<a name="204802153"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204802153" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204802153">(Jul 23 2020 at 14:12)</a>:</h4>
<p>I believe the wasmtime equivalent is the last example here -- <a href="https://bytecodealliance.github.io/wasmtime/api/wasmtime/struct.Func.html#method.wrap">https://bytecodealliance.github.io/wasmtime/api/wasmtime/struct.Func.html#method.wrap</a></p>



<a name="204802194"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204802194" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204802194">(Jul 23 2020 at 14:12)</a>:</h4>
<p>the wamr/wasm3 examples dont' look like they're actually validating the input provided by wasm</p>



<a name="204802205"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204802205" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204802205">(Jul 23 2020 at 14:12)</a>:</h4>
<p>or the length provided</p>



<a name="204802222"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204802222" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204802222">(Jul 23 2020 at 14:12)</a>:</h4>
<p>to make sure it's actually in-bounds in the wasm linear memory</p>



<a name="204802304"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204802304" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexandru Ene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204802304">(Jul 23 2020 at 14:13)</a>:</h4>
<p>I think WAMR does some checks as they mandate the size to follow that pointer, but didn't dive super deep into their actual implementation.</p>



<a name="204802343"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204802343" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204802343">(Jul 23 2020 at 14:13)</a>:</h4>
<p>hm ok, well in any case this isn't functionality built into wasmtime</p>



<a name="204802377"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204802377" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204802377">(Jul 23 2020 at 14:13)</a>:</h4>
<p>this is something you'll need to do in your <code>Func</code> closure</p>



<a name="204803807"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204803807" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204803807">(Jul 23 2020 at 14:24)</a>:</h4>
<p>it is not what <a href="https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/doc/export_native_api.md#buffer-address-conversion-and-boundary-check">https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/doc/export_native_api.md#buffer-address-conversion-and-boundary-check</a> describes</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/doc/export_native_api.md#buffer-address-conversion-and-boundary-check" style="background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/doc/export_native_api.md#buffer-address-conversion-and-boundary-check" title="bytecodealliance/wasm-micro-runtime">bytecodealliance/wasm-micro-runtime</a></div><div class="message_embed_description">WebAssembly Micro Runtime (WAMR). Contribute to bytecodealliance/wasm-micro-runtime development by creating an account on GitHub.</div></div></div>



<a name="204803898"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204803898" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204803898">(Jul 23 2020 at 14:25)</a>:</h4>
<p>"When passing a pointer address from WASM to native, the address value must be converted to native address before the native function can access it."</p>



<a name="204804516"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204804516" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204804516">(Jul 23 2020 at 14:29)</a>:</h4>
<p>hard to imagine that going from native to WASM will be different</p>



<a name="204807878"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204807878" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexandru Ene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204807878">(Jul 23 2020 at 14:53)</a>:</h4>
<p>Yes, so i want to pass exactly that, pass an address from WASM to native</p>



<a name="204808498"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204808498" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204808498">(Jul 23 2020 at 14:58)</a>:</h4>
<p>do you have to call <code>wasm_runtime_addr_native_to_app</code> for that?</p>



<a name="204808520"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204808520" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexandru Ene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204808520">(Jul 23 2020 at 14:58)</a>:</h4>
<p>What makes this difficult in WASMtime, is that the function wrappers don't take the engine as a parameter, so there is no easy way to query the WASM memory base pointer. <br>
This makes it hard to send a char * (or any pointer to WASM memory) from WASM land into C++ land and access it's contents (as you'd need the base offset, to get to a memory address that works out of the box in C++)<br>
As my second idea was to just send an i32/i64 (the WASM address - basically the wasm memory offset), and together with the base pointer I could re-create a C++ accessible pointer.</p>



<a name="204808797"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204808797" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204808797">(Jul 23 2020 at 15:00)</a>:</h4>
<p>it is hard to judge what WAMR is doing without complete example. Do you have working one?</p>



<a name="204808940"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204808940" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204808940">(Jul 23 2020 at 15:01)</a>:</h4>
<p><span class="user-mention" data-user-id="298375">@Alexandru Ene</span> the <code>Caller</code> type is how wasmtime supports getting the memory's base pointer right now, does that work for you?</p>



<a name="204808962"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204808962" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204808962">(Jul 23 2020 at 15:01)</a>:</h4>
<p>(or <code>wasmtime_caller_t</code> in the C API)</p>



<a name="204816748"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204816748" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexandru Ene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204816748">(Jul 23 2020 at 16:01)</a>:</h4>
<p><span class="user-mention" data-user-id="253994">@Alex Crichton</span>  Yes, if that allows me to get the base memory, I can reconstruct a host-vm accessible pointer from the WASMTIME pointer (offset). So this seems to solve my use-case.</p>



<a name="204816821"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204816821" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexandru Ene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204816821">(Jul 23 2020 at 16:02)</a>:</h4>
<p>I just need to figure out how exactly to set this up, but it sounds promissing. thanks</p>



<a name="204819567"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204819567" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexandru Ene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204819567">(Jul 23 2020 at 16:22)</a>:</h4>
<p>This is pretty cool. Would be interesting to see how this will evolve, as an user the WAMR approach seems sensible, as now everyone has to do the magical translation between address spaces themselves (with the associated risks)<br>
But it would be interesting to mandate a pointer + size like WAMR when passing VM pointers to HOST program</p>



<a name="204819622"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204819622" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexandru Ene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204819622">(Jul 23 2020 at 16:22)</a>:</h4>
<p>Maybe the interface proposal is something to deal with this</p>



<a name="204819733"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204819733" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204819733">(Jul 23 2020 at 16:24)</a>:</h4>
<p>notice that from "native" side wasm pointers are not really "pointer" but just offsets</p>



<a name="204819821"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204819821" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204819821">(Jul 23 2020 at 16:24)</a>:</h4>
<p>so basically I32 for wasm32</p>



<a name="204819987"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204819987" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexandru Ene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204819987">(Jul 23 2020 at 16:25)</a>:</h4>
<p>Yes, what would be interesting is to have these things more enforced (passing raw data over the boundary of VMs)<br>
I am sure things like these are worked on (I'm quite new to WASM in general)<br>
Basically started when I started writing stuff in here <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span></p>



<a name="204820174"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204820174" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexandru Ene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204820174">(Jul 23 2020 at 16:27)</a>:</h4>
<p>But stuff like forcing users to pass a pointer + size always, like WAMR tries to enforce is interesting. Of course you can just pass the offset directly and re-create the actual memory address on the host VM, but it's just easy to do it the "safer" way</p>



<a name="204820182"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204820182" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204820182">(Jul 23 2020 at 16:27)</a>:</h4>
<p>you can choose to do what WASI is doing atm</p>



<a name="204820206"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204820206" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexandru Ene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204820206">(Jul 23 2020 at 16:27)</a>:</h4>
<p>What is that?</p>



<a name="204820321"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204820321" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204820321">(Jul 23 2020 at 16:28)</a>:</h4>
<p>generate wrappers from witx?</p>



<a name="204820390"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204820390" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yury Delendik <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204820390">(Jul 23 2020 at 16:29)</a>:</h4>
<p>but your do_stuff(const char*) signature may not be valid there</p>



<a name="204821012"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204821012" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexandru Ene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204821012">(Jul 23 2020 at 16:33)</a>:</h4>
<p>that's interesting, I will look into it</p>



<a name="204821125"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204821125" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexandru Ene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204821125">(Jul 23 2020 at 16:34)</a>:</h4>
<p>I just thought that WASI functions have basically a special module in WASM engines that exposes some methods just like the other host vm methods</p>



<a name="204821139"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204821139" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexandru Ene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204821139">(Jul 23 2020 at 16:34)</a>:</h4>
<p>I didn't realize that's generated</p>



<a name="204824168"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204824168" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204824168">(Jul 23 2020 at 16:59)</a>:</h4>
<p><span class="user-mention" data-user-id="298375">@Alexandru Ene</span> this blog post might be helpful: <a href="https://radu-matei.com/blog/wasm-api-witx/">https://radu-matei.com/blog/wasm-api-witx/</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://radu-matei.com/blog/wasm-api-witx/" style="background-image: url(https://www.gravatar.com/avatar/031fa2ff2832edcb6b30c8ffb61da4d4?s=256)"></a><div class="data-container"><div class="message_embed_title"><a href="https://radu-matei.com/blog/wasm-api-witx/" title="Writing a simple WASM API layer using interface types and Wasmtime - radu's blog">Writing a simple WASM API layer using interface types and Wasmtime - radu's blog</a></div><div class="message_embed_description">In this short article we explore how to get started with WebAssembly interface types by defining a simple API layer, then implementing that using Wiggle and Wasmtime</div></div></div>



<a name="204824768"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204824768" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexandru Ene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204824768">(Jul 23 2020 at 17:03)</a>:</h4>
<p>Thanks <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p>



<a name="204850413"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204850413" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexandru Ene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204850413">(Jul 23 2020 at 20:34)</a>:</h4>
<p>Oh gosh, so I went back into this after taking a break, so there's a <code>wasmtime_func_callback_t</code> and a <code>wasm_func_callback_t</code> and just the first one supports the caller parameter. I was so confused between these two for a while</p>



<a name="204870681"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/204870681" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexandru Ene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#204870681">(Jul 24 2020 at 01:12)</a>:</h4>
<p>Just an update on this, it works as advised, with a small correction: using <code>wasm_name_new_from_string()</code> with WASMTIME is not a good idea.<br>
The generated names from that function are adding a <code>'\0'</code> to the name, making the rust str&amp; be<code> ['e', 'n', 'v', '\0']</code>.<br>
However, the imports from a WASM module are a str&amp; of just <code>"env"</code>, without a trailing <code>'\0'</code>.</p>
<p>Not sure where the change should be made so this interops nicer (maybe wasmtime can ignore trailing <code>\0</code>s for names?</p>



<a name="205048181"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/205048181" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#205048181">(Jul 26 2020 at 11:28)</a>:</h4>
<p><span class="user-mention" data-user-id="298375">@Alexandru Ene</span> would you mind filing an issue about this? It's possible that this is all by design, but in that case there might still be some documentation that could be improved. Or it's not working as intended and we should indeed fix it <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p>



<a name="205048840"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/205048840" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexandru Ene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#205048840">(Jul 26 2020 at 11:48)</a>:</h4>
<p>It is correct I think, for C++ it makes sense to capture and copy the terminating <code>'\0'</code>. But rust's str&amp; doesn't care about terminating zeros. It's most likely something that can be handled in the wasm_name_t rust wasmtime handling</p>



<a name="205073808"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/205073808" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#205073808">(Jul 27 2020 at 00:34)</a>:</h4>
<p><code>wasm_name_new_from_string</code> is an inline function in the <code>wasm.h</code> header that specifically copies the null when calling <code>wasm_byte_vec_new</code>, so there's not much we can do in Wasmtime.  I'd simply just use <code>wasm_byte_vec_new</code> directly with only the length of the string if the null was undesirable.</p>



<a name="205073904"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/205073904" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#205073904">(Jul 27 2020 at 00:37)</a>:</h4>
<p>i don't quite get the rationale of <code>wasm_name_new_from_string</code> copying the null; the only place in <code>wasm.h</code> that anything is null terminated is <code>wasm_message_t</code> used in traps.</p>



<a name="205074119"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/205074119" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#205074119">(Jul 27 2020 at 00:43)</a>:</h4>
<p>there's also no way for Wasmtime to distinguish a <code>wasm_name_t</code> from a <code>wasm_byte_vec_t</code> as the header defines the <code>wasm_name_t</code> functions in terms of the byte vec functions; that is, of course, assuming <code>wasm_name_t</code> is supposed to be null terminated as there's zero documentation of that.</p>



<a name="205074167"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/205074167" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#205074167">(Jul 27 2020 at 00:44)</a>:</h4>
<p>i'd argue this line: <code>typedef wasm_name_t wasm_message_t;  // null terminated</code> indicating <code>wasm_message_t</code> <em>being</em> null terminated as an indication of <code>wasm_name_t</code> not supposed to be null terminated.</p>



<a name="205074198"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/205074198" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#205074198">(Jul 27 2020 at 00:45)</a>:</h4>
<p>at any rate, I'd first log an issue against the <code>webassembly/c-api</code> repo for some clarity around this since there aren't any actual <code>wasm_name_t</code>-related functions we can implement to distinguish names from byte vecs.  I mean, we <em>could</em> check for null on every function taking a <code>wasm_name_t</code> and trim the underlying slice before handing it to the Rust API, but that seems unnecessary if <code>wasm_name_t</code> isn't supposed to be null terminated (undoc'd APIs = <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span>)</p>



<a name="205074700"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/205074700" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#205074700">(Jul 27 2020 at 01:01)</a>:</h4>
<p>if i had to guess, I'd say the null being copied in <code>wasm_name_new_from_string</code> to be an upstream bug in <code>wasm.h</code>.</p>



<a name="205074766"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/205074766" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Huene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#205074766">(Jul 27 2020 at 01:03)</a>:</h4>
<p>It looks like it <em>is</em> intentional (<a href="https://github.com/WebAssembly/wasm-c-api/pull/34">https://github.com/WebAssembly/wasm-c-api/pull/34</a>) but the way this function is used in this PR it should be called <code>wasm_message_new_from_string</code> as it's only used to create a trap message <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/wasm-c-api/pull/34" style="background-image: url(https://avatars3.githubusercontent.com/u/11578470?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/wasm-c-api/pull/34" title="Turn traps into their own class by rossberg · Pull Request #34 · WebAssembly/wasm-c-api">Turn traps into their own class by rossberg · Pull Request #34 · WebAssembly/wasm-c-api</a></div><div class="message_embed_description">Introduce a reference type wasm::Trap / wasm_trap_t to represent traps (backed by a JS Error instance -- enables them to maintain stack traces etc).
Change Result / wasm_result_t to carry a trap in...</div></div></div>



<a name="205097343"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Exporting%20void%20do_stuff%28const%20char%2A%29%20functions%20to%20wasmtime/near/205097343" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexandru Ene <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Exporting.20void.20do_stuff.28const.20char.2A.29.20functions.20to.20wasmtime.html#205097343">(Jul 27 2020 at 09:42)</a>:</h4>
<p>I opened this: <a href="https://github.com/WebAssembly/wasm-c-api/issues/149">https://github.com/WebAssembly/wasm-c-api/issues/149</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/wasm-c-api/issues/149" style="background-image: url(https://avatars3.githubusercontent.com/u/11578470?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/wasm-c-api/issues/149" title="wasm_name_t clarification · Issue #149 · WebAssembly/wasm-c-api">wasm_name_t clarification · Issue #149 · WebAssembly/wasm-c-api</a></div><div class="message_embed_description">Hello, I stumbled into this problem when using the C-API with WASMTIME. wasmname_t can be created with wasm_name_new_from_string. This function is implemented like so: static inline void wasm_name_...</div></div></div>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>