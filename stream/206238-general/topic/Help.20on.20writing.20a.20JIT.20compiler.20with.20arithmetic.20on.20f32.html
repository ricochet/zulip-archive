<html>
<head><meta charset="utf-8"><title>Help on writing a JIT compiler with arithmetic on f32 · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/index.html">general</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Help.20on.20writing.20a.20JIT.20compiler.20with.20arithmetic.20on.20f32.html">Help on writing a JIT compiler with arithmetic on f32</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="484152324"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Help%20on%20writing%20a%20JIT%20compiler%20with%20arithmetic%20on%20f32/near/484152324" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Farooq <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Help.20on.20writing.20a.20JIT.20compiler.20with.20arithmetic.20on.20f32.html#484152324">(Nov 24 2024 at 13:29)</a>:</h4>
<p>Hello again! It seems that <code>store</code> on <code>r_ptr</code> here has been used wrong. It gives a SEGFAULT. Where am I wrong?</p>
<p><a href="https://codeberg.org/farooqkz/wakegp/src/branch/master/src/compiler.rs#L159">https://codeberg.org/farooqkz/wakegp/src/branch/master/src/compiler.rs#L159</a><br>
<a href="https://codeberg.org/farooqkz/wakegp/src/branch/master/src/compiler.rs#L163">https://codeberg.org/farooqkz/wakegp/src/branch/master/src/compiler.rs#L163</a></p>
<p><code>r_ptr</code> comes from the second argument of the function(see <a href="https://codeberg.org/farooqkz/wakegp/src/branch/master/src/compiler.rs#L76">this</a> and <a href="https://codeberg.org/farooqkz/wakegp/src/branch/master/src/compiler.rs#L188">this</a>). The offset is calculated by the index(<code>r0</code>) multiplied by size of each element in the array(<a href="https://codeberg.org/farooqkz/wakegp/src/branch/master/src/compiler.rs#L188">https://codeberg.org/farooqkz/wakegp/src/branch/master/src/compiler.rs#L188</a>).</p>
<p>Thanks in advance!</p>
<div class="message_embed"><a class="message_embed_image" href="https://codeberg.org/farooqkz/wakegp/src/branch/master/src/compiler.rs#L159" style="background-image: url(&quot;https://uploads.zulipusercontent.net/776324b1528ffb4fde3a7d0cd8261b7c74306dcd/68747470733a2f2f636f6465626572672e6f72672f617661746172732f6133653939613562666333633638303466633062656635386234366663333466&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://codeberg.org/farooqkz/wakegp/src/branch/master/src/compiler.rs#L159" title="wakegp/src/compiler.rs at master">wakegp/src/compiler.rs at master</a></div><div class="message_embed_description">wakegp - Detecting wake words using Linear Genetic Programming</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://codeberg.org/farooqkz/wakegp/src/branch/master/src/compiler.rs#L163" style="background-image: url(&quot;https://uploads.zulipusercontent.net/776324b1528ffb4fde3a7d0cd8261b7c74306dcd/68747470733a2f2f636f6465626572672e6f72672f617661746172732f6133653939613562666333633638303466633062656635386234366663333466&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://codeberg.org/farooqkz/wakegp/src/branch/master/src/compiler.rs#L163" title="wakegp/src/compiler.rs at master">wakegp/src/compiler.rs at master</a></div><div class="message_embed_description">wakegp - Detecting wake words using Linear Genetic Programming</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://codeberg.org/farooqkz/wakegp/src/branch/master/src/compiler.rs#L76" style="background-image: url(&quot;https://uploads.zulipusercontent.net/776324b1528ffb4fde3a7d0cd8261b7c74306dcd/68747470733a2f2f636f6465626572672e6f72672f617661746172732f6133653939613562666333633638303466633062656635386234366663333466&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://codeberg.org/farooqkz/wakegp/src/branch/master/src/compiler.rs#L76" title="wakegp/src/compiler.rs at master">wakegp/src/compiler.rs at master</a></div><div class="message_embed_description">wakegp - Detecting wake words using Linear Genetic Programming</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://codeberg.org/farooqkz/wakegp/src/branch/master/src/compiler.rs#L188" style="background-image: url(&quot;https://uploads.zulipusercontent.net/776324b1528ffb4fde3a7d0cd8261b7c74306dcd/68747470733a2f2f636f6465626572672e6f72672f617661746172732f6133653939613562666333633638303466633062656635386234366663333466&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://codeberg.org/farooqkz/wakegp/src/branch/master/src/compiler.rs#L188" title="wakegp/src/compiler.rs at master">wakegp/src/compiler.rs at master</a></div><div class="message_embed_description">wakegp - Detecting wake words using Linear Genetic Programming</div></div></div>



<a name="484178373"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Help%20on%20writing%20a%20JIT%20compiler%20with%20arithmetic%20on%20f32/near/484178373" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Farooq <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Help.20on.20writing.20a.20JIT.20compiler.20with.20arithmetic.20on.20f32.html#484178373">(Nov 24 2024 at 20:36)</a>:</h4>
<p>The problem was that I had to map a memory and make it executable. I still have other questions. Should I ask here or open a new topic?</p>



<a name="484183886"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Help%20on%20writing%20a%20JIT%20compiler%20with%20arithmetic%20on%20f32/near/484183886" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Help.20on.20writing.20a.20JIT.20compiler.20with.20arithmetic.20on.20f32.html#484183886">(Nov 24 2024 at 22:09)</a>:</h4>
<p>Asking here is fine. Won't get around to answering any questions today (CET) though.</p>



<a name="484356093"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Help%20on%20writing%20a%20JIT%20compiler%20with%20arithmetic%20on%20f32/near/484356093" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Farooq <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Help.20on.20writing.20a.20JIT.20compiler.20with.20arithmetic.20on.20f32.html#484356093">(Nov 25 2024 at 17:29)</a>:</h4>
<p>I cannot find <code>brnz</code> in the docs which is used here:<br>
<a href="https://github.com/Rodrigodd/bf-compiler/blob/master/cranelift-jit/src/main.rs#L219">https://github.com/Rodrigodd/bf-compiler/blob/master/cranelift-jit/src/main.rs#L219</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/Rodrigodd/bf-compiler/blob/master/cranelift-jit/src/main.rs#L219" style="background-image: url(&quot;https://uploads.zulipusercontent.net/acb72b116f08afa31d1f516512cbca4d8da58a98/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f356432393661313665373531346237363233626531343135646231616634633133656438636633326437653339616338626164343732303361663537323163322f526f647269676f64642f62662d636f6d70696c6572&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/Rodrigodd/bf-compiler/blob/master/cranelift-jit/src/main.rs#L219" title="bf-compiler/cranelift-jit/src/main.rs at master · Rodrigodd/bf-compiler">bf-compiler/cranelift-jit/src/main.rs at master · Rodrigodd/bf-compiler</a></div><div class="message_embed_description">Interpreted, optimized, JITed and compiled implementations of the Brainfuck lang. - Rodrigodd/bf-compiler</div></div></div>



<a name="484356368"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Help%20on%20writing%20a%20JIT%20compiler%20with%20arithmetic%20on%20f32/near/484356368" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Farooq <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Help.20on.20writing.20a.20JIT.20compiler.20with.20arithmetic.20on.20f32.html#484356368">(Nov 25 2024 at 17:31)</a>:</h4>
<p>I basically doing an <code>fcmp</code>, if it's true, there will be a jump, either backward or forward within the function(jump offsets are guarrented to be always inside my function). If it's false, there won't be any jump.</p>



<a name="484356560"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Help%20on%20writing%20a%20JIT%20compiler%20with%20arithmetic%20on%20f32/near/484356560" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Farooq <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Help.20on.20writing.20a.20JIT.20compiler.20with.20arithmetic.20on.20f32.html#484356560">(Nov 25 2024 at 17:32)</a>:</h4>
<p>Furthermore, for forward jumps, how can I jump to an address which I've yet to write the instructions for? I mean if I don't have instructions yet, how do I get the jump address?</p>
<p>Edit: nvm this. There is an example in the bf compiler repository.</p>



<a name="484357256"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Help%20on%20writing%20a%20JIT%20compiler%20with%20arithmetic%20on%20f32/near/484357256" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Farooq <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Help.20on.20writing.20a.20JIT.20compiler.20with.20arithmetic.20on.20f32.html#484357256">(Nov 25 2024 at 17:36)</a>:</h4>
<p>hmm it seems that repo is using an ancient version of cranelift :)</p>



<a name="484357773"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Help%20on%20writing%20a%20JIT%20compiler%20with%20arithmetic%20on%20f32/near/484357773" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Farooq <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Help.20on.20writing.20a.20JIT.20compiler.20with.20arithmetic.20on.20f32.html#484357773">(Nov 25 2024 at 17:39)</a>:</h4>
<p>There is <code>br_if</code> and <code>br_table</code>. The first accepts arguments for both the <code>true</code> and <code>else/false</code> cases which does not match in my use case. The latter seems more like it, but I'm unsure if I can do backward jumps with it.</p>



<a name="484471246"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Help%20on%20writing%20a%20JIT%20compiler%20with%20arithmetic%20on%20f32/near/484471246" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Help.20on.20writing.20a.20JIT.20compiler.20with.20arithmetic.20on.20f32.html#484471246">(Nov 26 2024 at 09:46)</a>:</h4>
<p>Clif ir uses basic blocks rather than extended basic blocks, so every branch instruction is always jumps to another block and must be the last instruction in the block. In the backend a jump to the block immediately following the current block will be optimized away though.</p>



<a name="484471331"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Help%20on%20writing%20a%20JIT%20compiler%20with%20arithmetic%20on%20f32/near/484471331" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Help.20on.20writing.20a.20JIT.20compiler.20with.20arithmetic.20on.20f32.html#484471331">(Nov 26 2024 at 09:47)</a>:</h4>
<p>brz/brnz no longer exist and have been replaced by br_if when we moved from extended basic blocks to basic blocks.</p>



<a name="484765217"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Help%20on%20writing%20a%20JIT%20compiler%20with%20arithmetic%20on%20f32/near/484765217" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Farooq <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Help.20on.20writing.20a.20JIT.20compiler.20with.20arithmetic.20on.20f32.html#484765217">(Nov 27 2024 at 17:08)</a>:</h4>
<p>Can you please post an example on how to use do a simple if else statement like in C with cranelift?</p>



<a name="484765529"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Help%20on%20writing%20a%20JIT%20compiler%20with%20arithmetic%20on%20f32/near/484765529" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Help.20on.20writing.20a.20JIT.20compiler.20with.20arithmetic.20on.20f32.html#484765529">(Nov 27 2024 at 17:10)</a>:</h4>
<p>Here's an example of the use of <code>brif</code> in Wasmtime's translation to CLIF: <a href="https://github.com/bytecodealliance/wasmtime/blob/66910067642ce2ddf5509845306508f89a24fc9e/crates/cranelift/src/func_environ.rs#L913">https://github.com/bytecodealliance/wasmtime/blob/66910067642ce2ddf5509845306508f89a24fc9e/crates/cranelift/src/func_environ.rs#L913</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/66910067642ce2ddf5509845306508f89a24fc9e/crates/cranelift/src/func_environ.rs#L913" style="background-image: url(&quot;https://uploads.zulipusercontent.net/a9aa4448d95c1ebadc90fefbec150da1b598108b/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f376431383765306239626333356432333838666137366639656264643136333034333737336134303964643932396631376634393362656239623737636332322f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/66910067642ce2ddf5509845306508f89a24fc9e/crates/cranelift/src/func_environ.rs#L913" title="wasmtime/crates/cranelift/src/func_environ.rs at 66910067642ce2ddf5509845306508f89a24fc9e · bytecodealliance/wasmtime">wasmtime/crates/cranelift/src/func_environ.rs at 66910067642ce2ddf5509845306508f89a24fc9e · bytecodealliance/wasmtime</a></div><div class="message_embed_description">A fast and secure runtime for WebAssembly. Contribute to bytecodealliance/wasmtime development by creating an account on GitHub.</div></div></div>



<a name="484765606"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Help%20on%20writing%20a%20JIT%20compiler%20with%20arithmetic%20on%20f32/near/484765606" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Help.20on.20writing.20a.20JIT.20compiler.20with.20arithmetic.20on.20f32.html#484765606">(Nov 27 2024 at 17:10)</a>:</h4>
<p>note the "continuation block" -- that's a common idiom, if you have what is logically a "one-way branch" (if condition, go somewhere else)</p>



<a name="484765628"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Help%20on%20writing%20a%20JIT%20compiler%20with%20arithmetic%20on%20f32/near/484765628" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Help.20on.20writing.20a.20JIT.20compiler.20with.20arithmetic.20on.20f32.html#484765628">(Nov 27 2024 at 17:10)</a>:</h4>
<p>and note you can create blocks so you have their labels for targets before you fill them in</p>



<a name="484765669"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Help%20on%20writing%20a%20JIT%20compiler%20with%20arithmetic%20on%20f32/near/484765669" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Farooq <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Help.20on.20writing.20a.20JIT.20compiler.20with.20arithmetic.20on.20f32.html#484765669">(Nov 27 2024 at 17:11)</a>:</h4>
<p>Thanks!</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>