<html>
<head><meta charset="utf-8"><title>debug: wasmtime fails to emit global variables · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/index.html">general</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html">debug: wasmtime fails to emit global variables</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="256974400"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/256974400" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#256974400">(Oct 10 2021 at 18:23)</a>:</h4>
<p>g:\dev\test&gt;lldb.exe -- z:\dev\wasm\wasmtime\target\release\wasmtime.exe -g .\test.wasm<br>
(lldb) target create "z:\\dev\\wasm\\wasmtime\\target\\release\\wasmtime.exe"<br>
Current executable set to 'z:\dev\wasm\wasmtime\target\release\wasmtime.exe' (x86_64).<br>
(lldb) settings set -- target.run-args  "-g" ".\\test.wasm"<br>
(lldb) b test.cpp:7<br>
Breakpoint 1: no locations (pending).<br>
WARNING:  Unable to resolve breakpoint to any actual locations.<br>
(lldb) r<br>
Process 13668 launched: 'z:\dev\wasm\wasmtime\target\release\wasmtime.exe' (x86_64)<br>
1 location added to breakpoint 1<br>
Process 13668 stopped</p>
<ul>
<li>thread #1, stop reason = breakpoint 1.1<br>
    frame #0: 0x000001db729814a2 JIT(0x1db74680080)`Thing::Thing(this=(__ptr = 131088), i=5) at test.cpp:9:13<br>
   6    public:<br>
   7       Thing(int i)<br>
   8       {<br>
-&gt; 9          m_i = i;<br>
   10         my_global = i;<br>
   11   //      m_i ++;<br>
   12      }<br>
(lldb) fr v<br>
(WasmtimeVMContext *) __vmctx = 0x000001db72a50080<br>
(WebAssemblyPtrWrapper&lt;Thing&gt;) this = (__ptr = 131088)<br>
(int) i = 5<br>
(lldb) p my_global<br>
error: expression failed to parse:<br>
error: &lt;user expression 0&gt;:1:1: use of undeclared identifier 'my_global'<br>
my_global<br>
^ <a href="/user_uploads/15107/9DnJKvUeXssIjal60QicCXjz/test.cpp">test.cpp</a></li>
</ul>



<a name="256974567"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/256974567" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#256974567">(Oct 10 2021 at 18:26)</a>:</h4>
<p>when I query globals from the lldb API it seems I'm getting another copy of the locals. something's not quite right.</p>



<a name="256974606"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/256974606" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#256974606">(Oct 10 2021 at 18:27)</a>:</h4>
<p>also tried </p>
<p>fr v -g</p>
<p>same result.</p>



<a name="256975827"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/256975827" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#256975827">(Oct 10 2021 at 18:47)</a>:</h4>
<p>Tried native equivalent as sanity check. <br>
correct lldb command : fr v -g</p>
<p>(lldb) b test.cpp:7 <br>
Breakpoint 1: where = test`Thing::Thing(int) + 15 at test.cpp:8:13, address = 0x00000000004011ef<br>
(lldb) r<br>
Process 10008 launched: '/home/x/dev/test/test' (x86_64)<br>
Process 10008 stopped</p>
<ul>
<li>thread #1, name = 'test', stop reason = breakpoint 1.1<br>
    frame #0: 0x00000000004011ef test`Thing::Thing(this=0x0000000000416eb0, i=5) at test.cpp:8:13<br>
   5    public:<br>
   6       Thing(int i) <br>
   7       { <br>
-&gt; 8          m_i = i; <br>
   9          my_global = m_i;<br>
   10           //m_i++;<br>
   11      }<br>
(lldb) fr v<br>
(Thing *) this = 0x0000000000416eb0<br>
(int) i = 5<br>
(lldb) fr v -g<br>
(Thing *) this = 0x0000000000416eb0<br>
(int) i = 5<br>
(unsigned long) ::my_global = 0</li>
</ul>



<a name="257029251"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257029251" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257029251">(Oct 11 2021 at 08:20)</a>:</h4>
<p>Into the code :</p>
<p><a href="http://utils.rs">utils.rs</a> : append_vmctx_info generates DWARF DW_TAG_variable which should expose globals, if any.<br>
That calls build_with_locals in <a href="http://expression.rs">expression.rs</a> to  form a list of things to add to the dwarf data.<br>
An inspect of build_with_locals in <a href="http://expression.rs">expression.rs</a> seems to show locals only are built - no mention of globals.<br>
... which is what we're seeing in the debugger.</p>
<p>Hence initial conclusion is : wasmtime debug mode emits only locals. Global variable export implementation needs to be added.</p>
<p>Disclaimer: rust noob, dwarf noob :)</p>
<p>If I've missed anything, misunderstood, etc. correction welcome. First reading of the code.</p>



<a name="257031366"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257031366" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257031366">(Oct 11 2021 at 08:39)</a>:</h4>
<p>Severity: High. Standard debugging pipeline not complete until this has been resolved.</p>



<a name="257032458"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257032458" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257032458">(Oct 11 2021 at 08:49)</a>:</h4>
<p>we've got parse_global_section in wasmtime\cranelift\wasm\src\sections_translator.rs</p>
<p>perhaps can work from that.</p>



<a name="257037441"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257037441" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257037441">(Oct 11 2021 at 09:34)</a>:</h4>
<p><a href="https://github.com/bytecodealliance/wasmtime/issues/3439">https://github.com/bytecodealliance/wasmtime/issues/3439</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/issues/3439" style="background-image: url(https://opengraph.githubassets.com/4714d10138da4335a5e2d105d90ef37e11a9bd1619da02c80936532d0ef623e9/bytecodealliance/wasmtime/issues/3439)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/issues/3439" title="Cranelift: Debugging JIT dwarf data is missing global variables. · Issue #3439 · bytecodealliance/wasmtime">Cranelift: Debugging JIT dwarf data is missing global variables. · Issue #3439 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">test.cpp int my_global = 4; class Thing { public: Thing(int i) { m_i = i + my_global; } int m_i; }; int main() { auto thing = new Thing(5); return thing-&gt;m_i == 9; } Steps to Reproduce Compile a...</div></div></div>



<a name="257045068"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257045068" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257045068">(Oct 11 2021 at 10:43)</a>:</h4>
<p>(lldb) fr v -g -l </p>
<p>to print globals only, apparently. (globals, no locals).</p>



<a name="257112614"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257112614" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257112614">(Oct 11 2021 at 20:25)</a>:</h4>
<p>pushing my luck, but if I could get a little assistance from a senior dev on this, it'd be appreciated. I'll stumble through it eventually but someone already familiar with rust/dwarf/jit interface could likely close it faster with less chance of errors. not really a noob task. maybe that's a cop out.</p>
<p>then we have a solid debug pipeline afaik. needs more testing but that's the last issue I'm aware of.</p>



<a name="257115861"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257115861" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257115861">(Oct 11 2021 at 20:58)</a>:</h4>
<p>lldb issue - teemperor is reviewer. we get on ok, so maybe I have to throw my lldb is the test argument over there :)</p>



<a name="257116669"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257116669" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257116669">(Oct 11 2021 at 21:05)</a>:</h4>
<p>lldb aside, continued. I guess they want something like this to test it.<br>
<a href="https://llvm.org/docs/DebuggingJITedCode.html">https://llvm.org/docs/DebuggingJITedCode.html</a><br>
then its all within their tech tree. on it when globals issue resolved. essentials first.</p>



<a name="257188999"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257188999" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257188999">(Oct 12 2021 at 11:46)</a>:</h4>
<p>k, we get the rust noob version :)  failing at first fence :)  can't inspect with debugger coz stuff that's being injected is 2 debuggers deep (maybe lldb intercept can be disabled), so its logging. have log on screen with RUST_LOG=trace<br>
far too much I don't want to see &amp; doesn't seem to be a filter other than knowing specific module you want to monitor which I don't yet.</p>
<p>put following in wasmtime\crates\cranelift\src\debug\transform\utils.rs</p>
<p>warn!("TODO: inject_globals_here.");</p>
<p>// Build vmctx_die's DW_TAG_subprogram for <code>set</code> method</p>
<p>Won't even compile :( How do I place logging there plz. Can implement custom file logger if I need to, but first step is to ask if there's a standard way I can log from there. Input welcome :)</p>



<a name="257190278"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257190278" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257190278">(Oct 12 2021 at 11:58)</a>:</h4>
<p>seems a simple println works from there :) progress. if at glacial pace.</p>



<a name="257194518"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257194518" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257194518">(Oct 12 2021 at 12:32)</a>:</h4>
<p>shouldn't be there. learning my way around.</p>



<a name="257198631"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257198631" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257198631">(Oct 12 2021 at 13:02)</a>:</h4>
<p>generate_simulated_dwarf is entrypoint.</p>



<a name="257200008"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257200008" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257200008">(Oct 12 2021 at 13:12)</a>:</h4>
<p>DebugInfoData doesn't seem to contain globals. only locals.</p>



<a name="257217348"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257217348" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257217348">(Oct 12 2021 at 15:00)</a>:</h4>
<p>DebugPubNames/Types is globals ?</p>



<a name="257227188"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257227188" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257227188">(Oct 12 2021 at 16:01)</a>:</h4>
<p>to answer my own q previously, dwarf 4 is generated. says so in transform_dwarf - irrelevant aside.</p>



<a name="257232428"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257232428" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257232428">(Oct 12 2021 at 16:33)</a>:</h4>
<p>only a slight oversight :)</p>



<a name="257234920"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257234920" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257234920">(Oct 12 2021 at 16:50)</a>:</h4>
<p>there's a GlobalVariable thing I've just come across in cranelift. <br>
is that set incorrectly somehow &amp; hence responsible for behaviour we're observing ?</p>



<a name="257239090"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257239090" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257239090">(Oct 12 2021 at 17:17)</a>:</h4>
<p>.</p>



<a name="257249390"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257249390" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257249390">(Oct 12 2021 at 18:24)</a>:</h4>
<p>make_global in <a href="http://func_environ.rs">func_environ.rs</a> is called a few times with apparently zero index each time.</p>



<a name="257249521"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257249521" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257249521">(Oct 12 2021 at 18:25)</a>:</h4>
<p>but as that's passed a function, I don't see how it's globals. so <a href="http://confused.com">confused.com</a></p>



<a name="257249950"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257249950" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257249950">(Oct 12 2021 at 18:28)</a>:</h4>
<p>to cover statics maybe.</p>



<a name="257250180"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257250180" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257250180">(Oct 12 2021 at 18:30)</a>:</h4>
<p>whatever it is, same index each time seems odd. disclaimer: don't understand the code yet, might be fine.</p>



<a name="257251912"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257251912" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257251912">(Oct 12 2021 at 18:42)</a>:</h4>
<p>that's driven by Operator::GlobalSet which apparently is called thru set_global which doesn't show up in a source tree search so still confused.</p>



<a name="257252193"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257252193" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257252193">(Oct 12 2021 at 18:44)</a>:</h4>
<p>seems right place as there's Operator::LocalSet there too. zero index every time sounding fishy, but I don't know how that code is driven.</p>



<a name="257252550"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257252550" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257252550">(Oct 12 2021 at 18:46)</a>:</h4>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/f7543d3d10fee255a2cd7cbb999191168f55b4aa/cranelift/wasm/src/code_translator.rs#L173">https://github.com/bytecodealliance/wasmtime/blob/f7543d3d10fee255a2cd7cbb999191168f55b4aa/cranelift/wasm/src/code_translator.rs#L173</a></p>
<p>Dropped in </p>
<p>println!("Operator::GlobalSet {} ", global_index);</p>
<p>0 each time.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/f7543d3d10fee255a2cd7cbb999191168f55b4aa/cranelift/wasm/src/code_translator.rs#L173" style="background-image: url(https://opengraph.githubassets.com/f1c330f6943073356014ac4633bb937731a0c5bea4a9e574734535c77bc4c982/bytecodealliance/wasmtime)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/f7543d3d10fee255a2cd7cbb999191168f55b4aa/cranelift/wasm/src/code_translator.rs#L173" title="wasmtime/code_translator.rs at f7543d3d10fee255a2cd7cbb999191168f55b4aa · bytecodealliance/wasmtime">wasmtime/code_translator.rs at f7543d3d10fee255a2cd7cbb999191168f55b4aa · bytecodealliance/wasmtime</a></div><div class="message_embed_description">Standalone JIT-style runtime for WebAssembly, using Cranelift - wasmtime/code_translator.rs at f7543d3d10fee255a2cd7cbb999191168f55b4aa · bytecodealliance/wasmtime</div></div></div>



<a name="257252837"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257252837" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257252837">(Oct 12 2021 at 18:48)</a>:</h4>
<p>not called thru set_global, misread. that's some kind of built in I dont understand as rust noob.</p>



<a name="257252854"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257252854" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257252854">(Oct 12 2021 at 18:49)</a>:</h4>
<p>don't know what calls that stuff.</p>



<a name="257253035"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257253035" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257253035">(Oct 12 2021 at 18:50)</a>:</h4>
<p>does rust have an diagnostics magic I can drop in to say who called me, plz ? can't run debugger there without modding lldb for passthrough. will skip that if possible.</p>



<a name="257253115"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257253115" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257253115">(Oct 12 2021 at 18:50)</a>:</h4>
<p>actually, lldb might get me that on linux. native debug broken on windows bcoz pe/pdb code incomplete.</p>



<a name="257254382"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257254382" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257254382">(Oct 12 2021 at 18:59)</a>:</h4>
<p>from my simple test.cpp program, I get : <a href="https://pastebin.com/rNE64Xa9">https://pastebin.com/rNE64Xa9</a></p>
<p>GlobalSet index always 0</p>
<p>Q1: What's calling that ?<br>
Q2: Should it always be 0 ?  Does that sound right ?</p>
<div class="message_embed"><a class="message_embed_image" href="https://pastebin.com/rNE64Xa9" style="background-image: url(https://pastebin.com/i/facebook.png)"></a><div class="data-container"><div class="message_embed_title"><a href="https://pastebin.com/rNE64Xa9" title="Operator::LocalSet 0Operator::LocalSet 2Operator::LocalSet 0Operator::Glob - Pastebin.com">Operator::LocalSet 0Operator::LocalSet 2Operator::LocalSet 0Operator::Glob - Pastebin.com</a></div><div class="message_embed_description">Pastebin.com is the number one paste tool since 2002. Pastebin is a website where you can store text online for a set period of time.</div></div></div>



<a name="257259564"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257259564" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257259564">(Oct 12 2021 at 19:35)</a>:</h4>
<p>Operator::LocalSet 0 <br>
Operator::LocalSet 2 <br>
Operator::LocalSet 1 <br>
Operator::LocalSet 0 <br>
Operator::LocalSet 0 <br>
Operator::LocalSet 1 <br>
Operator::LocalSet 2 <br>
Operator::GlobalSet 0 <br>
Operator::GlobalSet 0 <br>
Operator::LocalSet 2 <br>
Process 16832 stopped</p>
<ul>
<li>thread #10, name = 'wasmtime', stop reason = signal SIGTRAP<br>
    frame #0: 0x00005555561867d5 wasmtime<code>cranelift_wasm::code_translator::translate_operator::h8f0891072d4134db + 68245
wasmtime</code>cranelift_wasm::code_translator::translate_operator::h8f0891072d4134db:<br>
-&gt;  0x5555561867d5 &lt;+68245&gt;: movq   0x1f10(%rsp), %rsi<br>
    0x5555561867dd &lt;+68253&gt;: movq   0x1f38(%rsp), %rax<br>
    0x5555561867e5 &lt;+68261&gt;: movq   (%rax), %rdx<br>
    0x5555561867e8 &lt;+68264&gt;: movq   0x21e0(%rsp), %rax<br>
  thread #12, name = 'wasmtime', stop reason = signal SIGTRAP<br>
    frame #0: 0x00005555561867d5 wasmtime<code>cranelift_wasm::code_translator::translate_operator::h8f0891072d4134db + 68245
wasmtime</code>cranelift_wasm::code_translator::translate_operator::h8f0891072d4134db:<br>
-&gt;  0x5555561867d5 &lt;+68245&gt;: movq   0x1f10(%rsp), %rsi<br>
    0x5555561867dd &lt;+68253&gt;: movq   0x1f38(%rsp), %rax<br>
    0x5555561867e5 &lt;+68261&gt;: movq   (%rax), %rdx<br>
    0x5555561867e8 &lt;+68264&gt;: movq   0x21e0(%rsp), %rax</li>
</ul>
<p>with :</p>
<p>Operator::GlobalSet { global_index } =&gt; {</p>
<div class="codehilite"><pre><span></span><code>        println!(&quot;Operator::GlobalSet {} &quot;, global_index);
            unsafe { std::intrinsics::breakpoint(); }
</code></pre></div>



<a name="257259871"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257259871" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257259871">(Oct 12 2021 at 19:37)</a>:</h4>
<p>index always 0 sounds wrong to me, but still getting head around what's going on.</p>



<a name="257262514"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257262514" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257262514">(Oct 12 2021 at 19:56)</a>:</h4>
<p>added second global to test program to cover case where that index should always be zero. with 2 globals it can't be. I think. <br>
but still always zero. so perhaps root cause.</p>



<a name="257262610"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257262610" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257262610">(Oct 12 2021 at 19:57)</a>:</h4>
<p>&amp; even if we only get 1, we're not seeing it at the other end, so still confused.</p>



<a name="257263834"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257263834" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257263834">(Oct 12 2021 at 20:05)</a>:</h4>
<p>behaviour explained by incomplete code. so maybe that's just how it is. global index bug, not noticed bcoz globals not translated.</p>



<a name="257267163"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257267163" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257267163">(Oct 12 2021 at 20:29)</a>:</h4>
<p>Added some more debug.</p>
<p>In GlobalSet</p>
<div class="codehilite"><pre><span></span><code>               + println!(&quot; builder.ins().store flags:{} val:{} addr:{} offset:{}&quot;, flags, val, addr, offset);
                builder.ins().store(flags, val, addr, offset);
</code></pre></div>

<p>dunno if you can do that, but anyway. seems a little more variety so perhaps ok. unsure where that ends up yet.</p>
<p>Operator::GlobalSet 0<br>
Operator::GlobalSet 0<br>
Operator::GlobalSet 0<br>
 builder.ins().store flags: notrap aligned val:v10 addr:v11 offset:+176<br>
 builder.ins().store flags: notrap aligned val:v10 addr:v11 offset:+176<br>
Operator::GlobalSet 0<br>
 builder.ins().store flags: notrap aligned val:v10 addr:v11 offset:+176<br>
 builder.ins().store flags: notrap aligned val:v7 addr:v8 offset:+176<br>
Operator::GlobalSet 0<br>
 builder.ins().store flags: notrap aligned val:v34 addr:v35 offset:+176<br>
Operator::GlobalSet 0<br>
Operator::GlobalSet 0<br>
 builder.ins().store flags: notrap aligned val:v26 addr:v27 offset:+176<br>
 builder.ins().store flags: notrap aligned val:v34 addr:v35 offset:+176<br>
Operator::GlobalSet 0<br>
 builder.ins().store flags: notrap aligned val:v93 addr:v94 offset:+176<br>
Operator::GlobalSet 0<br>
 builder.ins().store flags: notrap aligned val:v8 addr:v9 offset:+176<br>
Operator::GlobalSet 0<br>
 builder.ins().store flags: notrap aligned val:v8 addr:v9 offset:+176<br>
Operator::GlobalSet 0<br>
 builder.ins().store flags: notrap aligned val:v53 addr:v54 offset:+176<br>
Operator::GlobalSet 0<br>
 builder.ins().store flags: notrap aligned val:v2316 addr:v2317 offset:+176</p>



<a name="257268145"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257268145" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257268145">(Oct 12 2021 at 20:36)</a>:</h4>
<p>made one a float, everything still comes thru as i32. so not a clue what's going on yet.</p>



<a name="257268202"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257268202" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257268202">(Oct 12 2021 at 20:36)</a>:</h4>
<p>silence is weird. don't some folks know how this stuff works ?</p>



<a name="257318541"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257318541" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257318541">(Oct 13 2021 at 06:42)</a>:</h4>
<p>switched from cpp test to absolute basic c test.</p>
<p>test.c</p>
<p>float my_global_float = 2.5f;</p>
<p>int main() {<br>
   return (int)(my_global_float);<br>
}</p>
<p>nothing coming thru,  so the globals I was seeing were probably runtime built-in stuff.</p>



<a name="257318633"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257318633" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257318633">(Oct 13 2021 at 06:44)</a>:</h4>
<p>&amp; dwarf-dump:</p>
<p>.\test.wasm:    file format WASM</p>
<p>.debug_info contents:<br>
0x00000000: Compile Unit: length = 0x0000005a, format = DWARF32, version = 0x0004, abbr_offset = 0x0000, addr_size = 0x04 (next unit at 0x0000005e)</p>
<p>0x0000000b: DW_TAG_compile_unit<br>
              DW_AT_producer    ("clang version 11.0.0 (<a href="https://github.com/llvm/llvm-project">https://github.com/llvm/llvm-project</a> 176249bd6732a8044d457092ed932768724a6f06)")<br>
              DW_AT_language    (DW_LANG_C99)<br>
              DW_AT_name    ("test.c")<br>
              DW_AT_stmt_list   (0x00000000)<br>
              DW_AT_comp_dir    ("g:\\dev\\test")<br>
              DW_AT_low_pc  (0x0000002f)<br>
              DW_AT_high_pc (0x000000a4)</p>
<p>0x00000026:   DW_TAG_variable<br>
                DW_AT_name  ("my_global_float")<br>
                DW_AT_type  (0x00000037 "float")<br>
                DW_AT_external  (true)<br>
                DW_AT_decl_file ("g:\dev\test\.\test.c")<br>
                DW_AT_decl_line (1)<br>
                DW_AT_location  (DW_OP_addr 0x400)</p>
<p>0x00000037:   DW_TAG_base_type<br>
                DW_AT_name  ("float")<br>
                DW_AT_encoding  (DW_ATE_float)<br>
                DW_AT_byte_size (0x04)</p>
<p>0x0000003e:   DW_TAG_base_type<br>
                DW_AT_name  ("int")<br>
                DW_AT_encoding  (DW_ATE_signed)<br>
                DW_AT_byte_size (0x04)</p>
<p>0x00000045:   DW_TAG_subprogram<br>
                DW_AT_low_pc    (0x0000002f)<br>
                DW_AT_high_pc   (0x000000a4)<br>
                DW_AT_frame_base    (DW_OP_WASM_location 0x0 0x2, DW_OP_stack_value)<br>
                DW_AT_name  ("main")<br>
                DW_AT_decl_file ("g:\dev\test\.\test.c")<br>
                DW_AT_decl_line (3)<br>
                DW_AT_type  (0x0000003e "int")<br>
                DW_AT_external  (true)</p>
<p>0x0000005d:   NULL</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/llvm/llvm-project" style="background-image: url(https://opengraph.githubassets.com/b4b1ab4e1f68f3758f83fdc1f47887249f635fafef1e30addf1eea262cc266ad/llvm/llvm-project)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/llvm/llvm-project" title="GitHub - llvm/llvm-project: The LLVM Project is a collection of modular and reusable compiler and toolchain technologies. Note: the repository does not accept github pull requests at this moment. Please submit your patches at http://reviews.llvm.org.">GitHub - llvm/llvm-project: The LLVM Project is a collection of modular and reusable compiler and toolchain technologies. Note: the repository does not accept github pull requests at this moment. Please submit your patches at http://reviews.llvm.org.</a></div><div class="message_embed_description">The LLVM Project is a collection of modular and reusable compiler and toolchain technologies. Note: the repository does not accept github pull requests at this moment. Please submit your patches at...</div></div></div>



<a name="257320846"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257320846" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257320846">(Oct 13 2021 at 07:10)</a>:</h4>
<p>that test too simple apparently, even with opts off its eliminated global somehow.</p>
<p>so went with test.c :</p>
<p>float my_global_float = 2.5f;</p>
<p>float my_func()<br>
{<br>
    return my_global_float;<br>
}</p>
<p>int main() <br>
{<br>
   return (int) my_func();<br>
}</p>
<p>which generates this :</p>
<p>GlobalVariable::Memory gv:gv3 ty:i32<br>
 builder.ins().store flags: notrap aligned val:v9 addr:v10 offset:+96<br>
Operator::GlobalSet 0<br>
GlobalVariable::Memory gv:gv3 ty:i32<br>
 builder.ins().store flags: notrap aligned val:v25 addr:v26 offset:+96</p>



<a name="257320919"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257320919" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257320919">(Oct 13 2021 at 07:11)</a>:</h4>
<p>2 global references, both i32. can't see how that's right.</p>



<a name="257325915"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257325915" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257325915">(Oct 13 2021 at 08:01)</a>:</h4>
<p>workaround: to inspect globals in debugger, load a reference into a local &amp; inspect that. compile works, debug currently has a gap.</p>



<a name="257353853"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257353853" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257353853">(Oct 13 2021 at 12:09)</a>:</h4>
<p>yury - you're quiet :) any advice ?</p>



<a name="257354270"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257354270" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257354270">(Oct 13 2021 at 12:13)</a>:</h4>
<p>@mozilla - can we get a tiny bit of yury time on this, please (if he's willing) ? its quite hard.</p>



<a name="257354456"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257354456" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257354456">(Oct 13 2021 at 12:14)</a>:</h4>
<p>fixing this effectively unlocks wasmtime as far as I can see. aside from exceptions, which can wait (our use case anyway), we can go into production with this once debugging is solid. arguably now, though prefer it not to be wonky.</p>



<a name="257354575"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257354575" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257354575">(Oct 13 2021 at 12:15)</a>:</h4>
<p>we run with wasmtime in production, hopefully prove it solid, then it drops into firefox later. everyone wins.</p>



<a name="257355358"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257355358" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257355358">(Oct 13 2021 at 12:21)</a>:</h4>
<p>last thing stopping this being wasmtime 1.0 unless there are any other mvp gaps I'm unaware of.</p>



<a name="257356135"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257356135" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257356135">(Oct 13 2021 at 12:26)</a>:</h4>
<p>&amp; if I'm understanding correctly, appears gap is all the way into cranelift which isn't parsing debug globals correctly.  perhaps requires multiple seniors to resolve.</p>



<a name="257357123"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257357123" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257357123">(Oct 13 2021 at 12:34)</a>:</h4>
<p>even further into basics. can we run a standalone cranelift test to determine what its doing with debug parsing of globals. surprised this hasn't been tested, but its like that with all bugs - the thing you didn't think about.</p>



<a name="257360338"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257360338" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257360338">(Oct 13 2021 at 12:58)</a>:</h4>
<p>to get a sane debug/devel environment for this, seems we need a test program that loads a wasm then calls build_artifacts on it.<br>
that should detect &amp; reference globals.</p>



<a name="257390724"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257390724" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257390724">(Oct 13 2021 at 15:59)</a>:</h4>
<p>all this : <a href="https://docs.wasmtime.dev/api/wasmtime/struct.Global.html">https://docs.wasmtime.dev/api/wasmtime/struct.Global.html</a></p>
<p>so perhaps gap is smaller than feared. we'll see :)</p>
<p>can step thru a rust test app now have decoupled from lldb so can see what's going on.</p>



<a name="257392478"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257392478" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257392478">(Oct 13 2021 at 16:09)</a>:</h4>
<p>A little progress.<br>
Put following wasmtime/rust API test program together, based on introductory sample.</p>
<p><a href="https://pastebin.com/VLqtSedR">https://pastebin.com/VLqtSedR</a></p>
<p>test.c</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">float</span><span class="w"> </span><span class="n">my_global</span><span class="o">=</span><span class="mi">5</span><span class="p">;</span><span class="w"></span>

<span class="n">void</span><span class="w"> </span><span class="n">mytest</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">my_global</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">my_global</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>The global is located :)</p>
<div class="message_embed"><a class="message_embed_image" href="https://pastebin.com/VLqtSedR" style="background-image: url(https://pastebin.com/i/facebook.png)"></a><div class="data-container"><div class="message_embed_title"><a href="https://pastebin.com/VLqtSedR" title="use anyhow::Result;use wasmtime::*;fn main() -&gt; Result&lt;()&gt; {    let - Pastebin.com">use anyhow::Result;use wasmtime::*;fn main() -&gt; Result&lt;()&gt; {    let - Pastebin.com</a></div><div class="message_embed_description">Pastebin.com is the number one paste tool since 2002. Pastebin is a website where you can store text online for a set period of time.</div></div></div>



<a name="257407736"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257407736" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257407736">(Oct 13 2021 at 17:46)</a>:</h4>
<p>so ... ummm ... cranelift exposes, so dwarf conversion issue. if only we had an expert on that we could borrow for an hour or two with many beers owed :)</p>



<a name="257408491"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257408491" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257408491">(Oct 13 2021 at 17:51)</a>:</h4>
<p>could be an export issue. had to export-all for this test app,  haven't done so previously so will check if the issue.</p>



<a name="257409298"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257409298" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257409298">(Oct 13 2021 at 17:56)</a>:</h4>
<p>is that the issue ? is cranelift only passing on exported globals ? </p>
<p>that's valid for standard runtime but not for debug mode. debug mode should get everything.</p>



<a name="257409865"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257409865" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257409865">(Oct 13 2021 at 17:59)</a>:</h4>
<p>my test app has debug mode set.</p>



<a name="257412253"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257412253" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257412253">(Oct 13 2021 at 18:15)</a>:</h4>
<p>early in testing but cranelift seems to propagate all with clang -Wl,--export-all <br>
without it, not getting even the function.<br>
so export-all appears to be cranelift workaround. whether it goes anywhere from there, don't yet know.</p>



<a name="257412405"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257412405" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257412405">(Oct 13 2021 at 18:16)</a>:</h4>
<p>this needs verifying. to avoid us going off on wrong tangents.</p>



<a name="257413957"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257413957" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257413957">(Oct 13 2021 at 18:26)</a>:</h4>
<p>bit early as still not 100% sure but anyhow, here's test files : <a href="http://advance-software.com/misc/wasmtime_test.zip">http://advance-software.com/misc/wasmtime_test.zip</a></p>
<p>wasm shell scipts a bit off as resolving on windows, but is simple stuff. a hardwired path to fix up.</p>



<a name="257413999"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257413999" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257413999">(Oct 13 2021 at 18:26)</a>:</h4>
<p>extract same level as wasmtime, not inside that tree.</p>



<a name="257414552"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257414552" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257414552">(Oct 13 2021 at 18:30)</a>:</h4>
<p>path is Module::from_file in <a href="http://main.rs">main.rs</a> to where your test wasm is.</p>



<a name="257516553"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257516553" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257516553">(Oct 14 2021 at 11:05)</a>:</h4>
<p>weird. if I export anything, can't get lldb to hit a breakpoint. so workaround won't work, so gotta figure out why its doing that.</p>



<a name="257540575"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257540575" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257540575">(Oct 14 2021 at 14:04)</a>:</h4>
<p>looking at wasmtime\crates\environ\src\module_environ.rs</p>
<p>Payload::ExportSection(exports) - noticing my global ends up in there.</p>
<p>next up, see if I can follow it into Payload::GlobalSection(globals) </p>
<p>&amp; then figure out how we hook into that so we don't have export constraint.</p>



<a name="257541550"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257541550" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257541550">(Oct 14 2021 at 14:10)</a>:</h4>
<p>still no fan of rust. looking forwards to getting back to c++ :)</p>



<a name="257549926"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257549926" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257549926">(Oct 14 2021 at 15:00)</a>:</h4>
<p>any fixes for variable is optimized away (visual studio, rust debugging), following "cargo build" which is debug config, plz.</p>
<p>the friction to new amazing system is bits are still wonky.</p>



<a name="257551411"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257551411" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257551411">(Oct 14 2021 at 15:09)</a>:</h4>
<p><a href="https://www.reddit.com/r/rust/comments/fr7s7f/whats_the_latest_on_overoptimization_in_debug/">https://www.reddit.com/r/rust/comments/fr7s7f/whats_the_latest_on_overoptimization_in_debug/</a></p>
<p>seems a known issue. an aside. can work around it. will use my own debugger gui soon :)</p>



<a name="257559745"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257559745" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257559745">(Oct 14 2021 at 16:00)</a>:</h4>
<p>in build_artifacts , engine.config().tunables</p>
<p>parse_wasm_debuginfo is false. that seems wrong.</p>



<a name="257561012"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257561012" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257561012">(Oct 14 2021 at 16:07)</a>:</h4>
<p>experimental - might not be this, we'll see.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">debug_info</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">enable</span>: <span class="kt">bool</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">tunables</span><span class="p">.</span><span class="n">generate_native_debuginfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">enable</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="c1">// ADV_SW_PATCH[experimental]:</span>
<span class="w">        </span><span class="c1">// Required so we are able to emit globals - have to parse them so we know what to emit :)</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">tunables</span><span class="p">.</span><span class="n">parse_wasm_debuginfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">enable</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="bp">self</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="257565308"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257565308" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257565308">(Oct 14 2021 at 16:35)</a>:</h4>
<p>not seeing test app global float getting parsed even with that. think there's implementation missing but don't fully comprehend the parser yet.</p>



<a name="257565738"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257565738" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257565738">(Oct 14 2021 at 16:38)</a>:</h4>
<p>we've got this thing :</p>
<p>use wasmparser::{<br>
    self, Data, DataKind, DataSectionReader, Element, ElementItem, ElementItems, ElementKind,<br>
    ElementSectionReader, Export, ExportSectionReader, ExternalKind, FunctionSectionReader,<br>
    GlobalSectionReader, GlobalType, ImportSectionEntryType, ImportSectionReader,<br>
    MemorySectionReader, MemoryType, NameSectionReader, Naming, Operator, TableSectionReader,<br>
    TableType, TagSectionReader, TagType, TypeDef, TypeSectionReader,<br>
};</p>



<a name="257565885"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257565885" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257565885">(Oct 14 2021 at 16:40)</a>:</h4>
<p>&amp; this which we want registering in .debug_info section.</p>
<p>0x00000026:   DW_TAG_variable [2]  <br>
                DW_AT_name [DW_FORM_strp]   ( .debug_str[0x00000078] = "my_global")<br>
                DW_AT_type [DW_FORM_ref4]   (cu + 0x0037 =&gt; {0x00000037} "float")<br>
                DW_AT_external [DW_FORM_flag_present]   (true)<br>
                DW_AT_decl_file [DW_FORM_data1] ("g:\dev\test\.\test.c")<br>
                DW_AT_decl_line [DW_FORM_data1] (1)<br>
                DW_AT_location [DW_FORM_exprloc]    (DW_OP_addr 0x400)</p>



<a name="257566034"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257566034" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257566034">(Oct 14 2021 at 16:40)</a>:</h4>
<p>I'm not clear if that should run through GlobalSectionReader or TagSectionReader.</p>



<a name="257566096"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257566096" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257566096">(Oct 14 2021 at 16:41)</a>:</h4>
<p>or some other.</p>



<a name="257566934"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257566934" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257566934">(Oct 14 2021 at 16:46)</a>:</h4>
<p>slow, but I think we're making progress. not so scary now, just working thru it.</p>



<a name="257578128"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257578128" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257578128">(Oct 14 2021 at 17:59)</a>:</h4>
<p>debug_info section containing the variable we want is handled via register_dwarf_section, via Payload::CustomSection.</p>



<a name="257579685"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257579685" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257579685">(Oct 14 2021 at 18:09)</a>:</h4>
<p>that ends up in ModuleEnvironment : self.results[0].debuginfo.dwarf.debug_info.debug_info_section</p>
<p>&amp; isn't parsed - just reference to the section location &amp; length  - at that point anyway.</p>
<p>I guess we follow that up to the emit. unsure how we morph from wasm dwarf to target dwarf but it must be in there somewhere as the rest does it.</p>



<a name="257580322"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257580322" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257580322">(Oct 14 2021 at 18:13)</a>:</h4>
<p>has_unparsed_debuginfo flag is badly named. the debuginfo section isn't parsed, its just registered.</p>



<a name="257582359"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257582359" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257582359">(Oct 14 2021 at 18:28)</a>:</h4>
<p>so ... we can parse the debug info section, even if it means writing that code from scratch, we can somehow map from wasm addresses to target addresses &amp; we can emit dwarf. so we can do this :)</p>



<a name="257584060"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257584060" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257584060">(Oct 14 2021 at 18:39)</a>:</h4>
<p>&amp; we've got this thing in use already : <a href="https://github.com/gimli-rs/gimli">https://github.com/gimli-rs/gimli</a></p>
<p>Loc is terrible abbreviation in that as initially thought it meant local when it in fact means location. code doesn't run faster with shorter variable names :) just write out the whole word.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/gimli-rs/gimli" style="background-image: url(https://opengraph.githubassets.com/465da2dae2e4eb6b382959b2537db2831776ee67df9d545a178d10903793e75c/gimli-rs/gimli)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/gimli-rs/gimli" title="GitHub - gimli-rs/gimli: A blazing fast library for consuming the DWARF debugging format">GitHub - gimli-rs/gimli: A blazing fast library for consuming the DWARF debugging format</a></div><div class="message_embed_description">A blazing fast library for consuming the DWARF debugging format - GitHub - gimli-rs/gimli: A blazing fast library for consuming the DWARF debugging format</div></div></div>



<a name="257589811"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257589811" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257589811">(Oct 14 2021 at 19:17)</a>:</h4>
<p>can gimli decode debuginfo section to extract global DW_TAG_variable entities ?<br>
if not, we can implement as necessary.</p>



<a name="257589851"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257589851" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257589851">(Oct 14 2021 at 19:17)</a>:</h4>
<p><a href="https://github.com/gimli-rs/gimli">https://github.com/gimli-rs/gimli</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/gimli-rs/gimli" style="background-image: url(https://opengraph.githubassets.com/465da2dae2e4eb6b382959b2537db2831776ee67df9d545a178d10903793e75c/gimli-rs/gimli)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/gimli-rs/gimli" title="GitHub - gimli-rs/gimli: A blazing fast library for consuming the DWARF debugging format">GitHub - gimli-rs/gimli: A blazing fast library for consuming the DWARF debugging format</a></div><div class="message_embed_description">A blazing fast library for consuming the DWARF debugging format - GitHub - gimli-rs/gimli: A blazing fast library for consuming the DWARF debugging format</div></div></div>



<a name="257590061"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257590061" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257590061">(Oct 14 2021 at 19:19)</a>:</h4>
<p>:)</p>
<p><a href="https://github.com/gimli-rs/gimli/blob/master/examples/simple_line.rs">https://github.com/gimli-rs/gimli/blob/master/examples/simple_line.rs</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/gimli-rs/gimli/blob/master/examples/simple_line.rs" style="background-image: url(https://opengraph.githubassets.com/465da2dae2e4eb6b382959b2537db2831776ee67df9d545a178d10903793e75c/gimli-rs/gimli)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/gimli-rs/gimli/blob/master/examples/simple_line.rs" title="gimli/simple_line.rs at master · gimli-rs/gimli">gimli/simple_line.rs at master · gimli-rs/gimli</a></div><div class="message_embed_description">A blazing fast library for consuming the DWARF debugging format - gimli/simple_line.rs at master · gimli-rs/gimli</div></div></div>



<a name="257590366"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257590366" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257590366">(Oct 14 2021 at 19:20)</a>:</h4>
<p>that's me on hold until next week with this as real life calls, but feel free to carry on if the mood takes anyone :)</p>



<a name="257591904"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257591904" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257591904">(Oct 14 2021 at 19:30)</a>:</h4>
<p>looks like you need to load &amp; parse each top level DW_TAG_variable yourself, but that's not so hard.</p>



<a name="257592180"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257592180" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257592180">(Oct 14 2021 at 19:32)</a>:</h4>
<p>function statics are also technically globals but assuming function locals deliver those. should verify.</p>



<a name="257592411"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257592411" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257592411">(Oct 14 2021 at 19:34)</a>:</h4>
<p>&amp; that load/parse should probably end up in gimli so its there for the next guy.</p>



<a name="257680556"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257680556" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257680556">(Oct 15 2021 at 11:10)</a>:</h4>
<p>back to it, weekend off cancelled. this needs nailing anyway.</p>



<a name="257686373"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257686373" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257686373">(Oct 15 2021 at 12:02)</a>:</h4>
<p>if a global is at some memory location in input wasm, is it at same location in emitted wasm ? that'd make it easy &amp; can't think why it'd need to be different unless there are different alignment constraints.</p>



<a name="257688227"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257688227" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257688227">(Oct 15 2021 at 12:18)</a>:</h4>
<p>emit_dwarf takes a debug_info so if I can figure out where the globals section is going, it feeds into that &amp; almost done.</p>



<a name="257690273"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257690273" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257690273">(Oct 15 2021 at 12:35)</a>:</h4>
<p>have no idea what GlobalSection stuff is all about. our global doesn't end up there. seems to be used for some kind of built ins only.</p>



<a name="257690366"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/debug%3A%20wasmtime%20fails%20to%20emit%20global%20variables/near/257690366" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Williams <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/debug.3A.20wasmtime.20fails.20to.20emit.20global.20variables.html#257690366">(Oct 15 2021 at 12:36)</a>:</h4>
<p>this code is really light on comments. too much so imo.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>