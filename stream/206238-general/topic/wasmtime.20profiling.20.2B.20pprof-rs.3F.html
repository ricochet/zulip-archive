<html>
<head><meta charset="utf-8"><title>wasmtime profiling + pprof-rs? · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/index.html">general</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime.20profiling.20.2B.20pprof-rs.3F.html">wasmtime profiling + pprof-rs?</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="471938354"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime%20profiling%20%2B%20pprof-rs%3F/near/471938354" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xinyu Zeng <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime.20profiling.20.2B.20pprof-rs.3F.html#471938354">(Sep 21 2024 at 13:00)</a>:</h4>
<p>Is there any way we can use the wasmtime profiler together with <a href="https://github.com/tikv/pprof-rs">https://github.com/tikv/pprof-rs</a> ? The problem is that I am using the Rust API and directly calling <code>perf</code> cannot only profile some parts of the code. pprof-rs has that function but it seems we cannot use them together.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/tikv/pprof-rs" style="background-image: url(&quot;https://uploads.zulipusercontent.net/b934e44fab9e1ecda52505232812b0d65e34fbfc/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f383931343063643830633035393036376238343965373930636535623365353265623438316262353861376339393061353533373930353133393734343830392f74696b762f7070726f662d7273&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/tikv/pprof-rs" title="GitHub - tikv/pprof-rs: A Rust CPU profiler implemented with the help of backtrace-rs">GitHub - tikv/pprof-rs: A Rust CPU profiler implemented with the help of backtrace-rs</a></div><div class="message_embed_description">A Rust CPU profiler implemented with the help of backtrace-rs - tikv/pprof-rs</div></div></div>



<a name="471939098"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime%20profiling%20%2B%20pprof-rs%3F/near/471939098" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime.20profiling.20.2B.20pprof-rs.3F.html#471939098">(Sep 21 2024 at 13:09)</a>:</h4>
<p>Perf allows jit engines to create a file with all debuginfo and then when processing the profile it will read this jit engine generated file to handle the debuginfo for the code generated by the jit engine. It seems that pprof doesn't support reading this file.</p>



<a name="471939572"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime%20profiling%20%2B%20pprof-rs%3F/near/471939572" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime.20profiling.20.2B.20pprof-rs.3F.html#471939572">(Sep 21 2024 at 13:14)</a>:</h4>
<p>A bit of a hack, but maybe launching <code>perf record -p $your_own_pid</code> from within your program right before the point where you want to start recording and killing it when you want to stop recording would work? You probably need to add a sleep of a couple of ms after the starting perf to account for the time it takes for perf to initialize and starts creating a profile.</p>



<a name="471939778"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime%20profiling%20%2B%20pprof-rs%3F/near/471939778" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime.20profiling.20.2B.20pprof-rs.3F.html#471939778">(Sep 21 2024 at 13:17)</a>:</h4>
<p>Also make sure to use either <code>config.profiler(ProfilingStrategy::PerfMap)</code> or <code>config.profiler(ProfilingStrategy::JitDump)</code> to generate the aformentioned debuginfo file. The <code>PerfMap</code> option produces smaller files, but only includes function names, while the <code>JitDump</code> option produces larger files, but includes a lot more debuginfo (including line info I believe) and requires you to run <code>perf inject --jit</code> on the profile file to merge the jitdump file into the profile file.</p>



<a name="471943132"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime%20profiling%20%2B%20pprof-rs%3F/near/471943132" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xinyu Zeng <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime.20profiling.20.2B.20pprof-rs.3F.html#471943132">(Sep 21 2024 at 13:56)</a>:</h4>
<p>Thanks a lot! I grouped the wasm function calls I want to profile inside a function so I can view them in flamegraph inside that function stack. A similar hack :)</p>



<a name="471951381"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/wasmtime%20profiling%20%2B%20pprof-rs%3F/near/471951381" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/wasmtime.20profiling.20.2B.20pprof-rs.3F.html#471951381">(Sep 21 2024 at 15:34)</a>:</h4>
<p>I'm not familiar with pprof-rs itself but it looks like to integrate with that directly it would require walking the stack from a signal handler. In theory the DWARF that Wasmtime emits for Cranelift-generated code supports this because we use frame pointers for all functions and otherwise only have to describe the prologue (which I think we do correctly). In that sense in theory it should work (so long as <code>backtrace</code> works from a signal handler, which I thought it didn't...). </p>
<p>By default though if you're just using dwarf unwind tables for jit code you probably won't have good symbols for cranelift-generated code, so if profile collection works you'd likely still need to perform a postprocessing step to symbolicate what was found in cranelift. That's something that we don't provide many APIs for today (e.g. the <code>Module</code> type can't be used for that) but there's no reason we couldn't add more support for that since Wasmtime already does it internally</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>