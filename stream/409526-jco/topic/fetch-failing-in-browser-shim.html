<html>
<head><meta charset="utf-8"><title>fetch-failing-in-browser-shim · jco · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/409526-jco/index.html">jco</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/409526-jco/topic/fetch-failing-in-browser-shim.html">fetch-failing-in-browser-shim</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="490469447"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/409526-jco/topic/fetch-failing-in-browser-shim/near/490469447" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/409526-jco/topic/fetch-failing-in-browser-shim.html#490469447">(Dec 23 2024 at 07:52)</a>:</h4>
<p><a href="#narrow/channel/409526-jco/topic/fetch-failing-in-browser-shim/near/490280389">A message</a> was moved here from <a class="stream-topic" data-stream-id="409526" href="/#narrow/channel/409526-jco/topic/Basic.20hello-wasi-http-js.20sample.20from.20ground.20up">#jco &gt; Basic hello-wasi-http-js sample from ground up</a> by <span class="user-mention silent" data-user-id="598440">Victor Adossi</span>.</p>



<a name="490473744"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/409526-jco/topic/fetch-failing-in-browser-shim/near/490473744" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Victor Adossi <a href="https://bytecodealliance.github.io/zulip-archive/stream/409526-jco/topic/fetch-failing-in-browser-shim.html#490473744">(Dec 23 2024 at 08:20)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="527396">@Thomas Wang</span> just moved your issue over to a something new so it's easier for people to find, repro and hopefully help with!</p>
<p>Have you tried without bundling? I'm wondering if <code>esbuild</code> isn't taking in dependencies it should be.</p>
<p>I actually just got your example working, will push up a repo shortly.</p>



<a name="490477595"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/409526-jco/topic/fetch-failing-in-browser-shim/near/490477595" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Victor Adossi <a href="https://bytecodealliance.github.io/zulip-archive/stream/409526-jco/topic/fetch-failing-in-browser-shim.html#490477595">(Dec 23 2024 at 08:47)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="527396">@Thomas Wang</span> check out this repo for my working example -- I'm not sure exactly what's getting caught up in your Webpack setup, but hopefully it's helpful to you:</p>
<p><a href="https://github.com/vados-cosmonic/jco-browser-fetch-example">https://github.com/vados-cosmonic/jco-browser-fetch-example</a></p>
<p>PRs welcome to that repo -- I'll try and add it as an official <a href="https://github.com/bytecodealliance/jco/tree/main/examples"><code>jco</code> example</a> sometime!</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/vados-cosmonic/jco-browser-fetch-example" style="background-image: url(&quot;https://uploads.zulipusercontent.net/1a110c18f71ebe11ac7f8e3fc5f10249318f197e/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f343736666563303464396565356230643739303536393332306564343731343465653564636666363137303631333765643232323835323739616231363632612f7661646f732d636f736d6f6e69632f6a636f2d62726f777365722d66657463682d6578616d706c65&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/vados-cosmonic/jco-browser-fetch-example" title="GitHub - vados-cosmonic/jco-browser-fetch-example: Example of using jco with browser-powered fetch()">GitHub - vados-cosmonic/jco-browser-fetch-example: Example of using jco with browser-powered fetch()</a></div><div class="message_embed_description">Example of using jco with browser-powered fetch(). Contribute to vados-cosmonic/jco-browser-fetch-example development by creating an account on GitHub.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/jco/tree/main/examples" style="background-image: url(&quot;https://uploads.zulipusercontent.net/04163901ed725ba74005f32efec91d8c25d96bae/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f616163393736616533316637373637356238633030393262316534373130363966393531386533656439663466346538323430393665316266343066326132372f62797465636f6465616c6c69616e63652f6a636f&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/jco/tree/main/examples" title="jco/examples at main · bytecodealliance/jco">jco/examples at main · bytecodealliance/jco</a></div><div class="message_embed_description">JavaScript toolchain for working with WebAssembly Components - bytecodealliance/jco</div></div></div>



<a name="490478067"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/409526-jco/topic/fetch-failing-in-browser-shim/near/490478067" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Victor Adossi <a href="https://bytecodealliance.github.io/zulip-archive/stream/409526-jco/topic/fetch-failing-in-browser-shim.html#490478067">(Dec 23 2024 at 08:50)</a>:</h4>
<p>Oh also, as far as bundling goes, we do have an example over in wasmCloud (a project I'm a maintainer of &amp; whose stewarding corporate entity I currently work for):</p>
<p><a href="https://github.com/wasmCloud/wasmCloud/blob/main/examples/typescript/components/http-password-checker/rollup.config.mjs">https://github.com/wasmCloud/wasmCloud/blob/main/examples/typescript/components/http-password-checker/rollup.config.mjs</a></p>
<p>Just to be clear -- you <em>do not</em> need to use anything related to wasmCloud there or even glance at the other parts of the example -- I link it here only because it's a good example of a working Rollup config <em>with</em> external NodeJS deps pulled in (we use it to pull in <code>valibot</code>).</p>
<p>There may be other good examples though (maybe I should also commit a similar example to <code>jco</code>!)</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/wasmCloud/wasmCloud/blob/main/examples/typescript/components/http-password-checker/rollup.config.mjs" style="background-image: url(&quot;https://uploads.zulipusercontent.net/16762fc1438fdc6db4a0ad2e5782897700aa9a1f/68747470733a2f2f7265706f7369746f72792d696d616765732e67697468756275736572636f6e74656e742e636f6d2f3330343430333639322f31643761333062662d366433642d346161312d386663322d333663623031303938346463&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/wasmCloud/wasmCloud/blob/main/examples/typescript/components/http-password-checker/rollup.config.mjs" title="wasmCloud/examples/typescript/components/http-password-checker/rollup.config.mjs at main · wasmCloud/wasmCloud">wasmCloud/examples/typescript/components/http-password-checker/rollup.config.mjs at main · wasmCloud/wasmCloud</a></div><div class="message_embed_description">wasmCloud is an open source Cloud Native Computing Foundation (CNCF) project that enables teams to build, manage, and scale polyglot apps across any cloud, K8s, or edge. - wasmCloud/wasmCloud</div></div></div>



<a name="490610850"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/409526-jco/topic/fetch-failing-in-browser-shim/near/490610850" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Wang <a href="https://bytecodealliance.github.io/zulip-archive/stream/409526-jco/topic/fetch-failing-in-browser-shim.html#490610850">(Dec 24 2024 at 01:09)</a>:</h4>
<p>Thank you for providing the examples! I tried out your <a href="https://github.com/vados-cosmonic/jco-browser-fetch-example">example</a> but it seems like the <code>importmap</code> in <code>demo.html</code> is misconfigured (due to a <a href="https://github.com/vados-cosmonic/jco-browser-fetch-example/blob/4d6dbf0f4e68aefcdc8bba089b3cc3bd34f7ac02/demo.html#L25">trailing comma in the json</a>). <br>
Here's the error I see: <br>
<a href="/user_uploads/15107/tD7tC8YMNdvMlHo2hdyRiJiL/Screenshot-2024-12-23-at-5.01.46PM.png">Screenshot 2024-12-23 at 5.01.46 PM.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/15107/tD7tC8YMNdvMlHo2hdyRiJiL/Screenshot-2024-12-23-at-5.01.46PM.png" title="Screenshot 2024-12-23 at 5.01.46 PM.png"><img data-original-dimensions="2202x144" src="/user_uploads/thumbnail/15107/tD7tC8YMNdvMlHo2hdyRiJiL/Screenshot-2024-12-23-at-5.01.46PM.png/840x560.webp"></a></div><p>Due to failed loading of the importmap, I believe the example just directly imports <code>components.js</code> and runs it without any of the component sandboxing. </p>
<p>After fixing the trailing comma (see my <a href="https://github.com/vados-cosmonic/jco-browser-fetch-example/compare/main...cytommi:jco-browser-fetch-example:importmap-fix?expand=1">forked branch with the one liner diff</a>), a different error arises:<br>
<a href="/user_uploads/15107/pPw-7nS7uhBh9zuBzl1b8gN3/Screenshot-2024-12-23-at-5.06.06PM.png">Screenshot 2024-12-23 at 5.06.06 PM.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/15107/pPw-7nS7uhBh9zuBzl1b8gN3/Screenshot-2024-12-23-at-5.06.06PM.png" title="Screenshot 2024-12-23 at 5.06.06 PM.png"><img data-original-dimensions="2210x166" src="/user_uploads/thumbnail/15107/pPw-7nS7uhBh9zuBzl1b8gN3/Screenshot-2024-12-23-at-5.06.06PM.png/840x560.webp"></a></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/vados-cosmonic/jco-browser-fetch-example" style='background-image: url("https://uploads.zulipusercontent.net/92a35a0947ef0c51a5a8710813e4b522459277f7/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f373635656165386465316238383436363436323330633764326265306262386639366639636137623365626566313733353232326364613362333134646636352f7661646f732d636f736d6f6e69632f6a636f2d62726f777365722d66657463682d6578616d706c65")'></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/vados-cosmonic/jco-browser-fetch-example" title="GitHub - vados-cosmonic/jco-browser-fetch-example: Example of using jco with browser-powered fetch()">GitHub - vados-cosmonic/jco-browser-fetch-example: Example of using jco with browser-powered fetch()</a></div><div class="message_embed_description">Example of using jco with browser-powered fetch(). Contribute to vados-cosmonic/jco-browser-fetch-example development by creating an account on GitHub.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/vados-cosmonic/jco-browser-fetch-example/blob/4d6dbf0f4e68aefcdc8bba089b3cc3bd34f7ac02/demo.html#L25" style='background-image: url("https://uploads.zulipusercontent.net/92a35a0947ef0c51a5a8710813e4b522459277f7/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f373635656165386465316238383436363436323330633764326265306262386639366639636137623365626566313733353232326364613362333134646636352f7661646f732d636f736d6f6e69632f6a636f2d62726f777365722d66657463682d6578616d706c65")'></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/vados-cosmonic/jco-browser-fetch-example/blob/4d6dbf0f4e68aefcdc8bba089b3cc3bd34f7ac02/demo.html#L25" title="jco-browser-fetch-example/demo.html at 4d6dbf0f4e68aefcdc8bba089b3cc3bd34f7ac02 · vados-cosmonic/jco-browser-fetch-example">jco-browser-fetch-example/demo.html at 4d6dbf0f4e68aefcdc8bba089b3cc3bd34f7ac02 · vados-cosmonic/jco-browser-fetch-example</a></div><div class="message_embed_description">Example of using jco with browser-powered fetch(). Contribute to vados-cosmonic/jco-browser-fetch-example development by creating an account on GitHub.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/vados-cosmonic/jco-browser-fetch-example/compare/main...cytommi:jco-browser-fetch-example:importmap-fix?expand=1" style='background-image: url("https://uploads.zulipusercontent.net/92a35a0947ef0c51a5a8710813e4b522459277f7/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f373635656165386465316238383436363436323330633764326265306262386639366639636137623365626566313733353232326364613362333134646636352f7661646f732d636f736d6f6e69632f6a636f2d62726f777365722d66657463682d6578616d706c65")'></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/vados-cosmonic/jco-browser-fetch-example/compare/main...cytommi:jco-browser-fetch-example:importmap-fix?expand=1" title="Comparing vados-cosmonic:main...cytommi:importmap-fix · vados-cosmonic/jco-browser-fetch-example">Comparing vados-cosmonic:main...cytommi:importmap-fix · vados-cosmonic/jco-browser-fetch-example</a></div><div class="message_embed_description">Example of using jco with browser-powered fetch(). Contribute to vados-cosmonic/jco-browser-fetch-example development by creating an account on GitHub.</div></div></div>



<a name="490611357"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/409526-jco/topic/fetch-failing-in-browser-shim/near/490611357" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Wang <a href="https://bytecodealliance.github.io/zulip-archive/stream/409526-jco/topic/fetch-failing-in-browser-shim.html#490611357">(Dec 24 2024 at 01:14)</a>:</h4>
<p>I'm most confused by the <a href="https://github.com/bytecodealliance/jco/blob/fe90d2ff0af2fc43d42002373e3edb9f892d7f53/packages/preview2-shim/lib/browser/http.js#L41-L45">implementation of the wasi:http shim</a> in the @bytecodealliance/preview2-shim package. </p>
<p>To me it looks incomplete, <a href="https://github.com/bytecodealliance/jco/blob/fe90d2ff0af2fc43d42002373e3edb9f892d7f53/packages/preview2-shim/lib/browser/http.js#L35-L45">where both <code>incomingHandler</code> and <code>outgoingHandler</code> are left empty</a>. Could this be the root cause?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/jco/blob/fe90d2ff0af2fc43d42002373e3edb9f892d7f53/packages/preview2-shim/lib/browser/http.js#L41-L45" style="background-image: url(&quot;https://uploads.zulipusercontent.net/04163901ed725ba74005f32efec91d8c25d96bae/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f616163393736616533316637373637356238633030393262316534373130363966393531386533656439663466346538323430393665316266343066326132372f62797465636f6465616c6c69616e63652f6a636f&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/jco/blob/fe90d2ff0af2fc43d42002373e3edb9f892d7f53/packages/preview2-shim/lib/browser/http.js#L41-L45" title="jco/packages/preview2-shim/lib/browser/http.js at fe90d2ff0af2fc43d42002373e3edb9f892d7f53 · bytecodealliance/jco">jco/packages/preview2-shim/lib/browser/http.js at fe90d2ff0af2fc43d42002373e3edb9f892d7f53 · bytecodealliance/jco</a></div><div class="message_embed_description">JavaScript toolchain for working with WebAssembly Components - bytecodealliance/jco</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/jco/blob/fe90d2ff0af2fc43d42002373e3edb9f892d7f53/packages/preview2-shim/lib/browser/http.js#L35-L45" style="background-image: url(&quot;https://uploads.zulipusercontent.net/04163901ed725ba74005f32efec91d8c25d96bae/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f616163393736616533316637373637356238633030393262316534373130363966393531386533656439663466346538323430393665316266343066326132372f62797465636f6465616c6c69616e63652f6a636f&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/jco/blob/fe90d2ff0af2fc43d42002373e3edb9f892d7f53/packages/preview2-shim/lib/browser/http.js#L35-L45" title="jco/packages/preview2-shim/lib/browser/http.js at fe90d2ff0af2fc43d42002373e3edb9f892d7f53 · bytecodealliance/jco">jco/packages/preview2-shim/lib/browser/http.js at fe90d2ff0af2fc43d42002373e3edb9f892d7f53 · bytecodealliance/jco</a></div><div class="message_embed_description">JavaScript toolchain for working with WebAssembly Components - bytecodealliance/jco</div></div></div>



<a name="490622710"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/409526-jco/topic/fetch-failing-in-browser-shim/near/490622710" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Wang <a href="https://bytecodealliance.github.io/zulip-archive/stream/409526-jco/topic/fetch-failing-in-browser-shim.html#490622710">(Dec 24 2024 at 03:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="527396">Thomas Wang</span> <a href="#narrow/channel/409526-jco/topic/fetch-failing-in-browser-shim/near/490610850">said</a>:</p>
<blockquote>
<p>After fixing the trailing comma (see my <a href="https://github.com/vados-cosmonic/jco-browser-fetch-example/compare/main...cytommi:jco-browser-fetch-example:importmap-fix?expand=1">forked branch with the one liner diff</a>), a different error arises:<br>
<a href="/user_uploads/15107/pPw-7nS7uhBh9zuBzl1b8gN3/Screenshot-2024-12-23-at-5.06.06PM.png">Screenshot 2024-12-23 at 5.06.06 PM.png</a></p>
</blockquote>
<p>I realized that I didn't pass in a string to invoke <code>ping()</code> <span aria-label="man facepalming" class="emoji emoji-1f926-200d-2642" role="img" title="man facepalming">:man_facepalming:</span> . After fixing the two obvious bugs (<a href="https://github.com/vados-cosmonic/jco-browser-fetch-example/compare/main...cytommi:jco-browser-fetch-example:importmap-fix?expand=1">diff here</a>), I'm getting the same error I faced in my bundled solution: <br>
<a href="/user_uploads/15107/76MAOUTUnmNPaKOlHdw8Vi4a/Screenshot-2024-12-23-at-7.05.24PM.png">Screenshot 2024-12-23 at 7.05.24 PM.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/15107/76MAOUTUnmNPaKOlHdw8Vi4a/Screenshot-2024-12-23-at-7.05.24PM.png" title="Screenshot 2024-12-23 at 7.05.24 PM.png"><img data-original-dimensions="2030x344" src="/user_uploads/thumbnail/15107/76MAOUTUnmNPaKOlHdw8Vi4a/Screenshot-2024-12-23-at-7.05.24PM.png/840x560.webp"></a></div><p>Here's <a href="https://github.com/cytommi/jco-browser-fetch-example/tree/bundled">the branch</a> on my fork where I attempt to run the bundle. You can serve the bundle on my branch with <code>pnpm bundle:go</code></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/vados-cosmonic/jco-browser-fetch-example/compare/main...cytommi:jco-browser-fetch-example:importmap-fix?expand=1" style='background-image: url("https://uploads.zulipusercontent.net/92a35a0947ef0c51a5a8710813e4b522459277f7/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f373635656165386465316238383436363436323330633764326265306262386639366639636137623365626566313733353232326364613362333134646636352f7661646f732d636f736d6f6e69632f6a636f2d62726f777365722d66657463682d6578616d706c65")'></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/vados-cosmonic/jco-browser-fetch-example/compare/main...cytommi:jco-browser-fetch-example:importmap-fix?expand=1" title="Comparing vados-cosmonic:main...cytommi:importmap-fix · vados-cosmonic/jco-browser-fetch-example">Comparing vados-cosmonic:main...cytommi:importmap-fix · vados-cosmonic/jco-browser-fetch-example</a></div><div class="message_embed_description">Example of using jco with browser-powered fetch(). Contribute to vados-cosmonic/jco-browser-fetch-example development by creating an account on GitHub.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/cytommi/jco-browser-fetch-example/tree/bundled" style='background-image: url("https://uploads.zulipusercontent.net/77870087d620cde77be56f65782cf1e7e48061f1/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f323263346163616338663038653931326532653839366333363234386538303130393061393039393036323735306161636635366665613764346363663638372f6379746f6d6d692f6a636f2d62726f777365722d66657463682d6578616d706c65")'></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/cytommi/jco-browser-fetch-example/tree/bundled" title="GitHub - cytommi/jco-browser-fetch-example at bundled">GitHub - cytommi/jco-browser-fetch-example at bundled</a></div><div class="message_embed_description">Example of using jco with browser-powered fetch(). Contribute to cytommi/jco-browser-fetch-example development by creating an account on GitHub.</div></div></div>



<a name="490628376"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/409526-jco/topic/fetch-failing-in-browser-shim/near/490628376" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Victor Adossi <a href="https://bytecodealliance.github.io/zulip-archive/stream/409526-jco/topic/fetch-failing-in-browser-shim.html#490628376">(Dec 24 2024 at 04:14)</a>:</h4>
<p>Hey sorry for the last minute breakage -- the trailing  comma is fixed now, thanks for pointing it out!</p>



<a name="490628968"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/409526-jco/topic/fetch-failing-in-browser-shim/near/490628968" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Victor Adossi <a href="https://bytecodealliance.github.io/zulip-archive/stream/409526-jco/topic/fetch-failing-in-browser-shim.html#490628968">(Dec 24 2024 at 04:24)</a>:</h4>
<p>AH I just figured out the problem -- the <code>importmap</code> entry for <code>component.js</code> <em>was</em> the problem.</p>
<p>So the problem you're running to in your own code is with the bundling of imports for <code>component.js</code> -- the imports in <code>component.js</code> are not being resolved properly -- they need to be mapped.</p>
<p>In the browser we have essentially reproduced this (accidentally, on my part) by putting <code>component.js</code> in the import map -- the sibling entries <em>cannot</em> be used to <em>one of the imports themselves</em>, so you need to do the import of the module later.</p>
<p>Here's the commit that fixes things:</p>
<p><a href="https://github.com/vados-cosmonic/jco-browser-fetch-example/commit/48982ab306ba544b3e7fa444526e0b8b96aebabf">https://github.com/vados-cosmonic/jco-browser-fetch-example/commit/48982ab306ba544b3e7fa444526e0b8b96aebabf</a></p>
<p>And the import before use should look like this:</p>
<div class="codehilite" data-code-language="JavaScript"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ping</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">import</span><span class="p">(</span><span class="s2">"./component.js"</span><span class="p">);</span>
</code></pre></div>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/vados-cosmonic/jco-browser-fetch-example/commit/48982ab306ba544b3e7fa444526e0b8b96aebabf" style="background-image: url(&quot;https://uploads.zulipusercontent.net/8656b8301b39b22c756b950321a8d88481bb98fa/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f393964306361373735393932653830356132323761383464396437323434373733396163323061306262393066313162633964666133346330356165666566352f7661646f732d636f736d6f6e69632f6a636f2d62726f777365722d66657463682d6578616d706c652f636f6d6d69742f34383938326162333036626135343462336537666134343435323665306238623936616562616266&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/vados-cosmonic/jco-browser-fetch-example/commit/48982ab306ba544b3e7fa444526e0b8b96aebabf" title="fix; remove import map for component · vados-cosmonic/jco-browser-fetch-example@48982ab">fix; remove import map for component · vados-cosmonic/jco-browser-fetch-example@48982ab</a></div><div class="message_embed_description">Signed-off-by: Victor Adossi &lt;vadossi@cosmonic.com&gt;</div></div></div>



<a name="490648862"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/409526-jco/topic/fetch-failing-in-browser-shim/near/490648862" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Wang <a href="https://bytecodealliance.github.io/zulip-archive/stream/409526-jco/topic/fetch-failing-in-browser-shim.html#490648862">(Dec 24 2024 at 08:42)</a>:</h4>
<p>By removing the importmap entry for  <code>"./component.js": "./dist/transpiled/component.js"</code>, doesn't the code effectively mean that we're directly importing the component implementation instead of the componentized output in <code>dist/transpiled</code>?</p>



<a name="490706184"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/409526-jco/topic/fetch-failing-in-browser-shim/near/490706184" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Wang <a href="https://bytecodealliance.github.io/zulip-archive/stream/409526-jco/topic/fetch-failing-in-browser-shim.html#490706184">(Dec 24 2024 at 19:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="527396">Thomas Wang</span> <a href="#narrow/channel/409526-jco/topic/fetch-failing-in-browser-shim/near/490611357">said</a>:</p>
<blockquote>
<p>I'm most confused by the <a href="https://github.com/bytecodealliance/jco/blob/fe90d2ff0af2fc43d42002373e3edb9f892d7f53/packages/preview2-shim/lib/browser/http.js#L41-L45">implementation of the wasi:http shim</a> in the @bytecodealliance/preview2-shim package. </p>
<p>To me it looks incomplete, <a href="https://github.com/bytecodealliance/jco/blob/fe90d2ff0af2fc43d42002373e3edb9f892d7f53/packages/preview2-shim/lib/browser/http.js#L35-L45">where both <code>incomingHandler</code> and <code>outgoingHandler</code> are left empty</a>. Could this be the root cause?</p>
</blockquote>
<p>What do you think of this? Does it look like an incomplete implementation in <code>lib/browser/http.js</code> to you? Thanks for all the help! <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span></p>



<a name="490732763"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/409526-jco/topic/fetch-failing-in-browser-shim/near/490732763" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Victor Adossi <a href="https://bytecodealliance.github.io/zulip-archive/stream/409526-jco/topic/fetch-failing-in-browser-shim.html#490732763">(Dec 25 2024 at 02:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="527396">Thomas Wang</span> <a href="#narrow/channel/409526-jco/topic/fetch-failing-in-browser-shim/near/490648862">said</a>:</p>
<blockquote>
<p>By removing the importmap entry for  <code>"./component.js": "./dist/transpiled/component.js"</code>, doesn't the code effectively mean that we're directly importing the component implementation instead of the componentized output in <code>dist/transpiled</code>?</p>
</blockquote>
<p>Nope! The code <em>inside</em> <code>dist/transpiled</code> is actually using the imports that we're filling in on the browser side! If you take a look at <code>dist/transpiled/component.js</code>, it has a bunch of generated code but also imports from other modules. There's a difference between the component itself's implementation (which will have stuff like how to handle/encode, lift and lower, convert basic types, etc) and the platform implementation that's expected to be filled out (and adhere to the semantics of <code>wasi:*</code> imports)</p>
<p>If you look into that folder you'll see <code>component.js</code> and the <code>interfaces</code> folder, but those are all <em>Typescript definition files</em> -- i.e. <code>*.d.ts</code> files -- they don't include implementation, it's up to the code on the browser side (the "platform") to provide that.</p>
<p><span class="user-mention silent" data-user-id="527396">Thomas Wang</span> <a href="#narrow/channel/409526-jco/topic/fetch-failing-in-browser-shim/near/490706184">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="527396">Thomas Wang</span> <a href="#narrow/channel/409526-jco/topic/fetch-failing-in-browser-shim/near/490611357">said</a>:</p>
<blockquote>
<p>I'm most confused by the <a href="https://github.com/bytecodealliance/jco/blob/fe90d2ff0af2fc43d42002373e3edb9f892d7f53/packages/preview2-shim/lib/browser/http.js#L41-L45">implementation of the wasi:http shim</a> in the @bytecodealliance/preview2-shim package. </p>
<p>To me it looks incomplete, <a href="https://github.com/bytecodealliance/jco/blob/fe90d2ff0af2fc43d42002373e3edb9f892d7f53/packages/preview2-shim/lib/browser/http.js#L35-L45">where both <code>incomingHandler</code> and <code>outgoingHandler</code> are left empty</a>. Could this be the root cause?</p>
</blockquote>
<p>What do you think of this? Does it look like an incomplete implementation in <code>lib/browser/http.js</code> to you? Thanks for all the help! <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span></p>
</blockquote>
<p>This is fine in your case because it's not what is <em>actually called</em> -- <code>fetch()</code> is.</p>
<p>I think the context that's missing here is that <code>fetch()</code> is implemented in terms of WASI at a <em>lower level</em> -- <a href="https://github.com/bytecodealliance/StarlingMonkey">StarlingMonkey</a>, the JS runtime underneath. You can check out <a href="https://github.com/bytecodealliance/StarlingMonkey/blob/fb85134f84e90216b137cbe0f4ee1bbcbe552a1d/builtins/web/fetch/fetch-api.cpp#L22">the implementation here</a>. </p>
<p>To use <code>outgoingHandler</code> explicitly, you'd need to import it, which 99% of people will <em>not</em> do from JS contexts.</p>
<p>That said, <code>outgoingHandler</code> could/should definitely be written in terms of built in <code>fetch</code> in the future though -- as <code>jco transpile</code> can be used on components from other languages that <em>do</em> try to use <code>wasi:http/outgoing-handler</code></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/StarlingMonkey" style="background-image: url(&quot;https://uploads.zulipusercontent.net/11d4e14f57464791fb1daa7acbb6bd0a38a05b3a/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f643162626231653937626634643965636639356566666531343337363334376630313833303237623436376235653830633362633431633163326264343565382f62797465636f6465616c6c69616e63652f537461726c696e674d6f6e6b6579&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/StarlingMonkey" title="GitHub - bytecodealliance/StarlingMonkey: The StarlingMonkey JS runtime">GitHub - bytecodealliance/StarlingMonkey: The StarlingMonkey JS runtime</a></div><div class="message_embed_description">The StarlingMonkey JS runtime. Contribute to bytecodealliance/StarlingMonkey development by creating an account on GitHub.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/StarlingMonkey/blob/fb85134f84e90216b137cbe0f4ee1bbcbe552a1d/builtins/web/fetch/fetch-api.cpp#L22" style="background-image: url(&quot;https://uploads.zulipusercontent.net/11d4e14f57464791fb1daa7acbb6bd0a38a05b3a/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f643162626231653937626634643965636639356566666531343337363334376630313833303237623436376235653830633362633431633163326264343565382f62797465636f6465616c6c69616e63652f537461726c696e674d6f6e6b6579&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/StarlingMonkey/blob/fb85134f84e90216b137cbe0f4ee1bbcbe552a1d/builtins/web/fetch/fetch-api.cpp#L22" title="StarlingMonkey/builtins/web/fetch/fetch-api.cpp at fb85134f84e90216b137cbe0f4ee1bbcbe552a1d · bytecodealliance/StarlingMonkey">StarlingMonkey/builtins/web/fetch/fetch-api.cpp at fb85134f84e90216b137cbe0f4ee1bbcbe552a1d · bytecodealliance/StarlingMonkey</a></div><div class="message_embed_description">The StarlingMonkey JS runtime. Contribute to bytecodealliance/StarlingMonkey development by creating an account on GitHub.</div></div></div>



<a name="490738928"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/409526-jco/topic/fetch-failing-in-browser-shim/near/490738928" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Victor Adossi <a href="https://bytecodealliance.github.io/zulip-archive/stream/409526-jco/topic/fetch-failing-in-browser-shim.html#490738928">(Dec 25 2024 at 03:55)</a>:</h4>
<p>Ahh <span class="user-mention" data-user-id="527396">@Thomas Wang</span> I <em>finally</em> got what you were pointing at -- and I'm getting the same error as you (with my import pointed at the transpiled component) -- your note about the unfinished impl made me realize I was running off some <a href="https://github.com/bytecodealliance/jco/pull/518/files#diff-65e72330a38449af149d3fdc4a91947cd4a1f60c6eda25e7a5a38be0f9ccc26fR238">unreleased code that had the impls</a> which is why I was ending at a different spot...</p>
<p>I've made <a href="https://github.com/bytecodealliance/jco/pull/540">a PR to <code>jco</code> that should explain this</a> (and be a gate for the async PR) -- this is an example we should check on every release once the updated code lands.</p>
<p>Thanks for bringing this up <span aria-label="bow" class="emoji emoji-1f647" role="img" title="bow">:bow:</span></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/jco/pull/518/files#diff-65e72330a38449af149d3fdc4a91947cd4a1f60c6eda25e7a5a38be0f9ccc26fR238" style="background-image: url(&quot;https://uploads.zulipusercontent.net/e3256ed2bac9817541dc6dad137abdd086a280ac/68747470733a2f2f617661746172732e67697468756275736572636f6e74656e742e636f6d2f752f3634303834323f733d34303026763d34&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/jco/pull/518/files#diff-65e72330a38449af149d3fdc4a91947cd4a1f60c6eda25e7a5a38be0f9ccc26fR238" title="DRAFT: Adding JSPI and Asyncify by calvinrp · Pull Request #518 · bytecodealliance/jco">DRAFT: Adding JSPI and Asyncify by calvinrp · Pull Request #518 · bytecodealliance/jco</a></div><div class="message_embed_description">Adds options to jco transpile and jco types:
.addOption(new Option(&#39;--async-mode [mode]&#39;, &#39;use async imports and exports&#39;).choices([&#39;sync&#39;, &#39;jspi&#39;, &#39;asyncify&amp;#39...</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/jco/pull/540" style="background-image: url(&quot;https://uploads.zulipusercontent.net/56db9a5dcf88e940325a9d18806708de8e783505/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f376432323261356332663838656235306339616634313762663664383862313034636535323631333437626464613937353534346232646339666538636633612f62797465636f6465616c6c69616e63652f6a636f2f70756c6c2f353430&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/jco/pull/540" title="feat(examples): add browser fetch() example by vados-cosmonic · Pull Request #540 · bytecodealliance/jco">feat(examples): add browser fetch() example by vados-cosmonic · Pull Request #540 · bytecodealliance/jco</a></div><div class="message_embed_description">This example adds a component that uses browser-provided fetch() (and related shims) which returns the response for a GET request to a given URL.
This example should showcase how to use a transpile...</div></div></div>



<a name="491023758"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/409526-jco/topic/fetch-failing-in-browser-shim/near/491023758" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Wang <a href="https://bytecodealliance.github.io/zulip-archive/stream/409526-jco/topic/fetch-failing-in-browser-shim.html#491023758">(Dec 27 2024 at 19:25)</a>:</h4>
<p>Thank you so much for following up on this! I've got a few followup questions hereon for my own curiosity if you don't mind! </p>
<ol>
<li>Is it accurate to say that the wasi preview2-shim serves as the wasi <em>implementation</em> that gets called from <a href="https://github.com/bytecodealliance/StarlingMonkey/blob/main/host-apis/wasi-0.2.0/host_api.cpp">StarlingMonkey's HostAPI</a>? (so <code>js .fetch()</code> -&gt; <a href="https://github.com/bytecodealliance/StarlingMonkey/tree/main/builtins/web/fetch"><code>starlingmonkey fetch embedding</code></a> -&gt; <a href="https://github.com/bytecodealliance/StarlingMonkey/blob/main/host-apis/wasi-0.2.0/host_api.cpp"><code>starlingmonkey hostapi.cpp</code></a> -&gt; <code>wasi (implemented as wasi preview2-shim)</code>). Here's my mental model (<a href="https://excalidraw.com/#json=bPxIwHW8965HEyKBhmReh,yG-eihPc2Wt8LqnOhq5Dog">link here)</a>: <br>
<a href="/user_uploads/15107/2xEUk8nmM3_5zUXkuIjfLGtf/Screenshot-2024-12-27-at-11.18.11AM.png">Screenshot 2024-12-27 at 11.18.11 AM.png</a><div class="message_inline_image"><a href="/user_uploads/15107/2xEUk8nmM3_5zUXkuIjfLGtf/Screenshot-2024-12-27-at-11.18.11AM.png" title="Screenshot 2024-12-27 at 11.18.11 AM.png"><img data-original-dimensions="1426x1078" src="/user_uploads/thumbnail/15107/2xEUk8nmM3_5zUXkuIjfLGtf/Screenshot-2024-12-27-at-11.18.11AM.png/840x560.webp"></a></div></li>
</ol>
<p>2.Is it impossible to implement HTTP handlers synchronously? I noticed your PR is blocked by <a href="https://github.com/bytecodealliance/jco/pull/518/files#diff-50c08972b65d882f512b2e2b675b6d4e369e8ecbdb73c37b0bf92942dbc73dd5">the one adding JSPI and Asyncify</a>. I’m struggling to understand what’s missing in <a href="https://github.com/bytecodealliance/jco/blob/main/packages/preview2-shim/lib/browser/http.js">the current HTTP handler implementation</a> in the WASI-browser shim that's causing the issue—especially since <a href="https://github.com/cytommi/jco/blob/main/packages/preview2-shim/lib/nodejs/http.js">Node's WASI shim works</a>. Why are <em>asyncified</em> exports/imports necessary for supporting wasi-http?</p>
<p>Thank you!</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/jco/pull/518/files#diff-50c08972b65d882f512b2e2b675b6d4e369e8ecbdb73c37b0bf92942dbc73dd5" style='background-image: url("https://uploads.zulipusercontent.net/e3256ed2bac9817541dc6dad137abdd086a280ac/68747470733a2f2f617661746172732e67697468756275736572636f6e74656e742e636f6d2f752f3634303834323f733d34303026763d34")'></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/jco/pull/518/files#diff-50c08972b65d882f512b2e2b675b6d4e369e8ecbdb73c37b0bf92942dbc73dd5" title="DRAFT: Adding JSPI and Asyncify by calvinrp · Pull Request #518 · bytecodealliance/jco">DRAFT: Adding JSPI and Asyncify by calvinrp · Pull Request #518 · bytecodealliance/jco</a></div><div class="message_embed_description">Adds options to jco transpile and jco types:
.addOption(new Option('--async-mode [mode]', 'use async imports and exports').choices(['sync', 'jspi', 'asyncify&amp;#39...</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/jco/blob/main/packages/preview2-shim/lib/browser/http.js" style='background-image: url("https://uploads.zulipusercontent.net/f10afdd8e42b285c9c52ffa5bda34ce6b6227c77/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f633561356562653637353830306362323565373735366137336338616634306463646336316433643863643637396135633336333637653933306565643939632f62797465636f6465616c6c69616e63652f6a636f")'></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/jco/blob/main/packages/preview2-shim/lib/browser/http.js" title="jco/packages/preview2-shim/lib/browser/http.js at main · bytecodealliance/jco">jco/packages/preview2-shim/lib/browser/http.js at main · bytecodealliance/jco</a></div><div class="message_embed_description">JavaScript toolchain for working with WebAssembly Components - bytecodealliance/jco</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/cytommi/jco/blob/main/packages/preview2-shim/lib/nodejs/http.js" style='background-image: url("https://uploads.zulipusercontent.net/7747a1fa0ed02b5eecb16811f3c9fd48ccb6781b/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f383033303764333634363335313036336466386436326136386364376566383337626361636565313432353737653737396132383062326361346430356664662f6379746f6d6d692f6a636f")'></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/cytommi/jco/blob/main/packages/preview2-shim/lib/nodejs/http.js" title="jco/packages/preview2-shim/lib/nodejs/http.js at main · cytommi/jco">jco/packages/preview2-shim/lib/nodejs/http.js at main · cytommi/jco</a></div><div class="message_embed_description">JavaScript toolchain for working with WebAssembly Components - cytommi/jco</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/StarlingMonkey/blob/main/host-apis/wasi-0.2.0/host_api.cpp" style='background-image: url("https://uploads.zulipusercontent.net/6351bba797f56d0fc58551060dd131d7cc27f574/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f653266376339613766326466613062643834383562626238613938333264616435663836643561633734613834343763306563316664373266666133383133312f62797465636f6465616c6c69616e63652f537461726c696e674d6f6e6b6579")'></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/StarlingMonkey/blob/main/host-apis/wasi-0.2.0/host_api.cpp" title="StarlingMonkey/host-apis/wasi-0.2.0/host_api.cpp at main · bytecodealliance/StarlingMonkey">StarlingMonkey/host-apis/wasi-0.2.0/host_api.cpp at main · bytecodealliance/StarlingMonkey</a></div><div class="message_embed_description">The StarlingMonkey JS runtime. Contribute to bytecodealliance/StarlingMonkey development by creating an account on GitHub.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/StarlingMonkey/tree/main/builtins/web/fetch" style='background-image: url("https://uploads.zulipusercontent.net/6351bba797f56d0fc58551060dd131d7cc27f574/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f653266376339613766326466613062643834383562626238613938333264616435663836643561633734613834343763306563316664373266666133383133312f62797465636f6465616c6c69616e63652f537461726c696e674d6f6e6b6579")'></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/StarlingMonkey/tree/main/builtins/web/fetch" title="StarlingMonkey/builtins/web/fetch at main · bytecodealliance/StarlingMonkey">StarlingMonkey/builtins/web/fetch at main · bytecodealliance/StarlingMonkey</a></div><div class="message_embed_description">The StarlingMonkey JS runtime. Contribute to bytecodealliance/StarlingMonkey development by creating an account on GitHub.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://excalidraw.com/#json=bPxIwHW8965HEyKBhmReh,yG-eihPc2Wt8LqnOhq5Dog" style='background-image: url("https://uploads.zulipusercontent.net/4a5599ee4501f71edbb61f61b172edede2ed8632/68747470733a2f2f657863616c69647261772e636f6d2f6f672d696d6167652d332e706e67")'></a><div class="data-container"><div class="message_embed_title"><a href="https://excalidraw.com/#json=bPxIwHW8965HEyKBhmReh,yG-eihPc2Wt8LqnOhq5Dog" title="Excalidraw — Collaborative whiteboarding made easy">Excalidraw — Collaborative whiteboarding made easy</a></div><div class="message_embed_description">Excalidraw is a virtual collaborative whiteboard tool that lets you easily sketch diagrams that have a hand-drawn feel to them.</div></div></div>



<a name="491251152"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/409526-jco/topic/fetch-failing-in-browser-shim/near/491251152" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Victor Adossi <a href="https://bytecodealliance.github.io/zulip-archive/stream/409526-jco/topic/fetch-failing-in-browser-shim.html#491251152">(Dec 30 2024 at 07:57)</a>:</h4>
<h3>Regarding (1)</h3>
<p>Yes, I think that understanding is right, that diagram is looks excellent to me. I think the only thing you might be missing is the C calls generated by <a href="https://github.com/bytecodealliance/wit-bindgen"><code>wit-bindgen</code></a> in all this (explained below).</p>
<p>To supply some evidence, you can see in the <a href="https://github.com/bytecodealliance/StarlingMonkey/blob/main/builtins/web/fetch/fetch-api.cpp#L79">StarlingMonkey <code>fetch</code> impl</a>  -- that it deals in WASI terms. As you have already noticed, when components are run in the browser, they're actually disassembled into modules with WASI imports and then the <em>host</em> obviously has to provide implementations for those imports in the normal WASM module way.</p>
<p>Just a note, but StarlingMonkey <em>can't</em> implement the platform-specific stuff, because  in this context it is crammed into a WebAssembly component (module, at the end of the day) and run in a WASI-supporting <em>host</em> context, it <em>isn't</em> the host. A JS WebAssembly Component is roughly StarlingMonkey compiled to WASM + the source JS , with some initialization steps done. It's theoretically impossible for StarlingMonkey to sort of short circuit/stub/avoid expensive calls to the host, but I'm assuming that's not what we're talking about here. </p>
<p>The host is the browser (or V8 + NodeJS in the Node case).</p>
<p>The Host API helps turn commands like <code>fetch()</code> into WASI-compliant host calls, with the help of the host API -- For example in the supporting <a href="https://github.com/bytecodealliance/StarlingMonkey/blob/fb85134f84e90216b137cbe0f4ee1bbcbe552a1d/builtins/web/fetch/request-response.cpp#L202"><code>builtins/web/fetch/request-response.cpp</code>'s work creating outgoing request bodies</a>. </p>
<p>In <code>request-response.cpp</code> we <a href="https://github.com/bytecodealliance/StarlingMonkey/blob/fb85134f84e90216b137cbe0f4ee1bbcbe552a1d/builtins/web/fetch/request-response.cpp#L1050"><code>write_all</code></a> to the outgoing body, then eventually <a href="https://github.com/bytecodealliance/StarlingMonkey/blob/fb85134f84e90216b137cbe0f4ee1bbcbe552a1d/builtins/web/fetch/request-response.cpp#L1017"><code>finish</code> the outgoing body</a> (the lexical order is a little weird because of how <code>ReadableStream</code>s work, if you look at the comment above), all of those get turned into <code>host_api</code> methods like <a href="https://github.com/bytecodealliance/StarlingMonkey/blob/fb85134f84e90216b137cbe0f4ee1bbcbe552a1d/host-apis/wasi-0.2.0/host_api.cpp#L422"><code>write_all</code></a> and <a href="https://github.com/bytecodealliance/StarlingMonkey/blob/fb85134f84e90216b137cbe0f4ee1bbcbe552a1d/host-apis/wasi-0.2.0/host_api.cpp#L564"><code>HttpOutgoingBody::close</code></a>, which do <em>some</em> engine stuff, <em>and</em> ultimately/most-importantly WASI stuff that is actually <em>completely imported from C</em>, via bindings generated from <a href="https://github.com/bytecodealliance/wit-bindgen"><code>wit-bindgen</code></a> (ex. <code>wasi_io_streams_method_output_stream_blocking_flush(...)</code>.</p>
<p>Unfortunately I think I may have not mentioned <code>wit-bindgen</code> until now, but basically it is a language-specific imports (and exports) into code for a given programming language. The generated <a href="https://github.com/bytecodealliance/StarlingMonkey/tree/fb85134f84e90216b137cbe0f4ee1bbcbe552a1d/host-apis/wasi-0.2.0/bindings">bindings are in the host API repo</a>.</p>
<p>So all this is to say that you're correct -- when JS runs in StarlingMonkey (inside a component) it translates some builtins (like <code>fetch()</code>) to WASI underneath (<em>inside</em> the StarlingMonkey engine), and that code is translated to WASI calls on the host.</p>
<p>To be more concrete, like we've been talking about, the implementation of <a href="https://github.com/bytecodealliance/StarlingMonkey/blob/main/host-apis/wasi-0.2.0/host_api.cpp#L726"><code>OutgoingRequest::send()</code></a>, is actually trying to go out to <code>wasi:http/outgoing-handler.handle</code>. This is implemented in NodeJS but as you found unimplemented in browsers on <code>main</code>.</p>
<p><span class="user-mention" data-user-id="553681">@Guy Bedford</span> /  <span class="user-mention" data-user-id="234973">@Till Schneidereit</span> / <span class="user-mention" data-user-id="479055">@Calvin Prewitt</span>  would love some correction here on anything I missed above :)</p>
<p>This is why I was incorrectly thinking it was supposed to <em>just work</em> -- I was thinking that <code>HttpOutgoingRequest::send</code> at the StarlingMonkey level actually translated to <code>send()</code> at the shim level, but I was wrong about this. In fact it's silly, because <a href="https://github.com/WebAssembly/wasi-http/blob/main/wit/types.wit#L311"><code>outgoing-request</code> has no <code>send()</code>!</a>, it was just a utility addition. The thing we needed is <em>outgoing handler</em> which is not on <code>main</code> (yet!)</p>
<h3>Regarding (2)</h3>
<p>It is possible, but far from ideal -- this is because of the web platform use of asynchronous primitives to avoid blocking the main thread (etc), but WebAssembly (and core modules especially!) do not <em>expect</em> async host functions (this is what <a href="https://v8.dev/blog/jspi#what-is-%E2%80%98jspi%E2%80%99-for%3F">JSPI is for</a> and <a href="https://emscripten.org/docs/porting/asyncify.html">emscriptens Asyncify is for</a>) This may be why we didn't have the browser impl yet but I'm not 100% sure.</p>
<p>You could imagine one way to get around this is to use something like a web worker -- or some other non-main-thread execution context, but that's obviously not quite as ideal as getting decent same-event-loop support.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen" style="background-image: url(&quot;https://uploads.zulipusercontent.net/04d78d1f0ae4c2e54b4ed345ad3b2b6eeb3dbacf/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613334303831333134386661363365363235636333346134376431363161383033356431303464653436356539613238626366653632363035333565646462392f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen" title="GitHub - bytecodealliance/wit-bindgen: A language binding generator for WebAssembly interface types">GitHub - bytecodealliance/wit-bindgen: A language binding generator for WebAssembly interface types</a></div><div class="message_embed_description">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/StarlingMonkey/blob/main/builtins/web/fetch/fetch-api.cpp#L79" style="background-image: url(&quot;https://uploads.zulipusercontent.net/6351bba797f56d0fc58551060dd131d7cc27f574/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f653266376339613766326466613062643834383562626238613938333264616435663836643561633734613834343763306563316664373266666133383133312f62797465636f6465616c6c69616e63652f537461726c696e674d6f6e6b6579&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/StarlingMonkey/blob/main/builtins/web/fetch/fetch-api.cpp#L79" title="StarlingMonkey/builtins/web/fetch/fetch-api.cpp at main · bytecodealliance/StarlingMonkey">StarlingMonkey/builtins/web/fetch/fetch-api.cpp at main · bytecodealliance/StarlingMonkey</a></div><div class="message_embed_description">The StarlingMonkey JS runtime. Contribute to bytecodealliance/StarlingMonkey development by creating an account on GitHub.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/StarlingMonkey/blob/fb85134f84e90216b137cbe0f4ee1bbcbe552a1d/builtins/web/fetch/request-response.cpp#L202" style="background-image: url(&quot;https://uploads.zulipusercontent.net/6351bba797f56d0fc58551060dd131d7cc27f574/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f653266376339613766326466613062643834383562626238613938333264616435663836643561633734613834343763306563316664373266666133383133312f62797465636f6465616c6c69616e63652f537461726c696e674d6f6e6b6579&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/StarlingMonkey/blob/fb85134f84e90216b137cbe0f4ee1bbcbe552a1d/builtins/web/fetch/request-response.cpp#L202" title="StarlingMonkey/builtins/web/fetch/request-response.cpp at fb85134f84e90216b137cbe0f4ee1bbcbe552a1d · bytecodealliance/StarlingMonkey">StarlingMonkey/builtins/web/fetch/request-response.cpp at fb85134f84e90216b137cbe0f4ee1bbcbe552a1d · bytecodealliance/StarlingMonkey</a></div><div class="message_embed_description">The StarlingMonkey JS runtime. Contribute to bytecodealliance/StarlingMonkey development by creating an account on GitHub.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/StarlingMonkey/blob/fb85134f84e90216b137cbe0f4ee1bbcbe552a1d/builtins/web/fetch/request-response.cpp#L1050" style="background-image: url(&quot;https://uploads.zulipusercontent.net/6351bba797f56d0fc58551060dd131d7cc27f574/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f653266376339613766326466613062643834383562626238613938333264616435663836643561633734613834343763306563316664373266666133383133312f62797465636f6465616c6c69616e63652f537461726c696e674d6f6e6b6579&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/StarlingMonkey/blob/fb85134f84e90216b137cbe0f4ee1bbcbe552a1d/builtins/web/fetch/request-response.cpp#L1050" title="StarlingMonkey/builtins/web/fetch/request-response.cpp at fb85134f84e90216b137cbe0f4ee1bbcbe552a1d · bytecodealliance/StarlingMonkey">StarlingMonkey/builtins/web/fetch/request-response.cpp at fb85134f84e90216b137cbe0f4ee1bbcbe552a1d · bytecodealliance/StarlingMonkey</a></div><div class="message_embed_description">The StarlingMonkey JS runtime. Contribute to bytecodealliance/StarlingMonkey development by creating an account on GitHub.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/StarlingMonkey/blob/fb85134f84e90216b137cbe0f4ee1bbcbe552a1d/builtins/web/fetch/request-response.cpp#L1017" style="background-image: url(&quot;https://uploads.zulipusercontent.net/6351bba797f56d0fc58551060dd131d7cc27f574/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f653266376339613766326466613062643834383562626238613938333264616435663836643561633734613834343763306563316664373266666133383133312f62797465636f6465616c6c69616e63652f537461726c696e674d6f6e6b6579&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/StarlingMonkey/blob/fb85134f84e90216b137cbe0f4ee1bbcbe552a1d/builtins/web/fetch/request-response.cpp#L1017" title="StarlingMonkey/builtins/web/fetch/request-response.cpp at fb85134f84e90216b137cbe0f4ee1bbcbe552a1d · bytecodealliance/StarlingMonkey">StarlingMonkey/builtins/web/fetch/request-response.cpp at fb85134f84e90216b137cbe0f4ee1bbcbe552a1d · bytecodealliance/StarlingMonkey</a></div><div class="message_embed_description">The StarlingMonkey JS runtime. Contribute to bytecodealliance/StarlingMonkey development by creating an account on GitHub.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/StarlingMonkey/blob/fb85134f84e90216b137cbe0f4ee1bbcbe552a1d/host-apis/wasi-0.2.0/host_api.cpp#L422" style="background-image: url(&quot;https://uploads.zulipusercontent.net/6351bba797f56d0fc58551060dd131d7cc27f574/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f653266376339613766326466613062643834383562626238613938333264616435663836643561633734613834343763306563316664373266666133383133312f62797465636f6465616c6c69616e63652f537461726c696e674d6f6e6b6579&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/StarlingMonkey/blob/fb85134f84e90216b137cbe0f4ee1bbcbe552a1d/host-apis/wasi-0.2.0/host_api.cpp#L422" title="StarlingMonkey/host-apis/wasi-0.2.0/host_api.cpp at fb85134f84e90216b137cbe0f4ee1bbcbe552a1d · bytecodealliance/StarlingMonkey">StarlingMonkey/host-apis/wasi-0.2.0/host_api.cpp at fb85134f84e90216b137cbe0f4ee1bbcbe552a1d · bytecodealliance/StarlingMonkey</a></div><div class="message_embed_description">The StarlingMonkey JS runtime. Contribute to bytecodealliance/StarlingMonkey development by creating an account on GitHub.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/StarlingMonkey/blob/fb85134f84e90216b137cbe0f4ee1bbcbe552a1d/host-apis/wasi-0.2.0/host_api.cpp#L564" style="background-image: url(&quot;https://uploads.zulipusercontent.net/6351bba797f56d0fc58551060dd131d7cc27f574/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f653266376339613766326466613062643834383562626238613938333264616435663836643561633734613834343763306563316664373266666133383133312f62797465636f6465616c6c69616e63652f537461726c696e674d6f6e6b6579&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/StarlingMonkey/blob/fb85134f84e90216b137cbe0f4ee1bbcbe552a1d/host-apis/wasi-0.2.0/host_api.cpp#L564" title="StarlingMonkey/host-apis/wasi-0.2.0/host_api.cpp at fb85134f84e90216b137cbe0f4ee1bbcbe552a1d · bytecodealliance/StarlingMonkey">StarlingMonkey/host-apis/wasi-0.2.0/host_api.cpp at fb85134f84e90216b137cbe0f4ee1bbcbe552a1d · bytecodealliance/StarlingMonkey</a></div><div class="message_embed_description">The StarlingMonkey JS runtime. Contribute to bytecodealliance/StarlingMonkey development by creating an account on GitHub.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/StarlingMonkey/tree/fb85134f84e90216b137cbe0f4ee1bbcbe552a1d/host-apis/wasi-0.2.0/bindings" style="background-image: url(&quot;https://uploads.zulipusercontent.net/6351bba797f56d0fc58551060dd131d7cc27f574/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f653266376339613766326466613062643834383562626238613938333264616435663836643561633734613834343763306563316664373266666133383133312f62797465636f6465616c6c69616e63652f537461726c696e674d6f6e6b6579&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/StarlingMonkey/tree/fb85134f84e90216b137cbe0f4ee1bbcbe552a1d/host-apis/wasi-0.2.0/bindings" title="StarlingMonkey/host-apis/wasi-0.2.0/bindings at fb85134f84e90216b137cbe0f4ee1bbcbe552a1d · bytecodealliance/StarlingMonkey">StarlingMonkey/host-apis/wasi-0.2.0/bindings at fb85134f84e90216b137cbe0f4ee1bbcbe552a1d · bytecodealliance/StarlingMonkey</a></div><div class="message_embed_description">The StarlingMonkey JS runtime. Contribute to bytecodealliance/StarlingMonkey development by creating an account on GitHub.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/StarlingMonkey/blob/main/host-apis/wasi-0.2.0/host_api.cpp#L726" style="background-image: url(&quot;https://uploads.zulipusercontent.net/6351bba797f56d0fc58551060dd131d7cc27f574/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f653266376339613766326466613062643834383562626238613938333264616435663836643561633734613834343763306563316664373266666133383133312f62797465636f6465616c6c69616e63652f537461726c696e674d6f6e6b6579&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/StarlingMonkey/blob/main/host-apis/wasi-0.2.0/host_api.cpp#L726" title="StarlingMonkey/host-apis/wasi-0.2.0/host_api.cpp at main · bytecodealliance/StarlingMonkey">StarlingMonkey/host-apis/wasi-0.2.0/host_api.cpp at main · bytecodealliance/StarlingMonkey</a></div><div class="message_embed_description">The StarlingMonkey JS runtime. Contribute to bytecodealliance/StarlingMonkey development by creating an account on GitHub.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/wasi-http/blob/main/wit/types.wit#L311" style="background-image: url(&quot;https://uploads.zulipusercontent.net/83859990349aea3df102e4f70035896afad05d60/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f316336323933373265626230376532326237323964646337303431666566666166626563623466373831343133613931323139326266396336373335306666302f576562417373656d626c792f776173692d68747470&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/wasi-http/blob/main/wit/types.wit#L311" title="wasi-http/wit/types.wit at main · WebAssembly/wasi-http">wasi-http/wit/types.wit at main · WebAssembly/wasi-http</a></div><div class="message_embed_description">Contribute to WebAssembly/wasi-http development by creating an account on GitHub.</div></div></div>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>