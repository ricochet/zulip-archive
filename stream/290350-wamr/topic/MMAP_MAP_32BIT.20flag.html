<html>
<head><meta charset="utf-8"><title>MMAP_MAP_32BIT flag · wamr · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/290350-wamr/index.html">wamr</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/290350-wamr/topic/MMAP_MAP_32BIT.20flag.html">MMAP_MAP_32BIT flag</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="294898178"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/290350-wamr/topic/MMAP_MAP_32BIT%20flag/near/294898178" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Hu <a href="https://bytecodealliance.github.io/zulip-archive/stream/290350-wamr/topic/MMAP_MAP_32BIT.20flag.html#294898178">(Aug 23 2022 at 15:58)</a>:</h4>
<p>Hi all, does anyone have any context behind the comment here <a href="https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/core/app-mgr/app-manager/module_wasm_app.c#L1451">https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/core/app-mgr/app-manager/module_wasm_app.c#L1451</a>? I'm not sure what <code>relocation for R_X86_64_32/32S/PC32</code> refers to. Does this mean that it's unsafe to enable AOT on platforms where we cannot set the underlying <code>MAP_32BIT</code> flag here <a href="https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/core/shared/platform/common/posix/posix_memmap.c#L72">https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/core/shared/platform/common/posix/posix_memmap.c#L72</a> ? Thanks in advance.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/core/app-mgr/app-manager/module_wasm_app.c#L1451" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/9917d0e8da263c79e592033fcb7a5662b70fcfe0\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f306534346163373932383663326133346664376338376264373766386130363639616463353562663339386465373966336366396537623865616535383165322f62797465636f6465616c6c69616e63652f7761736d2d6d6963726f2d72756e74696d65)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/core/app-mgr/app-manager/module_wasm_app.c#L1451" title="wasm-micro-runtime/module_wasm_app.c at main · bytecodealliance/wasm-micro-runtime">wasm-micro-runtime/module_wasm_app.c at main · bytecodealliance/wasm-micro-runtime</a></div><div class="message_embed_description">WebAssembly Micro Runtime (WAMR). Contribute to bytecodealliance/wasm-micro-runtime development by creating an account on GitHub.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/core/shared/platform/common/posix/posix_memmap.c#L72" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/9917d0e8da263c79e592033fcb7a5662b70fcfe0\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f306534346163373932383663326133346664376338376264373766386130363639616463353562663339386465373966336366396537623865616535383165322f62797465636f6465616c6c69616e63652f7761736d2d6d6963726f2d72756e74696d65)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/core/shared/platform/common/posix/posix_memmap.c#L72" title="wasm-micro-runtime/posix_memmap.c at main · bytecodealliance/wasm-micro-runtime">wasm-micro-runtime/posix_memmap.c at main · bytecodealliance/wasm-micro-runtime</a></div><div class="message_embed_description">WebAssembly Micro Runtime (WAMR). Contribute to bytecodealliance/wasm-micro-runtime development by creating an account on GitHub.</div></div></div>



<a name="296250365"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/290350-wamr/topic/MMAP_MAP_32BIT%20flag/near/296250365" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wenyong Huang <a href="https://bytecodealliance.github.io/zulip-archive/stream/290350-wamr/topic/MMAP_MAP_32BIT.20flag.html#296250365">(Aug 31 2022 at 03:07)</a>:</h4>
<p><span class="user-mention" data-user-id="526972">@Gary Hu</span> For AOT, as the aot file loading is processed by runtime but not system dynamic loader (e.g. use dlopen to load .so file), runtime needs to allocate memory for aot code and aot data, and apply relocation for them, or patch/modify the aot code/data according to relocation records. And as the codegen is LLVM based, the relocation records are generated by LLVM, and there may be some special requirements. For relocation type R_X86_64_32/32S/PC32, it requires that destination address is 32-bit, and the target address may be an address pointing to some position aot code, so the aot code is should be in 32-bit range. As aot code is allocated by mmap, so we add MAP_32BIT flag for it.</p>
<p>The 32-bit relocation types are normally required by LLVM codegen size level 2 and 3, if you don't want to generate them, you can try generating the AOT file with size level 1: <code>wamrc --size-level=1 -o &lt;aot file&gt; &lt;wasm file&gt;</code>. Thanks.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>