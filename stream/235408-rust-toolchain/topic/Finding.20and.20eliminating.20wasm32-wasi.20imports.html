<html>
<head><meta charset="utf-8"><title>Finding and eliminating wasm32-wasi imports · rust-toolchain · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/index.html">rust-toolchain</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html">Finding and eliminating wasm32-wasi imports</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="423478642"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/423478642" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#423478642">(Feb 26 2024 at 20:33)</a>:</h4>
<p>As someone who is trying to compile a rust crate to <code>wasm32-wasi</code> that has dependencies on C libs (QuickJS via rquickjs), how can I go about finding the reason that different WASI preview 1 imports are being pulled in?</p>
<p>This risks being something that seems trivially obvious to some folks so to add extra context: I'm at the start of my rust journey and haven't played in compiled languages since a time when I had no idea what I was doing.</p>



<a name="423478971"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/423478971" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#423478971">(Feb 26 2024 at 20:35)</a>:</h4>
<p>This unfortunately generally isn't easy AFAIK, you'd have to trace symbols backwards to some exported function or something in a table for example, and that's a pretty manual process.</p>
<p>If you want zero imports you can use <code>wasm32-unknown-unknown</code>, though, but not all crate will compile for that target</p>



<a name="423479140"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/423479140" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#423479140">(Feb 26 2024 at 20:36)</a>:</h4>
<p>I did try targeting <code>wasm32-unknown-unknown</code> but quickly discovered how far out of my depth I was. <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="423479212"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/423479212" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#423479212">(Feb 26 2024 at 20:36)</a>:</h4>
<p>Are you aware of any tools that might expose WASM call graphs in some ergonomic form?</p>



<a name="423479292"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/423479292" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#423479292">(Feb 26 2024 at 20:37)</a>:</h4>
<p><code>twiggy</code> is the closest approximation that I can think of, but that's a "theoretically this is possible" kind of thing rather than "here's the one liner to render a graphviz file"</p>



<a name="423479600"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/423479600" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#423479600">(Feb 26 2024 at 20:39)</a>:</h4>
<p><code>twiggy paths</code> looks super promising.</p>



<a name="423479794"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/423479794" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#423479794">(Feb 26 2024 at 20:40)</a>:</h4>
<p>QuickJS's <code>os</code> module probably pulls in a lot of WASI stuff by way of <code>wasi-libc</code>: <a href="https://bellard.org/quickjs/quickjs.html#os-module">https://bellard.org/quickjs/quickjs.html#os-module</a></p>



<a name="423481116"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/423481116" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#423481116">(Feb 26 2024 at 20:50)</a>:</h4>
<p><span class="user-mention" data-user-id="509936">@Joel Dice</span> AFAICT, <code>rquickjs</code> shouldn't be pulling that in unless certain crate features are being used. I had he same question w/ <code>quickjs-wasm-rs</code> from the Javy team and I _know_ that it isn't pulling in the libc library.</p>



<a name="423482292"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/423482292" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#423482292">(Feb 26 2024 at 20:58)</a>:</h4>
<p>Yeah, I don't think it's pulling in the libc os module: <a href="https://github.com/DelSkayn/rquickjs/blob/7029b70b75cf9220c16a1ce2768968f3b8bef6fc/sys/build.rs#L123-L134">https://github.com/DelSkayn/rquickjs/blob/7029b70b75cf9220c16a1ce2768968f3b8bef6fc/sys/build.rs#L123-L134</a></p>



<a name="427937194"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/427937194" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#427937194">(Mar 20 2024 at 14:13)</a>:</h4>
<p>Well I've gone down this rabbit-hole once again and seem to have found a couple plausible explanations, as described in these issues: </p>
<ol>
<li><a href="https://github.com/WebAssembly/wasi-sdk/issues/190">https://github.com/WebAssembly/wasi-sdk/issues/190</a></li>
<li><a href="https://github.com/WebAssembly/wasi-sdk/issues/220">https://github.com/WebAssembly/wasi-sdk/issues/220</a></li>
</ol>
<p>As <span class="user-mention" data-user-id="587520">@Surma</span> found in the first, it seems that some nuance of the way C macros are defined in the <code>wasi-sdk</code> is forcing <code>NDEBUG</code> to be unset: <a href="https://github.com/WebAssembly/wasi-sdk/issues/190#issuecomment-914682467">https://github.com/WebAssembly/wasi-sdk/issues/190#issuecomment-914682467</a> and then <code>assert()</code> resulting in this 'stong' reference to stdout that LTO isn't able to get rid of.</p>
<p>I was able to avoid the imports by defining some stubs like the following: </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[no_mangle]</span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">__stdio_write</span><span class="p">(</span><span class="n">ptr</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">len</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span>
<span class="w">    </span><span class="mi">0</span>
<span class="p">}</span>
</code></pre></div>
<p>(also for <code>__stdout_write</code>, <code>__stdio_seek</code> and <code>__stdio_close</code>)</p>
<p>But these all end up becoming unnecessary and unwanted exports of the WASM binary. AFAICT, it's because of this: <a href="https://github.com/rust-lang/rust/issues/73958">https://github.com/rust-lang/rust/issues/73958</a></p>
<p>I'm a bit stumped for the time being on how I can put into place some of the findings from the first <code>wasi-sdk</code> issue.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/wasi-sdk/issues/190#issuecomment-914682467" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/b380733dcc0d559ae58edea0b40b3d7f5c70ae7c\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f343264313264613232383032336363616532343030303565636432613536373335386364373936336338623634303332663339643539616664626330373432662f576562417373656d626c792f776173692d73646b2f6973737565732f313930)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/wasi-sdk/issues/190#issuecomment-914682467" title="Avoid stdlib printing to stdout/stderr? · Issue #190 · WebAssembly/wasi-sdk">Avoid stdlib printing to stdout/stderr? · Issue #190 · WebAssembly/wasi-sdk</a></div><div class="message_embed_description">A very minimal code sample like this: #include &lt;memory&gt; int main() { auto a = std::shared_ptr&lt;int&gt;(new int(3)); return *a + 40; } compiled with WASI SDK like this: clang++ --target=wasm32-wasi -O3 ...</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/rust-lang/rust/issues/73958" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/ef9dc0bd2adb901c38cf70821dc47a03166c6700\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f316337633062306163613266333730333664323234613565373836353564333762336633663465663132346364393535313836653963323037323831313936332f727573742d6c616e672f727573742f6973737565732f3733393538)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/rust-lang/rust/issues/73958" title="Ability from the top-level of the compilation not to mark #[no_mangle] items exported from shared library · Issue #73958 · rust-lang/rust">Ability from the top-level of the compilation not to mark #[no_mangle] items exported from shared library · Issue #73958 · rust-lang/rust</a></div><div class="message_embed_description">Firefox currently builds all its Rust code into a static artifact called gkrust which is then statically linked, with cross-language LTO, with C++ artifacts to form the shippable libxul.so/dylib/dl...</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/wasi-sdk/issues/190" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/b380733dcc0d559ae58edea0b40b3d7f5c70ae7c\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f343264313264613232383032336363616532343030303565636432613536373335386364373936336338623634303332663339643539616664626330373432662f576562417373656d626c792f776173692d73646b2f6973737565732f313930)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/wasi-sdk/issues/190" title="Avoid stdlib printing to stdout/stderr? · Issue #190 · WebAssembly/wasi-sdk">Avoid stdlib printing to stdout/stderr? · Issue #190 · WebAssembly/wasi-sdk</a></div><div class="message_embed_description">A very minimal code sample like this: #include &lt;memory&gt; int main() { auto a = std::shared_ptr&lt;int&gt;(new int(3)); return *a + 40; } compiled with WASI SDK like this: clang++ --target=wasm32-wasi -O3 ...</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/wasi-sdk/issues/220" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/8cf7688333fdefed46c96d2f7f9c0ded96b760af\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f626432313263373038386361666430356136303064663465333430656463623163353138663339623139643862383339343435643934373565626166373232642f576562417373656d626c792f776173692d73646b2f6973737565732f323230)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/wasi-sdk/issues/220" title="Using C++ string results in `fd_close`, `fd_seek` &amp; `fd_write`, even for BAREMETAL compile · Issue #220 · WebAssembly/wasi-sdk">Using C++ string results in `fd_close`, `fd_seek` &amp; `fd_write`, even for BAREMETAL compile · Issue #220 · WebAssembly/wasi-sdk</a></div><div class="message_embed_description">I am writing C++ code for the internet computer, and I am a bit stuck at the moment trying to use strings. I studied the discussion in this issue in great detail, and I made good progress after I e...</div></div></div>



<a name="428039582"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428039582" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428039582">(Mar 21 2024 at 00:47)</a>:</h4>
<p>It seems like <span class="user-mention" data-user-id="498825">@Sam Clegg</span> was pointing to <code>__stderr_used</code> as being some sort of strong reference preventing the LTO. I can see <code>__stderr_used</code> listed in <code>wasi-sdk/share/wasi-sysroot/share/wasm32-wasi/defined-symbols.txt</code> but no other mentions in the pre-built <code>wasi-sdk</code> package.</p>
<p>Maybe that's what was meant by needing to rebuild the SDK from source. I'm out of my depth but will give that a spin next.</p>



<a name="428129149"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428129149" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428129149">(Mar 21 2024 at 13:31)</a>:</h4>
<p>I've found a sneaky call to <code>printf</code> in the subset of QuickJS I'm consuming but something sneaky is still pulling in stdout. I see the following in the generated function table: </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$__stdio_write</span><span class="w"> </span><span class="cp">$__stdio_close</span><span class="w"> </span><span class="cp">$__stdout_write</span><span class="w"> </span><span class="cp">$__stdio_seek</span>
</code></pre></div>
<p>I can't figure out how to trace calls to those and perhaps nor can the linker.</p>



<a name="428129630"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428129630" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428129630">(Mar 21 2024 at 13:33)</a>:</h4>
<p>Have you tried using e.g. <code>wasm-tools print</code> to inspect the generated Wasm file and find out which functions are calling those imports?</p>



<a name="428130707"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428130707" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428130707">(Mar 21 2024 at 13:38)</a>:</h4>
<p>That's how I've been doing most of my manual analysis. Those functions are never called directly, but I can't figure out if they might be called indirectly through <code>br_table</code> (if I'm even understanding wasi instructions correctly).</p>



<a name="428131101"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428131101" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428131101">(Mar 21 2024 at 13:39)</a>:</h4>
<p>You could try adding <code>--trace-symbol=__stdio_write</code> to the linker flags; that can sometimes identify where the reference is coming from.</p>



<a name="428131372"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428131372" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428131372">(Mar 21 2024 at 13:41)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="254083">@Dan Gohman</span>, sorry for the noob question but where would I put this flag? I have a gut feeling that this might be in the linking of the wasi sdk against one of quickjs's c files but not sure.</p>



<a name="428131691"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428131691" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428131691">(Mar 21 2024 at 13:42)</a>:</h4>
<p>It depends on how the quickjs build works. If there's a Makefile involved, you might be able to add <code>-Wl,--trace-symbol=__stdio_write</code> to something like <code>LDFLAGS</code>.</p>



<a name="428132027"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428132027" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428132027">(Mar 21 2024 at 13:44)</a>:</h4>
<p>If Rust is doing the linking, setting the env var <code>RUSTFLAGS='-C link-args=--trace-symbol=__stdio_write'</code></p>



<a name="428132283"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428132283" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428132283">(Mar 21 2024 at 13:45)</a>:</h4>
<p>I'll try both! <span aria-label="goofy" class="emoji emoji-1f92a" role="img" title="goofy">:goofy:</span></p>



<a name="428132535"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428132535" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428132535">(Mar 21 2024 at 13:46)</a>:</h4>
<p>Oh, and I always forget how to tell cargo to not swallow linker diagnostic output.</p>



<a name="428132690"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428132690" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428132690">(Mar 21 2024 at 13:47)</a>:</h4>
<p>I'm running with <code>-vv</code> but I'm not seeing anything that looks like obvious traces</p>



<a name="428132990"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428132990" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428132990">(Mar 21 2024 at 13:48)</a>:</h4>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="nv">LDFLAGS</span><span class="o">=</span><span class="s2">"-Wl,--trace-symbol=__stdio_write"</span><span class="w"> </span><span class="se">\</span>
<span class="nv">RUSTFLAGS</span><span class="o">=</span><span class="s2">"-Zlocation-detail=none -C link-args=--trace-symbol=__stdio_write"</span><span class="w"> </span><span class="se">\</span>
<span class="nv">WASI_SDK</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">/../wasi-sdk/build/wasi-sdk-21.0.0ga50a641f4b5a+m"</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>cargo<span class="w"> </span>+nightly<span class="w"> </span>build<span class="w"> </span>-Z<span class="w"> </span>build-std<span class="o">=</span>std,panic_abort<span class="w"> </span>-Z<span class="w"> </span>build-std-features<span class="o">=</span>panic_immediate_abort<span class="w"> </span>--target<span class="w"> </span>wasm32-wasi<span class="w"> </span>--release<span class="w"> </span>-vv
</code></pre></div>



<a name="428133185"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428133185" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428133185">(Mar 21 2024 at 13:49)</a>:</h4>
<p>I'll try with a symbol that is legitimately being pulled</p>



<a name="428133938"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428133938" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428133938">(Mar 21 2024 at 13:52)</a>:</h4>
<p>Ok, the full magic is <code>RUSTC_LOG=rustc_codegen_ssa::back::link=info RUSTFLAGS='-C link-args=-Wl,--trace-symbol=__stdio_write' cargo build</code></p>



<a name="428134139"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428134139" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428134139">(Mar 21 2024 at 13:53)</a>:</h4>
<p>Also seems I had the wrong delimiter in RUSTFLAGS</p>



<a name="428134627"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428134627" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428134627">(Mar 21 2024 at 13:55)</a>:</h4>
<p>Hrm, it's complaining with this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">-</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">rust</span><span class="o">-</span><span class="n">lld</span>: <span class="nc">error</span>: <span class="nc">unknown</span><span class="w"> </span><span class="n">argument</span>: <span class="o">-</span><span class="n">Wl</span><span class="p">,</span><span class="o">--</span><span class="n">trace</span><span class="o">-</span><span class="n">symbol</span><span class="o">=</span><span class="n">__stdio_write</span>
</code></pre></div>



<a name="428134754"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428134754" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428134754">(Mar 21 2024 at 13:56)</a>:</h4>
<p>Ah, in that case, remove just the <code>-Wl,</code></p>



<a name="428134922"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428134922" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428134922">(Mar 21 2024 at 13:57)</a>:</h4>
<p>(that's the flag needed when using <code>clang</code> as the "linker", which some things do)</p>



<a name="428134960"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428134960" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428134960">(Mar 21 2024 at 13:57)</a>:</h4>
<p><span aria-label="boom" class="emoji emoji-1f4a5" role="img" title="boom">:boom:</span> we have liftoff. Here's what I'm seeing:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">INFO</span><span class="w"> </span><span class="n">rustc_codegen_ssa</span>::<span class="n">back</span>::<span class="n">link</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="n">stderr</span>:

<span class="nc">INFO</span><span class="w"> </span><span class="n">rustc_codegen_ssa</span>::<span class="n">back</span>::<span class="n">link</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="n">stdout</span>:
<span class="p">.</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">sysroot</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">__stdio_write</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">lazy</span><span class="w"> </span><span class="n">definition</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">__stdio_write</span>
<span class="p">.</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">sysroot</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">__stdout_write</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">reference</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">__stdio_write</span>
<span class="p">.</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">sysroot</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">__stdio_write</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">definition</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">__stdio_write</span>
<span class="p">.</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">sysroot</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">stderr</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">reference</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">__stdio_write</span>
</code></pre></div>



<a name="428135320"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428135320" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428135320">(Mar 21 2024 at 13:58)</a>:</h4>
<p>So that must be indicative of it being unable to optimize it away from the <code>wasi-libc</code> <code>libc.a</code>?</p>



<a name="428135482"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428135482" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428135482">(Mar 21 2024 at 13:59)</a>:</h4>
<p>The reference is coming from <code>stderr.o</code>, so maybe something is pulling in <code>stderr</code>. Try changing <code>__stdio_write</code> to <code>stderr</code></p>



<a name="428135845"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428135845" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428135845">(Mar 21 2024 at 14:01)</a>:</h4>
<p>Ahh... meeting time. Will have to dive back in a bit later but big thanks <span class="user-mention" data-user-id="254083">@Dan Gohman</span> and <span class="user-mention" data-user-id="509936">@Joel Dice</span>.</p>
<p>Now that you mention stderr, maybe it's back to the conclusions drawn in this comment: <a href="https://github.com/WebAssembly/wasi-sdk/issues/190#issuecomment-916783936">https://github.com/WebAssembly/wasi-sdk/issues/190#issuecomment-916783936</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/wasi-sdk/issues/190#issuecomment-916783936" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/b380733dcc0d559ae58edea0b40b3d7f5c70ae7c\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f343264313264613232383032336363616532343030303565636432613536373335386364373936336338623634303332663339643539616664626330373432662f576562417373656d626c792f776173692d73646b2f6973737565732f313930)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/wasi-sdk/issues/190#issuecomment-916783936" title="Avoid stdlib printing to stdout/stderr? · Issue #190 · WebAssembly/wasi-sdk">Avoid stdlib printing to stdout/stderr? · Issue #190 · WebAssembly/wasi-sdk</a></div><div class="message_embed_description">A very minimal code sample like this: #include &lt;memory&gt; int main() { auto a = std::shared_ptr&lt;int&gt;(new int(3)); return *a + 40; } compiled with WASI SDK like this: clang++ --target=wasm32-wasi -O3 ...</div></div></div>



<a name="428136950"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428136950" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428136950">(Mar 21 2024 at 14:05)</a>:</h4>
<p>That particular issue is specific to C++; is there C++ code in QuickJS?</p>



<a name="428155242"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428155242" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428155242">(Mar 21 2024 at 15:21)</a>:</h4>
<p>Ah, gotcha. AFAICT it's 100% C.</p>



<a name="428155560"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428155560" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428155560">(Mar 21 2024 at 15:22)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">INFO</span><span class="w"> </span><span class="n">rustc_codegen_ssa</span>::<span class="n">back</span>::<span class="n">link</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="n">stderr</span>:

<span class="nc">INFO</span><span class="w"> </span><span class="n">rustc_codegen_ssa</span>::<span class="n">back</span>::<span class="n">link</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="n">stdout</span>:
<span class="p">.</span><span class="n">wasi</span><span class="o">-</span><span class="n">sysroot</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">stderr</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">lazy</span><span class="w"> </span><span class="n">definition</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">stderr</span>
<span class="p">.</span><span class="n">wasi</span><span class="o">-</span><span class="n">sysroot</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">stderr</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">definition</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">stderr</span>
</code></pre></div>



<a name="428155757"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428155757" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428155757">(Mar 21 2024 at 15:23)</a>:</h4>
<p>Hmm, maybe also try <code>__stderr_FILE</code> or <code>__stderr_used</code></p>



<a name="428155891"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428155891" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428155891">(Mar 21 2024 at 15:24)</a>:</h4>
<p>Both <code>stderr.c</code> and <code>stdout.c</code> in <code>wasi-libc</code> look very similar.</p>



<a name="428162442"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428162442" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428162442">(Mar 21 2024 at 15:53)</a>:</h4>
<p><code>__stderr_used</code> gives: </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">INFO</span><span class="w"> </span><span class="n">rustc_codegen_ssa</span>::<span class="n">back</span>::<span class="n">link</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="n">stderr</span>:

<span class="nc">INFO</span><span class="w"> </span><span class="n">rustc_codegen_ssa</span>::<span class="n">back</span>::<span class="n">link</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="n">stdout</span>:
<span class="p">.</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">sysroot</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">__stdio_exit</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">lazy</span><span class="w"> </span><span class="n">definition</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">__stderr_used</span>
<span class="p">.</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">sysroot</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">__stdio_exit</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">definition</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">__stderr_used</span>
<span class="p">.</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">sysroot</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">stderr</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">definition</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">__stderr_used</span>
</code></pre></div>



<a name="428162669"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428162669" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428162669">(Mar 21 2024 at 15:54)</a>:</h4>
<p>And <code>__stderr_FILE</code>: </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">INFO</span><span class="w"> </span><span class="n">rustc_codegen_ssa</span>::<span class="n">back</span>::<span class="n">link</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="n">stderr</span>:

<span class="nc">INFO</span><span class="w"> </span><span class="n">rustc_codegen_ssa</span>::<span class="n">back</span>::<span class="n">link</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="n">stdout</span>:
<span class="p">.</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">sysroot</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">stderr</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">lazy</span><span class="w"> </span><span class="n">definition</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">__stderr_FILE</span>
<span class="p">.</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">sysroot</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">vfprintf</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">reference</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">__stderr_FILE</span>
<span class="p">.</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">sysroot</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">stderr</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">definition</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">__stderr_FILE</span>
<span class="p">.</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">sysroot</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">strtod</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">reference</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">__stderr_FILE</span>
</code></pre></div>



<a name="428162730"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428162730" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428162730">(Mar 21 2024 at 15:55)</a>:</h4>
<p>Quick Q: are there any <code>assert</code>s in the codebase? That can pull in stderr. Compiling with <code>-DNDEBUG</code> can disable that.</p>



<a name="428163049"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428163049" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428163049">(Mar 21 2024 at 15:56)</a>:</h4>
<p>Hrm, why does <code>strtod.o</code> reference <code>__stderr_FILE</code>?</p>



<a name="428163174"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428163174" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428163174">(Mar 21 2024 at 15:57)</a>:</h4>
<p>I'll be in a meeting for the next hour or so, but I'll do some investigation when I get back.</p>



<a name="428165008"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428165008" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428165008">(Mar 21 2024 at 16:04)</a>:</h4>
<p>There are definitely asserts in QuickJS. I did something terrible to try to work around that here: <a href="https://github.com/ggoodman/rquickjs/commit/a95736a505d92219c2bad46664cd18ab88e81c13">https://github.com/ggoodman/rquickjs/commit/a95736a505d92219c2bad46664cd18ab88e81c13</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/ggoodman/rquickjs/commit/a95736a505d92219c2bad46664cd18ab88e81c13" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/abb263dd3971b7e6363e79483609439d5aed9056\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f353665623136663065306137363365386265613532646138346265656564316530336363316336353136366262326366636138623133326635366531393265662f67676f6f646d616e2f72717569636b6a732f636f6d6d69742f61393537333661353035643932323139633262616434363636346364313861623838653831633133)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/ggoodman/rquickjs/commit/a95736a505d92219c2bad46664cd18ab88e81c13" title="Test overriding assert · ggoodman/rquickjs@a95736a">Test overriding assert · ggoodman/rquickjs@a95736a</a></div><div class="message_embed_description">High level bindings to the quickjs javascript engine - Test overriding assert · ggoodman/rquickjs@a95736a</div></div></div>



<a name="428166931"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428166931" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428166931">(Mar 21 2024 at 16:13)</a>:</h4>
<p>I think this might be what is pulling it in: <a href="https://github.com/WebAssembly/wasi-libc/blob/6593687e25f07526c4b92a20fe5ddf507599d5b3/libc-top-half/headers/private/printscan.h#L46-L52">https://github.com/WebAssembly/wasi-libc/blob/6593687e25f07526c4b92a20fe5ddf507599d5b3/libc-top-half/headers/private/printscan.h#L46-L52</a></p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="n">__attribute__</span><span class="p">((</span><span class="n">__cold__</span><span class="p">,</span><span class="w"> </span><span class="n">__noreturn__</span><span class="p">))</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">long_double_not_supported</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">abort</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">__noreturn__</span><span class="p">));</span>
<span class="w">    </span><span class="n">fputs</span><span class="p">(</span><span class="s">"Support for formatting long double values is currently disabled.</span><span class="se">\n</span><span class="s">"</span>
<span class="w">          </span><span class="s">"To enable it, "</span><span class="w"> </span><span class="n">__wasilibc_printscan_full_support_option</span><span class="w"> </span><span class="s">".</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">__stderr_FILE</span><span class="p">);</span>
<span class="w">    </span><span class="n">abort</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>AFAICT, the similar construct for floats is not being pulled in.</p>



<a name="428170181"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428170181" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428170181">(Mar 21 2024 at 16:27)</a>:</h4>
<p>I tried ripping out the fputs calls in there in my local wasi-sdk build. Maybe holding it wrong but didn't see the reference disappear.</p>



<a name="428171844"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428171844" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428171844">(Mar 21 2024 at 16:35)</a>:</h4>
<p>I think I'm either rebuilding the sdk incorrectly or I'm not correctly propagating its path to the <code>rquickjs</code> crate's build process.</p>



<a name="428175438"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428175438" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428175438">(Mar 21 2024 at 16:53)</a>:</h4>
<p>I'm going to try a full rebuild of wasi-libc.</p>



<a name="428182307"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428182307" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428182307">(Mar 21 2024 at 17:28)</a>:</h4>
<p>Almost there:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">INFO</span><span class="w"> </span><span class="n">rustc_codegen_ssa</span>::<span class="n">back</span>::<span class="n">link</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="n">stderr</span>:

<span class="nc">INFO</span><span class="w"> </span><span class="n">rustc_codegen_ssa</span>::<span class="n">back</span>::<span class="n">link</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="n">stdout</span>:
<span class="p">.</span><span class="n">wasi</span><span class="o">-</span><span class="n">sysroot</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">stderr</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">lazy</span><span class="w"> </span><span class="n">definition</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">__stderr_FILE</span>
</code></pre></div>



<a name="428185755"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428185755" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428185755">(Mar 21 2024 at 17:48)</a>:</h4>
<p>So AFAICT, that got rid of the two unexpected references to <code>__stderr_FILE</code> in <code>vfprintf</code> and <code>strtod</code>. They were both because of that pseudo-assertion around long long / long double support.</p>
<p>And yet, the wasi imports persist! They are stubborn.</p>



<a name="428198284"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428198284" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428198284">(Mar 21 2024 at 19:04)</a>:</h4>
<p>I notice that in <code>stdout.c</code> in <code>wasi-libc</code>, we reference <code>__stdout_write</code> while in <code>stderr.c</code>, we reference <code>__stdio_write</code>. Could there be some circular reference here preventing LTO?</p>
<p>Compare:</p>
<ul>
<li><a href="https://github.com/WebAssembly/wasi-libc/blob/6593687e25f07526c4b92a20fe5ddf507599d5b3/libc-top-half/musl/src/stdio/stdout.c#L12">https://github.com/WebAssembly/wasi-libc/blob/6593687e25f07526c4b92a20fe5ddf507599d5b3/libc-top-half/musl/src/stdio/stdout.c#L12</a></li>
<li><a href="https://github.com/WebAssembly/wasi-libc/blob/6593687e25f07526c4b92a20fe5ddf507599d5b3/libc-top-half/musl/src/stdio/stderr.c#L12">https://github.com/WebAssembly/wasi-libc/blob/6593687e25f07526c4b92a20fe5ddf507599d5b3/libc-top-half/musl/src/stdio/stderr.c#L12</a></li>
</ul>



<a name="428199244"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428199244" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428199244">(Mar 21 2024 at 19:11)</a>:</h4>
<p>Rebuilding wasi-libc and heating the room a bit.</p>



<a name="428201150"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428201150" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428201150">(Mar 21 2024 at 19:24)</a>:</h4>
<p>Got rid of the strong reference but still have the imports sneaking in.</p>



<a name="428205480"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428205480" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428205480">(Mar 21 2024 at 19:49)</a>:</h4>
<p>Pretty confused by this asymmetry:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">.</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">sysroot</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">stderr</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">lazy</span><span class="w"> </span><span class="n">definition</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">stderr</span>
<span class="p">.</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">sysroot</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">stdout</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">definition</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">stdout</span>
</code></pre></div>



<a name="428206359"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428206359" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428206359">(Mar 21 2024 at 19:55)</a>:</h4>
<p>stderr is never buffered, while stdout is buffered by default. <code>__stdout_write</code> has extra code for handling line-buffering if it's attached to a terminal.</p>



<a name="428206883"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428206883" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428206883">(Mar 21 2024 at 19:58)</a>:</h4>
<p>Here I am coming through with an axe when a scalpel is needed. Here's my hack-job so far: <a href="https://github.com/WebAssembly/wasi-libc/compare/main...ggoodman:wasi-libc:prune_stdio">https://github.com/WebAssembly/wasi-libc/compare/main...ggoodman:wasi-libc:prune_stdio</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/wasi-libc/compare/main...ggoodman:wasi-libc:prune_stdio" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/408ae646d94c57e9577593a31f4d99015ae5b33a\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f326134353962306436373031353161656533666636646132616138646131336236353135663633323265663061633363626665336230653838376262653131392f576562417373656d626c792f776173692d6c696263)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/wasi-libc/compare/main...ggoodman:wasi-libc:prune_stdio" title="Comparing WebAssembly:main...ggoodman:prune_stdio · WebAssembly/wasi-libc">Comparing WebAssembly:main...ggoodman:prune_stdio · WebAssembly/wasi-libc</a></div><div class="message_embed_description">WASI libc implementation for WebAssembly. Contribute to WebAssembly/wasi-libc development by creating an account on GitHub.</div></div></div>



<a name="428211076"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428211076" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428211076">(Mar 21 2024 at 20:24)</a>:</h4>
<p><span class="user-mention" data-user-id="254083">@Dan Gohman</span> do you have a hypothesis as to why one would be lazy and the other not?</p>



<a name="428211898"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428211898" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428211898">(Mar 21 2024 at 20:29)</a>:</h4>
<p>Not offhand. "lazy" here is about wasm-ld's handling of archive files, where <code>.o</code> files are only pulled in if a symbol in them is defined, but I don't know the specifics.</p>



<a name="428221587"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428221587" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428221587">(Mar 21 2024 at 21:33)</a>:</h4>
<p>Out of curiosity, is it within reason to compile against the <code>wasi-libc</code> source instead of built objects?</p>



<a name="428221654"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428221654" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428221654">(Mar 21 2024 at 21:33)</a>:</h4>
<p>There aren't Makefiles set up to work that way, unfortunately.</p>



<a name="428221669"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428221669" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428221669">(Mar 21 2024 at 21:33)</a>:</h4>
<p>If there were, then it'd be reasonable :-)</p>



<a name="428221869"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428221869" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428221869">(Mar 21 2024 at 21:35)</a>:</h4>
<p>Gotcha. I've spent my novelty tokens and taken a line of credit already.</p>



<a name="428222072"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428222072" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428222072">(Mar 21 2024 at 21:36)</a>:</h4>
<p>Do you have code you could publish somewhere, so I could take a look?</p>



<a name="428222162"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428222162" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428222162">(Mar 21 2024 at 21:37)</a>:</h4>
<p>Good idea. I'm not sure how to get my <code>wasi-libc</code> fork linked up to my rust project in a consumable way though.</p>



<a name="428222932"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428222932" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428222932">(Mar 21 2024 at 21:43)</a>:</h4>
<p>I'm working from the <code>bridge</code> branch in <a href="https://github.com/ggoodman/quicky/tree/bridge">https://github.com/ggoodman/quicky/tree/bridge</a>. That should already be linked to my fork of <code>rquickjs</code> but the <code>WASI_SDK</code> reference in <code>.cargo/config.toml</code> is relative to my local check-out.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/ggoodman/quicky/tree/bridge" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/b669a55f9310176d708e055e8402bfd938efddc3\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f386563333033396138633463303731336337356663663765376365393730313865323162623039323763636433616332323830353437383535333230643031652f67676f6f646d616e2f717569636b79)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/ggoodman/quicky/tree/bridge" title="GitHub - ggoodman/quicky at bridge">GitHub - ggoodman/quicky at bridge</a></div><div class="message_embed_description">Contribute to ggoodman/quicky development by creating an account on GitHub.</div></div></div>



<a name="428223094"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428223094" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428223094">(Mar 21 2024 at 21:44)</a>:</h4>
<p>I've been using this script to help w/ the cycle time between shots in the dark <span aria-label="joy" class="emoji emoji-1f602" role="img" title="joy">:joy:</span> <a href="https://github.com/ggoodman/quicky/blob/4d2d859c765bb337a9791a4e1b2dc367925d5916/scripts/build.sh#L6-L8">https://github.com/ggoodman/quicky/blob/4d2d859c765bb337a9791a4e1b2dc367925d5916/scripts/build.sh#L6-L8</a></p>



<a name="428223444"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428223444" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428223444">(Mar 21 2024 at 21:47)</a>:</h4>
<p>My fork of <code>wasi-sdk</code>: <a href="https://github.com/ggoodman/wasi-sdk/tree/strip-wasi-stdio">https://github.com/ggoodman/wasi-sdk/tree/strip-wasi-stdio</a></p>
<p>Points to <code>wasi-libc</code> that has these changes: <a href="https://github.com/WebAssembly/wasi-libc/compare/main...ggoodman:wasi-libc:prune_stdio">https://github.com/WebAssembly/wasi-libc/compare/main...ggoodman:wasi-libc:prune_stdio</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/ggoodman/wasi-sdk/tree/strip-wasi-stdio" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/d83dee816013ca1ab26ab1229cc0fee4805fcd25\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f616463353936376262366539356537666139383962316362633132363266663561333331643663643037306333613563636333663565653933363630396434662f67676f6f646d616e2f776173692d73646b)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/ggoodman/wasi-sdk/tree/strip-wasi-stdio" title="GitHub - ggoodman/wasi-sdk at strip-wasi-stdio">GitHub - ggoodman/wasi-sdk at strip-wasi-stdio</a></div><div class="message_embed_description">WASI-enabled WebAssembly C/C++ toolchain. Contribute to ggoodman/wasi-sdk development by creating an account on GitHub.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/wasi-libc/compare/main...ggoodman:wasi-libc:prune_stdio" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/408ae646d94c57e9577593a31f4d99015ae5b33a\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f326134353962306436373031353161656533666636646132616138646131336236353135663633323265663061633363626665336230653838376262653131392f576562417373656d626c792f776173692d6c696263)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/wasi-libc/compare/main...ggoodman:wasi-libc:prune_stdio" title="Comparing WebAssembly:main...ggoodman:prune_stdio · WebAssembly/wasi-libc">Comparing WebAssembly:main...ggoodman:prune_stdio · WebAssembly/wasi-libc</a></div><div class="message_embed_description">WASI libc implementation for WebAssembly. Contribute to WebAssembly/wasi-libc development by creating an account on GitHub.</div></div></div>



<a name="428223510"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428223510" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428223510">(Mar 21 2024 at 21:47)</a>:</h4>
<p>That would be a lot of work to repro. I might be able to get a setup where only <code>quicky</code> needs to be pulled.</p>



<a name="428244715"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428244715" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428244715">(Mar 22 2024 at 01:21)</a>:</h4>
<p>The workflow is now described and show be reproducible here: <a href="https://github.com/ggoodman/quicky/tree/bridge">https://github.com/ggoodman/quicky/tree/bridge</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/ggoodman/quicky/tree/bridge" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/b669a55f9310176d708e055e8402bfd938efddc3\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f386563333033396138633463303731336337356663663765376365393730313865323162623039323763636433616332323830353437383535333230643031652f67676f6f646d616e2f717569636b79)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/ggoodman/quicky/tree/bridge" title="GitHub - ggoodman/quicky at bridge">GitHub - ggoodman/quicky at bridge</a></div><div class="message_embed_description">Contribute to ggoodman/quicky development by creating an account on GitHub.</div></div></div>



<a name="428249294"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428249294" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428249294">(Mar 22 2024 at 02:14)</a>:</h4>
<p>A new potential lead is <code>__stdio_exit</code> that I'm seeing getting linked. It seems like <code>__toread</code> and <code>__towrite</code> might both cause those weak references to become strong references:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="cm">/* atexit.c and __stdio_exit.c override these. the latter is linked</span>
<span class="cm"> * as a consequence of linking either __toread.c or __towrite.c. */</span>
<span class="n">weak_alias</span><span class="p">(</span><span class="n">dummy</span><span class="p">,</span><span class="w"> </span><span class="n">__funcs_on_exit</span><span class="p">);</span>
<span class="n">weak_alias</span><span class="p">(</span><span class="n">dummy</span><span class="p">,</span><span class="w"> </span><span class="n">__stdio_exit</span><span class="p">);</span>
</code></pre></div>
<p>I'm seeing this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">..</span><span class="p">.</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">__stdio_close</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">lazy</span><span class="w"> </span><span class="n">definition</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">__stdio_close</span>
<span class="o">..</span><span class="p">.</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">__stdio_seek</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">lazy</span><span class="w"> </span><span class="n">definition</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">__stdio_seek</span>
<span class="o">..</span><span class="p">.</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">__stdio_write</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">lazy</span><span class="w"> </span><span class="n">definition</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">__stdio_write</span>
<span class="o">..</span><span class="p">.</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">__toread</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">lazy</span><span class="w"> </span><span class="n">definition</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">__toread</span>
<span class="o">..</span><span class="p">.</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">__towrite</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">lazy</span><span class="w"> </span><span class="n">definition</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">__towrite</span>
<span class="o">..</span><span class="p">.</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">__overflow</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">reference</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">__towrite</span>
<span class="o">..</span><span class="p">.</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">__towrite</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">definition</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">__towrite</span>
<span class="o">..</span><span class="p">.</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">fwrite</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">reference</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">__towrite</span>
<span class="o">..</span><span class="p">.</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">stderr</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">lazy</span><span class="w"> </span><span class="n">definition</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">stderr</span>
<span class="o">..</span><span class="p">.</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">stdout</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">reference</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">__stdio_close</span>
<span class="o">..</span><span class="p">.</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">__stdio_close</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">definition</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">__stdio_close</span>
<span class="o">..</span><span class="p">.</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">stdout</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">reference</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">__stdio_write</span>
<span class="o">..</span><span class="p">.</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">__stdio_write</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">definition</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">__stdio_write</span>
<span class="o">..</span><span class="p">.</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">stdout</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">reference</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">__stdio_seek</span>
<span class="o">..</span><span class="p">.</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">__stdio_seek</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">definition</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">__stdio_seek</span>
<span class="o">..</span><span class="p">.</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">stdout</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">definition</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">stdout</span>
<span class="o">..</span><span class="p">.</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">vfprintf</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">reference</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">__towrite</span>
<span class="o">..</span><span class="p">.</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">__uflow</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">reference</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">__toread</span>
<span class="o">..</span><span class="p">.</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasi</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">__toread</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>: <span class="nc">definition</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">__toread</span>
</code></pre></div>



<a name="428249622"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428249622" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428249622">(Mar 22 2024 at 02:18)</a>:</h4>
<p>One nuance is that this project is designed to be run through wizer. I only see an obvious reference to <code>__stdio_exit</code> here: </p>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code>  <span class="p">(</span><span class="k">func</span> <span class="nv">$__wasm_call_dtors</span> <span class="cm">(;630;)</span> <span class="p">(</span><span class="k">type</span> <span class="mi">72</span><span class="p">)</span>
    <span class="nb">call</span> <span class="nv">$#func629&lt;dummy&gt;</span>
    <span class="nb">call</span> <span class="nv">$__stdio_exit</span>
  <span class="p">)</span>
  <span class="p">(</span><span class="k">func</span> <span class="nv">$init.command_export</span> <span class="cm">(;631;)</span> <span class="p">(</span><span class="k">type</span> <span class="mi">31</span><span class="p">)</span> <span class="p">(</span><span class="k">result</span> <span class="kt">i32</span><span class="p">)</span>
    <span class="nb">call</span> <span class="nv">$init</span>
    <span class="nb">call</span> <span class="nv">$__wasm_call_dtors</span>
  <span class="p">)</span>
</code></pre></div>



<a name="428250272"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428250272" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428250272">(Mar 22 2024 at 02:27)</a>:</h4>
<p>Is there a way to elect out of calling destructors?</p>



<a name="428332340"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428332340" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428332340">(Mar 22 2024 at 13:42)</a>:</h4>
<p>Lots of learning for me going down this rabbit hole but now I'm hoping to rein it back in. I think it's probably worth trying to come up with a minimal repro here. Any hypotheses on the shape of a minimal c library I can wrap in rust bindings to produce what we're seeing here?</p>



<a name="428378073"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428378073" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428378073">(Mar 22 2024 at 17:24)</a>:</h4>
<p>OK <span class="user-mention" data-user-id="254083">@Dan Gohman</span> I think I have a pretty sweet, mostly minimal repro here: <a href="https://github.com/ggoodman/wasi-import-repro">https://github.com/ggoodman/wasi-import-repro</a></p>
<p>The key finding is that the very presence of a <code>printf</code> call in a c library results in those <code>fd_*</code> imports getting pulled along even if we _know_ that the code calling <code>printf</code> is being eliminated by the linker.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/ggoodman/wasi-import-repro" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/6767469bbfcf6ec0a2d95f2b84d5e0fc241cce27\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f666638303534643836353239383230373961393631396132383031306162613237306537303166633236633163316263656537383166323537373438666264632f67676f6f646d616e2f776173692d696d706f72742d726570726f)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/ggoodman/wasi-import-repro" title="GitHub - ggoodman/wasi-import-repro">GitHub - ggoodman/wasi-import-repro</a></div><div class="message_embed_description">Contribute to ggoodman/wasi-import-repro development by creating an account on GitHub.</div></div></div>



<a name="428379458"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428379458" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428379458">(Mar 22 2024 at 17:33)</a>:</h4>
<p>This is showing that a rust function that references a c binding referencing a call to printf is enough, <strong>even if the rust function is omitted by a feature flag</strong>.</p>



<a name="428382627"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/428382627" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#428382627">(Mar 22 2024 at 17:52)</a>:</h4>
<p>Filed an issue here: <a href="https://github.com/WebAssembly/wasi-sdk/issues/401">https://github.com/WebAssembly/wasi-sdk/issues/401</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/wasi-sdk/issues/401" style="background-image: url(https\:\/\/uploads\.zulipusercontent\.net\/047b6f8847ee282146f38d6e7905687304b495f0\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f373366373464376533373934346263646466363565613638376231323239343434373631663064663738326464353832663663346564366435333131316162382f576562417373656d626c792f776173692d73646b2f6973737565732f343031)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/wasi-sdk/issues/401" title="LTO failing to prune WASI fd_* imports · Issue #401 · WebAssembly/wasi-sdk">LTO failing to prune WASI fd_* imports · Issue #401 · WebAssembly/wasi-sdk</a></div><div class="message_embed_description">In this repo, I've shown two scenarios where code that is functionally identical produces very different WASM binaries. Setup The two scenarios I'm testing are for a rust cdylib whose code looks li...</div></div></div>



<a name="437841611"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/437841611" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#437841611">(May 09 2024 at 15:46)</a>:</h4>
<p>Thinking more about this, I have the hypothesis that it's the finalizers that could be holding onto strong references.</p>
<p>That made me wonder (at least for my use-case) if I actually _cared_ about finalizers and clean-up. The main use-case I have at work uses a WASM instance exactly once and throws it away. All work after producing a 'result' is essentially wasted cycles as far as I'm concerned.</p>
<p>So I wonder if tooling could be parametrized for this sort of use-case... Could we tell the wasi-sdk / wasi-libc that we don't actually care about clean-up? In other words, the host and runtime can handle that for us. I understand that this wouldn't be a general-purpose strategy which is why I'm wondering about some opt-in behaviour. Does it sound feasible?</p>



<a name="437842671"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/437842671" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#437842671">(May 09 2024 at 15:53)</a>:</h4>
<p>AFAIK, <code>wasi-libc</code> generally won't clean anything up unless you tell it to (e.g. by closing a file descriptor).  So I think the answer in your case is: "don't call <code>close</code>" (which at the Rust level means e.g. wrapping a <code>File</code> in <code>ManuallyDrop</code> and never dropping it).</p>



<a name="437843052"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/437843052" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#437843052">(May 09 2024 at 15:55)</a>:</h4>
<p>But maybe you're asking for an optional build of <code>wasi-libc</code> where <code>close</code> is a no-op?</p>



<a name="438033619"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/235408-rust-toolchain/topic/Finding%20and%20eliminating%20wasm32-wasi%20imports/near/438033619" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Goodman <a href="https://bytecodealliance.github.io/zulip-archive/stream/235408-rust-toolchain/topic/Finding.20and.20eliminating.20wasm32-wasi.20imports.html#438033619">(May 10 2024 at 19:09)</a>:</h4>
<p>I think the solution when using rust is a bit easier but the use-case that confounds me is when building a c library against wasi-libc--and especially one whose source code I don't control.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>