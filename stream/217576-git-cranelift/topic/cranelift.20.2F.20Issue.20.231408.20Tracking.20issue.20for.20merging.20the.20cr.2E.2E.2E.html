<html>
<head><meta charset="utf-8"><title>cranelift / Issue #1408 Tracking issue for merging the cr... · git-cranelift · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/index.html">git-cranelift</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231408.20Tracking.20issue.20for.20merging.20the.20cr.2E.2E.2E.html">cranelift / Issue #1408 Tracking issue for merging the cr...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="189048564"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231408%20Tracking%20issue%20for%20merging%20the%20cr.../near/189048564" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231408.20Tracking.20issue.20for.20merging.20the.20cr.2E.2E.2E.html#189048564">(Feb 25 2020 at 18:49)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/cranelift/issues/1408" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1408">Issue #1408</a>:</p>
<blockquote>
<p>Discussed at yesterday's meeting I wanted to open an issue tracking progress for merging the wasmtime/cranelift repositories. I think there are three major work items that need to happen:</p>
<h2>Performing the actual merge</h2>
<p>There's a few different ways to do the merge here, but I'd like to propose that the following steps are done. </p>
<ul>
<li>Run <code>git filter-branch --tree-filter $HOME/rewrite-cranelift.sh HEAD</code> in the cranelift repository on the commit we want to merge in. The script <a href="https://gist.github.com/alexcrichton/c85fa26854af2d58142b6675027961b3" target="_blank" title="https://gist.github.com/alexcrichton/c85fa26854af2d58142b6675027961b3">looks like this</a>.</li>
<li>Next create a merge commit with the wasmtime head commit and this new commit. The state at this point would look like <a href="https://github.com/alexcrichton/wasmtime/tree/cranelift-merge" target="_blank" title="https://github.com/alexcrichton/wasmtime/tree/cranelift-merge">https://github.com/alexcrichton/wasmtime/tree/cranelift-merge</a><ul>
<li>This needs the <code>--allow-unrelated-histories</code> flag</li>
</ul>
</li>
<li>Next do a bunch of manual work including:<ul>
<li>Merge CI systems</li>
<li>Tidy up readmes/top-level markdowns/licenses/etc</li>
<li>Tidy up workspaces so there's only one</li>
<li>Update various scripts for testing</li>
</ul>
</li>
</ul>
<p>I suspect the last part is going to be pretty significant here, so I'll be prototyping that before we actually do the merge since we want the "shut down window" to be as small as possible. I'll post here with the work when I get it set up. If folks have workflows though that go beyond <code>cargo test</code> and want to make sure any scripts and such keep working, let me know! I'll try to make sure they work in the new repository.</p>
<h2>Transferring open issues</h2>
<p>This will involve creating a script to migrate all open issues from the bytecodealliance/cranelift repository to bytecodealliance/wasmtime. I don't believe such a script exists, but it'll get gisted here before the move is done.</p>
<h2>Making it easier to migrate open PRs</h2>
<p>I'm on the hook for creating <em>something</em> to make it easy-ish to transfer open PRs to the wasmtime repository. My current thinking is the script would look like:</p>
<ul>
<li>Fork wasmtime</li>
<li>Go into your local cranelift repository</li>
<li>Check out your PR</li>
<li>Squash your commits into one commit, <code>$pr</code></li>
<li>`git remote add wasmtime <a href="https://github.com/bytecodealliance/wasmtime" target="_blank" title="https://github.com/bytecodealliance/wasmtime">https://github.com/bytecodealliance/wasmtime</a></li>
<li><code>git fetch wasmtime</code></li>
<li><code>git merge-base $pr wasmtime/master</code> -- record this as <code>$base</code></li>
<li>Run <code>git diff $base...$pr &gt; foo.patch</code></li>
<li>Somehow edit the paths in <code>foo.patch</code> to all point to <code>crates/cranelift/*</code> instead of <code>cranelift-*</code></li>
<li>Save <code>foo.patch</code> somewhere else</li>
<li><code>git reset --hard wasmtime/master</code></li>
<li><code>patch -Np1 &lt; foo.patch</code></li>
<li><code>git commit -C $pr</code></li>
<li>Push that commit as a PR against wasmtime</li>
</ul>
<p>I'll run through this myself and confirm this works, posting the results here.</p>
</blockquote>



<a name="189048942"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231408%20Tracking%20issue%20for%20merging%20the%20cr.../near/189048942" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231408.20Tracking.20issue.20for.20merging.20the.20cr.2E.2E.2E.html#189048942">(Feb 25 2020 at 18:54)</a>:</h4>
<p>iximeow <a href="https://github.com/bytecodealliance/cranelift/issues/1408#issuecomment-591010420" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1408#issuecomment-591010420">commented</a> on <a href="https://github.com/bytecodealliance/cranelift/issues/1408" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1408">Issue #1408</a>:</p>
<blockquote>
<p>Has there been discussion of _why_ we want to merge the Cranelift and Wasmtime repos somewhere? I know it's been on the cranelift meeting agenda for the past few weeks but I never saw context for it there either.</p>
</blockquote>



<a name="189049257"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231408%20Tracking%20issue%20for%20merging%20the%20cr.../near/189049257" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231408.20Tracking.20issue.20for.20merging.20the.20cr.2E.2E.2E.html#189049257">(Feb 25 2020 at 18:57)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/cranelift/issues/1408#issuecomment-591012182" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1408#issuecomment-591012182">commented</a> on <a href="https://github.com/bytecodealliance/cranelift/issues/1408" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1408">Issue #1408</a>:</p>
<blockquote>
<ul>
<li>
<p>Can the crates be moved to <code>cranelift/*</code> instead of <code>crates/cranelift/*</code>, to avoid a level of indirection?</p>
</li>
<li>
<p>How should open PR's be migrated? Re-opening them in the new repo will loose scatter the discussion.</p>
</li>
<li>
<p>Merging Cranelift and Wasmtime doesn't make much sense to me. Cranelift is independent of Wasmtime, and is a dependency of many other projects, like wasmer, lucet, rustc_codegen_cranelift, ... By merging the Cranelift and Wasmtime repo's people will likely think that Cranelift is tightly coupled to Wasmtime.</p>
</li>
</ul>
</blockquote>



<a name="189049376"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231408%20Tracking%20issue%20for%20merging%20the%20cr.../near/189049376" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231408.20Tracking.20issue.20for.20merging.20the.20cr.2E.2E.2E.html#189049376">(Feb 25 2020 at 18:58)</a>:</h4>
<p>bjorn3 edited a <a href="https://github.com/bytecodealliance/cranelift/issues/1408#issuecomment-591012182" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1408#issuecomment-591012182">comment</a> on <a href="https://github.com/bytecodealliance/cranelift/issues/1408" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1408">Issue #1408</a>:</p>
<blockquote>
<ul>
<li>
<p>Can the crates be moved to <code>cranelift/*</code> instead of <code>crates/cranelift/*</code>, to avoid a level of indirection?</p>
</li>
<li>
<p>Re-opening PR's on the new repo will scatter the discussion between the old cranelift repo and the new wasmtime + cranelift repo.</p>
</li>
<li>
<p>Merging Cranelift and Wasmtime doesn't make much sense to me. Cranelift is independent of Wasmtime, and is a dependency of many other projects, like wasmer, lucet, rustc_codegen_cranelift, ... By merging the Cranelift and Wasmtime repo's people will likely think that Cranelift is tightly coupled to Wasmtime.</p>
</li>
</ul>
</blockquote>



<a name="189049565"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231408%20Tracking%20issue%20for%20merging%20the%20cr.../near/189049565" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231408.20Tracking.20issue.20for.20merging.20the.20cr.2E.2E.2E.html#189049565">(Feb 25 2020 at 19:01)</a>:</h4>
<p>bjorn3 edited a <a href="https://github.com/bytecodealliance/cranelift/issues/1408#issuecomment-591012182" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1408#issuecomment-591012182">comment</a> on <a href="https://github.com/bytecodealliance/cranelift/issues/1408" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1408">Issue #1408</a>:</p>
<blockquote>
<ul>
<li>
<p>Can the crates be moved to <code>cranelift/*</code> instead of <code>crates/cranelift/*</code>, to avoid a level of indirection?</p>
</li>
<li>
<p>Re-opening PR's on the new repo will scatter the discussion between the old cranelift repo and the new wasmtime + cranelift repo.</p>
</li>
<li>
<p>Merging Cranelift and Wasmtime doesn't make much sense to me. Cranelift is independent of Wasmtime, and is a dependency of many other projects, like wasmer, lucet, rustc_codegen_cranelift, ... By merging the Cranelift and Wasmtime repo's people will likely think that Cranelift is tightly coupled to Wasmtime.</p>
</li>
<li>
<p>By merging Cranelift and Wasmtime, I either have to accept that I will get notifications about Wasmtime issues and PR's, which I am <strong>not</strong> interested in, or I have to unwatch the combined repo, in which case I will miss Cranelift issues and PR's, which I <strong>am</strong> interested in.</p>
</li>
</ul>
</blockquote>



<a name="189055451"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231408%20Tracking%20issue%20for%20merging%20the%20cr.../near/189055451" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231408.20Tracking.20issue.20for.20merging.20the.20cr.2E.2E.2E.html#189055451">(Feb 25 2020 at 20:03)</a>:</h4>
<p>alexcrichton edited <a href="https://github.com/bytecodealliance/cranelift/issues/1408" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1408">Issue #1408</a>:</p>
<blockquote>
<p>Discussed at yesterday's meeting I wanted to open an issue tracking progress for merging the wasmtime/cranelift repositories. I think there are three major work items that need to happen:</p>
<h2>Performing the actual merge</h2>
<p>There's a few different ways to do the merge here, but I'd like to propose that the following steps are done. </p>
<ul>
<li>Run <code>git filter-branch --tree-filter $HOME/rewrite-cranelift.sh HEAD</code> in the cranelift repository on the commit we want to merge in. The script <a href="https://gist.github.com/alexcrichton/c85fa26854af2d58142b6675027961b3" target="_blank" title="https://gist.github.com/alexcrichton/c85fa26854af2d58142b6675027961b3">looks like this</a>.</li>
<li>Next create a merge commit with the wasmtime head commit and this new commit. The state at this point would look like <a href="https://github.com/alexcrichton/wasmtime/tree/cranelift-merge" target="_blank" title="https://github.com/alexcrichton/wasmtime/tree/cranelift-merge">https://github.com/alexcrichton/wasmtime/tree/cranelift-merge</a><ul>
<li>This needs the <code>--allow-unrelated-histories</code> flag</li>
</ul>
</li>
<li>Next do a bunch of manual work including:<ul>
<li>Merge CI systems</li>
<li>Tidy up readmes/top-level markdowns/licenses/etc</li>
<li>Tidy up workspaces so there's only one</li>
<li>Update various scripts for testing</li>
<li><a href="https://github.com/alexcrichton/wasmtime/commits/cranelift-merge-afterwards" target="_blank" title="https://github.com/alexcrichton/wasmtime/commits/cranelift-merge-afterwards">You can see a preview of this work</a> and what all got merged/moved</li>
</ul>
</li>
</ul>
<p>If folks have workflows though that go beyond <code>cargo test</code> and want to make sure any scripts and such keep working, let me know! I'll try to make sure they work in the new repository.</p>
<h2>Transferring open issues</h2>
<p>This will involve creating a script to migrate all open issues from the bytecodealliance/cranelift repository to bytecodealliance/wasmtime. I don't believe such a script exists, but it'll get gisted here before the move is done.</p>
<p>I think the general guidelines for this will be:</p>
<ul>
<li>Audit <a href="https://github.com/bytecodealliance/wasmtime/labels" target="_blank" title="https://github.com/bytecodealliance/wasmtime/labels">wasmtime labels</a> to ensure that they contain all relevant <a href="https://github.com/bytecodealliance/cranelift/labels" target="_blank" title="https://github.com/bytecodealliance/cranelift/labels">cranelift labels</a>. We should have a mapping from all cranelift labels to wasmtime labels.</li>
<li>Use GitHub's transfer issue feature to transfer all issues, using the above label mapping, to transfer issues to the wasmtime repository.</li>
</ul>
<h2>Making it easier to migrate open PRs</h2>
<p>I'm on the hook for creating <em>something</em> to make it easy-ish to transfer open PRs to the wasmtime repository. My current thinking is the script would look like:</p>
<ul>
<li>Fork wasmtime</li>
<li>Go into your local cranelift repository</li>
<li>Check out your PR</li>
<li>Squash your commits into one commit, <code>$pr</code></li>
<li>`git remote add wasmtime <a href="https://github.com/bytecodealliance/wasmtime" target="_blank" title="https://github.com/bytecodealliance/wasmtime">https://github.com/bytecodealliance/wasmtime</a></li>
<li><code>git fetch wasmtime</code></li>
<li><code>git merge-base $pr wasmtime/master</code> -- record this as <code>$base</code></li>
<li>Run <code>git diff $base...$pr &gt; foo.patch</code></li>
<li>Somehow edit the paths in <code>foo.patch</code> to all point to <code>crates/cranelift/*</code> instead of <code>cranelift-*</code></li>
<li>Save <code>foo.patch</code> somewhere else</li>
<li><code>git reset --hard wasmtime/master</code></li>
<li><code>patch -Np1 &lt; foo.patch</code></li>
<li><code>git commit -C $pr</code></li>
<li>Push that commit as a PR against wasmtime</li>
</ul>
<p>I'll run through this myself and confirm this works, posting the results here.</p>
</blockquote>



<a name="189057206"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231408%20Tracking%20issue%20for%20merging%20the%20cr.../near/189057206" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231408.20Tracking.20issue.20for.20merging.20the.20cr.2E.2E.2E.html#189057206">(Feb 25 2020 at 20:22)</a>:</h4>
<p>tschneidereit <a href="https://github.com/bytecodealliance/cranelift/issues/1408#issuecomment-591050388" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1408#issuecomment-591050388">commented</a> on <a href="https://github.com/bytecodealliance/cranelift/issues/1408" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1408">Issue #1408</a>:</p>
<blockquote>
<p>The merge was discussed a few months ago. Originally we had wanted to do this as part of the move to the Bytecode Alliance GitHub org, but then had to put it on the backburner because it became clear that the complications @alexcrichton mentions above would take longer to work through.</p>
<p>I'll give a longer explanation below, but to put one thing front-and-center, <strong>the merge is not in any way about tightly coupling Cranelift to Wasmtime</strong>. Speaking with my Mozilla hat on, that doesn't make sense, because SpiderMonkey is, if anything, the more important embedding. And neither does it make sense from a Bytecode Alliance perspective: as @bjorn3 points out, with Lucet we have another embedding that's in production and really important. And we're also big fans of rustc_codegen_cranelift, and certainly don't want that to not be supported.</p>
<p>The current setup causes us to have significant inefficiencies in our workflows, because we often have to do things in Cranelift and a runtime in parallel, and coordinate landing and CI runs, etc. We realized this will become much worse over time, because we need to be able to fully test features that have tight compiler/runtime interactions.</p>
<p>Right now, we have somewhat rudimentary support for testing these kinds of features in Cranelift, but with various upcoming features—such as Interface Types, Linking, and GC—we need something much more sophisticated. We came to the conclusion that by far the best way to do this is to have that runtime be Wasmtime, because otherwise we'd end up duplicating a lot of functionality. And we'd not really have something that's production-quality, meaning that the quality of the integration would always be worse than what it could be with Wasmtime.</p>
<p>Unfortunately, this is currently not possible: circular dependencies are hugely painful across separate repositories, and just doesn't seem viable. Hence the plan to merge the repositories.</p>
<p>We believe the downsides this brings are solidly outweighed by the advantage of improving the productivity of people working on both Cranelift and Wasmtime—and thus ultimately also benefit other embeddings of Cranelift.</p>
<p>We’ll of course continue doing individual crate releases on <a href="http://crates.io" target="_blank" title="http://crates.io">crates.io</a>, and we’ll make sure to have good Cranelift documentation independent from Wasmtime. We’ll provide more info about good workflows (including things around notification handling) based on these merged repositories once we get closer to actually doing the merge.</p>
</blockquote>



<a name="189077950"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231408%20Tracking%20issue%20for%20merging%20the%20cr.../near/189077950" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231408.20Tracking.20issue.20for.20merging.20the.20cr.2E.2E.2E.html#189077950">(Feb 26 2020 at 01:10)</a>:</h4>
<p>alexcrichton edited <a href="https://github.com/bytecodealliance/cranelift/issues/1408" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1408">Issue #1408</a>:</p>
<blockquote>
<p>Discussed at yesterday's meeting I wanted to open an issue tracking progress for merging the wasmtime/cranelift repositories. I think there are three major work items that need to happen:</p>
<h2>Performing the actual merge</h2>
<p>There's a few different ways to do the merge here, but I'd like to propose that the following steps are done. </p>
<ul>
<li>Run <code>git filter-branch --tree-filter $HOME/rewrite-cranelift.sh HEAD</code> in the cranelift repository on the commit we want to merge in. The script <a href="https://gist.github.com/alexcrichton/c85fa26854af2d58142b6675027961b3" target="_blank" title="https://gist.github.com/alexcrichton/c85fa26854af2d58142b6675027961b3">looks like this</a>.</li>
<li>Next create a merge commit with the wasmtime head commit and this new commit. The state at this point would look like <a href="https://github.com/alexcrichton/wasmtime/tree/cranelift-merge" target="_blank" title="https://github.com/alexcrichton/wasmtime/tree/cranelift-merge">https://github.com/alexcrichton/wasmtime/tree/cranelift-merge</a><ul>
<li>This needs the <code>--allow-unrelated-histories</code> flag</li>
</ul>
</li>
<li>Next do a bunch of manual work including:<ul>
<li>Merge CI systems</li>
<li>Tidy up readmes/top-level markdowns/licenses/etc</li>
<li>Tidy up workspaces so there's only one</li>
<li>Update various scripts for testing</li>
<li><a href="https://github.com/alexcrichton/wasmtime/commits/cranelift-merge-afterwards" target="_blank" title="https://github.com/alexcrichton/wasmtime/commits/cranelift-merge-afterwards">You can see a preview of this work</a> and what all got merged/moved</li>
</ul>
</li>
</ul>
<p>If folks have workflows though that go beyond <code>cargo test</code> and want to make sure any scripts and such keep working, let me know! I'll try to make sure they work in the new repository.</p>
<h2>Transferring open issues</h2>
<p>This will involve creating a script to migrate all open issues from the bytecodealliance/cranelift repository to bytecodealliance/wasmtime. </p>
<p>I think the general guidelines for this will be:</p>
<ul>
<li>Audit <a href="https://github.com/bytecodealliance/wasmtime/labels" target="_blank" title="https://github.com/bytecodealliance/wasmtime/labels">wasmtime labels</a> to ensure that they contain all relevant <a href="https://github.com/bytecodealliance/cranelift/labels" target="_blank" title="https://github.com/bytecodealliance/cranelift/labels">cranelift labels</a>. We should have a mapping from all cranelift labels to wasmtime labels.</li>
<li>Use GitHub's transfer issue feature to transfer all issues, using the above label mapping, to transfer issues to the wasmtime repository.</li>
</ul>
<p>script: <a href="https://gist.github.com/alexcrichton/ef102cb315e548c92fd671c198da9aa2" target="_blank" title="https://gist.github.com/alexcrichton/ef102cb315e548c92fd671c198da9aa2">https://gist.github.com/alexcrichton/ef102cb315e548c92fd671c198da9aa2</a></p>
<h2>Making it easier to migrate open PRs</h2>
<p>I'm on the hook for creating <em>something</em> to make it easy-ish to transfer open PRs to the wasmtime repository. My current thinking is the script would look like:</p>
<ul>
<li>Fork wasmtime</li>
<li>Go into your local cranelift repository</li>
<li>Check out your PR</li>
<li>Squash your commits into one commit, <code>$pr</code></li>
<li>`git remote add wasmtime <a href="https://github.com/bytecodealliance/wasmtime" target="_blank" title="https://github.com/bytecodealliance/wasmtime">https://github.com/bytecodealliance/wasmtime</a></li>
<li><code>git fetch wasmtime</code></li>
<li><code>git merge-base $pr wasmtime/master</code> -- record this as <code>$base</code></li>
<li>Run <code>git diff $base...$pr &gt; foo.patch</code></li>
<li>Somehow edit the paths in <code>foo.patch</code> to all point to <code>crates/cranelift/*</code> instead of <code>cranelift-*</code></li>
<li>Save <code>foo.patch</code> somewhere else</li>
<li><code>git reset --hard wasmtime/master</code></li>
<li><code>patch -Np1 &lt; foo.patch</code></li>
<li><code>git commit -C $pr</code></li>
<li>Push that commit as a PR against wasmtime</li>
</ul>
<p>I'll run through this myself and confirm this works, posting the results here.</p>
</blockquote>



<a name="189077977"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231408%20Tracking%20issue%20for%20merging%20the%20cr.../near/189077977" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231408.20Tracking.20issue.20for.20merging.20the.20cr.2E.2E.2E.html#189077977">(Feb 26 2020 at 01:11)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/cranelift/issues/1408#issuecomment-591182868" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1408#issuecomment-591182868">commented</a> on <a href="https://github.com/bytecodealliance/cranelift/issues/1408" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1408">Issue #1408</a>:</p>
<blockquote>
<p>Ok I've created a sample repository of what the final merge looks like -- <a href="https://github.com/alexcrichton/wasmtime/commits/cranelift-merge-afterwards" target="_blank" title="https://github.com/alexcrichton/wasmtime/commits/cranelift-merge-afterwards">https://github.com/alexcrichton/wasmtime/commits/cranelift-merge-afterwards</a> -- which has merges of CI, fuzzers, documentation, etc. Feel free to play around in that repo and let me know if you find any issues! </p>
<p>I've also created a script -- <a href="https://gist.github.com/alexcrichton/ef102cb315e548c92fd671c198da9aa2" target="_blank" title="https://gist.github.com/alexcrichton/ef102cb315e548c92fd671c198da9aa2">https://gist.github.com/alexcrichton/ef102cb315e548c92fd671c198da9aa2</a> -- to transfer all issues from one repository to another, while preserving labels. Tomorrow I'll work on how to transfer PRs in an "easy" fashion.</p>
</blockquote>



<a name="189129625"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231408%20Tracking%20issue%20for%20merging%20the%20cr.../near/189129625" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231408.20Tracking.20issue.20for.20merging.20the.20cr.2E.2E.2E.html#189129625">(Feb 26 2020 at 16:19)</a>:</h4>
<p>alexcrichton edited <a href="https://github.com/bytecodealliance/cranelift/issues/1408" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1408">Issue #1408</a>:</p>
<blockquote>
<p>Discussed at yesterday's meeting I wanted to open an issue tracking progress for merging the wasmtime/cranelift repositories. I think there are three major work items that need to happen:</p>
<h2>Performing the actual merge</h2>
<p>There's a few different ways to do the merge here, but I'd like to propose that the following steps are done. </p>
<ul>
<li>Run <code>git filter-branch --tree-filter $HOME/rewrite-cranelift.sh HEAD</code> in the cranelift repository on the commit we want to merge in. The script <a href="https://gist.github.com/alexcrichton/c85fa26854af2d58142b6675027961b3" target="_blank" title="https://gist.github.com/alexcrichton/c85fa26854af2d58142b6675027961b3">looks like this</a>.</li>
<li>Next create a merge commit with the wasmtime head commit and this new commit. The state at this point would look like <a href="https://github.com/alexcrichton/wasmtime/tree/cranelift-merge" target="_blank" title="https://github.com/alexcrichton/wasmtime/tree/cranelift-merge">https://github.com/alexcrichton/wasmtime/tree/cranelift-merge</a><ul>
<li>This needs the <code>--allow-unrelated-histories</code> flag</li>
</ul>
</li>
<li>Next do a bunch of manual work including:<ul>
<li>Merge CI systems</li>
<li>Tidy up readmes/top-level markdowns/licenses/etc</li>
<li>Tidy up workspaces so there's only one</li>
<li>Update various scripts for testing</li>
<li><a href="https://github.com/alexcrichton/wasmtime/commits/cranelift-merge-afterwards" target="_blank" title="https://github.com/alexcrichton/wasmtime/commits/cranelift-merge-afterwards">You can see a preview of this work</a> and what all got merged/moved</li>
</ul>
</li>
</ul>
<p>If folks have workflows though that go beyond <code>cargo test</code> and want to make sure any scripts and such keep working, let me know! I'll try to make sure they work in the new repository.</p>
<h2>Transferring open issues</h2>
<p>This will involve creating a script to migrate all open issues from the bytecodealliance/cranelift repository to bytecodealliance/wasmtime. </p>
<p>I think the general guidelines for this will be:</p>
<ul>
<li>Audit <a href="https://github.com/bytecodealliance/wasmtime/labels" target="_blank" title="https://github.com/bytecodealliance/wasmtime/labels">wasmtime labels</a> to ensure that they contain all relevant <a href="https://github.com/bytecodealliance/cranelift/labels" target="_blank" title="https://github.com/bytecodealliance/cranelift/labels">cranelift labels</a>. We should have a mapping from all cranelift labels to wasmtime labels.</li>
<li>Use GitHub's transfer issue feature to transfer all issues, using the above label mapping, to transfer issues to the wasmtime repository.</li>
</ul>
<p>script: <a href="https://gist.github.com/alexcrichton/ef102cb315e548c92fd671c198da9aa2" target="_blank" title="https://gist.github.com/alexcrichton/ef102cb315e548c92fd671c198da9aa2">https://gist.github.com/alexcrichton/ef102cb315e548c92fd671c198da9aa2</a></p>
<h2>Making it easier to migrate open PRs</h2>
<p>I've <a href="https://gist.github.com/alexcrichton/8cb3f4ef7c25317ba6824ee31e3e53aa" target="_blank" title="https://gist.github.com/alexcrichton/8cb3f4ef7c25317ba6824ee31e3e53aa">created a script</a> which should ideally make it easy to transfer PRs from one repository to another. The general gist of that script is something like this:</p>
<ul>
<li>We'll pick a commit to merge cranelift into wasmtime. We'll push two commits into this <code>cranelift</code> repository at that time: <code>before-merge</code> and <code>after-move</code>. The <code>before-merge</code> commit is the one we decided to merge into wasmtime. The <code>after-move</code> commit is a single extra commit with the rewrite script from the first step applied.</li>
<li>You'll check out your local branch and run the provided script here, that will do the following...</li>
<li>First it will fetch cranelift remote information</li>
<li>Next it will rebase on <code>before-merge</code>, to make sure your PR is up-to-date. You may want to do this manually first.</li>
<li>Next it rebase onto the <code>after-move</code> commit. Git should automatically detect all your renamed files, and everything should get moved around automatically.</li>
<li>Next it'll fetch wasmtime's information (currently my own temporary repository and temporary branch)</li>
<li>Finally it'll cherry-pick your changes, which are changes at the right paths, onto the wasmtime repository.</li>
</ul>
<p>At that point you should have a local git commit you can push up to your wasmtime fork and send as a PR. We'll need to, however, close PRs as they're reopened on wasmtime. </p>
<p>Once this all actually happens I can drop a comment on each PR with precise instructions with an updated script that has all the variables sorted out.</p>
</blockquote>



<a name="189129759"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231408%20Tracking%20issue%20for%20merging%20the%20cr.../near/189129759" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231408.20Tracking.20issue.20for.20merging.20the.20cr.2E.2E.2E.html#189129759">(Feb 26 2020 at 16:21)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/cranelift/issues/1408#issuecomment-591513263" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1408#issuecomment-591513263">commented</a> on <a href="https://github.com/bytecodealliance/cranelift/issues/1408" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1408">Issue #1408</a>:</p>
<blockquote>
<p>Ok I've now also created a script -- <a href="https://gist.github.com/alexcrichton/8cb3f4ef7c25317ba6824ee31e3e53aa" target="_blank" title="https://gist.github.com/alexcrichton/8cb3f4ef7c25317ba6824ee31e3e53aa">https://gist.github.com/alexcrichton/8cb3f4ef7c25317ba6824ee31e3e53aa</a> -- to rebase a PR on the <code>wasmtime</code> repository. The tl;dr; is that you use <code>git rebase</code> to move all the files for you, then you <code>cherry-pick</code> all the commits onto the wasmtime repo. </p>
<p>I've updated the description above, and that should make it so we're all set from a tooling perspective. I think now we just need a good time to pull the trigger!</p>
</blockquote>



<a name="189168079"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231408%20Tracking%20issue%20for%20merging%20the%20cr.../near/189168079" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231408.20Tracking.20issue.20for.20merging.20the.20cr.2E.2E.2E.html#189168079">(Feb 26 2020 at 22:37)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/cranelift/issues/1408#issuecomment-591680559" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1408#issuecomment-591680559">commented</a> on <a href="https://github.com/bytecodealliance/cranelift/issues/1408" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1408">Issue #1408</a>:</p>
<blockquote>
<p>I've created a <a href="#narrow/stream/217117-cranelift/topic/merge.20repo.20with.20wasmtime" title="#narrow/stream/217117-cranelift/topic/merge.20repo.20with.20wasmtime">zulip stream</a> if folks want to chat about this as well, and also as a less "email the world on everything" way to coordinate.</p>
</blockquote>



<a name="189326135"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231408%20Tracking%20issue%20for%20merging%20the%20cr.../near/189326135" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231408.20Tracking.20issue.20for.20merging.20the.20cr.2E.2E.2E.html#189326135">(Feb 28 2020 at 16:36)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/cranelift/issues/1408#issuecomment-592593379" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1408#issuecomment-592593379">commented</a> on <a href="https://github.com/bytecodealliance/cranelift/issues/1408" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1408">Issue #1408</a>:</p>
<blockquote>
<p>Ok unless there's any objects that come up, I plan on tackling this in the afternoon today and performing the actual merge. If you've got any concerns it's best to <a href="#narrow/stream/217117-cranelift/topic/merge.20repo.20with.20wasmtime" title="#narrow/stream/217117-cranelift/topic/merge.20repo.20with.20wasmtime">bring them up in zulip</a> and @-mention me. </p>
<p>One final question being considered is the final crate organization. The example above has <code>crates/cranelift/$crate</code>, but it sounds like we're now leaning towards <code>cranelift/$crate</code> or <code>cranelift/crates/$crate</code></p>
</blockquote>



<a name="189361789"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231408%20Tracking%20issue%20for%20merging%20the%20cr.../near/189361789" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231408.20Tracking.20issue.20for.20merging.20the.20cr.2E.2E.2E.html#189361789">(Feb 28 2020 at 23:29)</a>:</h4>
<p>alexcrichton transferred <a href="https://github.com/bytecodealliance/cranelift/issues/1408" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1408">Issue #1408</a>:</p>
<blockquote>
<p>Discussed at yesterday's meeting I wanted to open an issue tracking progress for merging the wasmtime/cranelift repositories. I think there are three major work items that need to happen:</p>
<h2>Performing the actual merge</h2>
<p>There's a few different ways to do the merge here, but I'd like to propose that the following steps are done. </p>
<ul>
<li>Run <code>git filter-branch --tree-filter $HOME/rewrite-cranelift.sh HEAD</code> in the cranelift repository on the commit we want to merge in. The script <a href="https://gist.github.com/alexcrichton/c85fa26854af2d58142b6675027961b3" target="_blank" title="https://gist.github.com/alexcrichton/c85fa26854af2d58142b6675027961b3">looks like this</a>.</li>
<li>Next create a merge commit with the wasmtime head commit and this new commit. The state at this point would look like <a href="https://github.com/alexcrichton/wasmtime/tree/cranelift-merge" target="_blank" title="https://github.com/alexcrichton/wasmtime/tree/cranelift-merge">https://github.com/alexcrichton/wasmtime/tree/cranelift-merge</a><ul>
<li>This needs the <code>--allow-unrelated-histories</code> flag</li>
</ul>
</li>
<li>Next do a bunch of manual work including:<ul>
<li>Merge CI systems</li>
<li>Tidy up readmes/top-level markdowns/licenses/etc</li>
<li>Tidy up workspaces so there's only one</li>
<li>Update various scripts for testing</li>
<li><a href="https://github.com/alexcrichton/wasmtime/commits/cranelift-merge-afterwards" target="_blank" title="https://github.com/alexcrichton/wasmtime/commits/cranelift-merge-afterwards">You can see a preview of this work</a> and what all got merged/moved</li>
</ul>
</li>
</ul>
<p>If folks have workflows though that go beyond <code>cargo test</code> and want to make sure any scripts and such keep working, let me know! I'll try to make sure they work in the new repository.</p>
<h2>Transferring open issues</h2>
<p>This will involve creating a script to migrate all open issues from the bytecodealliance/cranelift repository to bytecodealliance/wasmtime. </p>
<p>I think the general guidelines for this will be:</p>
<ul>
<li>Audit <a href="https://github.com/bytecodealliance/wasmtime/labels" target="_blank" title="https://github.com/bytecodealliance/wasmtime/labels">wasmtime labels</a> to ensure that they contain all relevant <a href="https://github.com/bytecodealliance/cranelift/labels" target="_blank" title="https://github.com/bytecodealliance/cranelift/labels">cranelift labels</a>. We should have a mapping from all cranelift labels to wasmtime labels.</li>
<li>Use GitHub's transfer issue feature to transfer all issues, using the above label mapping, to transfer issues to the wasmtime repository.</li>
</ul>
<p>script: <a href="https://gist.github.com/alexcrichton/ef102cb315e548c92fd671c198da9aa2" target="_blank" title="https://gist.github.com/alexcrichton/ef102cb315e548c92fd671c198da9aa2">https://gist.github.com/alexcrichton/ef102cb315e548c92fd671c198da9aa2</a></p>
<h2>Making it easier to migrate open PRs</h2>
<p>I've <a href="https://gist.github.com/alexcrichton/8cb3f4ef7c25317ba6824ee31e3e53aa" target="_blank" title="https://gist.github.com/alexcrichton/8cb3f4ef7c25317ba6824ee31e3e53aa">created a script</a> which should ideally make it easy to transfer PRs from one repository to another. The general gist of that script is something like this:</p>
<ul>
<li>We'll pick a commit to merge cranelift into wasmtime. We'll push two commits into this <code>cranelift</code> repository at that time: <code>before-merge</code> and <code>after-move</code>. The <code>before-merge</code> commit is the one we decided to merge into wasmtime. The <code>after-move</code> commit is a single extra commit with the rewrite script from the first step applied.</li>
<li>You'll check out your local branch and run the provided script here, that will do the following...</li>
<li>First it will fetch cranelift remote information</li>
<li>Next it will rebase on <code>before-merge</code>, to make sure your PR is up-to-date. You may want to do this manually first.</li>
<li>Next it rebase onto the <code>after-move</code> commit. Git should automatically detect all your renamed files, and everything should get moved around automatically.</li>
<li>Next it'll fetch wasmtime's information (currently my own temporary repository and temporary branch)</li>
<li>Finally it'll cherry-pick your changes, which are changes at the right paths, onto the wasmtime repository.</li>
</ul>
<p>At that point you should have a local git commit you can push up to your wasmtime fork and send as a PR. We'll need to, however, close PRs as they're reopened on wasmtime. </p>
<p>Once this all actually happens I can drop a comment on each PR with precise instructions with an updated script that has all the variables sorted out.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>