<html>
<head><meta charset="utf-8"><title>cranelift / Issue #1083 Optimized transitions for cranelift · git-cranelift · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/index.html">git-cranelift</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231083.20Optimized.20transitions.20for.20cranelift.html">cranelift / Issue #1083 Optimized transitions for cranelift</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="188991373"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231083%20Optimized%20transitions%20for%20cranelift/near/188991373" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231083.20Optimized.20transitions.20for.20cranelift.html#188991373">(Feb 25 2020 at 04:48)</a>:</h4>
<p>shravanrn edited <a href="https://github.com/bytecodealliance/cranelift/issues/1083" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1083">Issue #1083</a>:</p>
<blockquote>
<p>This bug is in the context of use of Cranelift to generate wasm sandboxed libraries for use in Firefox - i.e. this is a non web embedding. Full details available here <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1562797" target="_blank" title="https://bugzilla.mozilla.org/show_bug.cgi?id=1562797">https://bugzilla.mozilla.org/show_bug.cgi?id=1562797</a></p>
<p>We are using lucet as our wasm compiler which uses Cranelift under the covers. For performance reasons, we need to optimize transitions between native code and wasm sandboxed code beyond what lucet provides out of the box. Key to this is generating efficient trampoline functions that minimize overhead.</p>
<p>To this end we have rewritten trampolines that make a few assumptions based on " properties derivable from the WASM spec about register and stack use of a WASM compiler". These assumptions reduces overhead when using a sandboxed version of libGraphite by several 100's of percent. </p>
<p>Since this is something indirectly implied from the WASM spec, I am hoping that Cranelift can guarantee these and wanted to confirm if these are OK.</p>
<p>There are 3 assumptions - one about stacks, and two about register use</p>
<p>1) Assembly functions generated by Cranelift WASM never underflows the stack<br>
    - This is guaranteed from the WASM spec due to the fact that WASM functions are proper stack machines<br>
    - This would allow us to use the same stack for the application and wasm module<br>
    - However, our reliance on this depends on how bug-free we think Cranelift's conversion from the WASM stack machine<br>
2) Assembly functions generated by Cranelift never reads an uninitialized register<br>
    - This is an outcome of all function calls to WASM and within WASM (including indirect jumps) being typesafe.<br>
    - This means there should never be code generated that reads from a scratch register prior to writing to it.<br>
    - This also means there should never be code generate for a function that takes 2 parameters, that attempts to read a value from the register that would hold a third parameter (if it had existed)<br>
    - This allows us to avoid clearing scratch and unused parameter registers during WASM function invocation.<br>
3) Assembly functions generated by Cranelift always restore callee save registers<br>
    - Like point 2, this is an outcome of all functions being typesafe combined with the fact that WASM is a stack machine, which cannot manipulate the stack in a way that affects register spills. <br>
    - This means that there should no path through the function that would result in a callee save register not being restored<br>
    - This allows us to avoid explicitly restoring registers on the way out</p>
</blockquote>



<a name="188995278"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231083%20Optimized%20transitions%20for%20cranelift/near/188995278" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231083.20Optimized.20transitions.20for.20cranelift.html#188995278">(Feb 25 2020 at 06:42)</a>:</h4>
<p>shravanrn <a href="https://github.com/bytecodealliance/cranelift/issues/1083#issuecomment-590709658" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1083#issuecomment-590709658">commented</a> on <a href="https://github.com/bytecodealliance/cranelift/issues/1083" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1083">Issue #1083</a>:</p>
<blockquote>
<p>(Updating title as we want to point people to this bug until we can update docs)</p>
</blockquote>



<a name="189361591"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231083%20Optimized%20transitions%20for%20cranelift/near/189361591" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231083.20Optimized.20transitions.20for.20cranelift.html#189361591">(Feb 28 2020 at 23:26)</a>:</h4>
<p>alexcrichton transferred <a href="https://github.com/bytecodealliance/cranelift/issues/1083" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1083">Issue #1083</a>:</p>
<blockquote>
<p>This bug is in the context of use of Cranelift to generate wasm sandboxed libraries for use in Firefox - i.e. this is a non web embedding. Full details available here <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1562797" target="_blank" title="https://bugzilla.mozilla.org/show_bug.cgi?id=1562797">https://bugzilla.mozilla.org/show_bug.cgi?id=1562797</a></p>
<p>We are using lucet as our wasm compiler which uses Cranelift under the covers. For performance reasons, we need to optimize transitions between native code and wasm sandboxed code beyond what lucet provides out of the box. Key to this is generating efficient trampoline functions that minimize overhead.</p>
<p>To this end we have rewritten trampolines that make a few assumptions based on " properties derivable from the WASM spec about register and stack use of a WASM compiler". These assumptions reduces overhead when using a sandboxed version of libGraphite by several 100's of percent. </p>
<p>Since this is something indirectly implied from the WASM spec, I am hoping that Cranelift can guarantee these and wanted to confirm if these are OK.</p>
<p>There are 3 assumptions - one about stacks, and two about register use</p>
<p>1) Assembly functions generated by Cranelift WASM never underflows the stack<br>
    - This is guaranteed from the WASM spec due to the fact that WASM functions are proper stack machines<br>
    - This would allow us to use the same stack for the application and wasm module<br>
    - However, our reliance on this depends on how bug-free we think Cranelift's conversion from the WASM stack machine<br>
2) Assembly functions generated by Cranelift never reads an uninitialized register<br>
    - This is an outcome of all function calls to WASM and within WASM (including indirect jumps) being typesafe.<br>
    - This means there should never be code generated that reads from a scratch register prior to writing to it.<br>
    - This also means there should never be code generate for a function that takes 2 parameters, that attempts to read a value from the register that would hold a third parameter (if it had existed)<br>
    - This allows us to avoid clearing scratch and unused parameter registers during WASM function invocation.<br>
3) Assembly functions generated by Cranelift always restore callee save registers<br>
    - Like point 2, this is an outcome of all functions being typesafe combined with the fact that WASM is a stack machine, which cannot manipulate the stack in a way that affects register spills. <br>
    - This means that there should no path through the function that would result in a callee save register not being restored<br>
    - This allows us to avoid explicitly restoring registers on the way out</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>