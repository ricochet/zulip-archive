<html>
<head><meta charset="utf-8"><title>cranelift / PR #1346 Add 8x16 shift legalizations for x86... · git-cranelift · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/index.html">git-cranelift</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231346.20Add.208x16.20shift.20legalizations.20for.20x86.2E.2E.2E.html">cranelift / PR #1346 Add 8x16 shift legalizations for x86...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="185642899"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231346%20Add%208x16%20shift%20legalizations%20for%20x86.../near/185642899" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231346.20Add.208x16.20shift.20legalizations.20for.20x86.2E.2E.2E.html#185642899">(Jan 14 2020 at 21:35)</a>:</h4>
<p>abrown opened <a href="https://github.com/bytecodealliance/cranelift/pull/1346" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1346">PR #1346</a> from <code>add-shift-8x16</code> to <code>master</code>:</p>
<blockquote>
<ul>
<li>[x] This has not been discussed in an issue.</li>
<li>[x] A short description of what this does, why it is needed: I did not implement the <code>i8x16</code> shifts previously because there was discussion about whether they should be included in the spec (<a href="https://github.com/WebAssembly/simd/issues/117" target="_blank" title="https://github.com/WebAssembly/simd/issues/117">https://github.com/WebAssembly/simd/issues/117</a>). I still feel they should not be included due to the large overhead they impose on x86 but I am (rather unwillingly) implementing them here so we can get additional performance measurements.</li>
<li>[ ] This PR contains test cases, if meaningful.</li>
<li>[x] A reviewer from the core maintainer team has been assigned for this PR.</li>
</ul>
</blockquote>



<a name="185643353"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231346%20Add%208x16%20shift%20legalizations%20for%20x86.../near/185643353" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231346.20Add.208x16.20shift.20legalizations.20for.20x86.2E.2E.2E.html#185643353">(Jan 14 2020 at 21:40)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1346#pullrequestreview-342857116" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1346#pullrequestreview-342857116">PR Review</a>.</p>



<a name="185643354"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231346%20Add%208x16%20shift%20legalizations%20for%20x86.../near/185643354" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231346.20Add.208x16.20shift.20legalizations.20for.20x86.2E.2E.2E.html#185643354">(Jan 14 2020 at 21:40)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/cranelift/pull/1346#discussion_r366586863" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1346#discussion_r366586863">PR Review Comment</a>:</p>
<blockquote>
<p>@sunfishcode, @bnjbvr: I don't know how to get a pointer to the table of constants but I need something like that in order to load the mask. Is there a different way to do this? I looked at <code>binemit.rs::const_disp4</code> and it is not clear to me if/how at this point (when I'm doing legalizations) I can get an offset to the constant table.</p>
</blockquote>



<a name="185643434"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231346%20Add%208x16%20shift%20legalizations%20for%20x86.../near/185643434" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231346.20Add.208x16.20shift.20legalizations.20for.20x86.2E.2E.2E.html#185643434">(Jan 14 2020 at 21:41)</a>:</h4>
<p>abrown edited <a href="https://github.com/bytecodealliance/cranelift/pull/1346#discussion_r366586863" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1346#discussion_r366586863">PR Review Comment</a>.</p>



<a name="185967774"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231346%20Add%208x16%20shift%20legalizations%20for%20x86.../near/185967774" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231346.20Add.208x16.20shift.20legalizations.20for.20x86.2E.2E.2E.html#185967774">(Jan 17 2020 at 23:30)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1346#pullrequestreview-344893664" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1346#pullrequestreview-344893664">PR Review</a>.</p>



<a name="185967777"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231346%20Add%208x16%20shift%20legalizations%20for%20x86.../near/185967777" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231346.20Add.208x16.20shift.20legalizations.20for.20x86.2E.2E.2E.html#185967777">(Jan 17 2020 at 23:30)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/cranelift/pull/1346#discussion_r368177360" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1346#discussion_r368177360">PR Review Comment</a>:</p>
<blockquote>
<p>@sunfishcode, here's my current thinking on this:</p>
<ul>
<li>I considered whether having some sort of symbol (unrelated to globals) in the CL IR like <code>$func.rodata</code> would make this work; if that symbol could have a known address at compile time then I could use that and constant offsets to get at runtime-determined constants.</li>
<li>But can the address of that symbol be known at compile time? I think it can if it is function-related (not global) and relative to the PC: 1) once we know how long the function will be, <a href="https://github.com/bytecodealliance/cranelift/blob/cabbacbe63477fcc7d1f1e36717d84f08f749a98/cranelift-codegen/src/binemit/relaxation.rs#L130-L143" target="_blank" title="https://github.com/bytecodealliance/cranelift/blob/cabbacbe63477fcc7d1f1e36717d84f08f749a98/cranelift-codegen/src/binemit/relaxation.rs#L130-L143">calculate all of the offsets of jump tables, constants, and (now) symbols</a>, and 2) use functions like <code>jt_disp4</code>, <code>const_disp4</code>, and (now) <code>symbol_disp4</code> in <code>binemit.rs</code> to pull out those calculated offsets when we emit the code.</li>
<li>Looking at this from distance, we would be doing the same type of thing three times and the code is fragile due to the distance between when the offsets are assigned (<code>relax_branches</code>), referenced in code (<code>binemit.rs</code>), and actually populated with data (<code>emit_function</code>). Perhaps we add an abstraction to <code>Function</code> like <code>RelativeOffsets</code> that would map any of these things (jump table, constant, symbol) to their offset; it would only be usable after some new counting pass (removing that logic from <code>relax_branches</code>), would be queryable when encoding instructions and would know how to lay out the actual data in <code>emit_function</code></li>
</ul>
</blockquote>



<a name="192095637"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231346%20Add%208x16%20shift%20legalizations%20for%20x86.../near/192095637" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231346.20Add.208x16.20shift.20legalizations.20for.20x86.2E.2E.2E.html#192095637">(Mar 28 2020 at 00:24)</a>:</h4>
<p>abrown closed without merge <a href="https://github.com/bytecodealliance/cranelift/pull/1346" title="https://github.com/bytecodealliance/cranelift/pull/1346">PR #1346</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>