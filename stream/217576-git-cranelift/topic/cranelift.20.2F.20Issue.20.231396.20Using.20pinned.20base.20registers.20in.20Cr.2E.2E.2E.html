<html>
<head><meta charset="utf-8"><title>cranelift / Issue #1396 Using pinned base registers in Cr... · git-cranelift · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/index.html">git-cranelift</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231396.20Using.20pinned.20base.20registers.20in.20Cr.2E.2E.2E.html">cranelift / Issue #1396 Using pinned base registers in Cr...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="188507058"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231396%20Using%20pinned%20base%20registers%20in%20Cr.../near/188507058" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231396.20Using.20pinned.20base.20registers.20in.20Cr.2E.2E.2E.html#188507058">(Feb 19 2020 at 00:54)</a>:</h4>
<p>shravanrn opened <a href="https://github.com/bytecodealliance/cranelift/issues/1396" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1396">Issue #1396</a>:</p>
<blockquote>
<p>&lt;!-- Please try to describe precisely what you would like to do in Cranelift and/or<br>
expect from it. You can answer the questions below if they're relevant and<br>
delete this text before submitting. Thanks for opening an issue! --&gt;</p>
<h4>Feature</h4>
<p>I am a PhD student at UCSD investigating a variety of cranelift performance improvements and cranelift Spectre related hardening. So far, these appear very promising and I am hoping to contribute this back to cranelift in the future.</p>
<p>However a key requirement for this work is being able to pin the heap base register in the cranelift compiler. I believe there was support for this earlier, but the feature has since been removed. I am looking for a way to re-enable or re-implement this. I am using cranelift via the Lucet AOT wasm compiler.</p>
<h4>Benefit</h4>
<p>This will allow for analysis and prototyping of various performance improvements and Spectre related hardening for the cranelift compiler.</p>
<h4>Implementation</h4>
<p>I believe there was support for this earlier, but this was removed. I am looking for a way to re-enable or re-implement this. A quick and dirty hack for this is fine too, as this is for prototyping, and is not meant for production.</p>
<h4>Alternatives</h4>
<p>Unfortunately, all of the approaches I am investigating have a concrete reliance on this.</p>
<p>@sunfishcode, @pchickey  - We had spoken at the WASM CG about some of this. Would you have thoughts on how best I can proceed here?</p>
</blockquote>



<a name="188507148"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231396%20Using%20pinned%20base%20registers%20in%20Cr.../near/188507148" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231396.20Using.20pinned.20base.20registers.20in.20Cr.2E.2E.2E.html#188507148">(Feb 19 2020 at 00:56)</a>:</h4>
<p>shravanrn edited <a href="https://github.com/bytecodealliance/cranelift/issues/1396" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1396">Issue #1396</a>:</p>
<blockquote>
<p>&lt;!-- Please try to describe precisely what you would like to do in Cranelift and/or<br>
expect from it. You can answer the questions below if they're relevant and<br>
delete this text before submitting. Thanks for opening an issue! --&gt;</p>
<h4>Feature</h4>
<p>I am a PhD student at UCSD investigating a variety of cranelift performance improvements and cranelift Spectre related hardening. So far, these appear very promising and I am hoping to contribute this back to cranelift in the future.</p>
<p>However a key requirement for this work is being able to pin the heap base register in the cranelift compiler. I believe there was support for this earlier, but the feature has since been removed. I am looking for a way to re-enable or re-implement this. I am using cranelift via the Lucet AOT wasm compiler.</p>
<h4>Benefit</h4>
<p>This will allow for analysis and prototyping of various performance improvements and Spectre related hardening for the cranelift compiler.</p>
<h4>Implementation</h4>
<p>I believe there was support for this earlier, but this was removed. I am looking for a way to re-enable or re-implement this. A quick and dirty hack for this is fine too, as this is for prototyping, and is not meant for production.</p>
<h4>Alternatives</h4>
<p>Unfortunately, all of the approaches I am investigating explicitly rely on pinned base registers.</p>
<p>@sunfishcode, @pchickey  - We had spoken at the WASM CG about some of this. Would you have thoughts on how best I can proceed here?</p>
</blockquote>



<a name="188507388"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231396%20Using%20pinned%20base%20registers%20in%20Cr.../near/188507388" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231396.20Using.20pinned.20base.20registers.20in.20Cr.2E.2E.2E.html#188507388">(Feb 19 2020 at 01:01)</a>:</h4>
<p>iximeow <a href="https://github.com/bytecodealliance/cranelift/issues/1396#issuecomment-587981627" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1396#issuecomment-587981627">commented</a> on <a href="https://github.com/bytecodealliance/cranelift/issues/1396" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1396">Issue #1396</a>:</p>
<blockquote>
<p>So far as I know, Cranelift still supports using a pinned register for the heap base - I just started fixing up a branch in Lucet to expose it as a compilation flag: <a href="https://github.com/bytecodealliance/lucet/pull/273" target="_blank" title="https://github.com/bytecodealliance/lucet/pull/273">https://github.com/bytecodealliance/lucet/pull/273</a></p>
<p>What has you thinking support for this has been removed? If it's missing documentation or something along those lines, we probably ought to fix it :D</p>
</blockquote>



<a name="188508142"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231396%20Using%20pinned%20base%20registers%20in%20Cr.../near/188508142" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231396.20Using.20pinned.20base.20registers.20in.20Cr.2E.2E.2E.html#188508142">(Feb 19 2020 at 01:17)</a>:</h4>
<p>iximeow edited a <a href="https://github.com/bytecodealliance/cranelift/issues/1396#issuecomment-587981627" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1396#issuecomment-587981627">comment</a> on <a href="https://github.com/bytecodealliance/cranelift/issues/1396" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1396">Issue #1396</a>:</p>
<blockquote>
<p>So far as I know, Cranelift still supports using a pinned register for the heap base - I just started fixing up a branch in Lucet to expose it as a compilation flag: <a href="https://github.com/bytecodealliance/lucet/pull/273" target="_blank" title="https://github.com/bytecodealliance/lucet/pull/273">https://github.com/bytecodealliance/lucet/pull/273</a></p>
<p>What has you thinking support for this has been removed? If it's missing documentation or something along those lines, we probably ought to fix it :D</p>
<p>edit: @pchickey filled me in - it sounds like the current plan is that the new register allocator/backend doesn't have plans to support this from the start? If that's the case consider this a +1 for still wanting this feature, and quietly <span aria-label="eyes" class="emoji emoji-1f440" role="img" title="eyes">:eyes:</span> at the conversation here.</p>
</blockquote>



<a name="188510037"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231396%20Using%20pinned%20base%20registers%20in%20Cr.../near/188510037" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231396.20Using.20pinned.20base.20registers.20in.20Cr.2E.2E.2E.html#188510037">(Feb 19 2020 at 02:03)</a>:</h4>
<p>shravanrn <a href="https://github.com/bytecodealliance/cranelift/issues/1396#issuecomment-587996966" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1396#issuecomment-587996966">commented</a> on <a href="https://github.com/bytecodealliance/cranelift/issues/1396" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1396">Issue #1396</a>:</p>
<blockquote>
<p>@iximeow - thanks for the clarification! Yup, this is indeed a question about both the new and older register allocator. Re the old allocator - I will follow up in the linked lucet PR. Re the new allocator - Yup, I was hoping to start a conversation about supporting this :)</p>
</blockquote>



<a name="188516528"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231396%20Using%20pinned%20base%20registers%20in%20Cr.../near/188516528" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231396.20Using.20pinned.20base.20registers.20in.20Cr.2E.2E.2E.html#188516528">(Feb 19 2020 at 05:12)</a>:</h4>
<p>lars-t-hansen <a href="https://github.com/bytecodealliance/cranelift/issues/1396#issuecomment-588039474" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1396#issuecomment-588039474">commented</a> on <a href="https://github.com/bytecodealliance/cranelift/issues/1396" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1396">Issue #1396</a>:</p>
<blockquote>
<p>I don't think that we've concluded on this issue - for Firefox, it's really a wasm ABI issue more than a cranelift issue per se.  It's believed (based on some preliminary benchmarking) that a pinned heap register is a performance win for many programs, and even when the multi-memory proposal lands I'd be inclined to keep a pinned register for at least one of the memories until we know we're not regressing performance.  It's not known how much of win the pinned register is, once we get serious about optimizations that target this particular problem rather than rely on general optimizations &amp; register allocation solutions.</p>
</blockquote>



<a name="188590126"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231396%20Using%20pinned%20base%20registers%20in%20Cr.../near/188590126" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231396.20Using.20pinned.20base.20registers.20in.20Cr.2E.2E.2E.html#188590126">(Feb 19 2020 at 21:58)</a>:</h4>
<p>shravanrn <a href="https://github.com/bytecodealliance/cranelift/issues/1396#issuecomment-588492784" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1396#issuecomment-588492784">commented</a> on <a href="https://github.com/bytecodealliance/cranelift/issues/1396" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1396">Issue #1396</a>:</p>
<blockquote>
<blockquote>
<p>I don't think that we've concluded on this issue...  It's not known how much of win the pinned register is...</p>
</blockquote>
<p>Ah, gotcha. Thanks for the explanation! Given this, feel free to close this bug as it sounds like discussions on this subject are ongoing. </p>
<p>Just as a summary, the key points I wanted to make from my side was that </p>
<ol>
<li>Cranelift continues to keep the "pinned &amp; non-spilling" base register support in the current reg allocator</li>
<li>Make the case that Cranelift should continue to support "pinned &amp; non-spilling" base register in the new allocator as well. Our work on security and performance improvements relying on this, while ongoing, have some early results that are promising.</li>
</ol>
<p>I will try to follow the existing discussions around this feature. Thanks a bunch!</p>
</blockquote>



<a name="188729555"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231396%20Using%20pinned%20base%20registers%20in%20Cr.../near/188729555" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231396.20Using.20pinned.20base.20registers.20in.20Cr.2E.2E.2E.html#188729555">(Feb 21 2020 at 13:15)</a>:</h4>
<p>bnjbvr <a href="https://github.com/bytecodealliance/cranelift/issues/1396#issuecomment-589648401" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1396#issuecomment-589648401">commented</a> on <a href="https://github.com/bytecodealliance/cranelift/issues/1396" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1396">Issue #1396</a>:</p>
<blockquote>
<p>For what it's worth, the current system allows to pin the heap register via the <code>enable_pinned_reg</code> and <code>use_pinned_reg_as_heap_base</code> settings. Both are false by default. On x86_64, we pin it to r15.</p>
<p>This is definitely something we need to maintain as part of the new regalloc work, as long as Spidermonkey does it, so as to be competitive with Spidermonkey.</p>
</blockquote>



<a name="188896375"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231396%20Using%20pinned%20base%20registers%20in%20Cr.../near/188896375" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231396.20Using.20pinned.20base.20registers.20in.20Cr.2E.2E.2E.html#188896375">(Feb 24 2020 at 03:22)</a>:</h4>
<p>shravanrn <a href="https://github.com/bytecodealliance/cranelift/issues/1396#issuecomment-590155346" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1396#issuecomment-590155346">commented</a> on <a href="https://github.com/bytecodealliance/cranelift/issues/1396" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1396">Issue #1396</a>:</p>
<blockquote>
<p>Sounds good. Thanks for the info!</p>
</blockquote>



<a name="188896376"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231396%20Using%20pinned%20base%20registers%20in%20Cr.../near/188896376" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231396.20Using.20pinned.20base.20registers.20in.20Cr.2E.2E.2E.html#188896376">(Feb 24 2020 at 03:22)</a>:</h4>
<p>shravanrn closed <a href="https://github.com/bytecodealliance/cranelift/issues/1396" target="_blank" title="https://github.com/bytecodealliance/cranelift/issues/1396">Issue #1396</a>:</p>
<blockquote>
<p>&lt;!-- Please try to describe precisely what you would like to do in Cranelift and/or<br>
expect from it. You can answer the questions below if they're relevant and<br>
delete this text before submitting. Thanks for opening an issue! --&gt;</p>
<h4>Feature</h4>
<p>I am a PhD student at UCSD investigating a variety of cranelift performance improvements and cranelift Spectre related hardening. So far, these appear very promising and I am hoping to contribute this back to cranelift in the future.</p>
<p>However a key requirement for this work is being able to pin the heap base register in the cranelift compiler. I believe there was support for this earlier, but the feature has since been removed. I am looking for a way to re-enable or re-implement this. I am using cranelift via the Lucet AOT wasm compiler.</p>
<h4>Benefit</h4>
<p>This will allow for analysis and prototyping of various performance improvements and Spectre related hardening for the cranelift compiler.</p>
<h4>Implementation</h4>
<p>I believe there was support for this earlier, but this was removed. I am looking for a way to re-enable or re-implement this. A quick and dirty hack for this is fine too, as this is for prototyping, and is not meant for production.</p>
<h4>Alternatives</h4>
<p>Unfortunately, all of the approaches I am investigating explicitly rely on pinned base registers.</p>
<p>@sunfishcode, @pchickey  - We had spoken at the WASM CG about some of this. Would you have thoughts on how best I can proceed here?</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>