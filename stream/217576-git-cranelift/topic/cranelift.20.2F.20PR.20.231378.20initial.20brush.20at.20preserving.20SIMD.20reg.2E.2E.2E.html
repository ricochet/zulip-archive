<html>
<head><meta charset="utf-8"><title>cranelift / PR #1378 initial brush at preserving SIMD reg... · git-cranelift · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/index.html">git-cranelift</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html">cranelift / PR #1378 initial brush at preserving SIMD reg...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="187522738"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187522738" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187522738">(Feb 06 2020 at 06:10)</a>:</h4>
<p>iximeow opened <a href="https://github.com/bytecodealliance/cranelift/pull/1378" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378">PR #1378</a> from <code>windows-fprs-preservation</code> to <code>master</code>:</p>
<blockquote>
<ul>
<li>[ ] This has been discussed in issue #1366 </li>
<li>[ ] A short description: Windows appears to have extended ABI constraints to require callees to save XMM6-XMM15 (see #1366 for links to reference material). This PR adds preserve/restore behavior for those registers.</li>
<li>[ ] This PR contains test cases. Ish. There is an additional test that would test the right behavior if this was totally ready to go.</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so and/or ping<br>
<code>bnjbvr</code>. The list of suggested reviewers on the right can help you.</li>
</ul>
<p>This is a draft PR as there are two points where I think I should just ask for help rather than spin my wheels figuring out the Right Thing, I'll add comments below.</p>
<p>@sstangl if you get a chance, I think you might know the right things for the questions to follow!</p>
</blockquote>



<a name="187522740"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187522740" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187522740">(Feb 06 2020 at 06:10)</a>:</h4>
<p>iximeow edited <a href="https://github.com/bytecodealliance/cranelift/pull/1378" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378">PR #1378</a> from <code>windows-fprs-preservation</code> to <code>master</code>:</p>
<blockquote>
<ul>
<li>[ ] This has been discussed in issue #1366 </li>
<li>[x] A short description: Windows appears to have extended ABI constraints to require callees to save XMM6-XMM15 (see #1366 for links to reference material). This PR adds preserve/restore behavior for those registers.</li>
<li>[ ] This PR contains test cases. Ish. There is an additional test that would test the right behavior if this was totally ready to go.</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so and/or ping<br>
<code>bnjbvr</code>. The list of suggested reviewers on the right can help you.</li>
</ul>
<p>This is a draft PR as there are two points where I think I should just ask for help rather than spin my wheels figuring out the Right Thing, I'll add comments below.</p>
<p>@sstangl if you get a chance, I think you might know the right things for the questions to follow!</p>
</blockquote>



<a name="187522741"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187522741" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187522741">(Feb 06 2020 at 06:10)</a>:</h4>
<p>iximeow edited <a href="https://github.com/bytecodealliance/cranelift/pull/1378" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378">PR #1378</a> from <code>windows-fprs-preservation</code> to <code>master</code>:</p>
<blockquote>
<ul>
<li>[ ] This has been discussed in issue #1366 </li>
<li>[x] A short description: Windows appears to have extended ABI constraints to require callees to save XMM6-XMM15 (see #1366 for links to reference material). This PR adds preserve/restore behavior for those registers.</li>
<li>[x] This PR contains test cases. Ish. There is an additional test that would test the right behavior if this was totally ready to go.</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so and/or ping<br>
<code>bnjbvr</code>. The list of suggested reviewers on the right can help you.</li>
</ul>
<p>This is a draft PR as there are two points where I think I should just ask for help rather than spin my wheels figuring out the Right Thing, I'll add comments below.</p>
<p>@sstangl if you get a chance, I think you might know the right things for the questions to follow!</p>
</blockquote>



<a name="187522744"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187522744" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187522744">(Feb 06 2020 at 06:10)</a>:</h4>
<p>iximeow edited <a href="https://github.com/bytecodealliance/cranelift/pull/1378" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378">PR #1378</a> from <code>windows-fprs-preservation</code> to <code>master</code>:</p>
<blockquote>
<ul>
<li>[x] This has been discussed in issue #1366 </li>
<li>[x] A short description: Windows appears to have extended ABI constraints to require callees to save XMM6-XMM15 (see #1366 for links to reference material). This PR adds preserve/restore behavior for those registers.</li>
<li>[x] This PR contains test cases. Ish. There is an additional test that would test the right behavior if this was totally ready to go.</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so and/or ping<br>
<code>bnjbvr</code>. The list of suggested reviewers on the right can help you.</li>
</ul>
<p>This is a draft PR as there are two points where I think I should just ask for help rather than spin my wheels figuring out the Right Thing, I'll add comments below.</p>
<p>@sstangl if you get a chance, I think you might know the right things for the questions to follow!</p>
</blockquote>



<a name="187522755"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187522755" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187522755">(Feb 06 2020 at 06:11)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r375655738" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r375655738">PR Review Comment</a>:</p>
<blockquote>
<p>assuming this was a typo, <code>RSB</code> doesn't make sense to me as an x86-ism and the other automatically-restored register would be <code>RBP</code>.</p>
</blockquote>



<a name="187522756"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187522756" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187522756">(Feb 06 2020 at 06:11)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354218893" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354218893">PR Review</a>.</p>



<a name="187522827"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187522827" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187522827">(Feb 06 2020 at 06:13)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354219425" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354219425">PR Review</a>.</p>



<a name="187522828"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187522828" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187522828">(Feb 06 2020 at 06:13)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r375656163" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r375656163">PR Review Comment</a>:</p>
<blockquote>
<p>not checking that <code>GPR</code> (and <code>FPR</code>) contain the regunit in question could introduce errors if these RegClasses had differing widths. So far as I can see, x86 <code>RegClass</code> all have the same width of 1, so this happens to work out okay, but I think is strictly speaking a bug independent of SIMD register preservation.</p>
</blockquote>



<a name="187522899"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187522899" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187522899">(Feb 06 2020 at 06:14)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354219840" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354219840">PR Review</a>.</p>



<a name="187522900"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187522900" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187522900">(Feb 06 2020 at 06:14)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r375656490" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r375656490">PR Review Comment</a>:</p>
<blockquote>
<p><code>csrs.iter(FPR).len()</code> will be zero via the above assert, but I want the stack size to be the same expression in the three places we compute it here in <code>abi.rs</code>.</p>
</blockquote>



<a name="187523023"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187523023" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187523023">(Feb 06 2020 at 06:18)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354220769" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354220769">PR Review</a>.</p>



<a name="187523024"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187523024" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187523024">(Feb 06 2020 at 06:18)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r375657183" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r375657183">PR Review Comment</a>:</p>
<blockquote>
<p>this is where I'd like input from someone who knows codegen APIs better than me (@sstangl?): SIMD registers can't be <code>x86_push</code>'d nor <code>x86_pop</code>'d (there is no push/pop encoding in the ISA for them, even), so my plan is to know there will be sufficient space reserved for them and simply <code>load</code>/<code>store</code> them. To do that, I would need to use <code>rsp</code> or <code>rbp</code> as a base, with an appropriate offset. Is there a nice way to get <code>function call frame base</code> as a value?</p>
<p>I don't want to load <code>rbp</code> here (even if it were possible) because future frame pointer elision would break this, so either <code>rsp</code> or <code>function call frame base</code> seem like better choices. Computing the offset from here ought to be straightforward.</p>
</blockquote>



<a name="187523099"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187523099" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187523099">(Feb 06 2020 at 06:20)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r375657685" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r375657685">PR Review Comment</a>:</p>
<blockquote>
<p>The <code>bin</code> expression here is wrong, but I've not gotten sufficiently far in this test to need to fix that yet. An earlier (more cumbersome) approach to preserving SIMD registers confirmed that this does get far enough to try generating stores to preserve values though, so that's a start.</p>
</blockquote>



<a name="187523100"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187523100" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187523100">(Feb 06 2020 at 06:20)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354221402" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354221402">PR Review</a>.</p>



<a name="187557670"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187557670" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187557670">(Feb 06 2020 at 15:28)</a>:</h4>
<p>sstangl submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354527113" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354527113">PR Review</a>.</p>



<a name="187557672"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187557672" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187557672">(Feb 06 2020 at 15:28)</a>:</h4>
<p>sstangl submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354527113" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354527113">PR Review</a>.</p>



<a name="187557673"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187557673" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187557673">(Feb 06 2020 at 15:28)</a>:</h4>
<p>sstangl created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r375892668" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r375892668">PR Review Comment</a>:</p>
<blockquote>
<p>I think <a href="https://searchfox.org/mozilla-central/rev/cbd110d718bc89a499d3f996af24532abbf6f8ea/js/src/jit/x64/Trampoline-x64.cpp#72" target="_blank" title="https://searchfox.org/mozilla-central/rev/cbd110d718bc89a499d3f996af24532abbf6f8ea/js/src/jit/x64/Trampoline-x64.cpp#72">the IonMonkey-style approach</a> works well: figure out how many registers to push, allocate stack by subtracting from <code>%rsp</code>, and <code>vmovdqa</code> into place in an arbitrary order of your choosing.</p>
</blockquote>



<a name="187557674"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187557674" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187557674">(Feb 06 2020 at 15:28)</a>:</h4>
<p>sstangl created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r375900790" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r375900790">PR Review Comment</a>:</p>
<blockquote>
<p>I think unfortunately that this isn't quite right -- in order to store the xmm registers, the destination must be 16-byte aligned. Since the number of GPRs pushed is non-constant, you might need padding bytes.</p>
</blockquote>



<a name="187557675"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187557675" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187557675">(Feb 06 2020 at 15:28)</a>:</h4>
<p>sstangl created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r375901559" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r375901559">PR Review Comment</a>:</p>
<blockquote>
<p>Is this comment out of date? It's using <code>types::F64X2.bytes() as usize</code> now which doesn't look like double-counting!</p>
</blockquote>



<a name="187575030"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187575030" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187575030">(Feb 06 2020 at 18:32)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354676529" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354676529">PR Review</a>.</p>



<a name="187575031"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187575031" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187575031">(Feb 06 2020 at 18:32)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376008296" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376008296">PR Review Comment</a>:</p>
<blockquote>
<p>Yes, I think that would work well here too. What I don't know is how to get the value of <code>rsp</code> as a value I can provide here! Is there a way to write "give me an SSA value that is whatever is in <code>rsp</code> at this point"? The other option I can imagine is another pair of <code>x86_*</code> special instructions that directly encode <code>rsp</code>, and take the offset as an argument.</p>
<p>Sidenote: I see IonMonkey uses <code>vmovdqa</code> in favor of <code>movdqa</code> - is that actually what gets emitted? Is there a reason IonMonkey prefers the AVX form?</p>
</blockquote>



<a name="187575804"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187575804" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187575804">(Feb 06 2020 at 18:40)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376012623" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376012623">PR Review Comment</a>:</p>
<blockquote>
<p>Would it be possible to use <code>stack_store</code>?</p>
</blockquote>



<a name="187575805"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187575805" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187575805">(Feb 06 2020 at 18:40)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354682091" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354682091">PR Review</a>.</p>



<a name="187577633"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187577633" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187577633">(Feb 06 2020 at 19:01)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354695285" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354695285">PR Review</a>.</p>



<a name="187577634"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187577634" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187577634">(Feb 06 2020 at 19:01)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376022867" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376022867">PR Review Comment</a>:</p>
<blockquote>
<p>I'd hoped to store XMM registers before worrying about GPRs, so they would be a constant offset rather than conditionally requiring padding. I don't think that actually pans out though, and it's still variable on architecture width, so I'll adjust this to include some padding space if <code>csrs.iter(FPR).len() != 0</code>.</p>
</blockquote>



<a name="187577726"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187577726" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187577726">(Feb 06 2020 at 19:02)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354695846" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354695846">PR Review</a>.</p>



<a name="187577727"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187577727" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187577727">(Feb 06 2020 at 19:02)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376023294" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376023294">PR Review Comment</a>:</p>
<blockquote>
<p>you are correct! I realized shortly after writing the comment that double-counting is wrong for 32-bit targets, but forgot to fix the comment too.</p>
</blockquote>



<a name="187578808"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187578808" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187578808">(Feb 06 2020 at 19:14)</a>:</h4>
<p>iximeow updated <a href="https://github.com/bytecodealliance/cranelift/pull/1378" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378">PR #1378</a> from <code>windows-fprs-preservation</code> to <code>master</code>:</p>
<blockquote>
<ul>
<li>[x] This has been discussed in issue #1366 </li>
<li>[x] A short description: Windows appears to have extended ABI constraints to require callees to save XMM6-XMM15 (see #1366 for links to reference material). This PR adds preserve/restore behavior for those registers.</li>
<li>[x] This PR contains test cases. Ish. There is an additional test that would test the right behavior if this was totally ready to go.</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so and/or ping<br>
<code>bnjbvr</code>. The list of suggested reviewers on the right can help you.</li>
</ul>
<p>This is a draft PR as there are two points where I think I should just ask for help rather than spin my wheels figuring out the Right Thing, I'll add comments below.</p>
<p>@sstangl if you get a chance, I think you might know the right things for the questions to follow!</p>
</blockquote>



<a name="187579235"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187579235" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187579235">(Feb 06 2020 at 19:19)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376031480" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376031480">PR Review Comment</a>:</p>
<blockquote>
<p>ah! yes, I think so. If not, <code>stack_addr</code> is the piece I was missing before, and should work too.</p>
</blockquote>



<a name="187579236"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187579236" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187579236">(Feb 06 2020 at 19:19)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354706423" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354706423">PR Review</a>.</p>



<a name="187579546"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187579546" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187579546">(Feb 06 2020 at 19:22)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354708320" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354708320">PR Review</a>.</p>



<a name="187579547"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187579547" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187579547">(Feb 06 2020 at 19:22)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376032886" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376032886">PR Review Comment</a>:</p>
<blockquote>
<p>Unrelated, but because I noticed: do we know of anyone using <code>StackLimit</code>? <code>total_stack_size</code> here undercounts the real amount of space used in this function, as it doesn't include locals.</p>
</blockquote>



<a name="187585242"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187585242" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187585242">(Feb 06 2020 at 20:26)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354748032" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354748032">PR Review</a>.</p>



<a name="187585243"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187585243" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187585243">(Feb 06 2020 at 20:26)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376063544" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376063544">PR Review Comment</a>:</p>
<blockquote>
<p>All usages of <code>ArgumentPurpose::StackLimit</code> on github are either from Cranelift itself, or a gecko vendoring of Cranelift.</p>
</blockquote>



<a name="187589973"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187589973" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187589973">(Feb 06 2020 at 21:19)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354755864" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354755864">PR Review</a>.</p>



<a name="187589974"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187589974" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187589974">(Feb 06 2020 at 21:19)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354755864" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354755864">PR Review</a>.</p>



<a name="187589975"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187589975" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187589975">(Feb 06 2020 at 21:19)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376069480" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376069480">PR Review Comment</a>:</p>
<blockquote>
<p>typo:</p>
<div class="codehilite"><pre><span></span>/// Get the set of callee-saved general-purpose registers.
</pre></div>


</blockquote>



<a name="187590034"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187590034" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187590034">(Feb 06 2020 at 21:20)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354779721" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354779721">PR Review</a>.</p>



<a name="187590036"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187590036" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187590036">(Feb 06 2020 at 21:20)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376087920" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376087920">PR Review Comment</a>:</p>
<blockquote>
<p>Apologies for the drive by nitpick :)</p>
</blockquote>



<a name="187594456"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187594456" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187594456">(Feb 06 2020 at 22:17)</a>:</h4>
<p>iximeow updated <a href="https://github.com/bytecodealliance/cranelift/pull/1378" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378">PR #1378</a> from <code>windows-fprs-preservation</code> to <code>master</code>:</p>
<blockquote>
<ul>
<li>[x] This has been discussed in issue #1366 </li>
<li>[x] A short description: Windows appears to have extended ABI constraints to require callees to save XMM6-XMM15 (see #1366 for links to reference material). This PR adds preserve/restore behavior for those registers.</li>
<li>[x] This PR contains test cases. Ish. There is an additional test that would test the right behavior if this was totally ready to go.</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so and/or ping<br>
<code>bnjbvr</code>. The list of suggested reviewers on the right can help you.</li>
</ul>
<p>This is a draft PR as there are two points where I think I should just ask for help rather than spin my wheels figuring out the Right Thing, I'll add comments below.</p>
<p>@sstangl if you get a chance, I think you might know the right things for the questions to follow!</p>
</blockquote>



<a name="187594491"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187594491" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187594491">(Feb 06 2020 at 22:17)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354812281" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354812281">PR Review</a>.</p>



<a name="187594492"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187594492" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187594492">(Feb 06 2020 at 22:17)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376113644" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376113644">PR Review Comment</a>:</p>
<blockquote>
<p>good eye, this function went through some revisions too :)</p>
</blockquote>



<a name="187594885"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187594885" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187594885">(Feb 06 2020 at 22:22)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354814734" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354814734">PR Review</a>.</p>



<a name="187594886"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187594886" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187594886">(Feb 06 2020 at 22:22)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376115482" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376115482">PR Review Comment</a>:</p>
<blockquote>
<p>it turns out <code>stack_load</code> and <code>stack_store</code> won't do - there's no direct encoding for them in x86 (yet, I hope) and <code>prologue_epilogue</code> is well past <code>legalize</code>.</p>
<p><code>stack_addr</code> was surprising too: we're also past <code>regalloc</code> so I have to assign a location myself. The error not doing this (that I violated constraints) was quite confusing, because .. what constraints would copying <code>rsp</code> have? :D </p>
<p>A third consideration I didn't realize: we're also well past <code>postopt</code>, so opportunity to merge a <code>stack_addr/{load,store}</code> has passed. To this end, I added only one <code>stack_addr</code> in the prologue, and one in the epilogue, and only if we actually preserve any FPRs in the first place. With <code>stack_load</code>/<code>stack_store</code> encodings this can be cleaned up some more, but this already took longer than I'd anticipated.</p>
<p>Anyway, it works now!</p>
</blockquote>



<a name="187594955"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187594955" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187594955">(Feb 06 2020 at 22:23)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354815390" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354815390">PR Review</a>.</p>



<a name="187594956"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187594956" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187594956">(Feb 06 2020 at 22:23)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376115983" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376115983">PR Review Comment</a>:</p>
<blockquote>
<p>It appears that <code>filetests</code> doesn't actually test <code>bin</code> expressions (anymore?). This continued expressing the wrong bytes even while the test passed.</p>
<p>I thought I saw an incorrect <code>bin</code> in a different filetest, but wrote it off at the time. I'll file a followup issue for this.</p>
</blockquote>



<a name="187595029"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187595029" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187595029">(Feb 06 2020 at 22:24)</a>:</h4>
<p>iximeow updated <a href="https://github.com/bytecodealliance/cranelift/pull/1378" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378">PR #1378</a> from <code>windows-fprs-preservation</code> to <code>master</code>:</p>
<blockquote>
<ul>
<li>[x] This has been discussed in issue #1366 </li>
<li>[x] A short description: Windows appears to have extended ABI constraints to require callees to save XMM6-XMM15 (see #1366 for links to reference material). This PR adds preserve/restore behavior for those registers.</li>
<li>[x] This PR contains test cases. Ish. There is an additional test that would test the right behavior if this was totally ready to go.</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so and/or ping<br>
<code>bnjbvr</code>. The list of suggested reviewers on the right can help you.</li>
</ul>
<p>This is a draft PR as there are two points where I think I should just ask for help rather than spin my wheels figuring out the Right Thing, I'll add comments below.</p>
<p>@sstangl if you get a chance, I think you might know the right things for the questions to follow!</p>
</blockquote>



<a name="187595535"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187595535" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187595535">(Feb 06 2020 at 22:30)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354818662" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354818662">PR Review</a>.</p>



<a name="187595537"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20initial%20brush%20at%20preserving%20SIMD%20reg.../near/187595537" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20initial.20brush.20at.20preserving.20SIMD.20reg.2E.2E.2E.html#187595537">(Feb 06 2020 at 22:30)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376118471" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376118471">PR Review Comment</a>:</p>
<blockquote>
<p>mislead myself, <code>bin</code> directives are tested when the file is <code>test binemit</code>, but this is <code>test compile</code>.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>