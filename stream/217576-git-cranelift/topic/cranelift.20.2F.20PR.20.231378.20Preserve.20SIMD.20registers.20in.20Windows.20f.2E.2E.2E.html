<html>
<head><meta charset="utf-8"><title>cranelift / PR #1378 Preserve SIMD registers in Windows f... · git-cranelift · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/index.html">git-cranelift</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html">cranelift / PR #1378 Preserve SIMD registers in Windows f...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="187596113"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/187596113" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#187596113">(Feb 06 2020 at 22:37)</a>:</h4>
<p>iximeow edited <a href="https://github.com/bytecodealliance/cranelift/pull/1378" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378">PR #1378</a> from <code>windows-fprs-preservation</code> to <code>master</code>:</p>
<blockquote>
<ul>
<li>[x] This has been discussed in issue #1366 </li>
<li>[x] A short description: Windows appears to have extended ABI constraints to require callees to save XMM6-XMM15 (see #1366 for links to reference material). This PR adds preserve/restore behavior for those registers.</li>
<li>[x] This PR contains test cases. Ish. There is an additional test that would test the right behavior if this was totally ready to go.</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so and/or ping<br>
<code>bnjbvr</code>. The list of suggested reviewers on the right can help you.</li>
</ul>
<p>This is a draft PR as there are two points where I think I should just ask for help rather than spin my wheels figuring out the Right Thing, I'll add comments below.</p>
<p>@sstangl if you get a chance, I think you might know the right things for the questions to follow!</p>
</blockquote>



<a name="187596259"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/187596259" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#187596259">(Feb 06 2020 at 22:39)</a>:</h4>
<p>iximeow updated <a href="https://github.com/bytecodealliance/cranelift/pull/1378" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378">PR #1378</a> from <code>windows-fprs-preservation</code> to <code>master</code>:</p>
<blockquote>
<ul>
<li>[x] This has been discussed in issue #1366 </li>
<li>[x] A short description: Windows appears to have extended ABI constraints to require callees to save XMM6-XMM15 (see #1366 for links to reference material). This PR adds preserve/restore behavior for those registers.</li>
<li>[x] This PR contains test cases. Ish. There is an additional test that would test the right behavior if this was totally ready to go.</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so and/or ping<br>
<code>bnjbvr</code>. The list of suggested reviewers on the right can help you.</li>
</ul>
<p>This is a draft PR as there are two points where I think I should just ask for help rather than spin my wheels figuring out the Right Thing, I'll add comments below.</p>
<p>@sstangl if you get a chance, I think you might know the right things for the questions to follow!</p>
</blockquote>



<a name="187596730"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/187596730" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#187596730">(Feb 06 2020 at 22:46)</a>:</h4>
<p>iximeow updated <a href="https://github.com/bytecodealliance/cranelift/pull/1378" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378">PR #1378</a> from <code>windows-fprs-preservation</code> to <code>master</code>:</p>
<blockquote>
<ul>
<li>[x] This has been discussed in issue #1366 </li>
<li>[x] A short description: Windows appears to have extended ABI constraints to require callees to save XMM6-XMM15 (see #1366 for links to reference material). This PR adds preserve/restore behavior for those registers.</li>
<li>[x] This PR contains test cases. Ish. There is an additional test that would test the right behavior if this was totally ready to go.</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so and/or ping<br>
<code>bnjbvr</code>. The list of suggested reviewers on the right can help you.</li>
</ul>
<p>This is a draft PR as there are two points where I think I should just ask for help rather than spin my wheels figuring out the Right Thing, I'll add comments below.</p>
<p>@sstangl if you get a chance, I think you might know the right things for the questions to follow!</p>
</blockquote>



<a name="187596957"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/187596957" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#187596957">(Feb 06 2020 at 22:50)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354827961" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354827961">PR Review</a>.</p>



<a name="187596958"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/187596958" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#187596958">(Feb 06 2020 at 22:50)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376126112" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376126112">PR Review Comment</a>:</p>
<blockquote>
<p>As I mention in the commit message, I do not know having this part of the check causes an error. I tried copying the style in f.ex <code>probestack-disabled.clif</code>, and I swear this passed once, but now yields an error like</p>
<div class="codehilite"><pre><span></span>&gt; [RexOp1spaddr8_id#808d,%rcx]        v11 = stack_addr.i64 ss0
                                      ^~~~~~~~~~~~~~~~~~~~~~~~
Matched #7: \bv11 = stack_addr\.i64 ss0\b
&gt; [Op2fldDisp8#410,%xmm7]             v13 = load.f64x2 notrap aligned v11+16
Missed #8: \[Op2fldDisp8\#410,%xmm7\] v13 = load\.f64x2 notrap aligned v11\+16\b
</pre></div>


<p>note that</p>
<div class="codehilite"><pre><span></span>got:      [Op2fldDisp8#410,%xmm7]             v13 = load.f64x2 notrap aligned v11+16
expected: [Op2fldDisp8#410,%xmm7] v13 = load.f64x2 notrap aligned v11+16
</pre></div>


<p>these are the same aside from whitespace. I tested having the same amount of whitespace just in case, and that didn't influence passing or not. Am I misunderstanding the <code>nextln</code> directive?</p>
</blockquote>



<a name="187599120"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/187599120" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#187599120">(Feb 06 2020 at 23:21)</a>:</h4>
<p>iximeow updated <a href="https://github.com/bytecodealliance/cranelift/pull/1378" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378">PR #1378</a> from <code>windows-fprs-preservation</code> to <code>master</code>:</p>
<blockquote>
<ul>
<li>[x] This has been discussed in issue #1366 </li>
<li>[x] A short description: Windows appears to have extended ABI constraints to require callees to save XMM6-XMM15 (see #1366 for links to reference material). This PR adds preserve/restore behavior for those registers.</li>
<li>[x] This PR contains test cases. Ish. There is an additional test that would test the right behavior if this was totally ready to go.</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so and/or ping<br>
<code>bnjbvr</code>. The list of suggested reviewers on the right can help you.</li>
</ul>
<p>This is a draft PR as there are two points where I think I should just ask for help rather than spin my wheels figuring out the Right Thing, I'll add comments below.</p>
<p>@sstangl if you get a chance, I think you might know the right things for the questions to follow!</p>
</blockquote>



<a name="187599553"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/187599553" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#187599553">(Feb 06 2020 at 23:28)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354844698" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-354844698">PR Review</a>.</p>



<a name="187599554"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/187599554" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#187599554">(Feb 06 2020 at 23:28)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376139770" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r376139770">PR Review Comment</a>:</p>
<blockquote>
<p>This is brittle in the face of frame pointer elision. A more applicable register would be <code>r11</code>, but there are no rex encodings of <code>fstDisp8</code> or <code>fldDisp8</code>, so using <code>r11</code> as a base violates constraints that the registers must have index &lt;=7.</p>
</blockquote>



<a name="187864288"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/187864288" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#187864288">(Feb 10 2020 at 22:13)</a>:</h4>
<p>hrydgard submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-356303949" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-356303949">PR Review</a>.</p>



<a name="187864289"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/187864289" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#187864289">(Feb 10 2020 at 22:13)</a>:</h4>
<p>hrydgard created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r377348464" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r377348464">PR Review Comment</a>:</p>
<blockquote>
<p><code>csr_stack_size = (csr_stack_size + 15) &amp; !0b1111;</code></p>
<p>would save extending when already aligned to 16 bytes (unless I'm misunderstanding something and that's desirable)</p>
</blockquote>



<a name="187864343"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/187864343" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#187864343">(Feb 10 2020 at 22:14)</a>:</h4>
<p>hrydgard edited <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r377348464" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r377348464">PR Review Comment</a>.</p>



<a name="187864365"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/187864365" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#187864365">(Feb 10 2020 at 22:14)</a>:</h4>
<p>hrydgard edited <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r377348464" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r377348464">PR Review Comment</a>.</p>



<a name="187866833"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/187866833" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#187866833">(Feb 10 2020 at 22:45)</a>:</h4>
<p>iximeow updated <a href="https://github.com/bytecodealliance/cranelift/pull/1378" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378">PR #1378</a> from <code>windows-fprs-preservation</code> to <code>master</code>:</p>
<blockquote>
<ul>
<li>[x] This has been discussed in issue #1366 </li>
<li>[x] A short description: Windows appears to have extended ABI constraints to require callees to save XMM6-XMM15 (see #1366 for links to reference material). This PR adds preserve/restore behavior for those registers.</li>
<li>[x] This PR contains test cases. Ish. There is an additional test that would test the right behavior if this was totally ready to go.</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so and/or ping<br>
<code>bnjbvr</code>. The list of suggested reviewers on the right can help you.</li>
</ul>
<p>This is a draft PR as there are two points where I think I should just ask for help rather than spin my wheels figuring out the Right Thing, I'll add comments below.</p>
<p>@sstangl if you get a chance, I think you might know the right things for the questions to follow!</p>
</blockquote>



<a name="187866996"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/187866996" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#187866996">(Feb 10 2020 at 22:47)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-356321675" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-356321675">PR Review</a>.</p>



<a name="187866997"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/187866997" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#187866997">(Feb 10 2020 at 22:47)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r377363155" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r377363155">PR Review Comment</a>:</p>
<blockquote>
<p>that'll teach me for trying to do math. Good catch!</p>
</blockquote>



<a name="187875895"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/187875895" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#187875895">(Feb 11 2020 at 01:31)</a>:</h4>
<p>iximeow updated <a href="https://github.com/bytecodealliance/cranelift/pull/1378" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378">PR #1378</a> from <code>windows-fprs-preservation</code> to <code>master</code>:</p>
<blockquote>
<ul>
<li>[x] This has been discussed in issue #1366 </li>
<li>[x] A short description: Windows appears to have extended ABI constraints to require callees to save XMM6-XMM15 (see #1366 for links to reference material). This PR adds preserve/restore behavior for those registers.</li>
<li>[x] This PR contains test cases. Ish. There is an additional test that would test the right behavior if this was totally ready to go.</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so and/or ping<br>
<code>bnjbvr</code>. The list of suggested reviewers on the right can help you.</li>
</ul>
<p>This is a draft PR as there are two points where I think I should just ask for help rather than spin my wheels figuring out the Right Thing, I'll add comments below.</p>
<p>@sstangl if you get a chance, I think you might know the right things for the questions to follow!</p>
</blockquote>



<a name="187876021"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/187876021" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#187876021">(Feb 11 2020 at 01:34)</a>:</h4>
<p>iximeow updated <a href="https://github.com/bytecodealliance/cranelift/pull/1378" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378">PR #1378</a> from <code>windows-fprs-preservation</code> to <code>master</code>:</p>
<blockquote>
<ul>
<li>[x] This has been discussed in issue #1366 </li>
<li>[x] A short description: Windows appears to have extended ABI constraints to require callees to save XMM6-XMM15 (see #1366 for links to reference material). This PR adds preserve/restore behavior for those registers.</li>
<li>[x] This PR contains test cases. Ish. There is an additional test that would test the right behavior if this was totally ready to go.</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so and/or ping<br>
<code>bnjbvr</code>. The list of suggested reviewers on the right can help you.</li>
</ul>
<p>This is a draft PR as there are two points where I think I should just ask for help rather than spin my wheels figuring out the Right Thing, I'll add comments below.</p>
<p>@sstangl if you get a chance, I think you might know the right things for the questions to follow!</p>
</blockquote>



<a name="187876053"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/187876053" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#187876053">(Feb 11 2020 at 01:35)</a>:</h4>
<p>iximeow updated <a href="https://github.com/bytecodealliance/cranelift/pull/1378" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378">PR #1378</a> from <code>windows-fprs-preservation</code> to <code>master</code>:</p>
<blockquote>
<ul>
<li>[x] This has been discussed in issue #1366 </li>
<li>[x] A short description: Windows appears to have extended ABI constraints to require callees to save XMM6-XMM15 (see #1366 for links to reference material). This PR adds preserve/restore behavior for those registers.</li>
<li>[x] This PR contains test cases. Ish. There is an additional test that would test the right behavior if this was totally ready to go.</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so and/or ping<br>
<code>bnjbvr</code>. The list of suggested reviewers on the right can help you.</li>
</ul>
<p>This is a draft PR as there are two points where I think I should just ask for help rather than spin my wheels figuring out the Right Thing, I'll add comments below.</p>
<p>@sstangl if you get a chance, I think you might know the right things for the questions to follow!</p>
</blockquote>



<a name="188005683"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188005683" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188005683">(Feb 12 2020 at 12:36)</a>:</h4>
<p>jaykrell submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-357416889" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-357416889">PR Review</a>.</p>



<a name="188005684"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188005684" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188005684">(Feb 12 2020 at 12:36)</a>:</h4>
<p>jaykrell created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r378223819" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r378223819">PR Review Comment</a>:</p>
<blockquote>
<p>You only need to preserve the lower 128 bits.<br>
The upper 128 (or 384, whatever) are volatile.<br>
The rationale is:</p>
<ul>
<li>You cannot make registers nonvolatile after the fact.</li>
<li>The ABI cannot be revised in a compatible way, adding nonvolatile registers.</li>
<li>There are no unwind codes to describe how to restore anything not in the v1 ABI.</li>
</ul>
<p>You can save more if you want, but it buys little/nothing.</p>
<p>Except, you know, you can have private calling conventions among known callers/callees.</p>
<p>Callers can assume more volatiles (ymm, zmm) are preserved, and can allow for nonvolatiles to be trashed (that the caller preserves).</p>
<p>Calling conventions are largely?entirely about separate compilation.</p>
</blockquote>



<a name="188005987"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188005987" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188005987">(Feb 12 2020 at 12:40)</a>:</h4>
<p>jaykrell edited <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r378223819" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r378223819">PR Review Comment</a>.</p>



<a name="188041482"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188041482" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188041482">(Feb 12 2020 at 18:53)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-357702420" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-357702420">PR Review</a>.</p>



<a name="188041484"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188041484" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188041484">(Feb 12 2020 at 18:53)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r378446297" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r378446297">PR Review Comment</a>:</p>
<blockquote>
<p>Speaking of unwind, can we update <code>unwind.rs</code> to emit the unwind codes for these CSRs as part of this PR?  The original implementation made some assumptions as to what instructions were present in the prologue.</p>
</blockquote>



<a name="188041803"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188041803" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188041803">(Feb 12 2020 at 18:57)</a>:</h4>
<p>peterhuene edited <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r378446297" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r378446297">PR Review Comment</a>.</p>



<a name="188064421"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188064421" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188064421">(Feb 12 2020 at 23:38)</a>:</h4>
<p>iximeow updated <a href="https://github.com/bytecodealliance/cranelift/pull/1378" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378">PR #1378</a> from <code>windows-fprs-preservation</code> to <code>master</code>:</p>
<blockquote>
<ul>
<li>[x] This has been discussed in issue #1366 </li>
<li>[x] A short description: Windows appears to have extended ABI constraints to require callees to save XMM6-XMM15 (see #1366 for links to reference material). This PR adds preserve/restore behavior for those registers.</li>
<li>[x] This PR contains test cases. Ish. There is an additional test that would test the right behavior if this was totally ready to go.</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so and/or ping<br>
<code>bnjbvr</code>. The list of suggested reviewers on the right can help you.</li>
</ul>
<p>This is a draft PR as there are two points where I think I should just ask for help rather than spin my wheels figuring out the Right Thing, I'll add comments below.</p>
<p>@sstangl if you get a chance, I think you might know the right things for the questions to follow!</p>
</blockquote>



<a name="188064604"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188064604" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188064604">(Feb 12 2020 at 23:41)</a>:</h4>
<p>iximeow updated <a href="https://github.com/bytecodealliance/cranelift/pull/1378" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378">PR #1378</a> from <code>windows-fprs-preservation</code> to <code>master</code>:</p>
<blockquote>
<ul>
<li>[x] This has been discussed in issue #1366 </li>
<li>[x] A short description: Windows appears to have extended ABI constraints to require callees to save XMM6-XMM15 (see #1366 for links to reference material). This PR adds preserve/restore behavior for those registers.</li>
<li>[x] This PR contains test cases. Ish. There is an additional test that would test the right behavior if this was totally ready to go.</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so and/or ping<br>
<code>bnjbvr</code>. The list of suggested reviewers on the right can help you.</li>
</ul>
<p>This is a draft PR as there are two points where I think I should just ask for help rather than spin my wheels figuring out the Right Thing, I'll add comments below.</p>
<p>@sstangl if you get a chance, I think you might know the right things for the questions to follow!</p>
</blockquote>



<a name="188064887"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188064887" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188064887">(Feb 12 2020 at 23:45)</a>:</h4>
<p>iximeow updated <a href="https://github.com/bytecodealliance/cranelift/pull/1378" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378">PR #1378</a> from <code>windows-fprs-preservation</code> to <code>master</code>:</p>
<blockquote>
<ul>
<li>[x] This has been discussed in issue #1366 </li>
<li>[x] A short description: Windows appears to have extended ABI constraints to require callees to save XMM6-XMM15 (see #1366 for links to reference material). This PR adds preserve/restore behavior for those registers.</li>
<li>[x] This PR contains test cases. Ish. There is an additional test that would test the right behavior if this was totally ready to go.</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so and/or ping<br>
<code>bnjbvr</code>. The list of suggested reviewers on the right can help you.</li>
</ul>
<p>This is a draft PR as there are two points where I think I should just ask for help rather than spin my wheels figuring out the Right Thing, I'll add comments below.</p>
<p>@sstangl if you get a chance, I think you might know the right things for the questions to follow!</p>
</blockquote>



<a name="188065683"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188065683" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188065683">(Feb 12 2020 at 23:57)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-357873059" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-357873059">PR Review</a>.</p>



<a name="188065684"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188065684" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188065684">(Feb 12 2020 at 23:57)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r378580904" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r378580904">PR Review Comment</a>:</p>
<blockquote>
<p>I've update Windows fastcall unwind generation to <a href="https://github.com/bytecodealliance/cranelift/pull/1378/files#diff-9fd98f9cfa3e5b06cfaaf0209f9546afR185-R208" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378/files#diff-9fd98f9cfa3e5b06cfaaf0209f9546afR185-R208">emit XmmSave128</a> and XmmSave128Far, though I'm suspect of the offset.</p>
<p>From reading <a href="https://docs.microsoft.com/en-us/cpp/build/exception-handling-x64?view=vs-2019#unwind-operation-code" target="_blank" title="https://docs.microsoft.com/en-us/cpp/build/exception-handling-x64?view=vs-2019#unwind-operation-code">https://docs.microsoft.com/en-us/cpp/build/exception-handling-x64?view=vs-2019#unwind-operation-code</a> it looks like the offset for SaveXmm counts a number of 16-byte stack slots from the base of the call frame, so storing to <code>[rbp - 0x10]</code> would have an offset of 1, <code>[rbp - 0x20]</code> would be 2. In contrast, the callee-save code added here should be <code>[rsp - csr_stack_slot_offset + FPR_offset]</code> where <code>FPR_offset</code> is 0x10, 0x20, ... as appropriate. The offsets recorded are <code>FPR_offset</code>, and my suspicion is that they would be interpreted as offsets from the other side of callee-save space by Windows.</p>
<p>This is well beyond my experience with Windows to actually verify. If this looks right to you, I'd be happy to hear it - threading the size of <code>csr_stack_slot</code> through to <code>UnwindInfo</code> seems kind of annoying. I think it would best be a field on <code>Function</code>?</p>
</blockquote>



<a name="188066083"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188066083" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188066083">(Feb 13 2020 at 00:01)</a>:</h4>
<p>iximeow updated <a href="https://github.com/bytecodealliance/cranelift/pull/1378" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378">PR #1378</a> from <code>windows-fprs-preservation</code> to <code>master</code>:</p>
<blockquote>
<ul>
<li>[x] This has been discussed in issue #1366 </li>
<li>[x] A short description: Windows appears to have extended ABI constraints to require callees to save XMM6-XMM15 (see #1366 for links to reference material). This PR adds preserve/restore behavior for those registers.</li>
<li>[x] This PR contains test cases. Ish. There is an additional test that would test the right behavior if this was totally ready to go.</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so and/or ping<br>
<code>bnjbvr</code>. The list of suggested reviewers on the right can help you.</li>
</ul>
<p>This is a draft PR as there are two points where I think I should just ask for help rather than spin my wheels figuring out the Right Thing, I'll add comments below.</p>
<p>@sstangl if you get a chance, I think you might know the right things for the questions to follow!</p>
</blockquote>



<a name="188066267"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188066267" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188066267">(Feb 13 2020 at 00:04)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-357875504" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-357875504">PR Review</a>.</p>



<a name="188066268"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188066268" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188066268">(Feb 13 2020 at 00:04)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r378582944" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r378582944">PR Review Comment</a>:</p>
<blockquote>
<p>I also updated the comment to be more strongly worded on preserving the low 128 bits, thanks for the feedback, @jaykrell.</p>
</blockquote>



<a name="188073241"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188073241" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188073241">(Feb 13 2020 at 02:39)</a>:</h4>
<p>jaykrell submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-357921970" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-357921970">PR Review</a>.</p>



<a name="188073243"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188073243" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188073243">(Feb 13 2020 at 02:39)</a>:</h4>
<p>jaykrell created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r378623302" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r378623302">PR Review Comment</a>:</p>
<blockquote>
<p>To better understand, just look at C++ examples.<br>
Here is a start. Change it up with alloca to get a frame pointer.<br>
But ouch, keep in mind, compiler does some odd things that seem to violate the spec.<br>
Like getting the rsp/rbp before adjustment, and recording offsets from after.<br>
That does occur below unfortunately -- the use of rax.<br>
That is an optimization and you don't have to do it. Please don't, really.<br>
It is just trying to keep the offsets in the instructions to fit in 8 bits instead of 32 I think, to shrink instruction size, and looks unnecessary in this case, and wastes an instruction.</p>
<div class="codehilite"><pre><span></span>C:\s&gt;type 1.c

__declspec(dllexport)
float (*f1)(float, float);

__declspec(dllexport)
float f2(float a, float b)
{
 float c = a + b;
 float d = a - b;
 float e = a * b;
 float f = a / b;

 return f1(a, b) + f1(c, d) + f1(c, d) - f1(e, f) + f1(e + f, e - f);
}

C:\s&gt;cl /O2 /LD /Zi 1.c /link /noentry /incremental:no
Microsoft (R) C/C++ Optimizing Compiler Version 19.21.27702.2 for x64
Copyright (C) Microsoft Corporation.  All rights reserved.

1.c
Microsoft (R) Incremental Linker Version 14.21.27702.2
Copyright (C) Microsoft Corporation.  All rights reserved.

/out:1.dll
/dll
/implib:1.lib
/debug
/noentry
/incremental:no
1.obj
   Creating library 1.lib and object 1.exp

C:\s&gt;link /dump /unwindinfo /disasm 1.dll
Microsoft (R) COFF/PE Dumper Version 14.21.27702.2
Copyright (C) Microsoft Corporation.  All rights reserved.


Dump of file 1.dll

File Type: DLL

f2:
; This instruction is ok but imho an unnecessary and possibly failed optimization.

  0000000180001000: 48 8B C4           mov         rax,rsp

  0000000180001003: 48 81 EC 98 00 00  sub         rsp,98h
                    00
; for example, this could/should be encoded as mov [rsp-80]

  000000018000100A: 0F 29 70 E8        movaps      xmmword ptr [rax-18h],xmm6

; for example, this could/should be encoded as mov [rsp-70]

  000000018000100E: 0F 29 78 D8        movaps      xmmword ptr [rax-28h],xmm7
  0000000180001012: 0F 28 F9           movaps      xmm7,xmm1
  0000000180001015: 44 0F 29 40 C8     movaps      xmmword ptr [rax-38h],xmm8
  000000018000101A: 44 0F 28 C0        movaps      xmm8,xmm0
  000000018000101E: 44 0F 29 48 B8     movaps      xmmword ptr [rax-48h],xmm9
  0000000180001023: 44 0F 28 C8        movaps      xmm9,xmm0
  0000000180001027: 44 0F 29 50 A8     movaps      xmmword ptr [rax-58h],xmm10
  000000018000102C: F3 44 0F 5C CF     subss       xmm9,xmm7
  0000000180001031: 44 0F 29 58 98     movaps      xmmword ptr [rax-68h],xmm11
  0000000180001036: 44 0F 28 D0        movaps      xmm10,xmm0
  000000018000103A: 44 0F 29 60 88     movaps      xmmword ptr [rax-78h],xmm12
  000000018000103F: F3 44 0F 58 D7     addss       xmm10,xmm7
  0000000180001044: 44 0F 28 E0        movaps      xmm12,xmm0
  0000000180001048: 44 0F 28 D8        movaps      xmm11,xmm0
  000000018000104C: F3 44 0F 59 E7     mulss       xmm12,xmm7
  0000000180001051: 41 0F 28 C9        movaps      xmm1,xmm9
  0000000180001055: 41 0F 28 C2        movaps      xmm0,xmm10
  0000000180001059: F3 44 0F 5E DF     divss       xmm11,xmm7
  000000018000105E: FF 15 A4 1F 00 00  call        qword ptr [f1]
  0000000180001064: 0F 28 F0           movaps      xmm6,xmm0
  0000000180001067: 0F 28 CF           movaps      xmm1,xmm7
  000000018000106A: 41 0F 28 C0        movaps      xmm0,xmm8
  000000018000106E: FF 15 94 1F 00 00  call        qword ptr [f1]
  0000000180001074: F3 0F 58 F0        addss       xmm6,xmm0
  0000000180001078: 41 0F 28 C9        movaps      xmm1,xmm9
  000000018000107C: 41 0F 28 C2        movaps      xmm0,xmm10
  0000000180001080: FF 15 82 1F 00 00  call        qword ptr [f1]
  0000000180001086: 0F 28 F8           movaps      xmm7,xmm0
  0000000180001089: 41 0F 28 CB        movaps      xmm1,xmm11
  000000018000108D: 41 0F 28 C4        movaps      xmm0,xmm12
  0000000180001091: F3 0F 58 FE        addss       xmm7,xmm6
  0000000180001095: FF 15 6D 1F 00 00  call        qword ptr [f1]
  000000018000109B: 41 0F 28 CC        movaps      xmm1,xmm12
  000000018000109F: F3 0F 5C F8        subss       xmm7,xmm0
  00000001800010A3: F3 41 0F 5C CB     subss       xmm1,xmm11
  00000001800010A8: F3 45 0F 58 DC     addss       xmm11,xmm12
  00000001800010AD: 41 0F 28 C3        movaps      xmm0,xmm11
  00000001800010B1: FF 15 51 1F 00 00  call        qword ptr [f1]

 ; blech, see below
  00000001800010B7: 4C 8D 9C 24 98 00  lea         r11,[rsp+98h]
                    00 00
  00000001800010BF: 41 0F 28 73 E8     movaps      xmm6,xmmword ptr [r11-18h]
  00000001800010C4: F3 0F 58 C7        addss       xmm0,xmm7
  00000001800010C8: 0F 28 7C 24 70     movaps      xmm7,xmmword ptr [rsp+70h]
  00000001800010CD: 45 0F 28 43 C8     movaps      xmm8,xmmword ptr [r11-38h]
  00000001800010D2: 45 0F 28 4B B8     movaps      xmm9,xmmword ptr [r11-48h]
  00000001800010D7: 45 0F 28 53 A8     movaps      xmm10,xmmword ptr [r11-58h]
  00000001800010DC: 45 0F 28 5B 98     movaps      xmm11,xmmword ptr [r11-68h]
  00000001800010E1: 45 0F 28 63 88     movaps      xmm12,xmmword ptr [r11-78h]

; This violates the letter of the spec, alas.
; It is supposed to be add rsp,n, or lea rsp, n[frame]
  00000001800010E6: 49 8B E3           mov         rsp,r11
  00000001800010E9: C3                 ret

Function Table (1)

           Begin    End      Info      Function Name

  00000000 00001000 000010EA 0000211C  f2
    Unwind version: 1
    Unwind flags: None
    Size of prologue: 0x3F
    Count of codes: 16
    Unwind codes:
      3F: SAVE_XMM128, register=xmm12 offset=0x20
      36: SAVE_XMM128, register=xmm11 offset=0x30
      2C: SAVE_XMM128, register=xmm10 offset=0x40
      23: SAVE_XMM128, register=xmm9 offset=0x50
      1A: SAVE_XMM128, register=xmm8 offset=0x60
      12: SAVE_XMM128, register=xmm7 offset=0x70
      0E: SAVE_XMM128, register=xmm6 offset=0x80
      0A: ALLOC_LARGE, size=0x98
</pre></div>


<p>So, overall, mixed. The C++ examples help to understand, but they also confuse, because the C++ compiler violates the spec in ways that end up meaning the same thing at runtime, if you understand closely how unwinding works.<br>
I would encourage you to follow the spec instead, though I suppose there might be measurable perf benefits otherwise.</p>
<p>You can do the link /dump /unwindinfo on any binary -- no need for symbols.</p>
</blockquote>



<a name="188081553"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188081553" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188081553">(Feb 13 2020 at 06:22)</a>:</h4>
<p>jaykrell submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-357977669" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-357977669">PR Review</a>.</p>



<a name="188081554"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188081554" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188081554">(Feb 13 2020 at 06:22)</a>:</h4>
<p>jaykrell created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r378670559" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r378670559">PR Review Comment</a>:</p>
<blockquote>
<p>The NT unwinder is also open sourced, here:</p>
<p><a href="https://github.com/dotnet/runtime/blob/master/src/coreclr/src/unwinder/amd64/unwinder_amd64.cpp#L895" target="_blank" title="https://github.com/dotnet/runtime/blob/master/src/coreclr/src/unwinder/amd64/unwinder_amd64.cpp#L895">https://github.com/dotnet/runtime/blob/master/src/coreclr/src/unwinder/amd64/unwinder_amd64.cpp#L895</a></p>
<p>at least an old maybe subsetted/altered form, but probably useful.</p>
</blockquote>



<a name="188081570"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188081570" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188081570">(Feb 13 2020 at 06:23)</a>:</h4>
<p>jaykrell edited <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r378670559" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r378670559">PR Review Comment</a>.</p>



<a name="188129490"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188129490" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188129490">(Feb 13 2020 at 17:32)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-358413880" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-358413880">PR Review</a>.</p>



<a name="188129491"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188129491" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188129491">(Feb 13 2020 at 17:32)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r379011367" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r379011367">PR Review Comment</a>:</p>
<blockquote>
<p>The offsets in the generated unwind information in the test do seem odd, especially compared to the above output form VC++, but I think that's a result of adjusting the stack pointer for the frame <em>after</em> we're writing in the SIMD CSRs.  In the test output, an offset of 0, 0x10, and 0x20 make sense given that the SP will be adjusted up during unwinding restores the XMM registers.</p>
<p>Perhaps we should adjust the SP first?</p>
</blockquote>



<a name="188129498"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188129498" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188129498">(Feb 13 2020 at 17:32)</a>:</h4>
<p>peterhuene edited <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r379011367" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r379011367">PR Review Comment</a>.</p>



<a name="188129539"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188129539" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188129539">(Feb 13 2020 at 17:33)</a>:</h4>
<p>peterhuene edited <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r379011367" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r379011367">PR Review Comment</a>.</p>



<a name="188130312"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188130312" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188130312">(Feb 13 2020 at 17:40)</a>:</h4>
<p>peterhuene edited <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r379011367" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r379011367">PR Review Comment</a>.</p>



<a name="188130377"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188130377" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188130377">(Feb 13 2020 at 17:40)</a>:</h4>
<p>peterhuene edited <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r379011367" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r379011367">PR Review Comment</a>.</p>



<a name="188666215"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188666215" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188666215">(Feb 20 2020 at 18:52)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362148493" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362148493">PR Review</a>.</p>



<a name="188666216"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188666216" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188666216">(Feb 20 2020 at 18:52)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382191307" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382191307">PR Review Comment</a>:</p>
<blockquote>
<p>If the generated unwind info looks okay, are you good with this change and revisiting in case it turns out not to be? I don't have anything resembling a useful Windows development environment, so I'm not even entirely sure what to look for being wrong in case the unwind information is wrong - I imagine "only" an incorrect value for a callee-save register in some parent frame? Given that overall this PR fixes an ABI error that results in dangerously wrong code, I _would_ like to get this figured out :)</p>
</blockquote>



<a name="188668324"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188668324" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188668324">(Feb 20 2020 at 19:15)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362163900" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362163900">PR Review</a>.</p>



<a name="188668325"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188668325" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188668325">(Feb 20 2020 at 19:15)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382203403" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382203403">PR Review Comment</a>:</p>
<blockquote>
<p>I'm good with the change and open to revisiting it in the future.  I think the order of operations in our prologues is just a little "strange" compared to VC++'s prologues, but I don't necessarily see that as a problem with respect to unwind.</p>
</blockquote>



<a name="188669386"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188669386" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188669386">(Feb 20 2020 at 19:27)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362172095" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362172095">PR Review</a>.</p>



<a name="188670930"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188670930" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188670930">(Feb 20 2020 at 19:45)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382219354" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382219354">PR Review Comment</a>:</p>
<blockquote>
<p>Sorry, I just caught this.  I would expect a value of <strong>4</strong> originally, indicating a 40 byte SP adjustment: 8 bytes to realign the stack from the even number of GPR pushes and 32 bytes for the callee spill space we never elide (even for leaf functions).  So there's a bug currently in how we're aligning the stack even when spilling just the GPRs.</p>
<p>With your changes, I would expect a value of 10, indicating 88 bytes: 8 bytes to realign the stack from the even number of GPR pushes, 48 bytes for the saved XMM registers, and 32 bytes for the callee spill space.</p>
</blockquote>



<a name="188670931"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188670931" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188670931">(Feb 20 2020 at 19:45)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362183843" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362183843">PR Review</a>.</p>



<a name="188671638"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188671638" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188671638">(Feb 20 2020 at 19:54)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362189562" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362189562">PR Review</a>.</p>



<a name="188671686"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188671686" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188671686">(Feb 20 2020 at 19:54)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362189562" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362189562">PR Review</a>.</p>



<a name="188672497"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188672497" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188672497">(Feb 20 2020 at 20:03)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362195585" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362195585">PR Review</a>.</p>



<a name="188672498"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188672498" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188672498">(Feb 20 2020 at 20:03)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382228362" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382228362">PR Review Comment</a>:</p>
<blockquote>
<p>For comparison, the VC++ example above allocates 152 bytes for its frame: 8 bytes for stack alignment (upon entry stack is always off by 8 bytes due to call instruction pushing return address), 112 bytes for saved XMM registers, and 32 bytes for callee spill space (the function does call).</p>
</blockquote>



<a name="188672778"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188672778" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188672778">(Feb 20 2020 at 20:06)</a>:</h4>
<p>peterhuene edited <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382228362" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382228362">PR Review Comment</a>.</p>



<a name="188673178"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188673178" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188673178">(Feb 20 2020 at 20:11)</a>:</h4>
<p>peterhuene edited <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382219354" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382219354">PR Review Comment</a>.</p>



<a name="188680435"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188680435" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188680435">(Feb 20 2020 at 21:33)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382269599" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382269599">PR Review Comment</a>:</p>
<blockquote>
<p>Yep, there's definitely an error here. I hadn't checked the generated assembly on this case but</p>
<div class="codehilite"><pre><span></span>Disassembly of 356 bytes:                                                                                                                                                               [69/1840]
   0:   55                      push    rbp
   1:   48 89 e5                mov     rbp, rsp
   4:   53                      push    rbx
   5:   56                      push    rsi
   6:   57                      push    rdi
   7:   41 54                   push    r12
   9:   41 55                   push    r13
   b:   41 56                   push    r14
   d:   41 57                   push    r15
   f:   48 8d 84 24 10 00 00 00 lea     rax, [rsp + 0x10]
  17:   f2 0f 11 30             movsd   qword ptr [rax], xmm6
  1b:   f2 0f 11 78 10          movsd   qword ptr [rax + 0x10], xmm7
  20:   f2 44 0f 11 40 20       movsd   qword ptr [rax + 0x20], xmm8
</pre></div>


<p>is definitely not the prologue I'd want to see. It looks like the callee-save for fprs begins at where the stack was when created, rather than being a non-overlapping region laid out somewhere later on. Which makes sense, since this is so late in compilation. urgh.</p>
</blockquote>



<a name="188680436"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188680436" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188680436">(Feb 20 2020 at 21:33)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362249194" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362249194">PR Review</a>.</p>



<a name="188684191"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188684191" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188684191">(Feb 20 2020 at 22:10)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362271082" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362271082">PR Review</a>.</p>



<a name="188684192"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188684192" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188684192">(Feb 20 2020 at 22:10)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382286384" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382286384">PR Review Comment</a>:</p>
<blockquote>
<p>Was the unwind information "correct" in that RSP is adjusted by only 0x28 following saving the XMM registers?</p>
</blockquote>



<a name="188684290"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188684290" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188684290">(Feb 20 2020 at 22:12)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362271935" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362271935">PR Review</a>.</p>



<a name="188684291"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188684291" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188684291">(Feb 20 2020 at 22:12)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382287012" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382287012">PR Review Comment</a>:</p>
<blockquote>
<p>correct in that it was adjusted by 0x30 (5 * 8 == 40 == 0x28, but there's the implied extra 8 bytes bringing it to 0x30)</p>
</blockquote>



<a name="188684895"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188684895" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188684895">(Feb 20 2020 at 22:19)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362247186" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362247186">PR Review</a>.</p>



<a name="188684896"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188684896" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188684896">(Feb 20 2020 at 22:19)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382268121" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382268121">PR Review Comment</a>:</p>
<blockquote>
<p>File an issue for this todo and link to it here, so that it doesn't get lost, please.</p>
</blockquote>



<a name="188684897"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188684897" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188684897">(Feb 20 2020 at 22:19)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362247186" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362247186">PR Review</a>.</p>



<a name="188684898"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188684898" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188684898">(Feb 20 2020 at 22:19)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382285469" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382285469">PR Review Comment</a>:</p>
<blockquote>
<p>Wait -- shouldn't <code>fpr_offset</code> be initialized to the offset chosen for the stack slot earlier? Right now it is initialized to 0. (Or alternatively but equivalently use the stack slot offset as an immediate for the <code>stack_addr</code> instruction?) Otherwise we are always reading xmm6-15 from stack frame offsets <code>0..</code>. Is this the source of the overlapping stack slot bug?</p>
</blockquote>



<a name="188684899"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188684899" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188684899">(Feb 20 2020 at 22:19)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382275627" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382275627">PR Review Comment</a>:</p>
<blockquote>
<p>Is it too late in the pipeline to make <code>offset</code> be <code>None</code> here and then let <code>layout_stack</code> assign the offset? This might help with the overlapping stack slot issues you and Peter are discussing elsewhere in this thread (can't figure out how to comment inline there??). Or does the fastcall ABI require that they are saved at a particular location?</p>
</blockquote>



<a name="188684900"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188684900" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188684900">(Feb 20 2020 at 22:19)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382286021" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382286021">PR Review Comment</a>:</p>
<blockquote>
<p>ditto</p>
</blockquote>



<a name="188686306"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188686306" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188686306">(Feb 20 2020 at 22:34)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362283677" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362283677">PR Review</a>.</p>



<a name="188686307"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188686307" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188686307">(Feb 20 2020 at 22:34)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382296519" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382296519">PR Review Comment</a>:</p>
<blockquote>
<p>I was just looking at this for the same reason, I think you're on the right track. These offsets are up from the bottom of the stack slot so zero is on the opposite side from where <code>push</code> starts placing registers. My expectation was the callee-save region would look like</p>
<div class="codehilite"><pre><span></span>size      | rbp
size - 8  | rbx
size - 16 | rsi
... other callee-save gprs
0x20      | xmm8
0x10      | xmm7
0x00      | xmm6
</pre></div>


<p>which is close to what the actual layout looks like, but the base isn't what I'd expected.</p>
</blockquote>



<a name="188686392"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188686392" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188686392">(Feb 20 2020 at 22:35)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362284333" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362284333">PR Review</a>.</p>



<a name="188686393"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188686393" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188686393">(Feb 20 2020 at 22:35)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382297064" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382297064">PR Review Comment</a>:</p>
<blockquote>
<p>same as above, either this _is_ or is closely related to the overlapping stack slot issue. Either this will change or I'll update (probably with a comment describing CSR region layout) when it's fixed.</p>
</blockquote>



<a name="188686769"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188686769" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188686769">(Feb 20 2020 at 22:39)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362286458" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362286458">PR Review</a>.</p>



<a name="188686770"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188686770" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188686770">(Feb 20 2020 at 22:39)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382298847" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382298847">PR Review Comment</a>:</p>
<blockquote>
<p>(a nice benefit of picking the end of the CSR region is that it is defined to be aligned by ABI requirements, so we don't need to figure out if the last GPR save left the stack aligned or not)</p>
</blockquote>



<a name="188686846"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188686846" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188686846">(Feb 20 2020 at 22:40)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362286834" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362286834">PR Review</a>.</p>



<a name="188686847"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188686847" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188686847">(Feb 20 2020 at 22:40)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382299172" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382299172">PR Review Comment</a>:</p>
<blockquote>
<p>Oh sorry, I meant 0x30 (the 5 in the unwind info indicating (8*5)+8; I seem to always forget the +8).  Thanks for confirming.</p>
</blockquote>



<a name="188686857"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188686857" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188686857">(Feb 20 2020 at 22:41)</a>:</h4>
<p>peterhuene edited <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382299172" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382299172">PR Review Comment</a>.</p>



<a name="188687075"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188687075" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188687075">(Feb 20 2020 at 22:44)</a>:</h4>
<p>iximeow edited <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382298847" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382298847">PR Review Comment</a>.</p>



<a name="188687681"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188687681" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188687681">(Feb 20 2020 at 22:53)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362292893" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362292893">PR Review</a>.</p>



<a name="188687682"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188687682" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188687682">(Feb 20 2020 at 22:53)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382304102" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382304102">PR Review Comment</a>:</p>
<blockquote>
<p>Also, judging from the above disassembly, The offsets from RSP for the XMM registers are off by 1 in the resulting unwind information it seems.  We're recording the offsets from RAX in the unwind info (scaled-by-16 values of 0, 1, and 2), but RAX itself is offset 0x10 from RSP.</p>
</blockquote>



<a name="188687932"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188687932" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188687932">(Feb 20 2020 at 22:56)</a>:</h4>
<p>peterhuene edited <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382304102" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382304102">PR Review Comment</a>.</p>



<a name="188688154"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188688154" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188688154">(Feb 20 2020 at 22:59)</a>:</h4>
<p>peterhuene deleted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382304102" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382304102">PR Review Comment</a>.</p>



<a name="188688274"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188688274" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188688274">(Feb 20 2020 at 23:00)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362296611" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362296611">PR Review</a>.</p>



<a name="188688277"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188688277" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188688277">(Feb 20 2020 at 23:00)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382307125" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382307125">PR Review Comment</a>:</p>
<blockquote>
<p>I've deleted my last comment since it's probably just related to the overlapping stack slot issues.  Once we have the proper prologue generated, I'll verify that the unwind information properly describes it.</p>
</blockquote>



<a name="188697162"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188697162" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188697162">(Feb 21 2020 at 01:43)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362353558" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362353558">PR Review</a>.</p>



<a name="188697163"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188697163" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188697163">(Feb 21 2020 at 01:43)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382355798" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382355798">PR Review Comment</a>:</p>
<blockquote>
<p>Some notes as it took me a surprising amount of time to figure out what _exactly_ was going on. I didn't really understand <code>StackSlot</code> too well.</p>
<p>The gist of it is that <code>lea rax, [rsp + 0x10]</code> may look like an address of nothing in particular, but that's because it seems <code>StackSlot</code> used alongside adjusting the stack is a recipe for bad times. It's the instruction that would be correct to get the stack slot's start at the entry of the function without intervening changes. That is, the return address and <code>rbp</code> are preserved on the stack by Cranelift, and 0x10 down the stack from the base address of the call frame would be <code>rbx</code> and the start of the rest of the csr region. <code>rsp</code> isn't really "ready for use" until after the prologue though, so <code>stack_addr</code> doesn't seem appropriate to use as it currently exists for this purpose.</p>
<p>Subsequently, the xmm stores _would_ overwrite the return address, <code>rbp</code>, <code>rbx</code>, ..., were the stack slot address right - I misunderstood which direction offsets count from too.</p>
<p>I think what I can do is make a second stack slot that we can directly address for FPR save/lrestore, and requiring 16-byte alignment on that would keep offsets simple as well. I'll give it a try and we'll see how it goes :crossed_fingers: </p>
</blockquote>



<a name="188704529"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188704529" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188704529">(Feb 21 2020 at 05:20)</a>:</h4>
<p>iximeow updated <a href="https://github.com/bytecodealliance/cranelift/pull/1378" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378">PR #1378</a> from <code>windows-fprs-preservation</code> to <code>master</code>:</p>
<blockquote>
<ul>
<li>[x] This has been discussed in issue #1366 </li>
<li>[x] A short description: Windows appears to have extended ABI constraints to require callees to save XMM6-XMM15 (see #1366 for links to reference material). This PR adds preserve/restore behavior for those registers.</li>
<li>[x] This PR contains test cases. Ish. There is an additional test that would test the right behavior if this was totally ready to go.</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so and/or ping<br>
<code>bnjbvr</code>. The list of suggested reviewers on the right can help you.</li>
</ul>
<p>This is a draft PR as there are two points where I think I should just ask for help rather than spin my wheels figuring out the Right Thing, I'll add comments below.</p>
<p>@sstangl if you get a chance, I think you might know the right things for the questions to follow!</p>
</blockquote>



<a name="188704562"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188704562" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188704562">(Feb 21 2020 at 05:21)</a>:</h4>
<p>iximeow updated <a href="https://github.com/bytecodealliance/cranelift/pull/1378" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378">PR #1378</a> from <code>windows-fprs-preservation</code> to <code>master</code>:</p>
<blockquote>
<ul>
<li>[x] This has been discussed in issue #1366 </li>
<li>[x] A short description: Windows appears to have extended ABI constraints to require callees to save XMM6-XMM15 (see #1366 for links to reference material). This PR adds preserve/restore behavior for those registers.</li>
<li>[x] This PR contains test cases. Ish. There is an additional test that would test the right behavior if this was totally ready to go.</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so and/or ping<br>
<code>bnjbvr</code>. The list of suggested reviewers on the right can help you.</li>
</ul>
<p>This is a draft PR as there are two points where I think I should just ask for help rather than spin my wheels figuring out the Right Thing, I'll add comments below.</p>
<p>@sstangl if you get a chance, I think you might know the right things for the questions to follow!</p>
</blockquote>



<a name="188704777"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188704777" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188704777">(Feb 21 2020 at 05:29)</a>:</h4>
<p>iximeow updated <a href="https://github.com/bytecodealliance/cranelift/pull/1378" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378">PR #1378</a> from <code>windows-fprs-preservation</code> to <code>master</code>:</p>
<blockquote>
<ul>
<li>[x] This has been discussed in issue #1366 </li>
<li>[x] A short description: Windows appears to have extended ABI constraints to require callees to save XMM6-XMM15 (see #1366 for links to reference material). This PR adds preserve/restore behavior for those registers.</li>
<li>[x] This PR contains test cases. Ish. There is an additional test that would test the right behavior if this was totally ready to go.</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so and/or ping<br>
<code>bnjbvr</code>. The list of suggested reviewers on the right can help you.</li>
</ul>
<p>This is a draft PR as there are two points where I think I should just ask for help rather than spin my wheels figuring out the Right Thing, I'll add comments below.</p>
<p>@sstangl if you get a chance, I think you might know the right things for the questions to follow!</p>
</blockquote>



<a name="188704779"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188704779" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188704779">(Feb 21 2020 at 05:29)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362407026" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362407026">PR Review</a>.</p>



<a name="188704780"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188704780" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188704780">(Feb 21 2020 at 05:29)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382403956" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382403956">PR Review Comment</a>:</p>
<blockquote>
<p>the missing stack adjustment in this test maybe should have been a giveaway that something was awry too. I'd read it as not necessary, assuming <code>ss0</code> would be some valid stack slot, but in reality this was testing that a store to <code>v7</code> would clobber the start of the CSR region :(</p>
<p><code>ss0</code> is still the correct stack slot with this change because I add the FPR stack slot before the GPR stack slot. I've since updated this test to verify that.</p>
</blockquote>



<a name="188705295"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188705295" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188705295">(Feb 21 2020 at 05:45)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362410660" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362410660">PR Review</a>.</p>



<a name="188705296"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188705296" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188705296">(Feb 21 2020 at 05:45)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382407125" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382407125">PR Review Comment</a>:</p>
<blockquote>
<p>Surprise of surprises, the number is now not <code>3</code>, <code>4</code>, <code>5</code>, or <code>10</code>, but <code>12</code>! I can argue the correctness of 12, though. For <code>stack_slot</code> reasons I don't understand, the FPR preservation region is aligned more strictly than necessary. This grows what would be 48 bytes into 64. Plus eight bytes to realign the stack, and 32 bytes of shadow stack space, that makes for a 104-byte allocation. That would be 13 8-byte slots, minus one for the implied slot makes 12!</p>
<p>A similar wider-than-necessary FPR region is also present in the <a href="https://github.com/bytecodealliance/cranelift/blob/399fb63390f66592730f9922f89b980b16a1ad22/filetests/isa/x86/windows_fastcall_x64.clif#L49" target="_blank" title="https://github.com/bytecodealliance/cranelift/blob/399fb63390f66592730f9922f89b980b16a1ad22/filetests/isa/x86/windows_fastcall_x64.clif#L49"><code>float_callee_save</code></a> test I added. I've tried to follow through what causes this in <code>layout_stack</code> and my best theory is that treating a stack slot as a collection of smaller units is not quite how it's intended to be used, and instead it tries to align the provided stack slots using their sizes as an alignment requirement. It looks like treating a stack slot as an aggregate of more permissible units might be a bit of a change, so I'm open to recommendations if taking ~16-48 extra bytes per call frame is a nonstarter.</p>
</blockquote>



<a name="188705492"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188705492" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188705492">(Feb 21 2020 at 05:51)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362411993" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362411993">PR Review</a>.</p>



<a name="188705493"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188705493" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188705493">(Feb 21 2020 at 05:51)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382408324" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382408324">PR Review Comment</a>:</p>
<blockquote>
<p>update: it's not too late, but <code>layout_stack</code> requires slots of type <code>IncomingArg</code> to have a defined offset. That offset is used for the base of the stack layout so a <code>None</code> ends up being a panic.</p>
<p>I ended up making FPR save/restore go through a second stack slot of kind <code>SpillSlot</code> - it seems like either this or <code>ExplicitSlot</code> might make sense on account of stack store/load is a lot like a spill (if they weren't used, they wouldn't have to be "spilled" to the stack). I'm not entirely sure what <code>ExplicitSlot</code> ought to be used for, but it also looks applicable?</p>
</blockquote>



<a name="188760902"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188760902" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188760902">(Feb 21 2020 at 18:34)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362832014" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362832014">PR Review</a>.</p>



<a name="188760903"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188760903" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188760903">(Feb 21 2020 at 18:34)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382739655" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382739655">PR Review Comment</a>:</p>
<blockquote>
<p>I'm not totally sure, but I <em>think</em> that <code>SpillSlot</code>s are intended to be reused/de-duped across spilled values with distinct live ranges. This should be possible to do in theory for calling convention related stack slots (same as with struct return) but I'm not sure that it works as of today nor that it wouldn't be buggy.</p>
<p>I think (again not totally sure, as they're mostly used in tests and pretty much all slot kinds other than incoming args are treated the same way) that explicit slots are intended as catch all slots used for random purposes.</p>
<p>It seems that other csr slots are all <code>IncomingArg</code> tho, so maybe its best to keep that slot kind and figure out what the explicit offset needs to be, rather than rely on <code>layout_stack</code>.</p>
</blockquote>



<a name="188764638"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188764638" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188764638">(Feb 21 2020 at 19:15)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362856056" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-362856056">PR Review</a>.</p>



<a name="188764639"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/188764639" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#188764639">(Feb 21 2020 at 19:15)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382758396" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382758396">PR Review Comment</a>:</p>
<blockquote>
<p>I think we'd need to make some changes to <code>stack_layout</code> and <code>StackSlot</code> for "correct offset in <code>StackSlotKind::IncomingArg</code>" to be a question we can really answer. <code>stack_addr</code> and friends assume the prologue has already done its stack setup, and, seemingly, that <code>rsp</code> won't move through the body of the function. So for the address of an <code>IncomingArg</code> slot to be used _in_ the prologue, we'd need to defer actual resolution of stack offsets even after the instructions are added.</p>
<p>The other option is tracking the offset ourselves in the prologue, which I expect would look like tracking the amount we've moved SP with pushes/explicit adjustment, then acknowledging that the address from <code>stack_addr(IncomingArgSlot)</code> will be wrong (it'd be off by however much we've pushed) and correcting for that after the fact. Because floating point save/restore is past any GPR pushes, I think the offset will always be valid, just smaller than it "should" be.</p>
<p>I'd be more suspicious that I'm misunderstanding something, but I don't think we have other instances of wanting to do stack loads/stores in prologues/epilogues, so maybe this is actually a rough spot? :(</p>
</blockquote>



<a name="189624123"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/189624123" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#189624123">(Mar 03 2020 at 19:13)</a>:</h4>
<p>iximeow closed without merge <a href="https://github.com/bytecodealliance/cranelift/pull/1378" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378">PR #1378</a>.</p>



<a name="189650615"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/189650615" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#189650615">(Mar 04 2020 at 00:47)</a>:</h4>
<p>jaykrell submitted <a href="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-368430242" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#pullrequestreview-368430242">PR Review</a>.</p>



<a name="189650616"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20PR%20%231378%20Preserve%20SIMD%20registers%20in%20Windows%20f.../near/189650616" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20PR.20.231378.20Preserve.20SIMD.20registers.20in.20Windows.20f.2E.2E.2E.html#189650616">(Mar 04 2020 at 00:47)</a>:</h4>
<p>jaykrell created <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r387381512" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r387381512">PR Review Comment</a>:</p>
<blockquote>
<p>The VIsual C++ code above is weird.<br>
I do not recommend emulating it.<br>
It is surely correct, and it might be optimized, but do not emulate it.<br>
Visual C++ definitely does some strange things as optimizations.<br>
In particular, it stores to the stack before adjusting rsp, and then has to misstate frame pointer offsets. "Normal" code only pushes prior to storing to the stack, I believe.<br>
Maybe try looking at unoptimized output instead.<br>
Or link /dump /disasm /unwindinfo ntoskrnl.exe to find simple stuff written in assembly.<br>
Or read and follow the spec -- Visual C++ kinda skirts the spec.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>