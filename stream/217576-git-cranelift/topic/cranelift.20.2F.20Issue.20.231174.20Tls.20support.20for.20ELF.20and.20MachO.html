<html>
<head><meta charset="utf-8"><title>cranelift / Issue #1174 Tls support for ELF and MachO · git-cranelift · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/index.html">git-cranelift</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231174.20Tls.20support.20for.20ELF.20and.20MachO.html">cranelift / Issue #1174 Tls support for ELF and MachO</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="188051307"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231174%20Tls%20support%20for%20ELF%20and%20MachO/near/188051307" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231174.20Tls.20support.20for.20ELF.20and.20MachO.html#188051307">(Feb 12 2020 at 20:41)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-585407662" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-585407662">commented</a> on <a href="https://github.com/bytecodealliance/cranelift/pull/1174" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174">Issue #1174</a>:</p>
<blockquote>
<p>Ping?</p>
</blockquote>



<a name="188054154"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231174%20Tls%20support%20for%20ELF%20and%20MachO/near/188054154" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231174.20Tls.20support.20for.20ELF.20and.20MachO.html#188054154">(Feb 12 2020 at 21:18)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-585422418" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-585422418">commented</a> on <a href="https://github.com/bytecodealliance/cranelift/pull/1174" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174">Issue #1174</a>:</p>
<blockquote>
<p>@bjorn3 I'm fine with this once the conflicts are resolved and tests are added but that is because I'm not familiar enough with other ways of implementing TLS to have much comment. There's a Cranelift meeting on Monday mornings and there might be someone there that has more insight into the future Cranelift's threading support; I mention that because the whole threading thing might require some back-and-forth discussion.</p>
</blockquote>



<a name="188144146"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231174%20Tls%20support%20for%20ELF%20and%20MachO/near/188144146" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231174.20Tls.20support.20for.20ELF.20and.20MachO.html#188144146">(Feb 13 2020 at 19:57)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-585943990" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-585943990">commented</a> on <a href="https://github.com/bytecodealliance/cranelift/pull/1174" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174">Issue #1174</a>:</p>
<blockquote>
<blockquote>
<p>I'm not familiar enough with other ways of implementing TLS to have much comment.</p>
</blockquote>
<p>While there are other ways to implement TLS support, this matches the native TLS handling of ELF cq Mach-O. This way, it is possible to import/export tls variables from/to native objects. While this is not really necessary for cg_clif, as Rust makes a getter for the TLS var anyway and doesn't export the raw TLS var, for rcc it will likely be needed to interoperate with native code.</p>
</blockquote>



<a name="188209917"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231174%20Tls%20support%20for%20ELF%20and%20MachO/near/188209917" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231174.20Tls.20support.20for.20ELF.20and.20MachO.html#188209917">(Feb 14 2020 at 14:23)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-586309526" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-586309526">commented</a> on <a href="https://github.com/bytecodealliance/cranelift/pull/1174" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174">Issue #1174</a>:</p>
<blockquote>
<p>I rebased this and added tests for legalization of <code>global_value</code> and encoding of <code>x86_{elf,macho}_tls_get_addr</code>. Should I also add a test that <code>cranelift-object</code> correctly writes the tls section?</p>
<blockquote>
<p>I mention that because the whole threading thing might require some back-and-forth discussion.</p>
</blockquote>
<p>For cg_clif this is technically the only thing that prevents multithreading at the moment. I have made atomics atomic by using a global lock. While this is slow, at least it works. I would love to see atomic support in Cranelift, but for now TLS is more important for me.</p>
</blockquote>



<a name="188451377"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231174%20Tls%20support%20for%20ELF%20and%20MachO/near/188451377" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231174.20Tls.20support.20for.20ELF.20and.20MachO.html#188451377">(Feb 18 2020 at 13:46)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-587467774" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-587467774">commented</a> on <a href="https://github.com/bytecodealliance/cranelift/pull/1174" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174">Issue #1174</a>:</p>
<blockquote>
<p>@abrown Has this been discussed?</p>
</blockquote>



<a name="188464355"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231174%20Tls%20support%20for%20ELF%20and%20MachO/near/188464355" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231174.20Tls.20support.20for.20ELF.20and.20MachO.html#188464355">(Feb 18 2020 at 16:14)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-587541865" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-587541865">commented</a> on <a href="https://github.com/bytecodealliance/cranelift/pull/1174" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174">Issue #1174</a>:</p>
<blockquote>
<p>I think the cranelift meeting yesterday was cancelled due to a US holiday (at least I didn't attend) but I posted in a <a href="#narrow/stream/217117-cranelift/topic/threading" title="#narrow/stream/217117-cranelift/topic/threading">zulip chat thread</a> and I will bring it up next Monday.</p>
</blockquote>



<a name="188479982"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231174%20Tls%20support%20for%20ELF%20and%20MachO/near/188479982" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231174.20Tls.20support.20for.20ELF.20and.20MachO.html#188479982">(Feb 18 2020 at 18:56)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-587658657" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-587658657">commented</a> on <a href="https://github.com/bytecodealliance/cranelift/pull/1174" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174">Issue #1174</a>:</p>
<blockquote>
<p>Ok, thanks!</p>
</blockquote>



<a name="188960064"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231174%20Tls%20support%20for%20ELF%20and%20MachO/near/188960064" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231174.20Tls.20support.20for.20ELF.20and.20MachO.html#188960064">(Feb 24 2020 at 19:56)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-590519915" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-590519915">commented</a> on <a href="https://github.com/bytecodealliance/cranelift/pull/1174" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174">Issue #1174</a>:</p>
<blockquote>
<p>I decided to look a bit more at the <code>__tls_get_addr</code> ABI and noticed that I made a wrong assumption. In one place, it is said that the full code sequence needs to be 16 bytes (used to for example relax GD to other TLS models, <a href="https://github.com/llvm/llvm-project/blob/deb5819d6249cfe110da9377910f7e5c88e8ee09/lld/ELF/Arch/X86_64.cpp#L186" target="_blank" title="https://github.com/llvm/llvm-project/blob/deb5819d6249cfe110da9377910f7e5c88e8ee09/lld/ELF/Arch/X86_64.cpp#L186">https://github.com/llvm/llvm-project/blob/deb5819d6249cfe110da9377910f7e5c88e8ee09/lld/ELF/Arch/X86_64.cpp#L186</a>), suggesting a custom ABI, but the glibc implementation seems to require the C abi: <a href="https://github.com/bminor/glibc/blob/5f72f9800b250410cad3abfeeb09469ef12b2438/elf/dl-tls.c#L821" target="_blank" title="https://github.com/bminor/glibc/blob/5f72f9800b250410cad3abfeeb09469ef12b2438/elf/dl-tls.c#L821">https://github.com/bminor/glibc/blob/5f72f9800b250410cad3abfeeb09469ef12b2438/elf/dl-tls.c#L821</a>. When looking at LLVM, this seems to indeed be the case: <a href="https://github.com/llvm/llvm-project/blob/78be61871704a451a5d9462d7e96ed6c982746d4/llvm/lib/Target/X86/X86InstrCompiler.td#L453-L471" target="_blank" title="https://github.com/llvm/llvm-project/blob/78be61871704a451a5d9462d7e96ed6c982746d4/llvm/lib/Target/X86/X86InstrCompiler.td#L453-L471">https://github.com/llvm/llvm-project/blob/78be61871704a451a5d9462d7e96ed6c982746d4/llvm/lib/Target/X86/X86InstrCompiler.td#L453-L471</a>. The current code works for cg_clif, but that may be caused by the fact that rust creates a very small function just to get the tls addr, so none of the clobbered registers are used after the <code>global_value</code> instruction.</p>
<p>Clobbering all necessary registers will mean that I have to add even more clobber registers. Another option would be to use the existing infrastructure for the <code>call</code> and <code>call_indirect</code> instruction.</p>
</blockquote>



<a name="188961277"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231174%20Tls%20support%20for%20ELF%20and%20MachO/near/188961277" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231174.20Tls.20support.20for.20ELF.20and.20MachO.html#188961277">(Feb 24 2020 at 20:10)</a>:</h4>
<p>bjorn3 edited a <a href="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-590519915" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-590519915">comment</a> on <a href="https://github.com/bytecodealliance/cranelift/pull/1174" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174">Issue #1174</a>:</p>
<blockquote>
<p>I decided to look a bit more at the <code>__tls_get_addr</code> ABI and noticed that I made a wrong assumption. In one place, it is said that the full code sequence needs to be 16 bytes (used to for example relax GD to other TLS models, <a href="https://github.com/llvm/llvm-project/blob/deb5819d6249cfe110da9377910f7e5c88e8ee09/lld/ELF/Arch/X86_64.cpp#L186" target="_blank" title="https://github.com/llvm/llvm-project/blob/deb5819d6249cfe110da9377910f7e5c88e8ee09/lld/ELF/Arch/X86_64.cpp#L186">https://github.com/llvm/llvm-project/blob/deb5819d6249cfe110da9377910f7e5c88e8ee09/lld/ELF/Arch/X86_64.cpp#L186</a>), suggesting a custom ABI, but the glibc implementation seems to require the C abi: <a href="https://github.com/bminor/glibc/blob/5f72f9800b250410cad3abfeeb09469ef12b2438/elf/dl-tls.c#L821" target="_blank" title="https://github.com/bminor/glibc/blob/5f72f9800b250410cad3abfeeb09469ef12b2438/elf/dl-tls.c#L821">https://github.com/bminor/glibc/blob/5f72f9800b250410cad3abfeeb09469ef12b2438/elf/dl-tls.c#L821</a>. When looking at LLVM, this seems to indeed be the case: <a href="https://github.com/llvm/llvm-project/blob/78be61871704a451a5d9462d7e96ed6c982746d4/llvm/lib/Target/X86/X86InstrCompiler.td#L453-L471" target="_blank" title="https://github.com/llvm/llvm-project/blob/78be61871704a451a5d9462d7e96ed6c982746d4/llvm/lib/Target/X86/X86InstrCompiler.td#L453-L471">https://github.com/llvm/llvm-project/blob/78be61871704a451a5d9462d7e96ed6c982746d4/llvm/lib/Target/X86/X86InstrCompiler.td#L453-L471</a>. The current code works for cg_clif, but that may be caused by the fact that rust creates a very small function just to get the tls addr, so none of the clobbered registers are used after the <code>global_value</code> instruction.</p>
<p>Clobbering all necessary registers will mean that I have to add even more clobber registers. &lt;strike&gt;Another option would be to use the existing infrastructure for the <code>call</code> and <code>call_indirect</code> instruction.&lt;/strike&gt; (Edit: existing infrastructure only works for actual <code>call</code> and <code>call_indirect</code>.)</p>
</blockquote>



<a name="189052790"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231174%20Tls%20support%20for%20ELF%20and%20MachO/near/189052790" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231174.20Tls.20support.20for.20ELF.20and.20MachO.html#189052790">(Feb 25 2020 at 19:37)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-591030786" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-591030786">commented</a> on <a href="https://github.com/bytecodealliance/cranelift/pull/1174" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174">Issue #1174</a>:</p>
<blockquote>
<p>I tried to add more output registers for the clobbering, but the maximum amount of outputs is 8, which is way less than the amount of registers than are clobbered.</p>
<p>I also tried to use the same spill logic as used by normal calls, but I can't find where it is determined which registers are caller-saved and should spilled to the stack.</p>
</blockquote>



<a name="189053635"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231174%20Tls%20support%20for%20ELF%20and%20MachO/near/189053635" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231174.20Tls.20support.20for.20ELF.20and.20MachO.html#189053635">(Feb 25 2020 at 19:46)</a>:</h4>
<p>iximeow <a href="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-591035038" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-591035038">commented</a> on <a href="https://github.com/bytecodealliance/cranelift/pull/1174" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174">Issue #1174</a>:</p>
<blockquote>
<blockquote>
<p>I also tried to use the same spill logic as used by normal calls, but I can't find where it is determined which registers are caller-saved and should spilled to the stack.</p>
</blockquote>
<p>I think you might not have been able to find it because all register values that live through a call are spilled - callee-save/caller-save ABI guarantees are disregarded at the moment. <a href="https://github.com/bytecodealliance/cranelift/blob/master/cranelift-codegen/src/regalloc/spilling.rs#L267-L269" target="_blank" title="https://github.com/bytecodealliance/cranelift/blob/master/cranelift-codegen/src/regalloc/spilling.rs#L267-L269">There's a note in <code>spilling.rs</code> for this</a>. This <code>if</code> could be extended to spill around clobber-happy TLS operations.</p>
</blockquote>



<a name="189057110"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231174%20Tls%20support%20for%20ELF%20and%20MachO/near/189057110" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231174.20Tls.20support.20for.20ELF.20and.20MachO.html#189057110">(Feb 25 2020 at 20:21)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-591050120" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-591050120">commented</a> on <a href="https://github.com/bytecodealliance/cranelift/pull/1174" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174">Issue #1174</a>:</p>
<blockquote>
<p>Thanks @iximeow! It now correctly spills all caller-saved registers.</p>
</blockquote>



<a name="189091105"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231174%20Tls%20support%20for%20ELF%20and%20MachO/near/189091105" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231174.20Tls.20support.20for.20ELF.20and.20MachO.html#189091105">(Feb 26 2020 at 07:19)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-591277189" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-591277189">commented</a> on <a href="https://github.com/bytecodealliance/cranelift/pull/1174" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174">Issue #1174</a>:</p>
<blockquote>
<p><span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p>
</blockquote>



<a name="189785401"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231174%20Tls%20support%20for%20ELF%20and%20MachO/near/189785401" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231174.20Tls.20support.20for.20ELF.20and.20MachO.html#189785401">(Mar 05 2020 at 12:30)</a>:</h4>
<p>stefson <a href="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-595205081" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-595205081">commented</a> on <a href="https://github.com/bytecodealliance/cranelift/pull/1174" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174">Issue #1174</a>:</p>
<blockquote>
<p>@bjorn3  </p>
<p>I'm getting a compile error with building for aarch64-unknown-linux-gnu on current master, and found this pullrequest as the culprit when bisecting the issue. Here's the error: </p>
<div class="codehilite"><pre><span></span>   Compiling cranelift-codegen-meta v0.59.0 (/tmp/wasmtime/cranelift/codegen/meta)
   Compiling cranelift-bforest v0.59.0 (/tmp/wasmtime/cranelift/bforest)
   Compiling wasi-common v0.12.0 (/tmp/wasmtime/crates/wasi-common)
   Compiling cranelift-codegen v0.59.0 (/tmp/wasmtime/cranelift/codegen)
warning: unused import: `self::call::expand_call`
  --&gt; cranelift/codegen/src/legalizer/mod.rs:35:5
   |
35 | use self::call::expand_call;
   |     ^^^^^^^^^^^^^^^^^^^^^^^
   |
   = note: `#[warn(unused_imports)]` on by default

warning: unused import: `self::globalvalue::expand_global_value`
  --&gt; cranelift/codegen/src/legalizer/mod.rs:36:5
   |
36 | use self::globalvalue::expand_global_value;
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

warning: unused import: `self::heap::expand_heap_addr`
  --&gt; cranelift/codegen/src/legalizer/mod.rs:37:5
   |
37 | use self::heap::expand_heap_addr;
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^

warning: unused import: `self::table::expand_table_addr`
  --&gt; cranelift/codegen/src/legalizer/mod.rs:39:5
   |
39 | use self::table::expand_table_addr;
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

error[E0599]: no variant or associated item named `X86ElfTlsGetAddr` found for type `ir::instructions::Opcode` in the current scope
    --&gt; cranelift/codegen/src/regalloc/spilling.rs:272:45
     |
272  |             || opcode == crate::ir::Opcode::X86ElfTlsGetAddr
     |                                             ^^^^^^^^^^^^^^^^ variant or associated item not found in `ir::instructions::Opcode`
     |
    ::: /tmp/wasmtime/target/aarch64-unknown-linux-gnu/debug/build/cranelift-codegen-dd375821e82eb469/out/opcodes.rs:1427:1
     |
1427 | pub enum Opcode {
     | --------------- variant or associated item `X86ElfTlsGetAddr` not found here

error[E0599]: no variant or associated item named `X86MachoTlsGetAddr` found for type `ir::instructions::Opcode` in the current scope
    --&gt; cranelift/codegen/src/regalloc/spilling.rs:273:45
     |
273  |             || opcode == crate::ir::Opcode::X86MachoTlsGetAddr
     |                                             ^^^^^^^^^^^^^^^^^^ variant or associated item not found in `ir::instructions::Opcode`
     |
    ::: /tmp/wasmtime/target/aarch64-unknown-linux-gnu/debug/build/cranelift-codegen-dd375821e82eb469/out/opcodes.rs:1427:1
     |
1427 | pub enum Opcode {
     | --------------- variant or associated item `X86MachoTlsGetAddr` not found here

error: aborting due to 2 previous errors

For more information about this error, try `rustc --explain E0599`.
error: could not compile `cranelift-codegen`.
</pre></div>


<p>It's propably worth noting that this only happens when executing <code>cargo build</code> from the wasmtime dir, and it doesn't when <code>cd wasmtime/cranelift &amp; cargo build</code>. Still the error seems to be from cranelift. </p>
<p>P.S: the regression is caused by <a href="https://github.com/bytecodealliance/wasmtime/commit/0a1bb3ba6ccadd4b716cd259a097bb31435c0c6d" target="_blank" title="https://github.com/bytecodealliance/wasmtime/commit/0a1bb3ba6ccadd4b716cd259a097bb31435c0c6d">https://github.com/bytecodealliance/wasmtime/commit/0a1bb3ba6ccadd4b716cd259a097bb31435c0c6d</a> , I hope this thread is the correct one to note the author of that regression. </p>
</blockquote>



<a name="189788140"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231174%20Tls%20support%20for%20ELF%20and%20MachO/near/189788140" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231174.20Tls.20support.20for.20ELF.20and.20MachO.html#189788140">(Mar 05 2020 at 13:02)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-595217112" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-595217112">commented</a> on <a href="https://github.com/bytecodealliance/cranelift/pull/1174" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174">Issue #1174</a>:</p>
<blockquote>
<p>The problem is probably that Cranelift got built without x86 support, but I added a special case to regalloc with an x86 only instruction without checking for x86 support. I think the solution is to add an instruction attribute, just like <code>is_call</code> and <code>is_branch</code>, for this special case instead.</p>
</blockquote>



<a name="189828324"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231174%20Tls%20support%20for%20ELF%20and%20MachO/near/189828324" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231174.20Tls.20support.20for.20ELF.20and.20MachO.html#189828324">(Mar 05 2020 at 19:38)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-595409105" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-595409105">commented</a> on <a href="https://github.com/bytecodealliance/cranelift/pull/1174" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174">Issue #1174</a>:</p>
<blockquote>
<p>@bjorn3, can you create an issue in wasmtime so we can track this there?</p>
</blockquote>



<a name="189828370"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217576-git-cranelift/topic/cranelift%20/%20Issue%20%231174%20Tls%20support%20for%20ELF%20and%20MachO/near/189828370" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GitHub <a href="https://bytecodealliance.github.io/zulip-archive/stream/217576-git-cranelift/topic/cranelift.20.2F.20Issue.20.231174.20Tls.20support.20for.20ELF.20and.20MachO.html#189828370">(Mar 05 2020 at 19:38)</a>:</h4>
<p>abrown edited a <a href="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-595409105" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174#issuecomment-595409105">comment</a> on <a href="https://github.com/bytecodealliance/cranelift/pull/1174" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1174">Issue #1174</a>:</p>
<blockquote>
<p>@bjorn3 (or @stefson), can you create an issue in wasmtime so we can track this there?</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>