<html>
<head><meta charset="utf-8"><title>rfcs / PR #9 RFC (Wasmtime): add host functions at the `E... · rfc-notifications · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/index.html">rfc-notifications</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html">rfcs / PR #9 RFC (Wasmtime): add host functions at the `E...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="222027015"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222027015" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222027015">(Jan 08 2021 at 02:12)</a>:</h4>
<p>peterhuene opened <a href="https://github.com/bytecodealliance/rfcs/pull/9">PR #9</a> from <code>engine-host-functions</code> to <code>main</code>:</p>
<blockquote>
<p><a href="https://github.com/peterhuene/rfcs/blob/engine-host-functions/accepted/engine-host-functions.md">Rendered RFC</a></p>
<p>This RFC proposes to extend the Wasmtime API to allow users to define host<br>
functions at the <code>Engine</code>-level.</p>
<p>Today, <code>Func</code> is used to define host functions, but it is tied to a <code>Store</code>.<br>
If users desire short-lived stores to ensure short-lived instances, host<br>
functions need to be redefined upon every module instantiation.</p>
<p>By defining host functions at the <code>Engine</code>-level, instances can be created<br>
without having to redefine the host functions; this will make for faster module<br>
instantiations in scenarios where a module is repeatedly instantiated.</p>
</blockquote>



<a name="222088130"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222088130" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222088130">(Jan 08 2021 at 15:53)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/rfcs/pull/9#pullrequestreview-564360235">PR Review</a>.</p>



<a name="222088131"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222088131" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222088131">(Jan 08 2021 at 15:53)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/rfcs/pull/9#pullrequestreview-564360235">PR Review</a>.</p>



<a name="222088132"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222088132" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222088132">(Jan 08 2021 at 15:53)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/rfcs/pull/9#discussion_r554022203">PR Review Comment</a>:</p>
<blockquote>
<p>Since <code>Store</code> is generally behind <code>Rc</code> and such I think we'll want to change this and <code>remove_context</code> to <code>&amp;self</code> instead of <code>&amp;mut self</code>.<br>
</p>
</blockquote>



<a name="222088133"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222088133" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222088133">(Jan 08 2021 at 15:53)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/rfcs/pull/9#discussion_r554020265">PR Review Comment</a>:</p>
<blockquote>
<p>I think we may not end up needing <code>IntoEngineFunc</code> as a separate trait here? It's mentioned below that this trait will also be implemented for <code>Fn(Caller, &amp;[Val], &amp;mut [Val]) -&gt; Result&lt;Trap&gt; + </code>static<code> but I don't think we can do that because we can't infer the type signature from the closure. If that's the only reason, though, then this could have two methods, one taking </code>IntoFunc<code> and the other being the mirror of </code>Func::new` which takes a signature and a function?</p>
</blockquote>



<a name="222088134"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222088134" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222088134">(Jan 08 2021 at 15:53)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/rfcs/pull/9#discussion_r554026182">PR Review Comment</a>:</p>
<blockquote>
<p>FWIW this doesn't look like it necessarily needs to be a function on<code>Wasi</code>, it could presumably just be <code>store.set_context(WasiCtx::default())</code>?</p>
</blockquote>



<a name="222088192"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222088192" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222088192">(Jan 08 2021 at 15:54)</a>:</h4>
<p>alexcrichton edited <a href="https://github.com/bytecodealliance/rfcs/pull/9#discussion_r554020265">PR Review Comment</a>.</p>



<a name="222093531"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222093531" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222093531">(Jan 08 2021 at 16:33)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/rfcs/pull/9#pullrequestreview-564006766">PR Review</a>.</p>



<a name="222093532"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222093532" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222093532">(Jan 08 2021 at 16:33)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/rfcs/pull/9#discussion_r554051101">PR Review Comment</a>:</p>
<blockquote>
<p>In use cases for API virtualization, the store doesn't seem like the right entity to attach contextual information to. Using the store here effectively makes all instances of an API share data.</p>
<p>The Wasmtime ABI passes the callee vmcontext to regular wasm functions; would it make sense to use a similar mechanism for engine functions, and store the state in something like the <code>host_state</code> field in <code>Instance</code>, instead of in the store?<br>
</p>
</blockquote>



<a name="222093533"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222093533" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222093533">(Jan 08 2021 at 16:33)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/rfcs/pull/9#pullrequestreview-564006766">PR Review</a>.</p>



<a name="222095108"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222095108" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222095108">(Jan 08 2021 at 16:47)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/rfcs/pull/9#pullrequestreview-564417903">PR Review</a>.</p>



<a name="222095109"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222095109" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222095109">(Jan 08 2021 at 16:47)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/rfcs/pull/9#discussion_r554060616">PR Review Comment</a>:</p>
<blockquote>
<p>I'm not sure that instances are the best places to store data because they're generally designed at the wasm-spec-level to get decomposed into a bag of functions/globals/etc and those get passed around individually. The "calling instance" seems like it's sometimes a little ambiguous or just generally not available. </p>
<p>For virtualization, though, can you detail how something like this wouldn't work well? Wasm-based virtualization wouldn't be affected at all since it's not storing data directly in the <code>Store</code>, and host-based virtualization presumably wouldn't be using the exact same type of context to virtualize? (and if it is it could always use a newttype)</p>
</blockquote>



<a name="222099706"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222099706" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222099706">(Jan 08 2021 at 17:21)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/rfcs/pull/9#pullrequestreview-564442662">PR Review</a>.</p>



<a name="222099707"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222099707" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222099707">(Jan 08 2021 at 17:21)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/rfcs/pull/9#discussion_r554083878">PR Review Comment</a>:</p>
<blockquote>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> it would be really nice to avoid another <code>IntoFunc</code> style trait.</p>
<ul>
<li>They aren't great from a user point of view since they are basically "special" sealed traits and you have to figure out what shape of things are expected.</li>
<li>This seems, as Alex mentions, basically identical to the existing trait. Would be great to share a single trait if possible.</li>
</ul>
</blockquote>



<a name="222100866"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222100866" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222100866">(Jan 08 2021 at 17:30)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/rfcs/pull/9#pullrequestreview-564447827">PR Review</a>.</p>



<a name="222100867"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222100867" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222100867">(Jan 08 2021 at 17:30)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/rfcs/pull/9#pullrequestreview-564447827">PR Review</a>.</p>



<a name="222100868"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222100868" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222100868">(Jan 08 2021 at 17:30)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/rfcs/pull/9#discussion_r554087942">PR Review Comment</a>:</p>
<blockquote>
<div class="codehilite" data-code-language="suggestion"><pre><span></span><code>/// This will replace any existing `WasiCtx` associated with the `Store`.
///
/// The old `WasiCtx`, if any, is returned.
pub fn set_context(store: &amp;Store, context: WasiCtx) -&gt; Option&lt;WasiCtx&gt;;
</code></pre></div>
<p>Although, will this overwrite <em>any</em> context that already exists on the store? Not just a <code>WasiCtx</code>?</p>
<p>This is why it would be nice if we used <a href="https://en.wikipedia.org/wiki/Ephemeron">ephemerons</a> for associating context instead. (Something we can always add later, if it makes sense; nothing to block this stuff on I don't think.)</p>
</blockquote>



<a name="222105269"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222105269" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222105269">(Jan 08 2021 at 18:04)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/rfcs/pull/9#pullrequestreview-564471457">PR Review</a>.</p>



<a name="222105270"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222105270" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222105270">(Jan 08 2021 at 18:04)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/rfcs/pull/9#discussion_r554105996">PR Review Comment</a>:</p>
<blockquote>
<p>The existing <code>IntoFunc</code> method is inherently tied to <code>Store</code>, which is why it isn't being used in this context.</p>
<p>I'm not a fan of more boilerplate code, but I'm open to somehow extending <code>IntoFunc</code> for this use case.</p>
<p>Regarding <code>Fn(Caller, &amp;[Val], &amp;mut [Val])</code>, you're absolutely right that we can't infer the Wasm type of the function with that so another method will be necessary.</p>
</blockquote>



<a name="222105349"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222105349" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222105349">(Jan 08 2021 at 18:05)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/rfcs/pull/9#pullrequestreview-564471954">PR Review</a>.</p>



<a name="222105350"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222105350" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222105350">(Jan 08 2021 at 18:05)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/rfcs/pull/9#discussion_r554106353">PR Review Comment</a>:</p>
<blockquote>
<p>Agreed.  I'll remove the <code>&amp;mut</code>.</p>
</blockquote>



<a name="222105542"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222105542" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222105542">(Jan 08 2021 at 18:07)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/rfcs/pull/9#pullrequestreview-564472979">PR Review</a>.</p>



<a name="222105543"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222105543" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222105543">(Jan 08 2021 at 18:07)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/rfcs/pull/9#discussion_r554107224">PR Review Comment</a>:</p>
<blockquote>
<p>The thinking behind this is that <code>Wasi</code> will likely want to wrap the <code>WasiCtx</code> in a <code>RefCell</code> and it is the only one that knows exactly what it expects the context type to be in the host functions.</p>
</blockquote>



<a name="222105700"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222105700" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222105700">(Jan 08 2021 at 18:08)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/rfcs/pull/9#pullrequestreview-564474060">PR Review</a>.</p>



<a name="222105701"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222105701" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222105701">(Jan 08 2021 at 18:08)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/rfcs/pull/9#discussion_r554108023">PR Review Comment</a>:</p>
<blockquote>
<p>It would just replace the <code>WasiCtx</code> as a map of typeid -&gt; context value will be used ala Lucet's <code>set_embed_ctx</code>.</p>
</blockquote>



<a name="222105724"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222105724" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222105724">(Jan 08 2021 at 18:09)</a>:</h4>
<p>peterhuene edited <a href="https://github.com/bytecodealliance/rfcs/pull/9#discussion_r554108023">PR Review Comment</a>.</p>



<a name="222105736"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222105736" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222105736">(Jan 08 2021 at 18:09)</a>:</h4>
<p>peterhuene updated <a href="https://github.com/bytecodealliance/rfcs/pull/9">PR #9</a> from <code>engine-host-functions</code> to <code>main</code>:</p>
<blockquote>
<p><a href="https://github.com/peterhuene/rfcs/blob/engine-host-functions/accepted/engine-host-functions.md">Rendered RFC</a></p>
<p>This RFC proposes to extend the Wasmtime API to allow users to define host<br>
functions at the <code>Engine</code>-level.</p>
<p>Today, <code>Func</code> is used to define host functions, but it is tied to a <code>Store</code>.<br>
If users desire short-lived stores to ensure short-lived instances, host<br>
functions need to be redefined upon every module instantiation.</p>
<p>By defining host functions at the <code>Engine</code>-level, instances can be created<br>
without having to redefine the host functions; this will make for faster module<br>
instantiations in scenarios where a module is repeatedly instantiated.</p>
</blockquote>



<a name="222105913"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222105913" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222105913">(Jan 08 2021 at 18:10)</a>:</h4>
<p>peterhuene edited <a href="https://github.com/bytecodealliance/rfcs/pull/9#discussion_r554105996">PR Review Comment</a>.</p>



<a name="222107650"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222107650" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222107650">(Jan 08 2021 at 18:25)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/rfcs/pull/9#pullrequestreview-564485140">PR Review</a>.</p>



<a name="222107651"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222107651" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222107651">(Jan 08 2021 at 18:25)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/rfcs/pull/9#discussion_r554116631">PR Review Comment</a>:</p>
<blockquote>
<p>Ah right that's a good point, but I think we can add new functions as necessary to that trait since it's not intended to be implemented externally. We might have roughtly the same amount of boilerplate internally but  I think we should be able to get away witth one trait.</p>
</blockquote>



<a name="222107720"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222107720" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222107720">(Jan 08 2021 at 18:26)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/rfcs/pull/9#pullrequestreview-564485319">PR Review</a>.</p>



<a name="222107722"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222107722" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222107722">(Jan 08 2021 at 18:26)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/rfcs/pull/9#discussion_r554116790">PR Review Comment</a>:</p>
<blockquote>
<p>Ah ok that's a good point yeah, seems reasonable!</p>
</blockquote>



<a name="222108262"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222108262" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222108262">(Jan 08 2021 at 18:30)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/rfcs/pull/9#pullrequestreview-564488261">PR Review</a>.</p>



<a name="222108263"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222108263" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222108263">(Jan 08 2021 at 18:30)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/rfcs/pull/9#discussion_r554119115">PR Review Comment</a>:</p>
<blockquote>
<p>For more context, I originally proposed (in a privately reviewed draft) that the context be set on the instance, so I'm not opposed to that.</p>
<p>I think I was unclear in the intention of <code>set_context</code> allowing multiple values of different types, which is what Lucet does today with <code>insert_embed_ctx</code>.  As such, "insert" would probably be a better name as "set" has a singular connotation; I'll make that change.</p>
<p>If we do store it on the instance, we'll obviously need to modify the <code>wasmtime_runtime::Instance</code> to store the values and then <code>Caller</code> needs to be modified to perhaps return a <code>wasmtime::Instance</code> to get the values from?</p>
<p>That said, if we keep it on the <code>Store</code>, it's true that all instances using the <code>Wasi</code> host functions added at the engine-level will share the same <code>WasiCxt</code> context.  But that still does not preclude users from being able to call <code>Wasi::add_to_linker</code> to link in WASI with a different context for a specific instantiation.</p>
</blockquote>



<a name="222108639"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222108639" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222108639">(Jan 08 2021 at 18:33)</a>:</h4>
<p>peterhuene edited <a href="https://github.com/bytecodealliance/rfcs/pull/9#discussion_r554108023">PR Review Comment</a>.</p>



<a name="222111921"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222111921" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222111921">(Jan 08 2021 at 19:02)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/rfcs/pull/9#pullrequestreview-564508229">PR Review</a>.</p>



<a name="222111923"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222111923" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222111923">(Jan 08 2021 at 19:02)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/rfcs/pull/9#discussion_r554134615">PR Review Comment</a>:</p>
<blockquote>
<p>Agreed.  I'll update the draft with extensions for <code>IntoFunc</code>.</p>
</blockquote>



<a name="222114166"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222114166" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222114166">(Jan 08 2021 at 19:21)</a>:</h4>
<p>peterhuene edited <a href="https://github.com/bytecodealliance/rfcs/pull/9#discussion_r554119115">PR Review Comment</a>.</p>



<a name="222114221"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222114221" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222114221">(Jan 08 2021 at 19:22)</a>:</h4>
<p>peterhuene edited <a href="https://github.com/bytecodealliance/rfcs/pull/9#discussion_r554119115">PR Review Comment</a>.</p>



<a name="222116003"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222116003" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222116003">(Jan 08 2021 at 19:39)</a>:</h4>
<p>peterhuene updated <a href="https://github.com/bytecodealliance/rfcs/pull/9">PR #9</a> from <code>engine-host-functions</code> to <code>main</code>:</p>
<blockquote>
<p><a href="https://github.com/peterhuene/rfcs/blob/engine-host-functions/accepted/engine-host-functions.md">Rendered RFC</a></p>
<p>This RFC proposes to extend the Wasmtime API to allow users to define host<br>
functions at the <code>Engine</code>-level.</p>
<p>Today, <code>Func</code> is used to define host functions, but it is tied to a <code>Store</code>.<br>
If users desire short-lived stores to ensure short-lived instances, host<br>
functions need to be redefined upon every module instantiation.</p>
<p>By defining host functions at the <code>Engine</code>-level, instances can be created<br>
without having to redefine the host functions; this will make for faster module<br>
instantiations in scenarios where a module is repeatedly instantiated.</p>
</blockquote>



<a name="222118051"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222118051" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222118051">(Jan 08 2021 at 19:58)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/rfcs/pull/9#pullrequestreview-564541852">PR Review</a>.</p>



<a name="222118052"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222118052" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222118052">(Jan 08 2021 at 19:58)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/rfcs/pull/9#discussion_r554160530">PR Review Comment</a>:</p>
<blockquote>
<p>Oh I also think that this is going to need <code>Send</code> and <code>Sync</code> bounds to keep <code>Engine</code> both <code>Send</code> and <code>Sync</code> (and that'd also highlight that as an engine-global thing the function may get invoked concurrently)</p>
</blockquote>



<a name="222118086"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222118086" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222118086">(Jan 08 2021 at 19:58)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/rfcs/pull/9#pullrequestreview-564542103">PR Review</a>.</p>



<a name="222118087"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222118087" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222118087">(Jan 08 2021 at 19:58)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/rfcs/pull/9#discussion_r554160699">PR Review Comment</a>:</p>
<blockquote>
<p>Similar to above  this'll probably need <code>+ Send + Sync</code></p>
</blockquote>



<a name="222118421"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222118421" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222118421">(Jan 08 2021 at 20:01)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/rfcs/pull/9#pullrequestreview-564543974">PR Review</a>.</p>



<a name="222118422"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222118422" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222118422">(Jan 08 2021 at 20:01)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/rfcs/pull/9#discussion_r554162057">PR Review Comment</a>:</p>
<blockquote>
<p>Most definitely will. <em>shakes fist at Markdown not compiling his code</em></p>
</blockquote>



<a name="222119013"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222119013" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222119013">(Jan 08 2021 at 20:07)</a>:</h4>
<p>peterhuene updated <a href="https://github.com/bytecodealliance/rfcs/pull/9">PR #9</a> from <code>engine-host-functions</code> to <code>main</code>:</p>
<blockquote>
<p><a href="https://github.com/peterhuene/rfcs/blob/engine-host-functions/accepted/engine-host-functions.md">Rendered RFC</a></p>
<p>This RFC proposes to extend the Wasmtime API to allow users to define host<br>
functions at the <code>Engine</code>-level.</p>
<p>Today, <code>Func</code> is used to define host functions, but it is tied to a <code>Store</code>.<br>
If users desire short-lived stores to ensure short-lived instances, host<br>
functions need to be redefined upon every module instantiation.</p>
<p>By defining host functions at the <code>Engine</code>-level, instances can be created<br>
without having to redefine the host functions; this will make for faster module<br>
instantiations in scenarios where a module is repeatedly instantiated.</p>
</blockquote>



<a name="222119346"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222119346" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222119346">(Jan 08 2021 at 20:10)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/rfcs/pull/9#pullrequestreview-564549140">PR Review</a>.</p>



<a name="222119347"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222119347" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222119347">(Jan 08 2021 at 20:10)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/rfcs/pull/9#discussion_r554165818">PR Review Comment</a>:</p>
<blockquote>
<p>To be sure, I mean the <em>callee</em> vmctx arg, and not the <em>caller</em> one. The caller is indeed ambiguous and will ideally go away once interface types obviates exporting "memory". The callee, however, is pretty fundamental. Wasm functions need their instances.</p>
<p>The use case I'm thinking of is: an API which has some state associated with it. If two parts of an application each want to use that API, independently of the other, they should be able to have independent copies of the state. Ideally, we want host APIs to act as much like wasm APIs as possible, so that we can easily switch between host and polyfill implementations.</p>
<blockquote>
<p>That said, if we keep it on the Store, it's true that all instances using the Wasi host functions added at the engine-level will share the same WasiCxt context. But that still does not preclude users from being able to call Wasi::add_to_linker to link in WASI with a different context for a specific instantiation using the same store.</p>
</blockquote>
<p>It's good that you can do multiple contexts; what I'm asking is, should this be the default way of doing things, and perhaps even the only way? Right now, there's not a lot attached to the store, and the state that is there is well understood, which is a useful property when we think about suspending/resuming/checkpoint-restart/migration/etc. if instances.</p>
<p>Here's a potentially crazy idea: each imported function has a <code>VMCallerCheckedAnyfunc</code>, which includes a <code>*mut VMContext</code>. But after instantiation and linking are done, one instantace doesn't ever look at the <code>*mut VMContext</code> for another instance. It just just blindly passes the context argument when calling an import. So, what if we generalized this pointer, and said it's no longer just a <code>*mut VMContext</code>, but an arbitrary "context" state pointer? For wasm modules, it'd still be the same <code>VMContext</code> pointer, but for host modules, it could be a pointer into whatever type the host wanted? Then we wouldn't even have to figure out how to fit this into <code>Instance</code>.<br>
</p>
</blockquote>



<a name="222120465"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222120465" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222120465">(Jan 08 2021 at 20:20)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/rfcs/pull/9#pullrequestreview-564556502">PR Review</a>.</p>



<a name="222120466"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222120466" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222120466">(Jan 08 2021 at 20:20)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/rfcs/pull/9#discussion_r554171066">PR Review Comment</a>:</p>
<blockquote>
<p>Oh sorry I misunderstood about callee/caller. I'm curious though how you're thinking that the callee's state is initialized? For per-function state you can always simply capture state via the Rust closure, but the main problem with that is then the state is per-engine rather than per-instance/store. Where would per instance/store state get attached in what you're thinking @sunfishcode? (currently it's <code>set_context</code> for what this currently proposes I believe)</p>
</blockquote>



<a name="222144188"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222144188" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222144188">(Jan 09 2021 at 00:52)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/rfcs/pull/9#pullrequestreview-564665219">PR Review</a>.</p>



<a name="222144189"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/222144189" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#222144189">(Jan 09 2021 at 00:52)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/rfcs/pull/9#discussion_r554264317">PR Review Comment</a>:</p>
<blockquote>
<p>Ok yeah, that is tricky. I'll have to think about this some more.</p>
</blockquote>



<a name="224554011"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/224554011" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#224554011">(Jan 30 2021 at 00:23)</a>:</h4>
<p>peterhuene updated <a href="https://github.com/bytecodealliance/rfcs/pull/9">PR #9</a> from <code>engine-host-functions</code> to <code>main</code>:</p>
<blockquote>
<p><a href="https://github.com/peterhuene/rfcs/blob/engine-host-functions/accepted/engine-host-functions.md">Rendered RFC</a></p>
<p>This RFC proposes to extend the Wasmtime API to allow users to define host<br>
functions at the <code>Engine</code>-level.</p>
<p>Today, <code>Func</code> is used to define host functions, but it is tied to a <code>Store</code>.<br>
If users desire short-lived stores to ensure short-lived instances, host<br>
functions need to be redefined upon every module instantiation.</p>
<p>By defining host functions at the <code>Engine</code>-level, instances can be created<br>
without having to redefine the host functions; this will make for faster module<br>
instantiations in scenarios where a module is repeatedly instantiated.</p>
</blockquote>



<a name="224554061"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/224554061" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#224554061">(Jan 30 2021 at 00:24)</a>:</h4>
<p><strong>peterhuene</strong> has marked <a href="https://github.com/bytecodealliance/rfcs/pull/9">PR #9</a> as ready for review.</p>



<a name="224554106"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/224554106" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#224554106">(Jan 30 2021 at 00:25)</a>:</h4>
<p>peterhuene updated <a href="https://github.com/bytecodealliance/rfcs/pull/9">PR #9</a> from <code>engine-host-functions</code> to <code>main</code>:</p>
<blockquote>
<p><a href="https://github.com/peterhuene/rfcs/blob/engine-host-functions/accepted/engine-host-functions.md">Rendered RFC</a></p>
<p>This RFC proposes to extend the Wasmtime API to allow users to define host<br>
functions at the <code>Engine</code>-level.</p>
<p>Today, <code>Func</code> is used to define host functions, but it is tied to a <code>Store</code>.<br>
If users desire short-lived stores to ensure short-lived instances, host<br>
functions need to be redefined upon every module instantiation.</p>
<p>By defining host functions at the <code>Engine</code>-level, instances can be created<br>
without having to redefine the host functions; this will make for faster module<br>
instantiations in scenarios where a module is repeatedly instantiated.</p>
</blockquote>



<a name="224554340"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/224554340" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#224554340">(Jan 30 2021 at 00:28)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/rfcs/pull/9#pullrequestreview-579701195">PR Review</a>.</p>



<a name="224554341"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/224554341" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#224554341">(Jan 30 2021 at 00:28)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/rfcs/pull/9#discussion_r567163381">PR Review Comment</a>:</p>
<blockquote>
<p>@sunfishcode Do you have any suggestions as to an alternative approach? I'd like to resolve this prior to motion to finalize.</p>
</blockquote>



<a name="224954171"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/224954171" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#224954171">(Feb 02 2021 at 23:48)</a>:</h4>
<p>peterhuene updated <a href="https://github.com/bytecodealliance/rfcs/pull/9">PR #9</a> from <code>engine-host-functions</code> to <code>main</code>:</p>
<blockquote>
<p><a href="https://github.com/peterhuene/rfcs/blob/engine-host-functions/accepted/engine-host-functions.md">Rendered RFC</a></p>
<p>This RFC proposes to extend the Wasmtime API to allow users to define host<br>
functions at the <code>Engine</code>-level.</p>
<p>Today, <code>Func</code> is used to define host functions, but it is tied to a <code>Store</code>.<br>
If users desire short-lived stores to ensure short-lived instances, host<br>
functions need to be redefined upon every module instantiation.</p>
<p>By defining host functions at the <code>Engine</code>-level, instances can be created<br>
without having to redefine the host functions; this will make for faster module<br>
instantiations in scenarios where a module is repeatedly instantiated.</p>
</blockquote>



<a name="224954191"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%239%20RFC%20%28Wasmtime%29%3A%20add%20host%20functions%20at%20the%20%60E.../near/224954191" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.239.20RFC.20.28Wasmtime.29.3A.20add.20host.20functions.20at.20the.20.60E.2E.2E.2E.html#224954191">(Feb 02 2021 at 23:48)</a>:</h4>
<p>peterhuene edited <a href="https://github.com/bytecodealliance/rfcs/pull/9">PR #9</a> from <code>engine-host-functions</code> to <code>main</code>:</p>
<blockquote>
<p><a href="https://github.com/peterhuene/rfcs/blob/engine-host-functions/accepted/engine-host-functions.md">Rendered RFC</a></p>
<p>This RFC proposes to extend the Wasmtime API to allow users to define host<br>
functions in a <code>Config</code> that can be shared between multiple engines and<br>
therefore stores.</p>
<p>Today, <code>Func</code> is used to define host functions, but it is tied to a <code>Store</code>.<br>
If users desire short-lived stores to ensure short-lived instances, host<br>
functions need to be redefined upon every module instantiation.</p>
<p>By defining host functions with a <code>Config</code>, instances can be created<br>
without having to redefine the host functions; this will make for faster module<br>
instantiations in scenarios where a module is repeatedly instantiated.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>