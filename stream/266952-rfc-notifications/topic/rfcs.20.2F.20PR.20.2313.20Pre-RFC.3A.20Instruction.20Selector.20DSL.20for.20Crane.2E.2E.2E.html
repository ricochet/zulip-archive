<html>
<head><meta charset="utf-8"><title>rfcs / PR #13 Pre-RFC: Instruction Selector DSL for Crane... · rfc-notifications · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/index.html">rfc-notifications</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.2313.20Pre-RFC.3A.20Instruction.20Selector.20DSL.20for.20Crane.2E.2E.2E.html">rfcs / PR #13 Pre-RFC: Instruction Selector DSL for Crane...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="248533546"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%2313%20Pre-RFC%3A%20Instruction%20Selector%20DSL%20for%20Crane.../near/248533546" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.2313.20Pre-RFC.3A.20Instruction.20Selector.20DSL.20for.20Crane.2E.2E.2E.html#248533546">(Aug 05 2021 at 20:42)</a>:</h4>
<p>cfallin opened <a href="https://github.com/bytecodealliance/rfcs/pull/13">PR #13</a> from <code>cranelift-isel-pre-rfc</code> to <code>main</code>:</p>
<blockquote>
<p><a href="https://github.com/cfallin/rfcs/blob/cranelift-isel-pre-rfc/accepted/cranelift-isel-pre-rfc.md">Rendered</a></p>
<h1>Summary</h1>
<p>This pre-RFC aims to describe the case for developing or adopting a DSL to write instruction selection/lowering rules in Cranelift backends, and to introduce discussion points.</p>
<p>The goal is not (yet) to design a concrete DSL and start work. Rather, the goal here is to collect requirements, discuss different design choices and how they might work in our context, and generally to see what the community thinks about this and what folks might prefer.</p>
</blockquote>



<a name="248536254"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%2313%20Pre-RFC%3A%20Instruction%20Selector%20DSL%20for%20Crane.../near/248536254" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.2313.20Pre-RFC.3A.20Instruction.20Selector.20DSL.20for.20Crane.2E.2E.2E.html#248536254">(Aug 05 2021 at 21:03)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/rfcs/pull/13#pullrequestreview-723795891">PR review</a>.</p>



<a name="248536255"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%2313%20Pre-RFC%3A%20Instruction%20Selector%20DSL%20for%20Crane.../near/248536255" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.2313.20Pre-RFC.3A.20Instruction.20Selector.20DSL.20for.20Crane.2E.2E.2E.html#248536255">(Aug 05 2021 at 21:03)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/rfcs/pull/13#discussion_r683786100">PR review comment</a>:</p>
<blockquote>
<p>Removing <code>InstructionFormat</code> in favor of a big enum with a single variant for each instruction would already help with this even if there is no DSL by making it easy to match on said enum instead of the opcode, which allows binding the fields.</p>
</blockquote>



<a name="248537100"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%2313%20Pre-RFC%3A%20Instruction%20Selector%20DSL%20for%20Crane.../near/248537100" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.2313.20Pre-RFC.3A.20Instruction.20Selector.20DSL.20for.20Crane.2E.2E.2E.html#248537100">(Aug 05 2021 at 21:09)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/rfcs/pull/13">PR #13</a> from <code>cranelift-isel-pre-rfc</code> to <code>main</code>.</p>



<a name="248537249"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%2313%20Pre-RFC%3A%20Instruction%20Selector%20DSL%20for%20Crane.../near/248537249" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.2313.20Pre-RFC.3A.20Instruction.20Selector.20DSL.20for.20Crane.2E.2E.2E.html#248537249">(Aug 05 2021 at 21:10)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/rfcs/pull/13#pullrequestreview-723800732">PR review</a>.</p>



<a name="248537250"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%2313%20Pre-RFC%3A%20Instruction%20Selector%20DSL%20for%20Crane.../near/248537250" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.2313.20Pre-RFC.3A.20Instruction.20Selector.20DSL.20for.20Crane.2E.2E.2E.html#248537250">(Aug 05 2021 at 21:10)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/rfcs/pull/13#discussion_r683789859">PR review comment</a>:</p>
<blockquote>
<p>I think that even after the migration is complete it should be possible to write arbitrary code for the output generation, but not necessarily the input pattern matching. This would allow for complex output code to handle for example turning fixed divisions into multiplications or shifts while still preserving analyzability and optimizability of the patterns if desired.</p>
</blockquote>



<a name="248537363"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%2313%20Pre-RFC%3A%20Instruction%20Selector%20DSL%20for%20Crane.../near/248537363" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.2313.20Pre-RFC.3A.20Instruction.20Selector.20DSL.20for.20Crane.2E.2E.2E.html#248537363">(Aug 05 2021 at 21:11)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/rfcs/pull/13">PR #13</a> from <code>cranelift-isel-pre-rfc</code> to <code>main</code>.</p>



<a name="248539863"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%2313%20Pre-RFC%3A%20Instruction%20Selector%20DSL%20for%20Crane.../near/248539863" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.2313.20Pre-RFC.3A.20Instruction.20Selector.20DSL.20for.20Crane.2E.2E.2E.html#248539863">(Aug 05 2021 at 21:31)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/rfcs/pull/13#pullrequestreview-723813711">PR review</a>.</p>



<a name="248539864"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%2313%20Pre-RFC%3A%20Instruction%20Selector%20DSL%20for%20Crane.../near/248539864" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.2313.20Pre-RFC.3A.20Instruction.20Selector.20DSL.20for.20Crane.2E.2E.2E.html#248539864">(Aug 05 2021 at 21:31)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/rfcs/pull/13#pullrequestreview-723813711">PR review</a>.</p>



<a name="248539865"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%2313%20Pre-RFC%3A%20Instruction%20Selector%20DSL%20for%20Crane.../near/248539865" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.2313.20Pre-RFC.3A.20Instruction.20Selector.20DSL.20for.20Crane.2E.2E.2E.html#248539865">(Aug 05 2021 at 21:31)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/rfcs/pull/13#discussion_r683800193">PR review comment</a>:</p>
<blockquote>
<p>Related to verification efforts: I think we should call out superoptimization as something we would like to support for our isel. We should be able to do the superoptimization offline, based on CLIF patterns that we've harvested from real world programs, and then take the learned CLIF-&gt;vcode pairs and dump them into our new DSL. We should be able to effectively fold the preopt pass (and many more peepholes!) into isel lowering.</p>
<p>This would give us</p>
<ul>
<li>better compilation throughput because we have fewer passes over the clif,</li>
<li>correct by construction CLIF-&gt;vcode patterns, and</li>
<li>optimal (according to some cost function) code generation for these CLIF-&gt;vcode patterns.</li>
</ul>
</blockquote>



<a name="248553460"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%2313%20Pre-RFC%3A%20Instruction%20Selector%20DSL%20for%20Crane.../near/248553460" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.2313.20Pre-RFC.3A.20Instruction.20Selector.20DSL.20for.20Crane.2E.2E.2E.html#248553460">(Aug 06 2021 at 00:16)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/rfcs/pull/13#pullrequestreview-723888117">PR review</a>.</p>



<a name="248553461"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%2313%20Pre-RFC%3A%20Instruction%20Selector%20DSL%20for%20Crane.../near/248553461" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.2313.20Pre-RFC.3A.20Instruction.20Selector.20DSL.20for.20Crane.2E.2E.2E.html#248553461">(Aug 06 2021 at 00:16)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/rfcs/pull/13#discussion_r683863855">PR review comment</a>:</p>
<blockquote>
<p>That's a good point, for sure!</p>
<p>I would hope that the format in which we express our basic lowering patterns is general enough to support arbitrary superoptimizer-derived patterns (i.e., if this is not even technically possible then something is very wrong), so in practice it seems this boils down to, I think:</p>
<ol>
<li>We should have or build a translator/bridge from a superoptimizer format into the lowering DSL (like <code>peepmatic-souper</code>)</li>
<li>We should ensure that the whole infrastructure supports the "enormous pile of complex rules" case efficiently</li>
</ol>
</blockquote>



<a name="248553636"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%2313%20Pre-RFC%3A%20Instruction%20Selector%20DSL%20for%20Crane.../near/248553636" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.2313.20Pre-RFC.3A.20Instruction.20Selector.20DSL.20for.20Crane.2E.2E.2E.html#248553636">(Aug 06 2021 at 00:19)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/rfcs/pull/13#pullrequestreview-723888909">PR review</a>.</p>



<a name="248553637"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%2313%20Pre-RFC%3A%20Instruction%20Selector%20DSL%20for%20Crane.../near/248553637" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.2313.20Pre-RFC.3A.20Instruction.20Selector.20DSL.20for.20Crane.2E.2E.2E.html#248553637">(Aug 06 2021 at 00:19)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/rfcs/pull/13#discussion_r683864515">PR review comment</a>:</p>
<blockquote>
<p>Right, there are a number of cases where "little building block of arbitrary logic" is useful. Creation of immediate operands is another good example: aarch64 has a very interesting logical-immediate format that can support only some values, with a <a href="https://github.com/bytecodealliance/wasmtime/blob/bb85366a3bfab793de960b5be2b069760ab8a6df/cranelift/codegen/src/isa/aarch64/inst/imms.rs#L345-L535">complex algorithm</a> to derive it. We'd want to make that a "primitive" in some sense by calling out to the existing implementation.</p>
</blockquote>



<a name="248553961"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%2313%20Pre-RFC%3A%20Instruction%20Selector%20DSL%20for%20Crane.../near/248553961" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.2313.20Pre-RFC.3A.20Instruction.20Selector.20DSL.20for.20Crane.2E.2E.2E.html#248553961">(Aug 06 2021 at 00:24)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/rfcs/pull/13#pullrequestreview-723890465">PR review</a>.</p>



<a name="248553962"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%2313%20Pre-RFC%3A%20Instruction%20Selector%20DSL%20for%20Crane.../near/248553962" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.2313.20Pre-RFC.3A.20Instruction.20Selector.20DSL.20for.20Crane.2E.2E.2E.html#248553962">(Aug 06 2021 at 00:24)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/rfcs/pull/13#discussion_r683865960">PR review comment</a>:</p>
<blockquote>
<p>Possibly, but that's probably an orthogonal change to consider; or rather, it would make more sense to think about concrete quality-of-life refactors like this if we decide <em>not</em> to do a DSL, since whether to do a DSL is the high-order bit for developer experience.</p>
</blockquote>



<a name="248640858"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%2313%20Pre-RFC%3A%20Instruction%20Selector%20DSL%20for%20Crane.../near/248640858" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.2313.20Pre-RFC.3A.20Instruction.20Selector.20DSL.20for.20Crane.2E.2E.2E.html#248640858">(Aug 06 2021 at 17:18)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/rfcs/pull/13#pullrequestreview-724563479">PR review</a>.</p>



<a name="248640859"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%2313%20Pre-RFC%3A%20Instruction%20Selector%20DSL%20for%20Crane.../near/248640859" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.2313.20Pre-RFC.3A.20Instruction.20Selector.20DSL.20for.20Crane.2E.2E.2E.html#248640859">(Aug 06 2021 at 17:18)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/rfcs/pull/13#discussion_r684389757">PR review comment</a>:</p>
<blockquote>
<p>Exactly, well said :)</p>
</blockquote>



<a name="249944616"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/266952-rfc-notifications/topic/rfcs%20/%20PR%20%2313%20Pre-RFC%3A%20Instruction%20Selector%20DSL%20for%20Crane.../near/249944616" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RFC notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/266952-rfc-notifications/topic/rfcs.20.2F.20PR.20.2313.20Pre-RFC.3A.20Instruction.20Selector.20DSL.20for.20Crane.2E.2E.2E.html#249944616">(Aug 19 2021 at 05:51)</a>:</h4>
<p>cfallin closed without merge <a href="https://github.com/bytecodealliance/rfcs/pull/13">PR #13</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>