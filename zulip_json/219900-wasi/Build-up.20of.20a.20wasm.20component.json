[
    {
        "content": "<p>This discussion has already been initiated a few days ago, but sadly without good faith and proper respect. I hope I can reopen the same discussion but with proper respect as I also have the interest in better understanding the details of what makes a component tick.</p>\n<p>I've created the simplest WASM component module I was able to, which is:</p>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code><span class=\"p\">(</span><span class=\"err\">component</span>\n  <span class=\"p\">(</span><span class=\"err\">core</span> <span class=\"k\">module</span> <span class=\"nv\">$app-module</span>\n    <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"core-run\"</span><span class=\"p\">)</span> <span class=\"p\">(</span><span class=\"k\">result</span> <span class=\"kt\">i32</span><span class=\"p\">)</span>\n      <span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n    <span class=\"p\">)</span>\n  <span class=\"p\">)</span>\n  <span class=\"p\">(</span><span class=\"err\">core</span> <span class=\"err\">instance</span> <span class=\"nv\">$app-instance</span> <span class=\"p\">(</span><span class=\"err\">instantiate</span> <span class=\"nv\">$app-module</span><span class=\"p\">))</span>\n\n  <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"nv\">$lifted-run</span> <span class=\"p\">(</span><span class=\"k\">result</span> <span class=\"p\">(</span><span class=\"k\">result</span><span class=\"p\">))</span> <span class=\"p\">(</span><span class=\"err\">canon</span> <span class=\"err\">l</span><span class=\"nb\">if</span><span class=\"err\">t</span> <span class=\"p\">(</span><span class=\"err\">core</span> <span class=\"k\">func</span> <span class=\"nv\">$app-instance</span> <span class=\"s2\">\"core-run\"</span><span class=\"p\">)))</span>\n\n  <span class=\"p\">(</span><span class=\"err\">component</span> <span class=\"nv\">$wrapper</span>\n    <span class=\"p\">(</span><span class=\"k\">import</span> <span class=\"s2\">\"imported-run\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"nv\">$wrapper-run</span> <span class=\"p\">(</span><span class=\"k\">result</span> <span class=\"p\">(</span><span class=\"k\">result</span><span class=\"p\">))))</span>\n    <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"run\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"nv\">$wrapper-run</span><span class=\"p\">))</span>\n  <span class=\"p\">)</span>\n  <span class=\"p\">(</span><span class=\"err\">instance</span> <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"wasi:cli/run@0.2.0\"</span><span class=\"p\">)</span> <span class=\"p\">(</span><span class=\"err\">instantiate</span> <span class=\"nv\">$wrapper</span>\n    <span class=\"p\">(</span><span class=\"err\">with</span> <span class=\"s2\">\"imported-run\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"nv\">$lifted-run</span><span class=\"p\">))</span>\n  <span class=\"p\">))</span>\n<span class=\"p\">)</span>\n</code></pre></div>\n<p>I hope you could help me with my understanding of the above code.</p>\n<ul>\n<li>The <code>core module</code> describes a traditional WASM module as they exist outside of WASM components.</li>\n<li><code>core instance</code> describes an instance of this core module in the context of this component.</li>\n<li><code>canon lift</code> maps a core func to a component func, in this case from low level wasm return type <code>i32</code> to component wit return type <code>result</code>.</li>\n</ul>\n<p>Then the next two I have a harder time understanding. The <code>component</code> and the <code>instance</code>.<br>\nFor this component to correctly export the <code>wasi:cli/run@0.2.0</code> world, it needs to export an instance.<br>\nAnd to create an instance I need a component definition, which for a <code>wasi:cli/run@0.2.0</code> component only needs to export <code>run: func() -&gt; result</code>.</p>\n<p>But to get the lifted <code>run</code> function out as the expected <code>wasi:cli/run@0.2.0</code> <code>run</code> function I have to do the mapping I do in the component definition and in the instantiation binding? Is this correct? Or is there a simpler way to get the lifted <code>run</code> out as the <code>wasi:cli/run@0.2.0</code> expected <code>run</code>?</p>\n<p>In the case of a <code>wasi:cli/run@0.2.0</code> component do I always need to have a <code>component</code> definition and a <code>instance</code> definition as in my example?</p>",
        "id": 470534222,
        "sender_full_name": "Dax Huiberts",
        "timestamp": 1726480899
    },
    {
        "content": "<p>Your explanation for why the component and instance are needed seems right to me â€” targeting <code>wasi:cli/run@0.2.0</code> means exporting a component instance, hence why you declare an inner component exporting a <code>run</code> then an outer component which exports an instance of the inner one under the <code>run@0.2.0</code> name.<br>\nIf it strikes you as simpler, you may be able to move everything before <code>$wrapper</code> (the core module, the core instance and the component function)  into <code>$wrapper</code>, to avoid needing the function import. That would also allow you to directly export the component function inside its declaration.</p>",
        "id": 470544948,
        "sender_full_name": "IFcoltransG",
        "timestamp": 1726482841
    },
    {
        "content": "<p>the drawback of moving everything into $wrapper is that if you wanna import anything... well, imported component instances are typed, and types aren't shared between components as far as we know, so you'd need to declare them twice: once to import into the outer component, and once again to import into $wrapper</p>",
        "id": 470569864,
        "sender_full_name": "Soni L.",
        "timestamp": 1726487580
    },
    {
        "content": "<p>(and these get a lot more verbose than the run function)</p>",
        "id": 470570402,
        "sender_full_name": "Soni L.",
        "timestamp": 1726487665
    },
    {
        "content": "<p>arguably the real problem is that the WASI <code>command</code> world exports a WASI <code>run</code> interface instead of a plain <code>run</code> function... but anyway</p>",
        "id": 470571209,
        "sender_full_name": "Soni L.",
        "timestamp": 1726487794
    },
    {
        "content": "<p>The instance export here is required by <code>wasi:cli/run@0.2.0</code> indeed, but instantiating a component is not the only way of creating a component instance in the component model. There's also the ability to create a component instance from a \"bag of exports\" where you basically bundled up items within a component as named exports, creating an instance which can itself then be exported. For example another way of creating the above component would look like this:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">(</span><span class=\"n\">component</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"cp\">$app</span><span class=\"o\">-</span><span class=\"n\">module</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"s\">\"core-run\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">)</span>\n<span class=\"w\">      </span><span class=\"kt\">i32</span><span class=\"p\">.</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"cp\">$app</span><span class=\"o\">-</span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">instantiate</span><span class=\"w\"> </span><span class=\"cp\">$app</span><span class=\"o\">-</span><span class=\"n\">module</span><span class=\"p\">))</span>\n\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$lifted</span><span class=\"o\">-</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">canon</span><span class=\"w\"> </span><span class=\"n\">lift</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$app</span><span class=\"o\">-</span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"s\">\"core-run\"</span><span class=\"p\">)))</span>\n\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"cp\">$wrapper</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"s\">\"run\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$lifted</span><span class=\"o\">-</span><span class=\"n\">run</span><span class=\"p\">)))</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"s\">\"wasi:cli/run@0.2.0\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"cp\">$wrapper</span><span class=\"p\">))</span>\n<span class=\"p\">)</span>\n</code></pre></div>\n<p>This is probably simpler and more along the lines of what you might expect for \"hello world\" style use cases. The component you pasted and this one here are basically equivalent and are different ways to have the same structure. Within Wasmtime they end up compiling to basically the same result too (and the same in jco I believe).</p>\n<p>So that might raise the question: why bother having the <code>component $wrapper</code> in the first place? The reason for that is subtle unfortunately and has to do with resources in the component model. Resources are \"more advanced\" sort of in the sense of how all the typing rules work.  The <code>wasm-tool component new</code> command used to use <code>(instance (export \"...\" ...))</code> syntactical form and only switch to using nested components when resources were introduced. The precise reason for this has to do with validation of resources and how typing them in the component model works which is probably out of scope of this discussion.</p>\n<p>Regardless it's definitely possible to omit <code>component $wrapper</code>, but for <code>wasm-tools component new</code> it's easier to have one path that always emits a component. There's no runtime overhead associated with it and so far there hasn't been motivation to otherwise change it. Implementing such an optimization would be reasonable, however.</p>\n<p>If that leaves any lingering questions though or doesn't answer anything please let me know!</p>",
        "id": 470639823,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1726499039
    },
    {
        "content": "<p>Thank you IFcoltransG and Alex Crichton both for the clear explanations. This really helps solidify a better understanding of the building blocks of a component model module. Using the <code>(instance (export ...))</code> approach gives a simpler/easier understanding of the bare essentials and helps me build up on that.</p>",
        "id": 470943288,
        "sender_full_name": "Dax Huiberts",
        "timestamp": 1726570067
    },
    {
        "content": "<p>component model is a cursed typed scripting language for wasm modules, basically it's just RPC. it also doesn't align with how wasm engines actually work (most wasm engines aren't as strictly typed as CM is) so there's a huge impedance mismatch for implementers (thankfully components are self-contained, there are no type imports or generics or anything you need to explicitly declare, in excruciating detail, every aspect of the types you wanna use, so you can just do type checking as part of validation)</p>",
        "id": 471027729,
        "sender_full_name": "Soni L.",
        "timestamp": 1726589304
    },
    {
        "content": "<p>That might be a topic for a different thread.</p>",
        "id": 471085725,
        "sender_full_name": "IFcoltransG",
        "timestamp": 1726604725
    },
    {
        "content": "<p>With this new knowledge I've been able to strip down a version of rust \"hello world\" to the following which is as simple as I could get it. </p>\n<p>Is this as simple as this could get? Or are there some more reductions possible?</p>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code><span class=\"p\">(</span><span class=\"err\">component</span>\n  <span class=\"p\">(</span><span class=\"err\">instance</span> <span class=\"nv\">$error</span> <span class=\"p\">(</span><span class=\"k\">import</span> <span class=\"s2\">\"wasi:io/error@0.2.0\"</span><span class=\"p\">)</span>\n    <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"error\"</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"p\">(</span><span class=\"err\">sub</span> <span class=\"err\">resource</span><span class=\"p\">)))</span>\n  <span class=\"p\">)</span>\n  <span class=\"p\">(</span><span class=\"err\">alias</span> <span class=\"k\">export</span> <span class=\"nv\">$error</span> <span class=\"s2\">\"error\"</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$error</span><span class=\"p\">))</span>\n\n  <span class=\"p\">(</span><span class=\"err\">instance</span> <span class=\"nv\">$streams</span> <span class=\"p\">(</span><span class=\"k\">import</span> <span class=\"s2\">\"wasi:io/streams@0.2.0\"</span><span class=\"p\">)</span>\n    <span class=\"p\">(</span><span class=\"err\">alias</span> <span class=\"err\">outer</span> <span class=\"mi\">1</span> <span class=\"nv\">$error</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$error-alias</span><span class=\"p\">))</span>\n    <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"nv\">$output-stream</span> <span class=\"s2\">\"output-stream\"</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"p\">(</span><span class=\"err\">sub</span> <span class=\"err\">resource</span><span class=\"p\">)))</span>\n    <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"nv\">$error</span> <span class=\"s2\">\"error\"</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"p\">(</span><span class=\"err\">eq</span> <span class=\"nv\">$error-alias</span><span class=\"p\">)))</span>\n    <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$variant</span> <span class=\"p\">(</span><span class=\"err\">variant</span> <span class=\"p\">(</span><span class=\"err\">case</span> <span class=\"s2\">\"last-operation-failed\"</span> <span class=\"p\">(</span><span class=\"err\">own</span> <span class=\"nv\">$error</span><span class=\"p\">))</span> <span class=\"p\">(</span><span class=\"err\">case</span> <span class=\"s2\">\"closed\"</span><span class=\"p\">)))</span>\n    <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"nv\">$stream-error</span> <span class=\"s2\">\"stream-error\"</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"p\">(</span><span class=\"err\">eq</span> <span class=\"nv\">$variant</span><span class=\"p\">)))</span>\n    <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"[method]output-stream.blocking-write-and-flush\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">param</span> <span class=\"s2\">\"self\"</span> <span class=\"p\">(</span><span class=\"err\">borrow</span> <span class=\"nv\">$output-stream</span><span class=\"p\">))</span> <span class=\"p\">(</span><span class=\"k\">param</span> <span class=\"s2\">\"contents\"</span> <span class=\"p\">(</span><span class=\"err\">list</span> <span class=\"err\">u</span><span class=\"mi\">8</span><span class=\"p\">))</span> <span class=\"p\">(</span><span class=\"k\">result</span> <span class=\"p\">(</span><span class=\"k\">result</span> <span class=\"p\">(</span><span class=\"err\">error</span> <span class=\"nv\">$stream-error</span><span class=\"p\">)))))</span>\n  <span class=\"p\">)</span>\n  <span class=\"p\">(</span><span class=\"err\">alias</span> <span class=\"k\">export</span> <span class=\"nv\">$streams</span> <span class=\"s2\">\"output-stream\"</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$output-stream</span><span class=\"p\">))</span>\n\n  <span class=\"p\">(</span><span class=\"err\">instance</span> <span class=\"nv\">$stdout</span> <span class=\"p\">(</span><span class=\"k\">import</span> <span class=\"s2\">\"wasi:cli/stdout@0.2.0\"</span><span class=\"p\">)</span>\n    <span class=\"p\">(</span><span class=\"err\">alias</span> <span class=\"err\">outer</span> <span class=\"mi\">1</span> <span class=\"nv\">$output-stream</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$output-stream-alias</span><span class=\"p\">))</span>\n    <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"nv\">$output-stream</span> <span class=\"s2\">\"output-stream\"</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"p\">(</span><span class=\"err\">eq</span> <span class=\"nv\">$output-stream-alias</span><span class=\"p\">)))</span>\n    <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"get-stdout\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">result</span> <span class=\"p\">(</span><span class=\"err\">own</span> <span class=\"nv\">$output-stream</span><span class=\"p\">))))</span>\n  <span class=\"p\">)</span>\n\n  <span class=\"p\">(</span><span class=\"err\">core</span> <span class=\"k\">module</span> <span class=\"nv\">$memory</span>\n    <span class=\"p\">(</span><span class=\"k\">memory</span> <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"memory\"</span><span class=\"p\">)</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n  <span class=\"p\">)</span>\n  <span class=\"p\">(</span><span class=\"err\">core</span> <span class=\"err\">instance</span> <span class=\"nv\">$memory</span> <span class=\"p\">(</span><span class=\"err\">instantiate</span> <span class=\"nv\">$memory</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"err\">alias</span> <span class=\"err\">core</span> <span class=\"k\">export</span> <span class=\"nv\">$memory</span> <span class=\"s2\">\"memory\"</span> <span class=\"p\">(</span><span class=\"err\">core</span> <span class=\"k\">memory</span> <span class=\"nv\">$memory</span><span class=\"p\">))</span>\n\n  <span class=\"p\">(</span><span class=\"err\">core</span> <span class=\"k\">func</span> <span class=\"nv\">$stdout</span> <span class=\"p\">(</span><span class=\"err\">canon</span> <span class=\"err\">lower</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"nv\">$stdout</span> <span class=\"s2\">\"get-stdout\"</span><span class=\"p\">)))</span>\n  <span class=\"p\">(</span><span class=\"err\">core</span> <span class=\"k\">func</span> <span class=\"nv\">$write</span> <span class=\"p\">(</span><span class=\"err\">canon</span> <span class=\"err\">lower</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"nv\">$streams</span> <span class=\"s2\">\"[method]output-stream.blocking-write-and-flush\"</span><span class=\"p\">)</span> <span class=\"p\">(</span><span class=\"k\">memory</span> <span class=\"nv\">$memory</span><span class=\"p\">)))</span>\n\n  <span class=\"p\">(</span><span class=\"err\">core</span> <span class=\"k\">module</span> <span class=\"nv\">$app</span>\n    <span class=\"p\">(</span><span class=\"k\">memory</span> <span class=\"p\">(</span><span class=\"k\">import</span> <span class=\"s2\">\"memory\"</span> <span class=\"s2\">\"memory\"</span><span class=\"p\">)</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n    <span class=\"p\">(</span><span class=\"k\">data</span> <span class=\"p\">(</span><span class=\"nb\">i32.const</span> <span class=\"mi\">4</span><span class=\"p\">)</span> <span class=\"s2\">\"Hello world!</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"p\">)</span>\n    <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"nv\">$stdout</span> <span class=\"p\">(</span><span class=\"k\">import</span> <span class=\"s2\">\"wasi\"</span> <span class=\"s2\">\"stdout\"</span><span class=\"p\">)</span> <span class=\"p\">(</span><span class=\"k\">result</span> <span class=\"kt\">i32</span><span class=\"p\">))</span>\n    <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"nv\">$write</span> <span class=\"p\">(</span><span class=\"k\">import</span> <span class=\"s2\">\"wasi\"</span> <span class=\"s2\">\"write\"</span><span class=\"p\">)</span> <span class=\"p\">(</span><span class=\"k\">param</span> <span class=\"kt\">i32</span> <span class=\"kt\">i32</span> <span class=\"kt\">i32</span> <span class=\"kt\">i32</span><span class=\"p\">))</span>\n    <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"main\"</span><span class=\"p\">)</span> <span class=\"p\">(</span><span class=\"k\">result</span> <span class=\"kt\">i32</span><span class=\"p\">)</span>\n      <span class=\"p\">(</span><span class=\"nb\">call</span> <span class=\"nv\">$write</span>\n        <span class=\"nb\">call</span> <span class=\"nv\">$stdout</span> <span class=\"c1\">;; puts stdout handle on stack</span>\n        <span class=\"nb\">i32.const</span> <span class=\"mi\">4</span> <span class=\"c1\">;; memory address of string</span>\n        <span class=\"nb\">i32.const</span> <span class=\"mi\">13</span> <span class=\"c1\">;; length of string</span>\n        <span class=\"nb\">i32.const</span> <span class=\"mi\">0</span> <span class=\"c1\">;; memory address to where return value should be placed</span>\n      <span class=\"p\">)</span>\n      <span class=\"p\">(</span><span class=\"nb\">i32.load</span> <span class=\"p\">(</span><span class=\"nb\">i32.const</span> <span class=\"mi\">0</span><span class=\"p\">))</span> <span class=\"c1\">;; gets the result enum type at return address 0, 0 = success, 1 = error</span>\n    <span class=\"p\">)</span>\n  <span class=\"p\">)</span>\n\n  <span class=\"p\">(</span><span class=\"err\">core</span> <span class=\"err\">instance</span> <span class=\"nv\">$app</span> <span class=\"p\">(</span><span class=\"err\">instantiate</span> <span class=\"nv\">$app</span>\n    <span class=\"p\">(</span><span class=\"err\">with</span> <span class=\"s2\">\"wasi\"</span> <span class=\"p\">(</span><span class=\"err\">instance</span>\n      <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"stdout\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"nv\">$stdout</span><span class=\"p\">))</span>\n      <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"write\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"nv\">$write</span><span class=\"p\">))</span>\n    <span class=\"p\">))</span>\n    <span class=\"p\">(</span><span class=\"err\">with</span> <span class=\"s2\">\"memory\"</span> <span class=\"p\">(</span><span class=\"err\">instance</span> <span class=\"nv\">$memory</span><span class=\"p\">))</span>\n  <span class=\"p\">))</span>\n\n  <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"nv\">$main</span> <span class=\"p\">(</span><span class=\"k\">result</span> <span class=\"p\">(</span><span class=\"k\">result</span><span class=\"p\">))</span> <span class=\"p\">(</span><span class=\"err\">canon</span> <span class=\"err\">l</span><span class=\"nb\">if</span><span class=\"err\">t</span> <span class=\"p\">(</span><span class=\"err\">core</span> <span class=\"k\">func</span> <span class=\"nv\">$app</span> <span class=\"s2\">\"main\"</span><span class=\"p\">)))</span>\n\n  <span class=\"p\">(</span><span class=\"err\">instance</span> <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"wasi:cli/run@0.2.0\"</span><span class=\"p\">)</span>\n    <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"run\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"nv\">$main</span><span class=\"p\">))</span>\n  <span class=\"p\">)</span>\n<span class=\"p\">)</span>\n</code></pre></div>",
        "id": 471230592,
        "sender_full_name": "Dax Huiberts",
        "timestamp": 1726657265
    },
    {
        "content": "<p>To add to my last message some more specific questions:</p>\n<p>Especially the parts with the imports I'm not sure if they can be simplified further. Are the alias exports the only way to reference the types in the other imports.</p>\n<p>Is the <code>wasi:io/error@0.2.0</code> import mandatory because of the need of the error resource?</p>\n<p>Is the need to split the core module so I can first instantiate the memory, which is needed by the lowering definitions, which can then be used in the actual core module?</p>",
        "id": 471232733,
        "sender_full_name": "Dax Huiberts",
        "timestamp": 1726658000
    },
    {
        "content": "<p>Yeah that's a pretty minimal module and I'm not sure how to make it significantly smaller. You could use some text format shorthands perhaps such as omitting <code>(alias outer ...)</code> and just using the outer name (which is automatically turned into an alias), but beyond that you've got most bits.</p>\n<blockquote>\n<p>Are the alias exports the only way to reference the types in the other imports.</p>\n</blockquote>\n<p>Yes</p>\n<blockquote>\n<p>Is the <code>wasi:io/error@0.2.0</code> import mandatory because of the need of the error resource?</p>\n</blockquote>\n<p>Yes</p>\n<blockquote>\n<p>Is the need to split the core module so I can first instantiate the memory, which is needed by the lowering definitions, which can then be used in the actual core module?</p>\n</blockquote>\n<p>There's more than one way to go about this, for example components produced from Rust/C/etc typically don't do this split since they're exporting memory from the main module. What you've done here though works just fine and is defnitely a way to resolve the problem of \"<code>canon lower</code> needs access to a memory to lower into\"</p>",
        "id": 471279341,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1726671312
    },
    {
        "content": "<p>This was very illuminating for me to read, thanks <span class=\"user-mention\" data-user-id=\"756024\">@Dax Huiberts</span> !</p>\n<p>Does this warrant including in the docs somewhere? An annotated/commented version of this might be a fantastic introduction to understanding component WAT, and do the heavy lifting in explaining many concepts of the enhancements made possible by the CM</p>",
        "id": 473922947,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1727751762
    }
]