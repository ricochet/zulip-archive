[
    {
        "content": "<p>hey there, I am wondering if there are any progress on preview2 support in wasi-libc? Related issue: <a href=\"https://github.com/WebAssembly/wasi-libc/issues/430\">https://github.com/WebAssembly/wasi-libc/issues/430</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-libc/issues/430\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/dd3c2bb316b04f4f0067012d3299ca68f58c85e5\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f633137343863353634373839396637386361303962323565333464663062333435393363343535636436363432333339626437363666396330313265363735622f576562417373656d626c792f776173692d6c6962632f6973737565732f343330)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-libc/issues/430\" title=\"Is there any plan about supporting WASI preview2? · Issue #430 · WebAssembly/wasi-libc\">Is there any plan about supporting WASI preview2? · Issue #430 · WebAssembly/wasi-libc</a></div><div class=\"message_embed_description\">Seems WASI is going to upgrade to preview2.</div></div></div>",
        "id": 400799085,
        "sender_full_name": "Mossaka (Joe)",
        "timestamp": 1699383475
    },
    {
        "content": "<p>Out of curiosity, is that blocking something you're working on or planning to work on?  I.e. is there some Preview 2 feature that you can't use ergonomically with the existing wasi-libc + adapter approach?  If the answer is \"network sockets\", I'm planning to start working on that soon-ish.  If the answer is something else, I'd be interested to know.</p>",
        "id": 400800813,
        "sender_full_name": "Joel Dice",
        "timestamp": 1699384068
    },
    {
        "content": "<p>We were disucssing wasi-libc preview2 support in today's Go subgroup meeting and this idea came out when we were thinking whether TinyGo preview2 support needs to rely on wasi-libc or not. Currently we don't have a firm answer on that, but we are leaning towards no wasi-libc dependency. </p>\n<blockquote>\n<p>is that blocking something you're working on or planning to work on? </p>\n</blockquote>\n<p>No, the existing wasi-libc and adapter approach would totally work. </p>\n<p>There are still advantages on preview2 support in wasi-libc though. One of them is that we hypothethized that it will reduce the component size by removing the adapter in the component.</p>",
        "id": 400808841,
        "sender_full_name": "Mossaka (Joe)",
        "timestamp": 1699387625
    },
    {
        "content": "<p>I was able to modify the adapter to directly link with my code, creating a preview2 native module from c++ sources. I will try to upload the necessary changes to a public github over the weekend so that you can take a look.</p>",
        "id": 401345539,
        "sender_full_name": "Christof Petig",
        "timestamp": 1699613841
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"590366\">Christof Petig</span> <a href=\"#narrow/stream/219900-wasi/topic/wasi-libc.20preview2.20status.3F/near/401345539\">said</a>:</p>\n<blockquote>\n<p>I was able to modify the adapter to directly link with my code, creating a preview2 native module from c++ sources. I will try to upload the necessary changes to a public github over the weekend so that you can take a look.</p>\n</blockquote>\n<p>I uploaded a less intrusive version of the patch to <a href=\"https://github.com/cpetig/wasmtime-adapter\">https://github.com/cpetig/wasmtime-adapter</a> - but so far I was unable to test it, because wasmtime doesn't yet implement all of the preview2 interfaces used by the adapter. I will give it another try with jco, but that will take time.</p>\n<p>Ideally this adapter would consist of multiple (object) files, so that only used interfaces are required. wasm-opt (binaryen) can reduce unused dependencies for now.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/cpetig/wasmtime-adapter\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/bae23093cb8f89bdbc5e888759a065dbdaf277e5\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f326566323639373439663231343133303462646562396663646338346335396461326261663137643336323361386635393537666663616633306335343738612f6370657469672f7761736d74696d652d61646170746572)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/cpetig/wasmtime-adapter\" title=\"GitHub - cpetig/wasmtime-adapter: Preview2 adapter forked from wasmtime\">GitHub - cpetig/wasmtime-adapter: Preview2 adapter forked from wasmtime</a></div><div class=\"message_embed_description\">Preview2 adapter forked from wasmtime. Contribute to cpetig/wasmtime-adapter development by creating an account on GitHub.</div></div></div>",
        "id": 401612667,
        "sender_full_name": "Christof Petig",
        "timestamp": 1699794715
    },
    {
        "content": "<blockquote>\n<p>because wasmtime doesn't yet implement all of the preview2 interfaces used by the adapter. </p>\n</blockquote>\n<p>not sure what this means - wasmtime-wasi does have an implementation of all the interfaces used by the adapter, maybe you need to add them to your linker? or is there some other unresolved symbols related to your build?</p>",
        "id": 401810069,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1699894951
    },
    {
        "content": "<p>The resulting binary is importing filesystem preopens and terminal input/output streams which I didn't see in the Wasi implementations of wasmtime, so I assumed that they are yet to be implemented. I can take a closer look and send the exact interface names later.</p>",
        "id": 401857484,
        "sender_full_name": "Christof Petig",
        "timestamp": 1699915334
    },
    {
        "content": "<p><a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-preview1-component-adapter/src/descriptors.rs#L184\">https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-preview1-component-adapter/src/descriptors.rs#L184</a> refers to preopens, but I don't see that in <a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi/src/preview2/mod.rs#L83\">https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi/src/preview2/mod.rs#L83</a></p>",
        "id": 401858116,
        "sender_full_name": "Christof Petig",
        "timestamp": 1699915697
    },
    {
        "content": "<p>The host implementation of <code>wasi:filesystem/preopens@0.2.0-rc-2023-11-05#get-directories</code> is here: <a href=\"https://github.com/bytecodealliance/wasmtime/blob/24d945f3e34e3c24e0160850bb3f668c0eeabec4/crates/wasi/src/preview2/host/filesystem.rs#L15-L29\">https://github.com/bytecodealliance/wasmtime/blob/24d945f3e34e3c24e0160850bb3f668c0eeabec4/crates/wasi/src/preview2/host/filesystem.rs#L15-L29</a></p>",
        "id": 401858498,
        "sender_full_name": "Joel Dice",
        "timestamp": 1699915894
    },
    {
        "content": "<p>Thank you, but I couldn't find the registration of the implementation under that name, so I assumed it would be missing <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 401859450,
        "sender_full_name": "Christof Petig",
        "timestamp": 1699916406
    },
    {
        "content": "<p><code>wasmtime-wit-bindgen</code> generates the code that does the registration.  Specifically, it will generate an <code>add_to_linker</code> function which adds all the host functions and types to the <code>wasmtime::component::Linker</code>, thereby making them available to any guests instantiated using that <code>Linker</code>.  In this case, <code>wasmtime_wasi::preview2::command::add_to_linker</code> should provide the <code>wasi:filesystem/preopens@0.2.0-rc-2023-11-05#get-directories</code> function along with everything else the adapter might need.</p>",
        "id": 401861745,
        "sender_full_name": "Joel Dice",
        "timestamp": 1699917648
    },
    {
        "content": "<p>That makes sense, I will take a closer look to why wasmtime -S preview2 mybinary.wasm complains about the preopens missing.</p>",
        "id": 401963519,
        "sender_full_name": "Christof Petig",
        "timestamp": 1699960363
    },
    {
        "content": "<p>Do make sure the version of <code>wasmtime</code> you're using matches the adapter (i.e. if you're using and adapter that targets WASI 0.2.0-rc-2023-10-18, you'll want Wasmtime 14.0.x).  Note that 0.2.0-rc-2023-11-05 is particularly tricky since there is a range of commits in the wasmtime repo that use that version such that the WIT files changed over time in incompatible ways.  Your best bet is to build the adapter and <code>wasmtime</code> command from the exact same commit.</p>",
        "id": 402031997,
        "sender_full_name": "Joel Dice",
        "timestamp": 1699982055
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"509936\">Joel Dice</span> <a href=\"#narrow/stream/219900-wasi/topic/wasi-libc.20preview2.20status.3F/near/400800813\">said</a>:</p>\n<blockquote>\n<p>Out of curiosity, is that blocking something you're working on or planning to work on?  I.e. is there some Preview 2 feature that you can't use ergonomically with the existing wasi-libc + adapter approach?  If the answer is \"network sockets\", I'm planning to start working on that soon-ish.  If the answer is something else, I'd be interested to know.</p>\n</blockquote>\n<p>We're a wish to move socket based WAMR applications to Wasmtime and get them to work without modification. So, it's wasi-preview-1 + WAMR sockets, running on wasi-preview-2 + some sort of adapter.</p>",
        "id": 402314948,
        "sender_full_name": "Chris Woods",
        "timestamp": 1700077307
    },
    {
        "content": "<p>Of course, since there was no socket standard for preview-1, we've portability issues moving forward. (yay!).</p>",
        "id": 402315144,
        "sender_full_name": "Chris Woods",
        "timestamp": 1700077383
    },
    {
        "content": "<p>Thanks a lot to Joel and Pat for insisting that wasmtime supports all necessary preview2 symbols, I just found out that once I create a component out of my module it works (with -Wcomponent-model -Spreview2) - of course, because the resulting module targets already preview2, no adapter is needed.<br>\nAlso I just uploaded the successfully tested static adapter libraries as releases <a href=\"https://github.com/cpetig/wasmtime-adapter/releases/tag/2023-11-15\">https://github.com/cpetig/wasmtime-adapter/releases/tag/2023-11-15</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/cpetig/wasmtime-adapter/releases/tag/2023-11-15\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/048df0ec475d150a4d7851ce92d47647af17190c\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f306137336338323339386565616634646231643130616336663333306337656538663437383862313362616638316533393738393930383831353030373636372f6370657469672f7761736d74696d652d616461707465722f72656c65617365732f7461672f323032332d31312d3135)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/cpetig/wasmtime-adapter/releases/tag/2023-11-15\" title=\"Release Initial binary release · cpetig/wasmtime-adapter\">Release Initial binary release · cpetig/wasmtime-adapter</a></div><div class=\"message_embed_description\">Preview2 adapter forked from wasmtime. Contribute to cpetig/wasmtime-adapter development by creating an account on GitHub.</div></div></div>",
        "id": 402319696,
        "sender_full_name": "Christof Petig",
        "timestamp": 1700079146
    },
    {
        "content": "<blockquote>\n<p>If the answer is \"network sockets\", I'm planning to start working on that soon-ish.</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"509936\">@Joel Dice</span>, let me know if there's anything I can do to help.</p>",
        "id": 402324341,
        "sender_full_name": "Dave Bakker (badeend)",
        "timestamp": 1700081038
    },
    {
        "content": "<p>Thanks.  I was hoping to start this week, but got busy with other things, so it will probably be next week.</p>",
        "id": 402324527,
        "sender_full_name": "Joel Dice",
        "timestamp": 1700081115
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"590366\">Christof Petig</span> <a href=\"#narrow/stream/219900-wasi/topic/wasi-libc.20preview2.20status.3F/near/402319696\">said</a>:</p>\n<blockquote>\n<p>Also I just uploaded the successfully tested static adapter libraries as releases </p>\n</blockquote>",
        "id": 402325720,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1700081594
    },
    {
        "content": "<p>er sorry hit enter too soon, but Christof if you're interested I think that'd be neat to add to Wasmtime's CI and get releases for each version of Wasmtime as well</p>",
        "id": 402325757,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1700081616
    },
    {
        "content": "<p>e.g. having a new build mode of the adapter which produces a <code>*.a</code> instead of a <code>*.wasm</code></p>",
        "id": 402325787,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1700081629
    },
    {
        "content": "<p>Well, it clearly solves a problem for me (wanting to combine wamr with WIT), but the solution doesn't feel clean enough to me, yet. <br>\nIdeally you would have a feature selecting between the modes to build both variants from the same source code, and you probably want to cut the single adapter object file into one per feature or interface - although link time optimization seems to remove all the unused preview1 implementations quite well.<br>\nI would like to receive some feed back from users before going this step.</p>",
        "id": 402332476,
        "sender_full_name": "Christof Petig",
        "timestamp": 1700084355
    },
    {
        "content": "<p>ok makes sense, but the design of a standalone <code>*.wasm</code> was primarily intended to ease the transition into preview2, and having alternative stepping stones I think is useful too</p>",
        "id": 402333930,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1700084963
    },
    {
        "content": "<p>Couple of updates on <code>wasi-libc</code> support for Preview 2 (including <code>wasi-sockets</code>):</p>\n<ul>\n<li>I've opened <a href=\"https://github.com/WebAssembly/wasi-libc/issues/447\">https://github.com/WebAssembly/wasi-libc/issues/447</a> with a proposal, which has already generated good discussion</li>\n<li>I've started doing some prototyping in <a href=\"https://github.com/dicej/wasi-sockets-tests\">https://github.com/dicej/wasi-sockets-tests</a> and forks of <code>wasi-libc</code>, Rust <code>std</code>, <code>mio</code> and <code>tokio</code>.  At this point, you can make outbound IPv4 or IPv6 TCP connections in C or Rust, synchronously or asynchronously.</li>\n</ul>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-libc/issues/447\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/ee077c0dc1a848775223a67bbd650d6c412a85ba\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f316638313238333032653062356364353163626262323365613334376361353634613562373734303338336365623165306539666238393266633031646535302f576562417373656d626c792f776173692d6c6962632f6973737565732f343437)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-libc/issues/447\" title=\"Proposal: add `wasm32-wasi-preview2` target, prioritizing `wasi-sockets` support · Issue #447 · WebAssembly/wasi-libc\">Proposal: add `wasm32-wasi-preview2` target, prioritizing `wasi-sockets` support · Issue #447 · WebAssembly/wasi-libc</a></div><div class=\"message_embed_description\">Summary This is a proposal to add wasi-sockets support to wasi-libc as a first step towards full WASI Preview 2 support. This includes adding a new wasm32-wasi-preview2 build target to differentiat...</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/dicej/wasi-sockets-tests\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/e81ad00359c9c65c6710ca596ef0b4ca698349d6\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f343664303431376531383332656565306364656165663230626662333934353733623033303762663763366638363133353835643566616238623437303263642f646963656a2f776173692d736f636b6574732d7465737473)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/dicej/wasi-sockets-tests\" title=\"GitHub - dicej/wasi-sockets-tests: Test harness for prototyping support for wasi-sockets in the Rust std library and wasi-libc\">GitHub - dicej/wasi-sockets-tests: Test harness for prototyping support for wasi-sockets in the Rust std library and wasi-libc</a></div><div class=\"message_embed_description\">Test harness for prototyping support for wasi-sockets in the Rust std library and wasi-libc - GitHub - dicej/wasi-sockets-tests: Test harness for prototyping support for wasi-sockets in the Rust st...</div></div></div>",
        "id": 404963555,
        "sender_full_name": "Joel Dice",
        "timestamp": 1701298267
    },
    {
        "content": "<p>Awesome!</p>",
        "id": 405066749,
        "sender_full_name": "Dave Bakker (badeend)",
        "timestamp": 1701333695
    },
    {
        "content": "<p>I see you're targeting <code>0.2.0-rc-2023-10-18</code>. Just a heads up; <code>0.2.0-rc-2023-11-10</code> has some notable changes in the UDP spec.</p>",
        "id": 405067876,
        "sender_full_name": "Dave Bakker (badeend)",
        "timestamp": 1701333987
    },
    {
        "content": "<hr>\n<p>How can I get your branch running?</p>\n<p>I have:</p>\n<ul>\n<li>installed wasi-sdk at <code>/wasi-sdk-20.0</code></li>\n<li>checked out <code>https://github.com/dicej/wasi-libc/tree/sockets</code> into <code>/wasi-libc</code></li>\n<li>built your branch using <code>make CC=/wasi-sdk-20.0/bin/clang AR=/wasi-sdk-20.0/bin/llvm-ar NM=/wasi-sdk-20.0/bin/llvm-nm</code></li>\n<li>Then try to build a test program using <code>/wasi-sdk-20.0/bin/clang --sysroot=/wasi-libc/sysroot program.c -o program.wasm</code></li>\n</ul>\n<p>Program.c:</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdio.h&gt;</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;sys/socket.h&gt;</span>\n\n<span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">sock</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">socket</span><span class=\"p\">(</span><span class=\"n\">AF_INET</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">SOCK_STREAM</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">sock</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"Error while creating socket</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">-1</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"Yay!</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>But I still get the error:</p>\n<blockquote>\n<p>program.c:5:13: error: call to undeclared function 'socket';</p>\n</blockquote>",
        "id": 405087329,
        "sender_full_name": "Dave Bakker (badeend)",
        "timestamp": 1701340537
    },
    {
        "content": "<p>this is amazing work, <span class=\"user-mention\" data-user-id=\"509936\">@Joel Dice</span>. We have several groups over here that are needing wasi-libc work and willing to dive in to help -- but do not know where to start. I think I need to help various people engage in a <strong>constructive</strong> way and not <strong>chaos-inducing</strong> way. :-)</p>",
        "id": 405088797,
        "sender_full_name": "Ralph",
        "timestamp": 1701340978
    },
    {
        "content": "<blockquote>\n<p>But I still get the error</p>\n</blockquote>\n<p>Nevermind. Turns out the socket functions weren't being exported in <code>socket.h</code> yet. I've got it working now <span aria-label=\"working on it\" class=\"emoji emoji-1f6e0\" role=\"img\" title=\"working on it\">:working_on_it:</span></p>",
        "id": 405097581,
        "sender_full_name": "Dave Bakker (badeend)",
        "timestamp": 1701343936
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"378155\">Badeend</span> <a href=\"#narrow/stream/219900-wasi/topic/wasi-libc.20preview2.20status.3F/near/405097581\">said</a>:</p>\n<blockquote>\n<blockquote>\n<p>But I still get the error</p>\n</blockquote>\n<p>Nevermind. Turns out the socket functions weren't being exported in <code>socket.h</code> yet. I've got it working now <span aria-label=\"working on it\" class=\"emoji emoji-1f6e0\" role=\"img\" title=\"working on it\">:working_on_it:</span></p>\n</blockquote>\n<p>Good catch.  I'll admit I've only been testing with Rust so far, so I've probably missed a few basic things on the C side.</p>",
        "id": 405129644,
        "sender_full_name": "Joel Dice",
        "timestamp": 1701354699
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"268586\">Ralph</span> <a href=\"#narrow/stream/219900-wasi/topic/wasi-libc.20preview2.20status.3F/near/405088797\">said</a>:</p>\n<blockquote>\n<p>this is amazing work, <span class=\"user-mention silent\" data-user-id=\"509936\">Joel Dice</span>. We have several groups over here that are needing wasi-libc work and willing to dive in to help -- but do not know where to start. I think I need to help various people engage in a <strong>constructive</strong> way and not <strong>chaos-inducing</strong> way. :-)</p>\n</blockquote>\n<p>Sounds great.  I'd be happy to help coordinate efforts and e.g. schedule a meeting to divy up work as appropriate.</p>",
        "id": 405131344,
        "sender_full_name": "Joel Dice",
        "timestamp": 1701355182
    },
    {
        "content": "<p>I chatted with Till about ways to help others contribute to the wasi-libc/wasi-sockets effort, and we agreed that making one or issues in the GitHub, each with task checklists (like what Yosh has done for Jco, e.g. <a href=\"https://github.com/bytecodealliance/jco/issues/207\">https://github.com/bytecodealliance/jco/issues/207</a>) would great.  Maybe one issue each for TCP, UDP, and DNS?  I'll take a stab at it when I get a chance, although I may need help from e.g. <span class=\"user-mention\" data-user-id=\"378155\">@Badeend</span> to ensure it's complete.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/jco/issues/207\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/3394955b7982aa0798c94d1c0679836950aa6fae\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f313161363430393266623832646136616365366634623136613134623138643966333033333361346639393465663430646133303734616330326336373137642f62797465636f6465616c6c69616e63652f6a636f2f6973737565732f323037)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/jco/issues/207\" title=\"Jco transpile: implementation of wasi-io for Web · Issue #207 · bytecodealliance/jco\">Jco transpile: implementation of wasi-io for Web · Issue #207 · bytecodealliance/jco</a></div><div class=\"message_embed_description\">Tasks streams.read streams.blocking-read streams.skip streams.blocking-skip streams.subscribe-to-input-stream streams.drop-input-stream streams.check-write streams.write streams.blocking-write-and-...</div></div></div>",
        "id": 405180158,
        "sender_full_name": "Joel Dice",
        "timestamp": 1701370507
    },
    {
        "content": "<blockquote>\n<p>we agreed that making one or issues in the GitHub, each with task checklists (...)</p>\n</blockquote>\n<blockquote>\n<p>We have several groups (...) willing to dive in to help</p>\n</blockquote>\n<p>That's great! TBH, I don't think there's _that_ much  work to be done <span aria-label=\"stuck out tongue\" class=\"emoji emoji-1f61b\" role=\"img\" title=\"stuck out tongue\">:stuck_out_tongue:</span> It seems to me that having one or two people working on it for a few days could get it pretty far already. </p>\n<p>And if it wasn't clear already; I'm definitely up for being one of those people.  <span aria-label=\"octopus\" class=\"emoji emoji-1f419\" role=\"img\" title=\"octopus\">:octopus:</span></p>",
        "id": 405209677,
        "sender_full_name": "Dave Bakker (badeend)",
        "timestamp": 1701379989
    },
    {
        "content": "<p>It's one of my objectives to find some help here. good chance, given the timing, that help is found after Jan 1.....</p>",
        "id": 405308646,
        "sender_full_name": "Ralph",
        "timestamp": 1701418920
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"509936\">@Joel Dice</span>  I've just submitted a PR to your branch expanding TCP support even further</p>\n<p><a href=\"https://github.com/dicej/wasi-libc/pull/1\">https://github.com/dicej/wasi-libc/pull/1</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/dicej/wasi-libc/pull/1\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/bbc898d0f36648099f9f550401aaf0438dcf2bf6\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f376633656361623465376166353135326431363734633765646534613330666239326232353230316632396530613063646239306539663761366230653633312f646963656a2f776173692d6c6962632f70756c6c2f31)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/dicej/wasi-libc/pull/1\" title=\"Tcp sockets by badeend · Pull Request #1 · dicej/wasi-libc\">Tcp sockets by badeend · Pull Request #1 · dicej/wasi-libc</a></div><div class=\"message_embed_description\">Added support for all TCP operations &amp; socket options.\nAdded UDP stubs\n\nNotable remaining TODOs:\n\nupdate to 2023-11-10 snapshot\nmapping ip addresses from wasi to posix format isn;t implemented yet....</div></div></div>",
        "id": 405683769,
        "sender_full_name": "Dave Bakker (badeend)",
        "timestamp": 1701625264
    },
    {
        "content": "<p>The TCP support may 100% complete yet (see summary in PR), but I consider it \"good enough\" for a one-weekend project.</p>",
        "id": 405683965,
        "sender_full_name": "Dave Bakker (badeend)",
        "timestamp": 1701625431
    },
    {
        "content": "<p>Works On My Machine™</p>\n<p><a href=\"/user_uploads/15107/KiTyj-qym617fG1DRc2iKzx7/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/15107/KiTyj-qym617fG1DRc2iKzx7/image.png\" title=\"image.png\"><img src=\"/user_uploads/15107/KiTyj-qym617fG1DRc2iKzx7/image.png\"></a></div>",
        "id": 405684029,
        "sender_full_name": "Dave Bakker (badeend)",
        "timestamp": 1701625461
    },
    {
        "content": "<p>drive-by comment but some of those names are super long so I've opened <a href=\"https://github.com/bytecodealliance/wit-bindgen/pull/783\">https://github.com/bytecodealliance/wit-bindgen/pull/783</a> to enable reducing some of the verbosity in the C bindings here</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wit-bindgen/pull/783\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/182ae277a61958751af2325e0546ad4e21328ada\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f646439353061323034376531303736623232393430666234623464626134393064666231323738303965623030613562653833396235666636373361623863652f62797465636f6465616c6c69616e63652f7769742d62696e6467656e2f70756c6c2f373833)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wit-bindgen/pull/783\" title=\"Add a `--rename` option to the C generator by alexcrichton · Pull Request #783 · bytecodealliance/wit-bindgen\">Add a `--rename` option to the C generator by alexcrichton · Pull Request #783 · bytecodealliance/wit-bindgen</a></div><div class=\"message_embed_description\">The generated symbols for types like\nwasi:http/types@0.2.0-rc-2023-10-18 can get quite long so add an option to rename them explicitly if desired.</div></div></div>",
        "id": 405687388,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1701628229
    },
    {
        "content": "<p>nice</p>",
        "id": 405690248,
        "sender_full_name": "Dave Bakker (badeend)",
        "timestamp": 1701630536
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"378155\">@Badeend</span> Thanks so much for working on this; I'm 2/3 through reviewing your PR amidst a barrage of meetings.</p>",
        "id": 405888712,
        "sender_full_name": "Joel Dice",
        "timestamp": 1701714642
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"378155\">@Badeend</span> FYI, I'm working on adding <code>ioctl</code> and <code>poll</code> support for <code>wasi-sockets</code> in <code>wasi-libc</code> (in case you were planning to do the same).  Trying to get a Python <code>asyncio</code> test passing.</p>",
        "id": 406596038,
        "sender_full_name": "Joel Dice",
        "timestamp": 1701972662
    },
    {
        "content": "<p>Great! I'm working on UDP, so no conflict there <span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span></p>",
        "id": 406596246,
        "sender_full_name": "Dave Bakker (badeend)",
        "timestamp": 1701972738
    },
    {
        "content": "<p>I pushed <code>ioctl</code> and <code>poll</code> support yesterday.  Python is working nicely: <a href=\"https://github.com/dicej/wasi-sockets-tests/blob/main/client-python/app.py\">https://github.com/dicej/wasi-sockets-tests/blob/main/client-python/app.py</a></p>",
        "id": 406806782,
        "sender_full_name": "Joel Dice",
        "timestamp": 1702056472
    },
    {
        "content": "<p>The next big thing I plan to work on is to build separate sysroots for <code>wasm32-wasi</code> (Preview 1) and <code>wasm32-wasi-preview2</code> and update <code>wasi-sdk</code> to build and test both of them (using <code>wit-component</code> for the latter).  Once that's done, I'd like to get a draft PR up for <code>wasi-libc</code> to start getting feedback, even if not everything is implemented yet.</p>",
        "id": 406807795,
        "sender_full_name": "Joel Dice",
        "timestamp": 1702056808
    },
    {
        "content": "<p>y'all doing yeoperson's work here.....</p>",
        "id": 406813545,
        "sender_full_name": "Ralph",
        "timestamp": 1702058954
    },
    {
        "content": "<p>Initial UDP implementation is ready: <a href=\"https://github.com/dicej/wasi-libc/pull/4\">https://github.com/dicej/wasi-libc/pull/4</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/dicej/wasi-libc/pull/4\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/e8c6790c49dd8b8ea31115f280ae51d95919d8f1\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f383362376334613632643738346235613433353532393235393163613738363836383433616138646364313364626432386336306335633238383631363930342f646963656a2f776173692d6c6962632f70756c6c2f34)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/dicej/wasi-libc/pull/4\" title=\"UDP by badeend · Pull Request #4 · dicej/wasi-libc\">UDP by badeend · Pull Request #4 · dicej/wasi-libc</a></div><div class=\"message_embed_description\">Added UDP implementations for:\n\nsocket\nclose\nbind\nconnect\ngetsockname,  getpeername\nget/setsockopt\nrecv, send, recvfrom, sendto\n\nAdditionally:\n\nMade recvfrom &amp; sendto generally available, even for ...</div></div></div>",
        "id": 407050588,
        "sender_full_name": "Dave Bakker (badeend)",
        "timestamp": 1702206522
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"378155\">@Badeend</span> I just pushed <a href=\"https://github.com/dicej/wasi-libc/commit/6be1e1a29cfb1d1224b9a5a940de48ff26699a23\">https://github.com/dicej/wasi-libc/commit/6be1e1a29cfb1d1224b9a5a940de48ff26699a23</a> and <a href=\"https://github.com/dicej/wasi-sdk/commit/f9dabc8322dfa9cd9a717bf5fccd3116e86938f6\">https://github.com/dicej/wasi-sdk/commit/f9dabc8322dfa9cd9a717bf5fccd3116e86938f6</a>, which separate the Preview 1 and Preview 2 builds.  I'm going to try to keep both of them working going forward and will work on enabling CI testing for both tomorrow.  Note the use of the new <code>__wasilibc_use_preview2</code> preprocessor directive to conditionally enable Preview 2 features.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/dicej/wasi-libc/commit/6be1e1a29cfb1d1224b9a5a940de48ff26699a23\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/b03ecd00ed00566f2f29118cde3ae30f448f3839\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f326633626632343761623063616462343637353563666462313333316165343265616562313631633638396536636165316335396231396164353334313934352f646963656a2f776173692d6c6962632f636f6d6d69742f36626531653161323963666231643132323462396135613934306465343866663236363939613233)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/dicej/wasi-libc/commit/6be1e1a29cfb1d1224b9a5a940de48ff26699a23\" title=\"build for Preview 1 and 2 separately · dicej/wasi-libc@6be1e1a\">build for Preview 1 and 2 separately · dicej/wasi-libc@6be1e1a</a></div><div class=\"message_embed_description\">This restores the original Preview 1 socket code and only enables Preview 2\n-based functionality when requested via `WASI_SNAPSHOT=preview2`.\n\nSigned-off-by: Joel Dice &lt;joel.dice@fermyon.com&gt;</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/dicej/wasi-sdk/commit/f9dabc8322dfa9cd9a717bf5fccd3116e86938f6\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/d795c000356d47a4d9cdbf6e3b41115eb5889d5d\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f306237646461636131373539346361663366666533346432383339346239396666666630343634303638333533313163373261343033613463336562373563352f646963656a2f776173692d73646b2f636f6d6d69742f66396461626338333232646661396364396137313762663566636364333131366538363933386636)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/dicej/wasi-sdk/commit/f9dabc8322dfa9cd9a717bf5fccd3116e86938f6\" title=\"build for Preview 1 and Preview 2 separately · dicej/wasi-sdk@f9dabc8\">build for Preview 1 and Preview 2 separately · dicej/wasi-sdk@f9dabc8</a></div><div class=\"message_embed_description\">Signed-off-by: Joel Dice &lt;joel.dice@fermyon.com&gt;</div></div></div>",
        "id": 407367284,
        "sender_full_name": "Joel Dice",
        "timestamp": 1702350326
    },
    {
        "content": "<p>Great!</p>",
        "id": 407571300,
        "sender_full_name": "Dave Bakker (badeend)",
        "timestamp": 1702416475
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"378155\">@Dave Bakker (badeend)</span> I've been running the socket tests in the CPython regression test suite to test our <code>wasi-libc</code> work.  There are a lot of failures, but most of them are due to lack of thread, process, signal, and unix domain socket support, all of which are out of scope for what we're doing.  I'm currently digging into the remaining failures which aren't immediately obvious.</p>\n<p>Some of the failures are due to neither <code>SO_BROADCAST</code> nor <code>SO_REUSEADDR</code> existing.  Are either of those in scope for <code>wasi-sockets</code> (or for emulation in <code>wasi-libc</code>)?</p>",
        "id": 409019206,
        "sender_full_name": "Joel Dice",
        "timestamp": 1703021398
    },
    {
        "content": "<p>It Depends™:</p>\n<ul>\n<li>SO_BROADCAST for UDP: Not (yet) supported</li>\n<li>SO_REUSEADDR for UDP: Not (yet) supported</li>\n<li>SO_BROADCAST for TCP: N/A</li>\n<li>SO_REUSEADDR for TCP: This is enabled by default in wasi-sockets. This was already implemented for a while, but documented only <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7690/files\">a couple of days ago</a></li>\n</ul>\n<p>I think we should define SO_REUSEADDR and implement it in libc for TCP as a no-op. As for SO_BROADCAST: is it actually being used, or does it just need the constant to be defined? Maybe the simplest solution would be to define all commonly used sockopt constants, even if they're not implemented.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/pull/7690/files\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/a8000357ff591227070c79c39a619f93f8caf181\\/68747470733a2f2f617661746172732e67697468756275736572636f6e74656e742e636f6d2f752f333634363536313f733d34303026763d34)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/pull/7690/files\" title=\"wasi-sockets: Add SO_REUSEADDR back in by badeend · Pull Request #7690 · bytecodealliance/wasmtime\">wasi-sockets: Add SO_REUSEADDR back in by badeend · Pull Request #7690 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">In #7662 the call to bind_existing_tcp_listener was replaced with rustix::net::bind. Unfortunately, besides calling bind, bind_existing_tcp_listener also set SO_REUSEADDR. This PR restores that beh...</div></div></div>",
        "id": 409022094,
        "sender_full_name": "Dave Bakker (badeend)",
        "timestamp": 1703022917
    },
    {
        "content": "<p>This is the <code>SO_BROADCAST</code> test:  <a href=\"https://github.com/dicej/cpython/blob/abfbab6415fb029e7dca19ecc8d29a13da37bf71/Lib/test/test_asyncio/test_base_events.py#L1652-L1667\">https://github.com/dicej/cpython/blob/abfbab6415fb029e7dca19ecc8d29a13da37bf71/Lib/test/test_asyncio/test_base_events.py#L1652-L1667</a>.  Looks like the test just verifies that <code>SO_BROADCAST</code> can be get and set via <code>getsockopt</code>/<code>setsockopt</code>.  To be clear: we don't need the test to pass if it's not in scope (yet).</p>",
        "id": 409024020,
        "sender_full_name": "Joel Dice",
        "timestamp": 1703023700
    },
    {
        "content": "<p>Thanks for the info regarding <code>SO_REUSEADDR</code>.  I'll go ahead and add it as a no-op.</p>",
        "id": 409024067,
        "sender_full_name": "Joel Dice",
        "timestamp": 1703023726
    },
    {
        "content": "<p>UDP broadcast and multicast are not part of preview2, so those tests will most likely fail.</p>\n<p>Interesting testsuite, BTW. I'm curious how many preview2 can pass</p>",
        "id": 409024727,
        "sender_full_name": "Dave Bakker (badeend)",
        "timestamp": 1703024052
    },
    {
        "content": "<p>I've got all the relevant CPython asyncio regression tests passing (i.e. the ones that don't require multithreading, process spawning, signals, broadcast, etc.). <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>",
        "id": 409235369,
        "sender_full_name": "Joel Dice",
        "timestamp": 1703094845
    },
    {
        "content": "<p>Awesome! <span aria-label=\"rocket\" class=\"emoji emoji-1f680\" role=\"img\" title=\"rocket\">:rocket:</span></p>",
        "id": 409235463,
        "sender_full_name": "Dave Bakker (badeend)",
        "timestamp": 1703094881
    }
]