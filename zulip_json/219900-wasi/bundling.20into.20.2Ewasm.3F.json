[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"253998\">@Luke Wagner</span> I understand that you know about how to bundle files into a Wasm file. I'm trying to figure out how to bundle Python scripts into a Python.wasm binary. Could you point me in the right direction?</p>",
        "id": 294713775,
        "sender_full_name": "Richard Zak",
        "timestamp": 1661183064
    },
    {
        "content": "<p>AFAIK it hasn't been implemented or even really spec'd out yet.</p>",
        "id": 294714339,
        "sender_full_name": "Lann Martin",
        "timestamp": 1661183267
    },
    {
        "content": "<p>The rough idea is to embed files into custom sections in a way that they can be losslessly converted to and from a file system tree, but I don't think we've gotten much more concrete than that</p>",
        "id": 294715029,
        "sender_full_name": "Lann Martin",
        "timestamp": 1661183486
    },
    {
        "content": "<p>I've seen wasi-vfs <a href=\"https://github.com/kateinoigakukun/wasi-vfs\">https://github.com/kateinoigakukun/wasi-vfs</a> which is used with Ruby.wasm <a href=\"https://github.com/ruby/ruby.wasm\">https://github.com/ruby/ruby.wasm</a> but I haven't been able to replicate with Python. Is the proposed design for Wasm/wasi like Ruby's wasi-vfs? It's a static lib which gets compiled in, and the wasi-vfs tool is able to add files/directories.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/kateinoigakukun/wasi-vfs\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/869fccff462174cf409b83bc236ce8209b61d343\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f666663346431643366613130343566323937663162303563396262303465373035386464306334343566323466373637356439353034643034303835653262662f6b617465696e6f6967616b756b756e2f776173692d766673)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/kateinoigakukun/wasi-vfs\" title=\"GitHub - kateinoigakukun/wasi-vfs: A virtual filesystem layer for WASI.\">GitHub - kateinoigakukun/wasi-vfs: A virtual filesystem layer for WASI.</a></div><div class=\"message_embed_description\">A virtual filesystem layer for WASI. Contribute to kateinoigakukun/wasi-vfs development by creating an account on GitHub.</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/ruby/ruby.wasm\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/a6528eac90efda96895d7df1d49d74cfc7788ad7\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f626638373932353239616465663562346531653836623337633131313639383535633730666433616437333263336566623562346237356638643634306336622f727562792f727562792e7761736d)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/ruby/ruby.wasm\" title=\"GitHub - ruby/ruby.wasm: ruby.wasm is a collection of WebAssembly ports of the CRuby.\">GitHub - ruby/ruby.wasm: ruby.wasm is a collection of WebAssembly ports of the CRuby.</a></div><div class=\"message_embed_description\">ruby.wasm is a collection of WebAssembly ports of the CRuby. - GitHub - ruby/ruby.wasm: ruby.wasm is a collection of WebAssembly ports of the CRuby.</div></div></div>",
        "id": 294718776,
        "sender_full_name": "Richard Zak",
        "timestamp": 1661184088
    },
    {
        "content": "<p>If I'm not mistaken, <code>wasi-vfs</code> constructs an in-memory filesystem which is copied into a normal data segment. It doesn't require any cooperation from the runtime, unlike the custom sections approach</p>",
        "id": 294720069,
        "sender_full_name": "Lann Martin",
        "timestamp": 1661184481
    },
    {
        "content": "<p>(but I haven't used it, so hopefully someone more knowledgeable than I can confirm)</p>",
        "id": 294720317,
        "sender_full_name": "Lann Martin",
        "timestamp": 1661184556
    },
    {
        "content": "<p>I think there are two subtly-different cases here:</p>\n<ol>\n<li>bundling \"static assets\" that you want to be programmatically available to the running wasm code through maybe a traditional filesystem or maybe something more explicit like, say, the <a href=\"https://github.com/tc39/proposal-asset-references\">asset references proposal in JS</a></li>\n<li>bundling externally-viewed metadata (that is <em>not</em> accessible to the running wasm code) into a .wasm file (primarily via custom sections)</li>\n</ol>\n<p>Both are valuable, but the toolchain story is quite different.  If you're talking about bundling Python scripts, that sounds like case #1.  What I'd like to see here is that we can leverage the component model's linking support to build a language-independent tool that can virtualize a WASI filesystem in terms of data sections (and possibly other non-filesystem interfaces, e.g., a blob store interface).  The rough workflow would be that you (1) create a general Python component that imports the WASI filesystem interface to access the scripts as normal files, (2) call the virtualizer tool, passing in the Python component, the static asset directory, and lastly an /etc/fstab-like file that says \"mount the static assets at this directory in the VFS\" (thereby allowing multiple kinds of mounts, like Emscripten allows today).  The result would be a compound component that imports the original (shareable) Python component and embeds the static assets in data sections along with (also shareable) VFS code that implements the WASI filesystem interface imported by the Python component.  As an optional step (3), you could use wizer to create a post-Python-parsing snapshot, removing Python-parsing from the runtime-instantiation path.</p>\n<p>Unfortunately, we haven't started building this virtualizer tool, though.  Now that we have real component-model support in Wasmtime and producer tooling for generating and linking components wit-component+component-compose, it would make sense to start this soon as a new Bytecode Alliance tool to add to the suite.</p>\n<p>In the meantime, wizer can be used on core wasm to achieve a similar effect today, reading all the files before the snapshot, effectively using snapshotting as the tool for putting static assets into data sections.  Nick Fitzgerald is a good person to talk to about this.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/tc39/proposal-asset-references\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/32348e26b99323955fc97582b23c52bab2cf331b\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f343161343161353733353163643237393164383539323839353134623636633131626263356564326139393363303166393336306536313037646536393466642f746333392f70726f706f73616c2d61737365742d7265666572656e636573)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/tc39/proposal-asset-references\" title=\"GitHub - tc39/proposal-asset-references: Proposal to ECMAScript to add first-class location references relative to a module\">GitHub - tc39/proposal-asset-references: Proposal to ECMAScript to add first-class location references relative to a module</a></div><div class=\"message_embed_description\">Proposal to ECMAScript to add first-class location references relative to a module - GitHub - tc39/proposal-asset-references: Proposal to ECMAScript to add first-class location references relative ...</div></div></div>",
        "id": 294735043,
        "sender_full_name": "Luke Wagner",
        "timestamp": 1661189496
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"506027\">@Richard Zak</span> Hi, Richard. I'm the author of wasi-vfs, and I'm interested in your Python use case. Could you share me how you played with wasi-vfs? I'd love to help you :)</p>",
        "id": 295137489,
        "sender_full_name": "Yuta Saito",
        "timestamp": 1661380884
    },
    {
        "content": "<p>I used <code>wasi-vfs</code> to bundle Ruby's standard scripts and a script I wanted to run so I could run it with Enarx <a href=\"https://github.com/enarx/enarx\">https://github.com/enarx/enarx</a>. I haven't been successful with <code>wasi-vfs</code> &amp; Python yet, but <span class=\"user-mention\" data-user-id=\"484040\">@bstrie</span> and I are working on it. I ran into errors when trying to get a Wasi port of Python to link with libwasi_vfs.a and haven't tried again. But I think it's the only way forward for us, at least for now.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/enarx/enarx\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/be4bdaa2caa46f670d58a703d934be3a67c59967\\/68747470733a2f2f7265706f7369746f72792d696d616765732e67697468756275736572636f6e74656e742e636f6d2f3230363333373437322f65373430316338302d343736632d313165612d396134302d356262363736316233623265)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/enarx/enarx\" title=\"GitHub - enarx/enarx: Enarx: Confidential Computing with WebAssembly\">GitHub - enarx/enarx: Enarx: Confidential Computing with WebAssembly</a></div><div class=\"message_embed_description\">Enarx: Confidential Computing with WebAssembly. Contribute to enarx/enarx development by creating an account on GitHub.</div></div></div>",
        "id": 295137640,
        "sender_full_name": "Richard Zak",
        "timestamp": 1661381021
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"516084\">@bstrie</span> There are two \"bstrie\" accounts for some reason, tagging both.</p>",
        "id": 295137782,
        "sender_full_name": "Richard Zak",
        "timestamp": 1661381117
    },
    {
        "content": "<p>Ok, if you could report the error to the wasi-vfs repo, it would be very appreciated :)</p>",
        "id": 295138397,
        "sender_full_name": "Yuta Saito",
        "timestamp": 1661381624
    },
    {
        "content": "<p>I was able to successfully build WASI Python with the VFS.  I cloned tiran's cpython fork (<a href=\"https://github.com/tiran/cpython.git\">https://github.com/tiran/cpython.git</a>) and added a couple of hacks, as shown in this diff (obviously, update the paths for your own environment):</p>\n<p><a href=\"https://github.com/pvetere/cpython/commit/e291f4e8a656ddf8b75445290d826e6703e5776\">https://github.com/pvetere/cpython/commit/e291f4e8a656ddf8b75445290d826e6703e5776</a></p>\n<p>Then, from the repo's root, I did the following:</p>\n<ol>\n<li>Build WASI-enabled Python:</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Tools</span><span class=\"o\">/</span><span class=\"n\">wasm</span><span class=\"o\">/</span><span class=\"n\">wasm_build</span><span class=\"p\">.</span><span class=\"n\">py</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"w\"> </span><span class=\"n\">compile</span><span class=\"w\"></span>\n</code></pre></div>\n<ol start=\"2\">\n<li>Create the runtime structure in <code>./pyroot</code>:</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">cd</span><span class=\"w\"> </span><span class=\"n\">builddir</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">make</span><span class=\"w\"> </span><span class=\"n\">install</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">cd</span><span class=\"w\"> </span><span class=\"o\">../..</span><span class=\"w\"></span>\n</code></pre></div>\n<ol start=\"3\">\n<li>Pack the runtime libs into the Wasm module.  Run the following command from the root of the repo.  It may take a minute or two:</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">vfs</span><span class=\"w\"> </span><span class=\"n\">pack</span><span class=\"w\"> </span><span class=\"n\">builddir</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">python</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">mapdir</span><span class=\"w\"> </span><span class=\"n\">lib</span>::<span class=\"cp\">$(</span><span class=\"n\">pwd</span><span class=\"p\">)</span><span class=\"o\">/</span><span class=\"n\">pyroot</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"n\">builddir</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">python</span><span class=\"o\">-</span><span class=\"n\">with</span><span class=\"o\">-</span><span class=\"n\">vfs</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"></span>\n</code></pre></div>\n<ol start=\"4\">\n<li>Now you should be able to run python in Wasm with the VFS, like in the following example.  The <code>--dir .</code> option is necessary to give the right capabilities to wasmtime, but the libs are all read from the VFS.</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">dir</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"w\"> </span><span class=\"n\">builddir</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">python</span><span class=\"o\">-</span><span class=\"n\">with</span><span class=\"o\">-</span><span class=\"n\">vfs</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"></span>\n<span class=\"n\">Python</span><span class=\"w\"> </span><span class=\"mf\">3.12.0</span><span class=\"n\">a0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">heads</span><span class=\"o\">/</span><span class=\"n\">main</span><span class=\"o\">-</span><span class=\"n\">dirty</span>:<span class=\"mi\">32</span><span class=\"n\">ac98e899</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Aug</span><span class=\"w\"> </span><span class=\"mi\">25</span><span class=\"w\"> </span><span class=\"mi\">2022</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">10</span>:<span class=\"mi\">59</span>:<span class=\"mi\">15</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">Clang</span><span class=\"w\"> </span><span class=\"mf\">13.0.0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">https</span>:<span class=\"c1\">//github.com/llvm/llvm-project fd1d8c2f04dde23bee0fb3a7d069 on wasi</span>\n<span class=\"n\">Type</span><span class=\"w\"> </span><span class=\"s\">\"help\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"copyright\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"credits\"</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"s\">\"license\"</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">more</span><span class=\"w\"> </span><span class=\"n\">information</span><span class=\"p\">.</span><span class=\"w\"></span>\n<span class=\"o\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">sys</span><span class=\"w\"></span>\n<span class=\"o\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">json</span><span class=\"w\"></span>\n<span class=\"o\">&gt;&gt;&gt;</span><span class=\"w\"></span>\n</code></pre></div>\n<p>Hope this helps!</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/tiran/cpython.git\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/6c912ca302d304ef4911279dd69e0b3341ec80cc\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f343766363836386564653162326332393662303736386438663238616662643264356265363637303237346235363636336134616332303233383064353864362f746972616e2f63707974686f6e)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/tiran/cpython.git\" title=\"GitHub - tiran/cpython: The Python programming language\">GitHub - tiran/cpython: The Python programming language</a></div><div class=\"message_embed_description\">The Python programming language. Contribute to tiran/cpython development by creating an account on GitHub.</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/pvetere/cpython/commit/e291f4e8a656ddf8b75445290d826e6703e5776\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/770258d7d499741928167284a17e31efb0353a11\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f373863396635653938376531353338616135306139663533363531373134376137633737663530613235306533393037323533366438616139393235343662382f707665746572652f63707974686f6e2f636f6d6d69742f65323931663465386136353664646638623735343435323930643832366536373033653537373631)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/pvetere/cpython/commit/e291f4e8a656ddf8b75445290d826e6703e5776\" title=\"Hacks to get WASI Python building with VFS · pvetere/cpython@e291f4e\">Hacks to get WASI Python building with VFS · pvetere/cpython@e291f4e</a></div><div class=\"message_embed_description\">The Python programming language. Contribute to pvetere/cpython development by creating an account on GitHub.</div></div></div>",
        "id": 295255099,
        "sender_full_name": "Pete Vetere",
        "timestamp": 1661441376
    }
]