[
    {
        "content": "<p>alexcrichton transferred <a href=\"https://github.com/bytecodealliance/cranelift/issues/1237\" target=\"_blank\" title=\"https://github.com/bytecodealliance/cranelift/issues/1237\">Issue #1237</a>:</p>\n<blockquote>\n<ul>\n<li>What are the steps to reproduce the issue? Can you include a CLIF test case,<br>\n  ideally reduced with the <code>bugpoint</code> clif-util command?</li>\n</ul>\n<div class=\"codehilite\"><pre><span></span>1. Add the following as legalization:\n\n```rust\nfor &amp;(ty, ty_half) in &amp;[(I64, I32), (I128, I64)] {\n    let inst = ireduce.bind(ty_half).bind(ty);\n    expand.legalize(\n        def!(a = inst(x)),\n        vec![\n            def!((a, xh) = isplit(x)),\n        ]\n    )\n}\n```\n\n2. Try to compile:\n\n```\ntest run\ntarget x86_64\n\nfunction u0:0() -&gt; i64 system_v {\nebb0:\n    v0 = iconst.i64 0\n    v2 = iconcat v0, v0\n    v3 = ireduce.i64 v2\n    return v3\n}\n; run\n```\n</pre></div>\n\n\n<ul>\n<li>What do you expect to happen? What does actually happen? Does it panic, and<br>\n  if so, with which assertion?</li>\n</ul>\n<div class=\"codehilite\"><pre><span></span>I expected the `ireduce` to be legalized to `v3, v999 = isplit v2`. The result however was a verifier error:\n\n```\nfunction u0:0() -&gt; i64 [%rax] system_v {\n                                ebb0:\n[RexOp1pu_id#b8]                    v0 = iconst.i64 0\n[-]                                 v2 = iconcat v0, v0\n[Op1ret#c3]                         return v3\n;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n; error: inst3: v3 is defined by inst2 which has no EBB\n\n}\n```\n\nThe problem is that the following legalization code is generated:\n\n```rust\npos.func.dfg.clear_results(inst);\nlet curpos = pos.position();\nlet srcloc = pos.srcloc();\nlet (a, xh) = split::isplit(pos.func, cfg, curpos, srcloc, x);\nlet removed = pos.remove_inst();\ndebug_assert_eq!(removed, inst);\nreturn true;\n```\n\nThe inst results are never attached to an instruction again, nor turned into aliases.\n</pre></div>\n\n\n<ul>\n<li>Which Cranelift version / commit hash / branch are you using? <a href=\"http://bed9a72a777f1b972e58ad250ead851585d9ab1e\" target=\"_blank\" title=\"http://bed9a72a777f1b972e58ad250ead851585d9ab1e\">master</a></li>\n</ul>\n</blockquote>",
        "id": 189361658,
        "sender_full_name": "GitHub",
        "timestamp": 1582932458
    }
]