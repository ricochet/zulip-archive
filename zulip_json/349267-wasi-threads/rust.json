[
    {
        "content": "<p>After getting approval for adding <code>wasm32-wasi-threads</code> as a tier-2 target to <code>rustc</code> (see <a href=\"https://github.com/rust-lang/compiler-team/issues/574\">#574</a>), it was my intent earlier in the year to implement the new target and then fill in the missing <code>std::thread::spawn</code> implementation using the threads-compatible build of wasi-libc. (Rust's <code>wasm32-wasi</code> target already uses wasi-libc so using it again for <code>wasm32-wasi-threads</code> seems to make sense). I got sidetracked on other work, but want to help finish this work up if possible. <span class=\"user-mention\" data-user-id=\"612401\">@daxpedda</span>  contacted me the other day about this and volunteered to take a look and just yesterday <span class=\"user-mention\" data-user-id=\"614761\">@Georgii Rylov</span> did the same. I propose we use this thread to split this up into smaller chunks and coordinate who does what.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/compiler-team/issues/574\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/a98ac2c3b4c49f35df6452f7abed96c7003a51c5\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f333239353233666139346539643438636265326234326364616161343962313830363263353434373439393162326562373730343133343562373562313262362f727573742d6c616e672f636f6d70696c65722d7465616d2f6973737565732f353734)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/compiler-team/issues/574\" title=\"New tier-2 target for `wasm32-wasi` + threads · Issue #574 · rust-lang/compiler-team\">New tier-2 target for `wasm32-wasi` + threads · Issue #574 · rust-lang/compiler-team</a></div><div class=\"message_embed_description\">Proposal Several of us working on WebAssembly (cc: @alexcrichton, @loganek, @sunfishcode, @sbc100, @AlexEne) have made progress on a WASI proposal to allow spawning threads in WebAssembly programs ...</div></div></div>",
        "id": 355816908,
        "sender_full_name": "Andrew Brown",
        "timestamp": 1683215089
    },
    {
        "content": "<p>I think the most helpful thing I can do is document my progress on this before I was forced to stop. I had the <code>wasm32-wasi-threads</code> target building but compiling programs required linker flags (<code>--export-memory</code> I think?) that were only available in LLVM 16; as I waited for <code>rustc</code> to switch over to LLVM 16 (it now has), I got sidetracked. So here is a description of the steps I took to get that far: <a href=\"https://gist.github.com/abrown/9a94aaa164ad1a8d29d5e86b737bbdc6\">https://gist.github.com/abrown/9a94aaa164ad1a8d29d5e86b737bbdc6</a>.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://gist.github.com/abrown/9a94aaa164ad1a8d29d5e86b737bbdc6\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/2aafd906f69f8f71c7544060163ba3e419b173e8\\/68747470733a2f2f6769746875622e6769746875626173736574732e636f6d2f696d616765732f6d6f64756c65732f67697374732f676973742d6f672d696d6167652e706e67)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://gist.github.com/abrown/9a94aaa164ad1a8d29d5e86b737bbdc6\" title=\"How to start working on `wasm32-wasi-threads`\">How to start working on `wasm32-wasi-threads`</a></div><div class=\"message_embed_description\">How to start working on `wasm32-wasi-threads`. GitHub Gist: instantly share code, notes, and snippets.</div></div></div>",
        "id": 355817531,
        "sender_full_name": "Andrew Brown",
        "timestamp": 1683215267
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"612401\">@daxpedda</span>, <span class=\"user-mention\" data-user-id=\"614761\">@Georgii Rylov</span>, let me know what you think! Any others that want to help out feel free to jump in. <span class=\"user-mention\" data-user-id=\"612401\">@daxpedda</span>, it would probably be helpful to know how much further you have progressed from the gist I sent? (No pressure! I just mean for coordination-sake...)</p>",
        "id": 355817965,
        "sender_full_name": "Andrew Brown",
        "timestamp": 1683215379
    },
    {
        "content": "<p>Great, thank you <span class=\"user-mention\" data-user-id=\"254110\">@Andrew Brown</span> for gist and creating the channel for coordination</p>",
        "id": 355835890,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1683219562
    },
    {
        "content": "<p>I have not taken a look at it at all yet, I was planning to start next week.</p>",
        "id": 355837218,
        "sender_full_name": "daxpedda",
        "timestamp": 1683219897
    },
    {
        "content": "<p>Would like to take on thread-local variables as I've already spent the time figuring out what Rust does there. But that's in the future right now.</p>",
        "id": 355837375,
        "sender_full_name": "daxpedda",
        "timestamp": 1683219942
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"614761\">@Georgii Rylov</span> I'm happy to do the Rust library part if you take on the \"getting it to build\" part, if you like to split it that way.</p>",
        "id": 355837605,
        "sender_full_name": "daxpedda",
        "timestamp": 1683220011
    },
    {
        "content": "<p>It might work yeah, let me take a look at it first</p>",
        "id": 355838338,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1683220216
    },
    {
        "content": "<p>took a quick look at the guide, for me a new target(just a duplicate of wasm32-wasi made by changing the same files from gist) compiles code to wasm but even a hello world segfaults immediately</p>\n<p><span class=\"user-mention\" data-user-id=\"254110\">@Andrew Brown</span> how did you understand what files to modify? did you check <a href=\"https://github.com/rust-lang/rust/commit/ace71240d233e71fcc6e3824fa2e5e05697fd2cc\">https://github.com/rust-lang/rust/commit/ace71240d233e71fcc6e3824fa2e5e05697fd2cc</a> or an another earlier similar commit?</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rust/commit/ace71240d233e71fcc6e3824fa2e5e05697fd2cc\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/9102130974ea1964e2c39dc814b93d4a5a2eaf7e\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f623936626433663164666137613737653637616633393534363865353136383231383530316539656331666162323363306530383461663033623165313235622f727573742d6c616e672f727573742f636f6d6d69742f61636537313234306432333365373166636336653338323466613265356530353639376664326363)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rust/commit/ace71240d233e71fcc6e3824fa2e5e05697fd2cc\" title=\"Add a new wasm32-unknown-wasi target · rust-lang/rust@ace7124\">Add a new wasm32-unknown-wasi target · rust-lang/rust@ace7124</a></div><div class=\"message_embed_description\">This commit adds a new wasm32-based target distributed through rustup,\nsupported in the standard library, and implemented in the compiler. The\n`wasm32-unknown-wasi` target is intended to be a WebAs...</div></div></div>",
        "id": 357702223,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1683840722
    },
    {
        "content": "<p>Yes, commits like that one, conversations with others, some banging of my head on the wall, etc. It took me a while to even understand how to build the compiler the right way. What do you mean by \"segfault\"? I don't think that <code>rustc</code> should segfault as it tries to compile Rust code to the new <code>wasm32-wasi-threads</code> target (?!?). And if it does produce any WebAssembly, running that WebAssembly should not segfault either.</p>",
        "id": 357708957,
        "sender_full_name": "Andrew Brown",
        "timestamp": 1683844164
    },
    {
        "content": "<p>What is the error you are seeing?</p>",
        "id": 357708986,
        "sender_full_name": "Andrew Brown",
        "timestamp": 1683844181
    },
    {
        "content": "<p>Seems I did something wrong first time, now it didn't segfault and adding a new target(not a thread one) seems work fine. Sorry for disappearing, I accidentaly wiped my boot partition so delayed getting back to it</p>",
        "id": 359417020,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1684421238
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"254110\">@Andrew Brown</span> Why did you wait for llvm 16 in rust btw?</p>",
        "id": 359632605,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1684496905
    },
    {
        "content": "<p>It just feels realted to the problem with build that I'm trying to overcome now</p>\n<p>\"= note: rust-lld: error: --shared-memory is disallowed by std-532b41f7ca59a61b.19qx9c2akto1mw8b.rcgu.o because it was not compiled with 'atomics' or 'bulk-memory' features.\"</p>\n<p>according to what I found I need to add options like \"options.features = \"+atomics,+bulk-memory,+mutable-globals\".into();\"<br>\nBut it doesn't compile with \"+atomics\" and I suppose it might be related to usage of LLVM 16 <a href=\"https://github.com/rust-lang/rust/blob/master/compiler/rustc_codegen_llvm/src/llvm_util.rs#L413\">https://github.com/rust-lang/rust/blob/master/compiler/rustc_codegen_llvm/src/llvm_util.rs#L413</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rust/blob/master/compiler/rustc_codegen_llvm/src/llvm_util.rs#L413\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/717f2ce4d95b1facd3509137768f47196d04f7c1\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f373236303734343263393365653133616337343331633534376136656234333738643531613033306239366634363863366166636234393838366139326631352f727573742d6c616e672f72757374)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rust/blob/master/compiler/rustc_codegen_llvm/src/llvm_util.rs#L413\" title=\"rust/llvm_util.rs at master · rust-lang/rust\">rust/llvm_util.rs at master · rust-lang/rust</a></div><div class=\"message_embed_description\">Empowering everyone to build reliable and efficient software. - rust/llvm_util.rs at master · rust-lang/rust</div></div></div>",
        "id": 359633560,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1684497108
    },
    {
        "content": "<p>You can use <code>RUSTFLAGS=\"-Ctarget-features=+atomics,+bulk-memory,+mutable-globals\"</code> for as long as you use <code>cargo build -Zbuild-std=std,panic_abort</code>. Without the <code>-Zbuild-std</code> a version of the standard library without those features will be reused, which doesn't work.</p>",
        "id": 359685048,
        "sender_full_name": "bjorn3",
        "timestamp": 1684507759
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"614761\">Georgii Rylov</span> <a href=\"#narrow/stream/349267-wasi-threads/topic/rust/near/359632605\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"254110\">Andrew Brown</span> Why did you wait for llvm 16 in rust btw?</p>\n</blockquote>\n<p>The reason was related to linker flags: prior to LLVM 16, <code>--import-memory</code> and <code>--export-memory</code> were not allowed together. The reason both are needed is an artifact of how WASI currently does things; see <a href=\"https://github.com/WebAssembly/WASI/issues/502\">https://github.com/WebAssembly/WASI/issues/502</a> for more details.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/WASI/issues/502\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/7c20db9379c3128c7588e43e1e7388b98f4ab192\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f386337383431636464333735353434366439333235663537616234613762306261393838363362633766303766363337653365396236666562633837666632622f576562417373656d626c792f574153492f6973737565732f353032)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/WASI/issues/502\" title=\"memory export vs import · Issue #502 · WebAssembly/WASI\">memory export vs import · Issue #502 · WebAssembly/WASI</a></div><div class=\"message_embed_description\">currently a module exports its memory for wasi. for wasi-threads, a module imports the memory too. it's a bit redundant to both import and export a memory. regardless of what to do for wasi-threads...</div></div></div>",
        "id": 359694496,
        "sender_full_name": "Andrew Brown",
        "timestamp": 1684509647
    },
    {
        "content": "<p>It sounds like the core of the problem boils down to \"the linker wants all of the object files to have the same Wasm features.\" And some object from <code>std</code> has not been built this way. <span class=\"user-mention\" data-user-id=\"264278\">@bjorn3</span> is right that Cargo's way to rebuild <code>std</code> with all the right features is <code>-Zbuild-std</code> but I'm not completely sure for what you're doing that the command will look exactly like that (e.g., you might need to set those target features somewhere in the <code>rustc</code> code based on the target, like <code>if target == wasm32-wasi, then target-features = ...</code>). You're venturing into ground that I have not explored, though, so it may be more helpful if you can share the code or the command you're running?</p>",
        "id": 359696533,
        "sender_full_name": "Andrew Brown",
        "timestamp": 1684510072
    },
    {
        "content": "<p>Just guessing: you're trying to do something like <a href=\"https://github.com/rust-lang/rust/blob/master/compiler/rustc_target/src/spec/wasm64_unknown_unknown.rs#L38\">this</a> but for some reason that does not affect how <code>std</code> is built?</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rust/blob/master/compiler/rustc_target/src/spec/wasm64_unknown_unknown.rs#L38\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/650566fe991d82022fe23ce22a272a4d2b8a9e4a\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f383562616666653563353739633961336331373966323363653665316332643466346235313065306533633264303364613239316337366138666535366630332f727573742d6c616e672f72757374)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rust/blob/master/compiler/rustc_target/src/spec/wasm64_unknown_unknown.rs#L38\" title=\"rust/wasm64_unknown_unknown.rs at master · rust-lang/rust\">rust/wasm64_unknown_unknown.rs at master · rust-lang/rust</a></div><div class=\"message_embed_description\">Empowering everyone to build reliable and efficient software. - rust/wasm64_unknown_unknown.rs at master · rust-lang/rust</div></div></div>",
        "id": 359697737,
        "sender_full_name": "Andrew Brown",
        "timestamp": 1684510311
    },
    {
        "content": "<p>yeah, that's where I picked the idea</p>\n<p>Actually it seems I found a solution to build problems, now it builds and runs hello_world.wasm as expected</p>\n<p>And when I try to run code that spawns a thread it fails as expected<br>\n<code>thread 'main' panicked at 'failed to spawn thread: Error { kind: Unsupported, message: \"operation not supported on this platform\" }' </code> and it's coming from here <a href=\"https://github.com/rust-lang/rust/blob/master/library/std/src/sys/wasi/thread.rs#L17\">https://github.com/rust-lang/rust/blob/master/library/std/src/sys/wasi/thread.rs#L17</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rust/blob/master/library/std/src/sys/wasi/thread.rs#L17\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/d1b550b9c82461e37135ec6b67fb50cb0964db9b\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613438613265616138356638316364313736393537643532303233396333343330373631653562613462613935376131666432313734393330633964626539332f727573742d6c616e672f72757374)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rust/blob/master/library/std/src/sys/wasi/thread.rs#L17\" title=\"rust/thread.rs at master · rust-lang/rust\">rust/thread.rs at master · rust-lang/rust</a></div><div class=\"message_embed_description\">Empowering everyone to build reliable and efficient software. - rust/thread.rs at master · rust-lang/rust</div></div></div>",
        "id": 359746997,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1684523125
    },
    {
        "content": "<p>that's code that does the build <a href=\"https://github.com/rust-lang/rust/compare/master...g0djan:rust:godjan/wasi-threads\">https://github.com/rust-lang/rust/compare/master...g0djan:rust:godjan/wasi-threads</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rust/compare/master...g0djan:rust:godjan/wasi-threads\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/d1b550b9c82461e37135ec6b67fb50cb0964db9b\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613438613265616138356638316364313736393537643532303233396333343330373631653562613462613935376131666432313734393330633964626539332f727573742d6c616e672f72757374)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rust/compare/master...g0djan:rust:godjan/wasi-threads\" title=\"Comparing rust-lang:master...g0djan:godjan/wasi-threads · rust-lang/rust\">Comparing rust-lang:master...g0djan:godjan/wasi-threads · rust-lang/rust</a></div><div class=\"message_embed_description\">Empowering everyone to build reliable and efficient software. - Comparing rust-lang:master...g0djan:godjan/wasi-threads · rust-lang/rust</div></div></div>",
        "id": 359747188,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1684523176
    },
    {
        "content": "<p>so I think <span class=\"user-mention\" data-user-id=\"612401\">@daxpedda</span> already can start trying on top of that</p>\n<p>I started trying myself, but I'm more at stage of reading the proposal and looking through code for other platforms</p>",
        "id": 359747601,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1684523310
    },
    {
        "content": "<p>alright, gonna start soon!<br>\nthanks for all the work so far!</p>",
        "id": 359752723,
        "sender_full_name": "daxpedda",
        "timestamp": 1684525020
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"254110\">@Andrew Brown</span>   My understanding is that you implemented pthread_create in wasi-libc and std:<span aria-label=\"thread\" class=\"emoji emoji-1f9f5\" role=\"img\" title=\"thread\">:thread:</span>spawn should do the same thing from rust. Therefore I suppose the rust implementation should call <a href=\"https://github.com/WebAssembly/wasi-libc/commit/241060c3427c2cdd63aa1e0f7a804ab3f75a413f#diff-a5b02ecfa85206f437c423f8e81e591c2cb056ef77cdcfd12e757281ee1cc3a6R431\">__wasI_thread_spawn</a> as you did in wasi-libc and not supposed to try to call pthread_create from wasi-libc, right? </p>\n<p>So could you explain a bit why is it needed to set wasi_root and whether wasi-libc is supposed to be used from rust anyhow?<br>\nAnd I assume that __wasi_thread_spwan should be exposed in a similar way as it's done in atomics</p>\n<ul>\n<li><a href=\"https://github.com/rust-lang/stdarch/blob/7e2cdc675b92165c5f8c4c794620252be4605e74/crates/core_arch/src/wasm32/atomic.rs#L40\">https://github.com/rust-lang/stdarch/blob/7e2cdc675b92165c5f8c4c794620252be4605e74/crates/core_arch/src/wasm32/atomic.rs#L40</a></li>\n<li><a href=\"https://github.com/rust-lang/rust/blob/master/library/std/src/sys/wasm/atomics/futex.rs#L13\">https://github.com/rust-lang/rust/blob/master/library/std/src/sys/wasm/atomics/futex.rs#L13</a></li>\n</ul>\n<p>thank you for the answer about llvm btw</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-libc/commit/241060c3427c2cdd63aa1e0f7a804ab3f75a413f#diff-a5b02ecfa85206f437c423f8e81e591c2cb056ef77cdcfd12e757281ee1cc3a6R431\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/759769aa0e2ca1c7b9f2ff0605f4b1a91b5970ef\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f303864396439636565326163613532633938323166343033396663326662366266323631643034326331333934373866623331636131393764333933396237662f576562417373656d626c792f776173692d6c6962632f636f6d6d69742f32343130363063333432376332636464363361613165306637613830346162336637356134313366)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-libc/commit/241060c3427c2cdd63aa1e0f7a804ab3f75a413f#diff-a5b02ecfa85206f437c423f8e81e591c2cb056ef77cdcfd12e757281ee1cc3a6R431\" title=\"threads: implement `pthread_create` (#325) · WebAssembly/wasi-libc@241060c\">threads: implement `pthread_create` (#325) · WebAssembly/wasi-libc@241060c</a></div><div class=\"message_embed_description\">* threads: implement `pthread_create`\r\n\r\nAs described in the [`wasi-threads`] proposal, this change implements\r\n`pthread_create` using the new `wasi_thread_spawn(void *arg)` API. As\r\ndescribed ther...</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/stdarch/blob/7e2cdc675b92165c5f8c4c794620252be4605e74/crates/core_arch/src/wasm32/atomic.rs#L40\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/d8422c45491369731b2df48a7beafc042d411b34\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f616135306664393134386337393538353836616166646330623662333434393339646665393734353465343038383430353064363238623933376264366336662f727573742d6c616e672f73746461726368)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/stdarch/blob/7e2cdc675b92165c5f8c4c794620252be4605e74/crates/core_arch/src/wasm32/atomic.rs#L40\" title=\"stdarch/atomic.rs at 7e2cdc675b92165c5f8c4c794620252be4605e74 · rust-lang/stdarch\">stdarch/atomic.rs at 7e2cdc675b92165c5f8c4c794620252be4605e74 · rust-lang/stdarch</a></div><div class=\"message_embed_description\">Rust's standard library vendor-specific APIs and run-time feature detection - stdarch/atomic.rs at 7e2cdc675b92165c5f8c4c794620252be4605e74 · rust-lang/stdarch</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rust/blob/master/library/std/src/sys/wasm/atomics/futex.rs#L13\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/39dea6f71f5bce6b25bad3170350479eef8ad99e\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f396561393036316333316666303836363733303235616238376365353237356632346138323265326163303635663233376661633230303161616537636162382f727573742d6c616e672f72757374)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rust/blob/master/library/std/src/sys/wasm/atomics/futex.rs#L13\" title=\"rust/futex.rs at master · rust-lang/rust\">rust/futex.rs at master · rust-lang/rust</a></div><div class=\"message_embed_description\">Empowering everyone to build reliable and efficient software. - rust/futex.rs at master · rust-lang/rust</div></div></div>",
        "id": 360251760,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1684758189
    },
    {
        "content": "<p>Rust uses wasi-libc for everything. I'm pretty sure that if libstd were to call __wasi_thread_spawn directly as opposed to going through wasi-libc's pthread_create impl that would mess up the thread local storage for both wasi-libc and libstd.</p>",
        "id": 360254143,
        "sender_full_name": "bjorn3",
        "timestamp": 1684758821
    },
    {
        "content": "<p>Okay, thank you<br>\nSo supporting wasi-threads in rust would mean then export pthread_create, call it from std:<span aria-label=\"thread\" class=\"emoji emoji-1f9f5\" role=\"img\" title=\"thread\">:thread:</span>:spawn and overcome all the build and tests problems around it or something like that?</p>",
        "id": 360260869,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1684760299
    },
    {
        "content": "<p>I like what Zulip did to : thread :</p>",
        "id": 360261052,
        "sender_full_name": "Ramon Klass",
        "timestamp": 1684760336
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"614761\">Georgii Rylov</span> <a href=\"#narrow/stream/349267-wasi-threads/topic/rust/near/360260869\">said</a>:</p>\n<blockquote>\n<p>Okay, thank you<br>\nSo supporting wasi-threads in rust would mean then export pthread_create, call it from std:<span aria-label=\"thread\" class=\"emoji emoji-1f9f5\" role=\"img\" title=\"thread\">:thread:</span>:spawn and overcome all the build and tests problems around it or something like that?</p>\n</blockquote>\n<p>I think so.</p>",
        "id": 360290395,
        "sender_full_name": "bjorn3",
        "timestamp": 1684765861
    },
    {
        "content": "<p>(I'm now online!) I think the \"just use <code>pthread_create</code>\" approach is the best bet for now. Though technically one _could_ use <code>__wasi_thread_spawn</code> directly I would bet there would be more issues to fix than just using <code>pthread_create</code>. Plus, since <code>std</code> also uses <code>pthread_create</code> for non-Wasm targets (<a href=\"https://github.com/rust-lang/rust/blob/03761a50a3b26daded09e6da79252692c9bbad5f/library/std/src/sys/unix/thread.rs#L87\">here</a>), there is already precedent for this. It gives us one place to fix things (i.e., wasi-libc) as we test things out in these early days and makes it more likely that objects built by <code>rustc</code> and <code>clang</code> won't have weird incompatibilities.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rust/blob/03761a50a3b26daded09e6da79252692c9bbad5f/library/std/src/sys/unix/thread.rs#L87\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/fdb1e2fed4e0cfd95fbe9a341c31a86f2effd2c2\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f396133306435326666373162363432336364306435383566356132393832306634383061393932333037363232646330623364653364376334333465356436612f727573742d6c616e672f72757374)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rust/blob/03761a50a3b26daded09e6da79252692c9bbad5f/library/std/src/sys/unix/thread.rs#L87\" title=\"rust/thread.rs at 03761a50a3b26daded09e6da79252692c9bbad5f · rust-lang/rust\">rust/thread.rs at 03761a50a3b26daded09e6da79252692c9bbad5f · rust-lang/rust</a></div><div class=\"message_embed_description\">Empowering everyone to build reliable and efficient software. - rust/thread.rs at 03761a50a3b26daded09e6da79252692c9bbad5f · rust-lang/rust</div></div></div>",
        "id": 360330587,
        "sender_full_name": "Andrew Brown",
        "timestamp": 1684775229
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"614761\">@Georgii Rylov</span>, also: congratulations on getting things building!</p>",
        "id": 360331484,
        "sender_full_name": "Andrew Brown",
        "timestamp": 1684775451
    },
    {
        "content": "<p>Thank you =)</p>",
        "id": 360367588,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1684786890
    },
    {
        "content": "<p>Good, <code>pthread_create</code> sounds reasonable</p>",
        "id": 360367645,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1684786916
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"614761\">@Georgii Rylov</span><br>\nI reserved this weekend to work on this. So if you have anything you wanna share feel free to drop it here or commit it to your fork/branch.</p>",
        "id": 361171190,
        "sender_full_name": "daxpedda",
        "timestamp": 1685050785
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"612401\">@daxpedda</span> any updates there?</p>",
        "id": 362750105,
        "sender_full_name": "Enrico Loparco",
        "timestamp": 1685625265
    },
    {
        "content": "<p>I mostly made some progress understanding what has been done and how I'm going to proceed.<br>\nHad a bunch of issues linking, but I got that resolved.</p>\n<p>Gonna continue again this weekend.</p>",
        "id": 362750948,
        "sender_full_name": "daxpedda",
        "timestamp": 1685625415
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"612401\">@daxpedda</span> Hey, sorry for not responding, branch that I shared is still up to date. Do you have any branch where I can follow your progress? I just got myself free to get back to work on wasi-threads</p>",
        "id": 364061983,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1686070609
    },
    {
        "content": "<p>No problem!<br>\nUnfortunately I wasn't able to continue last weekend, so nothing really to share. The weekend before that I just got things to link correctly.</p>",
        "id": 364062765,
        "sender_full_name": "daxpedda",
        "timestamp": 1686070804
    },
    {
        "content": "<p>I plan to continue this weekend again, feel free to drop an update when you have something.</p>",
        "id": 364062884,
        "sender_full_name": "daxpedda",
        "timestamp": 1686070831
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"254110\">@Andrew Brown</span> do you understand why some symbols are needed to be specified in extern \"C\" <a href=\"https://github.com/rust-lang/rust/blob/master/library/std/src/sys/wasi/os.rs#L22\">https://github.com/rust-lang/rust/blob/master/library/std/src/sys/wasi/os.rs#L22</a></p>\n<p>and some others <a href=\"https://github.com/rust-lang/rust/blob/master/library/std/src/sys/wasi/os.rs#L64\">https://github.com/rust-lang/rust/blob/master/library/std/src/sys/wasi/os.rs#L64</a> can be used without specifying in extern</p>\n<p>even both symbols are present in <a href=\"https://github.com/WebAssembly/wasi-libc/blob/a6f871343313220b76009827ed0153586361c0d5/expected/wasm32-wasi-threads/defined-symbols.txt#L1184\">defined-symbols.txt</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rust/blob/master/library/std/src/sys/wasi/os.rs#L22\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/522d235ce3244bd718e2023585daaac74cefac5f\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f366235346332386530623832643435323638343237313438353762353530306239653136303464653362353436376461383762643565623561663763636662352f727573742d6c616e672f72757374)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rust/blob/master/library/std/src/sys/wasi/os.rs#L22\" title=\"rust/os.rs at master · rust-lang/rust\">rust/os.rs at master · rust-lang/rust</a></div><div class=\"message_embed_description\">Empowering everyone to build reliable and efficient software. - rust/os.rs at master · rust-lang/rust</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rust/blob/master/library/std/src/sys/wasi/os.rs#L64\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/522d235ce3244bd718e2023585daaac74cefac5f\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f366235346332386530623832643435323638343237313438353762353530306239653136303464653362353436376461383762643565623561663763636662352f727573742d6c616e672f72757374)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rust/blob/master/library/std/src/sys/wasi/os.rs#L64\" title=\"rust/os.rs at master · rust-lang/rust\">rust/os.rs at master · rust-lang/rust</a></div><div class=\"message_embed_description\">Empowering everyone to build reliable and efficient software. - rust/os.rs at master · rust-lang/rust</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-libc/blob/a6f871343313220b76009827ed0153586361c0d5/expected/wasm32-wasi-threads/defined-symbols.txt#L1184\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/1843fbc0e57a693fa55e03ac7a90b8be657a549a\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f383862306637396333346334353631393737373639616539633337626236333163333462343364353235646337616635613035386338643134653832616265322f576562417373656d626c792f776173692d6c696263)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-libc/blob/a6f871343313220b76009827ed0153586361c0d5/expected/wasm32-wasi-threads/defined-symbols.txt#L1184\" title=\"wasi-libc/defined-symbols.txt at a6f871343313220b76009827ed0153586361c0d5 · WebAssembly/wasi-libc\">wasi-libc/defined-symbols.txt at a6f871343313220b76009827ed0153586361c0d5 · WebAssembly/wasi-libc</a></div><div class=\"message_embed_description\">WASI libc implementation for WebAssembly. Contribute to WebAssembly/wasi-libc development by creating an account on GitHub.</div></div></div>",
        "id": 364062927,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1686070843
    },
    {
        "content": "<p>Alright I will keep it updated in this channel and will push things to my branch if I get any progress</p>",
        "id": 364063165,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1686070901
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"614761\">Georgii Rylov</span> <a href=\"#narrow/stream/349267-wasi-threads/topic/rust/near/364062927\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"254110\">Andrew Brown</span> do you understand why some symbols are needed to be specified in extern \"C\" <a href=\"https://github.com/rust-lang/rust/blob/master/library/std/src/sys/wasi/os.rs#L22\">https://github.com/rust-lang/rust/blob/master/library/std/src/sys/wasi/os.rs#L22</a></p>\n<p>and some others <a href=\"https://github.com/rust-lang/rust/blob/master/library/std/src/sys/wasi/os.rs#L64\">https://github.com/rust-lang/rust/blob/master/library/std/src/sys/wasi/os.rs#L64</a> can be used without specifying in extern</p>\n</blockquote>\n<p>Isn't it just exported through here: <a href=\"https://github.com/rust-lang/rust/blob/3572d7451d1062e8bccf310af6bbf6255091d296/library/std/src/sys/wasi/os.rs#L19\">https://github.com/rust-lang/rust/blob/3572d7451d1062e8bccf310af6bbf6255091d296/library/std/src/sys/wasi/os.rs#L19</a>?</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rust/blob/3572d7451d1062e8bccf310af6bbf6255091d296/library/std/src/sys/wasi/os.rs#L19\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/c66f40df9642e13dc6e3a2105d0f57efd6b785be\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f346233623033633162326630356339303563646666306231636263633133643365346536366136356462363238623366373032613232633937656564616561622f727573742d6c616e672f72757374)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rust/blob/3572d7451d1062e8bccf310af6bbf6255091d296/library/std/src/sys/wasi/os.rs#L19\" title=\"rust/os.rs at 3572d7451d1062e8bccf310af6bbf6255091d296 · rust-lang/rust\">rust/os.rs at 3572d7451d1062e8bccf310af6bbf6255091d296 · rust-lang/rust</a></div><div class=\"message_embed_description\">Empowering everyone to build reliable and efficient software. - rust/os.rs at 3572d7451d1062e8bccf310af6bbf6255091d296 · rust-lang/rust</div></div></div>",
        "id": 364063566,
        "sender_full_name": "daxpedda",
        "timestamp": 1686070992
    },
    {
        "content": "<p>If you follow it you land here: <a href=\"https://github.com/rust-lang/libc/blob/f171596308a616876d518b3491af716bd1629608/src/wasi.rs#L677\">https://github.com/rust-lang/libc/blob/f171596308a616876d518b3491af716bd1629608/src/wasi.rs#L677</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/libc/blob/f171596308a616876d518b3491af716bd1629608/src/wasi.rs#L677\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/cf8163450e0b058116bd1df042bd5f217c3c8b2f\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f663839626639353038346537336230623965356631333431373565333962613039656130636439636335386231323364633637383264313366393133333566322f727573742d6c616e672f6c696263)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/libc/blob/f171596308a616876d518b3491af716bd1629608/src/wasi.rs#L677\" title=\"libc/wasi.rs at f171596308a616876d518b3491af716bd1629608 · rust-lang/libc\">libc/wasi.rs at f171596308a616876d518b3491af716bd1629608 · rust-lang/libc</a></div><div class=\"message_embed_description\">Raw bindings to platform APIs for Rust. Contribute to rust-lang/libc development by creating an account on GitHub.</div></div></div>",
        "id": 364063883,
        "sender_full_name": "daxpedda",
        "timestamp": 1686071073
    },
    {
        "content": "<p>yep, but why <code>strerror_r</code> is just exported but <code>getcwd</code> isn't. Both symbols are defined in wasi-libc</p>",
        "id": 364063897,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1686071076
    },
    {
        "content": "<p>Nice, that's what I was looking for. Thank you!</p>",
        "id": 364063968,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1686071099
    },
    {
        "content": "<p>Ok, it sounds like you guys figured it out but I'll comment anyways: I think <code>getcwd</code> is now exported by the libc crate (see <a href=\"https://docs.rs/libc/0.2.146/libc/fn.getcwd.html\">here</a>) but probably was not when that code was written. See the \"add a few symbols not in upstream <code>libc</code> just yet\" comment up above on line 17. But I bet the <code>__wasilibc_get_environ</code> function is never going to be available in libc (like, it will only be available in wasi-libc) so that has to be manually declared as <code>extern \"C\"</code> so that this code will link to it.</p>",
        "id": 364067184,
        "sender_full_name": "Andrew Brown",
        "timestamp": 1686071895
    },
    {
        "content": "<p>I think we would need to do the same <code>extern \"C\"</code> for any special WASI functions that aren't going to be present in the upstream libc crate (e.g., the thread spawn and entry point)</p>",
        "id": 364067435,
        "sender_full_name": "Andrew Brown",
        "timestamp": 1686071972
    },
    {
        "content": "<p>If <code>__wasilibc_get_environ</code> is stable and won't be removed or changed in the future, then adding it to the libc crate may make sense. It already has a lot of platform specific api's exported by the platform's libc implementation.</p>",
        "id": 364107941,
        "sender_full_name": "bjorn3",
        "timestamp": 1686082943
    },
    {
        "content": "<p>It's used by Rust, so it's basically stable and won't be removed any time soon.</p>",
        "id": 364108388,
        "sender_full_name": "Dan Gohman",
        "timestamp": 1686083098
    },
    {
        "content": "<p>Good news I spawned the first thread, it executed the code passed to the thread but ofc it panicked immediately after that :)</p>\n<p><span class=\"user-mention\" data-user-id=\"612401\">@daxpedda</span> I updated the branch <a href=\"https://github.com/rust-lang/rust/compare/master...g0djan:rust:godjan/wasi-threads?expand=1\">https://github.com/rust-lang/rust/compare/master...g0djan:rust:godjan/wasi-threads?expand=1</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rust/compare/master...g0djan:rust:godjan/wasi-threads?expand=1\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/bf22422d75c52b2aa13d16968729d250037d1aaa\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f323435313631613533646662383132353264616136623833373461333234666365613438623337326361663766306563303730383033646665623162666337612f727573742d6c616e672f72757374)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rust/compare/master...g0djan:rust:godjan/wasi-threads?expand=1\" title=\"Comparing rust-lang:master...g0djan:godjan/wasi-threads · rust-lang/rust\">Comparing rust-lang:master...g0djan:godjan/wasi-threads · rust-lang/rust</a></div><div class=\"message_embed_description\">Empowering everyone to build reliable and efficient software. - Comparing rust-lang:master...g0djan:godjan/wasi-threads · rust-lang/rust</div></div></div>",
        "id": 364789910,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1686303274
    },
    {
        "content": "<p>ran into this error<br>\n<em>cannot recursively acquire mutex', library/std/src/sys/wasi/../unsupported/locks/mutex.rs:20:9</em></p>\n<p>seems primitives were not actually implemented for wasi or wasm yet and this stub was used but now the stub is not suitable<br>\naccording to <a href=\"https://github.com/rust-lang/rust/blob/master/library/std/src/sys/wasi/mod.rs#L32\">https://github.com/rust-lang/rust/blob/master/library/std/src/sys/wasi/mod.rs#L32</a> at least locks mod needs to be implemented, but I presume some of these(or all) will be needed too<br>\n*#[path = \"../unsupported/thread_local_dtor.rs\"]<br>\npub mod thread_local_dtor;<br>\n#[path = \"../unsupported/thread_local_key.rs\"]<br>\npub mod thread_local_key;<br>\n#[path = \"../unsupported/thread_parking.rs\"]*</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rust/blob/master/library/std/src/sys/wasi/mod.rs#L32\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/f98c0d5ac27f017c76588dd1459d799469cead8e\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f636535653339613638363563663131653339656133383165396237373732313832326564356530363264353033393564336161373431383262393164663663352f727573742d6c616e672f72757374)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rust/blob/master/library/std/src/sys/wasi/mod.rs#L32\" title=\"rust/mod.rs at master · rust-lang/rust\">rust/mod.rs at master · rust-lang/rust</a></div><div class=\"message_embed_description\">Empowering everyone to build reliable and efficient software. - rust/mod.rs at master · rust-lang/rust</div></div></div>",
        "id": 364902936,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1686326645
    },
    {
        "content": "<p>Seems implementing locks/pthread_mutex.rs was enough</p>\n<p>Ran this</p>\n<p><code>fn main() {\n    std::env::set_var(\"RUST_BACKTRACE\", \"1\");\n    let mut join = vec![];\n    for i in 0..10 {\n        join.push(std::thread::spawn(move || {\n            println!(\"threadken {}\", i);\n        }));\n    }\n    for j in join {\n        j.join().unwrap();\n    }\n}</code></p>\n<p>All threads were spawned, printed its number and the execution finished with 0 exit code.</p>",
        "id": 365874159,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1686663762
    },
    {
        "content": "<p>I still get some random error when I launch things, but it seems to work correct even with this error</p>\n<p><code>Failed to call function with name __main_void. Error: Exception: unreachable\nLimited backtrace available:</code></p>\n<p>I use wamr lib, probably will need to do a bit more work to make it run on wasmtime</p>",
        "id": 365874674,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1686663860
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"254110\">@Andrew Brown</span> <span class=\"user-mention\" data-user-id=\"612401\">@daxpedda</span> </p>\n<p>Got several questions<br>\n1) Is there a ready testsuite for threads in rust?<br>\n2) To make threads actually useful threads at least some primitives are necessary.</p>\n<div class=\"codehilite\"><pre><span></span><code> - Should this work be done in a separate PR? Is a proposal Issue needed for it?\n -  What primitives would be needed first - mutex, condvar, rwlock ?\n</code></pre></div>\n\n<p>3) Are wasm/wasi targets tested anyhow at the moment? It requires using a wasm runtime like wasmtime or wamr  but I haven't found traces of those in the rust repo</p>",
        "id": 366427434,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1686822381
    },
    {
        "content": "<p>1) I'm not aware of one.<br>\n2) I don't think this is actually relevant for the threads proposals, that's more part of the atomics proposals. I know it's already implemented and working for Wasm, but I don't know what the status of this is in WASI.<br>\n3) I don't know if they are tested in the Rust repo, but you would definitely some runtime unless you are just testing the binary output.</p>",
        "id": 366442396,
        "sender_full_name": "daxpedda",
        "timestamp": 1686824938
    },
    {
        "content": "<p>For (1) it might be useful to take a look at the tests people have contributed to the wasi-threads repository. They can't be used directly (they are designed to test the engine) but you could clone the ideas into new Rust-based tests.</p>",
        "id": 366873007,
        "sender_full_name": "Andrew Brown",
        "timestamp": 1686929800
    },
    {
        "content": "<p>For (2) it was my impression that <span class=\"user-mention\" data-user-id=\"253994\">@Alex Crichton</span> had implemented most of this in the Rust standard library using the atomic instructions from the WebAssembly threads proposal.</p>",
        "id": 366873486,
        "sender_full_name": "Andrew Brown",
        "timestamp": 1686929885
    },
    {
        "content": "<p>I would just test (3) separately for now and we can consult with other Rust contributors about this once a PR is created with the basic spawn functionality.</p>",
        "id": 366873975,
        "sender_full_name": "Andrew Brown",
        "timestamp": 1686929976
    },
    {
        "content": "<p>(2) Okay, I found Alex added it in the <a href=\"https://github.com/rust-lang/rust/commit/b4877edd6750edc12aa2db1953a6551843bfa4b4#diff-e7b12f6ba83a0cdbc3cb87d74fc513179077e78e950b2b5b922fb741b35e65a9\">PR</a> and later Mara added \"futex\" calls and replaced Alex implementation with using existing ones relying on \"futex\" calls <a href=\"https://github.com/rust-lang/rust/commit/8f2913cc2475682da493b06ce81cf1e4fc621f0e#diff-a1361a1163c230d0ca22ff5d3cae121055b49c8a3e1708ce814a5c0d6f2fa34f\">here</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rust/commit/b4877edd6750edc12aa2db1953a6551843bfa4b4#diff-e7b12f6ba83a0cdbc3cb87d74fc513179077e78e950b2b5b922fb741b35e65a9\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/8f8e95713b6dee0fcaa221ff94f591ee7f1d9df6\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f396364313734303733333263626437653763613161313432646164303965336164643030396265626566633834653337356261323738393561656265303864622f727573742d6c616e672f727573742f636f6d6d69742f62343837376564643637353065646331326161326462313935336136353531383433626661346234)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rust/commit/b4877edd6750edc12aa2db1953a6551843bfa4b4#diff-e7b12f6ba83a0cdbc3cb87d74fc513179077e78e950b2b5b922fb741b35e65a9\" title=\"std: Start implementing wasm32 atomics · rust-lang/rust@b4877ed\">std: Start implementing wasm32 atomics · rust-lang/rust@b4877ed</a></div><div class=\"message_embed_description\">This commit is an initial start at implementing the standard library for\nwasm32-unknown-unknown with the experimental `atomics` feature enabled. None of\nthese changes will be visible to users of th...</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rust/commit/8f2913cc2475682da493b06ce81cf1e4fc621f0e#diff-a1361a1163c230d0ca22ff5d3cae121055b49c8a3e1708ce814a5c0d6f2fa34f\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/87dadba172e07d956c598779da3d7f857dad31a9\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f323365346230303430303537343630633665346463313065353165666333383162366533373633313535373636333132623861353964376134393537353764642f727573742d6c616e672f727573742f636f6d6d69742f38663239313363633234373536383264613439336230366365383163663165346663363231663065)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rust/commit/8f2913cc2475682da493b06ce81cf1e4fc621f0e#diff-a1361a1163c230d0ca22ff5d3cae121055b49c8a3e1708ce814a5c0d6f2fa34f\" title=\"Use futex locks on wasm+atomics. · rust-lang/rust@8f2913c\">Use futex locks on wasm+atomics. · rust-lang/rust@8f2913c</a></div><div class=\"message_embed_description\">Empowering everyone to build reliable and efficient software. - Use futex locks on wasm+atomics. · rust-lang/rust@8f2913c</div></div></div>",
        "id": 367870790,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1687255940
    },
    {
        "content": "<p>Thank you</p>",
        "id": 367871073,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1687256012
    },
    {
        "content": "<p>On wasmtime I'm was getting \"2: missing required memory export\" ,  <span class=\"user-mention\" data-user-id=\"254110\">@Andrew Brown</span> do you know that anyone managed to at least compile some C code with WASI-threads and run it on wasmtime?</p>\n<p>I would expect it works on wasi-threads proposal tests, but it seems it doesn't actually <a href=\"https://github.com/WebAssembly/wasi-threads/issues/36#issuecomment-1600945096\">https://github.com/WebAssembly/wasi-threads/issues/36#issuecomment-1600945096</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-threads/issues/36#issuecomment-1600945096\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/62a705367bcf05da343601931298b8c9864f8290\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f386362356463383538626534323963623538313761376364353765666638306261636434653766626635303132633833623938666535303330353732626233612f576562417373656d626c792f776173692d746872656164732f6973737565732f3336)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-threads/issues/36#issuecomment-1600945096\" title=\"test: unable to use `build.sh` · Issue #36 · WebAssembly/wasi-threads\">test: unable to use `build.sh` · Issue #36 · WebAssembly/wasi-threads</a></div><div class=\"message_embed_description\">When I run build.sh, I see the following errors: $ ./build.sh Compiling testsuite/thread_spawn-simple.c testsuite/thread_spawn-simple.c:3:10: fatal error: 'wasi/api.h' file not found #include &lt;wasi...</div></div></div>",
        "id": 368259172,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1687358019
    },
    {
        "content": "<p>Found <a href=\"https://bytecodealliance.org/articles/wasi-threads\">https://bytecodealliance.org/articles/wasi-threads</a> , this example runs</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://bytecodealliance.org/articles/wasi-threads\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/b666ca74a20745aca2566cd241108afdcfa09d04\\/68747470733a2f2f62797465636f6465616c6c69616e63652e6f72672f696d616765732f6176617461722e706e67)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://bytecodealliance.org/articles/wasi-threads\" title=\"Announcing wasi-threads\">Announcing wasi-threads</a></div><div class=\"message_embed_description\">Until now, one piece missing from WebAssembly standalone engines was the ability to spawn threads.Browsers have had this ability for some time via Web Workers, but standalone engines had no standardway to do this. This post describes the...</div></div></div>",
        "id": 368268925,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1687359694
    },
    {
        "content": "<p>Yeah, I was going to point you to that last link; it definitely runs. I think what you are missing with \"required memory export\" is exporting the memory... wasi-threads wants the memory to be imported but the wasi-common crate expects it to be exported as well.</p>",
        "id": 368285892,
        "sender_full_name": "Andrew Brown",
        "timestamp": 1687362707
    },
    {
        "content": "<p>As for the tests, I'm not exactly sure what is going on there. I know I've had some issues running those tests in the past; maybe a max memory size is needed or a configured stack size, like <span class=\"user-mention\" data-user-id=\"513417\">@Marcin Kolny</span> mentioned in the thread.</p>",
        "id": 368286557,
        "sender_full_name": "Andrew Brown",
        "timestamp": 1687362835
    },
    {
        "content": "<p>With tests I checked that neither max-memory or stack-size helps <a href=\"https://github.com/WebAssembly/wasi-threads/issues/36#issuecomment-1601156113\">https://github.com/WebAssembly/wasi-threads/issues/36#issuecomment-1601156113</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-threads/issues/36#issuecomment-1601156113\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/5314d1a63fff0b44bd4c562d5219c2a1e5835202\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f306165663030313332666131336139316263343533363763376131643864336134626332613564373831666637306434303364633533656330623632646162382f576562417373656d626c792f776173692d746872656164732f6973737565732f3336)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-threads/issues/36#issuecomment-1601156113\" title=\"test: unable to use `build.sh` · Issue #36 · WebAssembly/wasi-threads\">test: unable to use `build.sh` · Issue #36 · WebAssembly/wasi-threads</a></div><div class=\"message_embed_description\">When I run build.sh, I see the following errors: $ ./build.sh Compiling testsuite/thread_spawn-simple.c testsuite/thread_spawn-simple.c:3:10: fatal error: 'wasi/api.h' file not found #include &lt;wasi...</div></div></div>",
        "id": 368297876,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1687364991
    },
    {
        "content": "<p>But with Rust I'm exporting it <a href=\"https://github.com/rust-lang/rust/compare/master...g0djan:rust:godjan/wasi-threads?expand=1#diff-6f5295f4c3305d9c6bb8bdaa253b497a35dc3c05efb0f4d319ca82582ddf8391R13\">https://github.com/rust-lang/rust/compare/master...g0djan:rust:godjan/wasi-threads?expand=1#diff-6f5295f4c3305d9c6bb8bdaa253b497a35dc3c05efb0f4d319ca82582ddf8391R13</a></p>\n<p><span class=\"user-mention\" data-user-id=\"513417\">@Marcin Kolny</span> guess is that <code>-pthread</code> should help, but I don't see yet where to add it cause now I get when I add it to pre_link_args</p>\n<p>rustc +stage1 -v --target=wasm32-wasi-threads -pthread /tmp/main.rs<br>\nerror: Unrecognized option: 'p'</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rust/compare/master...g0djan:rust:godjan/wasi-threads?expand=1#diff-6f5295f4c3305d9c6bb8bdaa253b497a35dc3c05efb0f4d319ca82582ddf8391R13\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/beaf5219e4296cfa5d8cffd9c076c914daeb7378\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f633336346366356333633033613261613239323365653438633164326661633236646263636334383733333166383834616533663930326634393335663238332f727573742d6c616e672f72757374)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rust/compare/master...g0djan:rust:godjan/wasi-threads?expand=1#diff-6f5295f4c3305d9c6bb8bdaa253b497a35dc3c05efb0f4d319ca82582ddf8391R13\" title=\"Comparing rust-lang:master...g0djan:godjan/wasi-threads · rust-lang/rust\">Comparing rust-lang:master...g0djan:godjan/wasi-threads · rust-lang/rust</a></div><div class=\"message_embed_description\">Empowering everyone to build reliable and efficient software. - Comparing rust-lang:master...g0djan:godjan/wasi-threads · rust-lang/rust</div></div></div>",
        "id": 368298384,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1687365101
    },
    {
        "content": "<p>I don't think <code>-pthread</code> flag is supported by rustc. But you can look at the flags that are added to the compiler when -pthread is enabled and try adding the same to rustc command.</p>",
        "id": 368320991,
        "sender_full_name": "Marcin Kolny",
        "timestamp": 1687370267
    },
    {
        "content": "<p>The diff in options with <code>-pthread</code><br>\n```➜  rust git:(godjan/wasi-threads) ✗ diff without_pthread with_pthread<br>\n18a19,26</p>\n<blockquote>\n<p>-target-feature<br>\n+atomics<br>\n-target-feature<br>\n+bulk-memory<br>\n-target-feature<br>\n+mutable-globals<br>\n-target-feature<br>\n+sign-ext<br>\n41a50<br>\n-pthread<br>\n45c54<br>\n&lt; /var/folders/gx/qqscz_s14pb4bybmb705ngdc0000gr/T/thread_spawn-simple-7622fa.o</p>\n</blockquote>\n<hr>\n<blockquote>\n<p>/var/folders/gx/qqscz_s14pb4bybmb705ngdc0000gr/T/thread_spawn-simple-fde3aa.o```</p>\n</blockquote>\n<p>I added this options(besides -pthread), but didn't help</p>\n<p>rustc seems to use rust-lld and it doesn't know --export-memory option<br>\n<span class=\"user-mention\" data-user-id=\"254110\">@Andrew Brown</span> does rustc use <code>wasm-ld</code> too or <code>rust-lld</code> solely?</p>",
        "id": 368612874,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1687448982
    },
    {
        "content": "<p>wasm-ld is lld. Lld can act like different linkers depending on how it is called. For example ld.lld is a unix liker, while lld-link.exe is a windows linker.</p>",
        "id": 368615488,
        "sender_full_name": "bjorn3",
        "timestamp": 1687449459
    },
    {
        "content": "<p>Rustc doesn't support the <code>-pthread</code> argument. Every rustc target either doesn't support threads or always supports it. The wasm32-wasi-threads target should unconditionally support threads unless something is wrong in it's implementation.</p>",
        "id": 368615975,
        "sender_full_name": "bjorn3",
        "timestamp": 1687449542
    },
    {
        "content": "<blockquote>\n<p>wasm-ld is lld</p>\n</blockquote>\n<p>Okay, and rust-lld is just another lld?</p>",
        "id": 368616708,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1687449655
    },
    {
        "content": "<p>Yes. I believe it only has a different name to prevent conflicts between the lld version that is part of rustc and an lld version that is globally installed.</p>",
        "id": 368659258,
        "sender_full_name": "bjorn3",
        "timestamp": 1687458425
    },
    {
        "content": "<p>rustup update helped, I needed a fresh version of rust-lld that also supports <code>--export-memory</code> flag. <br>\nAlex's comment helped <a href=\"https://github.com/rust-lang/rust/pull/112922#discussion_r1240001844\">https://github.com/rust-lang/rust/pull/112922#discussion_r1240001844</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rust/pull/112922#discussion_r1240001844\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/f23801266bec35db3841590708127392b6915863\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f636139353163326334343036656232616561303130636332653566313164653831626630636139303361653333643337643430346634343331346561383632652f727573742d6c616e672f727573742f70756c6c2f313132393232)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rust/pull/112922#discussion_r1240001844\" title=\"Add wasm32-wasi-threads target + WASI threads by g0djan · Pull Request #112922 · rust-lang/rust\">Add wasm32-wasi-threads target + WASI threads by g0djan · Pull Request #112922 · rust-lang/rust</a></div><div class=\"message_embed_description\">This PR adds a target proposed in rust-lang/compiler-team#574 by @abrown and implementation of std::thread::spawn for the target wasm32-wasi-threads\nIt was tested on WAMR(WebAssembly-Micro-Runtime)...</div></div></div>",
        "id": 368967892,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1687540066
    },
    {
        "content": "<p>Also I opened PR <a href=\"https://github.com/rust-lang/rust/pull/112922\">https://github.com/rust-lang/rust/pull/112922</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rust/pull/112922\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/f23801266bec35db3841590708127392b6915863\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f636139353163326334343036656232616561303130636332653566313164653831626630636139303361653333643337643430346634343331346561383632652f727573742d6c616e672f727573742f70756c6c2f313132393232)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rust/pull/112922\" title=\"Add wasm32-wasi-threads target + WASI threads by g0djan · Pull Request #112922 · rust-lang/rust\">Add wasm32-wasi-threads target + WASI threads by g0djan · Pull Request #112922 · rust-lang/rust</a></div><div class=\"message_embed_description\">This PR adds a target proposed in rust-lang/compiler-team#574 by @abrown and implementation of std::thread::spawn for the target wasm32-wasi-threads\nIt was tested on WAMR(WebAssembly-Micro-Runtime)...</div></div></div>",
        "id": 368968584,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1687540248
    },
    {
        "content": "<p>Looking at the lld that rustc is using, it should have <code>--export-memory</code>? Can you share what you've been doing which causes lld to print an unexpected argument?</p>",
        "id": 368969782,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1687540528
    },
    {
        "content": "<p>namely <code>export_memory</code> is present in <code>src/llvm-project/lld/wasm/Options.td</code></p>",
        "id": 368969845,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1687540545
    },
    {
        "content": "<blockquote>\n<p>Can you share what you've been doing which causes lld to print an unexpected argument?</p>\n</blockquote>\n<p>It seemed I was using rust-lld from stable and I didn't run <code>rustup update</code> for some time so it didn't support the flag at the time, now I added <code>--export-memory</code> as you suggested and it works after I ran <code>rustup update</code></p>",
        "id": 369039650,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1687561773
    },
    {
        "content": "<p>How are such changes to rust(compiled to wasm/wasi) or wasi-libc get tested if there's no runtime used in CI? It seems there are no tests in this PR for example <a href=\"https://github.com/WebAssembly/wasi-libc/commit/241060c3427c2cdd63aa1e0f7a804ab3f75a413f\">https://github.com/WebAssembly/wasi-libc/commit/241060c3427c2cdd63aa1e0f7a804ab3f75a413f</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-libc/commit/241060c3427c2cdd63aa1e0f7a804ab3f75a413f\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/759769aa0e2ca1c7b9f2ff0605f4b1a91b5970ef\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f303864396439636565326163613532633938323166343033396663326662366266323631643034326331333934373866623331636131393764333933396237662f576562417373656d626c792f776173692d6c6962632f636f6d6d69742f32343130363063333432376332636464363361613165306637613830346162336637356134313366)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-libc/commit/241060c3427c2cdd63aa1e0f7a804ab3f75a413f\" title=\"threads: implement `pthread_create` (#325) · WebAssembly/wasi-libc@241060c\">threads: implement `pthread_create` (#325) · WebAssembly/wasi-libc@241060c</a></div><div class=\"message_embed_description\">* threads: implement `pthread_create`\r\n\r\nAs described in the [`wasi-threads`] proposal, this change implements\r\n`pthread_create` using the new `wasi_thread_spawn(void *arg)` API. As\r\ndescribed ther...</div></div></div>",
        "id": 369039868,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1687561895
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"254110\">@Andrew Brown</span> <span class=\"user-mention\" data-user-id=\"264278\">@bjorn3</span> now I manually add these lines to config.toml to compile <code>rustc</code></p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">[</span><span class=\"n\">target</span><span class=\"p\">.</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasi</span><span class=\"p\">]</span>\n<span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"/opt/wasi-sdk/share/wasi-sysroot\"</span>\n<span class=\"p\">[</span><span class=\"n\">target</span><span class=\"p\">.</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">threads</span><span class=\"p\">]</span>\n<span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"/opt/wasi-sdk/share/wasi-sysroot\"</span>\n</code></pre></div>\n<p>I would assume that I need add downloading wasi-sdk and this lines somewhere in src/bootstrap/defaults so it actually gets to the compiler. But wasm32-wasi is in stable already and when I try to run <code>./x.py build --stage 1 --target wasm32-wasi</code> on master branch it also requires to add the path to wasi-sysroot to config.toml so I'm not sure whether I need to add path to wasi-sysroot anywhere</p>",
        "id": 374258000,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1689080422
    },
    {
        "content": "<p>When the wasm32-wasi target gets build in rust's CI <code>wasi-root</code> is set by CI. You only need to set <code>wasi-root</code> yourself if you are building it yourself.</p>",
        "id": 374259426,
        "sender_full_name": "bjorn3",
        "timestamp": 1689080688
    },
    {
        "content": "<p><a href=\"https://github.com/rust-lang/rust/blob/63ef74b6aa0448cee884324a1f47dde284176895/src/ci/docker/host-x86_64/dist-various-2/Dockerfile#L138\">https://github.com/rust-lang/rust/blob/63ef74b6aa0448cee884324a1f47dde284176895/src/ci/docker/host-x86_64/dist-various-2/Dockerfile#L138</a></p>",
        "id": 374259720,
        "sender_full_name": "bjorn3",
        "timestamp": 1689080738
    },
    {
        "content": "<p>then I probably need to add a similar lines in CI for wasm32-wasi-threads</p>",
        "id": 374260621,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1689080902
    },
    {
        "content": "<p>thank you</p>",
        "id": 374260690,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1689080917
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"264278\">@bjorn3</span> do you know how to upload llvm 16 to <a href=\"http://ci-mirrors.rust-lang.org\">ci-mirrors.rust-lang.org</a> ? LLVM 16 is needed for wasi threads and wasi toolchain in CI is using LLVM 15 now</p>\n<p>It seems to need to be updated the same way as here <a href=\"https://github.com/rust-lang/rust/commit/e8af822423498e1393d71b9fa64f64b6182c5b44\">https://github.com/rust-lang/rust/commit/e8af822423498e1393d71b9fa64f64b6182c5b44</a> but I don't know how to upload <a href=\"https://github.com/llvm/llvm-project/releases/download/llvmorg-16.0.4/clang+llvm-16.0.4-x86_64-linux-gnu-ubuntu-22.04.tar.xz\">https://github.com/llvm/llvm-project/releases/download/llvmorg-16.0.4/clang+llvm-16.0.4-x86_64-linux-gnu-ubuntu-22.04.tar.xz</a> to ci-mirrors</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rust/commit/e8af822423498e1393d71b9fa64f64b6182c5b44\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/7f93742f7a87e3cc2799f20d2e2663620c2efc4f\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f626565633738346336643532633662383836653636313530653532643966663962386432626630316635633932666635653733353363353463663337353933322f727573742d6c616e672f727573742f636f6d6d69742f65386166383232343233343938653133393364373162396661363466363462363138326335623434)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rust/commit/e8af822423498e1393d71b9fa64f64b6182c5b44\" title=\"Update the wasi toolchain. · rust-lang/rust@e8af822\">Update the wasi toolchain. · rust-lang/rust@e8af822</a></div><div class=\"message_embed_description\">Update the WASI build to LLVM 14.0 and the wasi-libc version from wasi-sdk-15.\n\nThis will require a ci-mirrors.rust-lang.org file load. Specifically, we\nneed [this LLVM release tarball] uploaded to...</div></div></div>",
        "id": 374274433,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1689083494
    },
    {
        "content": "<p>Someone on the infra team has to upload it.</p>",
        "id": 374275233,
        "sender_full_name": "bjorn3",
        "timestamp": 1689083637
    },
    {
        "content": "<p>Thanks, I will try to reach out to them</p>",
        "id": 374276173,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1689083784
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"614761\">Georgii Rylov</span> <a href=\"#narrow/stream/349267-wasi-threads/topic/rust/near/374260621\">said</a>:</p>\n<blockquote>\n<p>then I probably need to add a similar lines in CI for wasm32-wasi-threads</p>\n</blockquote>\n<p>I think you might also need to build the wasm32-wasi-threads sysroot somehow, like this script does for wasm32-wasi: <a href=\"https://github.com/rust-lang/rust/blob/63ef74b6aa0448cee884324a1f47dde284176895/src/ci/docker/host-x86_64/dist-various-2/build-wasi-toolchain.sh\">https://github.com/rust-lang/rust/blob/63ef74b6aa0448cee884324a1f47dde284176895/src/ci/docker/host-x86_64/dist-various-2/build-wasi-toolchain.sh</a></p>",
        "id": 374464218,
        "sender_full_name": "Andrew Brown",
        "timestamp": 1689124421
    },
    {
        "content": "<p>Yes, I also think so and already asked infra team in the Rust zulip to upload it to ci-mirrors <a href=\"https://rust-lang.zulipchat.com/#narrow/stream/242791-t-infra/topic/Upload.20LLVM.2016.20to.20ci-mirrors.2Erust-lang.2Eorg/near/374279147\">https://rust-lang.zulipchat.com/#narrow/stream/242791-t-infra/topic/Upload.20LLVM.2016.20to.20ci-mirrors.2Erust-lang.2Eorg/near/374279147</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://rust-lang.zulipchat.com/#narrow/stream/242791-t-infra/topic/Upload.20LLVM.2016.20to.20ci-mirrors.2Erust-lang.2Eorg/near/374279147\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/b470a6a9a9c7305c1cb5dfd01f6a6cac651c1674\\/68747470733a2f2f7a756c69702d617661746172732e73332e616d617a6f6e6177732e636f6d2f343731352f7265616c6d2f69636f6e2e706e673f76657273696f6e3d32)\"></a><div class=\"data-container\"><div class=\"message_embed_description\">If this message does not go away, try reloading the page.</div></div></div>",
        "id": 374544267,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1689153629
    },
    {
        "content": "<p>to upload LLVM 16 *</p>",
        "id": 374555587,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1689155971
    },
    {
        "content": "<p>added it <a href=\"https://github.com/rust-lang/rust/pull/112922/commits/b3597038d1ec3e196ff4e9a7cf9132a1396f0343\">https://github.com/rust-lang/rust/pull/112922/commits/b3597038d1ec3e196ff4e9a7cf9132a1396f0343</a>, though Idk how to test whether it's what needed to be done for ci</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rust/pull/112922/commits/b3597038d1ec3e196ff4e9a7cf9132a1396f0343\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/221f4ce47597e89719c0a350c6f5f5fbb24cb100\\/68747470733a2f2f617661746172732e67697468756275736572636f6e74656e742e636f6d2f752f32333338303538373f733d34303026763d34)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rust/pull/112922/commits/b3597038d1ec3e196ff4e9a7cf9132a1396f0343\" title=\"Add wasm32-wasi-threads target + WASI threads by g0djan · Pull Request #112922 · rust-lang/rust\">Add wasm32-wasi-threads target + WASI threads by g0djan · Pull Request #112922 · rust-lang/rust</a></div><div class=\"message_embed_description\">This PR adds a target proposed in rust-lang/compiler-team#574 by @abrown and implementation of std::thread::spawn for the target wasm32-wasi-threads\nIt was tested on WAMR(WebAssembly-Micro-Runtime)...</div></div></div>",
        "id": 374661308,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1689175908
    },
    {
        "content": "<p>Per policies  <a href=\"https://doc.rust-lang.org/nightly/rustc/target-tier-policy.html#tier-3-target-policy\">https://doc.rust-lang.org/nightly/rustc/target-tier-policy.html#tier-3-target-policy</a> the new target must have maintainers.</p>\n<p>I will add myself but wonder whether anybody volunteers too? It will make it easier for the target to get to Tier-2 as there's a requirement that there should be at least 2 maintainers</p>",
        "id": 376692592,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1689777863
    },
    {
        "content": "<p>**A tier 2 target must have a designated team of developers (the \"target maintainers\") available to consult on target-specific build-breaking issues, or if necessary to develop target-specific language or library implementation details. This team must have at least 2 developers.<br>\nThe target maintainers should not only fix target-specific issues, but should use any such issue as an opportunity to educate the Rust community about portability to their target, and enhance documentation of the target.**</p>\n<p>Those are the responsibilities when it gets to Tier-2</p>",
        "id": 376692741,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1689777895
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"254110\">@Andrew Brown</span> <span class=\"user-mention\" data-user-id=\"253994\">@Alex Crichton</span> <span class=\"user-mention\" data-user-id=\"612401\">@daxpedda</span> <span class=\"user-mention\" data-user-id=\"513417\">@Marcin Kolny</span> <span class=\"user-mention\" data-user-id=\"619002\">@Enrico Loparco</span></p>",
        "id": 376693083,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1689777960
    },
    {
        "content": "<p>I'm happy to volunteer yeah, so feel free to list my name</p>",
        "id": 376693860,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1689778106
    },
    {
        "content": "<p>You can add me as well</p>",
        "id": 376698205,
        "sender_full_name": "Andrew Brown",
        "timestamp": 1689778878
    },
    {
        "content": "<p>Nice will do, thank you guys</p>",
        "id": 376704370,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1689779997
    },
    {
        "content": "<p>Happy to be added too</p>",
        "id": 376723296,
        "sender_full_name": "Marcin Kolny",
        "timestamp": 1689783515
    },
    {
        "content": "<p>Hello, I started playing around and noticed that the join is hanging in case I compile without optimizations</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">sync</span>::<span class=\"n\">mpsc</span><span class=\"p\">;</span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">thread</span><span class=\"p\">;</span>\n\n<span class=\"k\">fn</span> <span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">send</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">recv</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">mpsc</span>::<span class=\"n\">channel</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">thread</span>::<span class=\"n\">spawn</span><span class=\"p\">(</span><span class=\"k\">move</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"fm\">vec!</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">];</span>\n<span class=\"w\">        </span><span class=\"n\">send</span><span class=\"p\">.</span><span class=\"n\">send</span><span class=\"p\">(</span><span class=\"n\">v</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"p\">});</span>\n\n<span class=\"w\">    </span><span class=\"n\">recv</span><span class=\"p\">.</span><span class=\"n\">recv</span><span class=\"p\">().</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"n\">thread</span><span class=\"p\">.</span><span class=\"n\">join</span><span class=\"p\">().</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>Tried both WAMR and Wasmtime.</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>rustc<span class=\"w\"> </span>-v<span class=\"w\"> </span>--target<span class=\"o\">=</span>wasm32-wasi-preview1-threads<span class=\"w\"> </span>test.rs\n./iwasm<span class=\"w\"> </span>test.wasm<span class=\"w\"> </span><span class=\"c1\"># It hangs...</span>\nwasmtime<span class=\"w\"> </span>--wasm-features<span class=\"o\">=</span>threads<span class=\"w\"> </span>--wasi-modules<span class=\"o\">=</span>experimental-wasi-threads<span class=\"w\"> </span>test.wasm<span class=\"w\"> </span><span class=\"c1\"># It hangs...</span>\n</code></pre></div>\n<p>Everything is fine if I compile with <code>rustc -v --target=wasm32-wasi-preview1-threads -O test.rs</code>.<br>\nAny ideas on what I can check? <span class=\"user-mention\" data-user-id=\"253994\">@Alex Crichton</span> <span class=\"user-mention\" data-user-id=\"254110\">@Andrew Brown</span></p>",
        "id": 395138228,
        "sender_full_name": "Enrico Loparco",
        "timestamp": 1696551838
    },
    {
        "content": "<p>Alas I'm not sure myself, that would likely require a good deal of runtime debugging as well as debugging the wasm itself.</p>",
        "id": 395263936,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1696600060
    },
    {
        "content": "<p>Would the core dump functionality of wasmtime help here? Or is there no way to core dump a hang?</p>",
        "id": 395264848,
        "sender_full_name": "bjorn3",
        "timestamp": 1696600371
    },
    {
        "content": "<p>Yeah unfortunately core dumps only happen on traps right now. You can perhaps try out fuel/epochs but those don't interact well with threads right now because the spawned store won't inherit the same configuration options at this time.</p>",
        "id": 395265222,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1696600488
    },
    {
        "content": "<p>My first thought is that there could be something wrong here: <a href=\"https://github.com/rust-lang/rust/blob/64fa0c34d7cb1a2d522414ab2c87024e465bd613/library/std/src/sys/wasm/atomics/futex.rs\">https://github.com/rust-lang/rust/blob/64fa0c34d7cb1a2d522414ab2c87024e465bd613/library/std/src/sys/wasm/atomics/futex.rs</a>. <span class=\"user-mention\" data-user-id=\"253994\">@Alex Crichton</span>, I've been hunting around in the <code>library/std/src/sync/mpsc</code> and <code>library/std/src/sync/mpmc</code> directories to see if we bottom out in a futex somehow but gave up. Is that the case somehow?</p>",
        "id": 395308812,
        "sender_full_name": "Andrew Brown",
        "timestamp": 1696616359
    },
    {
        "content": "<p>I think it bottoms out in mutexes/condvars nowadays, but I'm not up to date really on the implementation of mpsc</p>",
        "id": 395309190,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1696616543
    },
    {
        "content": "<p>I guess I'm just wondering if there is some <code>wait</code> that isn't getting it's appropriate <code>notify</code>... if there were a way to list the waiting <code>wait</code>s when a wasi-thread exits then we could post a log warning or something to help troubleshooting</p>",
        "id": 395310129,
        "sender_full_name": "Andrew Brown",
        "timestamp": 1696616945
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"254110\">@Andrew Brown</span> not that I'm aware of right now</p>",
        "id": 395313909,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1696618707
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"619002\">@Enrico Loparco</span> did you end up figuring this issue out? If not, maybe this PR could help: <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7220\">https://github.com/bytecodealliance/wasmtime/pull/7220</a>.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/pull/7220\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/e860c0a208d13d1f533bfcc182777a63459cc08f\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f366462316365646134376336613835343835623533613936656130386239653030653361313334313637643766623261633134653330633433316131336264342f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f37323230)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/pull/7220\" title=\"threads: log every `wait` and `notify` by abrown · Pull Request #7220 · bytecodealliance/wasmtime\">threads: log every `wait` and `notify` by abrown · Pull Request #7220 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">When troubleshooting deadlocks in WebAssembly modules, it is important to understand which wait instructions are still pending a notify. It would be nice to have some kind of --warn-deadlock-after=...</div></div></div>",
        "id": 396147542,
        "sender_full_name": "Andrew Brown",
        "timestamp": 1697050105
    },
    {
        "content": "<blockquote>\n<p>Hello, I started playing around and noticed that the join is hanging in case I compile without optimizations</p>\n</blockquote>\n<p>Looking again, the hanging is caused by <code>.recv()</code>, not the join as I said initially. And it seems to happen when <code>recv</code> is called before <code>send</code> in the example I posted above.</p>\n<p>Taking a closer look and then I'll try <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7220\">https://github.com/bytecodealliance/wasmtime/pull/7220</a>.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/pull/7220\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/964bc48f032e1d29bca3c58a2af07f8f3c49371f\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f623936303635333030633661633538316538316532313738363030633765303562363365303733373162316531353339663236396630333732643634313663322f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f37323230)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/pull/7220\" title=\"threads: log every `wait` and `notify` by abrown · Pull Request #7220 · bytecodealliance/wasmtime\">threads: log every `wait` and `notify` by abrown · Pull Request #7220 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">When troubleshooting deadlocks in WebAssembly modules, it is important to understand which wait instructions are still pending a notify. It would be nice to have some kind of --warn-deadlock-after=...</div></div></div>",
        "id": 396257062,
        "sender_full_name": "Enrico Loparco",
        "timestamp": 1697105291
    },
    {
        "content": "<p>Naive question, how do I build wasmtime with wasi threads enabled? I used <code>curl https://wasmtime.dev/install.sh -sSf | bash</code> in the past, but if I build from the repo (to get your commit) I get</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>./target/debug/wasmtime<span class=\"w\"> </span>--wasm-features<span class=\"o\">=</span>threads<span class=\"w\"> </span>--wasi-modules<span class=\"o\">=</span>experimental-wasi-threads<span class=\"w\"> </span>/Users/eloparco/dev/forks/wasm-micro-runtime/samples/wasi-threads/build/test.wasm\nerror:<span class=\"w\"> </span>unexpected<span class=\"w\"> </span>argument<span class=\"w\"> </span><span class=\"s1\">'--wasm-features'</span><span class=\"w\"> </span>found\n\n<span class=\"w\">  </span>tip:<span class=\"w\"> </span>a<span class=\"w\"> </span>similar<span class=\"w\"> </span>argument<span class=\"w\"> </span>exists:<span class=\"w\"> </span><span class=\"s1\">'--wasm'</span>\n\nUsage:<span class=\"w\"> </span>wasmtime<span class=\"w\"> </span>&lt;--optimize<span class=\"w\"> </span>&lt;KEY<span class=\"o\">[=</span>VAL<span class=\"o\">[</span>,..<span class=\"o\">]]</span>&gt;<span class=\"p\">|</span>--codegen<span class=\"w\"> </span>&lt;KEY<span class=\"o\">[=</span>VAL<span class=\"o\">[</span>,..<span class=\"o\">]]</span>&gt;<span class=\"p\">|</span>--debug<span class=\"w\"> </span>&lt;KEY<span class=\"o\">[=</span>VAL<span class=\"o\">[</span>,..<span class=\"o\">]]</span>&gt;<span class=\"p\">|</span>--wasm<span class=\"w\"> </span>&lt;KEY<span class=\"o\">[=</span>VAL<span class=\"o\">[</span>,..<span class=\"o\">]]</span>&gt;<span class=\"p\">|</span>--wasi<span class=\"w\"> </span>&lt;KEY<span class=\"o\">[=</span>VAL<span class=\"o\">[</span>,..<span class=\"o\">]]</span>&gt;&gt;<span class=\"w\"> </span>&lt;WASM&gt;...\n\nFor<span class=\"w\"> </span>more<span class=\"w\"> </span>information,<span class=\"w\"> </span>try<span class=\"w\"> </span><span class=\"s1\">'--help'</span>.\n</code></pre></div>",
        "id": 396278337,
        "sender_full_name": "Enrico Loparco",
        "timestamp": 1697113777
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"619002\">Enrico Loparco</span> <a href=\"#narrow/stream/349267-wasi-threads/topic/rust/near/396278337\">said</a>:</p>\n<blockquote>\n<p>Naive question, how do I build wasmtime with wasi threads enabled? I used <code>curl https://wasmtime.dev/install.sh -sSf | bash</code> in the past, but if I build from the repo (to get your commit) I get</p>\n<p><div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>./target/debug/wasmtime<span class=\"w\"> </span>--wasm-features<span class=\"o\">=</span>threads<span class=\"w\"> </span>--wasi-modules<span class=\"o\">=</span>experimental-wasi-threads<span class=\"w\"> </span>/Users/eloparco/dev/forks/wasm-micro-runtime/samples/wasi-threads/build/test.wasm\nerror:<span class=\"w\"> </span>unexpected<span class=\"w\"> </span>argument<span class=\"w\"> </span><span class=\"s1\">'--wasm-features'</span><span class=\"w\"> </span>found\n\n<span class=\"w\">  </span>tip:<span class=\"w\"> </span>a<span class=\"w\"> </span>similar<span class=\"w\"> </span>argument<span class=\"w\"> </span>exists:<span class=\"w\"> </span><span class=\"s1\">'--wasm'</span>\n\nUsage:<span class=\"w\"> </span>wasmtime<span class=\"w\"> </span>&lt;--optimize<span class=\"w\"> </span>&lt;KEY<span class=\"o\">[=</span>VAL<span class=\"o\">[</span>,..<span class=\"o\">]]</span>&gt;<span class=\"p\">|</span>--codegen<span class=\"w\"> </span>&lt;KEY<span class=\"o\">[=</span>VAL<span class=\"o\">[</span>,..<span class=\"o\">]]</span>&gt;<span class=\"p\">|</span>--debug<span class=\"w\"> </span>&lt;KEY<span class=\"o\">[=</span>VAL<span class=\"o\">[</span>,..<span class=\"o\">]]</span>&gt;<span class=\"p\">|</span>--wasm<span class=\"w\"> </span>&lt;KEY<span class=\"o\">[=</span>VAL<span class=\"o\">[</span>,..<span class=\"o\">]]</span>&gt;<span class=\"p\">|</span>--wasi<span class=\"w\"> </span>&lt;KEY<span class=\"o\">[=</span>VAL<span class=\"o\">[</span>,..<span class=\"o\">]]</span>&gt;&gt;<span class=\"w\"> </span>&lt;WASM&gt;...\n\nFor<span class=\"w\"> </span>more<span class=\"w\"> </span>information,<span class=\"w\"> </span>try<span class=\"w\"> </span><span class=\"s1\">'--help'</span>.\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Same exact problem... I'm looking for help as well...</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">/</span><span class=\"n\">mnt</span><span class=\"o\">/</span><span class=\"n\">e</span><span class=\"o\">/</span><span class=\"n\">Code</span><span class=\"o\">/</span><span class=\"n\">WebAssemblyExperiments</span><span class=\"o\">/</span><span class=\"n\">wasmthread</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">mnt</span><span class=\"o\">/</span><span class=\"n\">e</span><span class=\"o\">/</span><span class=\"n\">Code</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">features</span><span class=\"o\">=</span><span class=\"n\">threads</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">modules</span><span class=\"o\">=</span><span class=\"n\">experimental</span><span class=\"o\">-</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">threads</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">t</span>\n<span class=\"n\">hreads</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"n\">error</span>: <span class=\"nc\">unexpected</span><span class=\"w\"> </span><span class=\"n\">argument</span><span class=\"w\"> </span><span class=\"o\">'--</span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">features</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">found</span>\n\n<span class=\"w\">  </span><span class=\"n\">tip</span>: <span class=\"nc\">a</span><span class=\"w\"> </span><span class=\"n\">similar</span><span class=\"w\"> </span><span class=\"n\">argument</span><span class=\"w\"> </span><span class=\"n\">exists</span>: <span class=\"o\">'--</span><span class=\"n\">wasm</span><span class=\"o\">'</span>\n\n<span class=\"n\">Usage</span>: <span class=\"nc\">wasmtime</span><span class=\"w\"> </span><span class=\"o\">&lt;--</span><span class=\"n\">optimize</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">KEY</span><span class=\"p\">[</span><span class=\"o\">=</span><span class=\"n\">VAL</span><span class=\"p\">[,</span><span class=\"o\">..</span><span class=\"p\">]]</span><span class=\"o\">&gt;|--</span><span class=\"n\">codegen</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">KEY</span><span class=\"p\">[</span><span class=\"o\">=</span><span class=\"n\">VAL</span><span class=\"p\">[,</span><span class=\"o\">..</span><span class=\"p\">]]</span><span class=\"o\">&gt;|--</span><span class=\"n\">debug</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">KEY</span><span class=\"p\">[</span><span class=\"o\">=</span><span class=\"n\">VAL</span><span class=\"p\">[,</span><span class=\"o\">..</span><span class=\"p\">]]</span><span class=\"o\">&gt;|--</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">KEY</span><span class=\"p\">[</span><span class=\"o\">=</span><span class=\"n\">VAL</span><span class=\"p\">[,</span><span class=\"o\">..</span><span class=\"p\">]]</span><span class=\"o\">&gt;|--</span><span class=\"n\">wasi</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">KEY</span><span class=\"p\">[</span><span class=\"o\">=</span><span class=\"n\">VAL</span><span class=\"p\">[,</span><span class=\"o\">..</span><span class=\"p\">]]</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">WASM</span><span class=\"o\">&gt;..</span><span class=\"p\">.</span>\n\n<span class=\"n\">For</span><span class=\"w\"> </span><span class=\"n\">more</span><span class=\"w\"> </span><span class=\"n\">information</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kr\">try</span><span class=\"w\"> </span><span class=\"o\">'--</span><span class=\"n\">help</span><span class=\"o\">'</span><span class=\"p\">.</span>\n</code></pre></div>",
        "id": 396598211,
        "sender_full_name": "William Mortl",
        "timestamp": 1697249197
    },
    {
        "content": "<p>Support for wasi-threads is on-by-default, but the CLI flags have changed so nowadays that looks like <code>--wasm threads --wasi threads</code>, or <code>-W threads -S threads</code></p>",
        "id": 396604944,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1697253863
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"254110\">@Andrew Brown</span> Do I need different flags to enable those wait and notify logs? I picked this up from Enrico and executed the example with </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">RUST_LOG</span><span class=\"o\">=</span><span class=\"n\">wasi_common</span><span class=\"o\">=</span><span class=\"n\">trace</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">threads</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">wasi</span><span class=\"w\"> </span><span class=\"n\">threads</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">D</span><span class=\"w\"> </span><span class=\"n\">logging</span><span class=\"o\">=</span><span class=\"n\">y</span><span class=\"w\">  </span><span class=\"o\">..</span><span class=\"p\">.</span>\n</code></pre></div>\n<p>I don't see any wait or notify logs, but I get some WASI related logs eg  <code>TRACE wasi_common::snapshots::preview_1::wasi_snapshot_preview1 &gt; wiggle abi; module=\"wasi_snapshot_preview1\" function=\"fd_write\"</code></p>\n<p>I opened a ticket for the mpsc channels issue here <a href=\"https://github.com/rust-lang/rust/issues/117440\">https://github.com/rust-lang/rust/issues/117440</a></p>\n<p>I think I was able to get a trace from WAMR debugger that points towards a signal from allocation, through channel send.  I created a repo for quick reproduction <a href=\"https://github.com/cimacmillan/WasiThreadsSchedYieldBug\">https://github.com/cimacmillan/WasiThreadsSchedYieldBug</a>. Something interesting is that commenting out the thread join, and replacing with arbitrary thread sleep resolved the issue. Not sure how to dive further past those traces.</p>\n<p>Do you have any guidance on how I can trace it further / anything else I could provide that would help root-cause?</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rust/issues/117440\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/a099ab312d1586d875b94501f20e6a689cec092c\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f393332393735623162366435333963346665633132323463346532316164646537643437346666373538626130353630373033393133663432633533623963382f727573742d6c616e672f727573742f6973737565732f313137343430)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rust/issues/117440\" title=\"wasi threads mpsc channel hang on sched_yield only on debug rust build · Issue #117440 · rust-lang/rust\">wasi threads mpsc channel hang on sched_yield only on debug rust build · Issue #117440 · rust-lang/rust</a></div><div class=\"message_embed_description\">There is an issue with rust wasi threads where using mpsc channel can hang / deadlock only when compiled in debug mode With this code, with wasm32-wasi-preview1-threads target: use std::sync::mpsc;...</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/cimacmillan/WasiThreadsSchedYieldBug\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/a8acd206124679687d747ebe630df95c12444def\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f316138663864323664623134363436373135396632303833356164623031613234376434626262643631356239373363346239316532323365663135363031632f63696d61636d696c6c616e2f576173695468726561647353636865645969656c64427567)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/cimacmillan/WasiThreadsSchedYieldBug\" title=\"GitHub - cimacmillan/WasiThreadsSchedYieldBug\">GitHub - cimacmillan/WasiThreadsSchedYieldBug</a></div><div class=\"message_embed_description\">Contribute to cimacmillan/WasiThreadsSchedYieldBug development by creating an account on GitHub.</div></div></div>",
        "id": 399526242,
        "sender_full_name": "Callum Macmillan",
        "timestamp": 1698760470
    },
    {
        "content": "<p>I don't know what version of Wasmtime you're on, but if it's recent you may want to try <code>WASMTIME_LOG=wasmtime_runtime=trace ...</code>. Someone changed the environment variable for logging recently and I think the log statements you're looking for are in the runtime crate. What happens when you use that?</p>",
        "id": 399534341,
        "sender_full_name": "Andrew Brown",
        "timestamp": 1698762894
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"254110\">@Andrew Brown</span> Thanks, I built wasmtime on commit <code>1d46c2d589d97cd5a13c17c88c8d288f643bdaff</code> and getting this output running <a href=\"https://github.com/cimacmillan/WasiThreadsSchedYieldBug/blob/main/src/main.rs\">this example</a> on debug, before it hangs</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"mi\">2023</span><span class=\"o\">-</span><span class=\"mi\">10</span><span class=\"o\">-</span><span class=\"mi\">31</span><span class=\"n\">T15</span>:<span class=\"mi\">10</span>:<span class=\"mf\">33.642456</span><span class=\"n\">Z</span><span class=\"w\"> </span><span class=\"n\">TRACE</span><span class=\"w\"> </span><span class=\"n\">wasmtime_runtime</span>::<span class=\"n\">memory</span>: <span class=\"nc\">memory</span><span class=\"p\">.</span><span class=\"n\">atomic</span><span class=\"p\">.</span><span class=\"n\">notify</span><span class=\"p\">(</span><span class=\"n\">addr</span><span class=\"o\">=</span><span class=\"mh\">0x105910</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"o\">=</span><span class=\"mi\">4294967295</span><span class=\"p\">)</span>\n<span class=\"n\">receiving</span>\n<span class=\"mi\">2023</span><span class=\"o\">-</span><span class=\"mi\">10</span><span class=\"o\">-</span><span class=\"mi\">31</span><span class=\"n\">T15</span>:<span class=\"mi\">10</span>:<span class=\"mf\">33.642793</span><span class=\"n\">Z</span><span class=\"w\"> </span><span class=\"n\">TRACE</span><span class=\"w\"> </span><span class=\"n\">wasmtime_runtime</span>::<span class=\"n\">memory</span>: <span class=\"nc\">memory</span><span class=\"p\">.</span><span class=\"n\">atomic</span><span class=\"p\">.</span><span class=\"n\">wait32</span><span class=\"p\">(</span><span class=\"n\">addr</span><span class=\"o\">=</span><span class=\"mh\">0x105958</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"mi\">4294967295</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">timeout</span><span class=\"o\">=</span><span class=\"nb\">None</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"n\">sending</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">]</span>\n</code></pre></div>\n<p>Then on release build it outputs </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"mi\">2023</span><span class=\"o\">-</span><span class=\"mi\">10</span><span class=\"o\">-</span><span class=\"mi\">31</span><span class=\"n\">T15</span>:<span class=\"mi\">09</span>:<span class=\"mf\">17.319447</span><span class=\"n\">Z</span><span class=\"w\"> </span><span class=\"n\">TRACE</span><span class=\"w\"> </span><span class=\"n\">wasmtime_runtime</span>::<span class=\"n\">memory</span>: <span class=\"nc\">memory</span><span class=\"p\">.</span><span class=\"n\">atomic</span><span class=\"p\">.</span><span class=\"n\">notify</span><span class=\"p\">(</span><span class=\"n\">addr</span><span class=\"o\">=</span><span class=\"mh\">0x104d78</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"o\">=</span><span class=\"mi\">4294967295</span><span class=\"p\">)</span>\n<span class=\"n\">receiving</span>\n<span class=\"mi\">2023</span><span class=\"o\">-</span><span class=\"mi\">10</span><span class=\"o\">-</span><span class=\"mi\">31</span><span class=\"n\">T15</span>:<span class=\"mi\">09</span>:<span class=\"mf\">17.319740</span><span class=\"n\">Z</span><span class=\"w\"> </span><span class=\"n\">TRACE</span><span class=\"w\"> </span><span class=\"n\">wasmtime_runtime</span>::<span class=\"n\">memory</span>: <span class=\"nc\">memory</span><span class=\"p\">.</span><span class=\"n\">atomic</span><span class=\"p\">.</span><span class=\"n\">wait32</span><span class=\"p\">(</span><span class=\"n\">addr</span><span class=\"o\">=</span><span class=\"mh\">0x104db8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"mi\">4294967295</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">timeout</span><span class=\"o\">=</span><span class=\"nb\">None</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"n\">sending</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">]</span>\n<span class=\"mi\">2023</span><span class=\"o\">-</span><span class=\"mi\">10</span><span class=\"o\">-</span><span class=\"mi\">31</span><span class=\"n\">T15</span>:<span class=\"mi\">09</span>:<span class=\"mf\">17.319958</span><span class=\"n\">Z</span><span class=\"w\"> </span><span class=\"n\">TRACE</span><span class=\"w\"> </span><span class=\"n\">wasmtime_runtime</span>::<span class=\"n\">memory</span>: <span class=\"nc\">memory</span><span class=\"p\">.</span><span class=\"n\">atomic</span><span class=\"p\">.</span><span class=\"n\">notify</span><span class=\"p\">(</span><span class=\"n\">addr</span><span class=\"o\">=</span><span class=\"mh\">0x104db8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"n\">sent</span>\n<span class=\"mi\">2023</span><span class=\"o\">-</span><span class=\"mi\">10</span><span class=\"o\">-</span><span class=\"mi\">31</span><span class=\"n\">T15</span>:<span class=\"mi\">09</span>:<span class=\"mf\">17.319986</span><span class=\"n\">Z</span><span class=\"w\"> </span><span class=\"n\">TRACE</span><span class=\"w\"> </span><span class=\"n\">wasmtime_runtime</span>::<span class=\"n\">memory</span>: <span class=\"nc\">memory</span><span class=\"p\">.</span><span class=\"n\">atomic</span><span class=\"p\">.</span><span class=\"n\">notify</span><span class=\"p\">(</span><span class=\"n\">addr</span><span class=\"o\">=</span><span class=\"mh\">0x105fc0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"mi\">2023</span><span class=\"o\">-</span><span class=\"mi\">10</span><span class=\"o\">-</span><span class=\"mi\">31</span><span class=\"n\">T15</span>:<span class=\"mi\">09</span>:<span class=\"mf\">17.319992</span><span class=\"n\">Z</span><span class=\"w\"> </span><span class=\"n\">TRACE</span><span class=\"w\"> </span><span class=\"n\">wasmtime_runtime</span>::<span class=\"n\">memory</span>: <span class=\"nc\">memory</span><span class=\"p\">.</span><span class=\"n\">atomic</span><span class=\"p\">.</span><span class=\"n\">notify</span><span class=\"p\">(</span><span class=\"n\">addr</span><span class=\"o\">=</span><span class=\"mh\">0x104d2c</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"n\">received</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">]</span>\n</code></pre></div>",
        "id": 399542262,
        "sender_full_name": "Callum Macmillan",
        "timestamp": 1698765121
    },
    {
        "content": "<p>Cool, at least you should be able to see which pairs aren't matching up. I think the other thing that might help you troubleshoot is wasi-backtrace: I'm planning to propose that as a new API this Thursday at the WASI meeting. It will dump a Wasm back trace when called; I found this very, very helpful when trying to debug a recent deadlock.</p>",
        "id": 399547046,
        "sender_full_name": "Andrew Brown",
        "timestamp": 1698766508
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"254110\">@Andrew Brown</span> Thanks Andrew, using those it's easy to see that the atomic waits &amp; notifies don't match up. I added some similar logs to WAMR as well as backtraces on each notify, just as I'm a bit more familiar with that VM.  I added some pastes to <a href=\"https://github.com/rust-lang/rust/issues/117440#issuecomment-1792750313\">https://github.com/rust-lang/rust/issues/117440#issuecomment-1792750313</a>.  The main thread is stuck on wasi futex wait, and it looks like spawned thread isn't sending emitting a notify after sending vec over the channel. Annoyingly, when I add some debug logging to std lib, it changes the program behaviour / fails for a different reason. Would appreciate any ideas / tips you might have of where to look. Otherwise, will keep digging.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rust/issues/117440#issuecomment-1792750313\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/c1b7a06c0c397060381af9dd7015f1a5bbb117cf\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f393639613965663634653236333666613833656331333232306362393161646361393936653430333533623230323034396339393030363639353361653236662f727573742d6c616e672f727573742f6973737565732f313137343430)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rust/issues/117440#issuecomment-1792750313\" title=\"wasi threads mpsc channel hang on sched_yield only on debug rust build · Issue #117440 · rust-lang/rust\">wasi threads mpsc channel hang on sched_yield only on debug rust build · Issue #117440 · rust-lang/rust</a></div><div class=\"message_embed_description\">There is an issue with rust wasi threads where using mpsc channel can hang / deadlock only when compiled in debug mode With this code, with wasm32-wasi-preview1-threads target: use std::sync::mpsc;...</div></div></div>",
        "id": 400169269,
        "sender_full_name": "Callum Macmillan",
        "timestamp": 1699029435
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"663491\">@Callum Macmillan</span> reading over that issue (sorry drive-by comment), have you ruled out stack overflow?</p>",
        "id": 400172544,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1699030541
    },
    {
        "content": "<p>most issues I've seen with wasi threads are that the shadow memory stack overflows in debug mode</p>",
        "id": 400172570,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1699030552
    },
    {
        "content": "<p>and that silently corrupts everything</p>",
        "id": 400172597,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1699030561
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"253994\">@Alex Crichton</span> , <span class=\"user-mention\" data-user-id=\"513417\">@Marcin Kolny</span>  had linked me <a href=\"https://github.com/WebAssembly/wasi-libc/pull/380/commits/41da013047c63089b4c9e15c8de74ea90e2a2921\">this change</a> to set WASM global to the stack limit. I added some quick checking in WAMR and see the global stack pointer overflows only on the debug build in the child thread in the mpmc list channel start send. Then increasing <code>DEFAULT_MIN_STACK_SIZE</code> in std thread for wasi I no longer get the error.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-libc/pull/380/commits/41da013047c63089b4c9e15c8de74ea90e2a2921\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/bb9a0bc84b70472b867096cb93aa08729b5859ad\\/68747470733a2f2f617661746172732e67697468756275736572636f6e74656e742e636f6d2f752f333230313438393f733d34303026763d34)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-libc/pull/380/commits/41da013047c63089b4c9e15c8de74ea90e2a2921\" title=\"Define `__stack_base` and `__stack_limit` globals in debug mode for stack overflow detection by loganek · Pull Request #380 · WebAssembly/wasi-libc\">Define `__stack_base` and `__stack_limit` globals in debug mode for stack overflow detection by loganek · Pull Request #380 · WebAssembly/wasi-libc</a></div><div class=\"message_embed_description\">That enables VMs to implement stack overflow detection or using passes like https://github.com/WebAssembly/binaryen/blob/main/src/passes/StackCheck.cpp\nSee WebAssembly/wasi-threads#12</div></div></div>",
        "id": 400571090,
        "sender_full_name": "Callum Macmillan",
        "timestamp": 1699288689
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"253994\">@Alex Crichton</span> what do you think about increasing the default minimum stack size for wasi threads in Rust, at least for debug builds (<a href=\"https://github.com/rust-lang/rust/blob/master/library/std/src/sys/wasi/thread.rs#L69C11-L69C33\">here</a>)? Had discussed with Marcin that we can make changes to detect overflow at runtime with LLVM (<a href=\"https://github.com/WebAssembly/wasi-threads/issues/12\">issue</a>) so we can exit cleanly rather than deadlock. Then for the wasi mpsc channels <a href=\"https://github.com/rust-lang/rust/issues/117440\">issue</a> the open question is if anything needs to change in rust std lib. I'd presume the default spawned thread stack size should allow that <a href=\"https://github.com/cimacmillan/WasiThreadsSchedYieldBug/blob/main/src/main.rs\">example</a> when compiled in debug mode (and the suite of thread tests). I was also wondering whether it's possible to determine it with static analysis, so that the default thread stack size could be determined at compile time depending on build type / depth of source. In the meantime, we can set the env variable so we're unblocked.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-threads/issues/12\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/b94e34fd78dc0f51373ca813f16c43ed3c9a0fb4\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f346334663064346361393630393436316165393635343938336635613536393738633938333464333264306233323034373031626530373563303634346537612f576562417373656d626c792f776173692d746872656164732f6973737565732f3132)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-threads/issues/12\" title=\"Should runtimes have access to thread's stack boundaries? · Issue #12 · WebAssembly/wasi-threads\">Should runtimes have access to thread's stack boundaries? · Issue #12 · WebAssembly/wasi-threads</a></div><div class=\"message_embed_description\">At the moment runtimes can access stack boundaries reading by reading __heap_base/__data_end (or __stack_high/__stack_low) globals (if they're exported). That works for the main thread, but won't w...</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rust/issues/117440\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/2efdc976cba3a944e4e41b8f3c503ba9c18e37e4\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f323738666138373335636235353332653931366334393565666438343035613464613436663835346639653932653935383332363236323437373939633936622f727573742d6c616e672f727573742f6973737565732f313137343430)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rust/issues/117440\" title=\"wasi threads mpsc channel hang on sched_yield only on debug rust build · Issue #117440 · rust-lang/rust\">wasi threads mpsc channel hang on sched_yield only on debug rust build · Issue #117440 · rust-lang/rust</a></div><div class=\"message_embed_description\">There is an issue with rust wasi threads where using mpsc channel can hang / deadlock only when compiled in debug mode With this code, with wasm32-wasi-preview1-threads target: use std::sync::mpsc;...</div></div></div>",
        "id": 400765557,
        "sender_full_name": "Callum Macmillan",
        "timestamp": 1699371568
    },
    {
        "content": "<p>I definitely agree that the best fix here is to add stack overflow detction through llvm, and I think it'd make sense to just increase the default stack size. Even in debug mode it shouldn't be so easy to overflow the stack</p>",
        "id": 400773411,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1699373749
    },
    {
        "content": "<p>In that I think it makes sense to increase, and increasing only in debug mode sounds ok, but I think it would be ok to always have it increased too</p>",
        "id": 400773525,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1699373779
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"254110\">@Andrew Brown</span> <span class=\"user-mention\" data-user-id=\"253994\">@Alex Crichton</span> is there a reason why max-memory is set in .wasm binary?</p>\n<p>I want to add an api/setting to set max_memory value on vm_creation which will overwrite max-memory of the binary and use it instead</p>\n<p>Usecase: on-call can overwrite it manually in a config in a special circumstances instead of recompiling and maintaining a binary for every different number of max_memory</p>",
        "id": 402211292,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1700047961
    },
    {
        "content": "<p>to WAMR*</p>",
        "id": 402233350,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1700053387
    },
    {
        "content": "<p>WebAssembly validation of shared memories requires a maximum to be specified, so it's a spec-level thing. Runtimes can of course end up having a maximum smaller than this, but runtimes cannot arbitrarily raise this.</p>",
        "id": 402263578,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1700060690
    },
    {
        "content": "<p>Got it, thank you</p>\n<blockquote>\n<p>so it's a spec-level thing</p>\n</blockquote>\n<p>Do you know where can I find these specs?</p>\n<blockquote>\n<p>Runtimes can of course end up having a maximum smaller than this</p>\n</blockquote>\n<p>Okay, <span class=\"user-mention\" data-user-id=\"619002\">@Enrico Loparco</span> made a point that it can be useful too. When there're low-end devices that can't allocate that much memory</p>",
        "id": 402445743,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1700133435
    },
    {
        "content": "<p>The threads spec is located at <a href=\"https://webassembly.github.io/threads/\">https://webassembly.github.io/threads/</a></p>",
        "id": 402503283,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1700150479
    },
    {
        "content": "<blockquote>\n<p>WebAssembly validation of shared memories requires a maximum to be specified, so it's a spec-level thing. Runtimes can of course end up having a maximum smaller than this, but runtimes cannot arbitrarily raise this.</p>\n</blockquote>\n<p>Do you think it would make sense to have that mechanism already in the runtime (without adding an API)? When using shared memory and trying to allocate linear memory, if the allocation (or mmap) fails, we could try allocating half of it (or have a callback registered by the user to decide how to decrease it).</p>\n<p>When using shared memory in production, having a fixed max memory value for all targeted devices is quite a limitation and shipping different wasm files (where the only difference is the max memory value) depending on the specific device is quite unfeasible. <span class=\"user-mention\" data-user-id=\"415404\">@Wenyong Huang</span></p>",
        "id": 424049830,
        "sender_full_name": "Enrico Loparco",
        "timestamp": 1709221849
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"619002\">Enrico Loparco</span> <a href=\"#narrow/stream/349267-wasi-threads/topic/rust/near/424049830\">said</a>:</p>\n<blockquote>\n<blockquote>\n<p>WebAssembly validation of shared memories requires a maximum to be specified, so it's a spec-level thing. Runtimes can of course end up having a maximum smaller than this, but runtimes cannot arbitrarily raise this.</p>\n</blockquote>\n<p>Do you think it would make sense to have that mechanism already in the runtime (without adding an API)? When using shared memory and trying to allocate linear memory, if the allocation (or mmap) fails, we could try allocating half of it (or have a callback registered by the user to decide how to decrease it).</p>\n<p>When using shared memory in production, having a fixed max memory value for all targeted devices is quite a limitation and shipping different wasm files (where the only difference is the max memory value) depending on the specific device is quite unfeasible. <span class=\"user-mention silent\" data-user-id=\"415404\">Wenyong Huang</span></p>\n</blockquote>\n<p>Yes, it should make sense, for shared memory, if allocating memory fails when instantiation, we can decrease the size and allocate again, allocating half of max memory seems a little small, maybe we can decrease one or two pages until allocation succeeds, or as you said, register a callback. Another method may be adding another API like <code>wasm_module_inst_t wasm_runtime_instantiate_ex(module, args, error_buf, error_buf_size)</code>, in which args is a structure containing stack_size, heap_size, max_page_count and so on, so as to specify the max memory size when instantiating.</p>",
        "id": 424137087,
        "sender_full_name": "Wenyong Huang",
        "timestamp": 1709254163
    },
    {
        "content": "<blockquote>\n<p>Another method may be adding another API like wasm_module_inst_t wasm_runtime_instantiate_ex(module, args, error_buf, error_buf_size)</p>\n</blockquote>\n<p>Yes, that approach seems better since it avoids side effects, i.e. max memory value different from the one defined in the module being used without the developer knowing.</p>",
        "id": 424449425,
        "sender_full_name": "Enrico Loparco",
        "timestamp": 1709417091
    }
]