[
    {
        "content": "<p>I've tried using both cargo component and manual wit-bindgen, but both give me an error <code>error: module requires an import interface named </code>env`` converting a preview1 wasm module to a preview2 wasm component ,  and I can't find a reference to it in the example</p>",
        "id": 423206201,
        "sender_full_name": "benwis",
        "timestamp": 1708811199
    },
    {
        "content": "<p>You can use e.g. <code>wasm-tools print</code> to see what functions the module is importing from <code>env</code>, which might point to what's wrong.</p>",
        "id": 423208848,
        "sender_full_name": "Joel Dice",
        "timestamp": 1708813590
    },
    {
        "content": "<p>Interesting, I guess it's these:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"s\">\"env\"</span><span class=\"w\"> </span><span class=\"s\">\"_Znwm\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$_Znwm</span><span class=\"w\"> </span><span class=\"p\">(;</span><span class=\"mi\">0</span><span class=\"p\">;)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"mi\">4</span><span class=\"p\">)))</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"s\">\"env\"</span><span class=\"w\"> </span><span class=\"s\">\"_ZdlPv\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$_ZdlPv</span><span class=\"w\"> </span><span class=\"p\">(;</span><span class=\"mi\">1</span><span class=\"p\">;)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"mi\">0</span><span class=\"p\">)))</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"s\">\"env\"</span><span class=\"w\"> </span><span class=\"s\">\"__cxa_allocate_exception\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$__cxa_allocate_exception</span><span class=\"w\"> </span><span class=\"p\">(;</span><span class=\"mi\">2</span><span class=\"p\">;)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"mi\">4</span><span class=\"p\">)))</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"s\">\"env\"</span><span class=\"w\"> </span><span class=\"s\">\"_ZNSt12length_errorD1Ev\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$_ZNSt12length_errorD1Ev</span><span class=\"w\"> </span><span class=\"p\">(;</span><span class=\"mi\">3</span><span class=\"p\">;)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"mi\">4</span><span class=\"p\">)))</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"s\">\"env\"</span><span class=\"w\"> </span><span class=\"s\">\"__cxa_throw\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$__cxa_throw</span><span class=\"w\"> </span><span class=\"p\">(;</span><span class=\"mi\">4</span><span class=\"p\">;)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"mi\">6</span><span class=\"p\">)))</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"s\">\"env\"</span><span class=\"w\"> </span><span class=\"s\">\"_ZNSt20bad_array_new_lengthD1Ev\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$_ZNSt20bad_array_new_lengthD1Ev</span><span class=\"w\"> </span><span class=\"p\">(;</span><span class=\"mi\">5</span><span class=\"p\">;)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"mi\">4</span><span class=\"p\">)))</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"s\">\"env\"</span><span class=\"w\"> </span><span class=\"s\">\"_ZNSt20bad_array_new_lengthC1Ev\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$_ZNSt20bad_array_new_lengthC1Ev</span><span class=\"w\"> </span><span class=\"p\">(;</span><span class=\"mi\">6</span><span class=\"p\">;)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"mi\">4</span><span class=\"p\">)))</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"s\">\"env\"</span><span class=\"w\"> </span><span class=\"s\">\"_ZnwmSt11align_val_t\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$_ZnwmSt11align_val_t</span><span class=\"w\"> </span><span class=\"p\">(;</span><span class=\"mi\">20</span><span class=\"p\">;)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"mi\">3</span><span class=\"p\">)))</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"s\">\"env\"</span><span class=\"w\"> </span><span class=\"s\">\"_ZdlPvSt11align_val_t\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$_ZdlPvSt11align_val_t</span><span class=\"w\"> </span><span class=\"p\">(;</span><span class=\"mi\">21</span><span class=\"p\">;)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"mi\">2</span><span class=\"p\">)))</span>\n</code></pre></div>",
        "id": 423209022,
        "sender_full_name": "benwis",
        "timestamp": 1708813764
    },
    {
        "content": "<p>Did you by chance link C++ code using the <code>clang</code> command? If so, you may need to link with the <code>clang++</code> command.</p>",
        "id": 423209206,
        "sender_full_name": "Dan Gohman",
        "timestamp": 1708813934
    },
    {
        "content": "<p>Yeah, this was the build command</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"nv\">RUSTFLAGS</span><span class=\"o\">=</span><span class=\"s1\">'-L /opt/wasi-sdk-21.0/share/wasi-sysroot/lib/wasm32-wasi'</span><span class=\"w\"> </span><span class=\"nv\">CXXSTDLIB</span><span class=\"o\">=</span>c++<span class=\"w\"> </span><span class=\"nv\">CC</span><span class=\"o\">=</span>/opt/wasi-sdk-21.0/bin/clang<span class=\"w\"> </span><span class=\"nv\">CXX</span><span class=\"o\">=</span>/opt/wasi-sdk-21.0/bin/clang<span class=\"w\">  </span>cargo<span class=\"w\"> </span>component<span class=\"w\"> </span>build\n</code></pre></div>",
        "id": 423209254,
        "sender_full_name": "benwis",
        "timestamp": 1708814003
    },
    {
        "content": "<p>Yeah; try changing the <code>clang</code> at the end of the <code>CXX</code> to <code>clang++</code></p>",
        "id": 423209352,
        "sender_full_name": "Dan Gohman",
        "timestamp": 1708814087
    },
    {
        "content": "<p>Context: this rust library pulls in a wrapper crate for tree-sitter, which is written (partly) in C++</p>",
        "id": 423209371,
        "sender_full_name": "Joel Dice",
        "timestamp": 1708814107
    },
    {
        "content": "<p>This gives the same error and the same env lines</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\"> </span><span class=\"n\">RUSTFLAGS</span><span class=\"o\">='-</span><span class=\"n\">L</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">opt</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">sdk</span><span class=\"o\">-</span><span class=\"mf\">21.0</span><span class=\"o\">/</span><span class=\"n\">share</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">sysroot</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasi</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">CXXSTDLIB</span><span class=\"o\">=</span><span class=\"n\">c</span><span class=\"o\">++</span><span class=\"w\"> </span><span class=\"n\">CC</span><span class=\"o\">=/</span><span class=\"n\">opt</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">sdk</span><span class=\"o\">-</span><span class=\"mf\">21.0</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"o\">/</span><span class=\"n\">clang</span><span class=\"w\"> </span><span class=\"n\">CXX</span><span class=\"o\">=/</span><span class=\"n\">opt</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">sdk</span><span class=\"o\">-</span><span class=\"mf\">21.0</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"o\">/</span><span class=\"n\">clang</span><span class=\"o\">++</span><span class=\"w\">  </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"n\">build</span>\n</code></pre></div>",
        "id": 423209521,
        "sender_full_name": "benwis",
        "timestamp": 1708814247
    },
    {
        "content": "<p>IIRC, the linker was rust-lld</p>",
        "id": 423210075,
        "sender_full_name": "Joel Dice",
        "timestamp": 1708814783
    },
    {
        "content": "<p>I did get that error at one point that mentioned rust-lld<br>\nThis is the repo if anyone wants to try: <a href=\"https://github.com/benwis/femark/tree/wasi\">https://github.com/benwis/femark/tree/wasi</a><br>\nRunning on latest Rust stable on Arch Linux</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/benwis/femark/tree/wasi\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/b21f9fc59514ad135de8f62a6a1f9bae33b73921\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f663735643739333538366532343263353731393464613935333433646530393561383064393134323437383233636334343266636339303464393434343935612f62656e7769732f66656d61726b)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/benwis/femark/tree/wasi\" title=\"GitHub - benwis/femark at wasi\">GitHub - benwis/femark at wasi</a></div><div class=\"message_embed_description\">A Markdown to HTML compiler and Syntax Highlighter, built using Rust's pulldown-cmark and tree-sitter-highlight crates. Compiled for use via the Node FFI. - GitHub - benwis/femark at wasi</div></div></div>",
        "id": 423210138,
        "sender_full_name": "benwis",
        "timestamp": 1708814870
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"509936\">Joel Dice</span> <a href=\"#narrow/stream/327223-wit-bindgen/topic/module.20requires.20an.20import.20interface.20named.20env/near/423210075\">said</a>:</p>\n<blockquote>\n<p>IIRC, the linker was rust-lld</p>\n</blockquote>\n<p>I could tell cargo to try using an alternate linker, is the lld in the same folder the recommended one?</p>",
        "id": 423211839,
        "sender_full_name": "benwis",
        "timestamp": 1708816489
    },
    {
        "content": "<p>I'd guess rust-lld is fine, but what's needed is to link in the C++ standard library. You may need to add something like <code>-lc++ -lc++abi</code> to the link line..</p>",
        "id": 423213047,
        "sender_full_name": "Dan Gohman",
        "timestamp": 1708817638
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"254083\">Dan Gohman</span> <a href=\"#narrow/stream/327223-wit-bindgen/topic/module.20requires.20an.20import.20interface.20named.20env/near/423213047\">said</a>:</p>\n<blockquote>\n<p>I'd guess rust-lld is fine, but what's needed is to link in the C++ standard library. You may need to add something like <code>-lc++ -lc++abi</code> to the link line..</p>\n</blockquote>\n<p>For a C build noob, where would I add that?</p>",
        "id": 423221493,
        "sender_full_name": "benwis",
        "timestamp": 1708825968
    },
    {
        "content": "<p>Ok I tried adding it to RUSTFLAGS like so </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">RUSTFLAGS</span><span class=\"o\">='-</span><span class=\"n\">L</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">opt</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">sdk</span><span class=\"o\">-</span><span class=\"mf\">21.0</span><span class=\"o\">/</span><span class=\"n\">share</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">sysroot</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasi</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">lstatic</span><span class=\"o\">=</span><span class=\"n\">c</span><span class=\"o\">++</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">lstatic</span><span class=\"o\">=</span><span class=\"n\">c</span><span class=\"o\">++</span><span class=\"n\">abi</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">CXXSTDLIB</span><span class=\"o\">=</span><span class=\"n\">c</span><span class=\"o\">++</span><span class=\"w\"> </span><span class=\"n\">CC</span><span class=\"o\">=/</span><span class=\"n\">opt</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">sdk</span><span class=\"o\">-</span><span class=\"mf\">21.0</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"o\">/</span><span class=\"n\">clang</span><span class=\"w\"> </span><span class=\"n\">CXX</span><span class=\"o\">=/</span><span class=\"n\">opt</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">sdk</span><span class=\"o\">-</span><span class=\"mf\">21.0</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"o\">/</span><span class=\"n\">clang</span><span class=\"o\">++</span><span class=\"w\">  </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"n\">build</span>\n</code></pre></div>\n<p>it seems to throw the same error, I'll play with this a bit. I don't understand where the env interface comes from and what controls what goes into it</p>",
        "id": 423225996,
        "sender_full_name": "benwis",
        "timestamp": 1708830952
    },
    {
        "content": "<p>A thought occurs to me that this might not be a cargo issue, since it successfully builds</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">wit</span><span class=\"o\">-</span><span class=\"n\">parser</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">200.0</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">metadata</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">200.0</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"o\">-</span><span class=\"n\">sitter</span><span class=\"o\">-</span><span class=\"n\">highlight</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">20.1</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">wit</span><span class=\"o\">-</span><span class=\"n\">bindgen</span><span class=\"o\">-</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">19.1</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">wit</span><span class=\"o\">-</span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">200.0</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">femark</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">1.3</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">/</span><span class=\"n\">celCluster</span><span class=\"o\">/</span><span class=\"n\">projects</span><span class=\"o\">/</span><span class=\"n\">femark</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">Finished</span><span class=\"w\"> </span><span class=\"n\">dev</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">unoptimized</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">debuginfo</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mf\">10.67</span><span class=\"n\">s</span>\n<span class=\"w\">    </span><span class=\"n\">Creating</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">celCluster</span><span class=\"o\">/</span><span class=\"n\">projects</span><span class=\"o\">/</span><span class=\"n\">femark</span><span class=\"o\">/</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">debug</span><span class=\"o\">/</span><span class=\"n\">femark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"n\">error</span>: <span class=\"nc\">module</span><span class=\"w\"> </span><span class=\"n\">requires</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">interface</span><span class=\"w\"> </span><span class=\"n\">named</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">env</span><span class=\"err\">`</span>\n\n<span class=\"n\">femark</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"err\"></span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"cp\">$</span><span class=\"o\">!?</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"err\">📦</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">1.3</span><span class=\"w\"> </span><span class=\"n\">via</span><span class=\"w\"> </span><span class=\"err\">🦀</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">.</span><span class=\"mf\">76.0</span><span class=\"w\"> </span><span class=\"n\">took</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"n\">s</span>\n</code></pre></div>\n<p>and it's only the conversion to preview2 that's failing</p>",
        "id": 423229172,
        "sender_full_name": "benwis",
        "timestamp": 1708834111
    },
    {
        "content": "<p>Fixed it, turns out I needed to set <code>CXXFLAGS=-fno-exceptions</code> and that cleared it right up</p>",
        "id": 423236349,
        "sender_full_name": "benwis",
        "timestamp": 1708841405
    }
]