[
    {
        "content": "<p>Currently, <code>UnwindInfo</code> resides in the cranelift-codegen crate e.g. <a href=\"https://github.com/bytecodealliance/wasmtime/blob/c9a3f05afd45961b0b397f97c4ad79cd7a7c807d/cranelift/codegen/src/isa/unwind/systemv.rs#L100\">https://github.com/bytecodealliance/wasmtime/blob/c9a3f05afd45961b0b397f97c4ad79cd7a7c807d/cranelift/codegen/src/isa/unwind/systemv.rs#L100</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/c9a3f05afd45961b0b397f97c4ad79cd7a7c807d/cranelift/codegen/src/isa/unwind/systemv.rs#L100\" style=\"background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/c9a3f05afd45961b0b397f97c4ad79cd7a7c807d/cranelift/codegen/src/isa/unwind/systemv.rs#L100\" title=\"bytecodealliance/wasmtime\">bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">Standalone JIT-style runtime for WebAssembly, using Cranelift - bytecodealliance/wasmtime</div></div></div>",
        "id": 205406922,
        "sender_full_name": "Yury Delendik",
        "timestamp": 1596053141
    },
    {
        "content": "<p>Nothing stops to make this structures more generic to be used with other compilers</p>",
        "id": 205407061,
        "sender_full_name": "Yury Delendik",
        "timestamp": 1596053199
    },
    {
        "content": "<p>Main issue is knowing what stack unwind info can be provided by Lightbeam, and only Lightbeam knows how registers, IP, SP are saved on the stack</p>",
        "id": 205407350,
        "sender_full_name": "Yury Delendik",
        "timestamp": 1596053368
    },
    {
        "content": "<p>As easy hack, <code>CallFrameInstruction</code> in this file, can be made public</p>",
        "id": 205407960,
        "sender_full_name": "Yury Delendik",
        "timestamp": 1596053665
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"253991\">Yury Delendik</span> <a href=\"#narrow/stream/250463-Lightbeam-UnwindInfo/topic/UnwindInfo.20info/near/205407960\">said</a>:</p>\n<blockquote>\n<p>As easy hack, <code>CallFrameInstruction</code> in this file, can be made public</p>\n</blockquote>\n<p>Looks like a potential path forward, let's see what Jack has to say.</p>",
        "id": 205409105,
        "sender_full_name": "Michael Collison",
        "timestamp": 1596054268
    },
    {
        "content": "<p>I'm investigating exactly how this works and how Lightbeam could use it, but we will also need Wasmtime to use <code>CallFrameInstruction</code>s from both Lightbeam and Cranelift instead of only one or the other. Lightbeam is currently not quite up-to-date with the latest Wasmtime because multi-value is causing tests to fail and I don't feel comfortable merging it back in while it's still causing test failures, so if that work is done on the latest version of Wasmtime we'll have to figure out a way to backport it into the version that I've been working on (I believe the last version I merged into my branch is around a month old at this point)</p>",
        "id": 205468802,
        "sender_full_name": "Jack",
        "timestamp": 1596110184
    },
    {
        "content": "<p>So it looks like Lightbeam will just be able to emit <code>CallFrameInstruction::Cfa(RBP, 16)</code> at the start of every function and that should be enough, right?</p>",
        "id": 205470410,
        "sender_full_name": "Jack",
        "timestamp": 1596111337
    },
    {
        "content": "<p>Maybe we could emit <code>rsp + 8</code> at the start of the function and then <code>rsp + 16</code> after <code>push rbp</code>, but we emit the prelude at the start of every function anyway right now. We used to never emit a prelude, and I might change it in the future, but for now our backtraces should be pretty simple.</p>",
        "id": 205470694,
        "sender_full_name": "Jack",
        "timestamp": 1596111511
    },
    {
        "content": "<p>can you post sample/typical function disassembly?</p>",
        "id": 205477953,
        "sender_full_name": "Yury Delendik",
        "timestamp": 1596115600
    },
    {
        "content": "<p>as a hack, simple set of <code>CallFrameInstruction</code> might work, but in practice you will need to save all common registers</p>",
        "id": 205478060,
        "sender_full_name": "Yury Delendik",
        "timestamp": 1596115678
    },
    {
        "content": "<p>(I had plans to recover vmctx from parameters based on unwind info, though it might not be feasible just yet)</p>",
        "id": 205478569,
        "sender_full_name": "Yury Delendik",
        "timestamp": 1596115944
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"253991\">Yury Delendik</span> <a href=\"#narrow/stream/250463-Lightbeam/topic/UnwindInfo.20info/near/205478060\">said</a>:</p>\n<blockquote>\n<p>as a hack, simple set of <code>CallFrameInstruction</code> might work, but in practice you will need to save all common registers</p>\n</blockquote>\n<p>I would say that the fact that we reserve <code>rbp</code> for the stack pointer is a hack, but just generating simple <code>CallFrameInstruction</code>s doesn't sound like a hack if we know that we always generate a prelude. How do you mean that we will need to save all common registers?</p>",
        "id": 205480321,
        "sender_full_name": "Jack",
        "timestamp": 1596116916
    },
    {
        "content": "<p>unwinders follow these instructions, starting from the moment of signal. unwinders often want to know values of specific register (as in my example)</p>",
        "id": 205480732,
        "sender_full_name": "Yury Delendik",
        "timestamp": 1596117145
    },
    {
        "content": "<p>I never use callee-saved registers right now anyway. There's a refactor that I want to do that would make implementing saving callee-saved registers cleanly easy, but I haven't finished that refactor yet.</p>",
        "id": 205480968,
        "sender_full_name": "Jack",
        "timestamp": 1596117289
    },
    {
        "content": "<p>FDE will help you walk the frame, but sometimes data inside of these frames is important too</p>",
        "id": 205480980,
        "sender_full_name": "Yury Delendik",
        "timestamp": 1596117299
    },
    {
        "content": "<p>Ah, I see what you mean</p>",
        "id": 205481044,
        "sender_full_name": "Jack",
        "timestamp": 1596117336
    },
    {
        "content": "<p>So I should be emitting <code>Expression</code>, <code>ValExpression</code>, <code>Register</code> and so forth for every instruction I emit?</p>",
        "id": 205481246,
        "sender_full_name": "Jack",
        "timestamp": 1596117449
    },
    {
        "content": "<p>/me just saying that some effort shall be done so it will not look like a hack</p>",
        "id": 205481257,
        "sender_full_name": "Yury Delendik",
        "timestamp": 1596117455
    },
    {
        "content": "<p>Right, exactly. I'm just trying to find where that boundary is between hack and MVP, because although I don't want it to be a hack, I don't want to implement absolutely full functionality right now because I'm the only one doing the programming on this project and there are other things I need to do.</p>",
        "id": 205481426,
        "sender_full_name": "Jack",
        "timestamp": 1596117534
    },
    {
        "content": "<p>normally only handful of commands it needed, e.g. Cfa, Offset, maybe RememberState/RestoreState</p>",
        "id": 205481518,
        "sender_full_name": "Yury Delendik",
        "timestamp": 1596117585
    },
    {
        "content": "<p>Should I be annotating every time the stack pointer changes, or is it enough to just tell the debugger to use <code>RBP</code>?</p>",
        "id": 205481631,
        "sender_full_name": "Jack",
        "timestamp": 1596117633
    },
    {
        "content": "<p>Because I don't use rbp as a general-purpose register right now, I always push it at the start of the function and reserve it for the stack pointer (same reason as why I don't use callee-saved registers - I want to wait until some refactoring is done before I use it as a general-purpose register)</p>",
        "id": 205481869,
        "sender_full_name": "Jack",
        "timestamp": 1596117744
    },
    {
        "content": "<p>/me would like to see typical output from lightbeam</p>",
        "id": 205481952,
        "sender_full_name": "Yury Delendik",
        "timestamp": 1596117792
    },
    {
        "content": "<p>Sure, one moment</p>",
        "id": 205482135,
        "sender_full_name": "Jack",
        "timestamp": 1596117874
    },
    {
        "content": "<p>Wasm:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$fib</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"s\">&quot;fib&quot;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">param</span><span class=\"w\"> </span><span class=\"cp\">$p0</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">local</span><span class=\"w\"> </span><span class=\"cp\">$l1</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">local</span><span class=\"p\">.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"cp\">$l1</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"p\">.</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">))</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">block</span><span class=\"w\"> </span><span class=\"cp\">$B0</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">br_if</span><span class=\"w\"> </span><span class=\"cp\">$B0</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"p\">.</span><span class=\"n\">lt_u</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"p\">(</span><span class=\"n\">local</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"cp\">$p0</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"p\">.</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">)))</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">local</span><span class=\"p\">.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"cp\">$l1</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"p\">.</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">))</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"k\">loop</span><span class=\"w\"> </span><span class=\"cp\">$L1</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"p\">(</span><span class=\"n\">local</span><span class=\"p\">.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"cp\">$l1</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"p\">.</span><span class=\"n\">add</span><span class=\"w\"></span>\n<span class=\"w\">          </span><span class=\"p\">(</span><span class=\"n\">call</span><span class=\"w\"> </span><span class=\"cp\">$fib</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"p\">.</span><span class=\"n\">add</span><span class=\"w\"></span>\n<span class=\"w\">              </span><span class=\"p\">(</span><span class=\"n\">local</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"cp\">$p0</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">              </span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"p\">.</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">)))</span><span class=\"w\"></span>\n<span class=\"w\">          </span><span class=\"p\">(</span><span class=\"n\">local</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"cp\">$l1</span><span class=\"p\">)))</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"p\">(</span><span class=\"n\">br_if</span><span class=\"w\"> </span><span class=\"cp\">$L1</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"p\">.</span><span class=\"n\">gt_u</span><span class=\"w\"></span>\n<span class=\"w\">          </span><span class=\"p\">(</span><span class=\"n\">local</span><span class=\"p\">.</span><span class=\"n\">tee</span><span class=\"w\"> </span><span class=\"cp\">$p0</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"p\">.</span><span class=\"n\">add</span><span class=\"w\"></span>\n<span class=\"w\">              </span><span class=\"p\">(</span><span class=\"n\">local</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"cp\">$p0</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">              </span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"p\">.</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"mi\">2</span><span class=\"p\">)))</span><span class=\"w\"></span>\n<span class=\"w\">          </span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"p\">.</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)))))</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">local</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"cp\">$l1</span><span class=\"p\">))</span><span class=\"w\"></span>\n</code></pre></div>\n\n\n<p>Assembly:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"mi\">131</span><span class=\"w\"> </span><span class=\"n\">bytes</span>:\n   <span class=\"mi\">0</span>:   <span class=\"mi\">55</span><span class=\"w\">                          </span><span class=\"n\">push</span><span class=\"w\">    </span><span class=\"n\">rbp</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mi\">1</span>:   <span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">e5</span><span class=\"w\">                    </span><span class=\"n\">mov</span><span class=\"w\"> </span><span class=\"n\">rbp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">rsp</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mi\">4</span>:   <span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"mi\">81</span><span class=\"w\"> </span><span class=\"n\">fa</span><span class=\"w\"> </span><span class=\"mi\">02</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">        </span><span class=\"n\">cmp</span><span class=\"w\"> </span><span class=\"n\">edx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"n\">b</span>:   <span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"n\">b8</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">           </span><span class=\"n\">mov</span><span class=\"w\"> </span><span class=\"n\">eax</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">11</span>:   <span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">82</span><span class=\"w\"> </span><span class=\"mi\">63</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">           </span><span class=\"n\">jb</span><span class=\"w\">  </span><span class=\"mh\">0x7a</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">17</span>:   <span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"n\">b8</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">           </span><span class=\"n\">mov</span><span class=\"w\"> </span><span class=\"n\">eax</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"n\">d</span>:   <span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"n\">a5</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">        </span><span class=\"n\">lea</span><span class=\"w\"> </span><span class=\"n\">rsp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">rbp</span><span class=\"p\">]</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">24</span>:   <span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">d1</span><span class=\"w\">                    </span><span class=\"n\">mov</span><span class=\"w\"> </span><span class=\"n\">rcx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">rdx</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">27</span>:   <span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"mi\">81</span><span class=\"w\"> </span><span class=\"n\">c1</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\">        </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">ecx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mh\">0xffffffff</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"n\">e</span>:   <span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"mi\">52</span><span class=\"w\">                       </span><span class=\"n\">push</span><span class=\"w\">    </span><span class=\"n\">rdx</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">30</span>:   <span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"mi\">50</span><span class=\"w\">                       </span><span class=\"n\">push</span><span class=\"w\">    </span><span class=\"n\">rax</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">32</span>:   <span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"mi\">51</span><span class=\"w\">                       </span><span class=\"n\">push</span><span class=\"w\">    </span><span class=\"n\">rcx</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">34</span>:   <span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"n\">a4</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\"> </span><span class=\"n\">f8</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\">     </span><span class=\"n\">lea</span><span class=\"w\"> </span><span class=\"n\">rsp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">rsp</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"p\">]</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"n\">c</span>:   <span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"mi\">94</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\"> </span><span class=\"mi\">08</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">     </span><span class=\"n\">mov</span><span class=\"w\"> </span><span class=\"n\">rdx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">qword</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">rsp</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"p\">]</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">44</span>:   <span class=\"nc\">e8</span><span class=\"w\"> </span><span class=\"n\">b7</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\">              </span><span class=\"n\">call</span><span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">49</span>:   <span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"mi\">03</span><span class=\"w\"> </span><span class=\"mi\">84</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">     </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">eax</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">dword</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">rsp</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mh\">0x10</span><span class=\"p\">]</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">51</span>:   <span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\"> </span><span class=\"mi\">18</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">     </span><span class=\"n\">mov</span><span class=\"w\"> </span><span class=\"n\">rcx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">qword</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">rsp</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mh\">0x18</span><span class=\"p\">]</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">59</span>:   <span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"mi\">81</span><span class=\"w\"> </span><span class=\"n\">c1</span><span class=\"w\"> </span><span class=\"n\">fe</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\">        </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">ecx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mh\">0xfffffffe</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">60</span>:   <span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"mi\">81</span><span class=\"w\"> </span><span class=\"n\">f9</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">        </span><span class=\"n\">cmp</span><span class=\"w\"> </span><span class=\"n\">ecx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">67</span>:   <span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">ca</span><span class=\"w\">                    </span><span class=\"n\">mov</span><span class=\"w\"> </span><span class=\"n\">rdx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">rcx</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">6</span><span class=\"n\">a</span>:   <span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">ec</span><span class=\"w\">                    </span><span class=\"n\">mov</span><span class=\"w\"> </span><span class=\"n\">rsp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">rbp</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">6</span><span class=\"n\">d</span>:   <span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">87</span><span class=\"w\"> </span><span class=\"n\">aa</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\">           </span><span class=\"n\">ja</span><span class=\"w\">  </span><span class=\"mh\">0x1d</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">73</span>:   <span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"n\">a5</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">        </span><span class=\"n\">lea</span><span class=\"w\"> </span><span class=\"n\">rsp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">rbp</span><span class=\"p\">]</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">7</span><span class=\"n\">a</span>:   <span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"n\">a5</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">        </span><span class=\"n\">lea</span><span class=\"w\"> </span><span class=\"n\">rsp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">rbp</span><span class=\"p\">]</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">81</span>:   <span class=\"mi\">5</span><span class=\"n\">d</span><span class=\"w\">                          </span><span class=\"n\">pop</span><span class=\"w\"> </span><span class=\"n\">rbp</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">82</span>:   <span class=\"nc\">c3</span><span class=\"w\">                          </span><span class=\"n\">ret</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 205482866,
        "sender_full_name": "Jack",
        "timestamp": 1596118241
    },
    {
        "content": "<p>so at 1, you will need to change offset of CFA, and at 4 define CFA at rbp</p>",
        "id": 205484190,
        "sender_full_name": "Yury Delendik",
        "timestamp": 1596118844
    },
    {
        "content": "<p>Right, ok so that's what I expected. Is there anything else I'd need to do right now?</p>",
        "id": 205484431,
        "sender_full_name": "Jack",
        "timestamp": 1596118960
    },
    {
        "content": "<p>here is what cranelift does <a href=\"https://gist.github.com/yurydelendik/1dc5f78bb5edc67041100d7b3b837835#file-fib-frames-dump-L20-L24\">https://gist.github.com/yurydelendik/1dc5f78bb5edc67041100d7b3b837835#file-fib-frames-dump-L20-L24</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://gist.github.com/yurydelendik/1dc5f78bb5edc67041100d7b3b837835#file-fib-frames-dump-L20-L24\" style=\"background-image: url(https://github.githubassets.com/images/modules/gists/gist-og-image.png)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://gist.github.com/yurydelendik/1dc5f78bb5edc67041100d7b3b837835#file-fib-frames-dump-L20-L24\" title=\"fib.wat with cranelift\">fib.wat with cranelift</a></div><div class=\"message_embed_description\">fib.wat with cranelift. GitHub Gist: instantly share code, notes, and snippets.</div></div></div>",
        "id": 205484510,
        "sender_full_name": "Yury Delendik",
        "timestamp": 1596119000
    },
    {
        "content": "<p>BTW my lightbeam output is</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"mi\">0000000000000000</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">__wasm_function_0</span><span class=\"o\">&gt;</span>:\n   <span class=\"mi\">0</span>:   <span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"mi\">81</span><span class=\"w\"> </span><span class=\"n\">fa</span><span class=\"w\"> </span><span class=\"mi\">02</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">    </span><span class=\"n\">rex</span><span class=\"w\"> </span><span class=\"n\">cmp</span><span class=\"w\"> </span><span class=\"cp\">$</span><span class=\"mh\">0x2</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">edx</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mi\">7</span>:   <span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"n\">b8</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">rex</span><span class=\"w\"> </span><span class=\"n\">mov</span><span class=\"w\"> </span><span class=\"cp\">$</span><span class=\"mh\">0x1</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">eax</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"n\">d</span>:   <span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">82</span><span class=\"w\"> </span><span class=\"mi\">52</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">jb</span><span class=\"w\">     </span><span class=\"mi\">65</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">__wasm_function_0</span><span class=\"o\">+</span><span class=\"mh\">0x65</span><span class=\"o\">&gt;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">13</span>:   <span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"n\">b8</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">rex</span><span class=\"w\"> </span><span class=\"n\">mov</span><span class=\"w\"> </span><span class=\"cp\">$</span><span class=\"mh\">0x1</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">eax</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">19</span>:   <span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">d1</span><span class=\"w\">                </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rdx</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"n\">c</span>:   <span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"mi\">81</span><span class=\"w\"> </span><span class=\"n\">c1</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\">    </span><span class=\"n\">rex</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"cp\">$</span><span class=\"mh\">0xffffffff</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">ecx</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">23</span>:   <span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"mi\">52</span><span class=\"w\">                   </span><span class=\"n\">rex</span><span class=\"w\"> </span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">rdx</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">25</span>:   <span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"mi\">50</span><span class=\"w\">                   </span><span class=\"n\">rex</span><span class=\"w\"> </span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">rax</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">27</span>:   <span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"mi\">51</span><span class=\"w\">                   </span><span class=\"n\">rex</span><span class=\"w\"> </span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">29</span>:   <span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"mi\">94</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">    </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"mh\">0x0</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">),</span><span class=\"o\">%</span><span class=\"n\">rdx</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">30</span>:   <span class=\"mi\">00</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">31</span>:   <span class=\"nc\">e8</span><span class=\"w\"> </span><span class=\"n\">ca</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\">          </span><span class=\"n\">callq</span><span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">__wasm_function_0</span><span class=\"o\">&gt;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">36</span>:   <span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"mi\">03</span><span class=\"w\"> </span><span class=\"mi\">84</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\"> </span><span class=\"mi\">08</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">    </span><span class=\"n\">rex</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"mh\">0x8</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">),</span><span class=\"o\">%</span><span class=\"n\">eax</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"n\">d</span>:   <span class=\"mi\">00</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"n\">e</span>:   <span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">    </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"mh\">0x10</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">),</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">45</span>:   <span class=\"mi\">00</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">46</span>:   <span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"mi\">81</span><span class=\"w\"> </span><span class=\"n\">c1</span><span class=\"w\"> </span><span class=\"n\">fe</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\">    </span><span class=\"n\">rex</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"cp\">$</span><span class=\"mh\">0xfffffffe</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">ecx</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"n\">d</span>:   <span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"mi\">81</span><span class=\"w\"> </span><span class=\"n\">f9</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">    </span><span class=\"n\">rex</span><span class=\"w\"> </span><span class=\"n\">cmp</span><span class=\"w\"> </span><span class=\"cp\">$</span><span class=\"mh\">0x1</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">ecx</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">54</span>:   <span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">ca</span><span class=\"w\">                </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">rdx</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">57</span>:   <span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"n\">a4</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\"> </span><span class=\"mi\">18</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">    </span><span class=\"n\">lea</span><span class=\"w\">    </span><span class=\"mh\">0x18</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">),</span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">5</span><span class=\"n\">e</span>:   <span class=\"mi\">00</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">5</span><span class=\"n\">f</span>:   <span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">87</span><span class=\"w\"> </span><span class=\"n\">b4</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\">       </span><span class=\"n\">ja</span><span class=\"w\">     </span><span class=\"mi\">19</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">__wasm_function_0</span><span class=\"o\">+</span><span class=\"mh\">0x19</span><span class=\"o\">&gt;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">65</span>:   <span class=\"nc\">c3</span><span class=\"w\">                      </span><span class=\"n\">retq</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 205484801,
        "sender_full_name": "Yury Delendik",
        "timestamp": 1596119139
    },
    {
        "content": "<p>So the upstream version of Lightbeam at bytecodealliance/wasmtime generates different code to the current version that I'm using. The main difference is that the upstream version generates the prelude and resets <code>rsp</code> by doing <code>mov rsp, rbp</code>, but that's not necessary. I might actually remove the prelude again, it doesn't look like it'd be too much more difficult to generate the <code>CallFrameInstruction</code>s for the code that you've posted</p>",
        "id": 205485268,
        "sender_full_name": "Jack",
        "timestamp": 1596119359
    },
    {
        "content": "<p>in the case above CFA needs to be offset at least after 29 and adjusted at 31/36, but preferably after each push + registers saved (since there is no dedicated frame base)</p>",
        "id": 205485271,
        "sender_full_name": "Yury Delendik",
        "timestamp": 1596119360
    },
    {
        "content": "<p>so it you are getting rid off dedicated frame base (BP), than you will need to take care of maintaining proper CFA</p>",
        "id": 205485634,
        "sender_full_name": "Yury Delendik",
        "timestamp": 1596119527
    },
    {
        "content": "<p>notice that CIE says it is in SP, so if SP changes you need to have CfaOffset</p>",
        "id": 205485721,
        "sender_full_name": "Yury Delendik",
        "timestamp": 1596119568
    },
    {
        "content": "<p>/me hopes it makes sense</p>",
        "id": 205485762,
        "sender_full_name": "Yury Delendik",
        "timestamp": 1596119583
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"253989\">@Peter Huene</span> just to see if Windows will need more arrangements</p>",
        "id": 205523416,
        "sender_full_name": "Yury Delendik",
        "timestamp": 1596138191
    },
    {
        "content": "<p>So now we've got an idea of how Lightbeam's side of this will work, how do you think we should go about allowing Wasmtime to consume this metadata?</p>",
        "id": 205572323,
        "sender_full_name": "Jack",
        "timestamp": 1596187142
    },
    {
        "content": "<p>Currently lightbeam creates <code>Compilation</code> just from the (code) buffer (at crates/environ/src/lightbeam.rs). It is marked with comment at <a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/environ/src/compilation.rs#L52\">https://github.com/bytecodealliance/wasmtime/blob/main/crates/environ/src/compilation.rs#L52</a> -- all generated UnwindInfo are consumed by Wasmtime if present in the <code>CompiledFunction</code></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/environ/src/compilation.rs#L52\" style=\"background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/environ/src/compilation.rs#L52\" title=\"bytecodealliance/wasmtime\">bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">Standalone JIT-style runtime for WebAssembly, using Cranelift - bytecodealliance/wasmtime</div></div></div>",
        "id": 205590967,
        "sender_full_name": "Yury Delendik",
        "timestamp": 1596202869
    },
    {
        "content": "<p>I recommend to move from_buffer logic to <a href=\"http://lightbeam.rs\">lightbeam.rs</a> and just create Compilation/CompiledFunction there with UnwindInfo generated by the lightbeam.</p>",
        "id": 205595250,
        "sender_full_name": "Yury Delendik",
        "timestamp": 1596205068
    },
    {
        "content": "<p>to troubleshot you can use <code>wasmtime wasm2obj -g ...</code> -- it will create obj file that you can further inspect using <code>objdump -d</code> and <code>dwarfdump -debug-frame</code></p>",
        "id": 205597627,
        "sender_full_name": "Yury Delendik",
        "timestamp": 1596206202
    },
    {
        "content": "<p><a href=\"https://github.com/bytecodealliance/wasmtime/pull/2086\">https://github.com/bytecodealliance/wasmtime/pull/2086</a> addresses removal of <code>from_buffer</code></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/pull/2086\" style=\"background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/pull/2086\" title=\"Refactor where results of compilation are stored by alexcrichton · Pull Request #2086 · bytecodealliance/wasmtime\">Refactor where results of compilation are stored by alexcrichton · Pull Request #2086 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">This commit refactors the internals of compilation in Wasmtime to change\nwhere results of individual function compilation are stored. Previously\ncompilation resulted in many maps being returned, an...</div></div></div>",
        "id": 205810740,
        "sender_full_name": "Yury Delendik",
        "timestamp": 1596469698
    },
    {
        "content": "<p>Any progress on the subject? The <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2117\">https://github.com/bytecodealliance/wasmtime/pull/2117</a> landed, will it affect unwindinfo progress?</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/pull/2117\" style=\"background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/pull/2117\" title=\"wasmtime: Extract cranelift/lightbeam compilers to separate crates by alexcrichton · Pull Request #2117 · bytecodealliance/wasmtime\">wasmtime: Extract cranelift/lightbeam compilers to separate crates by alexcrichton · Pull Request #2117 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">This commit extracts the two implementations of Compiler into two\nseparate crates, wasmtime-cranelfit and wasmtime-lightbeam. The\nwasmtime-jit crate then depends on these two and instantiates them\n...</div></div></div>",
        "id": 207527348,
        "sender_full_name": "Yury Delendik",
        "timestamp": 1597933300
    },
    {
        "content": "<p>So to keep everyone informed, I quit Parity and it's unlikely that I will continue working on the unwind info before my last day of work. Keep this chat open though, it's very possible that Michael or Dmitriy will work on it in the future.</p>",
        "id": 209493065,
        "sender_full_name": "Jack",
        "timestamp": 1599646531
    },
    {
        "content": "<p>Unwind data structures were made public at <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2357\">https://github.com/bytecodealliance/wasmtime/pull/2357</a> -- it can make life easier for the lightbeam</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/pull/2357\" style=\"background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/pull/2357\" title=\"cranelift: refactor unwind logic to accommodate multiple backends   by yurydelendik · Pull Request #2357 · bytecodealliance/wasmtime\">cranelift: refactor unwind logic to accommodate multiple backends   by yurydelendik · Pull Request #2357 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">Prepares code for #2313\n\nMake cranelift_codegen::isa::unwind::input public\nMove UnwindCode&#39;s common offset field out of the structure\nMake MachCompileResult::unwind_info more generic\nRecord ini...</div></div></div>",
        "id": 215852377,
        "sender_full_name": "Yury Delendik",
        "timestamp": 1604672818
    }
]