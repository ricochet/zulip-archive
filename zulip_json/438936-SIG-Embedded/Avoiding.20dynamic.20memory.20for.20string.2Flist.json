[
    {
        "content": "<p>While trying to design a good API for string/list without memory allocation, I looked at <a href=\"https://github.com/WebAssembly/component-model/issues/175\">caller provided buffers</a> and <a href=\"https://github.com/WebAssembly/component-model/issues/383\">lazy value lowering</a> and was unable to design something which felt easy to use.</p>\n<p>E.g. <code>heapless::String</code> always required an upper bound which ideally would be defined in the WIT, thus I ended up with <a href=\"https://github.com/WebAssembly/component-model/issues/385\">bounded lists and strings</a> which by using return value optimization already avoid all allocations without requiring CPB or LVL.</p>\n<p>So my question to SIG embedded: Do these bounded containers already solve many problems with the component model for microcontrollers or am I too optimistic about it?</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/component-model/issues/175\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/3de83751aa0f6bcae076a2d89f011c666fb60eb4/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f373831336339653266333936616437643666656637336437613439363732313735623834313038643030653262613335663035636133346534613534616666352f576562417373656d626c792f636f6d706f6e656e742d6d6f64656c2f6973737565732f313735&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/component-model/issues/175\" title=\"Consider allowing caller-supplied buffer optimization for return values · Issue #175 · WebAssembly/component-model\">Consider allowing caller-supplied buffer optimization for return values · Issue #175 · WebAssembly/component-model</a></div><div class=\"message_embed_description\">Based on discussions in wasi-http/#8, we should consider a return-value optimization that avoids calling realloc by instead allowing the core wasm caller to supply a (buffer, length) i32 pair as a ...</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/component-model/issues/383\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/d06cc30dbae3e569b30584a3701833008bff5b07/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f306636383134643566393739663934393965333531633038373666666433363032613962366235373062383261613062663431393632356261383366373661392f576562417373656d626c792f636f6d706f6e656e742d6d6f64656c2f6973737565732f333833&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/component-model/issues/383\" title=\"Lazy value lowering · Issue #383 · WebAssembly/component-model\">Lazy value lowering · Issue #383 · WebAssembly/component-model</a></div><div class=\"message_embed_description\">This isn't a fully-fleshed out idea, but it's coming up in #369 and so I thought it might be nice to split out here. I'm tentatively excited about it, though (in that \"this is probably what we shou...</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/component-model/issues/385\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/79013a3181343c767d157343dd1dcc61e008afee/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f643937636537336634343564343231613235326635373931643631663830396338383863623534346530383963313165333833353566663134323939646562612f576562417373656d626c792f636f6d706f6e656e742d6d6f64656c2f6973737565732f333835&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/component-model/issues/385\" title=\"Bounded lists and strings · Issue #385 · WebAssembly/component-model\">Bounded lists and strings · Issue #385 · WebAssembly/component-model</a></div><div class=\"message_embed_description\">This extends #181 with the ability to embed bounded strings or lists directly within other structures while maintaining the variable length property. Some environments require avoiding all memory a...</div></div></div>",
        "id": 456964372,
        "sender_full_name": "Christof Petig",
        "timestamp": 1722981314
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"590366\">Christof Petig</span> <a href=\"#narrow/stream/438936-SIG-Embedded/topic/Avoiding.20dynamic.20memory.20for.20string.2Flist/near/456964372\">said</a>:</p>\n<blockquote>\n<p>So my question to SIG embedded: Do these bounded containers already solve many problems with the component model for microcontrollers or am I too optimistic about it?</p>\n</blockquote>\n<p>you're too optimistic, but then, so am I. :-)</p>",
        "id": 457040279,
        "sender_full_name": "Ralph",
        "timestamp": 1723017571
    },
    {
        "content": "<p>It might help on some use cases. It depends on the setup. In a realtime capable system, one should not malloc/free at all (or at least minimize it). So, yes, there it might help.</p>\n<p>On the other hand: We did some internal measurements with an artificial example, showing that malloc in wamr can perform faster (up to factor 2) than a native malloc (which is not surprising with the simple linear memory and not using the \"system's\" malloc in wasm). So, regarding \"speed\" this seems to be a lesser problem. More problematic is mem fragmentation, hence using only (statically) pre-allocated memory might help, if you can set it up properly.<br>\n(I recall, that there are languages which do not \"have\" a malloc in their programming model, hence Strings have a maximum size (like e.g. 16k). This, of course, leads to the problem, that a user (=the wasm app writer), who wants to read/parse a json/yml/xml file, might not be able to use some OSS parsers... or the user itself must adapt the OSS parser)</p>\n<p>What do you think <span class=\"user-mention\" data-user-id=\"435699\">@Chris Woods</span> <span class=\"user-mention\" data-user-id=\"571349\">@Stephen Berard</span> <span class=\"user-mention\" data-user-id=\"693032\">@Dominik Tacke</span> <span class=\"user-mention\" data-user-id=\"268650\">@Wang Xin</span> ?<br>\n[edited typos]</p>",
        "id": 457084283,
        "sender_full_name": "Thomas Trenner",
        "timestamp": 1723030110
    }
]