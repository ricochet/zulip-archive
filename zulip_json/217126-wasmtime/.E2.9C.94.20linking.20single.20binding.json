[
    {
        "content": "<p>Trying out wasmtime for the first time.</p>\n<p>I am trying to satisfy this error \"component imports instance <code>wasi:cli/environment@0.2.0</code>\" by calling <code>wasmtime_wasi::bindings::cli::environment::add_to_linker</code> in my binary, but I can't get the types to work out. I tried using the <code>type_annotate</code> trick shown <a href=\"https://docs.rs/wasmtime-wasi/latest/src/wasmtime_wasi/lib.rs.html#380\">https://docs.rs/wasmtime-wasi/latest/src/wasmtime_wasi/lib.rs.html#380</a> but no dice.</p>\n<p>I still get this</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>expected<span class=\"w\"> </span><span class=\"sb\">`</span><span class=\"o\">{</span>closure@main.rs:13:47<span class=\"o\">}</span><span class=\"sb\">`</span><span class=\"w\"> </span>to<span class=\"w\"> </span>be<span class=\"w\"> </span>a<span class=\"w\"> </span>closure<span class=\"w\"> </span>that<span class=\"w\"> </span>returns<span class=\"w\"> </span><span class=\"sb\">`</span><span class=\"p\">&amp;</span>mut<span class=\"w\"> </span>_<span class=\"sb\">`</span>,<span class=\"w\"> </span>but<span class=\"w\"> </span>it<span class=\"w\"> </span>returns<span class=\"w\"> </span><span class=\"sb\">`</span>WasiImpl&lt;<span class=\"p\">&amp;</span>mut<span class=\"w\"> </span>MyState&gt;<span class=\"sb\">`</span>\nexpected<span class=\"w\"> </span>mutable<span class=\"w\"> </span>reference<span class=\"w\"> </span><span class=\"sb\">`</span><span class=\"p\">&amp;</span>mut<span class=\"w\"> </span>_<span class=\"sb\">`</span>\n<span class=\"w\">              </span>found<span class=\"w\"> </span>struct<span class=\"w\"> </span><span class=\"sb\">`</span>wasmtime_wasi::WasiImpl&lt;<span class=\"p\">&amp;</span>mut<span class=\"w\"> </span>MyState&gt;<span class=\"sb\">`</span>\n</code></pre></div>",
        "id": 466149509,
        "sender_full_name": "Trent",
        "timestamp": 1724987694
    },
    {
        "content": "<p>does the code example on <a href=\"https://docs.rs/wasmtime-wasi/latest/wasmtime_wasi/fn.add_to_linker_sync.html\">add_to_linker_sync</a> help? Or are you trying to do something different than that?</p>",
        "id": 466155525,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1724991600
    },
    {
        "content": "<p>Not really. I only want to link the feature I want exposed, not everything in <a href=\"https://docs.rs/wasmtime-wasi/latest/src/wasmtime_wasi/lib.rs.html#382-408\">https://docs.rs/wasmtime-wasi/latest/src/wasmtime_wasi/lib.rs.html#382-408</a>. The API for enabling all the WASI interfaces is fine, but the API for enabling individually requires a second param that is pretty obscure.</p>\n<p>My code looks indentical to the source of the function you linked, but it still doesn't want to compile, giving me the above error.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">MyState</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">ctx</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">WasiCtx</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">table</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">ResourceTable</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">WasiView</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">MyState</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">ctx</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">WasiCtx</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">ctx</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">table</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">ResourceTable</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">table</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">type_annotate</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">WasiView</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">F</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">F</span>\n<span class=\"k\">where</span>\n<span class=\"w\">    </span><span class=\"n\">F</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nb\">Fn</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">WasiImpl</span><span class=\"o\">&lt;&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">val</span>\n<span class=\"p\">}</span>\n\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">type_annotate</span><span class=\"p\">::</span><span class=\"o\">&lt;</span><span class=\"n\">MyState</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"n\">t</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">WasiImpl</span><span class=\"p\">(</span><span class=\"n\">t</span><span class=\"p\">));</span>\n<span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">environment</span><span class=\"p\">::</span><span class=\"n\">add_to_linker</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">);</span>\n</code></pre></div>",
        "id": 466185987,
        "sender_full_name": "Trent",
        "timestamp": 1725004145
    },
    {
        "content": "<p>Oh I think you need to call <code>add_to_linker_get_host</code> instead of <code>add_to_linker</code>?</p>",
        "id": 466283961,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1725029072
    },
    {
        "content": "<p>Oh, well that fixed it, don't know how I missed that <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span> cheers</p>",
        "id": 466418845,
        "sender_full_name": "Trent",
        "timestamp": 1725066979
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"234973\">Till Schneidereit</span> has marked this topic as resolved.</p>",
        "id": 468570020,
        "sender_full_name": "Notification Bot",
        "timestamp": 1725803236
    }
]