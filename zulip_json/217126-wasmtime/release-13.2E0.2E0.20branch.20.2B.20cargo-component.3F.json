[
    {
        "content": "<p>Hello! Should one expect to be able to produce components using cargo-component and then instantiate them in Wasmtime from the v13 branch? Is there in general some way that people keep track of compatible versions, and are there generally compatible versions of other tools like cargo-component around each Wasmtime release or is that not always the case? Thanks! <span aria-label=\"heart\" class=\"emoji emoji-2764\" role=\"img\" title=\"heart\">:heart:</span></p>",
        "id": 391445801,
        "sender_full_name": "Jeff Parsons",
        "timestamp": 1694919323
    },
    {
        "content": "<p>Extra context for how I ended up asking this question:</p>\n<p>Toolchain versions:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">rustc</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">version</span>\n<span class=\"n\">rustc</span><span class=\"w\"> </span><span class=\"mf\">1.72.0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">5680</span><span class=\"n\">fa18f</span><span class=\"w\"> </span><span class=\"mi\">2023</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">23</span><span class=\"p\">)</span>\n<span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">version</span>\n<span class=\"n\">cargo</span><span class=\"o\">-</span><span class=\"n\">component</span><span class=\"o\">-</span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"mf\">0.1.0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">36</span><span class=\"n\">c221e</span><span class=\"w\"> </span><span class=\"mi\">2023</span><span class=\"o\">-</span><span class=\"mi\">09</span><span class=\"o\">-</span><span class=\"mi\">07</span><span class=\"w\"> </span><span class=\"n\">wasi</span>:<span class=\"mi\">134</span><span class=\"n\">dddc</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>Guest world:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"n\">component</span>:<span class=\"nc\">guest</span>\n\n<span class=\"n\">world</span><span class=\"w\"> </span><span class=\"n\">example</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"o\">-</span><span class=\"n\">world</span>: <span class=\"nc\">func</span><span class=\"p\">()</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">string</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>Host setup:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Config</span>::<span class=\"n\">new</span><span class=\"p\">();</span>\n<span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">wasm_component_model</span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">);</span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">engine</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Engine</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">config</span><span class=\"p\">).</span><span class=\"n\">context</span><span class=\"p\">(</span><span class=\"s\">\"Failed to create engine\"</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Component</span>::<span class=\"n\">from_file</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">engine</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"../guest/target/wasm32-wasi/debug/guest.wasm\"</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">context</span><span class=\"p\">(</span><span class=\"s\">\"Failed to load guest component\"</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Linker</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">engine</span><span class=\"p\">);</span>\n\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">table</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Table</span>::<span class=\"n\">new</span><span class=\"p\">();</span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Store</span>::<span class=\"n\">new</span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"o\">&amp;</span><span class=\"n\">engine</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">MyState</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">wasi</span>: <span class=\"nc\">WasiCtxBuilder</span>::<span class=\"n\">new</span><span class=\"p\">().</span><span class=\"n\">inherit_stdio</span><span class=\"p\">().</span><span class=\"n\">build</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">table</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">table</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n\n<span class=\"n\">wasmtime_wasi</span>::<span class=\"n\">preview2</span>::<span class=\"n\">command</span>::<span class=\"n\">sync</span>::<span class=\"n\">add_to_linker</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">context</span><span class=\"p\">(</span><span class=\"s\">\"Failed to set up WASI\"</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bindings</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Example</span>::<span class=\"n\">instantiate</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">component</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">linker</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">context</span><span class=\"p\">(</span><span class=\"s\">\"Failed to instantiate guest component\"</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>Output:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Error</span>: <span class=\"nc\">Failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">instantiate</span><span class=\"w\"> </span><span class=\"n\">guest</span><span class=\"w\"> </span><span class=\"n\">component</span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span>:\n    <span class=\"mi\">0</span>: <span class=\"nc\">import</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">wasi</span>:<span class=\"nc\">io</span><span class=\"o\">/</span><span class=\"n\">streams</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">wrong</span><span class=\"w\"> </span><span class=\"k\">type</span>\n    <span class=\"mi\">1</span>: <span class=\"nc\">instance</span><span class=\"w\"> </span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">write</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">wrong</span><span class=\"w\"> </span><span class=\"k\">type</span>\n    <span class=\"mi\">2</span>: <span class=\"nc\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"n\">results</span>\n<span class=\"w\">    </span><span class=\"mi\">3</span>: <span class=\"nc\">expected</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">-</span><span class=\"n\">tuple</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">-</span><span class=\"n\">tuple</span>\n</code></pre></div>\n<p>I assume (from ignorance) that this is because of recent changes to WASI and Wasmtime's implementation. Does that sound about right? Or maybe I just stuffed something up?</p>",
        "id": 391467204,
        "sender_full_name": "Jeff Parsons",
        "timestamp": 1694936106
    },
    {
        "content": "<p>the 13 branch has changes to streams that landed in the spec repo as this PR: <a href=\"https://github.com/WebAssembly/wasi-io/pull/45\">https://github.com/WebAssembly/wasi-io/pull/45</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-io/pull/45\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/18f1a9fed7b0ebdfdc360526722cc9b6dcd7c97a\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f376130323862346336656366623362613535366634393738626632306433636565323832396564333536643464383436626630333136666363396530376166662f576562417373656d626c792f776173692d696f2f70756c6c2f3435)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-io/pull/45\" title=\"New backpressure and flushing scheme for output-stream by pchickey · Pull Request #45 · WebAssembly/wasi-io\">New backpressure and flushing scheme for output-stream by pchickey · Pull Request #45 · WebAssembly/wasi-io</a></div><div class=\"message_embed_description\">output-stream's backpressure design has been changed to take into account that any write call with a list&lt;byte&gt; argument is going to consume the resources of a component implementation, by copying ...</div></div></div>",
        "id": 391566929,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1694981552
    },
    {
        "content": "<p>cargo-component's wasi preview 1 adapter was built prior to those changes, so cargo-component needs an update to include them</p>",
        "id": 391566979,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1694981582
    },
    {
        "content": "<p>i believe there is a way to override what adapter cargo-component uses, but i don't know it off the top of my head, and its a weekend. so, if you can figure out how to feed it the wasi-preview1-component-adapter built from the 13 branch, that ought to fix your problem</p>",
        "id": 391567050,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1694981634
    },
    {
        "content": "<p>Wonderful, thanks! :)</p>\n<p>I didn't figure out how to override what adapter cargo-component uses; instead I just did the update in the source. So — for anyone else who finds this and wants to do a similar thing — my steps were:</p>\n<ul>\n<li>Clone the <code>cargo-component</code> repo locally.</li>\n<li>Clone the <code>wasmtime</code> repo locally (don't forget to init submodules!)</li>\n<li>Follow instructions for building both variants (reactor, command) of the adapter here: <a href=\"https://github.com/bytecodealliance/wasmtime/tree/main/crates/wasi-preview1-component-adapter\">https://github.com/bytecodealliance/wasmtime/tree/main/crates/wasi-preview1-component-adapter</a>. For each variant of the adapter, copy the built <code>.wasm</code> file following the existing naming convention under the <code>adapters/</code> dir. I.e. new subdir with abbreviated wasmtime commit sha, with files named <code>wasi_snapshot_preview1.reactor.wasm</code> and <code>wasi_snapshot_preview1.command.wasm</code> inside.</li>\n<li>Update <code>WASI_ADAPTER_VERSION</code> in <code>cargo-component</code>'s <code>build.rs</code> to point to your new directory.</li>\n<li>Build your new version of <code>cargo-component</code>: <code>cargo install --path .</code></li>\n<li>Rebuild your guest component. (Might need to explicitly clean first; not sure if changing the version of <code>cargo-component</code> will invalidate the build cache.)</li>\n</ul>",
        "id": 391577196,
        "sender_full_name": "Jeff Parsons",
        "timestamp": 1694987185
    },
    {
        "content": "<p>Hi Jeff, feel free to put up a PR for updating the adapter; I'll also try to add an option for overriding the adapter tomorrow</p>",
        "id": 391625734,
        "sender_full_name": "Peter Huene",
        "timestamp": 1695017336
    },
    {
        "content": "<p>PR for adapters bump is here: <a href=\"https://github.com/bytecodealliance/cargo-component/pull/140\">https://github.com/bytecodealliance/cargo-component/pull/140</a></p>\n<p>Thanks!</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/cargo-component/pull/140\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/abb8ba98594611edb0b57b48456d68540982fdd0\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f626166663835643063653733623337616130353562313735313462616436303730313532643132326662653536333434643236363836633166356537323432632f62797465636f6465616c6c69616e63652f636172676f2d636f6d706f6e656e742f70756c6c2f313430)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/cargo-component/pull/140\" title=\"Update WASI adapters to 2ad057d by jeffparsons · Pull Request #140 · bytecodealliance/cargo-component\">Update WASI adapters to 2ad057d by jeffparsons · Pull Request #140 · bytecodealliance/cargo-component</a></div><div class=\"message_embed_description\">This is for compatibility with the Wasmtime 13 release branch.\nI have retained the previous adapters (134dddc) because I believe the plan is to support switching between them soon, and I imagine th...</div></div></div>",
        "id": 391781738,
        "sender_full_name": "Jeff Parsons",
        "timestamp": 1695074475
    },
    {
        "content": "<p>thanks jeff!</p>",
        "id": 391781814,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1695074513
    }
]