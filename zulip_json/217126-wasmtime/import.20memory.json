[
    {
        "content": "<p>I have a compiled  <code>.wasm</code> file which does not use memory. I am trying to run it using <code>wasmtime</code>. It seems <code>wasmtime</code> needs the <code>.wasm</code> file to export memory. </p>\n<p>The <code>.wasm</code> file is a simple file which just exits with a specific non-zero exit code. On executing it with <code>wasmtime</code>, I currently face the following:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$ wasmtime tmp\nError: failed to run main module <span class=\"sb\">`</span>tmp<span class=\"sb\">`</span>\n\nCaused by:\n    <span class=\"m\">0</span>: failed to invoke <span class=\"nb\">command</span> default\n    <span class=\"m\">1</span>: error <span class=\"k\">while</span> executing at wasm backtrace:\n           <span class=\"m\">0</span>:   0xa7 - &lt;unknown&gt;!&lt;wasm <span class=\"k\">function</span> <span class=\"m\">1</span>&gt;\n           <span class=\"m\">1</span>:   0xce - &lt;unknown&gt;!&lt;wasm <span class=\"k\">function</span> <span class=\"m\">3</span>&gt;\n           <span class=\"m\">2</span>:   0xb4 - &lt;unknown&gt;!&lt;wasm <span class=\"k\">function</span> <span class=\"m\">2</span>&gt;\n           <span class=\"m\">3</span>:   0xda - &lt;unknown&gt;!&lt;wasm <span class=\"k\">function</span> <span class=\"m\">4</span>&gt;\n    <span class=\"m\">2</span>: missing required memory <span class=\"nb\">export</span>\n</code></pre></div>\n<p>Please, could someone possibly share if there is any flag in <code>wasmtime</code> that allows executing without memory export? Also, does <code>wasmtime</code> allow/support memory import in <code>.wasm</code> file?</p>",
        "id": 325611269,
        "sender_full_name": "Ubaid Shaikh",
        "timestamp": 1675425666
    },
    {
        "content": "<p>Some doubts:</p>\n<ol>\n<li>Where can I find/learn about the structure of <code>.wasm</code> files that <code>wasmtime</code> expects? </li>\n<li>On compiling a <code>C/C++</code> code with <code>emscripten</code>, I found the following functions exported in the generated <code>.wasm</code> file</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code>  <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"__wasm_call_ctors\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"mi\">0</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"main\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"mi\">3</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"__indirect_function_table\"</span> <span class=\"p\">(</span><span class=\"k\">table</span> <span class=\"mi\">0</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"__errno_location\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"mi\">21</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"fflush\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"mi\">20</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"emscripten_stack_init\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"mi\">10</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"emscripten_stack_get_free\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"mi\">11</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"emscripten_stack_get_base\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"mi\">12</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"emscripten_stack_get_end\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"mi\">13</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"stackSave\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"mi\">6</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"stackRestore\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"mi\">7</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"stackAlloc\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"mi\">8</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"emscripten_stack_get_current\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"mi\">9</span><span class=\"p\">)))</span>\n</code></pre></div>\n<p>Please, could someone possibly share what these functions do and/or where I could find information about the working of these functions?</p>",
        "id": 325612894,
        "sender_full_name": "Ubaid Shaikh",
        "timestamp": 1675426104
    },
    {
        "content": "<p>I would be really grateful for any help on the above. Thank you.</p>",
        "id": 325613132,
        "sender_full_name": "Ubaid Shaikh",
        "timestamp": 1675426178
    },
    {
        "content": "<p>emscripten targets the Web and relies on its generated JS to fulfil all its imports and manage its exports. it isn't really going to work in non-Web environments.</p>\n<p>if you are trying to target wasmtime, you'd be better served by wasi-sdk: <a href=\"https://github.com/WebAssembly/wasi-sdk\">https://github.com/WebAssembly/wasi-sdk</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-sdk\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/ce0301770b2926a3af686ad9d1fb4676e2f3e6aa\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f346539626336383833613633633839376363646663303161396362323662613866613562656365386135616437653765343462646261326337393232633636662f576562417373656d626c792f776173692d73646b)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-sdk\" title=\"GitHub - WebAssembly/wasi-sdk: WASI-enabled WebAssembly C/C++ toolchain\">GitHub - WebAssembly/wasi-sdk: WASI-enabled WebAssembly C/C++ toolchain</a></div><div class=\"message_embed_description\">WASI-enabled WebAssembly C/C++ toolchain. Contribute to WebAssembly/wasi-sdk development by creating an account on GitHub.</div></div></div>",
        "id": 325703950,
        "sender_full_name": "fitzgen (he/him)",
        "timestamp": 1675450791
    },
    {
        "content": "<p>For 1. The wasmtime cli expects a wasi module. The wasi specification requires a memory to be exported. If you want to use a non-wasi wasm module you will have to use wasmtime as library and manually expose whichever interface you want to the wasm module.</p>",
        "id": 325704930,
        "sender_full_name": "bjorn3",
        "timestamp": 1675451111
    },
    {
        "content": "<p>Thank you so much for the clarification! This is very helpful!</p>",
        "id": 325724886,
        "sender_full_name": "Ubaid Shaikh",
        "timestamp": 1675458583
    },
    {
        "content": "<p>Using <code>wasi</code>, how can one print an integer or float to screen? There is <code>fd_write</code> in the <code>wasi</code> api documentation, but it seems it is only for printing strings. I attempted to store an integer in memory and then print it using <code>fd_write</code>as follows:</p>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code><span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"nv\">$main</span> <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"_start\"</span><span class=\"p\">)</span>\n    <span class=\"p\">(</span><span class=\"nb\">i32.store</span> <span class=\"p\">(</span><span class=\"nb\">i32.const</span> <span class=\"mi\">12</span><span class=\"p\">)</span> <span class=\"p\">(</span><span class=\"nb\">i32.const</span> <span class=\"mi\">26</span><span class=\"p\">))</span> <span class=\"c1\">;; store the number</span>\n\n\n    <span class=\"c1\">;; iov vector</span>\n    <span class=\"p\">(</span><span class=\"nb\">i32.store</span> <span class=\"p\">(</span><span class=\"nb\">i32.const</span> <span class=\"mi\">4</span><span class=\"p\">)</span> <span class=\"p\">(</span><span class=\"nb\">i32.const</span> <span class=\"mi\">12</span><span class=\"p\">))</span>\n    <span class=\"p\">(</span><span class=\"nb\">i32.store</span> <span class=\"p\">(</span><span class=\"nb\">i32.const</span> <span class=\"mi\">8</span><span class=\"p\">)</span> <span class=\"p\">(</span><span class=\"nb\">i32.const</span> <span class=\"mi\">4</span><span class=\"p\">))</span>\n\n\n    <span class=\"p\">(</span><span class=\"nb\">call</span> <span class=\"nv\">$fd_write</span>\n      <span class=\"p\">(</span><span class=\"nb\">i32.const</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"c1\">;; 1 for stdout</span>\n      <span class=\"p\">(</span><span class=\"nb\">i32.const</span> <span class=\"mi\">4</span><span class=\"p\">)</span> <span class=\"c1\">;; *iovs</span>\n      <span class=\"p\">(</span><span class=\"nb\">i32.const</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"c1\">;; iovs_len</span>\n      <span class=\"p\">(</span><span class=\"nb\">i32.const</span> <span class=\"mi\">0</span><span class=\"p\">)</span> <span class=\"c1\">;; nwritten</span>\n    <span class=\"p\">)</span>\n    <span class=\"nb\">drop</span>\n  <span class=\"p\">)</span>\n</code></pre></div>\n<p>It does not print any output. Printing an integer by storing it directly in memory using <code>(data (i32.const 12) \"26\")</code> works (because we are just printing it as string), but by storing it as <code>(i32.store (i32.const 12) (i32.const 26))</code> does not work. Please, could someone possibly share what I might be missing and/or how to print integers/float to stdout using <code>wasi</code>?</p>",
        "id": 325736261,
        "sender_full_name": "Ubaid Shaikh",
        "timestamp": 1675463718
    },
    {
        "content": "<p>There is no WASI-level support for formatted output of numbers. Typically programs would link with a source language's standard library, which would implement this in wasm, such as <code>format!(...)</code> in Rust or <code>printf</code> in C or other things in other languages.</p>",
        "id": 325736801,
        "sender_full_name": "Dan Gohman",
        "timestamp": 1675463982
    },
    {
        "content": "<p>I'm attempting to write some basic memory-logic to be able to pass strings to a wasm module, following <a href=\"https://radu-matei.com/blog/practical-guide-to-wasm-memory/#passing-arrays-to-modules-using-wasmtime\">this article</a>.</p>\n<p>It appears however that the wasmtime api have changed a bit since, and functions that return values no seem to require <code>get_typed_func::&lt;Params, Returns&gt;()</code> (which is great btw). What I don't understand is how to type guest functions that return a raw pointer to memory, and what difference it does if I use a <code>i32</code> or <code>u32</code> etc. for that.</p>\n<p>Given this function defined in rust and compiled to wasm:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">#[no_mangle]</span><span class=\"w\"></span>\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"s\">\"C\"</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">alloc</span><span class=\"p\">(</span><span class=\"n\">len</span>: <span class=\"kt\">usize</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"o\">*</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"kt\">u8</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">buf</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">Vec</span>::<span class=\"n\">with_capacity</span><span class=\"p\">(</span><span class=\"n\">len</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">buf</span><span class=\"p\">.</span><span class=\"n\">as_mut_ptr</span><span class=\"p\">();</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">std</span>::<span class=\"n\">mem</span>::<span class=\"n\">forget</span><span class=\"p\">(</span><span class=\"n\">buf</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>how do I type that on the hose side?</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">alloc</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"p\">.</span><span class=\"n\">get_typed_func</span>::<span class=\"o\">&lt;??</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">??&gt;</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"alloc\"</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n</code></pre></div>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://radu-matei.com/blog/practical-guide-to-wasm-memory/#passing-arrays-to-modules-using-wasmtime\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/98f3a46af15d1cbb6300c1db78743909925ad753\\/68747470733a2f2f7777772e67726176617461722e636f6d2f6176617461722f37623335636331653739613462353635313739313938383461396561363066323f733d323536)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://radu-matei.com/blog/practical-guide-to-wasm-memory/#passing-arrays-to-modules-using-wasmtime\" title=\"A practical guide to WebAssembly memory - radu's blog\">A practical guide to WebAssembly memory - radu's blog</a></div><div class=\"message_embed_description\">Memory in WebAssembly is one of the topics that creates confusion for newcomers, particularly for those with experience in languages with memory management features like garbage collection, such as JavaScript, Go, or Java. In this article we explore using memory in WebAssembly in various scenarios - passing JavaScript arrays to Rust and AssemblyScript modules, checking for some basic memory leaks using Valgrind, or exchanging strings between runtimes and modules using Wasmtime.</div></div></div>",
        "id": 325771717,
        "sender_full_name": "Jakob Lilliemarck",
        "timestamp": 1675489405
    },
    {
        "content": "<p>For wasm32 you did use a 32bit int and for wasm64 a 64bit int. Using an unsigned integer makes most sense.</p>",
        "id": 325793886,
        "sender_full_name": "bjorn3",
        "timestamp": 1675504189
    },
    {
        "content": "<p>By the way have you seen wit-bindgen? It takes care of a lot of work to pass higher level types like structs and arrays between the host and wasm.</p>",
        "id": 325794030,
        "sender_full_name": "bjorn3",
        "timestamp": 1675504252
    }
]